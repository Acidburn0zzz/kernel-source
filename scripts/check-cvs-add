#! /bin/bash

#
# Check if all files referenced by series.conf are in the CVS.
#

export LANG=C

patches="$(scripts/guards --list < series.conf)"

not_in_cvs="$(
    (   for dir in $(echo "$patches" | sed -e 's,[^/]*$,,' | sort -u); do
	    [ -e ${dir}CVS/Entries ] || continue
	    # Print each active file in the CVS twice
	    while IFS=/ read type file rev timestamp flags; do
		[ -n "$type" -o -z "$file" ] && continue
		# Croak files have not yet been committed to the CVS?
		#[ "$rev" = 0 ] && continue
		# Croak files are marked for deletion?
		[ "${rev:0:1}" = - ] && continue

		echo ${dir}$file
		echo ${dir}$file
	    done < ${dir}CVS/Entries
	done
	# Print the patches once, so that each patch that is not in the
	# CVS ends up as a unique entry
	echo "$patches"
    ) | sort | uniq -u)"
    
if [ -n "$not_in_cvs" ]; then
    for patch in $not_in_cvs; do
	if [ -e "$patch" ]; then
	    echo "Not in CVS: $patch" >&2
	    status=1
	else
	    echo "Missing: $patch" >&2
	    status=1
	fi
    done
    exit $status
fi
