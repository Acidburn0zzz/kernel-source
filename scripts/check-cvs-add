#! /bin/bash

#
# Check if all files referenced by series.conf are in the CVS.
#

export LANG=C

patches="$(scripts/guards --list < series.conf)"

not_in_cvs="$(
    (   for dir in $(echo "$patches" | sed -e 's,[^/]*$,,' | sort -u); do
	    # Print each active file in the CVS twice
	    while IFS=/ read type file rev timestamp flags; do
		[ -n "$type" -o -z "$file" ] && continue
		[ "$rev" = 0 -o "${rev:0:1}" = - ] && continue

		echo ${dir}$file
		echo ${dir}$file
	    done < ${dir}CVS/Entries
	done
	# Print the patches once, so that each patch that is not in the
	# CVS ends up as a unique entry
	echo "$patches"
    ) | sort | uniq -u)"
    
if [ -n "$not_in_cvs" ]; then
    echo "$not_in_cvs" \
    | sed -e "s,^,Not in CVS: ," >&2
    exit 1
fi
