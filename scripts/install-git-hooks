#!/bin/bash

# add scripts/git-hooks/pre-commit-test

SUBDIRECTORY_OK=true
. "$(git --exec-path)/git-sh-setup"
cdup=`git rev-parse --show-cdup`
cd "${cdup:-./}" || exit

check_snippet()
{
    # do not grep for the exact line so that those who really don't like
    # the pre-commit check can add '# kernel-source-pre-commit' to silence
    # the warnings
    grep -qs kernel-source-pre-commit "$GIT_DIR"/hooks/pre-commit
}

install_snippet()
{
    local hook="$GIT_DIR"/hooks/pre-commit
    local snippet='
# runs kernel-source-patch-check for each added or modified patch
. "$(dirname "$0")"/kernel-source-pre-commit'
    # fix up old clones that had '$GIT_DIR/hooks' here which doesn't work
    # with older gits
    if grep -qs '"$GIT_DIR"/hooks/' "$hook"; then
        sed -i 's:"\$GIT_DIR"/hooks/:"$(dirname "$0")"/:' "$hook"
    fi
    if check_snippet; then
        return
    fi
    if ! test -x "$hook"; then
        # if the hook was not enabled before, don't run the example code that
        # is usually there
        snippet="$snippet"$'\n'"exit 0"
    fi
    if test -e "$hook"; then
        snippet="$snippet" perl -pi'.orig' -e '
           if (/^[^#]/ && !$inserted) {
               print $ENV{"snippet"} . "\n";
               $inserted = 1;
           }' "$hook"
    else
        (echo '#!/bin/sh'
        echo
        echo $snippet) >"$hook"
    fi
}

is_eq()
{
    test "$1" -ef "$2" || cmp -s "$1" "$2"
}

check_scripts()
{
    test -x "$GIT_DIR"/hooks/pre-commit && \
    is_eq "$GIT_DIR"/hooks/kernel-source-pre-commit scripts/git-pre-commit && \
    is_eq "$GIT_DIR"/hooks/check-patch scripts/check-patch
}

# try to create a relative symlink if possible
relative_scripts_dir()
{
    local toplevel=$PWD
    local git_subdir=${GIT_DIR#$PWD/}
    if test "$git_subdir" != "$GIT_DIR"; then
        echo -n "$git_subdir/hooks" | sed 's:[^/]\+:..:g'; echo /scripts
    else
        echo "$toplevel/scripts"
    fi
}

install_scripts()
{
    chmod +x "$GIT_DIR"/hooks/pre-commit
    dir=$(relative_scripts_dir)
    ln -sf "$dir"/git-pre-commit "$GIT_DIR"/hooks/kernel-source-pre-commit
    ln -sf "$dir"/check-patch "$GIT_DIR"/hooks/check-patch
}

install_changes_merger()
{
    git config merge.rpm-changes.name "*.changes merge driver"
    git config merge.rpm-changes.driver "scripts/rpm-changes-merge.pl %A %O %B"
    if ! grep -qs 'merge=rpm-changes' "$GIT_DIR"/info/attributes; then
        mkdir -p "$GIT_DIR"/info
        echo '*.changes merge=rpm-changes' >>"$GIT_DIR"/info/attributes
    fi
}
    

case "$1" in
--check)
    check_snippet && check_scripts
    exit
    ;;
"")
    echo "Installing git commit hooks."
    install_snippet
    install_scripts
    echo "Installing kernel-source.changes merge driver."
    install_changes_merger
    ;;
*)
    echo "Usage: $0 [--check]" >&2
    exit 1
    ;;
esac

# vim: sw=4 : et
