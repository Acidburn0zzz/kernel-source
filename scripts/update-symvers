#! /bin/sh

MODVER_TAGS=~kbuild/modver/tags

usage() {
    cat <<EOF
Usage: ${0##*/} --list
       ${0##*/} [--dry-run] --update tag ...

List available tags, or update the symver dump files in the repository
to a given (set of) tags. Examples:

  $0 --update SLES-9-SP-3-i386-RC2
  $0 --update 'SLES-9-SP-3-*-RC2'

EOF
    exit $1
}

options=`getopt -o h --long list,update,dry-run -- "$@"`

if [ $? -ne 0 ]
then
        usage 1
fi

eval set -- "$options"

while :; do
    case "$1" in
	--list)
	    opt_list=1
	    ;;
	--update)
	    opt_update=1
	    ;;
	--dry-run)
	    opt_dry_run=1
	    ;;
	-h|--help)
	    usage 0
	    exit
	    ;;
	--)
	    shift
	    break
	    ;;
    esac
    shift
done

(( ${opt_list:-0} + ${opt_update:-0} != 1 )) && usage 1

if [ -n "$opt_list" ]; then
    ls $MODVER_TAGS
else
    [ $# -eq 0 ] && usage 1

    source $(dirname $0)/config.sh

    for tag in "$@"; do
	shopt -s nullglob
	set -- $MODVER_TAGS/$tag/*/kernel-*/symvers.gz
	if [ $# -eq 0 ]; then
	    echo "Tag(s) $tag not found" >&2
	    status=1
	    continue
	fi
	for package in "${@%/symvers.gz}"; do
	    if ! [ -h "$package" ]; then
		echo "$package is not a symlink" >&2
		status=1
		continue
	    fi
	    set -- $(IFS=/; echo $(readlink "$package"))
	    while [ $# -ge 3 -a \
		    "$2" != ${package##*/} -a \
		    "${3%-*}" != $SRCVERSION ]; do
		shift
	    done
	    if [ $# -lt 3 ]; then
		echo "Link $package does not contain" \
		     "'/*/${package##*/}/$SRCVERSION-*/'" >&2
		status=1
		continue
	    fi
	    arch=$(echo $1 | sed -e 's/i.86/i386/' -e 's/s390x/s390/' -e 's/ppc*/powerpc/')
	    flavor=${2#kernel-}

	    echo "${package#$MODVER_TAGS/} -> kabi/$arch/symvers-$flavor"
	    if [ -z "$opt_dry_run" ]; then
		mkdir -p kabi/$arch &&
		zcat $package/symvers.gz > kabi/$arch/symvers-$flavor ||
		status=1
	    fi
	done
    done
fi

exit $status

# vim:shiftwidth=4 softtabstop=4
