#! /bin/bash

usage() {
    echo "USAGE: ${0##*/} [--only-symvers|--only-symsets] rpm ..." >&2
}

options=`getopt -o h --long only-symvers,only-symsets,dry-run,help -- "$@"`
if [ $? -ne 0 ]; then
    usage
    exit 1
fi
eval set -- "$options"

opt_add_symsets=1
opt_add_symvers=1
while :; do
    case "$1" in
	--only-symsets)
	    opt_add_symvers=
	    ;;
	--only-symvers)
	    opt_add_symsets=
	    ;;
	--dry-run)
	    opt_dry_run=1
	    ;;
	-h|--help)
	    usage
	    exit 0
	    ;;
	--)
	    shift
	    break;
    esac
    shift
done

if [ $# -eq 0 ]; then
    usage
    exit 1
fi

tmpdir=$(mktemp -td ${0##*/}.XXXXXX)
trap "rm -rf $tmpdir" EXIT

shopt -s nullglob

archs_flavors="$(scripts/guards --list < config.conf)"
for rpm in "$@"; do
    case "$rpm" in
	*.src.rpm | *.nosrc.rpm)
	    continue
	    ;;
    esac

    exec 3< <(rpm -qp --qf '%{NAME}\n%{ARCH}\n' "$rpm")
    read name <&3
    read arch <&3
    exec 3<&-
    case "$arch" in
	i?86)
	    arch=i386 ;;
	ppc*)
	    arch=powerpc ;;
	s390*)
	    arch=s390 ;;
    esac
    flavor=${name#kernel-}

    if ! echo "$archs_flavors" | grep -q "$arch/$flavor"; then
	case "$flavor" in
	source | syms)
	    ;;
	*)
	    echo "${rpm%%*/}: not a known arch/flavor; skipping" >&2
	    ;;
	esac
	continue
    fi

    rpm2cpio "$rpm" \
    | ( cd $tmpdir && cpio -dim --quiet './boot/symvers-*' './boot/symsets-*' )

    if [ -n "$opt_add_symvers" ]; then
	set -- $tmpdir/boot/symvers-*.gz
	if [ $# -eq 0 ]; then
	    echo "No symvers file found in $rpm" >&2
	    status=1
	    continue
	fi

	for symvers in "$@"; do
	    gzip -cd $symvers > ${symvers%.gz}
	    symvers=${symvers%.gz}
	    flavor=${symvers##*-}

	    f=kabi/$arch/symvers-$flavor
	    if [ -e $f ] && cmp -s "$symvers" $f; then
		echo "${rpm%%*/}: ${f%%*/} is unchanged"
		continue
	    fi
	    [ -n "$opt_dry_run" ] || cp "$symvers" $f
	    echo "${f%%*/} added"
	done
    fi

    if [ -n "$opt_add_symsets" ]; then
	set -- $tmpdir/boot/symsets-*
	if [ $# -eq 0 ]; then
	    echo "No symsets file found in $rpm" >&2
	    status=1
	    continue
	fi

	for symsets in "$@"; do
	    flavor=${symsets%.tar.gz}
	    flavor=${flavor##*-}

	    f=kabi/$arch/symsets-$flavor.tar.gz
	    if [ -e $f ] && cmp -s "$symsets" $f; then
		echo "${rpm%%*/}: ${f%%*/} is unchanged"
		continue
	    fi
	    [ -n "$opt_dry_run" ] || cp "$symsets" $f
	    echo "${f%%*/} added"
	done
    fi

    if [ -e kabi/$arch/ignore-$flavor ]; then
	echo "WARNING: kabi/$arch/ignore-$flavor exists; kernel ABI checks" \
	     "are disabled for this kernel" >&2
	sleep 1
	status=1
    fi

    rm -rf $tmpdir/boot
done

exit $status

# vim:shiftwidth=4 softtabstop=4
