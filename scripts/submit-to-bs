#!/bin/sh

# very dumb script that uploads the kernel package to home:$user:Factory and
# creates a submitreq against openSUSE:Factory

die()
{
	echo "$@" >&2
	exit 1
}

get_bs_login()
{
	if test ! -e ~/.oscrc; then
		osc
	fi
	if test ! -e ~/.oscrc; then
		die "~/.oscrc not found, exiting"
	fi
	local res=$(awk '
		/^\[.*api\.opensuse\.org.*\]/ {
			pick=1
		}
		/^user *[:=] */ {
			if (pick) {
				sub(/.*[:=] */, "");
				print;
				exit
			}
		}' ~/.oscrc)
	if test -z "$res"; then
		die "Cannot determine your buildservice login"
	fi
	echo "$res"
	return 0
}

osc()
{
	echo osc "$@"
	command osc "$@"
}

dir=kernel-source
while test $# -gt 0; do
	case "$1" in
	-d|--dir)
		dir=$2
		shift 2
	;;
	-u|--user)
		user=$2
		shift 2
	;;
	*)
		die "Usage: $0 [-d dir] [-u user]"
	esac
done

if test -z "$user"; then
	user=$(get_bs_login) || exit
fi

#osc deletepac home:"$user":Factory kernel-source
osc linkpac openSUSE:Factory kernel-source home:"$user":Factory
tmpdir=`mktemp -d`
trap 'rm -rf "$tmpdir"' EXIT
pushd "$tmpdir" >/dev/null
	osc co -e home:"$user":Factory kernel-source
	# osc co -c is broken :-/
	bsdir="$tmpdir/home:$user:Factory/kernel-source"
	cd "$bsdir"
	rm -f *
popd >/dev/null
cp -a "$dir"/* "$bsdir"/
message="update to $(grep '^GIT Rev' $dir/*source-timestamp)"
pushd "$bsdir" >/dev/null
	osc addremove
	osc ci -m "$message"
popd >/dev/null
osc sr create --nodevelproject -m "$message" home:"$user":Factory \
	kernel-source openSUSE:Factory
