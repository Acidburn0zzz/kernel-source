#!/bin/bash

# Print git log in .changes format. Expects a revision range as argument

git rev-list --no-merges "$@" | while read commit; do
	raw=$(git cat-file commit "$commit")
	headers=$(echo "$raw" | sed '/^$/Q')
	msg=$(echo "$raw" | sed '1,/^$/d')
	ts=$(echo "$headers" | sed -rn 's/^author .*> ([^ ]*) .*/\1/p')
	date=$(LANG=C TZ=CET date -d @$ts)
	email=$(echo "$headers" | sed -rn 's/^author .* <(.*)> .*/\1/p')

	echo "-------------------------------------------------------------------"
	echo "$date - $email"
	echo
	echo "$msg" | sed '
		1 s/^[^-]/- &/
		/^$/d
		/^Signed-off-by:/d
		2,$ s/^[^-]/  &/'
	echo "- commit ${commit:0:7}"
	echo
done
