#! /bin/bash

if [ $# -ne 2 ]; then
    echo "Usage: ${0##*/} <symtypes1.gz> <symtypes2.gz>"
    echo "Show the differences between two /boot/symtypes-*.gz files."
    exit
fi

verbose_symtypes() {
    # The symtypes dumps have repeated identical type definitions stripped out.
    # Fill in the stripped-out definition to make the diff easier to understand.

    gzip -d < "$1" \
    | awk '
	$1 ~ /^.#.*/ {
	    if (NF != 1)
		syms[$1] = $0;
	    print syms[$1];
	    next;
	}
	{ print }
    '
}

diff -U0 --show-function-line='^/\*' --label "$1" --label "$2" \
    <(verbose_symtypes "$1") <(verbose_symtypes "$2")
