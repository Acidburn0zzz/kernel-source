#! /bin/sh

TAGS=~kbuild/modver/tags

usage() {
    cat <<EOF
Usage: ${0##*/} --list
       ${0##*/} [--dry-run] --tag-cvs=name tag ...

List available tags, or tag a specific release with the specified
name in CVS. Examples:

  ${0##*/} --tag-cvs=CODE10_BETA9 'SLES-10-CD-*-Beta9'

EOF
    exit $1
}

options=`getopt -o h --long list,tag-cvs:,dry-run -- "$@"`

if [ $? -ne 0 ]
then
        usage 1
fi

eval set -- "$options"

while :; do
    case "$1" in
	--list)
	    opt_list=1
	    ls $TAGS
	    ;;
	--tag-cvs)
	    opt_tag_cvs=$2
	    shift
	    ;;
	--dry-run)
	    opt_dry_run=1
	    ;;
	-h|--help)
	    usage 0
	    exit
	    ;;
	--)
	    shift
	    break
	    ;;
    esac
    shift
done

[ "${opt_list:+x}${opt_tag_cvs:+x}" != x ] && usage 1

if [ -n "$opt_list" ]; then
    ls $TAGS
else
    [ $# -eq 0 ] && usage 1

    source $(dirname $0)/config.sh

    for tag in "$@"; do
	shopt -s nullglob
	set -- $TAGS/$tag/kernel-*/cvsinfo
	if [ $# -eq 0 ]; then
	    echo "Tag(s) $tag not found" >&2
	    status=1
	    continue
	fi
	for package in "${@%/cvsinfo}"; do
	    if ! [ -h "$package" ]; then
		echo "$package is not a symlink" >&2
		status=1
		continue
	    fi
	    set -- $(IFS=/; echo $(readlink "$package"))
	    while [ $# -ge 3 -a \
		    "$2" != ${package##*/} -a \
		    "${3%-*}" != $SRCVERSION ]; do
		shift
	    done
	    if [ $# -lt 3 ]; then
		echo "Link $package does not contain" \
		     "'/*/${package##*/}/$SRCVERSION-*/'" >&2
		status=1
		continue
	    fi
	    arch=$(echo $1 | sed -e 's/i.86/i386/' -e 's/s390x/s390/' \
				 -e 's/ppc*/powerpc/')
	    #flavor=${2#kernel-}

	    #echo "${package#$TAGS/} -> kabi/$arch/symvers-$flavor"
	    ts=$(sed -nre 's,^Source Timestamp: ,,p' "$package/cvsinfo")
	    if [ -z "$ts" ]; then
		echo "Could not extract a timestamp from $package/cvsinfo" >&2
		status=1
		continue
	    fi
	    if [ -z "$timestamp" -a -n "$ts" ]; then
		timestamp=$ts
		continue
	    elif [ "$timestamp" != "$ts" ]; then
		echo "Timestamps differ" >&2
		status=1
		continue
	    fi

	    #echo $ts
#	    if [ -z "$opt_dry_run" ]; then
#		mkdir -p kabi/$arch &&
#		zcat $package/symvers.gz > kabi/$arch/symvers-$flavor ||
#		status=1
#	    fi
	done
    done
fi

exit $status

# vim:shiftwidth=4 softtabstop=4
