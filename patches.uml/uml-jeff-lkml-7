X-Gnus-Mail-Source: file:/home/kraxel/News/.inbox.lists
Message-Id: <200409140727.i8E7RfL7005648@ccure.user-mode-linux.org>
X-Mailer: exmh version 2.4 06/23/2000 with nmh-1.1-RC1
To: akpm@osdl.org
cc: linux-kernel@vger.kernel.org
Subject: [PATCH] UML - Finish conversion to sigjmp_buf/siglongjmp
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Date: 	Tue, 14 Sep 2004 03:27:41 -0400
From: Jeff Dike <jdike@addtoit.com>
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
X-Mailing-List: 	linux-kernel@vger.kernel.org
X-Scanned-By: MIMEDefang 2.43
Lines: 125
Xref: bytesex.org mlist.linux-kernel:22349

UML needs to use siglongjmp instead of longjmp everywhere.  This patch fixes
the remaining longjmp/jmp_buf occurrences.

Signed-off-by: Jeff Dike <jdike@addtoit.com>

Index: uml-2.6.9-rc2/arch/um/kernel/process.c
===================================================================
--- uml-2.6.9-rc2.orig/arch/um/kernel/process.c	2004-09-16 16:13:40.000000000 +0200
+++ uml-2.6.9-rc2/arch/um/kernel/process.c	2004-09-16 16:58:51.751011548 +0200
@@ -297,7 +297,7 @@ void __init check_ptrace(void)
 
 int run_kernel_thread(int (*fn)(void *), void *arg, void **jmp_ptr)
 {
-	jmp_buf buf;
+	sigjmp_buf buf;
 	int n;
 
 	*jmp_ptr = &buf;
Index: uml-2.6.9-rc2/arch/um/kernel/skas/process.c
===================================================================
--- uml-2.6.9-rc2.orig/arch/um/kernel/skas/process.c	2004-09-16 16:10:15.000000000 +0200
+++ uml-2.6.9-rc2/arch/um/kernel/skas/process.c	2004-09-16 16:58:51.757010569 +0200
@@ -209,7 +209,7 @@ void new_thread(void *stack, void **swit
 		void (*handler)(int))
 {
 	unsigned long flags;
-	jmp_buf switch_buf, fork_buf;
+	sigjmp_buf switch_buf, fork_buf;
 
 	*switch_buf_ptr = &switch_buf;
 	*fork_buf_ptr = &fork_buf;
@@ -233,7 +233,7 @@ void new_thread(void *stack, void **swit
 
 void thread_wait(void *sw, void *fb)
 {
-	jmp_buf buf, **switch_buf = sw, *fork_buf;
+	sigjmp_buf buf, **switch_buf = sw, *fork_buf;
 
 	*switch_buf = &buf;
 	fork_buf = fb;
@@ -295,23 +295,23 @@ void restore_registers(union uml_pt_regs
 
 void switch_threads(void *me, void *next)
 {
-	jmp_buf my_buf, **me_ptr = me, *next_buf = next;
+	sigjmp_buf my_buf, **me_ptr = me, *next_buf = next;
 	
 	*me_ptr = &my_buf;
 	if(sigsetjmp(my_buf, 1) == 0)
 		siglongjmp(*next_buf, 1);
 }
 
-static jmp_buf initial_jmpbuf;
+static sigjmp_buf initial_jmpbuf;
 
 /* XXX Make these percpu */
 static void (*cb_proc)(void *arg);
 static void *cb_arg;
-static jmp_buf *cb_back;
+static sigjmp_buf *cb_back;
 
 int start_idle_thread(void *stack, void *switch_buf_ptr, void **fork_buf_ptr)
 {
-	jmp_buf **switch_buf = switch_buf_ptr;
+	sigjmp_buf **switch_buf = switch_buf_ptr;
 	int n;
 
 	*fork_buf_ptr = &initial_jmpbuf;
@@ -347,7 +347,7 @@ void remove_sigstack(void)
 
 void initial_thread_cb_skas(void (*proc)(void *), void *arg)
 {
-	jmp_buf here;
+	sigjmp_buf here;
 
 	cb_proc = proc;
 	cb_arg = arg;
Index: uml-2.6.9-rc2/arch/um/kernel/trap_user.c
===================================================================
--- uml-2.6.9-rc2.orig/arch/um/kernel/trap_user.c	2004-09-16 16:10:15.000000000 +0200
+++ uml-2.6.9-rc2/arch/um/kernel/trap_user.c	2004-09-16 16:13:41.000000000 +0200
@@ -127,7 +127,7 @@ void alarm_handler(int sig, struct sigco
 
 void do_longjmp(void *b, int val)
 {
-	jmp_buf *buf = b;
+	sigjmp_buf *buf = b;
 
 	siglongjmp(*buf, val);
 }
Index: uml-2.6.9-rc2/arch/um/kernel/tt/uaccess_user.c
===================================================================
--- uml-2.6.9-rc2.orig/arch/um/kernel/tt/uaccess_user.c	2004-09-16 16:10:15.000000000 +0200
+++ uml-2.6.9-rc2/arch/um/kernel/tt/uaccess_user.c	2004-09-16 16:13:41.000000000 +0200
@@ -72,7 +72,7 @@ int __do_strnlen_user(const char *str, u
 	struct tt_regs save = TASK_REGS(get_current())->tt;
 	int ret;
 	unsigned long *faddrp = (unsigned long *)fault_addr;
-	jmp_buf jbuf;
+	sigjmp_buf jbuf;
 
 	*fault_catcher = &jbuf;
 	if(sigsetjmp(jbuf, 1) == 0)
Index: uml-2.6.9-rc2/arch/um/kernel/uaccess_user.c
===================================================================
--- uml-2.6.9-rc2.orig/arch/um/kernel/uaccess_user.c	2004-09-16 16:10:15.000000000 +0200
+++ uml-2.6.9-rc2/arch/um/kernel/uaccess_user.c	2004-09-16 16:13:41.000000000 +0200
@@ -17,8 +17,8 @@ unsigned long __do_user_copy(void *to, c
 					int n), int *faulted_out)
 {
 	unsigned long *faddrp = (unsigned long *) fault_addr, ret;
+	sigjmp_buf jbuf;
 
-	jmp_buf jbuf;
 	*fault_catcher = &jbuf;
 	if(sigsetjmp(jbuf, 1) == 0){
 		(*op)(to, from, n);
