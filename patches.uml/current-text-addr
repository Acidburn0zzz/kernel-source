# Provide a good implementation of current_text_addr for i386
#
# Signed-off-by: Paolo 'Blaisorblade' Giarrusso <blaisorblade_spam@yahoo.it>
Index: uml-2.6.9-rc2/include/asm-um/processor-generic.h
===================================================================
--- uml-2.6.9-rc2.orig/include/asm-um/processor-generic.h	2004-09-16 16:35:05.837336173 +0200
+++ uml-2.6.9-rc2/include/asm-um/processor-generic.h	2004-09-16 16:37:08.598390544 +0200
@@ -16,8 +16,6 @@ struct task_struct;
 
 struct mm_struct;
 
-#define current_text_addr() ((void *) 0)
-
 #define cpu_relax()   barrier()
 
 struct thread_struct {
Index: uml-2.6.9-rc2/include/asm-um/processor-i386.h
===================================================================
--- uml-2.6.9-rc2.orig/include/asm-um/processor-i386.h	2004-09-16 16:35:05.851333899 +0200
+++ uml-2.6.9-rc2/include/asm-um/processor-i386.h	2004-09-16 16:37:08.599390381 +0200
@@ -19,6 +19,13 @@ struct arch_thread {
 
 #include "asm/arch/user.h"
 
+/*
+ * Default implementation of macro that returns current
+ * instruction pointer ("program counter"). Stolen
+ * from asm-i386/processor.h
+ */
+#define current_text_addr() ({ void *pc; __asm__("movl $1f,%0\n1:":"=g" (pc)); pc; })
+
 #include "asm/processor-generic.h"
 
 #endif
