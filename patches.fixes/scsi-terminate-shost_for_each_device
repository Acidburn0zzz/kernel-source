From: Mike Christie <mikec@us.ibm.com>
Ref: http://marc.theaimsgroup.com/?l=linux-scsi&m=109886580930570&w=2

The problem with using shost_for_each_device wrt to the above oops is
that scsi_forget_host sets the state to SDEV_CANCEL, so that when
scsi_host_cancel iterates over the devices using shost_for_each_device
it cannot get a handle to the sdev (scsi_device_get fails becuase the
state is set to SDEV_CANCEL). And, __scsi_iterate_devices does not clear
the next pointer if this happens, so I think this is needed to fix just
the refcount bug in shost_for_each_device.

--- linux-2.6.8/drivers/scsi/scsi.c.orig	2004-10-27 14:44:28.194584880 +0200
+++ linux-2.6.8/drivers/scsi/scsi.c	2004-10-27 15:13:30.524671768 +0200
@@ -1044,6 +1044,7 @@
 		if (!scsi_device_get(next))
 			break;
 		list = list->next;
+		next = NULL;
 	}
 	spin_unlock_irqrestore(shost->host_lock, flags);
 
