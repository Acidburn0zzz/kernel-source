--- linux-2.6.4/fs/open.c.overflow	2004-04-01 22:22:25.000000000 +0200
+++ linux-2.6.4/fs/open.c	2004-04-01 22:27:13.000000000 +0200
@@ -57,10 +57,17 @@
 		memcpy(buf, &st, sizeof(st));
 	else {
 		if (sizeof buf->f_blocks == 4) {
-			if ((st.f_blocks | st.f_bfree |
-			     st.f_bavail | st.f_files | st.f_ffree) &
+			if ((st.f_blocks | st.f_bfree | st.f_bavail) &
 			    0xffffffff00000000ULL)
 				return -EOVERFLOW;
+			/* f_files and f_ffree may be -1; it's okay
+			 * to stuff that into 32 bits */
+			if (st.f_files != 0xffffffffffffffffULL
+			 && (st.f_files & 0xffffffff00000000ULL))
+				return -EOVERFLOW;
+			if (st.f_ffree != 0xffffffffffffffffULL
+			 && (st.f_ffree & 0xffffffff00000000ULL))
+				return -EOVERFLOW;
 		}
 
 		buf->f_type = st.f_type;
