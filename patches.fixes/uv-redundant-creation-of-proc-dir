Subject: [PATCH] UV: redundant creation of sgi_uv
To: linux-kernel@vger.kernel.org
Cc: mingo@elte.hu
From: Cliff Wickman <cpw@sgi.com>
Patch-mainline: 2.6.28?
References: bnc#444799

There is a collision between two UV functions:
  both uv_ptc_init() and gru_proc_init() try to make /proc/sgi_uv

So move it's creation to a single place: uv_system_init()

Diffed against 2.6.28-rc3

Signed-off-by: Cliff Wickman <cpw@sgi.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 arch/x86/kernel/genx2apic_uv_x.c |    2 ++
 arch/x86/kernel/tlb_uv.c         |    4 ----
 2 files changed, 2 insertions(+), 4 deletions(-)

--- a/arch/x86/kernel/genx2apic_uv_x.c
+++ b/arch/x86/kernel/genx2apic_uv_x.c
@@ -20,6 +20,7 @@
 #include <linux/module.h>
 #include <linux/hardirq.h>
 #include <linux/timer.h>
+#include <linux/proc_fs.h>
 #include <asm/current.h>
 #include <asm/smp.h>
 #include <asm/ipi.h>
@@ -577,5 +578,6 @@ void __init uv_system_init(void)
 	uv_scir_register_cpu_notifier();
 
 	uv_cpu_init();
+ 	proc_mkdir("sgi_uv", NULL);
 }
 
--- a/arch/x86/kernel/tlb_uv.c
+++ b/arch/x86/kernel/tlb_uv.c
@@ -566,14 +566,10 @@ static int __init uv_ptc_init(void)
 	if (!is_uv_system())
 		return 0;
 
-	if (!proc_mkdir("sgi_uv", NULL))
-		return -EINVAL;
-
 	proc_uv_ptc = create_proc_entry(UV_PTC_BASENAME, 0444, NULL);
 	if (!proc_uv_ptc) {
 		printk(KERN_ERR "unable to create %s proc entry\n",
 		       UV_PTC_BASENAME);
-		remove_proc_entry("sgi_uv", NULL);
 		return -EINVAL;
 	}
 	proc_uv_ptc->proc_fops = &proc_uv_ptc_operations;
