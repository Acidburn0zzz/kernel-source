Subject: Don't flip ordered color on a soft barrier
Patch-mainline: 2.6.16-rc1-mm2
References: 

From: Tejun Heo <htejun@gmail.com>

q->ordcolor must not be flipped on SOFTBARRIER.

Signed-off-by: Tejun Heo <htejun@gmail.com>
Signed-off-by: Jens Axboe <axboe@suse.de>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Acked-by: 

---

 block/elevator.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletion(-)

diff -puN block/elevator.c~block-request_queue-ordcolor-must-not-be-flipped-on-softbarrier block/elevator.c
--- devel/block/elevator.c~block-request_queue-ordcolor-must-not-be-flipped-on-softbarrier	2006-01-16 00:55:13.000000000 -0800
+++ devel-akpm/block/elevator.c	2006-01-16 00:55:13.000000000 -0800
@@ -336,7 +336,8 @@ void __elv_add_request(request_queue_t *
 		/*
 		 * toggle ordered color
 		 */
-		q->ordcolor ^= 1;
+		if (blk_barrier_rq(rq))
+			q->ordcolor ^= 1;
 
 		/*
 		 * barriers implicitly indicate back insertion
_
