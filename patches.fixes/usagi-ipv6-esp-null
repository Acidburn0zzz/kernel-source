
	Improved consistency checks: if the requested algorithm
	is NULL, alg_key_len may contain random garbage.

--- linux-2.6.1/net/ipv6/esp6.c	2004-01-09 07:59:45.000000000 +0100
+++ linux-2.6.1/net/ipv6/esp6.c	2003-08-23 10:02:16.000000000 +0200
@@ -372,7 +372,7 @@
 		if (x->aalg->alg_key_len == 0 || x->aalg->alg_key_len > 512)
 			goto error;
 	}
-	if (x->ealg == NULL)
+	if (x->ealg == NULL || (x->ealg->alg_key_len == 0 && x->props.ealgo != SADB_EALG_NULL))
 		goto error;
 
 	esp = kmalloc(sizeof(*esp), GFP_KERNEL);
@@ -411,11 +411,13 @@
 			goto error;
 	}
 	esp->conf.key = x->ealg->alg_key;
-	esp->conf.key_len = (x->ealg->alg_key_len+7)/8;
-	if (x->props.ealgo == SADB_EALG_NULL)
+	if (x->props.ealgo == SADB_EALG_NULL) {
+		esp->conf.key_len = 0;
 		esp->conf.tfm = crypto_alloc_tfm(x->ealg->alg_name, CRYPTO_TFM_MODE_ECB);
-	else
+	} else {
+		esp->conf.key_len = (x->ealg->alg_key_len+7)/8;
 		esp->conf.tfm = crypto_alloc_tfm(x->ealg->alg_name, CRYPTO_TFM_MODE_CBC);
+	}
 	if (esp->conf.tfm == NULL)
 		goto error;
 	esp->conf.ivlen = crypto_tfm_alg_ivsize(esp->conf.tfm);
