# This is a BitKeeper generated diff -Nru style patch.
#
# ChangeSet
#   2004/09/18 09:35:55-07:00 nickpiggin@yahoo.com.au 
#   [PATCH] fix missing unlock_page in mm/rmap.c
#   
#   A required unlock_page will be missed in a very rare (but possible) race
#   condition. Acked by Hugh, who says:
#   
#   	It'll be hard to hit because of the additional page_mapped test above,
#   	with truncate unmapping ptes from mms before it advances to removing
#   	pages from cache; but nothing to prevent it happening.
#   
#   Signed-off-by: Nick Piggin <nickpiggin@yahoo.com.au>
#   Signed-off-by: Hugh Dickins <hugh@veritas.com>
#   Signed-off-by: Linus Torvalds <torvalds@osdl.org>
# 
# mm/rmap.c
#   2004/09/18 03:46:41-07:00 nickpiggin@yahoo.com.au +3 -2
#   fix missing unlock_page in mm/rmap.c
# 
diff -Nru a/mm/rmap.c b/mm/rmap.c
--- a/mm/rmap.c	2004-09-20 00:09:48 -07:00
+++ b/mm/rmap.c	2004-09-20 00:09:48 -07:00
@@ -405,8 +405,9 @@
 			referenced += page_referenced_file(page);
 		else if (TestSetPageLocked(page))
 			referenced++;
-		else if (page->mapping) {
-			referenced += page_referenced_file(page);
+		else {
+			if (page->mapping)
+				referenced += page_referenced_file(page);
 			unlock_page(page);
 		}
 	}
