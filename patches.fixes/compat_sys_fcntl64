From: gordon.jin@intel.com (Gordon Jin)
Subject: fcntl(F_GETLK): Allow negative start and len values
References: 47963

POSIX-2001 allows negative l_len and l_start values in calls
to fcntl(F_GETLK).

Acked-by: agruen@suse.de

Index: linux-2.6.10/fs/compat.c
===================================================================
--- linux-2.6.10.orig/fs/compat.c	2005-01-13 10:29:33.000000000 +0100
+++ linux-2.6.10/fs/compat.c	2005-01-13 10:32:47.000000000 +0100
@@ -542,6 +542,13 @@ asmlinkage long compat_sys_fcntl64(unsig
 		ret = sys_fcntl(fd, cmd, (unsigned long)&f);
 		set_fs(old_fs);
 		if (cmd == F_GETLK && ret == 0) {
+			/* POSIX-2001 now defines negative l_len from fcntl man page */
+			if (f.l_len < 0) {	
+				f.l_start += f.l_len;
+				f.l_len = -f.l_len;
+			}
+			if (f.l_start < 0) 
+				return -EINVAL;
 			if ((f.l_start >= COMPAT_OFF_T_MAX) ||
 			    ((f.l_start + f.l_len) > COMPAT_OFF_T_MAX))
 				ret = -EOVERFLOW;
@@ -563,6 +570,13 @@ asmlinkage long compat_sys_fcntl64(unsig
 				(unsigned long)&f);
 		set_fs(old_fs);
 		if (cmd == F_GETLK64 && ret == 0) {
+			/* POSIX-2001 now defines negative l_len from fcntl man page */
+			if (f.l_len < 0) {
+				f.l_start += f.l_len;
+				f.l_len = -f.l_len;
+			}
+			if (f.l_start < 0)
+				return -EINVAL;
 			if ((f.l_start >= COMPAT_LOFF_T_MAX) ||
 			    ((f.l_start + f.l_len) > COMPAT_LOFF_T_MAX))
 				ret = -EOVERFLOW;
