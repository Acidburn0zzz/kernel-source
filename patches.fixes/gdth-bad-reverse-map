From: Jens Axboe <axboe@suse.de>
Subject: Fix gdth oops on highmem/iommu mapped sg entries
Patch-mainline: 
Suse-bugzilla: 48424

From bugzilla: With the original SLES9 kernel (kernel-smp-2.6.5-7.97)
the system started fine but after some minutes freezes.  With the newer
kernel 2.6.5-7.111-smp the system freezes immediately after starting.

Jens' analysis: gdth_copy_internal_data() is buggy, it uses phys_to_virt()
on an sg dma address to map it into the kernel. The whole pci_map_sg()
stuff isn't even needed, but I'll leave that for another update.

Signed-off-by: Jens Axboe <axboe@suse.de>

--- linux-2.6.5/drivers/scsi/gdth.c~	2004-11-23 18:18:36.141732541 +0100
+++ linux-2.6.5/drivers/scsi/gdth.c	2004-11-23 18:20:03.854292078 +0100
@@ -2719,6 +2719,7 @@
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(2,4,13)
         sgcnt = pci_map_sg(ha->pdev,sl,scp->use_sg,PCI_DMA_FROMDEVICE);
         for (i=0,cpsum=0; i<sgcnt; ++i,++sl) {
+	    unsigned long flags;
             cpnow = (ushort)sg_dma_len(sl);
             TRACE(("copy_internal() now %d sum %d count %d %d\n",
                           cpnow,cpsum,cpcount,(ushort)scp->bufflen));
@@ -2730,8 +2731,11 @@
                        hanum);
                 return;
             }
-            address = (char *)(page_address(sl->page) + sl->offset);
+	    local_irq_save(flags);
+	    address = kmap_atomic(sl->page, KM_BIO_SRC_IRQ) + sl->offset;
             memcpy(address,buffer,cpnow);
+	    kunmap_atomic(address, KM_BIO_SRC_IRQ);
+	    local_irq_restore(flags);
             if (cpsum == cpcount)
                 break;
             buffer += cpnow;
