Date: Mon, May 29 2006 14:31:56 +1000
From: David Chinner <dgc@sgi.com>
References: SGI:PV952967
Subject: Don't dirty the inode if it being freed in xfs_iunpin

Stop a BUG from occurring in generic_delete_inode by preventing
transaction completion from marking the inode dirty while it is being
cleaned up on its way out of the system.

Acked-by: Andreas Gruenbacher <agruen@suse.de>

--- a/fs/xfs/xfs_inode.c	2006-05-29 14:31:57.000000000 +1000
+++ b/fs/xfs/xfs_inode.c	2006-05-29 14:31:57.000000000 +1000
@@ -2757,7 +2757,8 @@ xfs_iunpin(
 			if (vp) {
 				struct inode	*inode = vn_to_inode(vp);
 
-				if (!(inode->i_state & I_NEW))
+				if (!(inode->i_state &
+						(I_NEW|I_FREEING|I_CLEAR)))
 					mark_inode_dirty_sync(inode);
 			}
 		}
