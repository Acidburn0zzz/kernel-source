From: Neil Brown <neilb@suse.de>
Subject: Make sure QUEUE_FLAG_CLUSTER is set properly for md.
Patch-mainline: yes
References: 90365

This flag should be set for a virtual device iff it is set
for all underlying devices.

Signed-off-by: Neil Brown <neilb@suse.de>

### Diffstat output
 ./block/ll_rw_blk.c |    2 ++
 ./drivers/md/md.c   |    1 +
 2 files changed, 3 insertions(+)

Acked-by: 

Index: linux-2.6.15/block/ll_rw_blk.c
===================================================================
--- linux-2.6.15.orig/block/ll_rw_blk.c	2006-02-09 17:05:19.000000000 +1100
+++ linux-2.6.15/block/ll_rw_blk.c	2006-02-09 17:07:35.000000000 +1100
@@ -780,6 +780,8 @@
 	t->max_hw_segments = min(t->max_hw_segments,b->max_hw_segments);
 	t->max_segment_size = min(t->max_segment_size,b->max_segment_size);
 	t->hardsect_size = max(t->hardsect_size,b->hardsect_size);
+	if (!test_bit(QUEUE_FLAG_CLUSTER, &b->queue_flags))
+		clear_bit(QUEUE_FLAG_CLUSTER, &t->queue_flags);
 }
 
 EXPORT_SYMBOL(blk_queue_stack_limits);
Index: linux-2.6.15/drivers/md/md.c
===================================================================
--- linux-2.6.15.orig/drivers/md/md.c	2006-02-09 17:04:52.000000000 +1100
+++ linux-2.6.15/drivers/md/md.c	2006-02-09 17:07:35.000000000 +1100
@@ -263,6 +263,7 @@
 		kfree(new);
 		return NULL;
 	}
+	set_bit(QUEUE_FLAG_CLUSTER, &new->queue->queue_flags);
 
 	blk_queue_make_request(new->queue, md_fail_request);
 
