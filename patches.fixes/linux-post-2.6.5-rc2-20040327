diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/Kconfig linux-post-2.6.5-rc2-20040327/arch/arm/Kconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/Kconfig	2004-03-19 06:04:54.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/Kconfig	2004-03-25 17:56:53.000000000 +0000
@@ -75,28 +75,6 @@ choice
 config ARCH_ADIFCC
 	bool "ADIFCC-based"
 
-config ARCH_ANAKIN
-	bool "Anakin"
-	---help---
-	  The Anakin is a StrongArm based SA110 - 2 DIN Vehicle Telematics Platform.
-	  64MB SDRAM - 4 Mb Flash - Compact Flash Interface - 1 MB VRAM
-
-	  On board peripherals:
-	  * Front display: 400x234 16 bit TFT touchscreen
-	  * External independent second screen interface
-	  * CAN controller SJA1000
-	  * USB host controller
-	  * 6 channel video codec with hardware overlay
-	  * Smartcard reader
-	  * IrDa
-
-	  Modules interfaced over the Multi Media Extension slots:
-	  * A communication card
-	  Wavecom GPRS modem
-	  uBlock GPS
-	  Bosch DAB module
-	  * An audio card ( 4 * 40W, AC97 Codec, I2S)
-
 config ARCH_CLPS7500
 	bool "Cirrus-CL-PS7500FE"
 
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/Makefile linux-post-2.6.5-rc2-20040327/arch/arm/Makefile
--- linux-post-2.6.5-rc2-20040326/arch/arm/Makefile	2004-02-19 10:47:57.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/Makefile	2004-03-25 17:56:53.000000000 +0000
@@ -96,7 +96,6 @@ endif
 textaddr-$(CONFIG_ARCH_CLPS711X)   := 0xc0028000
  machine-$(CONFIG_ARCH_CLPS711X)   := clps711x
 textaddr-$(CONFIG_ARCH_FORTUNET)   := 0xc0008000
- machine-$(CONFIG_ARCH_ANAKIN)	   := anakin
  machine-$(CONFIG_ARCH_IOP3XX)	   := iop3xx
  machine-$(CONFIG_ARCH_ADIFCC)	   := adifcc
 
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/boot/Makefile linux-post-2.6.5-rc2-20040327/arch/arm/boot/Makefile
--- linux-post-2.6.5-rc2-20040326/arch/arm/boot/Makefile	2003-10-16 10:13:58.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/boot/Makefile	2004-03-25 17:56:54.000000000 +0000
@@ -47,7 +47,6 @@ endif
 params_phys-$(CONFIG_ARCH_SA1100)	:= 0xc0000100
 initrd_phys-$(CONFIG_ARCH_SA1100)	:= 0xc0800000
    zreladdr-$(CONFIG_ARCH_PXA)		:= 0xa0008000
-   zreladdr-$(CONFIG_ARCH_ANAKIN)	:= 0x20008000
    zreladdr-$(CONFIG_ARCH_IOP3XX)	:= 0xa0008000
 params_phys-$(CONFIG_ARCH_IOP3XX)	:= 0xa0000100
    zreladdr-$(CONFIG_ARCH_ADIFCC)	:= 0xc0008000
@@ -82,7 +81,7 @@ $(obj)/zImage:	$(obj)/compressed/vmlinux
 	$(call if_changed,objcopy)
 	@echo '  Kernel: $@ is ready'
 
-quite_cmd_uimage = UIMAGE $@
+quiet_cmd_uimage = UIMAGE  $@
       cmd_uimage = $(CONFIG_SHELL) $(MKIMAGE) -A arm -O linux -T kernel \
 		   -C none -a $(ZRELADDR) -e $(ZRELADDR) \
 		   -n 'Linux-$(KERNELRELEASE)' -d $< $@
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/common/amba.c linux-post-2.6.5-rc2-20040327/arch/arm/common/amba.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/common/amba.c	2004-02-27 17:17:05.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/common/amba.c	2004-03-25 17:43:00.000000000 +0000
@@ -199,8 +199,12 @@ int amba_device_register(struct amba_dev
 
 	dev->dev.release = amba_device_release;
 	dev->dev.bus = &amba_bustype;
+	dev->dev.dma_mask = &dev->dma_mask;
 	dev->res.name = dev->dev.bus_id;
 
+	if (!dev->dev.coherent_dma_mask && dev->dma_mask)
+		dev_warn(&dev->dev, "coherent dma mask is unset\n");
+
 	ret = request_resource(parent, &dev->res);
 	if (ret == 0) {
 		tmp = ioremap(dev->res.start, SZ_4K);
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/common/sa1111.c linux-post-2.6.5-rc2-20040327/arch/arm/common/sa1111.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/common/sa1111.c	2004-02-22 15:51:55.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/common/sa1111.c	2004-03-25 17:43:00.000000000 +0000
@@ -516,6 +516,8 @@ sa1111_configure_smc(struct sa1111 *sach
 	 */
 	if (sachip->dev->dma_mask)
 		*sachip->dev->dma_mask &= sa1111_dma_mask[drac >> 2];
+
+	sachip->dev->coherent_dma_mask &= sa1111_dma_mask[drac >> 2];
 }
 
 #endif
@@ -558,6 +560,7 @@ sa1111_init_one_child(struct sa1111 *sac
 	dev->dev.parent  = sachip->dev;
 	dev->dev.bus     = &sa1111_bus_type;
 	dev->dev.release = sa1111_dev_release;
+	dev->dev.coherent_dma_mask = sachip->dev->coherent_dma_mask;
 	dev->res.start   = sachip->phys + info->offset;
 	dev->res.end     = dev->res.start + 511;
 	dev->res.name    = dev->dev.bus_id;
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/adi_evb_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/adi_evb_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/adi_evb_defconfig	2003-09-19 08:47:45.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/adi_evb_defconfig	2004-03-25 17:56:54.000000000 +0000
@@ -28,7 +28,6 @@ CONFIG_MODULES=y
 # System Type
 #
 CONFIG_ARCH_ADIFCC=y
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -417,8 +416,6 @@ CONFIG_SERIAL_CONSOLE=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/adsbitsy_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/adsbitsy_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/adsbitsy_defconfig	2003-09-19 08:47:46.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/adsbitsy_defconfig	2004-03-25 17:56:54.000000000 +0000
@@ -25,7 +25,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -581,7 +580,6 @@ CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_CLPS711X is not set
 # CONFIG_FB_CYBER2000 is not set
 CONFIG_FB_SA1100=y
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_E1355 is not set
 # CONFIG_FB_VIRTUAL is not set
 # CONFIG_FBCON_ADVANCED is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/assabet_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/assabet_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/assabet_defconfig	2003-09-19 08:47:48.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/assabet_defconfig	2004-03-25 17:56:54.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -527,8 +526,6 @@ CONFIG_VT=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
@@ -773,7 +770,6 @@ CONFIG_PC_KEYMAP=y
 CONFIG_FB=y
 CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_ACORN is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_CLPS711X is not set
 CONFIG_FB_SA1100=y
 # CONFIG_FB_CYBER2000 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/badge4_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/badge4_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/badge4_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/badge4_defconfig	2004-03-25 17:56:54.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -654,8 +653,6 @@ CONFIG_SOUND_GAMEPORT=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/cerfcube_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/cerfcube_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/cerfcube_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/cerfcube_defconfig	2004-03-25 17:56:55.000000000 +0000
@@ -45,7 +45,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
 # CONFIG_ARCH_CO285 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/ebsa110_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/ebsa110_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/ebsa110_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/ebsa110_defconfig	2004-03-25 17:56:55.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_ARCH_EBSA110=y
 # CONFIG_ARCH_RPC is not set
 # CONFIG_ARCH_SA1100 is not set
 # CONFIG_ARCH_CLPS711X is not set
-# CONFIG_ARCH_ANAKIN is not set
 
 #
 # Archimedes/A5000 Implementations
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/epxa10db_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/epxa10db_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/epxa10db_defconfig	2003-09-19 08:48:01.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/epxa10db_defconfig	2004-03-25 17:56:55.000000000 +0000
@@ -32,7 +32,6 @@ CONFIG_OBSOLETE_MODPARM=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/flexanet_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/flexanet_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/flexanet_defconfig	2003-09-19 08:48:02.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/flexanet_defconfig	2004-03-25 17:56:55.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -513,8 +512,6 @@ CONFIG_VT=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
@@ -716,7 +713,6 @@ CONFIG_PC_KEYMAP=y
 CONFIG_FB=y
 CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_ACORN is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_CLPS711X is not set
 CONFIG_FB_SA1100=y
 # CONFIG_FB_CYBER2000 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/fortunet_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/fortunet_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/fortunet_defconfig	2003-09-19 08:48:05.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/fortunet_defconfig	2004-03-25 17:56:55.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_EXPERIMENTAL=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 CONFIG_ARCH_CLPS711X=y
@@ -343,8 +342,6 @@ CONFIG_UNIX=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 CONFIG_SERIAL_CLPS711X=y
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/graphicsclient_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/graphicsclient_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/graphicsclient_defconfig	2003-09-19 08:48:08.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/graphicsclient_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -25,7 +25,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -687,7 +686,6 @@ CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_CLPS711X is not set
 # CONFIG_FB_CYBER2000 is not set
 CONFIG_FB_SA1100=y
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_E1355 is not set
 # CONFIG_FB_VIRTUAL is not set
 # CONFIG_FBCON_ADVANCED is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/graphicsmaster_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/graphicsmaster_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/graphicsmaster_defconfig	2003-09-19 08:48:09.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/graphicsmaster_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -25,7 +25,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -662,7 +661,6 @@ CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_CLPS711X is not set
 # CONFIG_FB_CYBER2000 is not set
 CONFIG_FB_SA1100=y
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_E1355 is not set
 # CONFIG_FB_VIRTUAL is not set
 # CONFIG_FBCON_ADVANCED is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/h3600_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/h3600_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/h3600_defconfig	2003-09-19 08:48:11.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/h3600_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -516,8 +515,6 @@ CONFIG_SERIAL=m
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
@@ -753,7 +750,6 @@ CONFIG_PC_KEYMAP=y
 CONFIG_FB=y
 CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_ACORN is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_CLPS711X is not set
 CONFIG_FB_SA1100=y
 # CONFIG_FB_CYBER2000 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/hackkit_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/hackkit_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/hackkit_defconfig	2003-09-19 08:48:12.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/hackkit_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -32,7 +32,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/integrator_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/integrator_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/integrator_defconfig	2003-09-19 08:48:15.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/integrator_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_ARCH_INTEGRATOR=y
 # CONFIG_ARCH_RPC is not set
 # CONFIG_ARCH_SA1100 is not set
 # CONFIG_ARCH_CLPS711X is not set
-# CONFIG_ARCH_ANAKIN is not set
 
 #
 # Archimedes/A5000 Implementations
@@ -620,7 +619,6 @@ CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_CLPS711X is not set
 # CONFIG_FB_CYBER2000 is not set
 # CONFIG_FB_SA1100 is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_E1355 is not set
 # CONFIG_FB_MATROX is not set
 # CONFIG_FB_ATY is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/iq80310_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/iq80310_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/iq80310_defconfig	2003-09-19 08:48:16.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/iq80310_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -39,7 +39,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
 # CONFIG_ARCH_CO285 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/iq80321_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/iq80321_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/iq80321_defconfig	2004-02-05 19:38:13.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/iq80321_defconfig	2004-03-25 17:56:56.000000000 +0000
@@ -39,7 +39,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
 # CONFIG_ARCH_CO285 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/jornada720_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/jornada720_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/jornada720_defconfig	2003-09-19 08:48:19.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/jornada720_defconfig	2004-03-25 17:56:57.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_KMOD=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -518,8 +517,6 @@ CONFIG_SERIAL=m
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
@@ -730,7 +727,6 @@ CONFIG_PC_KEYMAP=y
 CONFIG_FB=y
 CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_ACORN is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_CLPS711X is not set
 # CONFIG_FB_SA1100 is not set
 CONFIG_FB_EPSON1356=y
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/lart_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/lart_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/lart_defconfig	2003-10-08 08:22:19.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/lart_defconfig	2004-03-25 17:56:57.000000000 +0000
@@ -44,7 +44,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
 # CONFIG_ARCH_CO285 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/lubbock_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/lubbock_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/lubbock_defconfig	2003-09-19 08:48:21.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/lubbock_defconfig	2004-03-25 17:56:57.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_MODULES=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -583,8 +582,6 @@ CONFIG_SERIAL_8250_CONSOLE=y
 #
 # CONFIG_ATOMWIDE_SERIAL is not set
 # CONFIG_DUALSP_SERIAL is not set
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/lusl7200_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/lusl7200_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/lusl7200_defconfig	2003-09-19 08:48:22.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/lusl7200_defconfig	2004-03-25 17:56:57.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -314,8 +313,6 @@ CONFIG_SERIAL_NONSTANDARD=y
 #
 # CONFIG_ATOMWIDE_SERIAL is not set
 # CONFIG_DUALSP_SERIAL is not set
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/neponset_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/neponset_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/neponset_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/neponset_defconfig	2004-03-25 17:56:57.000000000 +0000
@@ -31,7 +31,6 @@ CONFIG_MODULES=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/netwinder_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/netwinder_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/netwinder_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/netwinder_defconfig	2004-03-25 17:56:58.000000000 +0000
@@ -40,7 +40,6 @@ CONFIG_IOSCHED_DEADLINE=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
 # CONFIG_ARCH_CO285 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/pangolin_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/pangolin_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/pangolin_defconfig	2003-09-19 08:48:26.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/pangolin_defconfig	2004-03-25 17:56:58.000000000 +0000
@@ -25,7 +25,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -662,7 +661,6 @@ CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_CYBER2000 is not set
 # CONFIG_FB_SA1100 is not set
 CONFIG_FB_MQ200=y
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_E1355 is not set
 # CONFIG_FB_VIRTUAL is not set
 CONFIG_FBCON_ADVANCED=y
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/pleb_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/pleb_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/pleb_defconfig	2003-09-19 08:48:32.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/pleb_defconfig	2004-03-25 17:56:58.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_KMOD=y
 # CONFIG_ARCH_RPC is not set
 CONFIG_ARCH_SA1100=y
 # CONFIG_ARCH_CLPS711X is not set
-# CONFIG_ARCH_ANAKIN is not set
 
 #
 # Archimedes/A5000 Implementations
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/rpc_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/rpc_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/rpc_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/rpc_defconfig	2004-03-25 17:56:58.000000000 +0000
@@ -31,7 +31,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/shannon_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/shannon_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/shannon_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/shannon_defconfig	2004-03-25 17:56:58.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/shark_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/shark_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/shark_defconfig	2003-10-21 19:47:29.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/shark_defconfig	2004-03-25 17:56:58.000000000 +0000
@@ -46,7 +46,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
 # CONFIG_ARCH_CO285 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/stork_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/stork_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/stork_defconfig	2003-09-19 08:48:39.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/stork_defconfig	2004-03-25 17:56:59.000000000 +0000
@@ -28,7 +28,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -514,8 +513,6 @@ CONFIG_SERIAL_CONSOLE=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
@@ -753,7 +750,6 @@ CONFIG_PC_KEYMAP=y
 CONFIG_FB=y
 CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_ACORN is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_CLPS711X is not set
 CONFIG_FB_SA1100=y
 # CONFIG_FB_CYBER2000 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/system3_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/system3_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/system3_defconfig	2003-09-19 08:48:40.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/system3_defconfig	2004-03-25 17:56:59.000000000 +0000
@@ -27,7 +27,6 @@ CONFIG_MODULES=y
 #
 # System Type
 #
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -532,8 +531,6 @@ CONFIG_VT=y
 #
 # Serial drivers
 #
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
@@ -799,7 +796,6 @@ CONFIG_PC_KEYMAP=y
 CONFIG_FB=y
 CONFIG_DUMMY_CONSOLE=y
 # CONFIG_FB_ACORN is not set
-# CONFIG_FB_ANAKIN is not set
 # CONFIG_FB_CLPS711X is not set
 CONFIG_FB_SA1100=y
 # CONFIG_FB_CYBER2000 is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/configs/trizeps_defconfig linux-post-2.6.5-rc2-20040327/arch/arm/configs/trizeps_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/configs/trizeps_defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/configs/trizeps_defconfig	2004-03-25 17:56:59.000000000 +0000
@@ -35,7 +35,6 @@ CONFIG_KMOD=y
 # System Type
 #
 # CONFIG_ARCH_ADIFCC is not set
-# CONFIG_ARCH_ANAKIN is not set
 # CONFIG_ARCH_ARCA5K is not set
 # CONFIG_ARCH_CLPS7500 is not set
 # CONFIG_ARCH_CLPS711X is not set
@@ -601,8 +600,6 @@ CONFIG_SOUND_GAMEPORT=y
 # CONFIG_SERIAL_8250_MULTIPORT is not set
 # CONFIG_SERIAL_8250_RSA is not set
 # CONFIG_SERIAL_ACORN is not set
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/kernel/debug.S linux-post-2.6.5-rc2-20040327/arch/arm/kernel/debug.S
--- linux-post-2.6.5-rc2-20040326/arch/arm/kernel/debug.S	2003-04-15 15:12:47.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/kernel/debug.S	2004-03-25 17:56:59.000000000 +0000
@@ -348,37 +348,6 @@
 1002:
 		.endm
 
-#elif defined(CONFIG_ARCH_ANAKIN)
-
-//#//include <asm/arch/serial_reg.h>
-
-		.macro	addruart,rx
-		mrc	p15, 0, \rx, c1, c0
-		tst	\rx, #1			@ MMU enabled?
-		moveq	\rx, #IO_START
-		movne	\rx, #IO_BASE
-		add	\rx, \rx, #UART0
-		.endm
-
-		.macro	senduart,rd,rx
-		str	\rd, [\rx, #0x14]	@ tx
-		ldr	\rd, [\rx, #0x18]
-		orr	\rd, \rd, #SENDREQUEST
-		str	\rd, [\rx, #0x18]
-		.endm
-
-		.macro	waituart,rd,rx
-1001:		ldr	\rd, [\rx, #0x10]
-		tst	\rd, #TXEMPTY
-		beq	1001b
-		.endm
-
-		.macro	busyuart,rd,rx
-1001:		ldr	\rd, [\rx, #0x10]
-		tst	\rd, #CTS
-		bne	1001b
-		.endm
-
 #elif defined(CONFIG_ARCH_CAMELOT)
 
 #include <asm/arch/excalibur.h>
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/kernel/entry-armv.S linux-post-2.6.5-rc2-20040327/arch/arm/kernel/entry-armv.S
--- linux-post-2.6.5-rc2-20040326/arch/arm/kernel/entry-armv.S	2004-01-30 16:23:55.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/kernel/entry-armv.S	2004-03-25 17:56:59.000000000 +0000
@@ -530,33 +530,6 @@ ENTRY(soft_irq_mask)
 		.macro	irq_prio_table
 		.endm
 
-#elif defined(CONFIG_ARCH_ANAKIN)
-
-		.macro	disable_fiq
-		.endm
-
-		.macro	get_irqnr_and_base, irqnr, irqstat, base, tmp
-		mov	\base, #IO_BASE
-		mov	\irqstat, #INTERRUPT_CONTROLLER
-		ldr	\tmp, =anakin_irq_mask
-		ldr	\irqstat, [\base, \irqstat]
-		ldr	\tmp, [\tmp]
-		ands	\irqstat, \irqstat, \tmp
-		ldrne	\tmp, =anakin_active_irqs
-		strne	\irqstat, [\tmp]
-		movne	\irqnr, #IRQ_ANAKIN
-		.endm
-
-		.macro	irq_prio_table
-		.ltorg
-		.bss
-ENTRY(anakin_irq_mask)
-		.word	0
-ENTRY(anakin_active_irqs)
-		.space	4
-		.text
-		.endm
-
 #elif defined(CONFIG_ARCH_IOP310) || defined(CONFIG_ARCH_ADIFCC)
 
 		.macro	disable_fiq
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/Makefile linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/Makefile
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/Makefile	2003-02-03 22:19:35.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/Makefile	1970-01-01 00:00:00.000000000 +0000
@@ -1,11 +0,0 @@
-#
-# Makefile for the linux kernel.
-#
-
-# Object file lists.
-
-obj-y			:= arch.o irq.o mm.o
-obj-m			:=
-obj-n			:=
-obj-			:=
-
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/arch.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/arch.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/arch.c	2003-09-20 09:38:17.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/arch.c	1970-01-01 00:00:00.000000000 +0000
@@ -1,29 +0,0 @@
-/*
- *  linux/arch/arm/mach-anakin/arch.c
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 W/TTC	Created
- */
-#include <linux/tty.h>
-#include <linux/init.h>
-
-#include <asm/setup.h>
-#include <asm/mach-types.h>
-#include <asm/mach/arch.h>
-
-extern void anakin_map_io(void);
-extern void genarch_init_irq(void);
-
-MACHINE_START(ANAKIN, "Anakin")
-	MAINTAINER("Wookey/Tak-Shing Chan")
-	BOOT_MEM(0x20000000, 0x40000000, 0xe0000000)
-	VIDEO(0x80000000, 0x8002db40)
-	MAPIO(anakin_map_io)
-	INITIRQ(genarch_init_irq)
-MACHINE_END
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/irq.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/irq.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/irq.c	2002-11-17 15:31:07.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/irq.c	1970-01-01 00:00:00.000000000 +0000
@@ -1,83 +0,0 @@
-/*
- *  linux/arch/arm/mach-anakin/irq.c
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   10-Apr-2001 TTC	Created
- */
-
-#include <linux/ptrace.h>
-#include <linux/interrupt.h>
-#include <linux/init.h>
-
-#include <asm/irq.h>
-#include <asm/mach/irq.h>
-
-extern unsigned int anakin_irq_mask, anakin_active_irqs;
-extern void do_IRQ(int, struct pt_regs *);
-
-static void
-anakin_mask_irq(unsigned int irq)
-{
-	anakin_irq_mask &= ~(1 << irq);
-}
-
-static void
-anakin_unmask_irq(unsigned int irq)
-{
-	anakin_irq_mask |= (1 << irq);
-}
-
-/*
- * This is a faked interrupt to deal with parallel interrupt requests
- * on the Anakin.  Make sure that its interrupt number is not in any
- * way conflicting with the hardware interrupt numbers!  Check
- * IRQ_ANAKIN in linux/include/asm-arm/arch-anakin/irqs.h.
- */
-static void
-anakin_interrupt(int irq, void *dev_id, struct pt_regs *regs)
-{
-	for (irq = 0; irq < NR_IRQS; irq++)
-		if (anakin_active_irqs & (1 << irq))
-			do_IRQ(irq, regs);
-}
-
-static struct irqaction anakin_irq = {
-	.name		= "Anakin IRQ",
-	.handler	= anakin_interrupt,
-	.flags		= SA_INTERRUPT
-};
- 
-void __init
-irq_init_irq(void)
-{
-	unsigned int irq;
-
-	for (irq = 0; irq < NR_IRQS; irq++) {
-		switch (irq) {
-		case IRQ_UART0:
-		case IRQ_UART1:
-		case IRQ_UART2:
-		case IRQ_TICK:
-		case IRQ_CODEC:
-		case IRQ_UART4:
-		case IRQ_TOUCHSCREEN:
-		case IRQ_UART3:
-		case IRQ_FIFO:
-		case IRQ_CAN:
-		case IRQ_COMPACTFLASH:
-		case IRQ_BOSH:
-		case IRQ_ANAKIN:
-			irq_desc[irq].valid = 1;
-			irq_desc[irq].mask_ack = anakin_mask_irq;
-			irq_desc[irq].mask = anakin_mask_irq;
-			irq_desc[irq].unmask = anakin_unmask_irq;
-		}
-	}
-	setup_arm_irq(IRQ_ANAKIN, &anakin_irq);
-}
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/mm.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/mm.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-anakin/mm.c	2002-06-04 23:19:01.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-anakin/mm.c	1970-01-01 00:00:00.000000000 +0000
@@ -1,30 +0,0 @@
-/*
- *  linux/arch/arm/mach-anakin/mm.c
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 W/TTC	Created
- */
-#include <linux/kernel.h>
-#include <linux/init.h>
-
-#include <asm/io.h>
-#include <asm/pgtable.h>
-#include <asm/mach/map.h>
-
-static struct map_desc anakin_io_desc[] __initdata = {
-	{ IO_BASE,    IO_START,    IO_SIZE,    MT_DEVICE },
-	{ FLASH_BASE, FLASH_START, FLASH_SIZE, MT_DEVICE },
-	{ VGA_BASE,   VGA_START,   VGA_SIZE,   MT_DEVICE }
-};
-
-void __init
-anakin_map_io(void)
-{
-	iotable_init(anakin_io_desc, ARRAY_SIZE(anakin_io_desc));
-}
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/Kconfig linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/Kconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/Kconfig	2003-10-23 05:27:13.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/Kconfig	2004-03-25 10:03:35.000000000 +0000
@@ -204,7 +204,7 @@ config SA1100_OMNIMETER
 	depends on ARCH_SA1100
 	help
 	  Say Y here if you are using the inhand electronics OmniMeter.  See
-	  <http://www.inhandelectronics.com/html/omni1.html> for details.
+	  <http://www.inhandelectronics.com/omnimeter.asp> for details.
 
 config SA1100_PANGOLIN
 	bool "Pangolin"
@@ -232,7 +232,7 @@ config SA1100_PT_SYSTEM3
 	help
 	  Say Y here if you intend to build a kernel suitable to run on
 	  a Pruftechnik Digital Board. For more information see
-	  <http://www.pruftechnik.com>
+	  <http://www.pruftechnik.com/>
 
 config SA1100_SHANNON
 	bool "Shannon"
@@ -250,8 +250,8 @@ config SA1100_SHERMAN
 	  Say Y here to support the Blazie Engineering `Sherman' StrongARM
 	  1110-based SBC, used primarily in assistance products for the
 	  visually impaired.  The company is now Freedom Scientific, with
-	  a website at <http://www.freedomscientific.com/index.html>. The
-	  Sherman product, however, appears to have been discontinued.
+	  a website at <http://www.freedomscientific.com/>. The Sherman
+	  product, however, appears to have been discontinued.
 
 config SA1100_SIMPAD
 	bool "Simpad"
@@ -262,7 +262,7 @@ config SA1100_SIMPAD
 	  FLASH. The SL4 version got 64 MB RAM and 32 MB FLASH and a
 	  PCMCIA-Slot. The version for the Germany Telecom (DTAG) is the same
 	  like CL4 in additional it has a PCMCIA-Slot. For more information
-	  visit <http://www.my-siemens.com or www.siemens.ch>.
+	  visit <http://www.my-siemens.com/> or <http://www.siemens.ch/>.
 
 config SA1100_PFS168
 	bool "Tulsa"
@@ -280,7 +280,7 @@ config SA1100_VICTOR
 	help
 	  Say Y here if you are using a Visu Aide Intel(R) StrongARM(R)
 	  SA-1100 based Victor Digital Talking Book Reader.  See
-	  <http://www.visuaide.com/pagevictor.en.html> for information on
+	  <http://www.visuaide.com/products.html> for information on
 	  this system.
 
 config SA1100_XP860
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/adsbitsy.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/adsbitsy.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/adsbitsy.c	2003-08-15 22:22:53.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/adsbitsy.c	2004-03-25 17:43:00.000000000 +0000
@@ -47,6 +47,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/badge4.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/badge4.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/badge4.c	2003-08-15 22:22:53.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/badge4.c	2004-03-25 17:43:00.000000000 +0000
@@ -55,6 +55,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask;
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/generic.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/generic.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/generic.c	2004-02-27 17:03:10.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/generic.c	2004-03-25 17:43:00.000000000 +0000
@@ -162,6 +162,7 @@ static struct platform_device sa11x0udc_
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa11x0udc_dma_mask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa11x0udc_resources),
 	.resource	= sa11x0udc_resources,
@@ -212,6 +213,7 @@ static struct platform_device sa11x0mcp_
 	.id		= 0,
 	.dev = {
 		.dma_mask = &sa11x0mcp_dma_mask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa11x0mcp_resources),
 	.resource	= sa11x0mcp_resources,
@@ -232,6 +234,7 @@ static struct platform_device sa11x0ssp_
 	.id		= 0,
 	.dev = {
 		.dma_mask = &sa11x0ssp_dma_mask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa11x0ssp_resources),
 	.resource	= sa11x0ssp_resources,
@@ -253,6 +256,9 @@ static struct resource sa11x0fb_resource
 static struct platform_device sa11x0fb_device = {
 	.name		= "sa11x0-fb",
 	.id		= 0,
+	.dev = {
+		.coherent_dma_mask = 0xffffffff,
+	},
 	.num_resources	= ARRAY_SIZE(sa11x0fb_resources),
 	.resource	= sa11x0fb_resources,
 };
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/graphicsmaster.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/graphicsmaster.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/graphicsmaster.c	2003-08-15 22:22:53.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/graphicsmaster.c	2004-03-25 17:43:01.000000000 +0000
@@ -44,6 +44,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/jornada720.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/jornada720.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/jornada720.c	2003-08-15 22:22:53.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/jornada720.c	2004-03-25 17:43:01.000000000 +0000
@@ -44,6 +44,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/neponset.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/neponset.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/neponset.c	2004-02-06 19:35:37.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/neponset.c	2004-03-25 17:43:01.000000000 +0000
@@ -251,6 +251,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/pfs168.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/pfs168.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/pfs168.c	2003-09-20 09:38:17.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/pfs168.c	2004-03-25 17:43:01.000000000 +0000
@@ -38,6 +38,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/system3.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/system3.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/system3.c	2003-08-15 22:22:54.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/system3.c	2004-03-25 17:43:01.000000000 +0000
@@ -393,6 +393,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/xp860.c linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/xp860.c
--- linux-post-2.6.5-rc2-20040326/arch/arm/mach-sa1100/xp860.c	2003-08-15 22:22:54.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mach-sa1100/xp860.c	2004-03-25 17:43:01.000000000 +0000
@@ -45,6 +45,7 @@ static struct platform_device sa1111_dev
 	.id		= 0,
 	.dev		= {
 		.dma_mask = &sa1111_dmamask,
+		.coherent_dma_mask = 0xffffffff,
 	},
 	.num_resources	= ARRAY_SIZE(sa1111_resources),
 	.resource	= sa1111_resources,
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm/mm/Kconfig linux-post-2.6.5-rc2-20040327/arch/arm/mm/Kconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm/mm/Kconfig	2004-02-20 23:32:19.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm/mm/Kconfig	2004-03-25 17:57:00.000000000 +0000
@@ -185,8 +185,8 @@ config CPU_ARM1026
 
 # SA110
 config CPU_SA110
-	bool "Support StrongARM(R) SA-110 processor" if !ARCH_EBSA110 && !FOOTBRIDGE && !ARCH_TBOX && !ARCH_SHARK && !ARCH_NEXUSPCI && !ARCH_ANAKIN && ARCH_RPC
-	default y if ARCH_EBSA110 || FOOTBRIDGE || ARCH_TBOX || ARCH_SHARK || ARCH_NEXUSPCI || ARCH_ANAKIN
+	bool "Support StrongARM(R) SA-110 processor" if !ARCH_EBSA110 && !FOOTBRIDGE && !ARCH_TBOX && !ARCH_SHARK && !ARCH_NEXUSPCI && ARCH_RPC
+	default y if ARCH_EBSA110 || FOOTBRIDGE || ARCH_TBOX || ARCH_SHARK || ARCH_NEXUSPCI
 	select CPU_32v3 if ARCH_RPC
 	select CPU_32v4 if !ARCH_RPC
 	select CPU_ABRT_EV4
diff -purN linux-post-2.6.5-rc2-20040326/arch/arm26/defconfig linux-post-2.6.5-rc2-20040327/arch/arm26/defconfig
--- linux-post-2.6.5-rc2-20040326/arch/arm26/defconfig	2004-03-17 12:02:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/arm26/defconfig	2004-03-25 17:57:00.000000000 +0000
@@ -164,8 +164,6 @@ CONFIG_SOUND_GAMEPORT=y
 # CONFIG_SERIAL_8250_RSA is not set
 # CONFIG_ATOMWIDE_SERIAL is not set
 # CONFIG_DUALSP_SERIAL is not set
-# CONFIG_SERIAL_ANAKIN is not set
-# CONFIG_SERIAL_ANAKIN_CONSOLE is not set
 # CONFIG_SERIAL_AMBA is not set
 # CONFIG_SERIAL_AMBA_CONSOLE is not set
 # CONFIG_SERIAL_CLPS711X is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/i386/kernel/acpi/boot.c linux-post-2.6.5-rc2-20040327/arch/i386/kernel/acpi/boot.c
--- linux-post-2.6.5-rc2-20040326/arch/i386/kernel/acpi/boot.c	2004-03-23 06:32:11.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/i386/kernel/acpi/boot.c	2004-03-26 22:50:48.000000000 +0000
@@ -277,7 +277,7 @@ acpi_parse_ioapic (
  * Parse Interrupt Source Override for the ACPI SCI
  */
 static void
-acpi_parse_sci_int_src_ovr(u8 bus_irq, u16 polarity, u16 trigger, u32 global_irq)
+acpi_sci_ioapic_setup(u32 gsi, u16 polarity, u16 trigger)
 {
 	if (trigger == 0)	/* compatible SCI trigger is level */
 		trigger = 3;
@@ -292,13 +292,18 @@ acpi_parse_sci_int_src_ovr(u8 bus_irq, u
 	if (acpi_sci_flags.polarity)
 		polarity = acpi_sci_flags.polarity;
 
-	mp_override_legacy_irq(bus_irq, polarity, trigger, global_irq);
+	/*
+ 	 * mp_config_acpi_legacy_irqs() already setup IRQs < 16
+	 * If GSI is < 16, this will update its flags,
+	 * else it will create a new mp_irqs[] entry.
+	 */
+	mp_override_legacy_irq(gsi, polarity, trigger, gsi);
 
 	/*
 	 * stash over-ride to indicate we've been here
 	 * and for later update of acpi_fadt
 	 */
-	acpi_sci_override_gsi = global_irq;
+	acpi_sci_override_gsi = gsi;
 	return;
 }
 
@@ -315,9 +320,8 @@ acpi_parse_int_src_ovr (
 	acpi_table_print_madt_entry(header);
 
 	if (intsrc->bus_irq == acpi_fadt.sci_int) {
-		acpi_parse_sci_int_src_ovr(intsrc->bus_irq,
-			intsrc->flags.polarity, intsrc->flags.trigger,
-			intsrc->global_irq);
+		acpi_sci_ioapic_setup(intsrc->global_irq,
+			intsrc->flags.polarity, intsrc->flags.trigger);
 		return 0;
 	}
 
@@ -660,7 +664,7 @@ acpi_parse_madt_ioapic_entries(void)
 	 * pretend we got one so we can set the SCI flags.
 	 */
 	if (!acpi_sci_override_gsi)
-		acpi_parse_sci_int_src_ovr(acpi_fadt.sci_int, 0, 0, acpi_fadt.sci_int);
+		acpi_sci_ioapic_setup(acpi_fadt.sci_int, 0, 0);
 
 	count = acpi_table_parse_madt(ACPI_MADT_NMI_SRC, acpi_parse_nmi_src, NR_IRQ_VECTORS);
 	if (count < 0) {
diff -purN linux-post-2.6.5-rc2-20040326/arch/ia64/configs/sn2_defconfig linux-post-2.6.5-rc2-20040327/arch/ia64/configs/sn2_defconfig
--- linux-post-2.6.5-rc2-20040326/arch/ia64/configs/sn2_defconfig	2004-03-15 13:55:41.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/ia64/configs/sn2_defconfig	2004-03-25 14:18:56.000000000 +0000
@@ -48,31 +48,26 @@ CONFIG_MMU=y
 CONFIG_RWSEM_XCHGADD_ALGORITHM=y
 CONFIG_TIME_INTERPOLATION=y
 CONFIG_EFI=y
-# CONFIG_ITANIUM is not set
-CONFIG_MCKINLEY=y
 # CONFIG_IA64_GENERIC is not set
 # CONFIG_IA64_DIG is not set
 # CONFIG_IA64_HP_ZX1 is not set
 CONFIG_IA64_SGI_SN2=y
 # CONFIG_IA64_HP_SIM is not set
+# CONFIG_ITANIUM is not set
+CONFIG_MCKINLEY=y
 # CONFIG_IA64_PAGE_SIZE_4KB is not set
 # CONFIG_IA64_PAGE_SIZE_8KB is not set
 CONFIG_IA64_PAGE_SIZE_16KB=y
 # CONFIG_IA64_PAGE_SIZE_64KB is not set
-CONFIG_ACPI=y
-CONFIG_ACPI_INTERPRETER=y
-CONFIG_ACPI_KERNEL_CONFIG=y
 CONFIG_IA64_L1_CACHE_SHIFT=7
 # CONFIG_MCKINLEY_ASTEP_SPECIFIC is not set
 CONFIG_NUMA=y
 CONFIG_VIRTUAL_MEM_MAP=y
 CONFIG_DISCONTIGMEM=y
-CONFIG_IA64_MCA=y
 # CONFIG_IA64_CYCLONE is not set
 CONFIG_IOSAPIC=y
-# CONFIG_IA64_SGI_SN_SIM is not set
+CONFIG_IA64_SGI_SN_SIM=y
 CONFIG_FORCE_MAX_ZONEORDER=18
-# CONFIG_IA64_PAL_IDLE is not set
 CONFIG_SMP=y
 CONFIG_NR_CPUS=512
 # CONFIG_PREEMPT is not set
@@ -86,9 +81,15 @@ CONFIG_BINFMT_ELF=y
 # CONFIG_BINFMT_MISC is not set
 
 #
+# Power management and ACPI
+#
+CONFIG_ACPI=y
+
+#
 # ACPI (Advanced Configuration and Power Interface) Support
 #
 CONFIG_ACPI_BOOT=y
+CONFIG_ACPI_INTERPRETER=y
 # CONFIG_ACPI_BUTTON is not set
 # CONFIG_ACPI_FAN is not set
 # CONFIG_ACPI_PROCESSOR is not set
@@ -98,6 +99,10 @@ CONFIG_ACPI_BUS=y
 CONFIG_ACPI_POWER=y
 CONFIG_ACPI_PCI=y
 CONFIG_ACPI_SYSTEM=y
+
+#
+# Bus options (PCI, PCMCIA)
+#
 CONFIG_PCI=y
 CONFIG_PCI_DOMAINS=y
 CONFIG_PCI_LEGACY_PROC=y
@@ -106,7 +111,13 @@ CONFIG_PCI_NAMES=y
 #
 # PCI Hotplug Support
 #
-# CONFIG_HOTPLUG_PCI is not set
+CONFIG_HOTPLUG_PCI=y
+# CONFIG_HOTPLUG_PCI_FAKE is not set
+# CONFIG_HOTPLUG_PCI_ACPI is not set
+# CONFIG_HOTPLUG_PCI_CPCI is not set
+# CONFIG_HOTPLUG_PCI_PCIE is not set
+# CONFIG_HOTPLUG_PCI_SHPC is not set
+CONFIG_HOTPLUG_PCI_SGI=y
 
 #
 # PCMCIA/CardBus support
@@ -120,7 +131,7 @@ CONFIG_PCI_NAMES=y
 #
 # Generic Driver Options
 #
-# CONFIG_FW_LOADER is not set
+CONFIG_FW_LOADER=m
 # CONFIG_DEBUG_DRIVER is not set
 
 #
@@ -140,13 +151,12 @@ CONFIG_PCI_NAMES=y
 #
 # Block devices
 #
-# CONFIG_BLK_DEV_FD is not set
 # CONFIG_BLK_CPQ_DA is not set
 # CONFIG_BLK_CPQ_CISS_DA is not set
 CONFIG_BLK_DEV_DAC960=m
 CONFIG_BLK_DEV_UMEM=m
 CONFIG_BLK_DEV_LOOP=y
-# CONFIG_BLK_DEV_CRYPTOLOOP is not set
+CONFIG_BLK_DEV_CRYPTOLOOP=m
 CONFIG_BLK_DEV_NBD=m
 # CONFIG_BLK_DEV_CARMEL is not set
 CONFIG_BLK_DEV_RAM=y
@@ -272,6 +282,7 @@ CONFIG_SCSI_SATA=y
 CONFIG_SCSI_SATA_SVW=m
 CONFIG_SCSI_ATA_PIIX=m
 CONFIG_SCSI_SATA_PROMISE=m
+# CONFIG_SCSI_SATA_SIL is not set
 CONFIG_SCSI_SATA_VIA=m
 CONFIG_SCSI_SATA_VITESSE=y
 # CONFIG_SCSI_BUSLOGIC is not set
@@ -314,12 +325,12 @@ CONFIG_MD_RAID5=y
 # CONFIG_MD_RAID6 is not set
 CONFIG_MD_MULTIPATH=y
 CONFIG_BLK_DEV_DM=y
-# CONFIG_DM_CRYPT is not set
+CONFIG_DM_CRYPT=m
 
 #
 # Fusion MPT device support
 #
-CONFIG_FUSION=m
+CONFIG_FUSION=y
 CONFIG_FUSION_MAX_SGE=40
 CONFIG_FUSION_ISENSE=m
 CONFIG_FUSION_CTL=m
@@ -364,7 +375,6 @@ CONFIG_IP_MROUTE=y
 CONFIG_IP_PIMSM_V1=y
 CONFIG_IP_PIMSM_V2=y
 CONFIG_ARPD=y
-# CONFIG_INET_ECN is not set
 CONFIG_SYN_COOKIES=y
 CONFIG_INET_AH=m
 CONFIG_INET_ESP=m
@@ -460,7 +470,6 @@ CONFIG_XFRM_USER=m
 #
 # SCTP Configuration (EXPERIMENTAL)
 #
-CONFIG_IPV6_SCTP__=m
 # CONFIG_IP_SCTP is not set
 # CONFIG_ATM is not set
 CONFIG_VLAN_8021Q=m
@@ -490,6 +499,7 @@ CONFIG_NET_SCH_TEQL=m
 CONFIG_NET_SCH_TBF=m
 CONFIG_NET_SCH_GRED=m
 CONFIG_NET_SCH_DSMARK=m
+# CONFIG_NET_SCH_DELAY is not set
 # CONFIG_NET_SCH_INGRESS is not set
 CONFIG_NET_QOS=y
 CONFIG_NET_ESTIMATOR=y
@@ -523,12 +533,10 @@ CONFIG_TUN=m
 # Ethernet (10 or 100Mbit)
 #
 CONFIG_NET_ETHERNET=y
-CONFIG_MII=y
+CONFIG_MII=m
 # CONFIG_HAPPYMEAL is not set
 # CONFIG_SUNGEM is not set
-CONFIG_NET_VENDOR_3COM=y
-CONFIG_VORTEX=m
-CONFIG_TYPHOON=m
+# CONFIG_NET_VENDOR_3COM is not set
 
 #
 # Tulip family network device support
@@ -550,7 +558,7 @@ CONFIG_NET_PCI=y
 # CONFIG_B44 is not set
 # CONFIG_FORCEDETH is not set
 # CONFIG_DGRS is not set
-CONFIG_EEPRO100=y
+CONFIG_EEPRO100=m
 # CONFIG_EEPRO100_PIO is not set
 # CONFIG_E100 is not set
 # CONFIG_FEALNX is not set
@@ -582,7 +590,8 @@ CONFIG_TIGON3=y
 #
 # Ethernet (10000 Mbit)
 #
-# CONFIG_IXGB is not set
+CONFIG_IXGB=m
+# CONFIG_IXGB_NAPI is not set
 # CONFIG_FDDI is not set
 # CONFIG_HIPPI is not set
 CONFIG_PPP=m
@@ -606,7 +615,7 @@ CONFIG_PPP_DEFLATE=m
 # CONFIG_TR is not set
 CONFIG_NET_FC=y
 # CONFIG_SHAPER is not set
-# CONFIG_NETCONSOLE is not set
+CONFIG_NETCONSOLE=y
 
 #
 # Wan interfaces
@@ -627,8 +636,10 @@ CONFIG_NET_FC=y
 # Bluetooth support
 #
 # CONFIG_BT is not set
-# CONFIG_NETPOLL is not set
-# CONFIG_NET_POLL_CONTROLLER is not set
+CONFIG_NETPOLL=y
+# CONFIG_NETPOLL_RX is not set
+# CONFIG_NETPOLL_TRAP is not set
+CONFIG_NET_POLL_CONTROLLER=y
 
 #
 # ISDN subsystem
@@ -674,9 +685,13 @@ CONFIG_SERIO_I8042=y
 CONFIG_INPUT_KEYBOARD=y
 CONFIG_KEYBOARD_ATKBD=y
 # CONFIG_KEYBOARD_SUNKBD is not set
+# CONFIG_KEYBOARD_LKKBD is not set
 # CONFIG_KEYBOARD_XTKBD is not set
 # CONFIG_KEYBOARD_NEWTON is not set
-# CONFIG_INPUT_MOUSE is not set
+CONFIG_INPUT_MOUSE=y
+CONFIG_MOUSE_PS2=y
+# CONFIG_MOUSE_SERIAL is not set
+# CONFIG_MOUSE_VSXXXAA is not set
 # CONFIG_INPUT_JOYSTICK is not set
 # CONFIG_INPUT_TOUCHSCREEN is not set
 # CONFIG_INPUT_MISC is not set
@@ -714,11 +729,6 @@ CONFIG_SERIAL_CORE_CONSOLE=y
 CONFIG_UNIX98_PTYS=y
 CONFIG_LEGACY_PTYS=y
 CONFIG_LEGACY_PTY_COUNT=256
-
-#
-# Mice
-#
-# CONFIG_BUSMOUSE is not set
 # CONFIG_QIC02_TAPE is not set
 
 #
@@ -742,7 +752,8 @@ CONFIG_EFI_RTC=y
 #
 # CONFIG_AGP is not set
 # CONFIG_DRM is not set
-# CONFIG_RAW_DRIVER is not set
+CONFIG_RAW_DRIVER=m
+CONFIG_MAX_RAW_DEVS=256
 
 #
 # I2C support
@@ -825,9 +836,9 @@ CONFIG_AUTOFS4_FS=y
 # CD-ROM/DVD Filesystems
 #
 CONFIG_ISO9660_FS=y
-# CONFIG_JOLIET is not set
+CONFIG_JOLIET=y
 # CONFIG_ZISOFS is not set
-# CONFIG_UDF_FS is not set
+CONFIG_UDF_FS=m
 
 #
 # DOS/FAT/NT Filesystems
@@ -887,6 +898,7 @@ CONFIG_SMB_FS=m
 # CONFIG_CIFS is not set
 # CONFIG_NCP_FS is not set
 # CONFIG_CODA_FS is not set
+# CONFIG_INTERMEZZO_FS is not set
 # CONFIG_AFS_FS is not set
 
 #
@@ -980,6 +992,7 @@ CONFIG_MAGIC_SYSRQ=y
 # CONFIG_IA64_DEBUG_CMPXCHG is not set
 # CONFIG_IA64_DEBUG_IRQ is not set
 # CONFIG_DEBUG_INFO is not set
+CONFIG_SYSVIPC_COMPAT=y
 
 #
 # Security options
@@ -1006,4 +1019,5 @@ CONFIG_CRYPTO_DES=m
 # CONFIG_CRYPTO_CAST6 is not set
 # CONFIG_CRYPTO_ARC4 is not set
 CONFIG_CRYPTO_DEFLATE=m
+# CONFIG_CRYPTO_MICHAEL_MIC is not set
 # CONFIG_CRYPTO_TEST is not set
diff -purN linux-post-2.6.5-rc2-20040326/arch/ia64/kernel/unwind.c linux-post-2.6.5-rc2-20040327/arch/ia64/kernel/unwind.c
--- linux-post-2.6.5-rc2-20040326/arch/ia64/kernel/unwind.c	2004-02-19 19:27:59.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/ia64/kernel/unwind.c	2004-03-26 00:36:55.000000000 +0000
@@ -1746,7 +1746,7 @@ run_script (struct unw_script *script, s
 			if (!state->pri_unat_loc)
 				state->pri_unat_loc = &state->sw->ar_unat;
 			/* register off. is a multiple of 8, so the least 3 bits (type) are 0 */
-			s[dst+1] = (*state->pri_unat_loc - s[dst]) | UNW_NAT_MEMSTK;
+			s[dst+1] = ((unsigned long) state->pri_unat_loc - s[dst]) | UNW_NAT_MEMSTK;
 			break;
 
 		      case UNW_INSN_SETNAT_TYPE:
diff -purN linux-post-2.6.5-rc2-20040326/arch/ia64/mm/fault.c linux-post-2.6.5-rc2-20040327/arch/ia64/mm/fault.c
--- linux-post-2.6.5-rc2-20040326/arch/ia64/mm/fault.c	2004-03-24 12:40:32.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/ia64/mm/fault.c	2004-03-25 15:23:45.000000000 +0000
@@ -233,7 +233,7 @@ ia64_do_page_fault (unsigned long addres
 	bust_spinlocks(1);
 
 	if (address < PAGE_SIZE)
-		printk(KERN_ALERT "Unable to handle kernel NULL pointer dereference");
+		printk(KERN_ALERT "Unable to handle kernel NULL pointer dereference (address %016lx)\n", address);
 	else
 		printk(KERN_ALERT "Unable to handle kernel paging request at "
 		       "virtual address %016lx\n", address);
diff -purN linux-post-2.6.5-rc2-20040326/arch/ppc/kernel/entry.S linux-post-2.6.5-rc2-20040327/arch/ppc/kernel/entry.S
--- linux-post-2.6.5-rc2-20040326/arch/ppc/kernel/entry.S	2004-03-23 22:47:12.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/ppc/kernel/entry.S	2004-03-25 03:10:41.000000000 +0000
@@ -171,9 +171,10 @@ _GLOBAL(DoSyscall)
 	bl	do_show_syscall
 #endif /* SHOW_SYSCALLS */
 	rlwinm	r10,r1,0,0,18	/* current_thread_info() */
+	lwz	r11,TI_LOCAL_FLAGS(r10)
+	rlwinm	r11,r11,0,~_TIFL_FORCE_NOERROR
+	stw	r11,TI_LOCAL_FLAGS(r10)
 	lwz	r11,TI_FLAGS(r10)
-	rlwinm	r11,r11,0,~_TIF_FORCE_NOERROR
-	stw	r11,TI_FLAGS(r10)
 	andi.	r11,r11,_TIF_SYSCALL_TRACE
 	bne-	syscall_dotrace
 syscall_dotrace_cont:
@@ -196,8 +197,8 @@ ret_from_syscall:
 	cmpl	0,r3,r11
 	rlwinm	r12,r1,0,0,18	/* current_thread_info() */
 	blt+	30f
-	lwz	r11,TI_FLAGS(r12)
-	andi.	r11,r11,_TIF_FORCE_NOERROR
+	lwz	r11,TI_LOCAL_FLAGS(r12)
+	andi.	r11,r11,_TIFL_FORCE_NOERROR
 	bne	30f
 	neg	r3,r3
 	lwz	r10,_CCR(r1)	/* Set SO bit in CR */
diff -purN linux-post-2.6.5-rc2-20040326/arch/ppc/kernel/process.c linux-post-2.6.5-rc2-20040327/arch/ppc/kernel/process.c
--- linux-post-2.6.5-rc2-20040326/arch/ppc/kernel/process.c	2004-03-24 01:55:33.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/ppc/kernel/process.c	2004-03-25 03:35:07.000000000 +0000
@@ -163,6 +163,7 @@ dump_altivec(struct pt_regs *regs, elf_v
 void
 enable_kernel_altivec(void)
 {
+	preempt_disable();
 #ifdef CONFIG_SMP
 	if (current->thread.regs && (current->thread.regs->msr & MSR_VEC))
 		giveup_altivec(current);
@@ -171,12 +172,14 @@ enable_kernel_altivec(void)
 #else
 	giveup_altivec(last_task_used_altivec);
 #endif /* __SMP __ */
+	preempt_enable();
 }
 #endif /* CONFIG_ALTIVEC */
 
 void
 enable_kernel_fp(void)
 {
+	preempt_disable();
 #ifdef CONFIG_SMP
 	if (current->thread.regs && (current->thread.regs->msr & MSR_FP))
 		giveup_fpu(current);
@@ -185,13 +188,16 @@ enable_kernel_fp(void)
 #else
 	giveup_fpu(last_task_used_math);
 #endif /* CONFIG_SMP */
+	preempt_enable();
 }
 
 int
 dump_task_fpu(struct task_struct *tsk, elf_fpregset_t *fpregs)
 {
-	if (tsk->thread.regs && tsk->thread.regs->msr & MSR_FP)
+	preempt_disable();
+	if (tsk->thread.regs && (tsk->thread.regs->msr & MSR_FP))
 		giveup_fpu(tsk);
+	preempt_enable();
 	memcpy(fpregs, &tsk->thread.fpr[0], sizeof(*fpregs));
 	return 1;
 }
@@ -329,12 +335,14 @@ void prepare_to_copy(struct task_struct 
 
 	if (regs == NULL)
 		return;
+	preempt_disable();
 	if (regs->msr & MSR_FP)
 		giveup_fpu(current);
 #ifdef CONFIG_ALTIVEC
 	if (regs->msr & MSR_VEC)
 		giveup_altivec(current);
 #endif /* CONFIG_ALTIVEC */
+	preempt_enable();
 }
 
 /*
@@ -479,12 +487,14 @@ int sys_execve(unsigned long a0, unsigne
 	error = PTR_ERR(filename);
 	if (IS_ERR(filename))
 		goto out;
+	preempt_disable();
 	if (regs->msr & MSR_FP)
 		giveup_fpu(current);
 #ifdef CONFIG_ALTIVEC
 	if (regs->msr & MSR_VEC)
 		giveup_altivec(current);
 #endif /* CONFIG_ALTIVEC */
+	preempt_enable();
 	error = do_execve(filename, (char __user *__user *) a1,
 			  (char __user *__user *) a2, regs);
 	if (error == 0)
diff -purN linux-post-2.6.5-rc2-20040326/arch/ppc/kernel/traps.c linux-post-2.6.5-rc2-20040327/arch/ppc/kernel/traps.c
--- linux-post-2.6.5-rc2-20040326/arch/ppc/kernel/traps.c	2004-02-24 23:45:08.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/ppc/kernel/traps.c	2004-03-25 02:21:47.000000000 +0000
@@ -391,14 +391,25 @@ check_bug_trap(struct pt_regs *regs)
 		return 0;
 	if (bug->line & BUG_WARNING_TRAP) {
 		/* this is a WARN_ON rather than BUG/BUG_ON */
+#ifdef CONFIG_XMON
+		xmon_printf(KERN_ERR "Badness in %s at %s:%d\n",
+		       bug->function, bug->file,
+		       bug->line & ~BUG_WARNING_TRAP);
+#endif /* CONFIG_XMON */		
 		printk(KERN_ERR "Badness in %s at %s:%d\n",
 		       bug->function, bug->file,
 		       bug->line & ~BUG_WARNING_TRAP);
 		dump_stack();
 		return 1;
 	}
+#ifdef CONFIG_XMON
+	xmon_printf(KERN_CRIT "kernel BUG in %s at %s:%d!\n",
+	       bug->function, bug->file, bug->line);
+	xmon(regs);
+#endif /* CONFIG_XMON */
 	printk(KERN_CRIT "kernel BUG in %s at %s:%d!\n",
 	       bug->function, bug->file, bug->line);
+
 	return 0;
 }
 
@@ -427,8 +438,14 @@ ProgramCheckException(struct pt_regs *re
 		int code = 0;
 		u32 fpscr;
 
+		/* We must make sure the FP state is consistent with
+		 * our MSR_FP in regs
+		 */
+		preempt_disable();
 		if (regs->msr & MSR_FP)
 			giveup_fpu(current);
+		preempt_enable();
+
 		fpscr = current->thread.fpscr;
 		fpscr &= fpscr << 22;	/* mask summary bits with enables */
 		if (fpscr & FPSCR_VX)
@@ -592,13 +609,17 @@ TAUException(struct pt_regs *regs)
 void
 AltivecAssistException(struct pt_regs *regs)
 {
+	preempt_disable();
 	if (regs->msr & MSR_VEC)
 		giveup_altivec(current);
+	preempt_enable();
+
 	/* XXX quick hack for now: set the non-Java bit in the VSCR */
 	current->thread.vscr.u[3] |= 0x10000;
 }
 #endif /* CONFIG_ALTIVEC */
 
+
 void __init trap_init(void)
 {
 }
diff -purN linux-post-2.6.5-rc2-20040326/arch/sparc64/kernel/signal32.c linux-post-2.6.5-rc2-20040327/arch/sparc64/kernel/signal32.c
--- linux-post-2.6.5-rc2-20040326/arch/sparc64/kernel/signal32.c	2003-11-18 02:10:35.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/sparc64/kernel/signal32.c	2004-03-26 22:16:00.000000000 +0000
@@ -394,7 +394,7 @@ segv:
 asmlinkage void do_rt_sigreturn32(struct pt_regs *regs)
 {
 	struct rt_signal_frame32 __user *sf;
-	unsigned int psr, pc, npc, fpu_save;
+	unsigned int psr, pc, npc, fpu_save, u_ss_sp;
 	mm_segment_t old_fs;
 	sigset_t set;
 	compat_sigset_t seta;
@@ -448,7 +448,8 @@ asmlinkage void do_rt_sigreturn32(struct
 	if (fpu_save)
 		err |= restore_fpu_state32(regs, &sf->fpu_state);
 	err |= copy_from_user(&seta, &sf->mask, sizeof(compat_sigset_t));
-	err |= __get_user((long)st.ss_sp, &sf->stack.ss_sp);
+	err |= __get_user(u_ss_sp, &sf->stack.ss_sp);
+	st.ss_sp = (void *) (long) u_ss_sp;
 	err |= __get_user(st.ss_flags, &sf->stack.ss_flags);
 	err |= __get_user(st.ss_size, &sf->stack.ss_size);
 	if (err)
@@ -977,7 +978,7 @@ asmlinkage int svr4_setcontext(svr4_ucon
 {
 	svr4_gregset_t  __user *gr;
 	mm_segment_t old_fs;
-	u32 pc, npc, psr;
+	u32 pc, npc, psr, u_ss_sp;
 	sigset_t set;
 	svr4_sigset_t setv;
 	int i, err;
@@ -1017,7 +1018,8 @@ asmlinkage int svr4_setcontext(svr4_ucon
 	if (_NSIG_WORDS >= 2)
 		set.sig[1] = setv.sigbits[2] | (((long)setv.sigbits[3]) << 32);
 	
-	err |= __get_user((long)st.ss_sp, &c->stack.sp);
+	err |= __get_user(u_ss_sp, &c->stack.sp);
+	st.ss_sp = (void *) (long) u_ss_sp;
 	err |= __get_user(st.ss_flags, &c->stack.flags);
 	err |= __get_user(st.ss_size, &c->stack.size);
 	if (err)
@@ -1310,9 +1312,9 @@ asmlinkage int do_sys32_sigstack(u32 u_s
 	
 	/* Now see if we want to update the new state. */
 	if (ssptr) {
-		void *ss_sp;
+		u32 ss_sp;
 
-		if (get_user((long)ss_sp, &ssptr->the_stack))
+		if (get_user(ss_sp, &ssptr->the_stack))
 			goto out;
 
 		/* If the current stack was set with sigaltstack, don't
@@ -1338,13 +1340,15 @@ out:
 asmlinkage int do_sys32_sigaltstack(u32 ussa, u32 uossa, unsigned long sp)
 {
 	stack_t uss, uoss;
+	u32 u_ss_sp = 0;
 	int ret;
 	mm_segment_t old_fs;
 	
-	if (ussa && (get_user((long)uss.ss_sp, &((stack_t32 __user *)(long)ussa)->ss_sp) ||
+	if (ussa && (get_user(u_ss_sp, &((stack_t32 __user *)(long)ussa)->ss_sp) ||
 		    __get_user(uss.ss_flags, &((stack_t32 __user *)(long)ussa)->ss_flags) ||
 		    __get_user(uss.ss_size, &((stack_t32 __user *)(long)ussa)->ss_size)))
 		return -EFAULT;
+	uss.ss_sp = (void *) (long) u_ss_sp;
 	old_fs = get_fs();
 	set_fs(KERNEL_DS);
 	ret = do_sigaltstack(ussa ? &uss : NULL, uossa ? &uoss : NULL, sp);
diff -purN linux-post-2.6.5-rc2-20040326/arch/sparc64/kernel/sys_sparc32.c linux-post-2.6.5-rc2-20040327/arch/sparc64/kernel/sys_sparc32.c
--- linux-post-2.6.5-rc2-20040326/arch/sparc64/kernel/sys_sparc32.c	2004-03-24 20:08:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/sparc64/kernel/sys_sparc32.c	2004-03-26 23:00:38.000000000 +0000
@@ -1104,7 +1104,7 @@ static int filldir(void * __buf, const c
 	copy_to_user(dirent->d_name, name, namlen);
 	put_user(0, dirent->d_name + namlen);
 	put_user(d_type, (char *) dirent + reclen - 1);
-	((char *) dirent) += reclen;
+	dirent = (void *) dirent + reclen;
 	buf->current_dir = dirent;
 	buf->count -= reclen;
 	return 0;
@@ -1781,9 +1781,12 @@ asmlinkage int sys32_sigaction (int sig,
 
         if (act) {
 		compat_old_sigset_t mask;
+		u32 u_handler, u_restorer;
 		
-		ret = get_user((long)new_ka.sa.sa_handler, &act->sa_handler);
-		ret |= __get_user((long)new_ka.sa.sa_restorer, &act->sa_restorer);
+		ret = get_user(u_handler, &act->sa_handler);
+		new_ka.sa.sa_handler = (void *) (long) u_handler;
+		ret |= __get_user(u_restorer, &act->sa_restorer);
+		new_ka.sa.sa_restorer = (void *) (long) u_restorer;
 		ret |= __get_user(new_ka.sa.sa_flags, &act->sa_flags);
 		ret |= __get_user(mask, &act->sa_mask);
 		if (ret)
@@ -1822,8 +1825,11 @@ sys32_rt_sigaction(int sig, struct sigac
 	set_thread_flag(TIF_NEWSIGNALS);
 
         if (act) {
+		u32 u_handler, u_restorer;
+
 		new_ka.ka_restorer = restorer;
-		ret = get_user((long)new_ka.sa.sa_handler, &act->sa_handler);
+		ret = get_user(u_handler, &act->sa_handler);
+		new_ka.sa.sa_handler = (void *) (long) u_handler;
 		ret |= __copy_from_user(&set32, &act->sa_mask, sizeof(compat_sigset_t));
 		switch (_NSIG_WORDS) {
 		case 4: new_ka.sa.sa_mask.sig[3] = set32.sig[6] | (((long)set32.sig[7]) << 32);
@@ -1832,7 +1838,8 @@ sys32_rt_sigaction(int sig, struct sigac
 		case 1: new_ka.sa.sa_mask.sig[0] = set32.sig[0] | (((long)set32.sig[1]) << 32);
 		}
 		ret |= __get_user(new_ka.sa.sa_flags, &act->sa_flags);
-		ret |= __get_user((long)new_ka.sa.sa_restorer, &act->sa_restorer);
+		ret |= __get_user(u_restorer, &act->sa_restorer);
+		new_ka.sa.sa_restorer = (void *) (long) u_restorer;
                 if (ret)
                 	return -EFAULT;
 	}
diff -purN linux-post-2.6.5-rc2-20040326/arch/sparc64/kernel/sys_sunos32.c linux-post-2.6.5-rc2-20040327/arch/sparc64/kernel/sys_sunos32.c
--- linux-post-2.6.5-rc2-20040326/arch/sparc64/kernel/sys_sunos32.c	2004-03-05 22:45:19.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/arch/sparc64/kernel/sys_sunos32.c	2004-03-26 22:16:26.000000000 +0000
@@ -302,7 +302,7 @@ static int sunos_filldir(void * __buf, c
 	put_user(reclen, &dirent->d_reclen);
 	copy_to_user(dirent->d_name, name, namlen);
 	put_user(0, dirent->d_name + namlen);
-	((char *) dirent) += reclen;
+	dirent = (void *) dirent + reclen;
 	buf->curr = dirent;
 	buf->count -= reclen;
 	return 0;
@@ -382,7 +382,7 @@ static int sunos_filldirentry(void * __b
 	put_user(reclen, &dirent->d_reclen);
 	copy_to_user(dirent->d_name, name, namlen);
 	put_user(0, dirent->d_name + namlen);
-	((char *) dirent) += reclen;
+	dirent = (void *) dirent + reclen;
 	buf->curr = dirent;
 	buf->count -= reclen;
 	return 0;
@@ -1276,10 +1276,12 @@ asmlinkage int sunos_sigaction (int sig,
 
 	if (act) {
 		compat_old_sigset_t mask;
+		u32 u_handler;
 
-		if (get_user((long)new_ka.sa.sa_handler, &((struct old_sigaction32 *)A(act))->sa_handler) ||
+		if (get_user(u_handler, &((struct old_sigaction32 *)A(act))->sa_handler) ||
 		    __get_user(new_ka.sa.sa_flags, &((struct old_sigaction32 *)A(act))->sa_flags))
 			return -EFAULT;
+		new_ka.sa.sa_handler = (void *) (long) u_handler;
 		__get_user(mask, &((struct old_sigaction32 *)A(act))->sa_mask);
 		new_ka.sa.sa_restorer = NULL;
 		new_ka.ka_restorer = NULL;
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/ec.c linux-post-2.6.5-rc2-20040327/drivers/acpi/ec.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/ec.c	2004-02-04 05:29:19.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/ec.c	2004-03-26 19:31:03.000000000 +0000
@@ -719,7 +719,7 @@ acpi_ec_start (
 	 * Install GPE handler
 	 */
 	status = acpi_install_gpe_handler(NULL, ec->gpe_bit,
-		ACPI_EVENT_EDGE_TRIGGERED, &acpi_ec_gpe_handler, ec);
+		ACPI_GPE_EDGE_TRIGGERED, &acpi_ec_gpe_handler, ec);
 	if (ACPI_FAILURE(status)) {
 		return_VALUE(-ENODEV);
 	}
@@ -803,7 +803,7 @@ acpi_ec_ecdt_probe (void)
 	 * Install GPE handler
 	 */
 	status = acpi_install_gpe_handler(NULL, ec_ecdt->gpe_bit,
-		ACPI_EVENT_EDGE_TRIGGERED, &acpi_ec_gpe_handler,
+		ACPI_GPE_EDGE_TRIGGERED, &acpi_ec_gpe_handler,
 		ec_ecdt);
 	if (ACPI_FAILURE(status)) {
 		goto error;
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evgpe.c linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evgpe.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evgpe.c	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evgpe.c	2004-03-26 18:47:08.000000000 +0000
@@ -99,9 +99,8 @@ acpi_ev_get_gpe_event_info (
 		return (NULL);
 	}
 
-	/*
-	 * A Non-null gpe_device means this is a GPE Block Device.
-	 */
+	/* A Non-NULL gpe_device means this is a GPE Block Device */
+
 	obj_desc = acpi_ns_get_attached_object ((struct acpi_namespace_node *) gpe_device);
 	if (!obj_desc ||
 		!obj_desc->device.gpe_block) {
@@ -297,7 +296,7 @@ acpi_ev_asynch_execute_gpe_method (
 		}
 	}
 
-	if (local_gpe_event_info.flags & ACPI_EVENT_LEVEL_TRIGGERED) {
+	if ((local_gpe_event_info.flags & ACPI_GPE_XRUPT_TYPE_MASK) == ACPI_GPE_LEVEL_TRIGGERED) {
 		/*
 		 * GPE is level-triggered, we clear the GPE status bit after handling
 		 * the event.
@@ -346,7 +345,7 @@ acpi_ev_gpe_dispatch (
 	 * If edge-triggered, clear the GPE status bit now.  Note that
 	 * level-triggered events are cleared after the GPE is serviced.
 	 */
-	if (gpe_event_info->flags & ACPI_EVENT_EDGE_TRIGGERED) {
+	if ((gpe_event_info->flags & ACPI_GPE_XRUPT_TYPE_MASK) == ACPI_GPE_EDGE_TRIGGERED) {
 		status = acpi_hw_clear_gpe (gpe_event_info);
 		if (ACPI_FAILURE (status)) {
 			ACPI_REPORT_ERROR (("acpi_ev_gpe_dispatch: Unable to clear GPE[%2X]\n",
@@ -369,7 +368,7 @@ acpi_ev_gpe_dispatch (
 
 		/* It is now safe to clear level-triggered events. */
 
-		if (gpe_event_info->flags & ACPI_EVENT_LEVEL_TRIGGERED) {
+		if ((gpe_event_info->flags & ACPI_GPE_XRUPT_TYPE_MASK) == ACPI_GPE_LEVEL_TRIGGERED) {
 			status = acpi_hw_clear_gpe (gpe_event_info);
 			if (ACPI_FAILURE (status)) {
 				ACPI_REPORT_ERROR ((
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evgpeblk.c linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evgpeblk.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evgpeblk.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evgpeblk.c	2004-03-26 18:47:07.000000000 +0000
@@ -168,11 +168,11 @@ unlock_and_exit:
  *              information for quick lookup during GPE dispatch
  *
  *              The name of each GPE control method is of the form:
- *                  "_Lnn" or "_Enn"
- *                  Where:
- *                      L      - means that the GPE is level triggered
- *                      E      - means that the GPE is edge triggered
- *                      nn     - is the GPE number [in HEX]
+ *              "_Lxx" or "_Exx"
+ *              Where:
+ *                  L      - means that the GPE is level triggered
+ *                  E      - means that the GPE is edge triggered
+ *                  xx     - is the GPE number [in HEX]
  *
  ******************************************************************************/
 
@@ -188,36 +188,41 @@ acpi_ev_save_method_info (
 	u32                             gpe_number;
 	char                            name[ACPI_NAME_SIZE + 1];
 	u8                              type;
-	acpi_status                     status;
 
 
 	ACPI_FUNCTION_TRACE ("ev_save_method_info");
 
 
-	/* Extract the name from the object and convert to a string */
-
+	/*
+	 * _Lxx and _Exx GPE method support
+	 *
+	 * 1) Extract the name from the object and convert to a string
+	 */
 	ACPI_MOVE_32_TO_32 (name,
 			   &((struct acpi_namespace_node *) obj_handle)->name.integer);
 	name[ACPI_NAME_SIZE] = 0;
 
 	/*
-	 * Edge/Level determination is based on the 2nd character
-	 * of the method name
+	 * 2) Edge/Level determination is based on the 2nd character
+	 *    of the method name
+	 *
+	 * NOTE: Default GPE type is RUNTIME.  May be changed later to WAKE if a
+	 * _PRW object is found that points to this GPE.
 	 */
 	switch (name[1]) {
 	case 'L':
-		type = ACPI_EVENT_LEVEL_TRIGGERED;
+		type = ACPI_GPE_LEVEL_TRIGGERED | ACPI_GPE_TYPE_RUNTIME;
 		break;
 
 	case 'E':
-		type = ACPI_EVENT_EDGE_TRIGGERED;
+		type = ACPI_GPE_EDGE_TRIGGERED | ACPI_GPE_TYPE_RUNTIME;
 		break;
 
 	default:
 		/* Unknown method type, just ignore it! */
 
 		ACPI_DEBUG_PRINT ((ACPI_DB_ERROR,
-			"Unknown GPE method type: %s (name not of form _Lnn or _Enn)\n",
+			"Unknown GPE method type: %s (name not of form _Lxx or _Exx)\n",
 			name));
 		return_ACPI_STATUS (AE_OK);
 	}
@@ -229,7 +234,7 @@ acpi_ev_save_method_info (
 		/* Conversion failed; invalid method, just ignore it */
 
 		ACPI_DEBUG_PRINT ((ACPI_DB_ERROR,
-			"Could not extract GPE number from name: %s (name is not of form _Lnn or _Enn)\n",
+			"Could not extract GPE number from name: %s (name is not of form _Lxx or _Exx)\n",
 			name));
 		return_ACPI_STATUS (AE_OK);
 	}
@@ -255,13 +260,6 @@ acpi_ev_save_method_info (
 	gpe_event_info->flags    = type;
 	gpe_event_info->method_node = (struct acpi_namespace_node *) obj_handle;
 
-	/* Enable the GPE (SCIs should be disabled at this point) */
-
-	status = acpi_hw_enable_gpe (gpe_event_info);
-	if (ACPI_FAILURE (status)) {
-		return_ACPI_STATUS (status);
-	}
-
 	ACPI_DEBUG_PRINT ((ACPI_DB_LOAD,
 		"Registered GPE method %s as GPE number 0x%.2X\n",
 		name, gpe_number));
@@ -271,6 +269,122 @@ acpi_ev_save_method_info (
 
 /*******************************************************************************
  *
+ * FUNCTION:    acpi_ev_get_gpe_type
+ *
+ * PARAMETERS:  Callback from walk_namespace
+ *
+ * RETURN:      Status
+ *
+ * DESCRIPTION: Called from acpi_walk_namespace. Expects each object to be a
+ *              Device.  Run the _PRW method.  If present, extract the GPE
+ *              number and mark the GPE as a WAKE GPE.
+ *
+ ******************************************************************************/
+
+static acpi_status
+acpi_ev_get_gpe_type (
+	acpi_handle                     obj_handle,
+	u32                             level,
+	void                            *info,
+	void                            **return_value)
+{
+	struct acpi_gpe_walk_info       *gpe_info = (void *) info;
+	struct acpi_namespace_node      *gpe_device;
+	struct acpi_gpe_block_info      *gpe_block;
+	struct acpi_namespace_node      *target_gpe_device;
+	struct acpi_gpe_event_info      *gpe_event_info;
+	union acpi_operand_object       *pkg_desc;
+	union acpi_operand_object       *obj_desc;
+	u32                             gpe_number;
+	acpi_status                     status;
+
+
+	ACPI_FUNCTION_TRACE ("ev_get_gpe_type");
+
+
+	/* Check for a _PRW method under this device */
+
+	status = acpi_ut_evaluate_object (obj_handle, METHOD_NAME__PRW,
+			 ACPI_BTYPE_PACKAGE, &pkg_desc);
+	if (status == AE_NOT_FOUND) {
+		return_ACPI_STATUS (AE_OK);
+	}
+	else if (ACPI_FAILURE (status)) {
+		return_ACPI_STATUS (status);
+	}
+
+	/* The returned _PRW package must have at least two elements */
+
+	if (pkg_desc->package.count < 2) {
+		goto cleanup;
+	}
+
+	/* Extract pointers from the input context */
+
+	gpe_device = gpe_info->gpe_device;
+	gpe_block = gpe_info->gpe_block;
+
+	/*
+	 * The _PRW object must return a package, we are only interested
+	 * in the first element
+	 */
+	obj_desc = pkg_desc->package.elements[0];
+
+	if (ACPI_GET_OBJECT_TYPE (obj_desc) == ACPI_TYPE_INTEGER) {
+		/* Use FADT-defined GPE device (from definition of _PRW) */
+
+		target_gpe_device = acpi_gbl_fadt_gpe_device;
+
+		/* Integer is the GPE number in the FADT described GPE blocks */
+
+		gpe_number = (u32) obj_desc->integer.value;
+	}
+	else if (ACPI_GET_OBJECT_TYPE (obj_desc) == ACPI_TYPE_PACKAGE) {
+		/* Package contains a GPE reference and GPE number within a GPE block */
+
+		if ((obj_desc->package.count < 2) ||
+			(ACPI_GET_OBJECT_TYPE (obj_desc->package.elements[0]) != ACPI_TYPE_LOCAL_REFERENCE) ||
+			(ACPI_GET_OBJECT_TYPE (obj_desc->package.elements[1]) != ACPI_TYPE_INTEGER)) {
+			goto cleanup;
+		}
+
+		/* Get GPE block reference and decode */
+
+		target_gpe_device = obj_desc->package.elements[0]->reference.node;
+		gpe_number = (u32) obj_desc->package.elements[1]->integer.value;
+	}
+	else {
+		/* Unknown type, just ignore it */
+
+		goto cleanup;
+	}
+
+	/*
+	 * Is this GPE within this block?
+	 *
+	 * TRUE iff these conditions are true:
+	 *     1) The GPE devices match.
+	 *     2) The GPE index(number) is within the range of the Gpe Block
+	 *          associated with the GPE device.
+	 */
+	if ((gpe_device == target_gpe_device) &&
+		(gpe_number >= gpe_block->block_base_number) &&
+		(gpe_number < gpe_block->block_base_number + (gpe_block->register_count * 8))) {
+		/* Mark GPE for WAKE but DISABLED (even for wake) */
+
+		gpe_event_info = &gpe_block->event_info[gpe_number - gpe_block->block_base_number];
+		gpe_event_info->flags |= ACPI_GPE_TYPE_WAKE;
+	}
+
+cleanup:
+	acpi_ut_remove_reference (pkg_desc);
+
+	return_ACPI_STATUS (status);
+}
+
+
+/*******************************************************************************
+ *
  * FUNCTION:    acpi_ev_get_gpe_xrupt_block
  *
  * PARAMETERS:  interrupt_level     - Interrupt for a GPE block
@@ -695,8 +809,13 @@ acpi_ev_create_gpe_block (
 	struct acpi_gpe_block_info      **return_gpe_block)
 {
 	struct acpi_gpe_block_info      *gpe_block;
+	struct acpi_gpe_event_info      *gpe_event_info;
+	acpi_native_uint                i;
+	acpi_native_uint                j;
+	u32                             wake_gpe_count;
+	u32                             gpe_enabled_count;
 	acpi_status                     status;
-
+	struct acpi_gpe_walk_info       gpe_info;
 
 	ACPI_FUNCTION_TRACE ("ev_create_gpe_block");
 
@@ -737,7 +856,8 @@ acpi_ev_create_gpe_block (
 
 	/* Dump info about this GPE block */
 
-	ACPI_DEBUG_PRINT ((ACPI_DB_INIT, "GPE %02d to %02d [%4.4s] %d regs at %8.8X%8.8X on int %d\n",
+	ACPI_DEBUG_PRINT ((ACPI_DB_INIT,
+		"GPE %02d to %02d [%4.4s] %d regs at %8.8X%8.8X on int %d\n",
 		gpe_block->block_base_number,
 		(u32) (gpe_block->block_base_number +
 				((gpe_block->register_count * ACPI_GPE_REGISTER_WIDTH) -1)),
@@ -752,6 +872,58 @@ acpi_ev_create_gpe_block (
 			  ACPI_UINT32_MAX, ACPI_NS_WALK_NO_UNLOCK, acpi_ev_save_method_info,
 			  gpe_block, NULL);
 
+	/*
+	 * Runtime option: Should Wake GPEs be enabled at runtime?  The default is
+	 * No,they should only be enabled just as the machine goes to sleep.
+	 */
+	if (acpi_gbl_leave_wake_gpes_disabled) {
+		/*
+		 * Differentiate RUNTIME vs WAKE GPEs, via the _PRW control methods. (Each
+		 * GPE that has one or more _PRWs that reference it is by definition a
+		 * WAKE GPE and will not be enabled while the machine is running.)
+		 */
+		gpe_info.gpe_block = gpe_block;
+		gpe_info.gpe_device = gpe_device;
+
+		status = acpi_ns_walk_namespace (ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,
+				  ACPI_UINT32_MAX, ACPI_NS_WALK_UNLOCK, acpi_ev_get_gpe_type,
+				  &gpe_info, NULL);
+	}
+
+	/*
+	 * Enable all GPEs in this block that are 1) "runtime" GPEs, and 2) have
+	 * a corresponding _Lxx or _Exx method.  All other GPEs must be enabled via
+	 * the acpi_enable_gpe() external interface.
+	 */
+	wake_gpe_count = 0;
+	gpe_enabled_count = 0;
+
+	for (i = 0; i < gpe_block->register_count; i++) {
+		for (j = 0; j < 8; j++) {
+			/* Get the info block for this particular GPE */
+
+			gpe_event_info = &gpe_block->event_info[(i * ACPI_GPE_REGISTER_WIDTH) + j];
+			if ((gpe_event_info->method_node) &&
+			   ((gpe_event_info->flags & ACPI_GPE_TYPE_MASK) == ACPI_GPE_TYPE_RUNTIME)) {
+				/* Enable this GPE, it is 1) RUNTIME and 2) has an _Lxx or _Exx method */
+
+				status = acpi_hw_enable_gpe (gpe_event_info);
+				if (ACPI_FAILURE (status)) {
+					return_ACPI_STATUS (status);
+				}
+				gpe_enabled_count++;
+			}
+
+			if ((gpe_event_info->flags & ACPI_GPE_TYPE_MASK) == ACPI_GPE_TYPE_WAKE) {
+				wake_gpe_count++;
+			}
+		}
+	}
+
+	ACPI_DEBUG_PRINT ((ACPI_DB_INIT,
+			"Found %u Wake, Enabled %u Runtime GPEs in this block\n",
+			wake_gpe_count, gpe_enabled_count));
+
 	/* Return the new block */
 
 	if (return_gpe_block) {
@@ -775,27 +947,25 @@ acpi_ev_create_gpe_block (
  ******************************************************************************/
 
 acpi_status
-acpi_ev_gpe_initialize (void)
+acpi_ev_gpe_initialize (
+	void)
 {
 	u32                             register_count0 = 0;
 	u32                             register_count1 = 0;
 	u32                             gpe_number_max = 0;
-	acpi_handle                     gpe_device;
 	acpi_status                     status;
 
 
 	ACPI_FUNCTION_TRACE ("ev_gpe_initialize");
 
 
-	/* Get a handle to the predefined _GPE object */
-
-	status = acpi_get_handle (NULL, "\\_GPE", &gpe_device);
+	status = acpi_ut_acquire_mutex (ACPI_MTX_NAMESPACE);
 	if (ACPI_FAILURE (status)) {
 		return_ACPI_STATUS (status);
 	}
 
 	/*
-	 * Initialize the GPE Blocks defined in the FADT
+	 * Initialize the GPE Block(s) defined in the FADT
 	 *
 	 * Why the GPE register block lengths are divided by 2:  From the ACPI Spec,
 	 * section "General-Purpose Event Registers", we have:
@@ -829,8 +999,9 @@ acpi_ev_gpe_initialize (void)
 
 		/* Install GPE Block 0 */
 
-		status = acpi_ev_create_gpe_block (gpe_device, &acpi_gbl_FADT->xgpe0_blk,
+		status = acpi_ev_create_gpe_block (acpi_gbl_fadt_gpe_device, &acpi_gbl_FADT->xgpe0_blk,
 				 register_count0, 0, acpi_gbl_FADT->sci_int, &acpi_gbl_gpe_fadt_blocks[0]);
+
 		if (ACPI_FAILURE (status)) {
 			ACPI_REPORT_ERROR ((
 				"Could not create GPE Block 0, %s\n",
@@ -861,9 +1032,10 @@ acpi_ev_gpe_initialize (void)
 		else {
 			/* Install GPE Block 1 */
 
-			status = acpi_ev_create_gpe_block (gpe_device, &acpi_gbl_FADT->xgpe1_blk,
+			status = acpi_ev_create_gpe_block (acpi_gbl_fadt_gpe_device, &acpi_gbl_FADT->xgpe1_blk,
 					 register_count1, acpi_gbl_FADT->gpe1_base,
 					 acpi_gbl_FADT->sci_int, &acpi_gbl_gpe_fadt_blocks[1]);
+
 			if (ACPI_FAILURE (status)) {
 				ACPI_REPORT_ERROR ((
 					"Could not create GPE Block 1, %s\n",
@@ -885,7 +1057,8 @@ acpi_ev_gpe_initialize (void)
 		/* GPEs are not required by ACPI, this is OK */
 
 		ACPI_REPORT_INFO (("There are no GPE blocks defined in the FADT\n"));
-		return_ACPI_STATUS (AE_OK);
+		status = AE_OK;
+		goto cleanup;
 	}
 
 	/* Check for Max GPE number out-of-range */
@@ -893,9 +1066,12 @@ acpi_ev_gpe_initialize (void)
 	if (gpe_number_max > ACPI_GPE_MAX) {
 		ACPI_REPORT_ERROR (("Maximum GPE number from FADT is too large: 0x%X\n",
 			gpe_number_max));
-		return_ACPI_STATUS (AE_BAD_VALUE);
+		status = AE_BAD_VALUE;
+		goto cleanup;
 	}
 
+cleanup:
+	(void) acpi_ut_release_mutex (ACPI_MTX_NAMESPACE);
 	return_ACPI_STATUS (AE_OK);
 }
 
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evmisc.c linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evmisc.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evmisc.c	2004-01-17 23:12:32.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evmisc.c	2004-03-26 18:47:08.000000000 +0000
@@ -97,6 +97,20 @@ acpi_ev_is_notify_object (
  *
  ******************************************************************************/
 
+#ifdef ACPI_DEBUG_OUTPUT
+static const char                *acpi_notify_value_names[] =
+{
+	"Bus Check",
+	"Device Check",
+	"Device Wake",
+	"Eject request",
+	"Device Check Light",
+	"Frequency Mismatch",
+	"Bus Mode Mismatch",
+	"Power Fault"
+};
+#endif
+
 acpi_status
 acpi_ev_queue_notify_request (
 	struct acpi_namespace_node      *node,
@@ -112,7 +126,7 @@ acpi_ev_queue_notify_request (
 
 
 	/*
-	 * For value 1 (Ejection Request), some device method may need to be run.
+	 * For value 3 (Ejection Request), some device method may need to be run.
 	 * For value 2 (Device Wake) if _PRW exists, the _PS0 method may need to be run.
 	 * For value 0x80 (Status Change) on the power button or sleep button,
 	 * initiate soft-off or sleep operation?
@@ -120,26 +134,13 @@ acpi_ev_queue_notify_request (
 	ACPI_DEBUG_PRINT ((ACPI_DB_INFO,
 		"Dispatching Notify(%X) on node %p\n", notify_value, node));
 
-	switch (notify_value) {
-	case 0:
-		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "Notify value: Re-enumerate Devices\n"));
-		break;
-
-	case 1:
-		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "Notify value: Ejection Request\n"));
-		break;
-
-	case 2:
-		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "Notify value: Device Wake\n"));
-		break;
-
-	case 0x80:
-		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "Notify value: Status Change\n"));
-		break;
-
-	default:
-		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "Unknown Notify Value: %X \n", notify_value));
-		break;
+	if (notify_value <= 7) {
+		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "Notify value: %s\n",
+				acpi_notify_value_names[notify_value]));
+	}
+	else {
+		ACPI_DEBUG_PRINT ((ACPI_DB_INFO, "notify value: 0x2.2_x **Device Specific**\n",
+				notify_value));
 	}
 
 	/*
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evxfevnt.c linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evxfevnt.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/events/evxfevnt.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/events/evxfevnt.c	2004-03-26 18:47:07.000000000 +0000
@@ -247,16 +247,29 @@ acpi_enable_gpe (
 		goto unlock_and_exit;
 	}
 
-	/* Enable the requested GPE number */
-
-	status = acpi_hw_enable_gpe (gpe_event_info);
-	if (ACPI_FAILURE (status)) {
-		goto unlock_and_exit;
-	}
+	/* Check for Wake vs Runtime GPE */
 
 	if (flags & ACPI_EVENT_WAKE_ENABLE) {
+		/* Ensure the requested wake GPE is disabled */
+
+		status = acpi_hw_disable_gpe (gpe_event_info);
+		if (ACPI_FAILURE (status)) {
+			goto unlock_and_exit;
+		}
+
+		/* Defer Enable of Wake GPE until sleep time */
+
 		acpi_hw_enable_gpe_for_wakeup (gpe_event_info);
 	}
+	else {
+		/* Enable the requested runtime GPE  */
+
+		status = acpi_hw_enable_gpe (gpe_event_info);
+		if (ACPI_FAILURE (status)) {
+			goto unlock_and_exit;
+		}
+	}
+
 
 unlock_and_exit:
 	if (flags & ACPI_NOT_ISR) {
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/excreate.c linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/excreate.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/excreate.c	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/excreate.c	2004-03-26 18:47:08.000000000 +0000
@@ -84,14 +84,15 @@ acpi_ex_create_alias (
 	alias_node = (struct acpi_namespace_node *) walk_state->operands[0];
 	target_node = (struct acpi_namespace_node *) walk_state->operands[1];
 
-	if (target_node->type == ACPI_TYPE_LOCAL_ALIAS) {
+	if ((target_node->type == ACPI_TYPE_LOCAL_ALIAS) ||
+		(target_node->type == ACPI_TYPE_LOCAL_METHOD_ALIAS)) {
 		/*
 		 * Dereference an existing alias so that we don't create a chain
 		 * of aliases.  With this code, we guarantee that an alias is
 		 * always exactly one level of indirection away from the
 		 * actual aliased name.
 		 */
-		target_node = (struct acpi_namespace_node *) target_node->object;
+		target_node = ACPI_CAST_PTR (struct acpi_namespace_node, target_node->object);
 	}
 
 	/*
@@ -117,6 +118,17 @@ acpi_ex_create_alias (
 		alias_node->object = ACPI_CAST_PTR (union acpi_operand_object, target_node);
 		break;
 
+	case ACPI_TYPE_METHOD:
+
+		/*
+		 * The new alias has the type ALIAS and points to the original
+		 * NS node, not the object itself.  This is because for these
+		 * types, the object can change dynamically via a Store.
+		 */
+		alias_node->type = ACPI_TYPE_LOCAL_METHOD_ALIAS;
+		alias_node->object = ACPI_CAST_PTR (union acpi_operand_object, target_node);
+		break;
+
 	default:
 
 		/* Attach the original source object to the new Alias Node */
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/exdump.c linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/exdump.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/exdump.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/exdump.c	2004-03-26 18:47:07.000000000 +0000
@@ -774,6 +774,7 @@ acpi_ex_dump_object_descriptor (
 
 
 	case ACPI_TYPE_LOCAL_ALIAS:
+	case ACPI_TYPE_LOCAL_METHOD_ALIAS:
 	case ACPI_TYPE_LOCAL_EXTRA:
 	case ACPI_TYPE_LOCAL_DATA:
 	default:
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/exresnte.c linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/exresnte.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/exresnte.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/exresnte.c	2004-03-26 18:47:07.000000000 +0000
@@ -108,10 +108,11 @@ acpi_ex_resolve_node_to_value (
 	ACPI_DEBUG_PRINT ((ACPI_DB_EXEC, "Entry=%p source_desc=%p [%s]\n",
 		 node, source_desc, acpi_ut_get_type_name (entry_type)));
 
-	if (entry_type == ACPI_TYPE_LOCAL_ALIAS) {
+	if ((entry_type == ACPI_TYPE_LOCAL_ALIAS) ||
+		(entry_type == ACPI_TYPE_LOCAL_METHOD_ALIAS)) {
 		/* There is always exactly one level of indirection */
 
-		node       = (struct acpi_namespace_node *) node->object;
+		node       = ACPI_CAST_PTR (struct acpi_namespace_node, node->object);
 		source_desc = acpi_ns_get_attached_object (node);
 		entry_type = acpi_ns_get_type ((acpi_handle) node);
 		*object_ptr = node;
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/exstoren.c linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/exstoren.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/executer/exstoren.c	2004-02-13 23:08:40.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/executer/exstoren.c	2004-03-26 18:47:07.000000000 +0000
@@ -138,6 +138,7 @@ acpi_ex_resolve_object (
 
 
 	case ACPI_TYPE_LOCAL_ALIAS:
+	case ACPI_TYPE_LOCAL_METHOD_ALIAS:
 
 		/*
 		 * Aliases are resolved by acpi_ex_prep_operands
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/hardware/hwgpe.c linux-post-2.6.5-rc2-20040327/drivers/acpi/hardware/hwgpe.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/hardware/hwgpe.c	2004-02-27 01:20:55.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/hardware/hwgpe.c	2004-03-26 18:47:07.000000000 +0000
@@ -53,9 +53,9 @@
  *
  * FUNCTION:    acpi_hw_enable_gpe
  *
- * PARAMETERS:  gpe_number      - The GPE
+ * PARAMETERS:  gpe_event_info      - Info block for the GPE to be enabled
  *
- * RETURN:      None
+ * RETURN:      Status
  *
  * DESCRIPTION: Enable a single GPE.
  *
@@ -95,7 +95,7 @@ acpi_hw_enable_gpe (
  *
  * FUNCTION:    acpi_hw_enable_gpe_for_wakeup
  *
- * PARAMETERS:  gpe_number      - The GPE
+ * PARAMETERS:  gpe_event_info      - Info block for the GPE to be enabled
  *
  * RETURN:      None
  *
@@ -122,9 +122,11 @@ acpi_hw_enable_gpe_for_wakeup (
 	}
 
 	/*
-	 * Set the bit so we will not disable this when sleeping
+	 * Set the bit so we will not enable this GPE when sleeping (and disable
+	 * it upon wake)
 	 */
 	gpe_register_info->wake_enable |= gpe_event_info->bit_mask;
+	gpe_event_info->flags |= (ACPI_GPE_TYPE_WAKE | ACPI_GPE_ENABLED);
 }
 
 
@@ -132,9 +134,9 @@ acpi_hw_enable_gpe_for_wakeup (
  *
  * FUNCTION:    acpi_hw_disable_gpe
  *
- * PARAMETERS:  gpe_number      - The GPE
+ * PARAMETERS:  gpe_event_info      - Info block for the GPE to be disabled
  *
- * RETURN:      None
+ * RETURN:      Status
  *
  * DESCRIPTION: Disable a single GPE.
  *
@@ -177,6 +179,8 @@ acpi_hw_disable_gpe (
 		return (status);
 	}
 
+	/* Make sure this GPE is disabled for wake, also */
+
 	acpi_hw_disable_gpe_for_wakeup (gpe_event_info);
 	return (AE_OK);
 }
@@ -186,7 +190,7 @@ acpi_hw_disable_gpe (
  *
  * FUNCTION:    acpi_hw_disable_gpe_for_wakeup
  *
- * PARAMETERS:  gpe_number      - The GPE
+ * PARAMETERS:  gpe_event_info      - Info block for the GPE to be disabled
  *
  * RETURN:      None
  *
@@ -212,9 +216,8 @@ acpi_hw_disable_gpe_for_wakeup (
 		return;
 	}
 
-	/*
-	 * Clear the bit so we will disable this when sleeping
-	 */
+	/* Clear the bit so we will disable this when sleeping */
+
 	gpe_register_info->wake_enable &= ~(gpe_event_info->bit_mask);
 }
 
@@ -223,11 +226,11 @@ acpi_hw_disable_gpe_for_wakeup (
  *
  * FUNCTION:    acpi_hw_clear_gpe
  *
- * PARAMETERS:  gpe_number      - The GPE
+ * PARAMETERS:  gpe_event_info      - Info block for the GPE to be cleared
  *
- * RETURN:      None
+ * RETURN:      status_status
  *
- * DESCRIPTION: Clear a single GPE.
+ * DESCRIPTION: Clear the status bit for a single GPE.
  *
  ******************************************************************************/
 
@@ -256,9 +259,10 @@ acpi_hw_clear_gpe (
  *
  * FUNCTION:    acpi_hw_get_gpe_status
  *
- * PARAMETERS:  gpe_number      - The GPE
+ * PARAMETERS:  gpe_event_info      - Info block for the GPE to queried
+ *              event_status        - Where the GPE status is returned
  *
- * RETURN:      None
+ * RETURN:      Status
  *
  * DESCRIPTION: Return the status of a single GPE.
  *
@@ -376,7 +380,7 @@ acpi_hw_disable_gpe_block (
  *
  * RETURN:      Status
  *
- * DESCRIPTION: Clear all GPEs within a GPE block
+ * DESCRIPTION: Clear status bits for all GPEs within a GPE block
  *
  ******************************************************************************/
 
@@ -392,7 +396,7 @@ acpi_hw_clear_gpe_block (
 	/* Examine each GPE Register within the block */
 
 	for (i = 0; i < gpe_block->register_count; i++) {
-		/* Clear all GPEs in this register */
+		/* Clear status on all GPEs in this register */
 
 		status = acpi_hw_low_level_write (8, 0xFF,
 				 &gpe_block->register_info[i].status_address);
@@ -407,19 +411,20 @@ acpi_hw_clear_gpe_block (
 
 /******************************************************************************
  *
- * FUNCTION:    acpi_hw_disable_non_wakeup_gpe_block
+ * FUNCTION:    acpi_hw_prepare_gpe_block_for_sleep
  *
  * PARAMETERS:  gpe_xrupt_info      - GPE Interrupt info
  *              gpe_block           - Gpe Block info
  *
  * RETURN:      Status
  *
- * DESCRIPTION: Disable all GPEs except wakeup GPEs in a GPE block
+ * DESCRIPTION: Disable all runtime GPEs and enable all wakeup GPEs -- within
+ *              a single GPE block
  *
  ******************************************************************************/
 
 static acpi_status
-acpi_hw_disable_non_wakeup_gpe_block (
+acpi_hw_prepare_gpe_block_for_sleep (
 	struct acpi_gpe_xrupt_info      *gpe_xrupt_info,
 	struct acpi_gpe_block_info      *gpe_block)
 {
@@ -437,8 +442,11 @@ acpi_hw_disable_non_wakeup_gpe_block (
 
 	for (i = 0; i < gpe_block->register_count; i++) {
 		/*
-		 * Read the enabled status of all GPEs. We
+		 * Read the enabled/disabled status of all GPEs. We
 		 * will be using it to restore all the GPEs later.
+		 *
+		 * NOTE:  Wake GPEs are are ALL disabled at this time, so when we wake
+		 * and restore this register, they will be automatically disabled.
 		 */
 		status = acpi_hw_low_level_read (8, &in_value,
 				 &gpe_register_info->enable_address);
@@ -449,7 +457,8 @@ acpi_hw_disable_non_wakeup_gpe_block (
 		gpe_register_info->enable = (u8) in_value;
 
 		/*
-		 * Disable all GPEs except wakeup GPEs.
+		 * 1) Disable all runtime GPEs
+		 * 2) Enable all wakeup GPEs
 		 */
 		status = acpi_hw_low_level_write (8, gpe_register_info->wake_enable,
 				&gpe_register_info->enable_address);
@@ -457,6 +466,8 @@ acpi_hw_disable_non_wakeup_gpe_block (
 			return (status);
 		}
 
+		/* Point to next GPE register */
+
 		gpe_register_info++;
 	}
 
@@ -466,22 +477,22 @@ acpi_hw_disable_non_wakeup_gpe_block (
 
 /******************************************************************************
  *
- * FUNCTION:    acpi_hw_disable_non_wakeup_gpes
+ * FUNCTION:    acpi_hw_prepare_gpes_for_sleep
  *
  * PARAMETERS:  None
  *
- * RETURN:      None
+ * RETURN:      Status
  *
- * DESCRIPTION: Disable all non-wakeup GPEs
+ * DESCRIPTION: Disable all runtime GPEs, enable all wake GPEs.
  *              Called with interrupts disabled. The interrupt handler also
  *              modifies gpe_register_info->Enable, so it should not be
- *              given the chance to run until after non-wake GPEs are
+ *              given the chance to run until after the runtime GPEs are
  *              re-enabled.
  *
  ******************************************************************************/
 
 acpi_status
-acpi_hw_disable_non_wakeup_gpes (
+acpi_hw_prepare_gpes_for_sleep (
 	void)
 {
 	acpi_status                     status;
@@ -490,27 +501,27 @@ acpi_hw_disable_non_wakeup_gpes (
 	ACPI_FUNCTION_ENTRY ();
 
 
-	status = acpi_ev_walk_gpe_list (acpi_hw_disable_non_wakeup_gpe_block);
-
+	status = acpi_ev_walk_gpe_list (acpi_hw_prepare_gpe_block_for_sleep);
 	return (status);
 }
 
 
 /******************************************************************************
  *
- * FUNCTION:    acpi_hw_enable_non_wakeup_gpe_block
+ * FUNCTION:    acpi_hw_restore_gpe_block_on_wake
  *
  * PARAMETERS:  gpe_xrupt_info      - GPE Interrupt info
  *              gpe_block           - Gpe Block info
  *
  * RETURN:      Status
  *
- * DESCRIPTION: Enable a single GPE.
+ * DESCRIPTION: Enable all runtime GPEs and disable all wake GPEs -- in one
+ *              GPE block
  *
  ******************************************************************************/
 
 static acpi_status
-acpi_hw_enable_non_wakeup_gpe_block (
+acpi_hw_restore_gpe_block_on_wake (
 	struct acpi_gpe_xrupt_info      *gpe_xrupt_info,
 	struct acpi_gpe_block_info      *gpe_block)
 {
@@ -537,8 +548,12 @@ acpi_hw_enable_non_wakeup_gpe_block (
 		}
 
 		/*
-		 * We previously stored the enabled status of all GPEs.
-		 * Blast them back in.
+		 * Restore the GPE Enable register, which will do the following:
+		 *
+		 * 1) Disable all wakeup GPEs
+		 * 2) Enable all runtime GPEs
+		 *
+		 *  (On sleep, we saved the enabled status of all GPEs)
 		 */
 		status = acpi_hw_low_level_write (8, gpe_register_info->enable,
 				 &gpe_register_info->enable_address);
@@ -546,28 +561,30 @@ acpi_hw_enable_non_wakeup_gpe_block (
 			return (status);
 		}
 
+		/* Point to next GPE register */
+
 		gpe_register_info++;
 	}
 
-
 	return (AE_OK);
 }
 
 
 /******************************************************************************
  *
- * FUNCTION:    acpi_hw_enable_non_wakeup_gpes
+ * FUNCTION:    acpi_hw_restore_gpes_on_wake
  *
  * PARAMETERS:  None
  *
- * RETURN:      None
+ * RETURN:      Status
  *
- * DESCRIPTION: Enable all non-wakeup GPEs we previously enabled.
+ * DESCRIPTION: Enable all runtime GPEs and disable all wake GPEs -- in all
+ *              GPE blocks
  *
  ******************************************************************************/
 
 acpi_status
-acpi_hw_enable_non_wakeup_gpes (
+acpi_hw_restore_gpes_on_wake (
 	void)
 {
 	acpi_status                     status;
@@ -576,7 +593,6 @@ acpi_hw_enable_non_wakeup_gpes (
 	ACPI_FUNCTION_ENTRY ();
 
 
-	status = acpi_ev_walk_gpe_list (acpi_hw_enable_non_wakeup_gpe_block);
-
+	status = acpi_ev_walk_gpe_list (acpi_hw_restore_gpe_block_on_wake);
 	return (status);
 }
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/hardware/hwsleep.c linux-post-2.6.5-rc2-20040327/drivers/acpi/hardware/hwsleep.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/hardware/hwsleep.c	2004-03-04 03:30:02.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/hardware/hwsleep.c	2004-03-26 18:47:07.000000000 +0000
@@ -286,7 +286,11 @@ acpi_enter_sleep_state (
 		}
 	}
 
-	status = acpi_hw_disable_non_wakeup_gpes ();
+	/*
+	 * 1) Disable all runtime GPEs
+	 * 2) Enable all wakeup GPEs
+	 */
+	status = acpi_hw_prepare_gpes_for_sleep ();
 	if (ACPI_FAILURE (status)) {
 		return_ACPI_STATUS (status);
 	}
@@ -415,7 +419,11 @@ acpi_enter_sleep_state_s4bios (
 		return_ACPI_STATUS (status);
 	}
 
-	status = acpi_hw_disable_non_wakeup_gpes ();
+	/*
+	 * 1) Disable all runtime GPEs
+	 * 2) Enable all wakeup GPEs
+	 */
+	status = acpi_hw_prepare_gpes_for_sleep ();
 	if (ACPI_FAILURE (status)) {
 		return_ACPI_STATUS (status);
 	}
@@ -528,10 +536,14 @@ acpi_leave_sleep_state (
 	if (ACPI_FAILURE (status) && status != AE_NOT_FOUND) {
 		ACPI_REPORT_ERROR (("Method _WAK failed, %s\n", acpi_format_exception (status)));
 	}
+	/* TBD: _WAK "sometimes" returns stuff - do we want to look at it? */
 
-	/* _WAK returns stuff - do we want to look at it? */
-
-	status = acpi_hw_enable_non_wakeup_gpes ();
+	/*
+	 * Restore the GPEs:
+	 * 1) Disable all wakeup GPEs
+	 * 2) Enable all runtime GPEs
+	 */
+	status = acpi_hw_restore_gpes_on_wake ();
 	if (ACPI_FAILURE (status)) {
 		return_ACPI_STATUS (status);
 	}
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsaccess.c linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsaccess.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsaccess.c	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsaccess.c	2004-03-26 18:47:08.000000000 +0000
@@ -247,6 +247,14 @@ acpi_ns_root_initialize (void)
 
 unlock_and_exit:
 	(void) acpi_ut_release_mutex (ACPI_MTX_NAMESPACE);
+
+	/* Save a handle to "_GPE", it is always present */
+
+	if (ACPI_SUCCESS (status)) {
+		status = acpi_ns_get_node_by_path ("\\_GPE", NULL, ACPI_NS_NO_UPSEARCH,
+				  &acpi_gbl_fadt_gpe_device);
+	}
+
 	return_ACPI_STATUS (status);
 }
 
@@ -577,6 +585,7 @@ acpi_ns_lookup (
 		if ((num_segments       == 0)                               &&
 			(type_to_check_for  != ACPI_TYPE_ANY)                   &&
 			(type_to_check_for  != ACPI_TYPE_LOCAL_ALIAS)           &&
+			(type_to_check_for  != ACPI_TYPE_LOCAL_METHOD_ALIAS)    &&
 			(type_to_check_for  != ACPI_TYPE_LOCAL_SCOPE)           &&
 			(this_node->type    != ACPI_TYPE_ANY)                   &&
 			(this_node->type    != type_to_check_for)) {
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsdump.c linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsdump.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsdump.c	2004-01-17 23:12:32.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsdump.c	2004-03-26 18:47:08.000000000 +0000
@@ -351,6 +351,7 @@ acpi_ns_dump_one_object (
 
 
 		case ACPI_TYPE_LOCAL_ALIAS:
+		case ACPI_TYPE_LOCAL_METHOD_ALIAS:
 
 			acpi_os_printf ("Target %4.4s (%p)\n", acpi_ut_get_node_name (obj_desc), obj_desc);
 			break;
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nseval.c linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nseval.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nseval.c	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nseval.c	2004-03-26 18:47:07.000000000 +0000
@@ -311,6 +311,15 @@ acpi_ns_evaluate_by_handle (
 	}
 
 	/*
+	 * For a method alias, we must grab the actual method node
+	 * so that proper scoping context will be established
+	 * before execution.
+	 */
+	if (acpi_ns_get_type (node) == ACPI_TYPE_LOCAL_METHOD_ALIAS) {
+		node = ACPI_CAST_PTR (struct acpi_namespace_node, node->object);
+	}
+
+	/*
 	 * Two major cases here:
 	 * 1) The object is an actual control method -- execute it.
 	 * 2) The object is not a method -- just return it's current
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nssearch.c linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nssearch.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nssearch.c	2004-01-17 23:12:32.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nssearch.c	2004-03-26 18:47:08.000000000 +0000
@@ -113,6 +113,12 @@ acpi_ns_search_node (
 		/* Check for match against the name */
 
 		if (next_node->name.integer == target_name) {
+			/* Resolve a control method alias if any */
+
+			if (acpi_ns_get_type (next_node) == ACPI_TYPE_LOCAL_METHOD_ALIAS) {
+				next_node = ACPI_CAST_PTR (struct acpi_namespace_node, next_node->object);
+			}
+
 			/*
 			 * Found matching entry.
 			 */
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsutils.c linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsutils.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsutils.c	2004-02-27 01:20:55.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsutils.c	2004-03-26 18:47:08.000000000 +0000
@@ -256,7 +256,7 @@ acpi_ns_get_type (
 
 
 	if (!node) {
-		ACPI_REPORT_WARNING (("ns_get_type: Null Node ptr"));
+		ACPI_REPORT_WARNING (("ns_get_type: Null Node input pointer\n"));
 		return_VALUE (ACPI_TYPE_ANY);
 	}
 
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsxfeval.c linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsxfeval.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/namespace/nsxfeval.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/namespace/nsxfeval.c	2004-03-26 18:47:07.000000000 +0000
@@ -45,6 +45,7 @@
 
 #include <acpi/acpi.h>
 #include <acpi/acnamesp.h>
+#include <acpi/acinterp.h>
 
 
 #define _COMPONENT          ACPI_NAMESPACE
@@ -149,11 +150,11 @@ acpi_evaluate_object_typed (
  * FUNCTION:    acpi_evaluate_object
  *
  * PARAMETERS:  Handle              - Object handle (optional)
- *              *Pathname           - Object pathname (optional)
- *              **external_params   - List of parameters to pass to method,
+ *              Pathname            - Object pathname (optional)
+ *              external_params     - List of parameters to pass to method,
  *                                    terminated by NULL.  May be NULL
  *                                    if no parameters are being passed.
- *              *return_buffer      - Where to put method's return value (if
+ *              return_buffer       - Where to put method's return value (if
  *                                    any).  If NULL, no value is returned.
  *
  * RETURN:      Status
@@ -172,6 +173,7 @@ acpi_evaluate_object (
 	struct acpi_buffer              *return_buffer)
 {
 	acpi_status                     status;
+	acpi_status                     status2;
 	union acpi_operand_object       **internal_params = NULL;
 	union acpi_operand_object       *internal_return_obj = NULL;
 	acpi_size                       buffer_space_needed;
@@ -203,7 +205,7 @@ acpi_evaluate_object (
 		 */
 		for (i = 0; i < external_params->count; i++) {
 			status = acpi_ut_copy_eobject_to_iobject (&external_params->pointer[i],
-					 &internal_params[i]);
+					  &internal_params[i]);
 			if (ACPI_FAILURE (status)) {
 				acpi_ut_delete_internal_object_list (internal_params);
 				return_ACPI_STATUS (status);
@@ -321,14 +323,20 @@ acpi_evaluate_object (
 		}
 	}
 
-	/* Delete the return and parameter objects */
-
 	if (internal_return_obj) {
 		/*
-		 * Delete the internal return object. (Or at least
-		 * decrement the reference count by one)
+		 * Delete the internal return object.  NOTE: Interpreter
+		 * must be locked to avoid race condition.
 		 */
-		acpi_ut_remove_reference (internal_return_obj);
+		status2 = acpi_ex_enter_interpreter ();
+		if (ACPI_SUCCESS (status2)) {
+			/*
+			 * Delete the internal return object. (Or at least
+			 * decrement the reference count by one)
+			 */
+			acpi_ut_remove_reference (internal_return_obj);
+			acpi_ex_exit_interpreter ();
+		}
 	}
 
 	/*
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/osl.c linux-post-2.6.5-rc2-20040327/drivers/acpi/osl.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/osl.c	2004-03-13 09:11:01.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/osl.c	2004-03-26 19:31:03.000000000 +0000
@@ -1048,3 +1048,24 @@ acpi_serialize_setup(char *str)
 
 __setup("acpi_serialize", acpi_serialize_setup);
 
+/*
+ * Wake and Run-Time GPES are expected to be separate.
+ * We disable wake-GPEs at run-time to prevent spurious
+ * interrupts.
+ *
+ * However, if a system exists that shares Wake and
+ * Run-time events on the same GPE this flag is available
+ * to tell Linux to keep the wake-time GPEs enabled at run-time.
+ */
+int __init
+acpi_wake_gpes_always_on_setup(char *str)
+{
+	printk(KERN_INFO PREFIX "wake GPEs not disabled\n");
+
+	acpi_gbl_leave_wake_gpes_disabled = FALSE;
+
+	return 1;
+}
+
+__setup("acpi_wake_gpes_always_on", acpi_wake_gpes_always_on_setup);
+
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/pci_link.c linux-post-2.6.5-rc2-20040327/drivers/acpi/pci_link.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/pci_link.c	2004-02-26 05:11:46.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/pci_link.c	2004-03-25 22:34:37.000000000 +0000
@@ -72,6 +72,7 @@ struct acpi_pci_link_irq {
 	u8			edge_level;		/* All IRQs */
 	u8			active_high_low;	/* All IRQs */
 	u8			setonboot;
+	u8			resource_type;
 	u8			possible_count;
 	u8			possible[ACPI_PCI_LINK_MAX_POSSIBLE];
 };
@@ -123,6 +124,7 @@ acpi_pci_link_check_possible (
 		}
 		link->irq.edge_level = p->edge_level;
 		link->irq.active_high_low = p->active_high_low;
+		link->irq.resource_type = ACPI_RSTYPE_IRQ;
 		break;
 	}
 	case ACPI_RSTYPE_EXT_IRQ:
@@ -143,6 +145,7 @@ acpi_pci_link_check_possible (
 		}
 		link->irq.edge_level = p->edge_level;
 		link->irq.active_high_low = p->active_high_low;
+		link->irq.resource_type = ACPI_RSTYPE_EXT_IRQ;
 		break;
 	}
 	default:
@@ -342,13 +345,18 @@ acpi_pci_link_set (
 		}
 	}
 
+	resource_type = link->irq.resource_type;
+
+	if (resource_type != ACPI_RSTYPE_IRQ &&
+			resource_type != ACPI_RSTYPE_EXT_IRQ){
 	/* If IRQ<=15, first try with a "normal" IRQ descriptor. If that fails, try with
 	 * an extended one */
-	if (irq <= 15) {
-		resource_type = ACPI_RSTYPE_IRQ;
-	} else {
-		resource_type = ACPI_RSTYPE_EXT_IRQ;
-	}
+		if (irq <= 15) {
+			resource_type = ACPI_RSTYPE_IRQ;
+		} else {
+			resource_type = ACPI_RSTYPE_EXT_IRQ;
+		}
+	} 
 
 retry_programming:
    
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/resources/rsaddr.c linux-post-2.6.5-rc2-20040327/drivers/acpi/resources/rsaddr.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/resources/rsaddr.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/resources/rsaddr.c	2004-03-26 18:47:07.000000000 +0000
@@ -88,6 +88,7 @@ acpi_rs_address16_resource (
 
 	ACPI_FUNCTION_TRACE ("rs_address16_resource");
 
+
 	/*
 	 * Point past the Descriptor to get the number of bytes consumed
 	 */
@@ -149,7 +150,7 @@ acpi_rs_address16_resource (
 		output_struct->data.address16.attribute.memory.read_write_attribute =
 				(u16) (temp8 & 0x01);
 		output_struct->data.address16.attribute.memory.cache_attribute =
-				(u16) ((temp8 >> 1) & 0x0F);
+				(u16) ((temp8 >> 1) & 0x03);
 	}
 	else {
 		if (ACPI_IO_RANGE == output_struct->data.address16.resource_type) {
@@ -347,7 +348,7 @@ acpi_rs_address16_stream (
 
 		temp8 |=
 			(linked_list->data.address16.attribute.memory.cache_attribute &
-			 0x0F) << 1;
+			 0x03) << 1;
 	}
 	else if (ACPI_IO_RANGE == linked_list->data.address16.resource_type) {
 		temp8 = (u8)
@@ -539,7 +540,7 @@ acpi_rs_address32_resource (
 				(u16) (temp8 & 0x01);
 
 		output_struct->data.address32.attribute.memory.cache_attribute =
-				(u16) ((temp8 >> 1) & 0x0F);
+				(u16) ((temp8 >> 1) & 0x03);
 	}
 	else {
 		if (ACPI_IO_RANGE == output_struct->data.address32.resource_type) {
@@ -735,7 +736,7 @@ acpi_rs_address32_stream (
 
 		temp8 |=
 			(linked_list->data.address32.attribute.memory.cache_attribute &
-			 0x0F) << 1;
+			 0x03) << 1;
 	}
 	else if (ACPI_IO_RANGE == linked_list->data.address32.resource_type) {
 		temp8 = (u8)
@@ -926,7 +927,7 @@ acpi_rs_address64_resource (
 				(u16) (temp8 & 0x01);
 
 		output_struct->data.address64.attribute.memory.cache_attribute =
-				(u16) ((temp8 >> 1) & 0x0F);
+				(u16) ((temp8 >> 1) & 0x03);
 	}
 	else {
 		if (ACPI_IO_RANGE == output_struct->data.address64.resource_type) {
@@ -1124,7 +1125,7 @@ acpi_rs_address64_stream (
 
 		temp8 |=
 			(linked_list->data.address64.attribute.memory.cache_attribute &
-			 0x0F) << 1;
+			 0x03) << 1;
 	}
 	else if (ACPI_IO_RANGE == linked_list->data.address64.resource_type) {
 		temp8 = (u8)
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/utilities/utglobal.c linux-post-2.6.5-rc2-20040327/drivers/acpi/utilities/utglobal.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/utilities/utglobal.c	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/utilities/utglobal.c	2004-03-26 18:47:07.000000000 +0000
@@ -253,14 +253,15 @@ const u8                                
 	ACPI_NS_NORMAL,                     /* 19 index_field      */
 	ACPI_NS_NORMAL,                     /* 20 Reference        */
 	ACPI_NS_NORMAL,                     /* 21 Alias            */
-	ACPI_NS_NORMAL,                     /* 22 Notify           */
-	ACPI_NS_NORMAL,                     /* 23 Address Handler  */
-	ACPI_NS_NEWSCOPE | ACPI_NS_LOCAL,   /* 24 Resource Desc    */
-	ACPI_NS_NEWSCOPE | ACPI_NS_LOCAL,   /* 25 Resource Field   */
-	ACPI_NS_NEWSCOPE,                   /* 26 Scope            */
-	ACPI_NS_NORMAL,                     /* 27 Extra            */
-	ACPI_NS_NORMAL,                     /* 28 Data             */
-	ACPI_NS_NORMAL                      /* 29 Invalid          */
+	ACPI_NS_NORMAL,                     /* 22 method_alias     */
+	ACPI_NS_NORMAL,                     /* 23 Notify           */
+	ACPI_NS_NORMAL,                     /* 24 Address Handler  */
+	ACPI_NS_NEWSCOPE | ACPI_NS_LOCAL,   /* 25 Resource Desc    */
+	ACPI_NS_NEWSCOPE | ACPI_NS_LOCAL,   /* 26 Resource Field   */
+	ACPI_NS_NEWSCOPE,                   /* 27 Scope            */
+	ACPI_NS_NORMAL,                     /* 28 Extra            */
+	ACPI_NS_NORMAL,                     /* 29 Data             */
+	ACPI_NS_NORMAL                      /* 30 Invalid          */
 };
 
 
@@ -501,14 +502,15 @@ static const char                   *acp
 	/* 19 */ "index_field",
 	/* 20 */ "Reference",
 	/* 21 */ "Alias",
-	/* 22 */ "Notify",
-	/* 23 */ "addr_handler",
-	/* 24 */ "resource_desc",
-	/* 25 */ "resource_fld",
-	/* 26 */ "Scope",
-	/* 27 */ "Extra",
-	/* 28 */ "Data",
-	/* 39 */ "Invalid"
+	/* 22 */ "method_alias",
+	/* 23 */ "Notify",
+	/* 24 */ "addr_handler",
+	/* 25 */ "resource_desc",
+	/* 26 */ "resource_fld",
+	/* 27 */ "Scope",
+	/* 28 */ "Extra",
+	/* 29 */ "Data",
+	/* 30 */ "Invalid"
 };
 
 
@@ -556,7 +558,7 @@ char *
 acpi_ut_get_node_name (
 	void                            *object)
 {
-	struct acpi_namespace_node      *node;
+	struct acpi_namespace_node      *node = (struct acpi_namespace_node *) object;
 
 
 	if (!object)
@@ -564,7 +566,10 @@ acpi_ut_get_node_name (
 		return ("NULL NODE");
 	}
 
-	node = (struct acpi_namespace_node *) object;
+	if (object == ACPI_ROOT_OBJECT)
+	{
+		node = acpi_gbl_root_node;
+	}
 
 	if (node->descriptor != ACPI_DESC_TYPE_NAMED)
 	{
@@ -782,6 +787,7 @@ acpi_ut_init_globals (
 
 	acpi_gbl_create_osi_method = TRUE;
 	acpi_gbl_all_methods_serialized = FALSE;
+	acpi_gbl_leave_wake_gpes_disabled = TRUE;
 
 	/* Memory allocation and cache lists */
 
diff -purN linux-post-2.6.5-rc2-20040326/drivers/acpi/utilities/utmisc.c linux-post-2.6.5-rc2-20040327/drivers/acpi/utilities/utmisc.c
--- linux-post-2.6.5-rc2-20040326/drivers/acpi/utilities/utmisc.c	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/acpi/utilities/utmisc.c	2004-03-26 18:47:07.000000000 +0000
@@ -529,6 +529,7 @@ acpi_ut_strupr (
 	return (src_string);
 }
 
+
 /*******************************************************************************
  *
  * FUNCTION:    acpi_ut_mutex_initialize
@@ -562,10 +563,8 @@ acpi_ut_mutex_initialize (
 		}
 	}
 
-
 	status = acpi_os_create_lock (&acpi_gbl_gpe_lock);
-
-	return_ACPI_STATUS (AE_OK);
+	return_ACPI_STATUS (status);
 }
 
 
diff -purN linux-post-2.6.5-rc2-20040326/drivers/atm/nicstar.c linux-post-2.6.5-rc2-20040327/drivers/atm/nicstar.c
--- linux-post-2.6.5-rc2-20040326/drivers/atm/nicstar.c	2004-01-14 00:28:09.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/atm/nicstar.c	2004-03-25 23:05:52.000000000 +0000
@@ -112,9 +112,6 @@
 
 /* Macros *********************************************************************/
 
-#define MAX(a,b) ((a) > (b) ? (a) : (b))
-#define MIN(a,b) ((a) < (b) ? (a) : (b))
-
 #define CMD_BUSY(card) (readl((card)->membase + STAT) & NS_STAT_CMDBZ)
 
 #define NS_DELAY mdelay(1)
@@ -2483,7 +2480,7 @@ static void dequeue_rx(ns_dev *card, ns_
             for (j = 1; j < NS_SKB(iovb)->iovcnt; j++)
             {
                lb = (struct sk_buff *) iov->iov_base;
-               tocopy = MIN(remaining, iov->iov_len);
+               tocopy = min_t(int, remaining, iov->iov_len);
                memcpy(hb->tail, lb->data, tocopy);
                skb_put(hb, tocopy);
                iov++;
diff -purN linux-post-2.6.5-rc2-20040326/drivers/ide/ide-cd.c linux-post-2.6.5-rc2-20040327/drivers/ide/ide-cd.c
--- linux-post-2.6.5-rc2-20040326/drivers/ide/ide-cd.c	2004-03-25 08:39:55.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/ide/ide-cd.c	2004-03-26 09:19:33.000000000 +0000
@@ -2372,7 +2372,7 @@ static int cdrom_read_toc(ide_drive_t *d
 
 	/* Now try to get the total cdrom capacity. */
 	stat = cdrom_get_last_written(cdi, &last_written);
-	if (!stat && last_written) {
+	if (!stat && (last_written > toc->capacity)) {
 		toc->capacity = last_written;
 		set_capacity(drive->disk, toc->capacity * sectors_per_frame);
 	}
diff -purN linux-post-2.6.5-rc2-20040326/drivers/macintosh/adbhid.c linux-post-2.6.5-rc2-20040327/drivers/macintosh/adbhid.c
--- linux-post-2.6.5-rc2-20040326/drivers/macintosh/adbhid.c	2004-02-05 05:54:07.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/macintosh/adbhid.c	2004-03-25 05:16:56.000000000 +0000
@@ -107,7 +107,6 @@ static struct adbhid *adbhid[16] = { 0 }
 static void adbhid_probe(void);
 
 static void adbhid_input_keycode(int, int, int, struct pt_regs *);
-static void leds_done(struct adb_request *);
 
 static void init_trackpad(int id);
 static void init_trackball(int id);
@@ -446,24 +445,54 @@ adbhid_buttons_input(unsigned char *data
 
 static struct adb_request led_request;
 static int leds_pending[16];
+static int leds_req_pending;
 static int pending_devs[16];
 static int pending_led_start=0;
 static int pending_led_end=0;
+static spinlock_t leds_lock  = SPIN_LOCK_UNLOCKED;
+
+static void leds_done(struct adb_request *req)
+{
+	int leds, device;
+	unsigned long flags;
+
+	spin_lock_irqsave(&leds_lock, flags);
+
+	if (pending_led_start != pending_led_end) {
+		device = pending_devs[pending_led_start];
+		leds = leds_pending[device] & 0xff;
+		leds_pending[device] = 0;
+		pending_led_start++;
+		pending_led_start = (pending_led_start < 16) ? pending_led_start : 0;
+	} else
+		leds_req_pending = 0;
+
+	spin_unlock_irqrestore(&leds_lock, flags);
+	if (leds_req_pending)
+		adb_request(&led_request, leds_done, 0, 3,
+			    ADB_WRITEREG(device, KEYB_LEDREG), 0xff, ~leds);
+}
 
 static void real_leds(unsigned char leds, int device)
 {
-    if (led_request.complete) {
-	adb_request(&led_request, leds_done, 0, 3,
-		    ADB_WRITEREG(device, KEYB_LEDREG), 0xff,
-		    ~leds);
-    } else {
-	if (!(leds_pending[device] & 0x100)) {
-	    pending_devs[pending_led_end] = device;
-	    pending_led_end++;
-	    pending_led_end = (pending_led_end < 16) ? pending_led_end : 0;
+	unsigned long flags;
+
+	spin_lock_irqsave(&leds_lock, flags);
+	if (!leds_req_pending) {
+		leds_req_pending = 1;
+		spin_unlock_irqrestore(&leds_lock, flags);	       
+		adb_request(&led_request, leds_done, 0, 3,
+			    ADB_WRITEREG(device, KEYB_LEDREG), 0xff, ~leds);
+		return;
+	} else {
+		if (!(leds_pending[device] & 0x100)) {
+			pending_devs[pending_led_end] = device;
+			pending_led_end++;
+			pending_led_end = (pending_led_end < 16) ? pending_led_end : 0;
+		}
+		leds_pending[device] = leds | 0x100;
 	}
-	leds_pending[device] = leds | 0x100;
-    }
+	spin_unlock_irqrestore(&leds_lock, flags);	       
 }
 
 /*
@@ -487,21 +516,6 @@ static int adbhid_kbd_event(struct input
 	return -1;
 }
 
-static void leds_done(struct adb_request *req)
-{
-    int leds,device;
-
-    if (pending_led_start != pending_led_end) {
-	device = pending_devs[pending_led_start];
-	leds = leds_pending[device] & 0xff;
-	leds_pending[device] = 0;
-	pending_led_start++;
-	pending_led_start = (pending_led_start < 16) ? pending_led_start : 0;
-	real_leds(leds,device);
-    }
-
-}
-
 static int
 adb_message_handler(struct notifier_block *this, unsigned long code, void *x)
 {
@@ -518,7 +532,7 @@ adb_message_handler(struct notifier_bloc
 		}
 
 		/* Stop pending led requests */
-		while(!led_request.complete)
+		while(leds_req_pending)
 			adb_poll();
 		break;
 
diff -purN linux-post-2.6.5-rc2-20040326/drivers/macintosh/via-pmu.c linux-post-2.6.5-rc2-20040327/drivers/macintosh/via-pmu.c
--- linux-post-2.6.5-rc2-20040326/drivers/macintosh/via-pmu.c	2004-02-25 10:31:13.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/macintosh/via-pmu.c	2004-03-25 07:52:00.000000000 +0000
@@ -137,7 +137,8 @@ static int data_index;
 static int data_len;
 static volatile int adb_int_pending;
 static volatile int disable_poll;
-static struct adb_request bright_req_1, bright_req_2, bright_req_3;
+static struct adb_request bright_req_1, bright_req_2;
+static unsigned long async_req_locks;
 static struct device_node *vias;
 static int pmu_kind = PMU_UNKNOWN;
 static int pmu_fully_inited = 0;
@@ -404,7 +405,6 @@ static int __init via_pmu_start(void)
 
 	bright_req_1.complete = 1;
 	bright_req_2.complete = 1;
-	bright_req_3.complete = 1;
 #ifdef CONFIG_PMAC_PBOOK
 	batt_req.complete = 1;
 	if (pmac_call_feature(PMAC_FTR_SLEEP_STATE,NULL,0,-1) >= 0)
@@ -710,6 +710,8 @@ done_battery_state_ohare(struct adb_requ
 	pmu_batteries[pmu_cur_battery].amperage = amperage;
 	pmu_batteries[pmu_cur_battery].voltage = voltage;
 	pmu_batteries[pmu_cur_battery].time_remaining = time;
+
+	clear_bit(0, &async_req_locks);
 }
 
 static void __pmac
@@ -785,12 +787,14 @@ done_battery_state_smart(struct adb_requ
 		pmu_batteries[pmu_cur_battery].time_remaining = 0;
 
 	pmu_cur_battery = (pmu_cur_battery + 1) % pmu_battery_count;
+
+	clear_bit(0, &async_req_locks);
 }
 
 static void __pmac
 query_battery_state(void)
 {
-	if (!batt_req.complete)
+	if (test_and_set_bit(0, &async_req_locks))
 		return;
 	if (pmu_kind == PMU_OHARE_BASED)
 		pmu_request(&batt_req, done_battery_state_ohare,
@@ -1690,20 +1694,30 @@ pmu_set_backlight_enable(int on, int lev
 	return 0;
 }
 
+static void __openfirmware
+pmu_bright_complete(struct adb_request *req)
+{
+	if (req == &bright_req_1)
+		clear_bit(1, &async_req_locks);
+	if (req == &bright_req_2)
+		clear_bit(2, &async_req_locks);
+}
+
 static int __openfirmware
 pmu_set_backlight_level(int level, void* data)
 {
 	if (vias == NULL)
 		return -ENODEV;
 
-	if (!bright_req_1.complete)
+	if (test_and_set_bit(1, &async_req_locks))
 		return -EAGAIN;
-	pmu_request(&bright_req_1, NULL, 2, PMU_BACKLIGHT_BRIGHT,
+	pmu_request(&bright_req_1, pmu_bright_complete, 2, PMU_BACKLIGHT_BRIGHT,
 		backlight_to_bright[level]);
-	if (!bright_req_2.complete)
+	if (test_and_set_bit(2, &async_req_locks))
 		return -EAGAIN;
-	pmu_request(&bright_req_2, NULL, 2, PMU_POWER_CTRL, PMU_POW_BACKLIGHT
-		| (level > BACKLIGHT_OFF ? PMU_POW_ON : PMU_POW_OFF));
+	pmu_request(&bright_req_2, pmu_bright_complete, 2, PMU_POWER_CTRL,
+		    PMU_POW_BACKLIGHT | (level > BACKLIGHT_OFF ?
+					 PMU_POW_ON : PMU_POW_OFF));
 
 	return 0;
 }
@@ -2330,6 +2344,8 @@ pmac_suspend_devices(void)
 		return -EBUSY;
 	}
 	
+	preempt_disable();
+	
 	/* Make sure the decrementer won't interrupt us */
 	asm volatile("mtdec %0" : : "r" (0x7fffffff));
 	/* Make sure any pending DEC interrupt occurring while we did
@@ -2352,6 +2368,7 @@ pmac_suspend_devices(void)
 	if (ret) {
 		wakeup_decrementer();
 		local_irq_enable();
+		preempt_enable();
 		device_resume();
 		broadcast_wake();
 		printk(KERN_ERR "Driver powerdown failed\n");
@@ -2360,7 +2377,8 @@ pmac_suspend_devices(void)
 
 	/* Wait for completion of async backlight requests */
 	while (!bright_req_1.complete || !bright_req_2.complete ||
-		!bright_req_3.complete || !batt_req.complete)
+
+			!batt_req.complete)
 		pmu_poll();
 
 	/* Giveup the lazy FPU & vec so we don't have to back them
@@ -2398,6 +2416,8 @@ pmac_wakeup_devices(void)
 
 	pmu_blink(1);
 
+	preempt_enable();
+
 	/* Resume devices */
 	device_resume();
 
@@ -2673,9 +2693,9 @@ powerbook_sleep_3400(void)
 		mb();
 
 	pmac_wakeup_devices();
-
 	pbook_free_pci_save();
 	iounmap(mem_ctrl);
+
 	return 0;
 }
 
diff -purN linux-post-2.6.5-rc2-20040326/drivers/pcmcia/yenta_socket.c linux-post-2.6.5-rc2-20040327/drivers/pcmcia/yenta_socket.c
--- linux-post-2.6.5-rc2-20040326/drivers/pcmcia/yenta_socket.c	2004-03-14 20:10:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/pcmcia/yenta_socket.c	2004-03-25 10:20:36.000000000 +0000
@@ -1017,6 +1017,11 @@ static struct pci_device_id yenta_table 
 	CB_ID(PCI_VENDOR_ID_TI, PCI_DEVICE_ID_TI_1250, TI1250),
 	CB_ID(PCI_VENDOR_ID_TI, PCI_DEVICE_ID_TI_1410, TI1250),
 
+	CB_ID(PCI_VENDOR_ID_ENE, PCI_DEVICE_ID_ENE_1211, TI12XX),
+	CB_ID(PCI_VENDOR_ID_ENE, PCI_DEVICE_ID_ENE_1225, TI12XX),
+	CB_ID(PCI_VENDOR_ID_ENE, PCI_DEVICE_ID_ENE_1410, TI1250),
+	CB_ID(PCI_VENDOR_ID_ENE, PCI_DEVICE_ID_ENE_1420, TI12XX),
+
 	CB_ID(PCI_VENDOR_ID_RICOH, PCI_DEVICE_ID_RICOH_RL5C465, RICOH),
 	CB_ID(PCI_VENDOR_ID_RICOH, PCI_DEVICE_ID_RICOH_RL5C466, RICOH),
 	CB_ID(PCI_VENDOR_ID_RICOH, PCI_DEVICE_ID_RICOH_RL5C475, RICOH),
diff -purN linux-post-2.6.5-rc2-20040326/drivers/serial/Kconfig linux-post-2.6.5-rc2-20040327/drivers/serial/Kconfig
--- linux-post-2.6.5-rc2-20040326/drivers/serial/Kconfig	2004-03-23 10:05:26.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/serial/Kconfig	2004-03-25 17:57:00.000000000 +0000
@@ -174,32 +174,6 @@ config SERIAL_8250_ACORN
 	  system, say Y to this option.  The driver can handle 1, 2, or 3 port
 	  cards.  If unsure, say N.
 
-config SERIAL_ANAKIN
-	bool "Anakin serial port support"
-	depends on ARM && ARCH_ANAKIN
-	select SERIAL_CORE
-	help
-	  ::: To be written :::
-
-config SERIAL_ANAKIN_CONSOLE
-	bool "Console on Anakin serial port"
-	depends on SERIAL_ANAKIN
-	select SERIAL_CORE_CONSOLE
-	help
-	  Even if you say Y here, the currently visible virtual console
-	  (/dev/tty0) will still be used as the system console by default, but
-	  you can alter that using a kernel command line option such as
-	  "console=ttyAN0". (Try "man bootparam" or see the documentation of
-	  your boot loader (lilo or loadlin) about how to pass options to the
-	  kernel at boot time.)
-
-config ANAKIN_DEFAULT_BAUDRATE
-	int "Default Anakin serial baudrate"
-	depends on SERIAL_ANAKIN
-	default "9600"
-	help
-	  ::: To be written :::
-
 config SERIAL_AMBA
 	tristate "ARM AMBA serial port support"
 	depends on ARM_AMBA
diff -purN linux-post-2.6.5-rc2-20040326/drivers/serial/Makefile linux-post-2.6.5-rc2-20040327/drivers/serial/Makefile
--- linux-post-2.6.5-rc2-20040326/drivers/serial/Makefile	2004-03-23 10:05:26.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/serial/Makefile	2004-03-25 17:57:00.000000000 +0000
@@ -16,7 +16,6 @@ obj-$(CONFIG_SERIAL_21285) += 21285.o
 obj-$(CONFIG_SERIAL_8250) += 8250.o $(serial-8250-y)
 obj-$(CONFIG_SERIAL_8250_CS) += serial_cs.o
 obj-$(CONFIG_SERIAL_8250_ACORN) += 8250_acorn.o
-obj-$(CONFIG_SERIAL_ANAKIN) += anakin.o
 obj-$(CONFIG_SERIAL_AMBA) += amba.o
 obj-$(CONFIG_SERIAL_CLPS711X) += clps711x.o
 obj-$(CONFIG_SERIAL_PXA) += pxa.o
diff -purN linux-post-2.6.5-rc2-20040326/drivers/serial/anakin.c linux-post-2.6.5-rc2-20040327/drivers/serial/anakin.c
--- linux-post-2.6.5-rc2-20040326/drivers/serial/anakin.c	2004-03-16 10:29:44.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/serial/anakin.c	1970-01-01 00:00:00.000000000 +0000
@@ -1,545 +0,0 @@
-/*
- *  linux/drivers/char/anakin.c
- *
- *  Based on driver for AMBA serial ports, by ARM Limited,
- *  Deep Blue Solutions Ltd., Linus Torvalds and Theodore Ts'o.
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- *  Copyright (C) 2001 Blue Mug, Inc. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   20-Apr-2001 TTC	Created
- *   05-May-2001 W/TTC	Updated for serial_core.c
- *   27-Jun-2001 jonm	Minor changes; add mctrl support, switch to 
- *   			SA_INTERRUPT. Works reliably now. No longer requires
- *   			changes to the serial_core API.
- *
- *  $Id: anakin.c,v 1.32 2002/07/28 10:03:27 rmk Exp $
- */
-
-#include <linux/config.h>
-#include <linux/module.h>
-#include <linux/tty.h>
-#include <linux/ioport.h>
-#include <linux/init.h>
-#include <linux/serial.h>
-#include <linux/console.h>
-#include <linux/sysrq.h>
-#include <linux/device.h>
-
-#include <asm/io.h>
-#include <asm/irq.h>
-
-#include <linux/serial_core.h>
-
-#include <asm/arch/serial_reg.h>
-
-#define UART_NR			5
-
-#define SERIAL_ANAKIN_NAME	"ttyAN"
-#define SERIAL_ANAKIN_MAJOR	204
-#define SERIAL_ANAKIN_MINOR	32
-
-static unsigned int txenable[NR_IRQS];		/* Software interrupt register */
-
-static inline unsigned int
-anakin_in(struct uart_port *port, unsigned int offset)
-{
-	return __raw_readl(port->base + offset);
-}
-
-static inline void
-anakin_out(struct uart_port *port, unsigned int offset, unsigned int value)
-{
-	__raw_writel(value, port->base + offset);
-}
-
-static void
-anakin_stop_tx(struct uart_port *port, unsigned int tty_stop)
-{
-	txenable[port->irq] = 0;
-}
-
-static inline void
-anakin_transmit_buffer(struct uart_port *port)
-{
-	struct circ_buf *xmit = &port->info->xmit;
-
-	while (!(anakin_in(port, 0x10) & TXEMPTY))
-		barrier();
-	anakin_out(port, 0x14, xmit->buf[xmit->tail]);
-	anakin_out(port, 0x18, anakin_in(port, 0x18) | SENDREQUEST);
-	xmit->tail = (xmit->tail + 1) & (UART_XMIT_SIZE-1);
-        port->icount.tx++;
-
-	if (uart_circ_empty(xmit))
-		anakin_stop_tx(port, 0); 
-}
-
-static inline void
-anakin_transmit_x_char(struct uart_port *port)
-{
-	anakin_out(port, 0x14, port->x_char);
-	anakin_out(port, 0x18, anakin_in(port, 0x18) | SENDREQUEST);
-	port->icount.tx++;
-	port->x_char = 0;
-}
-
-static void
-anakin_start_tx(struct uart_port *port, unsigned int tty_start)
-{
-	// is it this... or below
-	if (!txenable[port->irq]) {
-		txenable[port->irq] = TXENABLE;
-
-		if ((anakin_in(port, 0x10) & TXEMPTY)) {
-		    anakin_transmit_buffer(port);
-		}
-	}
-}
-
-static void
-anakin_stop_rx(struct uart_port *port)
-{
-	while (anakin_in(port, 0x10) & RXRELEASE) 
-	    anakin_in(port, 0x14);
-	anakin_out(port, 0x18, anakin_in(port, 0x18) | BLOCKRX);
-}
-
-static void
-anakin_enable_ms(struct uart_port *port)
-{
-}
-
-static inline void
-anakin_rx_chars(struct uart_port *port)
-{
-	unsigned int ch;
-	struct tty_struct *tty = port->info->tty;
-
-	if (!(anakin_in(port, 0x10) & RXRELEASE))
-		return;
-
-	ch = anakin_in(port, 0x14) & 0xff;
-
-	if (tty->flip.count < TTY_FLIPBUF_SIZE) {
-		*tty->flip.char_buf_ptr++ = ch;
-		*tty->flip.flag_buf_ptr++ = TTY_NORMAL;
-		port->icount.rx++;
-		tty->flip.count++;
-	} 
-	tty_flip_buffer_push(tty);
-}
-
-static inline void
-anakin_overrun_chars(struct uart_port *port)
-{
-	unsigned int ch;
-
-	ch = anakin_in(port, 0x14);
-	port->icount.overrun++;
-}
-
-static inline void
-anakin_tx_chars(struct uart_port *port)
-{
-	struct circ_buf *xmit = &port->info->xmit;
-
-	if (port->x_char) {
-		anakin_transmit_x_char(port);
-		return; 
-	}
-
-	if (uart_circ_empty(xmit) || uart_tx_stopped(port)) {
-		anakin_stop_tx(port, 0);
-		return;
-	}
-
-	anakin_transmit_buffer(port);
-
-	if (uart_circ_chars_pending(xmit) < WAKEUP_CHARS)
-		uart_write_wakeup(port);
-}
-
-static void
-anakin_int(int irq, void *dev_id, struct pt_regs *regs)
-{
-	unsigned int status;
-	struct uart_port *port = dev_id;
-
-	status = anakin_in(port, 0x1c);
-
-	if (status & RX) 
-		anakin_rx_chars(port);
-
-	if (status & OVERRUN) 
-		anakin_overrun_chars(port);
-
-	if (txenable[port->irq] && (status & TX)) 
-		anakin_tx_chars(port);
-}
-
-static unsigned int
-anakin_tx_empty(struct uart_port *port)
-{
-	return anakin_in(port, 0x10) & TXEMPTY ? TIOCSER_TEMT : 0;
-}
-
-static unsigned int
-anakin_get_mctrl(struct uart_port *port)
-{
-	unsigned int status = 0;
-
-	status |= (anakin_in(port, 0x10) & CTS ? TIOCM_CTS : 0);
-	status |= (anakin_in(port, 0x18) & DCD ? TIOCM_CAR : 0);
-	status |= (anakin_in(port, 0x18) & DTR ? TIOCM_DTR : 0);
-	status |= (anakin_in(port, 0x18) & RTS ? TIOCM_RTS : 0);
-	
-	return status;
-}
-
-static void
-anakin_set_mctrl(struct uart_port *port, unsigned int mctrl)
-{
-	unsigned int status;
-
-	status = anakin_in(port, 0x18);
-
-	if (mctrl & TIOCM_RTS) 
-		status |= RTS;
-	else 
-		status &= ~RTS;
-
-	if (mctrl & TIOCM_CAR)
-		status |= DCD;
-	else 
-		status &= ~DCD;
-
-	anakin_out(port, 0x18, status);
-}
-
-static void
-anakin_break_ctl(struct uart_port *port, int break_state)
-{
-	unsigned long flags;
-	unsigned int status;
-
-	spin_lock_irqsave(&port->lock, flags);
-	status = anakin_in(port, 0x20);
-
-	if (break_state == -1)
-		status |= SETBREAK;
-	else
-		status &= ~SETBREAK;
-
-	anakin_out(port, 0x20, status);
-	spin_unlock_irqrestore(&port->lock, flags);
-}
-
-static int anakin_startup(struct uart_port *port)
-{
-	int retval;
-	unsigned int read,write;
-
-	/*
-	 * Allocate the IRQ
-	 */
-	retval = request_irq(port->irq, anakin_int, SA_INTERRUPT,
-			     "serial_anakin", port);
-	if (retval)
-		return retval;
-
-	/*
-	 * initialise the old status of the modem signals
-	 */
-	port->old_status = 0;
-
-	/*
-	 * Finally, disable IRQ and softIRQs for first byte)
-	 */
-	txenable[port->irq] = 0;
-	read = anakin_in(port, 0x18);
-	write = (read & ~(RTS | DTR | BLOCKRX)) | IRQENABLE;
-	anakin_out(port, 0x18, write);
-
-	return 0;
-}
-
-static void anakin_shutdown(struct uart_port *port)
-{
-	/*
-	 * Free the interrupt
-	 */
-	free_irq(port->irq, port);
-
-	/*
-	 * disable all interrupts, disable the port
-	 */
-	anakin_out(port, 0x18, anakin_in(port, 0x18) & ~IRQENABLE);
-}
-
-static void
-anakin_set_termios(struct uart_port *port, struct termios *termios,
-		   struct termios *old)
-{
-	unsigned long flags;
-	unsigned int baud, quot;
-
-	/*
-	 * We don't support parity, stop bits, or anything other
-	 * than 8 bits, so clear these termios flags.
-	 */
-	termios->c_cflag &= ~(CSIZE | CSTOPB | PARENB | PARODD | CREAD);
-	termios->c_cflag |= CS8;
-
-	/*
-	 * We don't appear to support any error conditions either.
-	 */
-	termios->c_iflag &= ~(INPCK | IGNPAR | IGNBRK | BRKINT);
-
-	/*
-	 * Ask the core to calculate the divisor for us.
-	 */
-	baud = uart_get_baud_rate(port, termios, old, 0, port->uartclk/16); 
-	quot = uart_get_divisor(port, baud);
-
-	spin_lock_irqsave(&port->lock, flags);
-
-	uart_update_timeout(port, termios->c_cflag, baud);
-
-	while (!(anakin_in(port, 0x10) & TXEMPTY))
-		barrier();
-
-	anakin_out(port, 0x10, (anakin_in(port, 0x10) & ~PRESCALER)
-			| (quot << 3));
-
-	//parity always set to none
-	anakin_out(port, 0x18, anakin_in(port, 0x18) & ~PARITY);
-	spin_unlock_irqrestore(&port->lock, flags);
-}
-
-static const char *anakin_type(struct port *port)
-{
-	return port->type == PORT_ANAKIN ? "ANAKIN" : NULL;
-}
-
-static struct uart_ops anakin_pops = {
-	.tx_empty	= anakin_tx_empty,
-	.set_mctrl	= anakin_set_mctrl,
-	.get_mctrl	= anakin_get_mctrl,
-	.stop_tx	= anakin_stop_tx,
-	.start_tx	= anakin_start_tx,
-	.stop_rx	= anakin_stop_rx,
-	.enable_ms	= anakin_enable_ms,
-	.break_ctl	= anakin_break_ctl,
-	.startup	= anakin_startup,
-	.shutdown	= anakin_shutdown,
-	.set_termios	= anakin_set_termios,
-	.type		= anakin_type,
-};
-
-static struct uart_port anakin_ports[UART_NR] = {
-	{
-		.base		= IO_BASE + UART0,
-		.irq		= IRQ_UART0,
-		.uartclk	= 3686400,
-		.fifosize	= 0,
-		.ops		= &anakin_pops,
-		.flags		= ASYNC_BOOT_AUTOCONF,
-		.line		= 0,
-	},
-	{
-		.base		= IO_BASE + UART1,
-		.irq		= IRQ_UART1,
-		.uartclk	= 3686400,
-		.fifosize	= 0,
-		.ops		= &anakin_pops,
-		.flags		= ASYNC_BOOT_AUTOCONF,
-		.line		= 1,
-	},
-	{
-		.base		= IO_BASE + UART2,
-		.irq		= IRQ_UART2,
-		.uartclk	= 3686400,
-		.fifosize	= 0,
-		.ops		= &anakin_pops,
-		.flags		= ASYNC_BOOT_AUTOCONF,
-		.line		= 2,
-	},
-	{
-		.base		= IO_BASE + UART3,
-		.irq		= IRQ_UART3,
-		.uartclk	= 3686400,
-		.fifosize	= 0,
-		.ops		= &anakin_pops,
-		.flags		= ASYNC_BOOT_AUTOCONF,
-		.line		= 3,
-	},
-	{
-		.base		= IO_BASE + UART4,
-		.irq		= IRQ_UART4,
-		.uartclk	= 3686400,
-		.fifosize	= 0,
-		.ops		= &anakin_pops,
-		.flags		= ASYNC_BOOT_AUTOCONF,
-		.line		= 4,
-	},
-};
-
-
-#ifdef CONFIG_SERIAL_ANAKIN_CONSOLE
-
-static void
-anakin_console_write(struct console *co, const char *s, unsigned int count)
-{
-	struct uart_port *port = &anakin_ports[co->index];
-	unsigned int flags, status, i;
-
-	/*
-	 *	First save the status then disable the interrupts
-	 */
-	local_irq_save(flags);
-	status = anakin_in(port, 0x18);
-	anakin_out(port, 0x18, status & ~IRQENABLE);
-	local_irq_restore(flags);
-
-	/*
-	 *	Now, do each character
-	 */
-	for (i = 0; i < count; i++, s++) {
-		while (!(anakin_in(port, 0x10) & TXEMPTY))
-			barrier();
-
-		/*
-		 *	Send the character out.
-		 *	If a LF, also do CR...
-		 */
-		anakin_out(port, 0x14, *s);
-		anakin_out(port, 0x18, anakin_in(port, 0x18) | SENDREQUEST);
-
-		if (*s == 10) {
-			while (!(anakin_in(port, 0x10) & TXEMPTY))
-				barrier();
-			anakin_out(port, 0x14, 13);
-			anakin_out(port, 0x18, anakin_in(port, 0x18)
-					| SENDREQUEST);
-		}
-	}
-
-	/*
-	 *	Finally, wait for transmitter to become empty
-	 *	and restore the interrupts
-	 */
-	while (!(anakin_in(port, 0x10) & TXEMPTY))
-		barrier();
-
-	if (status & IRQENABLE) {
-		local_irq_save(flags);
- 		anakin_out(port, 0x18, anakin_in(port, 0x18) | IRQENABLE);
-		local_irq_restore(flags);
-	}
-}
-
-/*
- * Read the current UART setup.
- */
-static void __init
-anakin_console_get_options(struct uart_port *port, int *baud, int *parity, int *bits)
-{
-	int paritycode;
-
-	*baud = GETBAUD (anakin_in(port, 0x10) & PRESCALER);
-	paritycode = GETPARITY(anakin_in(port, 0x18) & PARITY);
-	switch (paritycode) {
-	  case NONEPARITY: *parity = 'n'; break;
-	  case ODDPARITY: *parity = 'o'; break;
-	  case EVENPARITY: *parity = 'e'; break;
-	}
-	*bits = 8;
-}
-
-static int __init
-anakin_console_setup(struct console *co, char *options)
-{
-	struct uart_port *port;
-	int baud = CONFIG_ANAKIN_DEFAULT_BAUDRATE;
-	int bits = 8;
-	int parity = 'n';
-
-	/*
-	 * Check whether an invalid uart number has been specified, and
-	 * if so, search for the first available port that does have
-	 * console support.
-	 */
-	if (co->index >= UART_NR)
-		co->index = 0;
-	port = &anakin_ports[co->index];
-
-	if (options)
-		uart_parse_options(options, &baud, &parity, &bits);
-	else
-		anakin_console_get_options(port, &baud, &parity, &bits);
-
-	return uart_set_options(port, co, baud, parity, bits);
-}
-
-extern struct uart_driver anakin_reg;
-static struct console anakin_console = {
-	.name		= SERIAL_ANAKIN_NAME,
-	.write		= anakin_console_write,
-	.device		= uart_console_device,
-	.setup		= anakin_console_setup,
-	.flags		= CON_PRINTBUFFER,
-	.index		= -1,
-};
-
-static int __init anakin_console_init(void)
-{
-	register_console(&anakin_console);
-	return 0;
-}
-console_initcall(anakin_console_init);
-
-#define ANAKIN_CONSOLE		&anakin_console
-#else
-#define ANAKIN_CONSOLE		NULL
-#endif
-
-static struct uart_driver anakin_reg = {
-	.driver_name		= SERIAL_ANAKIN_NAME,
-	.dev_name		= SERIAL_ANAKIN_NAME,
-	.major			= SERIAL_ANAKIN_MAJOR,
-	.minor			= SERIAL_ANAKIN_MINOR,
-	.nr			= UART_NR,
-	.cons			= ANAKIN_CONSOLE,
-};
-
-static int __init
-anakin_init(void)
-{
-	int ret;
-
-	printk(KERN_INFO "Serial: Anakin driver $Revision: 1.32 $\n");
-
-	ret = uart_register_driver(&anakin_reg);
-	if (ret == 0) {
-		int i;
-
-		for (i = 0; i < UART_NR; i++)
-			uart_add_one_port(&anakin_reg, &anakin_ports[i]);
-	}
-	return ret;
-}
-
-__initcall(anakin_init);
-
-MODULE_DESCRIPTION("Anakin serial driver");
-MODULE_AUTHOR("Tak-Shing Chan <chan@aleph1.co.uk>");
-MODULE_SUPPORTED_DEVICE("ttyAN");
-MODULE_LICENSE("GPL");
-MODULE_ALIAS_CHARDEV(SERIAL_ANAKIN_MAJOR, SERIAL_ANAKIN_MINOR);
diff -purN linux-post-2.6.5-rc2-20040326/drivers/video/Kconfig linux-post-2.6.5-rc2-20040327/drivers/video/Kconfig
--- linux-post-2.6.5-rc2-20040326/drivers/video/Kconfig	2004-02-18 08:40:48.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/video/Kconfig	2004-03-25 17:57:01.000000000 +0000
@@ -76,10 +76,6 @@ config FB_ACORN
 	  hardware found in Acorn RISC PCs and other ARM-based machines.  If
 	  unsure, say N.
 
-config FB_ANAKIN
-	bool "Anakin LCD support"
-	depends on FB && ARM && ARCH_ANAKIN
-
 config FB_CLPS711X
 	bool "CLPS711X LCD support"
 	depends on FB && ARM && ARCH_CLPS711X
diff -purN linux-post-2.6.5-rc2-20040326/drivers/video/Makefile linux-post-2.6.5-rc2-20040327/drivers/video/Makefile
--- linux-post-2.6.5-rc2-20040326/drivers/video/Makefile	2004-02-18 08:41:08.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/video/Makefile	2004-03-25 17:57:01.000000000 +0000
@@ -28,7 +28,6 @@ obj-$(CONFIG_FB_CONTROL)          += con
 obj-$(CONFIG_FB_PLATINUM)         += platinumfb.o macmodes.o cfbfillrect.o cfbcopyarea.o cfbimgblt.o
 obj-$(CONFIG_FB_VALKYRIE)         += valkyriefb.o macmodes.o cfbfillrect.o cfbcopyarea.o cfbimgblt.o
 obj-$(CONFIG_FB_CT65550)          += chipsfb.o cfbfillrect.o cfbcopyarea.o cfbimgblt.o
-obj-$(CONFIG_FB_ANAKIN)           += anakinfb.o cfbfillrect.o cfbcopyarea.o cfbimgblt.o
 obj-$(CONFIG_FB_CLPS711X)         += clps711xfb.o cfbfillrect.o cfbcopyarea.o cfbimgblt.o
 obj-$(CONFIG_FB_CYBER)            += cyberfb.o
 obj-$(CONFIG_FB_CYBER2000)        += cyber2000fb.o cfbfillrect.o cfbcopyarea.o cfbimgblt.o
diff -purN linux-post-2.6.5-rc2-20040326/drivers/video/anakinfb.c linux-post-2.6.5-rc2-20040327/drivers/video/anakinfb.c
--- linux-post-2.6.5-rc2-20040326/drivers/video/anakinfb.c	2003-04-24 10:30:41.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/video/anakinfb.c	1970-01-01 00:00:00.000000000 +0000
@@ -1,102 +0,0 @@
-/*
- *  linux/drivers/video/anakinfb.c
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   23-Apr-2001 TTC	Created
- */
-
-#include <linux/types.h>
-#include <linux/fb.h>
-#include <linux/string.h>
-#include <linux/errno.h>
-#include <linux/init.h>
-#include <linux/module.h>
-
-#include <asm/io.h>
-
-static u32 colreg[17];
-static struct fb_info fb_info;
-
-static struct fb_var_screeninfo anakinfb_var = {
-	.xres 		= 400,
-	.yres 		= 234,
-	.xres_virtual 	= 400,
-	.yres_virtual 	= 234,
-	.bits_per_pixel = 16,
-	.red 		= { 11, 5, 0 },
-	.green 		= {  5, 6, 0 }, 
-	.blue 		= {  0, 5, 0 },
-	.activate	= FB_ACTIVATE_NOW,
-	.height		= -1,
-	.width		= -1,
-	.vmode		= FB_VMODE_NONINTERLACED,
-};
-
-static struct fb_fix_screeninfo anakinfb_fix = {
-	.id 		= "AnakinFB",
-	.smem_start 	= VGA_START,
-	.smem_len 	= VGA_SIZE,
-	.type 		= FB_TYPE_PACKED_PIXELS,
-	.visual 	= FB_VISUAL_TRUECOLOR,
-	.line_length 	= 400*2,
-	.accel 		= FB_ACCEL_NONE,
-};
-
-static int
-anakinfb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,
-			u_int transp, struct fb_info *info)
-{
-	if (regno > 15)
-		return 1;
-
-	((u16 *)(info->pseudo_palette))[regno] = (red & 0xf800) | (green & 0xfc00 >> 5) | (blue & 0xf800 >> 11);
-	return 0;
-}
-
-static struct fb_ops anakinfb_ops = {
-	.owner		= THIS_MODULE,
-	.fb_setcolreg	= anakinfb_setcolreg,
-	.fb_fillrect	= cfb_fillrect,
-	.fb_copyarea	= cfb_copyarea,
-	.fb_imageblit	= cfb_imageblit,
-	.fb_cursor	= soft_cursor,
-};
-
-int __init
-anakinfb_init(void)
-{
-	memset(&fb_info, 0, sizeof(struct fb_info));
-
-	fb_info.flags = FBINFO_FLAG_DEFAULT;
-	fb_info.fbops = &anakinfb_ops;
-	fb_info.var = anakinfb_var;
-	fb_info.fix = anakinfb_fix;
-	fb_info.psuedo_palette = colreg;
-	if (!(request_mem_region(VGA_START, VGA_SIZE, "vga")))
-		return -ENOMEM;
-	if (fb_info.screen_base = ioremap(VGA_START, VGA_SIZE)) {
-		release_mem_region(VGA_START, VGA_SIZE);
-		return -EIO;
-	}
-
-	fb_alloc_cmap(&fb_info.cmap, 16, 0);
-
-	if (register_framebuffer(&fb_info) < 0) {
-		iounmap(fb_info.screen_base);
-		release_mem_region(VGA_START, VGA_SIZE);
-		return -EINVAL;
-	}
-
-	MOD_INC_USE_COUNT;
-	return 0;
-}
-
-MODULE_AUTHOR("Tak-Shing Chan <chan@aleph1.co.uk>");
-MODULE_DESCRIPTION("Anakin framebuffer driver");
-MODULE_SUPPORTED_DEVICE("fb");
diff -purN linux-post-2.6.5-rc2-20040326/drivers/video/fbmem.c linux-post-2.6.5-rc2-20040327/drivers/video/fbmem.c
--- linux-post-2.6.5-rc2-20040326/drivers/video/fbmem.c	2004-03-23 10:05:27.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/drivers/video/fbmem.c	2004-03-25 17:57:01.000000000 +0000
@@ -55,7 +55,6 @@ extern int acornfb_init(void);
 extern int acornfb_setup(char*);
 extern int amifb_init(void);
 extern int amifb_setup(char*);
-extern int anakinfb_init(void);
 extern int atafb_init(void);
 extern int atafb_setup(char*);
 extern int macfb_init(void);
@@ -180,9 +179,6 @@ static struct {
 #ifdef CONFIG_FB_AMIGA
 	{ "amifb", amifb_init, amifb_setup },
 #endif
-#ifdef CONFIG_FB_ANAKIN
-	{ "anakinfb", anakinfb_init, NULL },
-#endif
 #ifdef CONFIG_FB_CLPS711X
 	{ "clps711xfb", clps711xfb_init, NULL },
 #endif
diff -purN linux-post-2.6.5-rc2-20040326/include/acpi/acconfig.h linux-post-2.6.5-rc2-20040327/include/acpi/acconfig.h
--- linux-post-2.6.5-rc2-20040326/include/acpi/acconfig.h	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/acpi/acconfig.h	2004-03-26 18:47:07.000000000 +0000
@@ -64,7 +64,7 @@
 
 /* Version string */
 
-#define ACPI_CA_VERSION                 0x20040311
+#define ACPI_CA_VERSION                 0x20040326
 
 /* Maximum objects in the various object caches */
 
diff -purN linux-post-2.6.5-rc2-20040326/include/acpi/acglobal.h linux-post-2.6.5-rc2-20040327/include/acpi/acglobal.h
--- linux-post-2.6.5-rc2-20040326/include/acpi/acglobal.h	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/acpi/acglobal.h	2004-03-26 18:47:07.000000000 +0000
@@ -87,6 +87,7 @@ extern      u32                         
 
 ACPI_EXTERN u8                                  acpi_gbl_create_osi_method;
 ACPI_EXTERN u8                                  acpi_gbl_all_methods_serialized;
+ACPI_EXTERN u8                                  acpi_gbl_leave_wake_gpes_disabled;
 
 /*****************************************************************************
  *
@@ -196,6 +197,7 @@ extern const char                       
 
 ACPI_EXTERN struct acpi_namespace_node          acpi_gbl_root_node_struct;
 ACPI_EXTERN struct acpi_namespace_node         *acpi_gbl_root_node;
+ACPI_EXTERN struct acpi_namespace_node         *acpi_gbl_fadt_gpe_device;
 
 extern const u8                                 acpi_gbl_ns_properties[NUM_NS_TYPES];
 extern const struct acpi_predefined_names       acpi_gbl_pre_defined_names [NUM_PREDEFINED_NAMES];
diff -purN linux-post-2.6.5-rc2-20040326/include/acpi/achware.h linux-post-2.6.5-rc2-20040327/include/acpi/achware.h
--- linux-post-2.6.5-rc2-20040326/include/acpi/achware.h	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/acpi/achware.h	2004-03-26 18:47:07.000000000 +0000
@@ -149,11 +149,11 @@ acpi_hw_get_gpe_status (
 	acpi_event_status               *event_status);
 
 acpi_status
-acpi_hw_disable_non_wakeup_gpes (
+acpi_hw_prepare_gpes_for_sleep (
 	void);
 
 acpi_status
-acpi_hw_enable_non_wakeup_gpes (
+acpi_hw_restore_gpes_on_wake (
 	void);
 
 
diff -purN linux-post-2.6.5-rc2-20040326/include/acpi/aclocal.h linux-post-2.6.5-rc2-20040327/include/acpi/aclocal.h
--- linux-post-2.6.5-rc2-20040326/include/acpi/aclocal.h	2004-01-17 23:12:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/acpi/aclocal.h	2004-03-26 18:47:07.000000000 +0000
@@ -360,6 +360,13 @@ struct acpi_gpe_xrupt_info
 };
 
 
+struct acpi_gpe_walk_info
+{
+	struct acpi_namespace_node              *gpe_device;
+	struct acpi_gpe_block_info              *gpe_block;
+};
+
+
 typedef acpi_status (*ACPI_GPE_CALLBACK) (
 	struct acpi_gpe_xrupt_info      *gpe_xrupt_info,
 	struct acpi_gpe_block_info      *gpe_block);
diff -purN linux-post-2.6.5-rc2-20040326/include/acpi/actypes.h linux-post-2.6.5-rc2-20040327/include/acpi/actypes.h
--- linux-post-2.6.5-rc2-20040326/include/acpi/actypes.h	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/acpi/actypes.h	2004-03-26 18:47:08.000000000 +0000
@@ -413,7 +413,7 @@ typedef u32                             
  * of the ACPI object_type() operator (See the ACPI Spec). Therefore,
  * only add to the first group if the spec changes.
  *
- * Types must be kept in sync with the global acpi_ns_properties
+ * NOTE: Types must be kept in sync with the global acpi_ns_properties
  * and acpi_ns_type_names arrays.
  */
 typedef u32                                     acpi_object_type;
@@ -450,26 +450,27 @@ typedef u32                             
 #define ACPI_TYPE_LOCAL_INDEX_FIELD     0x13
 #define ACPI_TYPE_LOCAL_REFERENCE       0x14  /* Arg#, Local#, Name, Debug, ref_of, Index */
 #define ACPI_TYPE_LOCAL_ALIAS           0x15
-#define ACPI_TYPE_LOCAL_NOTIFY          0x16
-#define ACPI_TYPE_LOCAL_ADDRESS_HANDLER 0x17
-#define ACPI_TYPE_LOCAL_RESOURCE        0x18
-#define ACPI_TYPE_LOCAL_RESOURCE_FIELD  0x19
-#define ACPI_TYPE_LOCAL_SCOPE           0x1A  /* 1 Name, multiple object_list Nodes */
+#define ACPI_TYPE_LOCAL_METHOD_ALIAS    0x16
+#define ACPI_TYPE_LOCAL_NOTIFY          0x17
+#define ACPI_TYPE_LOCAL_ADDRESS_HANDLER 0x18
+#define ACPI_TYPE_LOCAL_RESOURCE        0x19
+#define ACPI_TYPE_LOCAL_RESOURCE_FIELD  0x1A
+#define ACPI_TYPE_LOCAL_SCOPE           0x1B  /* 1 Name, multiple object_list Nodes */
 
-#define ACPI_TYPE_NS_NODE_MAX           0x1A  /* Last typecode used within a NS Node */
+#define ACPI_TYPE_NS_NODE_MAX           0x1B  /* Last typecode used within a NS Node */
 
 /*
  * These are special object types that never appear in
  * a Namespace node, only in an union acpi_operand_object
  */
-#define ACPI_TYPE_LOCAL_EXTRA           0x1B
-#define ACPI_TYPE_LOCAL_DATA            0x1C
+#define ACPI_TYPE_LOCAL_EXTRA           0x1C
+#define ACPI_TYPE_LOCAL_DATA            0x1D
 
-#define ACPI_TYPE_LOCAL_MAX             0x1C
+#define ACPI_TYPE_LOCAL_MAX             0x1D
 
 /* All types above here are invalid */
 
-#define ACPI_TYPE_INVALID               0x1D
+#define ACPI_TYPE_INVALID               0x1E
 #define ACPI_TYPE_NOT_FOUND             0xFF
 
 
@@ -511,9 +512,8 @@ typedef u32                             
 #define ACPI_WRITE                      1
 #define ACPI_IO_MASK                    1
 
-
 /*
- * Acpi Event Types: Fixed & General Purpose
+ * Event Types: Fixed & General Purpose
  */
 typedef u32                                     acpi_event_type;
 
@@ -528,25 +528,8 @@ typedef u32                             
 #define ACPI_EVENT_MAX                  4
 #define ACPI_NUM_FIXED_EVENTS           ACPI_EVENT_MAX + 1
 
-#define ACPI_GPE_INVALID                0xFF
-#define ACPI_GPE_MAX                    0xFF
-#define ACPI_NUM_GPE                    256
-
-#define ACPI_EVENT_LEVEL_TRIGGERED      1
-#define ACPI_EVENT_EDGE_TRIGGERED       2
-
 /*
- * Flags for GPE and Lock interfaces
- */
-#define ACPI_EVENT_WAKE_ENABLE          0x2
-#define ACPI_EVENT_WAKE_DISABLE         0x2
-
-#define ACPI_NOT_ISR                    0x1
-#define ACPI_ISR                        0x0
-
-
-/*
- * acpi_event Status:
+ * Event Status - Per event
  * -------------
  * The encoding of acpi_event_status is illustrated below.
  * Note that a set bit (1) indicates the property is TRUE
@@ -567,6 +550,45 @@ typedef u32                             
 #define ACPI_EVENT_FLAG_WAKE_ENABLED    (acpi_event_status) 0x02
 #define ACPI_EVENT_FLAG_SET             (acpi_event_status) 0x04
 
+/*
+ * General Purpose Events (GPE)
+ */
+#define ACPI_GPE_INVALID                0xFF
+#define ACPI_GPE_MAX                    0xFF
+#define ACPI_NUM_GPE                    256
+
+/*
+ * GPE info flags - Per GPE
+ * +---------+-+-+-+
+ * |Bits 8:3 |2|1|0|
+ * +---------+-+-+-+
+ *          | | | |
+ *          | | | +- Edge or Level Triggered
+ *          | | +--- Type: Wake or Runtime
+ *          | +----- Enabled for wake?
+ *          +--------<Reserved>
+ */
+#define ACPI_GPE_XRUPT_TYPE_MASK        (u8) 1
+#define ACPI_GPE_LEVEL_TRIGGERED        (u8) 1
+#define ACPI_GPE_EDGE_TRIGGERED         (u8) 0
+
+#define ACPI_GPE_TYPE_MASK              (u8) 2
+#define ACPI_GPE_TYPE_WAKE              (u8) 2
+#define ACPI_GPE_TYPE_RUNTIME           (u8) 0       /* Default */
+
+#define ACPI_GPE_ENABLE_MASK            (u8) 4
+#define ACPI_GPE_ENABLED                (u8) 4
+#define ACPI_GPE_DISABLED               (u8) 0       /* Default */
+
+/*
+ * Flags for GPE and Lock interfaces
+ */
+#define ACPI_EVENT_WAKE_ENABLE          0x2
+#define ACPI_EVENT_WAKE_DISABLE         0x2
+
+#define ACPI_NOT_ISR                    0x1
+#define ACPI_ISR                        0x0
+
 
 /* Notify types */
 
diff -purN linux-post-2.6.5-rc2-20040326/include/acpi/acutils.h linux-post-2.6.5-rc2-20040327/include/acpi/acutils.h
--- linux-post-2.6.5-rc2-20040326/include/acpi/acutils.h	2004-03-13 00:29:42.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/acpi/acutils.h	2004-03-26 18:47:07.000000000 +0000
@@ -471,6 +471,7 @@ acpi_ut_delete_internal_object_list (
 #define METHOD_NAME__PRT        "_PRT"
 #define METHOD_NAME__CRS        "_CRS"
 #define METHOD_NAME__PRS        "_PRS"
+#define METHOD_NAME__PRW        "_PRW"
 
 
 acpi_status
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/dma.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/dma.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/dma.h	2002-02-05 20:09:39.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/dma.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,20 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/dma.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 W/TTC	Created
- */
-
-#ifndef __ASM_ARCH_DMA_H
-#define __ASM_ARCH_DMA_H
-
-#define MAX_DMA_ADDRESS		0xffffffff
-#define MAX_DMA_CHANNELS	0
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/hardware.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/hardware.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/hardware.h	2002-02-05 20:09:39.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/hardware.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,69 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/hardware.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   10-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_HARDWARE_H
-#define __ASM_ARCH_HARDWARE_H
-
-/*
- * Memory map
- */
-#define SRAM_START		0x00000000
-#define SRAM_SIZE		0x00100000
-#define SRAM_BASE		0xdf000000
-
-#define SDRAM_START		0x20000000
-#define SDRAM_SIZE		0x04000000
-#define SDRAM_BASE		0xc0000000
-
-#define IO_START		0x40000000
-#define IO_SIZE			0x00100000
-#define IO_BASE			0xe0000000
-
-#define FLASH_START		0x60000000
-#define FLASH_SIZE		0x00080000
-#define FLASH_BASE		0xe8000000
-
-#define VGA_START		0x80000000
-#define VGA_SIZE		0x0002db40
-#define VGA_BASE		0xf0000000
-
-/*
- * IO map
- */
-#define IO_CONTROLLER		0x00000
-#define INTERRUPT_CONTROLLER	0x02000
-#define UART0			0x04000
-#define UART1			0x06000
-#define UART2			0x08000
-#define CODEC			0x0a000
-#define UART4			0x0c000
-#define UART3			0x0e000
-#define DISPLAY_CONTROLLER	0x10000
-#define DAB			0x12000
-#define STATE_CONTROLLER	0x14000
-#define CAN			0x23000
-#define COMPACTFLASH		0x24000
-
-/*
- * Use SRAM for D-cache flush
- */
-#define FLUSH_BASE_PHYS		SRAM_START
-#define FLUSH_BASE		SRAM_BASE
-#define UNCACHEABLE_ADDR	(SRAM_BASE + 0x10000)
-
-/*
- * Use SDRAM for memory
- */
-#define MEM_SIZE		SDRAM_SIZE
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/ide.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/ide.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/ide.h	2002-05-27 14:09:24.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/ide.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,55 +0,0 @@
-/*
- * linux/include/asm-arm/arch-anakin/ide.h
- *
- * Copyright 2001 Blue Mug Inc. for Acunia N.V.
- *
- * 08-jun-2001: Initial clone of arch-sa1100/ide.h by Jon McClintock
- *              (jonm@bluemug.com).
- */
- 
-#include <asm/irq.h>
-#include <asm/hardware.h>
-
-/*
- * Set up a hw structure for a specified data port, control port and IRQ.
- * This should follow whatever the default interface uses.
- */
-static __inline__ void
-ide_init_hwif_ports(hw_regs_t *hw, int data_port, int ctrl_port, int *irq)
-{
-	ide_ioreg_t reg;
-	int i;
-	int regincr = 4;
-	
-	memset(hw, 0, sizeof(*hw));
-
-	reg = (ide_ioreg_t)data_port;
-
-	for (i = IDE_DATA_OFFSET; i <= IDE_STATUS_OFFSET; i++) {
-		hw->io_ports[i] = reg;
-		reg += regincr;
-	}
-
-	hw->io_ports[IDE_CONTROL_OFFSET] = (ide_ioreg_t) ctrl_port;
-
-	if (irq)
-		*irq = 0;
-}
-
-
-/*
- * This registers the standard ports for this architecture with the IDE
- * driver.
- */
-static __inline__ void
-ide_init_default_hwifs(void)
-{
-    hw_regs_t hw;
-
-    ide_init_hwif_ports(&hw, IO_BASE + COMPACTFLASH,
-			IO_BASE + COMPACTFLASH + IDE_CONTROL_OFFSET, NULL);
-    hw.irq = IRQ_COMPACTFLASH;
-    ide_register_hw(&hw);
-}
-
-
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/io.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/io.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/io.h	2002-02-05 15:23:18.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/io.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,30 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/io.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   10-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARM_ARCH_IO_H
-#define __ASM_ARM_ARCH_IO_H
-
-
-#define IO_SPACE_LIMIT		0xffffffff
-
-#define __io(a)			(a)
-
-/*
- * We don't support ins[lb]/outs[lb].  Make them fault.
- */
-#define __raw_readsb(p,d,l)	do { *(int *)0 = 0; } while (0)
-#define __raw_readsl(p,d,l)	do { *(int *)0 = 0; } while (0)
-#define __raw_writesb(p,d,l)	do { *(int *)0 = 0; } while (0)
-#define __raw_writesl(p,d,l)	do { *(int *)0 = 0; } while (0)
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/irqs.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/irqs.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/irqs.h	2002-02-05 20:09:39.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/irqs.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,33 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/irqs.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   10-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_IRQS_H
-#define __ASM_ARCH_IRQS_H
-
-#define NR_IRQS			16
-
-#define IRQ_UART0		0
-#define IRQ_UART1		1
-#define IRQ_UART2		2
-#define IRQ_TICK		3
-#define IRQ_CODEC		4
-#define IRQ_UART4		5
-#define IRQ_TOUCHSCREEN		6
-#define IRQ_UART3		7
-#define IRQ_FIFO		8
-#define IRQ_CAN			9
-#define IRQ_COMPACTFLASH	10
-#define IRQ_BOSH		12
-#define IRQ_ANAKIN		15
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/memory.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/memory.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/memory.h	2002-11-21 00:04:02.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/memory.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,34 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/memory.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_MEMORY_H
-#define __ASM_ARCH_MEMORY_H
-
-#define TASK_SIZE		(0xbf000000)
-#define TASK_SIZE_26		(64u * 1024 * 1024)
-#define TASK_UNMAPPED_BASE	(0x40000000)
-
-#define PAGE_OFFSET		0xc0000000
-#define PHYS_OFFSET		0x20000000
-
-#define __virt_to_phys(a)	((a) - PAGE_OFFSET + PHYS_OFFSET)
-#define __phys_to_virt(a)	((a) + PAGE_OFFSET - PHYS_OFFSET)
-#define __virt_to_bus(a)	__virt_to_phys(a)
-#define __bus_to_virt(a)	__phys_to_virt(a)
-
-#define __virt_to_phys__is_a_macro
-#define __phys_to_virt__is_a_macro
-#define __virt_to_bus__is_a_macro
-#define __bus_to_virt__is_a_macro
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/param.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/param.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/param.h	2002-07-09 19:05:37.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/param.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,16 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/param.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   11-Apr-2001 TTC	Created
- */
-
-/*
- * Reserved for future use
- */
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/serial.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/serial.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/serial.h	2003-10-05 20:52:40.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/serial.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,29 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/serial.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   11-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_SERIAL_H
-#define __ASM_ARCH_SERIAL_H
-
-#include <asm/io.h>
-#include <asm/irq.h>
-
-/*
- * UART3 and UART4 are not supported yet
- */
-#define STD_SERIAL_PORT_DEFNS	\
-	{ 0, 0, IO_BASE + UART0, IRQ_UART0, 0 }, \
-	{ 0, 0, IO_BASE + UART1, IRQ_UART1, 0 }, \
-	{ 0, 0, IO_BASE + UART2, IRQ_UART2, 0 }
-#define EXTRA_SERIAL_PORT_DEFNS
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/serial_reg.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/serial_reg.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/serial_reg.h	2002-02-05 20:09:39.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/serial_reg.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,65 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/serial_reg.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 TTC	Created
- */
-
-#ifndef ASM_ARCH_SERIAL_REG_H
-#define ASM_ARCH_SERIAL_REG_H
-
-/*
- * Serial registers (other than tx/rx)
- */
-
-/*
- * [UARTx + 0x10]
- */
-#define RXRELEASE		(1 << 0)
-#define TXEMPTY			(1 << 1)
-#define CTS			(1 << 2)
-#define PRESCALER		(31 << 3)
-#define SETBAUD(baud)		((230400 / (baud) - 1) << 3)
-#define GETBAUD(prescaler)	(230400 / (((prescaler) >> 3) + 1))
-
-
-/*
- * [UARTx + 0x18]
- */
-#define IRQENABLE		(1 << 0)
-#define SENDREQUEST		(1 << 1)
-#define RTS			(1 << 2)
-#define DTR			(1 << 3)
-#define DCD			(1 << 4)
-#define BLOCKRX			(1 << 5)
-#define PARITY			(3 << 6)
-#define SETPARITY(parity)	((parity) << 6)
-#define GETPARITY(parity)	((parity) >> 6)
-#define NONEPARITY              (0)
-#define ODDPARITY               (1)
-#define EVENPARITY              (2)
-
-/*
- * [UARTx + 0x1c]
- */
-#define TX			(1 << 0)
-#define RX			(1 << 1)
-#define OVERRUN			(1 << 2)
-
-/*
- * [UARTx + 0x20]
- */
-#define SETBREAK		(1 << 0)
-
-/*
- * Software interrupt register
- */
-#define TXENABLE		(1 << 0)
-
-#endif 
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/system.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/system.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/system.h	2002-04-06 17:23:30.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/system.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,28 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/system.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   11-Apr-2001 TTC	Created
- *   04-May-2001 W/PB	Removed cpu_do_idle()
- */
-
-#ifndef __ASM_ARCH_SYSTEM_H
-#define __ASM_ARCH_SYSTEM_H
-
-static inline void arch_idle(void)
-{
-}
-
-static inline void
-arch_reset(char mode)
-{
-	cpu_reset(0);
-}
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/time.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/time.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/time.h	2003-05-13 15:20:49.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/time.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,30 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/time.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   10-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_TIME_H
-#define __ASM_ARCH_TIME_H
-
-static irqreturn_t
-anakin_timer_interrupt(int irq, void *dev_id, struct pt_regs *regs)
-{
-	do_timer(regs);
-	return IRQ_HANDLED;
-}
-
-void __init time_init(void)
-{
-	timer_irq.handler = anakin_timer_interrupt;
-	setup_irq(IRQ_TICK, &timer_irq);
-}
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/timex.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/timex.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/timex.h	2002-02-05 20:09:39.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/timex.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,22 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/timex.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_TIMEX_H
-#define __ASM_ARCH_TIMEX_H
-
-/*
- * Timex specification for Anakin
- */
-#define CLOCK_TICK_RATE		(1000 / 8)
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/uncompress.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/uncompress.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/uncompress.h	2002-02-17 11:52:04.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/uncompress.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,58 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/uncompress.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   10-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_UNCOMPRESS_H
-#define __ASM_ARCH_UNCOMPRESS_H
-
-#include <linux/config.h>
-#include <asm/io.h>
-#include <asm/arch/serial_reg.h>
-
-#ifndef CONFIG_ANAKIN_DEFAULT_BAUDRATE
-#define CONFIG_ANAKIN_DEFAULT_BAUDRATE	9600
-#endif
-
-static inline void
-putc(int c)
-{
-	while (!(__raw_readl(IO_START + UART0 + 0x10) & TXEMPTY));
-	__raw_writel(c, IO_START + UART0 + 0x14);
-	__raw_writel(__raw_readl(IO_START + UART0 + 0x18)
-			| SENDREQUEST, IO_START + UART0 + 0x18);
-}
-
-static void
-puts(const char *s)
-{
-	int c;
-
-	while ((c = *s++)) {
-		putc(c);
-		if (c == '\n') putc('\r');
-	}
-}
-
-static void
-arch_decomp_setup(void)
-{
-	__raw_writel(__raw_readl(IO_START + UART0 + 0x10) & ~PRESCALER
-			| SETBAUD(CONFIG_ANAKIN_DEFAULT_BAUDRATE),
-			IO_START + UART0 + 0x10);
-	__raw_writel(__raw_readl(IO_START + UART0 + 0x18) & ~(IRQENABLE
-			| RTS | DTR | BLOCKRX | PARITY),
-			IO_START + UART0 + 0x18);
-}
-
-#define arch_decomp_wdog()
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/vmalloc.h linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/vmalloc.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/arch-anakin/vmalloc.h	2003-10-02 07:11:59.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/arch-anakin/vmalloc.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,28 +0,0 @@
-/*
- *  linux/include/asm-arm/arch-anakin/vmalloc.h
- *
- *  Copyright (C) 2001 Aleph One Ltd. for Acunia N.V.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- *
- *  Changelog:
- *   09-Apr-2001 TTC	Created
- */
-
-#ifndef __ASM_ARCH_VMALLOC_H
-#define __ASM_ARCH_VMALLOC_H
-
-/*
- * VMALLOC_ARCH_OFFSET must be set to VMALLOC_OFFSET (check
- * linux/arch/arm/kernel/traps.c)
- */
-#define VMALLOC_ARCH_OFFSET	(8 * 1024 * 1024)
-#define VMALLOC_START		(((unsigned long) (high_memory) + VMALLOC_ARCH_OFFSET) & ~(VMALLOC_ARCH_OFFSET - 1))
-#define VMALLOC_END		(PAGE_OFFSET + 0x10000000)
-
-#define MODULE_START	(PAGE_OFFSET - 16*1048576)
-#define MODULE_END	(PAGE_OFFSET)
-
-#endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/dma-mapping.h linux-post-2.6.5-rc2-20040327/include/asm-arm/dma-mapping.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/dma-mapping.h	2004-03-14 06:54:58.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/dma-mapping.h	2004-03-25 19:50:12.000000000 +0000
@@ -352,5 +352,13 @@ dma_sync_sg_for_device(struct device *de
 	}
 }
 
+/*
+ * DMA errors are defined by all-bits-set in the DMA address.
+ */
+static inline int dma_mapping_error(dma_addr_t dma_addr)
+{
+	return dma_addr == ~0;
+}
+
 #endif /* __KERNEL__ */
 #endif
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-arm/hardware/amba.h linux-post-2.6.5-rc2-20040327/include/asm-arm/hardware/amba.h
--- linux-post-2.6.5-rc2-20040326/include/asm-arm/hardware/amba.h	2004-02-06 15:00:43.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-arm/hardware/amba.h	2004-03-25 17:43:01.000000000 +0000
@@ -15,6 +15,7 @@
 struct amba_device {
 	struct device		dev;
 	struct resource		res;
+	u64			dma_mask;
 	unsigned int		periphid;
 	unsigned int		irq[AMBA_NR_IRQS];
 };
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-ppc/ptrace.h linux-post-2.6.5-rc2-20040327/include/asm-ppc/ptrace.h
--- linux-post-2.6.5-rc2-20040326/include/asm-ppc/ptrace.h	2003-06-15 23:39:20.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-ppc/ptrace.h	2004-03-25 03:02:44.000000000 +0000
@@ -49,7 +49,10 @@ struct pt_regs {
 #define instruction_pointer(regs) ((regs)->nip)
 #define user_mode(regs) (((regs)->msr & MSR_PR) != 0)
 
-#define force_successful_syscall_return()   set_thread_flag(TIF_FORCE_NOERROR)
+#define force_successful_syscall_return()   \
+	do { \
+		current_thread_info()->local_flags |= _TIFL_FORCE_NOERROR; \
+	} while(0)
 
 /*
  * We use the least-significant bit of the trap field to indicate
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-ppc/thread_info.h linux-post-2.6.5-rc2-20040327/include/asm-ppc/thread_info.h
--- linux-post-2.6.5-rc2-20040326/include/asm-ppc/thread_info.h	2003-09-15 20:59:05.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-ppc/thread_info.h	2004-03-25 03:03:56.000000000 +0000
@@ -18,6 +18,7 @@ struct thread_info {
 	struct task_struct	*task;		/* main task structure */
 	struct exec_domain	*exec_domain;	/* execution domain */
 	unsigned long		flags;		/* low level flags */
+	unsigned long		local_flags;	/* non-racy flags */
 	int			cpu;		/* cpu we're on */
 	int			preempt_count;
 	struct restart_block	restart_block;
@@ -28,6 +29,7 @@ struct thread_info {
 	.task =		&tsk,			\
 	.exec_domain =	&default_exec_domain,	\
 	.flags =	0,			\
+	.local_flags =  0,			\
 	.cpu =		0,			\
 	.preempt_count = 1,			\
 	.restart_block = {			\
@@ -69,8 +71,9 @@ static inline struct thread_info *curren
 #define TI_TASK		0
 #define TI_EXECDOMAIN	4
 #define TI_FLAGS	8
-#define TI_CPU		12
-#define TI_PREEMPT	16
+#define TI_LOCAL_FLAGS	12
+#define TI_CPU		16
+#define TI_PREEMPT	20
 
 #define PREEMPT_ACTIVE		0x4000000
 
@@ -83,16 +86,22 @@ static inline struct thread_info *curren
 #define TIF_NEED_RESCHED	3	/* rescheduling necessary */
 #define TIF_POLLING_NRFLAG	4	/* true if poll_idle() is polling
 					   TIF_NEED_RESCHED */
-#define TIF_FORCE_NOERROR	5	/* don't return error from current
-					   syscall even if result < 0 */
-
 /* as above, but as bit values */
 #define _TIF_SYSCALL_TRACE	(1<<TIF_SYSCALL_TRACE)
 #define _TIF_NOTIFY_RESUME	(1<<TIF_NOTIFY_RESUME)
 #define _TIF_SIGPENDING		(1<<TIF_SIGPENDING)
 #define _TIF_NEED_RESCHED	(1<<TIF_NEED_RESCHED)
 #define _TIF_POLLING_NRFLAG	(1<<TIF_POLLING_NRFLAG)
-#define _TIF_FORCE_NOERROR	(1<<TIF_FORCE_NOERROR)
+
+/*
+ * Non racy (local) flags bit numbers
+ */
+#define TIFL_FORCE_NOERROR	0	/* don't return error from current
+					   syscall even if result < 0 */
+
+/* as above, but as bit values */
+#define _TIFL_FORCE_NOERROR	(1<<TIFL_FORCE_NOERROR)
+
 
 #endif /* __KERNEL__ */
 
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-sparc64/page.h linux-post-2.6.5-rc2-20040327/include/asm-sparc64/page.h
--- linux-post-2.6.5-rc2-20040326/include/asm-sparc64/page.h	2003-10-24 08:04:41.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-sparc64/page.h	2004-03-26 22:12:13.000000000 +0000
@@ -48,8 +48,8 @@ typedef struct { unsigned long iopgprot;
 
 #define pte_val(x)	((x).pte)
 #define iopte_val(x)	((x).iopte)
-#define pmd_val(x)      ((unsigned long)(x).pmd)
-#define pgd_val(x)	((unsigned long)(x).pgd)
+#define pmd_val(x)      ((x).pmd)
+#define pgd_val(x)	((x).pgd)
 #define ctxd_val(x)	((x).ctxd)
 #define pgprot_val(x)	((x).pgprot)
 #define iopgprot_val(x)	((x).iopgprot)
@@ -74,8 +74,8 @@ typedef unsigned long iopgprot_t;
 
 #define pte_val(x)	(x)
 #define iopte_val(x)	(x)
-#define pmd_val(x)      ((unsigned long)(x))
-#define pgd_val(x)	((unsigned long)(x))
+#define pmd_val(x)      (x)
+#define pgd_val(x)	(x)
 #define ctxd_val(x)	(x)
 #define pgprot_val(x)	(x)
 #define iopgprot_val(x)	(x)
diff -purN linux-post-2.6.5-rc2-20040326/include/asm-sparc64/svr4.h linux-post-2.6.5-rc2-20040327/include/asm-sparc64/svr4.h
--- linux-post-2.6.5-rc2-20040326/include/asm-sparc64/svr4.h	2003-04-22 06:09:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/asm-sparc64/svr4.h	2004-03-26 22:16:56.000000000 +0000
@@ -87,7 +87,7 @@ enum svr4_stack_flags {
 
 /* signal stack execution place, unsupported */
 typedef struct svr4_stack_t {
-        char *sp;
+        u32  sp;
         int  size;
         int  flags;
 } svr4_stack_t;
diff -purN linux-post-2.6.5-rc2-20040326/include/linux/inetdevice.h linux-post-2.6.5-rc2-20040327/include/linux/inetdevice.h
--- linux-post-2.6.5-rc2-20040326/include/linux/inetdevice.h	2004-02-18 03:03:26.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/linux/inetdevice.h	2004-03-25 23:06:10.000000000 +0000
@@ -36,6 +36,8 @@ struct in_device
 	rwlock_t		lock;
 	int			dead;
 	struct in_ifaddr	*ifa_list;	/* IP ifaddr chain		*/
+	int			mc_initted;
+
 	struct ip_mc_list	*mc_list;	/* IP multicast filter chain    */
 	rwlock_t		mc_lock;	/* for mc_tomb */
 	struct ip_mc_list	*mc_tomb;
diff -purN linux-post-2.6.5-rc2-20040326/include/linux/pci_ids.h linux-post-2.6.5-rc2-20040327/include/linux/pci_ids.h
--- linux-post-2.6.5-rc2-20040326/include/linux/pci_ids.h	2004-03-16 20:49:40.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/include/linux/pci_ids.h	2004-03-25 10:20:52.000000000 +0000
@@ -1837,6 +1837,12 @@
 #define PCI_DEVICE_ID_TIGON3_5901_2	0x170e
 #define PCI_DEVICE_ID_BCM4401		0x4401
 
+#define PCI_VENDOR_ID_ENE		0x1524
+#define PCI_DEVICE_ID_ENE_1211		0x1211
+#define PCI_DEVICE_ID_ENE_1225		0x1225
+#define PCI_DEVICE_ID_ENE_1410		0x1410
+#define PCI_DEVICE_ID_ENE_1420		0x1420
+
 #define PCI_VENDOR_ID_SYBA		0x1592
 #define PCI_DEVICE_ID_SYBA_2P_EPP	0x0782
 #define PCI_DEVICE_ID_SYBA_1P_ECP	0x0783
diff -purN linux-post-2.6.5-rc2-20040326/net/atm/lec.c linux-post-2.6.5-rc2-20040327/net/atm/lec.c
--- linux-post-2.6.5-rc2-20040326/net/atm/lec.c	2004-02-28 23:54:09.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/net/atm/lec.c	2004-03-25 23:02:11.000000000 +0000
@@ -797,8 +797,8 @@ lec_vcc_attach(struct atm_vcc *vcc, void
 	vcc->pop = lec_pop;
         lec_vcc_added(dev_lec[ioc_data.dev_num]->priv, 
                       &ioc_data, vcc, vcc->push);
-        vcc->push = lec_push;
         vcc->proto_data = dev_lec[ioc_data.dev_num];
+        vcc->push = lec_push;
         return 0;
 }
 
diff -purN linux-post-2.6.5-rc2-20040326/net/ipv4/igmp.c linux-post-2.6.5-rc2-20040327/net/ipv4/igmp.c
--- linux-post-2.6.5-rc2-20040326/net/ipv4/igmp.c	2004-03-05 22:17:31.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/net/ipv4/igmp.c	2004-03-25 23:06:10.000000000 +0000
@@ -1217,6 +1217,9 @@ void ip_mc_down(struct in_device *in_dev
 
 	ASSERT_RTNL();
 
+	if (!in_dev->mc_initted)
+		return;
+
 #ifdef CONFIG_IP_MULTICAST
 	in_dev->mr_ifc_count = 0;
 	if (del_timer(&in_dev->mr_ifc_timer))
@@ -1262,6 +1265,8 @@ void ip_mc_up(struct in_device *in_dev)
 
 	for (i=in_dev->mc_list; i; i=i->next)
 		igmp_group_added(i);
+
+	in_dev->mc_initted = 1;
 }
 
 /*
diff -purN linux-post-2.6.5-rc2-20040326/sound/oss/dmasound/dmasound_core.c linux-post-2.6.5-rc2-20040327/sound/oss/dmasound/dmasound_core.c
--- linux-post-2.6.5-rc2-20040326/sound/oss/dmasound/dmasound_core.c	2004-02-06 08:24:50.000000000 +0000
+++ linux-post-2.6.5-rc2-20040327/sound/oss/dmasound/dmasound_core.c	2004-03-25 07:41:02.000000000 +0000
@@ -1004,6 +1004,7 @@ static void sq_reset(void)
 static int sq_fsync(struct file *filp, struct dentry *dentry)
 {
 	int rc = 0;
+	int timeout = 5;
 
 	write_sq.syncing |= 1;
 	sq_play();	/* there may be an incomplete frame waiting */
@@ -1018,6 +1019,12 @@ static int sq_fsync(struct file *filp, s
 			rc = -EINTR;
 			break;
 		}
+		if (!--timeout) {
+			printk(KERN_WARNING "dmasound: Timeout draining output\n");
+			sq_reset_output();
+			rc = -EIO;
+			break;
+		}
 	}
 
 	/* flag no sync regardless of whether we had a DSP_POST or not */
