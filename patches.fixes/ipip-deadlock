Subject: [PATCH] IPV4: dead lock in error path
From: YOSHIFUJI Hideaki / =?iso-2022-jp?B?GyRCNUhGIzFRTEAbKEI=?= <yoshfuji@linux-ipv6.org>
Date: Fri, 21 May 2004 17:23:29 +0900 (JST)

Hello.

We forgot to release ipip_lock in error path.

--yoshfuji

===== net/ipv4/ipip.c 1.40 vs edited =====
--- 1.40/net/ipv4/ipip.c	Mon Feb 23 14:45:28 2004
+++ edited/net/ipv4/ipip.c	Fri May 21 17:17:28 2004
@@ -479,6 +479,7 @@
 	read_lock(&ipip_lock);
 	if ((tunnel = ipip_tunnel_lookup(iph->saddr, iph->daddr)) != NULL) {
 		if (!xfrm4_policy_check(NULL, XFRM_POLICY_IN, skb)) {
+			read_unlock(&ipip_lock);
 			kfree_skb(skb);
 			return 0;
 		}

-- 
Hideaki YOSHIFUJI @ USAGI Project <yoshfuji@linux-ipv6.org>
GPG FP: 9022 65EB 1ECF 3AD1 0BDF  80D8 4807 F894 E062 0EEA

