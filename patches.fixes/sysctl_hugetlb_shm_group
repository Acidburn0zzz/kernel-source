diff -urNp linux-2.6.5/Documentation/filesystems/proc.txt linux-2.6.5.SUSE/Documentation/filesystems/proc.txt
--- linux-2.6.5/Documentation/filesystems/proc.txt	2004-04-04 05:36:54.000000000 +0200
+++ linux-2.6.5.SUSE/Documentation/filesystems/proc.txt	2004-05-11 15:15:17.000000000 +0200
@@ -1207,6 +1207,14 @@ On the  other  hand,  enabling this feat
 and thrash the system to death, so large and/or important servers will want to
 set this value to 0.
 
+nr_hugepages and hugetlb_shm_group
+----------------------------------
+
+nr_hugepages configures number of hugetlb page reserved for the system.
+
+hugetlb_shm_group contains group id that is allowed to create SysV shared
+memory segment using hugetlb page.
+
 2.5 /proc/sys/dev - Device specific parameters
 ----------------------------------------------
 
@@ -1823,10 +1831,3 @@ need to  recompile  the kernel, or even 
 command to write value into these files, thereby changing the default settings
 of the kernel.
 ------------------------------------------------------------------------------
-
-
-
-
-
-
-
diff -urNp linux-2.6.5/Documentation/vm/hugetlbpage.txt linux-2.6.5.SUSE/Documentation/vm/hugetlbpage.txt
--- linux-2.6.5/Documentation/vm/hugetlbpage.txt	2004-04-04 05:36:24.000000000 +0200
+++ linux-2.6.5.SUSE/Documentation/vm/hugetlbpage.txt	2004-05-11 15:15:17.000000000 +0200
@@ -91,9 +91,12 @@ A regular chown, chgrp and chmod command
 used to change the file attributes on hugetlbfs.
 
 Also, it is important to note that no such mount command is required if the
-applications are going to use only shmat/shmget system calls.  It is possible
-for same or different applications to use any combination of mmaps and shm*
-calls.  Though the mount of filesystem will be required for using mmaps.
+applications are going to use only shmat/shmget system calls.  Users who
+wish to use hugetlb page via shared memory segment should be a member of
+a supplementary group and system admin needs to configure that gid into
+/proc/sys/vm/hugetlb_shm_group.  It is possible for same or different
+applications to use any combination of mmaps and shm* calls.  Though the
+mount of filesystem will be required for using mmaps.
 
 /* Example of using hugepage in user application using Sys V shared memory
  * system calls.  In this example, app is requesting memory of size 256MB that
diff -urNp linux-2.6.5/fs/hugetlbfs/inode.c linux-2.6.5.SUSE/fs/hugetlbfs/inode.c
--- linux-2.6.5/fs/hugetlbfs/inode.c	2004-05-11 15:15:03.000000000 +0200
+++ linux-2.6.5.SUSE/fs/hugetlbfs/inode.c	2004-05-11 15:15:17.000000000 +0200
@@ -43,6 +43,8 @@ static struct backing_dev_info hugetlbfs
 	.memory_backed	= 1,	/* Does not contribute to dirty memory */
 };
 
+int sysctl_hugetlb_shm_group;
+
 static int hugetlbfs_file_mmap(struct file *file, struct vm_area_struct *vma)
 {
 	struct inode *inode = file->f_dentry->d_inode;
@@ -735,6 +737,12 @@ static unsigned long hugetlbfs_counter(v
 	return ret;
 }
 
+static int can_do_hugetlb_shm(void)
+{
+	return likely(capable(CAP_IPC_LOCK) ||
+			in_group_p(sysctl_hugetlb_shm_group));
+}
+
 struct file *hugetlb_zero_setup(size_t size)
 {
 	int error;
@@ -744,7 +752,7 @@ struct file *hugetlb_zero_setup(size_t s
 	struct qstr quick_string;
 	char buf[16];
 
-	if (!can_do_mlock())
+	if (!can_do_hugetlb_shm())
 		return ERR_PTR(-EPERM);
 
 	if (!is_hugepage_mem_enough(size))
diff -urNp linux-2.6.5/include/linux/hugetlb.h linux-2.6.5.SUSE/include/linux/hugetlb.h
--- linux-2.6.5/include/linux/hugetlb.h	2004-05-11 15:15:03.000000000 +0200
+++ linux-2.6.5.SUSE/include/linux/hugetlb.h	2004-05-11 15:15:17.000000000 +0200
@@ -32,6 +32,7 @@ int is_aligned_hugepage_range(unsigned l
 int pmd_huge(pmd_t pmd);
 
 extern int htlbpage_max;
+extern int sysctl_hugetlb_shm_group;
 
 static inline void
 mark_mm_hugetlb(struct mm_struct *mm, struct vm_area_struct *vma)
diff -urNp linux-2.6.5/include/linux/sysctl.h linux-2.6.5.SUSE/include/linux/sysctl.h
--- linux-2.6.5/include/linux/sysctl.h	2004-05-11 15:15:04.000000000 +0200
+++ linux-2.6.5.SUSE/include/linux/sysctl.h	2004-05-11 15:15:17.000000000 +0200
@@ -172,7 +172,8 @@ enum
 	VM_MAX_MAP_COUNT=22,	/* int: Maximum number of mmaps/address-space */
  	VM_LAPTOP_MODE=23,      /* vm laptop mode */
  	VM_BLOCK_DUMP=24,       /* block dump mode */
- 	VM_DISABLE_CAP_MLOCK=25,/* disable CAP_IPC_LOCK checking */
+	VM_HUGETLB_GROUP=25,	/* permitted hugetlb group */
+ 	VM_DISABLE_CAP_MLOCK=26,/* disable CAP_IPC_LOCK checking */
 };
 
 
diff -urNp linux-2.6.5/kernel/sysctl.c linux-2.6.5.SUSE/kernel/sysctl.c
--- linux-2.6.5/kernel/sysctl.c	2004-05-11 15:15:04.000000000 +0200
+++ linux-2.6.5.SUSE/kernel/sysctl.c	2004-05-11 15:15:17.000000000 +0200
@@ -814,6 +814,14 @@ static ctl_table vm_table[] = {
 		.mode		= 0644,
 		.proc_handler	= &hugetlb_sysctl_handler,
 	 },
+	 {
+		.ctl_name	= VM_HUGETLB_GROUP,
+		.procname	= "hugetlb_shm_group",
+		.data		= &sysctl_hugetlb_shm_group,
+		.maxlen		= sizeof(sysctl_hugetlb_shm_group),
+		.mode		= 0644,
+		.proc_handler	= &proc_dointvec,
+	 },
 #endif
 	{
 		.ctl_name	= VM_LOWER_ZONE_PROTECTION,
