#date: 2004-04-21
#id: 1.1371.705.15
#tag: cpufreq
#time: 17:07:29
#title: [CPUFREQ] Fix unbalanced try_get_module/put_module
#who: davej@redhat.com
#
# ChangeSet
#   1.1371.705.15 04/04/21 17:07:29 davej@redhat.com +1 -0
#   [CPUFREQ] Fix unbalanced try_get_module/put_module
#   Spotted by Charles Coffing <ccoffing@novell.com>
#
# drivers/cpufreq/cpufreq.c +8 -4
#   [CPUFREQ] Fix unbalanced try_get_module/put_module
#     Spotted by Charles Coffing <ccoffing@novell.com>
#
diff -Nru a/drivers/cpufreq/cpufreq.c b/drivers/cpufreq/cpufreq.c
--- a/drivers/cpufreq/cpufreq.c	Wed Apr 28 10:53:15 2004
+++ b/drivers/cpufreq/cpufreq.c	Wed Apr 28 10:53:15 2004
@@ -360,8 +360,10 @@
 		return -EINVAL;
 
 	policy = kmalloc(sizeof(struct cpufreq_policy), GFP_KERNEL);
-	if (!policy)
-		return -ENOMEM;
+	if (!policy) {
+		ret = -ENOMEM;
+		goto nomem_out;
+	}
 	memset(policy, 0, sizeof(struct cpufreq_policy));
 
 	policy->cpu = cpu;
@@ -410,7 +412,7 @@
 	return 0;
 
 
- err_out_unregister:
+err_out_unregister:
 	spin_lock_irqsave(&cpufreq_driver_lock, flags);
 	cpufreq_cpu_data[cpu] = NULL;
 	spin_unlock_irqrestore(&cpufreq_driver_lock, flags);
@@ -418,8 +420,10 @@
 	kobject_unregister(&policy->kobj);
 	wait_for_completion(&policy->kobj_unregister);
 
- err_out:
+err_out:
 	kfree(policy);
+
+nomem_out:
 	module_put(cpufreq_driver->owner);
 	return ret;
 }
