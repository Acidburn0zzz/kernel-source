From: NeilBrown <neilb@cse.unsw.edu.au>
To: Marcelo Tosatti <marcelo.tosatti@cyclades.com>
Cc: nfs@lists.sourceforge.net
Subject: [NFS] [PATCH kNFSd 1 of 4] Fixed possibly xdr parsing error if write size exceed 2^31

xdr_argsize_check needs to cope with the possibility that the
pointer has wrapped and could be below buf->base.

Index: linux-2.6.8/include/linux/nfsd/xdr3.h
===================================================================
--- linux-2.6.8.orig/include/linux/nfsd/xdr3.h
+++ linux-2.6.8/include/linux/nfsd/xdr3.h
@@ -43,7 +43,7 @@ struct nfsd3_writeargs {
 	__u64			offset;
 	__u32			count;
 	int			stable;
-	int			len;
+	__u32			len;
 	struct kvec		vec[RPCSVC_MAXPAGES];
 	int			vlen;
 };
Index: linux-2.6.8/include/linux/sunrpc/svc.h
===================================================================
--- linux-2.6.8.orig/include/linux/sunrpc/svc.h
+++ linux-2.6.8/include/linux/sunrpc/svc.h
@@ -163,7 +163,8 @@ xdr_argsize_check(struct svc_rqst *rqstp
 {
 	char *cp = (char *)p;
 	struct kvec *vec = &rqstp->rq_arg.head[0];
-	return cp - (char*)vec->iov_base <= vec->iov_len;
+	return cp >= (char*)vec->iov_base
+	    && cp <= (char*)vec->iov_base + vec->iov_len;
 }
 
 static inline int
