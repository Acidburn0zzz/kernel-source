Patch from Chuck Lever at NetApp

The O_DIRECT patch introduced in 2.4 had some code to select the blocksize
based on the server's advertised wtmult value. This causes all sorts of
problems with large disks, and can also degrade performance.

And with 2.6, it's not necessary anymore, so we just go back to using
the specified wsize as s_blocksize


Index: linux-2.6.5/fs/nfs/inode.c
===================================================================
--- linux-2.6.5.orig/fs/nfs/inode.c	2004-04-30 10:49:55.000000000 +0200
+++ linux-2.6.5/fs/nfs/inode.c	2004-04-30 10:59:59.000000000 +0200
@@ -312,14 +312,6 @@
 		server->rsize = nfs_block_size(fsinfo.rtpref <= PAGE_SIZE ?fsinfo.rtpref:PAGE_SIZE, NULL);
 	if (server->wsize == 0)
 		server->wsize = nfs_block_size(fsinfo.wtpref <= PAGE_SIZE ?fsinfo.wtpref:PAGE_SIZE, NULL);
-	if (sb->s_blocksize == 0) {
-		if (fsinfo.wtmult == 0) {
-			sb->s_blocksize = 512;
-			sb->s_blocksize_bits = 9;
-		} else
-			sb->s_blocksize = nfs_block_bits(fsinfo.wtmult,
-							 &sb->s_blocksize_bits);
-	}
 
 	if (fsinfo.rtmax >= 512 && server->rsize > fsinfo.rtmax)
 		server->rsize = nfs_block_size(fsinfo.rtmax, NULL);
@@ -338,6 +330,10 @@
                 server->wsize = server->wpages << PAGE_CACHE_SHIFT;
 	}
 
+	if (sb->s_blocksize == 0)
+		sb->s_blocksize = nfs_block_bits(server->wsize,
+							 &sb->s_blocksize_bits);
+
 	server->dtsize = nfs_block_size(fsinfo.dtpref, NULL);
 	if (server->dtsize > PAGE_CACHE_SIZE)
 		server->dtsize = PAGE_CACHE_SIZE;
