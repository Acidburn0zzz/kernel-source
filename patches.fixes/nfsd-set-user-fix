From: J. Bruce Fields <bfields at citi.umich.edu>
Subject: Call nfsd_setuser on every fh_verify
Patch-mainline: no
References: 167552

As fh_verify can be called with a dentry already inplace (if created
by exp_pseudoroot) we need to call nfsd_setuser every time, not just
if the dentry is first being found.

 fs/nfsd/nfsfh.c |   14 +++++++-------
 1 files changed, 7 insertions(+), 7 deletions(-)

Signed-off-by: Neil Brown <neilb@suse.de>
Acked-by: 

--- a/fs/nfsd/nfsfh.c
+++ b/fs/nfsd/nfsfh.c
@@ -187,13 +187,6 @@ fh_verify(struct svc_rqst *rqstp, struct
 			goto out;
 		}
 
-		/* Set user creds for this exportpoint */
-		error = nfsd_setuser(rqstp, exp);
-		if (error) {
-			error = nfserrno(error);
-			goto out;
-		}
-
 		/*
 		 * Look up the dentry using the NFS file handle.
 		 */
@@ -250,6 +243,13 @@ #endif
 		exp = fhp->fh_export;
 	}
 	cache_get(&exp->h);
+
+	/* Set user creds for this exportpoint; necessary even in the "just
+	 * checking" case because this may be a filehandle that was created by
+	 * fh_compose, and that is about to be used in another nfsv4 compound
+	 * operation */
+	error = nfsd_setuser(rqstp, exp); if (error) { error = nfserrno(error);
+		goto out; }
 
 	error = nfsd_mode_check(rqstp, dentry->d_inode->i_mode, type);
 	if (error)

