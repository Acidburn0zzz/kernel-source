From: Matthew Garrett <mjg59@srcf.ucam.org>
Subject: [PATCH] - restore i8259A eoi status on resume
Patch-mainline: yes (2.6.19)
References: bug #212208 (fixes s2disk for acer ferrari 4000)

 arch/i386/kernel/i8259.c   |    6 +++++-
 arch/x86_64/kernel/i8259.c |    6 +++++-
 2 files changed, 10 insertions(+), 2 deletions(-)

Signed-off-by: Matthew Garrett <mjg59@srcf.ucam.org>
Signed-off-by: Andi Kleen <ak@suse.de>
Signed-off-by: Frank Seidel <fseidel@suse.de>

Index: linux-2.6.18/arch/i386/kernel/i8259.c
===================================================================
--- linux-2.6.18.orig/arch/i386/kernel/i8259.c
+++ linux-2.6.18/arch/i386/kernel/i8259.c
@@ -45,6 +45,8 @@ static void end_8259A_irq (unsigned int 
 
 #define shutdown_8259A_irq	disable_8259A_irq
 
+static int i8259A_auto_eoi;
+
 static void mask_and_ack_8259A(unsigned int);
 
 unsigned int startup_8259A_irq(unsigned int irq)
@@ -253,7 +255,7 @@ static void save_ELCR(char *trigger)
 
 static int i8259A_resume(struct sys_device *dev)
 {
-	init_8259A(0);
+	init_8259A(i8259A_auto_eoi);
 	restore_ELCR(irq_trigger);
 	return 0;
 }
@@ -301,6 +303,8 @@ void init_8259A(int auto_eoi)
 {
 	unsigned long flags;
 
+	i8259A_auto_eoi = auto_eoi;
+
 	spin_lock_irqsave(&i8259A_lock, flags);
 
 	outb(0xff, PIC_MASTER_IMR);	/* mask all of 8259A-1 */
Index: linux-2.6.18/arch/x86_64/kernel/i8259.c
===================================================================
--- linux-2.6.18.orig/arch/x86_64/kernel/i8259.c
+++ linux-2.6.18/arch/x86_64/kernel/i8259.c
@@ -128,6 +128,8 @@ void (*interrupt[NR_IRQS])(void) = {
 
 DEFINE_SPINLOCK(i8259A_lock);
 
+static int i8259A_auto_eoi;
+
 static void end_8259A_irq (unsigned int irq)
 {
 	if (irq > 256) { 
@@ -341,6 +343,8 @@ void init_8259A(int auto_eoi)
 {
 	unsigned long flags;
 
+	i8259A_auto_eoi = auto_eoi;
+
 	spin_lock_irqsave(&i8259A_lock, flags);
 
 	outb(0xff, 0x21);	/* mask all of 8259A-1 */
@@ -399,7 +403,7 @@ static void save_ELCR(char *trigger)
 
 static int i8259A_resume(struct sys_device *dev)
 {
-	init_8259A(0);
+	init_8259A(i8259A_auto_eoi);
 	restore_ELCR(irq_trigger);
 	return 0;
 }
