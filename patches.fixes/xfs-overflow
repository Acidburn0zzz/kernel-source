# Date: Thu, 27 May 2004 12:29:52 -0500
# From: Eric Sandeen <sandeen@penguin.americas.sgi.com>
# Subject: TAKE 915269 - Fix overflow at 8 Exabytes
# 
# Found this when running test 071 on 64-bit boxes.
# Those of you squeezing every last byte out of your
# 64-bit box can now safely write offsets of 2^63-1 :)
# 
# Fix overflow in mapping test at offsets of 2^63-1 bytes
# 
# 
# Date:  Thu May 27 10:28:34 PDT 2004
# Workarea:  penguin.americas.sgi.com:/src/eric/linux-2.4.x
# Inspected by:  nathans,felixb
# 
# The following file(s) were checked into:
#   bonnie.engr.sgi.com:/isms/linux/2.4.x-xfs
# 
# 	- When checking whether a mapping matches our offset,
# 	  test in such a way that it will not overflow 63 bits - 
# 	  calculate last offset in the mapping for comparison
diff -u xfs-linux/fs/xfs/linux/xfs_aops.c:1.71 xfs-linux/linux-2.6/xfs_aops.c:1.72
--- xfs-linux/fs/xfs/linux/xfs_aops.c:1.71	Mon May 24 23:31:11 2004
+++ xfs-linux/fs/xfs/linux/xfs_aops.c	Thu May 27 17:28:34 2004
@@ -217,7 +217,7 @@
 
 	if (full_offset < iomapp->iomap_offset)
 		return NULL;
-	if (iomapp->iomap_offset + iomapp->iomap_bsize > full_offset)
+	if (iomapp->iomap_offset + (iomapp->iomap_bsize -1) >= full_offset)
 		return iomapp;
 	return NULL;
 }
