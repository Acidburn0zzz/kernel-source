Bug 42619, make reiserfs and ext3 honor barrier=off kernel boot
parameter.  This prevents an oops for devices that don't handle the
barrier failures well, like multipathing.

The barrier=off kernel boot parameter only controls the reiserfs
and ext3 default mount options.  mounting -o barrier=flush for
reiserfs or -o barrier=1 for ext3 will still turn barriers on
at the filesystem level.  This would only be useful for scsi
drives that ignore the barrier=off global.

Index: linux-2.6.5/fs/ext3/super.c
===================================================================
--- linux-2.6.5.orig/fs/ext3/super.c
+++ linux-2.6.5/fs/ext3/super.c
@@ -1131,7 +1131,8 @@ static int ext3_fill_super (struct super
 	sbi->s_resgid = le16_to_cpu(es->s_def_resgid);
 
 	/* enable barriers by default */
-	set_opt(sbi->s_mount_opt, BARRIER);
+	if (!flush_barriers_disabled())
+		set_opt(sbi->s_mount_opt, BARRIER);
 
 	if (!parse_options ((char *) data, sbi, &journal_inum, 0))
 		goto failed_mount;
Index: linux-2.6.5/fs/reiserfs/super.c
===================================================================
--- linux-2.6.5.orig/fs/reiserfs/super.c
+++ linux-2.6.5/fs/reiserfs/super.c
@@ -1487,7 +1487,7 @@ static int reiserfs_fill_super (struct s
     }
     /* make barrer=flush the default */
 
-    if (!reiserfs_barrier_none(s))
+    if (!reiserfs_barrier_none(s) && !flush_barriers_disabled())
 	REISERFS_SB(s)->s_mount_opt |= (1 << REISERFS_BARRIER_FLUSH);
     if (reiserfs_barrier_flush(s))
     	printk("reiserfs: using flush barriers\n");
Index: linux-2.6.5/include/linux/blkdev.h
===================================================================
--- linux-2.6.5.orig/include/linux/blkdev.h
+++ linux-2.6.5/include/linux/blkdev.h
@@ -746,4 +746,6 @@ typedef enum {
 
 extern barrier_mode_t chosen_barrier_mode;
 
+extern int flush_barriers_disabled(void);
+
 #endif
Index: linux-2.6.5/drivers/block/ll_rw_blk.c
===================================================================
--- linux-2.6.5.orig/drivers/block/ll_rw_blk.c
+++ linux-2.6.5/drivers/block/ll_rw_blk.c
@@ -3310,3 +3310,9 @@ static int __init barrier_setup (char *s
 	return 1;
 }
 __setup ("barrier=", barrier_setup);
+
+/* returns true if ide barriers are globally disabled */
+int flush_barriers_disabled(void) {
+	return chosen_barrier_mode == barrier_off;
+}
+EXPORT_SYMBOL(flush_barriers_disabled);
