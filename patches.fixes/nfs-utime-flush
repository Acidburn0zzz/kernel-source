From: Trond Myklebust <Trond.Myklebust@netapp.com>
Subject: NFS: writes should not clobber utimes() calls
References: 149807
Patch-mainline: yes

Ensure that we flush out writes in the case when someone calls utimes() in
order to set the file times.

Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
Acked-by: Olaf Kirch <okir@suse.de>
 fs/nfs/inode.c |    8 +++-----
 1 files changed, 3 insertions(+), 5 deletions(-)

Index: build/fs/nfs/inode.c
===================================================================
--- build.orig/fs/nfs/inode.c
+++ build/fs/nfs/inode.c
@@ -862,11 +862,9 @@ nfs_setattr(struct dentry *dentry, struc
 
 	lock_kernel();
 	nfs_begin_data_update(inode);
-	/* Write all dirty data if we're changing file permissions or size */
-	if ((attr->ia_valid & (ATTR_MODE|ATTR_UID|ATTR_GID|ATTR_SIZE)) != 0) {
-		filemap_write_and_wait(inode->i_mapping);
-		nfs_wb_all(inode);
-	}
+	/* Write all dirty data */
+	filemap_write_and_wait(inode->i_mapping);
+	nfs_wb_all(inode);
 	/*
 	 * Return any delegations if we're going to change ACLs
 	 */
