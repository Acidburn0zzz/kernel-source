From: Neil Brown <neilb@suse.de>
Subject: Make sure QUEUE_FLAG_CLUSTER is set properly for dm.
Patch-mainline: yes
References: 90365

This flag should be set for a virtual device iff it is set
for all underlying devices.

Signed-off-by: Neil Brown <neilb@suse.de>

### Diffstat output
 ./drivers/md/dm-table.c         |    9 +++++++++
 ./include/linux/device-mapper.h |    1 +
 2 files changed, 10 insertions(+)

Acked-by: 

Index: linux-2.6.15/drivers/md/dm-table.c
===================================================================
--- linux-2.6.15.orig/drivers/md/dm-table.c	2006-02-09 17:04:39.000000000 +1100
+++ linux-2.6.15/drivers/md/dm-table.c	2006-02-09 17:07:56.000000000 +1100
@@ -97,6 +97,8 @@
 
 	lhs->seg_boundary_mask =
 		min_not_zero(lhs->seg_boundary_mask, rhs->seg_boundary_mask);
+
+	lhs->no_cluster |= rhs->no_cluster;
 }
 
 /*
@@ -525,6 +527,8 @@
 		rs->seg_boundary_mask =
 			min_not_zero(rs->seg_boundary_mask,
 				     q->seg_boundary_mask);
+
+		rs->no_cluster |= !test_bit(QUEUE_FLAG_CLUSTER, &q->queue_flags);
 	}
 
 	return r;
@@ -834,6 +838,11 @@
 	q->hardsect_size = t->limits.hardsect_size;
 	q->max_segment_size = t->limits.max_segment_size;
 	q->seg_boundary_mask = t->limits.seg_boundary_mask;
+	if (t->limits.no_cluster)
+		q->queue_flags &= ~(1 << QUEUE_FLAG_CLUSTER);
+	else
+		q->queue_flags |= (1 << QUEUE_FLAG_CLUSTER);
+
 }
 
 unsigned int dm_table_get_num_targets(struct dm_table *t)
Index: linux-2.6.15/include/linux/device-mapper.h
===================================================================
--- linux-2.6.15.orig/include/linux/device-mapper.h	2006-02-09 17:04:45.000000000 +1100
+++ linux-2.6.15/include/linux/device-mapper.h	2006-02-09 17:07:56.000000000 +1100
@@ -97,6 +97,7 @@
 	unsigned short		hardsect_size;
 	unsigned int		max_segment_size;
 	unsigned long		seg_boundary_mask;
+	unsigned char		no_cluster; /* inverted so that 0 is default */
 };
 
 struct dm_target {
