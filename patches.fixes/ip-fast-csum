
This patch fixes a mis-compilation that happens with gcc 3.2.2.
In ip_fragment(), gcc will inline ip_send_check:

	iph->check = 0;
	iph->check = ip_fast_csum((unsigned char *) iph, iph->ihl);

In some situations, gcc will optimize iph->check = -1; away and
create incorrect code.

--- linux-2.6.0-test8/include/asm-i386/checksum.h	2003-10-17 23:43:24.000000000 +0200
+++ new/include/asm-i386/checksum.h	2003-10-23 14:53:21.000000000 +0200
@@ -83,7 +83,8 @@
 	   are modified, we must also specify them as outputs, or gcc
 	   will assume they contain their original values. */
 	: "=r" (sum), "=r" (iph), "=r" (ihl)
-	: "1" (iph), "2" (ihl));
+	: "1" (iph), "2" (ihl)
+	: "memory");
 	return(sum);
 }
 
--- linux-2.6.0-test8/include/asm-x86_64/checksum.h	2003-10-17 23:43:21.000000000 +0200
+++ new/include/asm-x86_64/checksum.h	2003-10-23 14:53:33.000000000 +0200
@@ -68,7 +68,8 @@
 	   are modified, we must also specify them as outputs, or gcc
 	   will assume they contain their original values. */
 	: "=r" (sum), "=r" (iph), "=r" (ihl)
-	: "1" (iph), "2" (ihl));
+	: "1" (iph), "2" (ihl)
+	: "memory");
 	return(sum);
 }
 
