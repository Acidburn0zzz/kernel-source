From: Jens Axboe <axboe@suse.de>
Subject: Add hdX=noflush for buggy hard drives
Patch-mainline: 
References: 66590

See subj

Acked-by: 
Signed-off-by: 

--- linux-2.6.11/drivers/ide/ide.c~	2005-03-15 12:25:37.000000000 +0100
+++ linux-2.6.11/drivers/ide/ide.c	2005-03-15 12:26:01.000000000 +0100
@@ -1759,7 +1759,7 @@
 		const char *hd_words[] = {
 			"none", "noprobe", "nowerr", "cdrom", "serialize",
 			"autotune", "noautotune", "minus8", "swapdata", "bswap",
-			"minus11", "remap", "remap63", "scsi", NULL };
+			"noflush", "remap", "remap63", "scsi", NULL };
 		unit = s[2] - 'a';
 		hw   = unit / MAX_DRIVES;
 		unit = unit % MAX_DRIVES;
@@ -1796,6 +1796,9 @@
 			case -10: /* "bswap" */
 				drive->bswap = 1;
 				goto done;
+			case -11: /* "noflush" */
+				drive->noflush = 1;
+				goto done;
 			case -12: /* "remap" */
 				drive->remap_0_to_1 = 1;
 				goto done;
--- linux-2.6.11/drivers/ide/ide-disk.c~	2005-03-15 12:26:38.000000000 +0100
+++ linux-2.6.11/drivers/ide/ide-disk.c	2005-03-15 12:27:01.000000000 +0100
@@ -1139,7 +1139,7 @@
 	 * LBA48 is not available so we don't need to recheck that.
 	 */
 	barrier = 0;
-	if (ide_id_has_flush_cache(id))
+	if (ide_id_has_flush_cache(id) && !drive->noflush)
 		barrier = 1;
 	if (drive->addressing == 1) {
 		/* Can't issue the correct flush ? */
--- linux-2.6.11/include/linux/ide.h~	2005-03-15 12:26:07.000000000 +0100
+++ linux-2.6.11/include/linux/ide.h	2005-03-15 12:26:30.000000000 +0100
@@ -689,6 +689,7 @@
 	u8	waiting_for_dma;	/* dma currently in progress */
 	u8	unmask;			/* okay to unmask other irqs */
 	u8	bswap;			/* byte swap data */
+	u8	noflush;		/* don't attempt flushes */
 	u8	dsc_overlap;		/* DSC overlap */
 	u8	nice1;			/* give potential excess bandwidth */
 
