From: Jens Axboe <axboe@suse.de>
Subject: Add hdX=noflush for buggy hard drives
Patch-mainline: 2.6.18-rc3
References: 66590

See subj

Acked-by: 
Signed-off-by: 

--- linux-2.6.15/drivers/ide/ide.c~	2006-01-23 13:14:42.000000000 +0100
+++ linux-2.6.15/drivers/ide/ide.c	2006-01-23 13:15:28.000000000 +0100
@@ -1547,7 +1547,7 @@
 		const char *hd_words[] = {
 			"none", "noprobe", "nowerr", "cdrom", "serialize",
 			"autotune", "noautotune", "minus8", "swapdata", "bswap",
-			"minus11", "remap", "remap63", "scsi", NULL };
+			"noflush", "remap", "remap63", "scsi", NULL };
 		unit = s[2] - 'a';
 		hw   = unit / MAX_DRIVES;
 		unit = unit % MAX_DRIVES;
@@ -1586,6 +1586,9 @@
 			case -10: /* "bswap" */
 				drive->bswap = 1;
 				goto done;
+			case -11: /* noflush */
+				drive->noflush = 1;
+				goto done;
 			case -12: /* "remap" */
 				drive->remap_0_to_1 = 1;
 				goto done;
--- linux-2.6.15/drivers/ide/ide-disk.c~	2006-01-23 13:14:49.000000000 +0100
+++ linux-2.6.15/drivers/ide/ide-disk.c	2006-01-23 13:15:56.000000000 +0100
@@ -771,7 +771,7 @@
 		 * not available so we don't need to recheck that.
 		 */
 		capacity = idedisk_capacity(drive);
-		barrier = ide_id_has_flush_cache(id) &&
+		barrier = ide_id_has_flush_cache(id) && !drive->noflush &&
 			(drive->addressing == 0 || capacity <= (1ULL << 28) ||
 			 ide_id_has_flush_cache_ext(id));
 
--- linux-2.6.15/include/linux/ide.h~	2006-01-23 13:14:54.000000000 +0100
+++ linux-2.6.15/include/linux/ide.h	2006-01-23 13:16:10.000000000 +0100
@@ -573,6 +573,7 @@
 	u8	waiting_for_dma;	/* dma currently in progress */
 	u8	unmask;			/* okay to unmask other irqs */
 	u8	bswap;			/* byte swap data */
+	u8	noflush;		/* don't attempt flushes */
 	u8	dsc_overlap;		/* DSC overlap */
 	u8	nice1;			/* give potential excess bandwidth */
 
