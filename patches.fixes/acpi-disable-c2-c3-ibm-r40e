From: Thomas Rosner <kernel-bugs@digital-trauma.de>
Subject: Disable C2/C3 states on all IBM R40e BIOSes
References: 129954
Patch-mainline: not yet

This adds all known BIOS versions of IBM R40e Laptops to the C2/C3
processor state blacklist and thus prevents them from crashing.
This fixes kernel.org Bug #3549.

Implementation is probably overly verbose, but DMI_MATCH seems to give us
no choice.

Signed-off-by: Thomas Rosner <kernel-bugs@digital-trauma.de>
Cc: <linux-acpi@intel.com>
Cc: "Brown, Len" <len.brown@intel.com>
Cc: Dave Jones <davej@redhat.com>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Acked-by: trenn@suse.de

Index: linux-2.6.15/drivers/acpi/processor_idle.c
===================================================================
--- linux-2.6.15.orig/drivers/acpi/processor_idle.c
+++ linux-2.6.15/drivers/acpi/processor_idle.c
@@ -95,23 +95,110 @@ static int set_max_cstate(struct dmi_sys
 }
 
 static struct dmi_system_id __cpuinitdata processor_power_dmi_table[] = {
-	{set_max_cstate, "IBM ThinkPad R40e", {
-					       DMI_MATCH(DMI_BIOS_VENDOR,
-							 "IBM"),
-					       DMI_MATCH(DMI_BIOS_VERSION,
-							 "1SET60WW")},
-	 (void *)1},
-	{set_max_cstate, "Medion 41700", {
-					  DMI_MATCH(DMI_BIOS_VENDOR,
-						    "Phoenix Technologies LTD"),
-					  DMI_MATCH(DMI_BIOS_VERSION,
-						    "R01-A1J")}, (void *)1},
-	{set_max_cstate, "Clevo 5600D", {
-					 DMI_MATCH(DMI_BIOS_VENDOR,
-						   "Phoenix Technologies LTD"),
-					 DMI_MATCH(DMI_BIOS_VERSION,
-						   "SHE845M0.86C.0013.D.0302131307")},
-	 (void *)2},
+      /* The known versions of IBM R40e BIOS */
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET32WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET43WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET45WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET47WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET50WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET52WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET55WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET56WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET59WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET60WW")},
+        (void *)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET61WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET62WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET64WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET65WW") },
+        (void*)1},
+      {set_max_cstate, "IBM ThinkPad R40e", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "IBM"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "1SET68WW") },
+        (void*)1},
+      /* Other laptops, same problem */
+      {set_max_cstate, "Medion 41700", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "Phoenix Technologies LTD"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "R01-A1J")},
+        (void *)1},
+      {set_max_cstate, "Clevo 5600D", {
+        DMI_MATCH(DMI_BIOS_VENDOR,
+   	 "Phoenix Technologies LTD"),
+        DMI_MATCH(DMI_BIOS_VERSION,
+   	 "SHE845M0.86C.0013.D.0302131307")},
+        (void *)2},
 	{},
 };
 
