From: Hannes Reinecke
Subject: SATA ATAPI AHCI generates error messages when drive is empty
Patch-Mainline: yes
References: 156878

SATA ATAPI drives connected to an ahci HBA throw lots of error like

ata2: translated ATA stat/err 0x51/24 to SCSI SK/ASC/ASCQ 0xb/00/00
ata2: translated ATA stat/err 0x51/24 to SCSI SK/ASC/ASCQ 0xb/00/00

The ahci driver tries to determine the reason for an error, but never
passes this information back. Hence the sense code for ATAPI drives is
not requested and libata tries to make do with the available
information.

This patch fixes the ahci driver to pass the correct error status
information.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/ahci.c b/drivers/scsi/ahci.c
index a800fb5..0459970 100644
--- a/drivers/scsi/ahci.c
+++ b/drivers/scsi/ahci.c
@@ -697,7 +697,7 @@ static inline int ahci_host_intr(struct 
 		ahci_restart_port(ap, status);
 
 		if (qc) {
-			qc->err_mask |= AC_ERR_OTHER;
+			qc->err_mask |= err_mask;
 			ata_qc_complete(qc);
 		}
 	}
