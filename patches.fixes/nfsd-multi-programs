Status: ok
From: NeilBrown <neilb@suse.de>
Subject: Make sure svc_process call the correct pg_authenticate for multi-service port
Patch-mainline: pending
References: 128784



If an RPC socket is serving multiple programs, then the
pg_authenticate of the first program in the list is called,
instead of pg_authenticate for the program to be run.

This does not cause a problem with any programs in the current kernel,
but could confuse future code.

Also set pg_authenticate for nfsd_acl_program incase it ever gets used.


Signed-off-by: Neil Brown <neilb@suse.de>

### Diffstat output
 ./fs/nfsd/nfssvc.c |    1 +
 ./net/sunrpc/svc.c |   12 +++++++-----
 2 files changed, 8 insertions(+), 5 deletions(-)


Index: linux-2.6.13/fs/nfsd/nfssvc.c
===================================================================
--- linux-2.6.13.orig/fs/nfsd/nfssvc.c	2005-08-29 09:41:01.000000000 +1000
+++ linux-2.6.13/fs/nfsd/nfssvc.c	2005-10-20 17:21:03.000000000 +1000
@@ -379,6 +379,7 @@
 	.pg_name		= "nfsd",
 	.pg_class		= "nfsd",
 	.pg_stats		= &nfsd_acl_svcstats,
+	.pg_authenticate	= &svc_set_client,
 };
 
 static struct svc_stat	nfsd_acl_svcstats = {
Index: linux-2.6.13/net/sunrpc/svc.c
===================================================================
--- linux-2.6.13.orig/net/sunrpc/svc.c	2005-08-29 09:41:01.000000000 +1000
+++ linux-2.6.13/net/sunrpc/svc.c	2005-10-20 17:21:03.000000000 +1000
@@ -313,6 +313,11 @@
 	rqstp->rq_proc = proc = ntohl(svc_getu32(argv));	/* procedure number */
 
 	progp = serv->sv_program;
+
+	for (progp = serv->sv_program; progp; progp = progp->pg_next)
+		if (prog == progp->pg_prog)
+			break;
+
 	/*
 	 * Decode auth data, and add verifier to reply buffer.
 	 * We do this before anything else in order to get a decent
@@ -320,7 +325,7 @@
 	 */
 	auth_res = svc_authenticate(rqstp, &auth_stat);
 	/* Also give the program a chance to reject this call: */
-	if (auth_res == SVC_OK) {
+	if (auth_res == SVC_OK && progp) {
 		auth_stat = rpc_autherr_badcred;
 		auth_res = progp->pg_authenticate(rqstp);
 	}
@@ -340,10 +345,7 @@
 	case SVC_COMPLETE:
 		goto sendit;
 	}
-		
-	for (progp = serv->sv_program; progp; progp = progp->pg_next)
-		if (prog == progp->pg_prog)
-			break;
+
 	if (progp == NULL)
 		goto err_bad_prog;
 
