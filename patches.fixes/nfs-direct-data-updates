Index: linux-2.6.5/fs/nfs/direct.c
===================================================================
--- linux-2.6.5.orig/fs/nfs/direct.c	2004-05-17 19:41:42.000000000 +0200
+++ linux-2.6.5/fs/nfs/direct.c	2004-05-17 19:44:14.000000000 +0200
@@ -252,6 +252,7 @@
 	size_t request;
 	int need_commit;
 	int tot_bytes;
+	int result;
 	int curpage;
 	struct nfs_writeverf first_verf;
 	struct nfs_write_data	wdata = {
@@ -278,8 +279,6 @@
 	wdata.args.pgbase = user_addr & ~PAGE_MASK;
 	wdata.args.offset = file_offset;
         do {
-		int result;
-
 		wdata.args.count = request;
                 if (wdata.args.count > wsize)
                         wdata.args.count = wsize;
@@ -296,7 +295,7 @@
 		if (result <= 0) {
 			if (tot_bytes > 0)
 				break;
-			return result;
+			goto out;
 		}
 
 		if (tot_bytes == 0)
@@ -335,10 +334,13 @@
 						VERF_SIZE) != 0)
 			goto sync_retry;
 	}
+
+	result = tot_bytes;
+
+out:
 	nfs_end_data_update(inode);
 	NFS_FLAGS(inode) |= NFS_INO_INVALID_DATA;
-
-	return tot_bytes;
+	return result;
 
 sync_retry:
 	wdata.args.stable = NFS_FILE_SYNC;
