diff -urNp linux-2.6.5/mm/fremap.c linux-2.6.5.SUSE/mm/fremap.c
--- linux-2.6.5/mm/fremap.c	2004-04-13 17:25:51.000000000 +0200
+++ linux-2.6.5.SUSE/mm/fremap.c	2004-04-13 17:26:02.000000000 +0200
@@ -153,8 +153,12 @@ asmlinkage long sys_remap_file_pages(uns
 	unsigned long linear_pgoff;
 	unsigned long end = start + size;
 	struct vm_area_struct *vma;
-	int err = -EINVAL;
+	int err;
 
+	err = -EPERM;
+	if (!can_do_mlock())
+		return err;
+	err = -EINVAL;
 	if (__prot)
 		return err;
 	/*
