From: mls@suse.de, okir@suse.de
Subject: [NFS] Drop inode after rename
References: 76854
Patch-mainline: submitted 2005-07-11

When doing a rename on a NFSv2 mount on top of an existing file, the
inode of the overwritten file would remain, with all caches intact. If
a subsequently created file ended up with the same inode number and file
handle (which is what unfsd does), it would pick up the stale cache.

Lengthy analysis in the bug report if you care :)

Signed-off-by: okir@suse.de


Index: linux-2.6.14/fs/nfs/dir.c
===================================================================
--- linux-2.6.14.orig/fs/nfs/dir.c
+++ linux-2.6.14/fs/nfs/dir.c
@@ -1550,8 +1550,13 @@ go_ahead:
 		shrink_dcache_parent(old_dentry);
 	}
 
-	if (new_inode)
+	if (new_inode) {
+		/* If this is the last reference to the inode make
+		 * sure the VFS zaps it and all associated caches.
+		 */
+		new_inode->i_nlink--;
 		d_delete(new_dentry);
+	}
 
 	nfs_begin_data_update(old_dir);
 	nfs_begin_data_update(new_dir);
