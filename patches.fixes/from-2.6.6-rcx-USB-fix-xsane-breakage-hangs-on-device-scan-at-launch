#date: 2004-04-07
#id: 1.1371.662.6
#tag: usb
#time: 16:52:02
#title: USB: fix xsane breakage, hangs on device scan at launch
#who: david-b@pacbell.net
#
# ChangeSet
#   1.1371.662.6 04/04/07 16:52:02 david-b@pacbell.net +1 -0
#   [PATCH] USB: fix xsane breakage, hangs on device scan at launch
#   
#   Disable a usbfs disconnect() synchronization hack, which recently
#   started deadlocking because this routine is now called in a different
#   context.
#   
#   It shouldn't be needed any longer now that usbcore shuts down endpoints
#   as part of driver unbinding.  (Except maybe on UHCI, which will have
#   canceled but not necessarily completed all requests.)
#
# drivers/usb/core/devio.c +4 -5
#
diff -Nru a/drivers/usb/core/devio.c b/drivers/usb/core/devio.c
--- a/drivers/usb/core/devio.c	Wed Apr 28 00:17:51 2004
+++ b/drivers/usb/core/devio.c	Wed Apr 28 00:17:51 2004
@@ -339,18 +339,17 @@
 	if (!ps)
 		return;
 
-	/* this waits till synchronous requests complete */
-	down_write (&ps->devsem);
+	/* NOTE:  this relies on usbcore having canceled and completed
+	 * all pending I/O requests; 2.6 does that.
+	 */
 
 	/* prevent new I/O requests */
 	ps->dev = 0;
-	ps->ifclaimed = 0;
+	clear_bit(intf->cur_altsetting->desc.bInterfaceNumber, &ps->ifclaimed);
 	usb_set_intfdata (intf, NULL);
 
 	/* force async requests to complete */
 	destroy_all_async (ps);
-
-	up_write (&ps->devsem);
 }
 
 struct usb_driver usbdevfs_driver = {
