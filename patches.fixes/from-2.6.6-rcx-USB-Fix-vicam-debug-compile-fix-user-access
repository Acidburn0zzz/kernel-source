#date: 2004-04-15
#id: 1.1371.1.433
#tag: usb
#time: 10:29:23
#title: USB: Fix vicam debug compile, fix user access
#who: xschmi00@stud.feec.vutbr.cz[torvalds]
#
# ChangeSet
#   1.1371.1.433 04/04/15 10:29:23 xschmi00@stud.feec.vutbr.cz[torvalds] +1 -0
#   [PATCH] USB: Fix vicam debug compile, fix user access
#   
#   The last copy_from_user patch to the vicam driver broke compilation with
#   VICAM_DEBUG on.
#   
#   There is also another copy_from_user missing in case VIDIOCSPICT. 
#   
#   This fixes both issues.
#
# drivers/usb/media/vicam.c +13 -8
# arch/ppc64/configs/g5_defconfig +18 -8
#   ppc64: update g5_defconfig
#
diff -Nru a/drivers/usb/media/vicam.c b/drivers/usb/media/vicam.c
--- a/drivers/usb/media/vicam.c	Wed Apr 28 00:50:43 2004
+++ b/drivers/usb/media/vicam.c	Wed Apr 28 00:50:43 2004
@@ -612,15 +612,20 @@
 
 	case VIDIOCSPICT:
 		{
-			struct video_picture *vp = (struct video_picture *) arg;
-
-			DBG("VIDIOCSPICT depth = %d, pal = %d\n", vp->depth,
-			    vp->palette);
+			struct video_picture vp;
+			
+			if (copy_from_user(&vp, arg, sizeof(vp))) {
+				retval = -EFAULT;
+				break;
+			}
+			
+			DBG("VIDIOCSPICT depth = %d, pal = %d\n", vp.depth,
+			    vp.palette);
 
-			cam->gain = vp->brightness >> 8;
+			cam->gain = vp.brightness >> 8;
 
-			if (vp->depth != 24
-			    || vp->palette != VIDEO_PALETTE_RGB24)
+			if (vp.depth != 24
+			    || vp.palette != VIDEO_PALETTE_RGB24)
 				retval = -EINVAL;
 
 			break;
@@ -660,7 +665,7 @@
 				break;
 			}
 
-			DBG("VIDIOCSWIN %d x %d\n", vw->width, vw->height);
+			DBG("VIDIOCSWIN %d x %d\n", vw.width, vw.height);
 			
 			if ( vw.width != 320 || vw.height != 240 )
 				retval = -EFAULT;
