----- Forwarded message from Santiago Leon <santil@us.ibm.com> -----

Date: Wed, 07 Apr 2004 11:31:08 -0500
From: Santiago Leon <santil@us.ibm.com>
User-Agent: Mozilla/5.0 (Windows; U; WinNT4.0; en-US; rv:1.6) Gecko/20040113
To: olaf@suse.de
Subject: vscsi deadlock fix

Here you go... please apply...

Thanks,
-- 
Santiago A. Leon
Power Linux Development
IBM Linux Technology Center

===== drivers/scsi/ibmvscsi/rpa_vscsi.c 1.17 vs 1.18 =====
--- 1.17/drivers/scsi/ibmvscsi/rpa_vscsi.c	Wed Mar 31 23:11:35 2004
+++ 1.18/drivers/scsi/ibmvscsi/rpa_vscsi.c	Wed Apr  7 10:24:36 2004
@@ -34,6 +34,9 @@
 #include <linux/interrupt.h>
 #include "ibmvscsi.h"
 
+/* We don't need one workqueue per host, one is enough for all of them */
+static struct workqueue_struct *vscsi_wq = NULL;
+
 /* ------------------------------------------------------------
  * Routines for managing the command/response queue
  */
@@ -53,7 +56,7 @@
 	struct ibmvscsi_host_data *hostdata =
 	    (struct ibmvscsi_host_data *)dev_instance;
 	vio_disable_interrupts(to_vio_dev(hostdata->dev));
-	schedule_work(&hostdata->srp_task);
+	queue_work(vscsi_wq, &hostdata->srp_task);
 	return IRQ_HANDLED;
 }
 
@@ -273,12 +276,16 @@
 
 int __init ibmvscsi_module_init(void)
 {
+	vscsi_wq = create_workqueue("vscsi-ev");
+	if (!vscsi_wq)
+		return -ENOMEM;
 	return vio_register_driver(&ibmvscsi_driver);
 }
 
 void __exit ibmvscsi_module_exit(void)
 {
 	vio_unregister_driver(&ibmvscsi_driver);
+	destroy_workqueue(vscsi_wq);
 }
 
 module_init(ibmvscsi_module_init);


----- End forwarded message -----
