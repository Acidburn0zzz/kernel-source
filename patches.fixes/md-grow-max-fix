Status: ok
From: Doug Ledford <dledford@redhat.com>
Subject: Fix md grow/size code to correctly find the maximum available space.
Patch-mainline: 2.6.17-rc1
References: none


An md array can be asked to change the amount of each device that it
is using, and in particular can be asked to use the maximum available
space.  This currently only works if the first device is not larger
than the rest.  As 'size' gets changed and so 'fit' becomes wrong.
So check if a 'fit' is required early and don't corrupt it.

Signed-off-by: Doug Ledford <dledford@redhat.com>
Signed-off-by: Neil Brown <neilb@suse.de>

diff ./drivers/md/md.c~current~ ./drivers/md/md.c
Index: linux-2.6.16/drivers/md/md.c
===================================================================
--- linux-2.6.16.orig/drivers/md/md.c	2006-03-28 09:52:33.000000000 +1100
+++ linux-2.6.16/drivers/md/md.c	2006-03-28 10:12:09.000000000 +1100
@@ -3438,6 +3438,7 @@
 	mdk_rdev_t * rdev;
 	int rv;
 	struct list_head *tmp;
+	int fit = (size == 0);
 
 	if (mddev->pers->resize == NULL)
 		return -EINVAL;
@@ -3455,7 +3456,6 @@
 		return -EBUSY;
 	ITERATE_RDEV(mddev,rdev,tmp) {
 		sector_t avail;
-		int fit = (size == 0);
 		if (rdev->sb_offset > rdev->data_offset)
 			avail = (rdev->sb_offset*2) - rdev->data_offset;
 		else
