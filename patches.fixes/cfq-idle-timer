From: Jens Axboe <axboe@suse.de>
Subject: Fix race in idle timer setup
Patch-mainline: 
References: 178499

There's a small race with cfq_set_active_queue() and the timer readding
itself, from when the timer has fired and until we grab the queue
lock and readd it. Fix this by just using mod_timer, that will do the
right thing for us.

Acked-by: 
Signed-off-by: 

--- linux-2.6.16/block/cfq-iosched.c~	2006-06-01 09:54:16.000000000 +0200
+++ linux-2.6.16/block/cfq-iosched.c	2006-06-01 09:55:14.000000000 +0200
@@ -2196,10 +2196,9 @@
 	 * race with a non-idle queue, reset timer
 	 */
 	end = cfqd->last_end_request + CFQ_IDLE_GRACE;
-	if (!time_after_eq(jiffies, end)) {
-		cfqd->idle_class_timer.expires = end;
-		add_timer(&cfqd->idle_class_timer);
-	} else
+	if (!time_after_eq(jiffies, end))
+		mod_timer(&cfqd->idle_class_timer, end);
+	else
 		cfq_schedule_dispatch(cfqd);
 
 	spin_unlock_irqrestore(cfqd->queue->queue_lock, flags);
