From: Andrea Arcangeli <andrea@suse.de>
Subject: avoid -ENOMEM due reclaimable slab caches
Patch-mainline: no
References: 65526

This makes sure that reclaimable buffer headers and reclaimable inodes
are accounted properly during the overcommit checks.

Signed-off-by: Andrea Arcangeli <andrea@suse.de>

--- x/fs/inode.c.orig	2005-04-27 16:35:57.000000000 +0200
+++ x/fs/inode.c	2005-05-04 03:31:57.000000000 +0200
@@ -1336,7 +1336,7 @@ void __init inode_init(unsigned long mem
 
 	/* inode slab cache */
 	inode_cachep = kmem_cache_create("inode_cache", sizeof(struct inode),
-				0, SLAB_PANIC, init_once, NULL);
+				0, SLAB_RECLAIM_ACCOUNT|SLAB_PANIC, init_once, NULL);
 	set_shrinker(DEFAULT_SEEKS, shrink_icache_memory);
 
 	/* Hash may have been set up in inode_init_early */
--- x/fs/buffer.c.orig	2005-04-27 16:35:56.000000000 +0200
+++ x/fs/buffer.c	2005-05-04 03:32:17.000000000 +0200
@@ -3115,7 +3115,7 @@ void __init buffer_init(void)
 
 	bh_cachep = kmem_cache_create("buffer_head",
 			sizeof(struct buffer_head), 0,
-			SLAB_PANIC, init_buffer_head, NULL);
+			SLAB_RECLAIM_ACCOUNT|SLAB_PANIC, init_buffer_head, NULL);
 
 	/*
 	 * Limit the bh occupancy to 10% of ZONE_NORMAL
