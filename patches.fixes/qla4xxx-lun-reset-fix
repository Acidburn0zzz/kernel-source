From: Vikas Chaudary <vikas.chaudary@qlogic.com>
Subject: qla4xxx: bus reset causes system hard crash
References: bnc#548251

Whenever a LUN reset is sent to a device which is not active
the system crashes. So to avoid this we should wait for
for device to come online before lun reset, and
avoid sending LUN reset if device/LUN is not online.

Acked-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/qla4xxx/ql4_def.h b/drivers/scsi/qla4xxx/ql4_def.h
index af34744..eb9f5ff 100644
--- a/drivers/scsi/qla4xxx/ql4_def.h
+++ b/drivers/scsi/qla4xxx/ql4_def.h
@@ -350,6 +350,7 @@
 #define ISP_SEM_WAIT_TOV		10
 
 #define MAX_RESET_HA_RETRIES		2
+#define DEVICE_ONLINE_TOV		10
 
 /*---------------------------------------------------------------------------*/
 /*
diff --git a/drivers/scsi/qla4xxx/ql4_mbx.c b/drivers/scsi/qla4xxx/ql4_mbx.c
index f454a5a..bfb8d40 100644
--- a/drivers/scsi/qla4xxx/ql4_mbx.c
+++ b/drivers/scsi/qla4xxx/ql4_mbx.c
@@ -1223,6 +1223,7 @@ qla4xxx_reset_lun(scsi_qla_host_t *ha,
 {
 	uint32_t mbox_cmd[MBOX_REG_COUNT];
 	uint32_t mbox_sts[MBOX_REG_COUNT];
+	unsigned long wait_online;
 	uint8_t target = ddb_entry->target;
 	uint8_t lun = lun_entry->lun;
 	uint8_t status = QLA_SUCCESS;
@@ -1235,6 +1236,26 @@ qla4xxx_reset_lun(scsi_qla_host_t *ha,
 			      ha->host_no, ddb_entry->bus, target, lun));
 
 	/*
+	* If device is not online wait for 10 sec for device to come online.
+	* else return error
+	*/
+	if(atomic_read(&ddb_entry->state) != DEV_STATE_ONLINE)
+	{
+		wait_online = jiffies + (DEVICE_ONLINE_TOV * HZ);
+		while (time_before(jiffies, wait_online)) {
+			set_current_state(TASK_UNINTERRUPTIBLE);
+			schedule_timeout(HZ);
+		if (atomic_read(&ddb_entry->state) == DEV_STATE_ONLINE)
+			break;
+		}
+
+		if (atomic_read(&ddb_entry->state) != DEV_STATE_ONLINE)
+		{
+			return QLA_ERROR;
+		}
+	}
+
+	/*
 	 * Send lun reset command to ISP, so that the ISP will return all
 	 * outstanding requests with RESET status
 	 */
