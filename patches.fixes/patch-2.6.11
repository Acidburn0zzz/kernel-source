From: olh@suse.de
Subject: patch-2.6.11

diff -purN linux-2.6.11-rc5-bk4/CREDITS linux-2.6.11/CREDITS
--- linux-2.6.11-rc5-bk4/CREDITS	2005-02-24 05:03:07.000000000 +0100
+++ linux-2.6.11/CREDITS	2005-03-02 08:38:13.000000000 +0100
@@ -805,6 +805,21 @@ S: One Dell Way
 S: Round Rock, TX  78682
 S: USA
 
+N: Ben Dooks
+E: ben-linux@fluff.org
+E: ben@simtec.co.uk
+W: http://www.fluff.org/ben/
+W: http://www.simtec.co.uk/
+D: Samsung S3C2410/S3C2440 support, general ARM support
+D: Maintaining Simtec Electronics development boards
+S: Simtec Electronics
+S: Avondale Drive
+S: Tarleton
+S: Preston
+S: Lancs
+S: PR4 6AX
+S: United Kingdom
+
 N: John G Dorsey
 E: john+@cs.cmu.edu
 D: ARM Linux ports to Assabet/Neponset, Spot
diff -purN linux-2.6.11-rc5-bk4/Makefile linux-2.6.11/Makefile
--- linux-2.6.11-rc5-bk4/Makefile	2005-03-02 10:04:07.286556579 +0100
+++ linux-2.6.11/Makefile	2005-03-02 08:38:13.000000000 +0100
@@ -1,7 +1,7 @@
 VERSION = 2
 PATCHLEVEL = 6
 SUBLEVEL = 11
-EXTRAVERSION = -rc5-bk4
+EXTRAVERSION =
 NAME=Woozy Numbat
 
 # *DOCUMENTATION*
diff -purN linux-2.6.11-rc5-bk4/arch/arm/kernel/debug.S linux-2.6.11/arch/arm/kernel/debug.S
--- linux-2.6.11-rc5-bk4/arch/arm/kernel/debug.S	2005-02-24 05:02:37.000000000 +0100
+++ linux-2.6.11/arch/arm/kernel/debug.S	2005-03-02 08:37:54.000000000 +0100
@@ -52,29 +52,6 @@
 #include <asm/arch/debug-macro.S>
 #endif
 
-#if 0
-// #elif defined(CONFIG_ARCH_FTVPCI)
-		.macro	addruart,rx
-		mrc	p15, 0, \rx, c1, c0
-		tst	\rx, #1			@ MMU enabled?
-		movne	\rx, #0xe0000000
-		moveq	\rx, #0x10000000
-		.endm
-
-		.macro	senduart,rd,rx
-		str	\rd, [\rx, #0xc]
-		.endm
-
-		.macro	busyuart,rd,rx
-1001:		ldr	\rd, [\rx, #0x4]
-		tst	\rd, #1 << 2
-		beq	1001b
-		.endm
-
-		.macro	waituart,rd,rx
-		.endm
-#endif
-
 /*
  * Useful debugging routines
  */
diff -purN linux-2.6.11-rc5-bk4/arch/arm/mach-imx/dma.c linux-2.6.11/arch/arm/mach-imx/dma.c
--- linux-2.6.11-rc5-bk4/arch/arm/mach-imx/dma.c	2005-02-24 05:03:37.000000000 +0100
+++ linux-2.6.11/arch/arm/mach-imx/dma.c	2005-03-02 08:38:33.000000000 +0100
@@ -136,7 +136,7 @@ dma_err_handler(int irq, void *dev_id, s
 			       i, channel->name);
 			DBOSR |= (1 << i);
 		}
-		DISR |= (1 << i);
+		DISR = (1 << i);
 	}
 	return IRQ_HANDLED;
 }
@@ -158,10 +158,10 @@ dma_irq_handler(int irq, void *dev_id, s
 				 */
 				printk(KERN_WARNING
 				       "spurious IRQ for DMA channel %d\n", i);
-				DISR |= (1 << i);
 			}
 		}
 	}
+	DISR = disr;
 	return IRQ_HANDLED;
 }
 
diff -purN linux-2.6.11-rc5-bk4/arch/arm/mach-imx/generic.c linux-2.6.11/arch/arm/mach-imx/generic.c
--- linux-2.6.11-rc5-bk4/arch/arm/mach-imx/generic.c	2005-02-24 05:03:40.000000000 +0100
+++ linux-2.6.11/arch/arm/mach-imx/generic.c	2005-03-02 08:38:34.000000000 +0100
@@ -100,8 +100,8 @@ EXPORT_SYMBOL(imx_gpio_mode);
 static unsigned int imx_decode_pll(unsigned int pll)
 {
 	u32 mfi = (pll >> 10) & 0xf;
-	u32 mfn = pll & 0x3f;
-	u32 mfd = (pll >> 16) & 0x3f;
+	u32 mfn = pll & 0x3ff;
+	u32 mfd = (pll >> 16) & 0x3ff;
 	u32 pd =  (pll >> 26) & 0xf;
 	u32 f_ref = (CSCR & CSCR_SYSTEM_SEL) ? 16000000 : (CLK32 * 512);
 
diff -purN linux-2.6.11-rc5-bk4/arch/ia64/kernel/ptrace.c linux-2.6.11/arch/ia64/kernel/ptrace.c
--- linux-2.6.11-rc5-bk4/arch/ia64/kernel/ptrace.c	2005-02-24 05:03:28.000000000 +0100
+++ linux-2.6.11/arch/ia64/kernel/ptrace.c	2005-03-02 08:38:33.000000000 +0100
@@ -16,6 +16,7 @@
 #include <linux/smp_lock.h>
 #include <linux/user.h>
 #include <linux/security.h>
+#include <linux/audit.h>
 
 #include <asm/pgtable.h>
 #include <asm/processor.h>
diff -purN linux-2.6.11-rc5-bk4/drivers/acpi/pci_irq.c linux-2.6.11/drivers/acpi/pci_irq.c
--- linux-2.6.11-rc5-bk4/drivers/acpi/pci_irq.c	2005-02-24 05:02:38.000000000 +0100
+++ linux-2.6.11/drivers/acpi/pci_irq.c	2005-03-02 08:38:08.000000000 +0100
@@ -460,7 +460,7 @@ void
 acpi_pci_irq_disable (
 	struct pci_dev		*dev)
 {
-	u32			gsi = 0;
+	int			gsi = 0;
 	u8			pin = 0;
 	int			edge_level = ACPI_LEVEL_SENSITIVE;
 	int			active_high_low = ACPI_ACTIVE_LOW;
@@ -487,10 +487,10 @@ acpi_pci_irq_disable (
 	 * If no PRT entry was found, we'll try to derive an IRQ from the
 	 * device's parent bridge.
 	 */
-	if (!gsi)
+	if (gsi < 0)
  		gsi = acpi_pci_irq_derive(dev, pin,
 					  &edge_level, &active_high_low);
-	if (!gsi)
+	if (gsi < 0)
 		return_VOID;
 
 	/*
diff -purN linux-2.6.11-rc5-bk4/drivers/block/genhd.c linux-2.6.11/drivers/block/genhd.c
--- linux-2.6.11-rc5-bk4/drivers/block/genhd.c	2005-02-24 05:02:45.000000000 +0100
+++ linux-2.6.11/drivers/block/genhd.c	2005-03-02 08:38:08.000000000 +0100
@@ -660,9 +660,10 @@ int invalidate_partition(struct gendisk 
 {
 	int res = 0;
 	struct block_device *bdev = bdget_disk(disk, index);
-	if (bdev)
+	if (bdev) {
 		res = __invalidate_device(bdev, 1);
-	bdput(bdev);
+		bdput(bdev);
+	}
 	return res;
 }
 
diff -purN linux-2.6.11-rc5-bk4/drivers/input/serio/i8042-x86ia64io.h linux-2.6.11/drivers/input/serio/i8042-x86ia64io.h
--- linux-2.6.11-rc5-bk4/drivers/input/serio/i8042-x86ia64io.h	2005-02-24 05:03:09.000000000 +0100
+++ linux-2.6.11/drivers/input/serio/i8042-x86ia64io.h	2005-03-02 08:38:17.000000000 +0100
@@ -224,7 +224,7 @@ static struct acpi_driver i8042_acpi_kbd
 
 static struct acpi_driver i8042_acpi_aux_driver = {
 	.name		= "i8042",
-	.ids		= "PNP0F13,SYN0801",
+	.ids		= "PNP0F03,PNP0F0B,PNP0F0E,PNP0F12,PNP0F13,SYN0801",
 	.ops		= {
 		.add		= i8042_acpi_aux_add,
 	},
diff -purN linux-2.6.11-rc5-bk4/drivers/net/wireless/prism54/islpci_hotplug.c linux-2.6.11/drivers/net/wireless/prism54/islpci_hotplug.c
--- linux-2.6.11-rc5-bk4/drivers/net/wireless/prism54/islpci_hotplug.c	2005-02-24 05:02:45.000000000 +0100
+++ linux-2.6.11/drivers/net/wireless/prism54/islpci_hotplug.c	2005-03-02 08:38:08.000000000 +0100
@@ -163,7 +163,7 @@ prism54_probe(struct pci_dev *pdev, cons
 	if (rvalue || !mem_addr) {
 		printk(KERN_ERR "%s: PCI device memory region not configured; fix your BIOS or CardBus bridge/drivers\n",
 		       DRV_NAME);
-		goto do_pci_disable_device;
+		goto do_pci_release_regions;
 	}
 
 	/* enable PCI bus-mastering */
diff -purN linux-2.6.11-rc5-bk4/drivers/serial/8250.c linux-2.6.11/drivers/serial/8250.c
--- linux-2.6.11-rc5-bk4/drivers/serial/8250.c	2005-02-24 05:02:21.000000000 +0100
+++ linux-2.6.11/drivers/serial/8250.c	2005-03-02 08:37:47.000000000 +0100
@@ -450,9 +450,11 @@ static void disable_rsa(struct uart_8250
  */
 static int size_fifo(struct uart_8250_port *up)
 {
-	unsigned char old_fcr, old_mcr, old_dll, old_dlm;
+	unsigned char old_fcr, old_mcr, old_dll, old_dlm, old_lcr;
 	int count;
 
+	old_lcr = serial_inp(up, UART_LCR);
+	serial_outp(up, UART_LCR, 0);
 	old_fcr = serial_inp(up, UART_FCR);
 	old_mcr = serial_inp(up, UART_MCR);
 	serial_outp(up, UART_FCR, UART_FCR_ENABLE_FIFO |
@@ -475,11 +477,40 @@ static int size_fifo(struct uart_8250_po
 	serial_outp(up, UART_LCR, UART_LCR_DLAB);
 	serial_outp(up, UART_DLL, old_dll);
 	serial_outp(up, UART_DLM, old_dlm);
+	serial_outp(up, UART_LCR, old_lcr);
 
 	return count;
 }
 
 /*
+ * Read UART ID using the divisor method - set DLL and DLM to zero
+ * and the revision will be in DLL and device type in DLM.  We
+ * preserve the device state across this.
+ */
+static unsigned int autoconfig_read_divisor_id(struct uart_8250_port *p)
+{
+	unsigned char old_dll, old_dlm, old_lcr;
+	unsigned int id;
+
+	old_lcr = serial_inp(p, UART_LCR);
+	serial_outp(p, UART_LCR, UART_LCR_DLAB);
+
+	old_dll = serial_inp(p, UART_DLL);
+	old_dlm = serial_inp(p, UART_DLM);
+
+	serial_outp(p, UART_DLL, 0);
+	serial_outp(p, UART_DLM, 0);
+
+	id = serial_inp(p, UART_DLL) | serial_inp(p, UART_DLM) << 8;
+
+	serial_outp(p, UART_DLL, old_dll);
+	serial_outp(p, UART_DLM, old_dlm);
+	serial_outp(p, UART_LCR, old_lcr);
+
+	return id;
+}
+
+/*
  * This is a helper routine to autodetect StarTech/Exar/Oxsemi UART's.
  * When this function is called we know it is at least a StarTech
  * 16650 V2, but it might be one of several StarTech UARTs, or one of
@@ -491,7 +522,7 @@ static int size_fifo(struct uart_8250_po
  */
 static void autoconfig_has_efr(struct uart_8250_port *up)
 {
-	unsigned char id1, id2, id3, rev, saved_dll, saved_dlm;
+	unsigned int id1, id2, id3, rev;
 
 	/*
 	 * Everything with an EFR has SLEEP
@@ -541,21 +572,13 @@ static void autoconfig_has_efr(struct ua
 	 *  0x12 - XR16C2850.
 	 *  0x14 - XR16C854.
 	 */
-	serial_outp(up, UART_LCR, UART_LCR_DLAB);
-	saved_dll = serial_inp(up, UART_DLL);
-	saved_dlm = serial_inp(up, UART_DLM);
-	serial_outp(up, UART_DLL, 0);
-	serial_outp(up, UART_DLM, 0);
-	id2 = serial_inp(up, UART_DLL);
-	id1 = serial_inp(up, UART_DLM);
-	serial_outp(up, UART_DLL, saved_dll);
-	serial_outp(up, UART_DLM, saved_dlm);
-
-	DEBUG_AUTOCONF("850id=%02x:%02x ", id1, id2);
-
-	if (id1 == 0x10 || id1 == 0x12 || id1 == 0x14) {
-		if (id1 == 0x10)
-			up->rev = id2;
+	id1 = autoconfig_read_divisor_id(up);
+	DEBUG_AUTOCONF("850id=%04x ", id1);
+
+	id2 = id1 >> 8;
+	if (id2 == 0x10 || id2 == 0x12 || id2 == 0x14) {
+		if (id2 == 0x10)
+			up->rev = id1 & 255;
 		up->port.type = PORT_16850;
 		return;
 	}
@@ -597,6 +620,19 @@ static void autoconfig_8250(struct uart_
 		up->port.type = PORT_16450;
 }
 
+static int broken_efr(struct uart_8250_port *up)
+{
+	/*
+	 * Exar ST16C2550 "A2" devices incorrectly detect as
+	 * having an EFR, and report an ID of 0x0201.  See
+	 * http://www.exar.com/info.php?pdf=dan180_oct2004.pdf
+	 */
+	if (autoconfig_read_divisor_id(up) == 0x0201 && size_fifo(up) == 16)
+		return 1;
+
+	return 0;
+}
+
 /*
  * We know that the chip has FIFOs.  Does it have an EFR?  The
  * EFR is located in the same register position as the IIR and
@@ -633,7 +669,7 @@ static void autoconfig_16550a(struct uar
 	 * (other ST16C650V2 UARTs, TI16C752A, etc)
 	 */
 	serial_outp(up, UART_LCR, 0xBF);
-	if (serial_in(up, UART_EFR) == 0) {
+	if (serial_in(up, UART_EFR) == 0 && !broken_efr(up)) {
 		DEBUG_AUTOCONF("EFRv2 ");
 		autoconfig_has_efr(up);
 		return;
diff -purN linux-2.6.11-rc5-bk4/drivers/serial/8250_pci.c linux-2.6.11/drivers/serial/8250_pci.c
--- linux-2.6.11-rc5-bk4/drivers/serial/8250_pci.c	2005-02-24 05:03:09.000000000 +0100
+++ linux-2.6.11/drivers/serial/8250_pci.c	2005-03-02 08:38:17.000000000 +0100
@@ -2212,6 +2212,13 @@ static struct pci_device_id serial_pci_t
 		0, pbn_exar_XR17C158 },
 
 	/*
+	 * Topic TP560 Data/Fax/Voice 56k modem (reported by Evan Clarke)
+	 */
+	{	PCI_VENDOR_ID_TOPIC, PCI_DEVICE_ID_TOPIC_TP560,
+		PCI_ANY_ID, PCI_ANY_ID, 0, 0,
+		pbn_b0_1_115200 },
+
+	/*
 	 * These entries match devices with class COMMUNICATION_SERIAL,
 	 * COMMUNICATION_MODEM or COMMUNICATION_MULTISERIAL
 	 */
@@ -2241,7 +2248,7 @@ static struct pci_driver serial_pci_driv
 
 static int __init serial8250_pci_init(void)
 {
-	return pci_module_init(&serial_pci_driver);
+	return pci_register_driver(&serial_pci_driver);
 }
 
 static void __exit serial8250_pci_exit(void)
diff -purN linux-2.6.11-rc5-bk4/drivers/serial/Makefile linux-2.6.11/drivers/serial/Makefile
--- linux-2.6.11-rc5-bk4/drivers/serial/Makefile	2005-02-24 05:02:45.000000000 +0100
+++ linux-2.6.11/drivers/serial/Makefile	2005-03-02 08:38:09.000000000 +0100
@@ -6,9 +6,9 @@
 
 serial-8250-y :=
 serial-8250-$(CONFIG_SERIAL_8250_ACPI) += 8250_acpi.o
+serial-8250-$(CONFIG_PNP) += 8250_pnp.o
 serial-8250-$(CONFIG_GSC) += 8250_gsc.o
 serial-8250-$(CONFIG_PCI) += 8250_pci.o
-serial-8250-$(CONFIG_PNP) += 8250_pnp.o
 serial-8250-$(CONFIG_HP300) += 8250_hp300.o
 
 obj-$(CONFIG_SERIAL_CORE) += serial_core.o
diff -purN linux-2.6.11-rc5-bk4/drivers/video/aty/radeon_base.c linux-2.6.11/drivers/video/aty/radeon_base.c
--- linux-2.6.11-rc5-bk4/drivers/video/aty/radeon_base.c	2005-02-24 05:02:31.000000000 +0100
+++ linux-2.6.11/drivers/video/aty/radeon_base.c	2005-03-02 08:37:54.000000000 +0100
@@ -2551,7 +2551,7 @@ MODULE_AUTHOR("Ani Joshi");
 MODULE_DESCRIPTION("framebuffer driver for ATI Radeon chipset");
 MODULE_LICENSE("GPL");
 module_param(noaccel, bool, 0);
-module_param(default_dynclk, int, -2);
+module_param(default_dynclk, int, 0);
 MODULE_PARM_DESC(default_dynclk, "int: -2=enable on mobility only,-1=do not change,0=off,1=on");
 MODULE_PARM_DESC(noaccel, "bool: disable acceleration");
 module_param(nomodeset, bool, 0);
diff -purN linux-2.6.11-rc5-bk4/fs/sysfs/file.c linux-2.6.11/fs/sysfs/file.c
--- linux-2.6.11-rc5-bk4/fs/sysfs/file.c	2005-02-24 05:02:21.000000000 +0100
+++ linux-2.6.11/fs/sysfs/file.c	2005-03-02 08:37:47.000000000 +0100
@@ -231,15 +231,16 @@ static ssize_t
 sysfs_write_file(struct file *file, const char __user *buf, size_t count, loff_t *ppos)
 {
 	struct sysfs_buffer * buffer = file->private_data;
+	ssize_t len;
 
 	down(&buffer->sem);
-	count = fill_write_buffer(buffer,buf,count);
-	if (count > 0)
-		count = flush_write_buffer(file->f_dentry,buffer,count);
-	if (count > 0)
-		*ppos += count;
+	len = fill_write_buffer(buffer, buf, count);
+	if (len > 0)
+		len = flush_write_buffer(file->f_dentry, buffer, len);
+	if (len > 0)
+		*ppos += len;
 	up(&buffer->sem);
-	return count;
+	return len;
 }
 
 static int check_perm(struct inode * inode, struct file * file)
diff -purN linux-2.6.11-rc5-bk4/include/linux/pci_ids.h linux-2.6.11/include/linux/pci_ids.h
--- linux-2.6.11-rc5-bk4/include/linux/pci_ids.h	2005-02-24 05:03:51.000000000 +0100
+++ linux-2.6.11/include/linux/pci_ids.h	2005-03-02 08:38:37.000000000 +0100
@@ -1972,6 +1972,9 @@
 #define PCI_DEVICE_ID_BCM4401		0x4401
 #define PCI_DEVICE_ID_BCM4401B0		0x4402
 
+#define PCI_VENDOR_ID_TOPIC		0x151f
+#define PCI_DEVICE_ID_TOPIC_TP560	0x0000
+
 #define PCI_VENDOR_ID_ENE		0x1524
 #define PCI_DEVICE_ID_ENE_1211		0x1211
 #define PCI_DEVICE_ID_ENE_1225		0x1225
diff -purN linux-2.6.11-rc5-bk4/kernel/audit.c linux-2.6.11/kernel/audit.c
--- linux-2.6.11-rc5-bk4/kernel/audit.c	2005-02-24 05:03:37.000000000 +0100
+++ linux-2.6.11/kernel/audit.c	2005-03-02 08:38:33.000000000 +0100
@@ -360,7 +360,7 @@ static int audit_receive_msg(struct sk_b
 		status_set.backlog_limit = audit_backlog_limit;
 		status_set.lost		 = atomic_read(&audit_lost);
 		status_set.backlog	 = atomic_read(&audit_backlog);
-		audit_send_reply(pid, seq, AUDIT_GET, 0, 0,
+		audit_send_reply(NETLINK_CB(skb).pid, seq, AUDIT_GET, 0, 0,
 				 &status_set, sizeof(status_set));
 		break;
 	case AUDIT_SET:
@@ -407,8 +407,8 @@ static int audit_receive_msg(struct sk_b
 		/* fallthrough */
 	case AUDIT_LIST:
 #ifdef CONFIG_AUDITSYSCALL
-		err = audit_receive_filter(nlh->nlmsg_type, pid, uid, seq,
-					   data);
+		err = audit_receive_filter(nlh->nlmsg_type, NETLINK_CB(skb).pid,
+					   uid, seq, data);
 #else
 		err = -EOPNOTSUPP;
 #endif
diff -purN linux-2.6.11-rc5-bk4/kernel/auditsc.c linux-2.6.11/kernel/auditsc.c
--- linux-2.6.11-rc5-bk4/kernel/auditsc.c	2005-02-24 05:03:09.000000000 +0100
+++ linux-2.6.11/kernel/auditsc.c	2005-03-02 08:38:17.000000000 +0100
@@ -358,7 +358,7 @@ static int audit_filter_rules(struct tas
 		case AUDIT_INODE:
 			if (ctx) {
 				for (j = 0; j < ctx->name_count; j++) {
-					if (MINOR(ctx->names[j].ino)==value) {
+					if (ctx->names[j].ino == value) {
 						++result;
 						break;
 					}
diff -purN linux-2.6.11-rc5-bk4/security/selinux/ss/conditional.c linux-2.6.11/security/selinux/ss/conditional.c
--- linux-2.6.11-rc5-bk4/security/selinux/ss/conditional.c	2005-02-24 05:02:29.000000000 +0100
+++ linux-2.6.11/security/selinux/ss/conditional.c	2005-03-02 08:37:49.000000000 +0100
@@ -401,8 +401,10 @@ static int cond_read_node(struct policyd
 		expr->expr_type = le32_to_cpu(buf[0]);
 		expr->bool = le32_to_cpu(buf[1]);
 
-		if (!expr_isvalid(p, expr))
+		if (!expr_isvalid(p, expr)) {
+			kfree(expr);
 			goto err;
+		}
 
 		if (i == 0) {
 			node->expr = expr;
diff -purN linux-2.6.11-rc5-bk4/security/selinux/ss/policydb.c linux-2.6.11/security/selinux/ss/policydb.c
--- linux-2.6.11-rc5-bk4/security/selinux/ss/policydb.c	2005-02-24 05:02:38.000000000 +0100
+++ linux-2.6.11/security/selinux/ss/policydb.c	2005-03-02 08:38:07.000000000 +0100
@@ -773,7 +773,7 @@ static int class_read(struct policydb *p
 	cladatum = kmalloc(sizeof(*cladatum), GFP_KERNEL);
 	if (!cladatum) {
 		rc = -ENOMEM;
-		goto bad;
+		goto out;
 	}
 	memset(cladatum, 0, sizeof(*cladatum));
 
