ChangeSet
  1.1786 04/05/19 16:41:54 akpm@osdl.org[torvalds] +2 -0
  [PATCH] use-before-uninitialized value in ext3(2)_find_ goal
  
  From: Mingming Cao <cmm@us.ibm.com>
  
  There is a uninitialized goal value being referenced in both ext3 and ext2
  find goal block functions (ext3_find_goal() and ext2_find_goal()).
  
  In the non-sequential write case, these functions check the goal value(non
  zero) before calling ext3(2)_find_near() to find the goal block to
  allocate.
  
  Since the goal value is uninitialized(non zero), the ext3(2)_find_near() is
  never being called in the non-sequential write, thus ext3(2)_find_goal()
  failed to guide a goal block in the random write case.
  
  ext3(2)_new_block() takes the junk goal value and will turn it to goal 0
  since it's normally beyond the filesystem block number limit.  The fix is
  trivial.

  fs/ext3/inode.c
    1.96 04/05/19 09:03:00 akpm@osdl.org[torvalds] +1 -0
    use-before-uninitialized value in ext3(2)_find_ goal

  fs/ext2/inode.c
    1.75 04/05/19 09:03:00 akpm@osdl.org[torvalds] +1 -0
    use-before-uninitialized value in ext3(2)_find_ goal

.........................................................................
diff -p -Nru a/fs/ext2/inode.c b/fs/ext2/inode.c
--- a/fs/ext2/inode.c	Thu May 20 06:34:37 2004
+++ b/fs/ext2/inode.c	Thu May 20 06:34:37 2004
@@ -584,6 +584,7 @@ out:
 	if (err == -EAGAIN)
 		goto changed;
 
+	goal = 0;
 	if (ext2_find_goal(inode, iblock, chain, partial, &goal) < 0)
 		goto changed;
 
diff -p -Nru a/fs/ext3/inode.c b/fs/ext3/inode.c
--- a/fs/ext3/inode.c	Thu May 20 06:34:37 2004
+++ b/fs/ext3/inode.c	Thu May 20 06:34:37 2004
@@ -811,6 +811,7 @@ out:
 	if (err == -EAGAIN)
 		goto changed;
 
+	goal = 0;
 	down(&ei->truncate_sem);
 	if (ext3_find_goal(inode, iblock, chain, partial, &goal) < 0) {
 		up(&ei->truncate_sem);
.........................................................................
# vim: syntax=diff

