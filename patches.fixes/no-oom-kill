Date: Mon, 04 Oct 2004 20:17:00
From: Andi Kleen <ak@suse.de>
Subject: #46535: Add local-oom-kill sysctl to allow disabling the OOM killer

[agruen] This is for debugging...

Index: linux-2.6.8/mm/oom_kill.c
===================================================================
--- linux-2.6.8.orig/mm/oom_kill.c
+++ linux-2.6.8/mm/oom_kill.c
@@ -21,6 +21,8 @@
 #include <linux/timex.h>
 #include <linux/jiffies.h>
 
+int sysctl_no_oomkill;
+
 /* #define DEBUG */
 
 /**
@@ -230,6 +232,10 @@ void out_of_memory(int gfp_mask)
 	static unsigned long first, last, count, lastkill;
 	unsigned long now, since;
 
+	WARN_ON(1);
+	if (sysctl_no_oomkill)
+		return;
+
 	spin_lock(&oom_lock);
 	now = jiffies;
 	since = now - last;
Index: linux-2.6.8/kernel/sysctl.c
===================================================================
--- linux-2.6.8.orig/kernel/sysctl.c
+++ linux-2.6.8/kernel/sysctl.c
@@ -55,6 +55,8 @@ static int proc_do_kdb(ctl_table *table,
 
 #if defined(CONFIG_SYSCTL)
 
+extern int sysctl_no_oomkill;
+
 /* External variables not in a header file. */
 extern int panic_timeout;
 extern int C_A_D;
@@ -864,6 +866,15 @@ static ctl_table vm_table[] = {
 		.mode		= 0644,
 		.proc_handler	= &proc_dointvec,
 	},
+	{
+		.ctl_name	= 998,
+		.procname	= "local-oom-kill", 
+		.data		= &sysctl_no_oomkill,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= &proc_dointvec,
+	},
+
 	{ .ctl_name = 0 }
 };
 
