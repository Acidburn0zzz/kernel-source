From: someone@intel.com
Subject: Force HPET to be enabled for laptops
Patch-mainline: 2.6.24 hopefully

Found at: http://www.linuxpowertop.org/patches/hpet_patches_45.patch

This is also in the -mm tree

Updated Oct 13, 2007 jeffm:
	Removed bits that fixed the resume logic, committed into mainline
	as commit 18de5bc4c1f1f1fa5e14f354a7603bd6e9d4e3b6 for 2.6.23-rc1.

Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
Signed-off-by: Jeff Mahoney <jeffm@suse.com>

---

 arch/i386/kernel/hpet.c |   32 +++++++++++++++++++++++++++++++-
 1 file changed, 31 insertions(+), 1 deletion(-)

--- a/arch/i386/kernel/hpet.c	2007-08-27 14:01:19.000000000 -0400
+++ b/arch/i386/kernel/hpet.c	2007-08-27 14:01:21.000000000 -0400
@@ -125,6 +125,7 @@ static struct clock_event_device hpet_cl
 	.set_next_event = hpet_next_event,
 	.shift		= 32,
 	.irq		= 0,
+	.rating		= 50,
 };
 
 static void hpet_start_counter(void)
@@ -139,6 +140,12 @@ static void hpet_start_counter(void)
 	hpet_writel(cfg, HPET_CFG);
 }
 
+static void hpet_restart_counter(void)
+{
+	ich_force_hpet_resume();
+	hpet_start_counter();
+}
+
 static void hpet_enable_int(void)
 {
 	unsigned long cfg = hpet_readl(HPET_CFG);
@@ -217,7 +228,7 @@ static struct clocksource clocksource_hp
 	.mask		= HPET_MASK,
 	.shift		= HPET_SHIFT,
 	.flags		= CLOCK_SOURCE_IS_CONTINUOUS,
-	.resume		= hpet_start_counter,
+	.resume		= hpet_restart_counter,
 };
 
 /*
@@ -229,6 +241,9 @@ int __init hpet_enable(void)
 	u64 tmp, start, now;
 	cycle_t t1;
 
+	if (hpet_virt_address)
+		return 0;
+
 	if (!is_hpet_capable())
 		return 0;
 
@@ -336,6 +350,26 @@ out_nohpet:
 }
 
 
+static int __init hpet_late_init(void)
+{
+	if (boot_hpet_disable)
+		return -ENODEV;
+
+	if (!hpet_address) {
+		if (!force_hpet_address)
+			return -ENODEV;
+
+		hpet_address = force_hpet_address;
+		hpet_enable();
+		if (!hpet_virt_address)
+			return -ENODEV;
+	}
+
+	return 0;
+}
+module_init(hpet_late_init);
+
+
 #ifdef CONFIG_HPET_EMULATE_RTC
 
 /* HPET in LegacyReplacement Mode eats up RTC interrupt line. When, HPET
