From: Jens Axboe <axboe@suse.de>
Subject: Fix barrier hang with CFQ
Patch-mainline: 2.6.13
References: 96537

We cannot deny a barrier to be sent even if we have requests pending at the
->cfq_max_depth limit, as we require the barrier to make progress.

Acked-by: 
Signed-off-by: 

--- linux-2.6.12/drivers/block/cfq-iosched.c~	2005-08-02 13:17:58.000000000 +0200
+++ linux-2.6.12/drivers/block/cfq-iosched.c	2005-08-02 13:11:57.000000000 +0200
@@ -1281,6 +1281,7 @@
 			 */
 			if (!cfq_crq_in_driver(crq) &&
 			    !cfq_cfqq_idle_window(cfqq) &&
+			    !blk_barrier_rq(rq) &&
 			    cfqd->rq_in_driver >= cfqd->cfq_max_depth)
 				return NULL;
 
