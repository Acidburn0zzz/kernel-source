
This patch allows for more than one concurrent directio NFS read or write
request, by releasing the i_sem while we're doing the call. According
to Chuck Lever and Andrea Arcangeli, releasing the semaphore is not
problematic.

diff -X /home/cel/src/linux/dont-diff -Naurp 02-rename/fs/nfs/direct.c 03-odirect-isem/fs/nfs/direct.c
--- 02-rename/fs/nfs/direct.c	2004-01-09 02:00:02.000000000 -0500
+++ 03-odirect-isem/fs/nfs/direct.c	2004-02-02 12:54:57.151256000 -0500
@@ -429,9 +429,7 @@ nfs_direct_IO(int rw, struct kiocb *iocb
 	if (!is_sync_kiocb(iocb))
 		goto out;
 
-	result = nfs_revalidate_inode(NFS_SERVER(inode), inode);
-	if (result < 0)
-		goto out;
+	up(&inode->i_sem);
 
 	switch (rw) {
 	case READ:
@@ -452,6 +450,8 @@ nfs_direct_IO(int rw, struct kiocb *iocb
 		break;
 	}
 
+	down(&inode->i_sem);
+
 out:
 	dprintk("NFS: direct_IO result=%d\n", result);
 	return result;
