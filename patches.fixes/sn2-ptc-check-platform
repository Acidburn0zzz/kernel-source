From: Robin Holt <holt@sgi.com>
Subject: Prevent sn2 ptc code from executing on all ia64 subarches
References: 143446
Acked-by: schwab@suse.de
Patch-Mainline: superseded

Prarit, I don't think your patch catches all the cases.  Try
this one.

 arch/ia64/sn/kernel/sn2/sn_hwperf.c |    3 +++
 drivers/char/snsc.c                 |    7 ++++++-
 drivers/pci/hotplug/sgi_hotplug.c   |    3 +++
 drivers/sn/ioc4.c                   |    3 +++
 4 files changed, 15 insertions(+), 1 deletion(-)

--- linux-2.6.15.orig/arch/ia64/sn/kernel/sn2/sn_hwperf.c	2006-02-09 13:00:12.000000000 -0800
+++ linux-2.6.15/arch/ia64/sn/kernel/sn2/sn_hwperf.c	2006-02-09 13:02:36.000000000 -0800
@@ -976,6 +976,9 @@
 	if (!ia64_platform_is("sn2"))
 		return 0;
 
+	if (!ia64_platform_is("sn2"))
+		return -ENODEV;
+
 	sn_hwperf_init();
 
 	/*
--- linux-2.6.15.orig/drivers/char/snsc.c	2006-02-09 13:00:12.000000000 -0800
+++ linux-2.6.15/drivers/char/snsc.c	2006-02-09 13:02:36.000000000 -0800
@@ -375,7 +375,12 @@
 	struct sysctl_data_s *scd;
 	void *salbuf;
 	dev_t first_dev, dev;
-	nasid_t event_nasid = ia64_sn_get_console_nasid();
+	nasid_t event_nasid;
+
+	if (!ia64_platform_is("sn2"))
+		return -ENODEV;
+
+	event_nasid = ia64_sn_get_console_nasid();
 
 	if (alloc_chrdev_region(&first_dev, 0, num_cnodes,
 				SYSCTL_BASENAME) < 0) {
--- linux-2.6.15.orig/drivers/pci/hotplug/sgi_hotplug.c	2006-02-09 13:00:12.000000000 -0800
+++ linux-2.6.15/drivers/pci/hotplug/sgi_hotplug.c	2006-02-09 13:02:36.000000000 -0800
@@ -552,6 +552,9 @@
 	int rc;
 	int registered = 0;
 
+	if (!ia64_platform_is("sn2"))
+		return -ENODEV;
+
 	if (sn_sal_rev() < SGI_HOTPLUG_PROM_REV) {
 		printk(KERN_ERR "%s: PROM version must be greater than 4.30\n",
 		       __FUNCTION__);
--- linux-2.6.15.orig/drivers/sn/ioc4.c	2006-02-09 13:00:12.000000000 -0800
+++ linux-2.6.15/drivers/sn/ioc4.c	2006-02-09 13:02:36.000000000 -0800
@@ -406,6 +406,9 @@
 static int __devinit
 ioc4_init(void)
 {
+	if (!ia64_platform_is("sn2"))
+		return -ENODEV;
+
 	return pci_register_driver(&ioc4_driver);
 }
 
