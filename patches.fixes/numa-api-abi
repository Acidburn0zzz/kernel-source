# This is a BitKeeper generated diff -Nru style patch.
#
# ChangeSet
#   2004/09/14 08:38:02-07:00 ak@suse.de 
#   [PATCH] Fix ABI in set_mempolicy()
#   
#   Fix ABI in set_mempolicy() that got broken by an earlier change.
#   
#   Add a check for very big input values and prevent excessive looping in the
#   kernel.
#   
#   Cc: Paul "nyer, nyer, your mother wears combat boots!" Jackson <pj@sgi.com>
#   
#   Signed-off-by: Andrew Morton <akpm@osdl.org>
#   Signed-off-by: Linus Torvalds <torvalds@osdl.org>
# 
# mm/mempolicy.c
#   2004/09/13 18:56:13-07:00 ak@suse.de +3 -0
#   Fix ABI in set_mempolicy()
# 
diff -Nru a/mm/mempolicy.c b/mm/mempolicy.c
--- a/mm/mempolicy.c	2004-09-18 01:00:35 -07:00
+++ b/mm/mempolicy.c	2004-09-18 01:00:35 -07:00
@@ -132,6 +132,7 @@
 	unsigned long nlongs;
 	unsigned long endmask;
 
+	--maxnode;
 	bitmap_zero(nodes, MAX_NUMNODES);
 	if (maxnode == 0 || !nmask)
 		return 0;
@@ -145,6 +146,8 @@
 	/* When the user specified more nodes than supported just check
 	   if the non supported part is all zero. */
 	if (nlongs > BITS_TO_LONGS(MAX_NUMNODES)) {
+		if (nlongs > PAGE_SIZE/sizeof(long))
+			return -EINVAL;
 		for (k = BITS_TO_LONGS(MAX_NUMNODES); k < nlongs; k++) {
 			unsigned long t;
 			if (get_user(t,  nmask + k))
