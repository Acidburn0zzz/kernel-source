From: Robert Love <rml@novell.com>
Subject: fix inotify to emit delete events
References: 162437
Patch-mainline: yes

Signed-off-by: Robert Love <rml@novell.com>
Acked-by: mason@suse.com

 fs/dcache.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

--- linux-2.6.16-8/fs/dcache.c.orig	2006-03-31 14:25:48.000000000 -0500
+++ linux-2.6.16-8/fs/dcache.c	2006-03-31 14:25:57.000000000 -0500
@@ -1223,11 +1223,11 @@
 	spin_lock(&dentry->d_lock);
 	isdir = S_ISDIR(dentry->d_inode->i_mode);
 	if (atomic_read(&dentry->d_count) == 1) {
-		/* remove this and other inotify debug checks after 2.6.18 */
-		dentry->d_flags &= ~DCACHE_INOTIFY_PARENT_WATCHED;
-
 		dentry_iput(dentry);
 		fsnotify_nameremove(dentry, isdir);
+
+		/* remove this and other inotify debug checks after 2.6.18 */
+		dentry->d_flags &= ~DCACHE_INOTIFY_PARENT_WATCHED;
 		return;
 	}
 
