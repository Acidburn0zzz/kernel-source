Subject: Prevent chown from modifying inode ctimes without permission check
From: agruen@suse.de
References: 42542

Stop chmod(foo, -1, -1) from updating an inode's ctime: In this case
the ctime would get modified without performing any permission checks.
This fix is only significant for directories. The ctimes of all other
files can trivially be modified by creating a hard link of the file,
which modifies the inode's link count, and thus the ctime as well.

Index: linux-2.6.8/fs/open.c
===================================================================
--- linux-2.6.8.orig/fs/open.c
+++ linux-2.6.8/fs/open.c
@@ -678,12 +678,14 @@ static int chown_common(struct dentry * 
 	error = -EPERM;
 	if (IS_IMMUTABLE(inode) || IS_APPEND(inode))
 		goto out;
-	newattrs.ia_valid =  ATTR_CTIME;
+	newattrs.ia_valid = 0;
 	if (user != (uid_t) -1) {
+		newattrs.ia_valid |=  ATTR_CTIME;
 		newattrs.ia_valid |= ATTR_UID;
 		newattrs.ia_uid = user;
 	}
 	if (group != (gid_t) -1) {
+		newattrs.ia_valid |=  ATTR_CTIME;
 		newattrs.ia_valid |= ATTR_GID;
 		newattrs.ia_gid = group;
 	}
