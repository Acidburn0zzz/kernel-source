# This is a BitKeeper generated diff -Nru style patch.
#
# ChangeSet
#   2004/09/17 11:54:51-07:00 Markus.Lidel@shadowconnect.com 
#   [PATCH] reduce ioremap memory size for Adaptec I2O controllers
#   
#   The I2O subsystem currently map all memory from the I2O controller for the
#   controller's in queue, even if it is not necessary.  This is a problem,
#   because on some systems the size returned from pci_resource_len() could be
#   128MB and only 1-4MB is needed.
#   
#   Changes:
#   
#   - only ioremap as much memory as the controller is actually using.
#   
#   Signed-off-by: Andrew Morton <akpm@osdl.org>
#   Signed-off-by: Linus Torvalds <torvalds@osdl.org>
# 
# drivers/message/i2o/pci.c
#   2004/09/16 23:58:37-07:00 Markus.Lidel@shadowconnect.com +15 -0
#   reduce ioremap memory size for Adaptec I2O controllers
# 
diff -Nru a/drivers/message/i2o/pci.c b/drivers/message/i2o/pci.c
--- a/drivers/message/i2o/pci.c	2004-09-18 00:51:57 -07:00
+++ b/drivers/message/i2o/pci.c	2004-09-18 00:51:57 -07:00
@@ -133,6 +133,21 @@
 			if (!c->base.phys) {
 				c->base.phys = pci_resource_start(pdev, i);
 				c->base.len = pci_resource_len(pdev, i);
+
+				/*
+				 * If we know what card it is, set the size
+				 * correctly. Code is taken from dpt_i2o.c
+				 */
+				if(pdev->device == 0xa501) {
+					if(pdev->subsystem_device >= 0xc032 &&
+					   pdev->subsystem_device <= 0xc03b) {
+						if(c->base.len > 0x400000)
+							c->base.len = 0x400000;
+					} else {
+						if(c->base.len > 0x100000)
+							c->base.len = 0x100000;
+					}
+				}
 				if (!c->raptor)
 					break;
 			} else {
