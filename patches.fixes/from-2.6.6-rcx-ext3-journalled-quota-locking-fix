#date: 2004-04-26
#from: Jan Kara <jack@ucw.cz>
#id: 1.1535
#tag: via-mm
#time: 22:56:01
#title: ext3 journalled quota locking fix
#who: akpm@osdl.org[torvalds]
#
# ChangeSet
#   1.1535 04/04/26 22:56:01 akpm@osdl.org[torvalds] +1 -0
#   [PATCH] ext3 journalled quota locking fix
#   
#   From: Jan Kara <jack@ucw.cz>
#   
#   I've attached a fix for a problem in ext3 journalled quota patch - the problem
#   is that detecting whether dqput() sleeps was wrong and so we could possibly
#   schedule when holding a spinlock.
#
# fs/dquot.c +1 -1
#
diff -Nru a/fs/dquot.c b/fs/dquot.c
--- a/fs/dquot.c	Wed Apr 28 10:38:30 2004
+++ b/fs/dquot.c	Wed Apr 28 10:38:30 2004
@@ -642,7 +642,7 @@
 /* Return 0 if dqput() won't block (note that 1 doesn't necessarily mean blocking) */
 static inline int dqput_blocks(struct dquot *dquot)
 {
-	if (atomic_read(&dquot->dq_count) <= 1 && dquot_dirty(dquot))
+	if (atomic_read(&dquot->dq_count) <= 1)
 		return 1;
 	return 0;
 }
