#date: 2004-04-19
#from: Chris Wright <chrisw@osdl.org>
#id: 1.1371.726.5
#tag: via-mm
#time: 12:05:40
#title: fix load_elf_binary error path on unshare_files error
#who: akpm@osdl.org[torvalds]
#
# ChangeSet
#   1.1371.726.5 04/04/19 12:05:40 akpm@osdl.org[torvalds] +1 -0
#   [PATCH] fix load_elf_binary error path on unshare_files error
#   
#   From: Chris Wright <chrisw@osdl.org>
#   
#   Make sure to return proper retval on unshare_files() error in load_elf_binary.
#   
#   Error noted by Kirill Korotaev <kirillx@7ka.mipt.ru>.
#
# fs/binfmt_elf.c +2 -1
#
diff -Nru a/fs/binfmt_elf.c b/fs/binfmt_elf.c
--- a/fs/binfmt_elf.c	Wed Apr 28 00:33:10 2004
+++ b/fs/binfmt_elf.c	Wed Apr 28 00:33:10 2004
@@ -522,7 +522,8 @@
 		goto out_free_ph;
 
 	files = current->files;		/* Refcounted so ok */
-	if(unshare_files() < 0)
+	retval = unshare_files();
+	if (retval < 0)
 		goto out_free_ph;
 	if (files == current->files) {
 		put_files_struct(files);
