#date: 2004-04-18
#id: 1.1371.1.480
#tag: via-mm
#time: 10:55:56
#title: set_anon_super locking fix
#who: akpm@osdl.org[torvalds]
#
# ChangeSet
#   1.1371.1.480 04/04/18 10:55:56 akpm@osdl.org[torvalds] +1 -0
#   [PATCH] set_anon_super locking fix
#   
#   Take the idr's lock while removing an element on the error path.  Spotted by
#   Nathan Lynch <nathanl@austin.ibm.com>.
#
# fs/super.c +2 -0
#
diff -Nru a/fs/super.c b/fs/super.c
--- a/fs/super.c	Wed Apr 28 00:38:20 2004
+++ b/fs/super.c	Wed Apr 28 00:38:20 2004
@@ -562,7 +562,9 @@
 	spin_unlock(&unnamed_dev_lock);
 
 	if ((dev & MAX_ID_MASK) == (1 << MINORBITS)) {
+		spin_lock(&unnamed_dev_lock);
 		idr_remove(&unnamed_dev_idr, dev);
+		spin_unlock(&unnamed_dev_lock);
 		return -EMFILE;
 	}
 	s->s_dev = MKDEV(0, dev & MINORMASK);
