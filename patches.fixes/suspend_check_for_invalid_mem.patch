From: Rafael Wysocki <rjwysocki@sisk.pl>
Subject: Check for invalid memory on resume and suspend
Patch-mainline: soon
References: #296242

Signed-off-by: Thomas Renninger <trenn@suse.de>
Acked-by: Pavel Machek <pavel@suse.de>
Ackde-by: Andi Kleen <ak@suse.de>

---
 kernel/power/snapshot.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6/kernel/power/snapshot.c
===================================================================
--- linux-2.6.orig/kernel/power/snapshot.c
+++ linux-2.6/kernel/power/snapshot.c
@@ -709,7 +709,8 @@ static void mark_nosave_pages(struct mem
 				region->end_pfn << PAGE_SHIFT);
 
 		for (pfn = region->start_pfn; pfn < region->end_pfn; pfn++)
-			memory_bm_set_bit(bm, pfn);
+			if (pfn_valid(pfn))
+				memory_bm_set_bit(bm, pfn);
 	}
 }
 
