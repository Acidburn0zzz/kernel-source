From: Jens Axboe <axboe@suse.de>
Subject: cfq-iosched: busy_rr fairness fix
Patch-mainline: 2.6.17-rc6
References: 

[PATCH] cfq-iosched: busy_rr fairness fix

Now that we select busy_rr for possible service, insert entries at the
back of that list instead of at the front.

Signed-off-by: Jens Axboe <axboe@suse.de>
Acked-by: 

--- a/block/cfq-iosched.c
+++ b/block/cfq-iosched.c
@@ -501,10 +501,13 @@ static void cfq_resort_rr_list(struct cf
 
 	/*
 	 * if queue was preempted, just add to front to be fair. busy_rr
-	 * isn't sorted.
+	 * isn't sorted, but insert at the back for fairness.
 	 */
 	if (preempted || list == &cfqd->busy_rr) {
-		list_add(&cfqq->cfq_list, list);
+		if (preempted)
+			list = list->prev;
+
+		list_add_tail(&cfqq->cfq_list, list);
 		return;
 	}
 
