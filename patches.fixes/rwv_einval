From: Chris Mason <mason@suse.com>
Subject: readv and writev should check for EINVAL before Efault
References: 71223

The LSB test suite expects EINVAL for some readv and writev calls,
and the kernel is currently retunring EFAULT.  The patch moves
the EFAULT checks after the EINVAL in hopes of keeping the lsb happy.

                Test Information: 
        iov[0].iov_base = 0x8071910, iov[0].iov_len = 4096 
        iov[1].iov_base = 0x8071910, iov[1].iov_len = -1 
        writev(7, iov, 2) did not behave as expected: 
        ERRNO VALUES: expected: 22 (EINVAL), observed: 14 (EFAULT)

Signed-off-by: mason@suse.com

Index: linux.h/fs/read_write.c
===================================================================
--- linux.h.orig/fs/read_write.c	2005-03-02 19:17:31.000000000 -0500
+++ linux.h/fs/read_write.c	2005-03-17 16:30:15.000000000 -0500
@@ -467,13 +467,13 @@ static ssize_t do_readv_writev(int type,
 		void __user *buf = iov[seg].iov_base;
 		ssize_t len = (ssize_t)iov[seg].iov_len;
 
-		if (unlikely(!access_ok(vrfy_dir(type), buf, len)))
-			goto Efault;
 		if (len < 0)	/* size_t not fitting an ssize_t .. */
 			goto out;
 		tot_len += len;
 		if ((ssize_t)tot_len < 0) /* maths overflow on the ssize_t */
 			goto out;
+		if (unlikely(!access_ok(vrfy_dir(type), buf, len)))
+			goto Efault;
 	}
 	if (tot_len == 0) {
 		ret = 0;
