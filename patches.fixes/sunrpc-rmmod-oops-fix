#date: 2004-04-22
#from: "J. Bruce Fields" <bfields@fieldses.org>
#id: 1.1371.743.19
#tag: via-mm
#time: 13:38:04
#title: sunrpc rmmod oops fix
#who: akpm@osdl.org[torvalds]
#
# ChangeSet
#   1.1371.743.19 04/04/22 13:38:04 akpm@osdl.org[torvalds] +3 -0
#   [PATCH] sunrpc rmmod oops fix
#   
#   From: "J. Bruce Fields" <bfields@fieldses.org>
#   
#   Unregister svcauth_gss caches on exit from gss module; fixes an oops on
#   rmmod.
#
# net/sunrpc/auth_gss/svcauth_gss.c +7 -0
# net/sunrpc/auth_gss/auth_gss.c +1 -0
# include/linux/sunrpc/svcauth_gss.h +1 -0
#
diff -Nru a/include/linux/sunrpc/svcauth_gss.h b/include/linux/sunrpc/svcauth_gss.h
--- a/include/linux/sunrpc/svcauth_gss.h	Wed Apr 28 10:47:05 2004
+++ b/include/linux/sunrpc/svcauth_gss.h	Wed Apr 28 10:47:05 2004
@@ -20,6 +20,7 @@
 #include <linux/sunrpc/auth_gss.h>
 
 int gss_svc_init(void);
+void gss_svc_shutdown(void);
 int svcauth_gss_register_pseudoflavor(u32 pseudoflavor, char * name);
 
 #endif /* __KERNEL__ */
diff -Nru a/net/sunrpc/auth_gss/auth_gss.c b/net/sunrpc/auth_gss/auth_gss.c
--- a/net/sunrpc/auth_gss/auth_gss.c	Wed Apr 28 10:47:05 2004
+++ b/net/sunrpc/auth_gss/auth_gss.c	Wed Apr 28 10:47:05 2004
@@ -984,6 +984,7 @@
 
 static void __exit exit_rpcsec_gss(void)
 {
+	gss_svc_shutdown();
 	gss_mech_unregister_all();
 	rpcauth_unregister(&authgss_ops);
 }
diff -Nru a/net/sunrpc/auth_gss/svcauth_gss.c b/net/sunrpc/auth_gss/svcauth_gss.c
--- a/net/sunrpc/auth_gss/svcauth_gss.c	Wed Apr 28 10:47:05 2004
+++ b/net/sunrpc/auth_gss/svcauth_gss.c	Wed Apr 28 10:47:05 2004
@@ -1063,3 +1063,10 @@
 	svc_auth_register(RPC_AUTH_GSS, &svcauthops_gss);
 	return 0;
 }
+
+void
+gss_svc_shutdown(void)
+{
+	cache_unregister(&rsc_cache);
+	cache_unregister(&rsi_cache);
+}
