From: Andrea Arcangeli <andrea@suse.de>
Subject: avoid underflow of the number of cpus during panic-reboot
Patch-mainline: no
References: 67025

Signed-off-by: Andrea Arcangeli <andrea@suse.de>

--- xx/arch/x86_64/kernel/smp.c.~1~	2005-02-28 00:43:32.000000000 +0100
+++ xx/arch/x86_64/kernel/smp.c	2005-03-03 02:45:02.000000000 +0100
@@ -372,7 +372,10 @@ void smp_send_stop(void)
 	__smp_call_function(smp_really_stop_cpu, NULL, 0, 0);
 	if (!nolock)
 		spin_unlock(&call_lock);
-	smp_stop_cpu();
+
+	local_irq_disable();
+	disable_local_APIC();
+	local_irq_enable(); 
 }
 
 /*
