# This is a BitKeeper generated diff -Nru style patch.
#
# ChangeSet
#   2004/09/30 09:59:42+02:00 hare@lammermuir.suse.de 
#   When a device is disconnected, we should mark the state accordingly
#   and drop the packet as there is no device we could talk to.
#   Fix suggested by James Bottomley.
#   
#   Signed-off-by: Hannes Reinecke <hare@suse.de>
# 
# drivers/usb/storage/usb.c
#   2004/09/30 09:59:34+02:00 hare@lammermuir.suse.de +3 -2
#   Fix SCSI command handling on disconnect.
# 
diff -Nru a/drivers/usb/storage/usb.c b/drivers/usb/storage/usb.c
--- a/drivers/usb/storage/usb.c	2004-09-30 10:09:01 +02:00
+++ b/drivers/usb/storage/usb.c	2004-09-30 10:09:01 +02:00
@@ -320,7 +320,8 @@
 
 		/* don't do anything if we are disconnecting */
 		if (test_bit(US_FLIDX_DISCONNECTING, &us->flags)) {
-			US_DEBUGP("No command during disconnect\n");
+			US_DEBUGP("Ignoring command during disconnect\n");
+			us->srb->result = DID_NO_CONNECT << 16;
 			goto SkipForDisconnect;
 		}
 
@@ -374,6 +375,7 @@
 		/* lock access to the state */
 		scsi_lock(host);
 
+SkipForDisconnect:
 		/* indicate that the command is done */
 		if (us->srb->result != DID_ABORT << 16) {
 			US_DEBUGP("scsi cmd done, result=0x%x\n", 
@@ -393,7 +395,6 @@
 			complete(&(us->notify));
 
 		/* empty the queue, reset the state, and release the lock */
-SkipForDisconnect:
 		us->srb = NULL;
 		us->sm_state = US_STATE_IDLE;
 		scsi_unlock(host);
