ChangeSet
  1.1604 04/04/28 09:58:52 ink@jurassic.park.msu.ru[torvalds] +1 -0
  [PATCH] Fix rwsem contention case on alpha/s390x
  
  Thanks to Dru <andru@treshna.com>, who provided an easy way to reproduce
  the problem.
  
  What we have in lib/rwsem.c:__rwsem_do_wake():
  	int woken, loop;
  	^^^
  and several lines below:
  	loop = woken;
  	woken *= RWSEM_ACTIVE_BIAS-RWSEM_WAITING_BIAS;
  	woken -= RWSEM_ACTIVE_BIAS;
  
  However, rw_semaphore->count is 64-bit on Alpha, so
  RWSEM_WAITING_BIAS has been defined as -0x0000000100000000L.
  Obviously, this blows up in the write contention case.

  lib/rwsem.c
    1.11 04/04/27 13:04:14 ink@jurassic.park.msu.ru[torvalds] +1 -2
    Fix rwsem contention case on alpha/s390x

.........................................................................
diff -Nru a/lib/rwsem.c b/lib/rwsem.c
--- a/lib/rwsem.c	Wed Apr 28 21:20:44 2004
+++ b/lib/rwsem.c	Wed Apr 28 21:20:44 2004
@@ -41,8 +41,7 @@
 {
 	struct rwsem_waiter *waiter;
 	struct list_head *next;
-	signed long oldcount;
-	int woken, loop;
+	signed long oldcount, woken, loop;
 
 	rwsemtrace(sem,"Entering __rwsem_do_wake");
 
.........................................................................
# vim: syntax=diff

