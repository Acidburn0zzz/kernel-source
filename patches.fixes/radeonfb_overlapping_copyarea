Return-Path: <olaf@suse.de>
Received: from hermes.suse.de (hermes.suse.de [10.0.0.1])
	by wotan.suse.de (Postfix) with ESMTP id 12556105CE
	for <olh@wotan.suse.de>; Tue, 11 May 2004 07:56:23 +0200 (CEST)
Received: by hermes.suse.de (Postfix)
	id 0B39E400F6; Tue, 11 May 2004 07:56:23 +0200 (CEST)
Received: from mandarine.suse.de (mandarine.suse.de [10.10.3.21])
	by hermes.suse.de (Postfix) with ESMTP
	id 063913917E; Tue, 11 May 2004 07:56:23 +0200 (CEST)
Received: by mandarine.suse.de (Postfix, from userid 90)
	id E89F44685C; Tue, 11 May 2004 07:56:22 +0200 (CEST)
To: mantel@suse.de, olh@suse.de
Subject: Incoming changes to linux-2.5 cset 1.1623  mandarine.suse.de:/olaf/sources/tree/linux-2.5 
Message-Id: <20040511055622.E89F44685C@mandarine.suse.de>
Date: Tue, 11 May 2004 07:56:22 +0200 (CEST)
From: olaf@suse.de (Olaf Hering)
X-Spam-Checker-Version: SpamAssassin 2.63 (2004-01-11) on wotan.suse.de
X-Spam-Level: 
X-Spam-Status: No, hits=-4.8 required=5.0 tests=AWL,BAYES_00 autolearn=ham 
	version=2.63
Content-Length: 1801

old status OK
ChangeSet
  1.1623 04/05/10 16:54:27 eger@havoc.gtf.org[torvalds] +1 -0
  [PATCH] radeon: fix overlapping copyarea
  
  This fixes a corruption problem with overlapping copyarea()'s
  in the radeon driver.

  drivers/video/aty/radeon_accel.c
    1.4 04/04/18 16:49:14 eger@havoc.gtf.org[torvalds] +17 -4
    radeon: fix overlapping copyarea

.........................................................................
diff -Nru a/drivers/video/aty/radeon_accel.c b/drivers/video/aty/radeon_accel.c
--- a/drivers/video/aty/radeon_accel.c	Tue May 11 07:56:22 2004
+++ b/drivers/video/aty/radeon_accel.c	Tue May 11 07:56:22 2004
@@ -53,6 +53,18 @@
 static void radeonfb_prim_copyarea(struct radeonfb_info *rinfo, 
 				   const struct fb_copyarea *area)
 {
+	int xdir, ydir;
+	u32 sx, sy, dx, dy, w, h;
+
+	w = area->width; h = area->height;
+	dx = area->dx; dy = area->dy;
+	sx = area->sx; sy = area->sy;
+	xdir = sx - dx;
+	ydir = sy - dy;
+
+	if ( xdir < 0 ) { sx += w-1; dx += w-1; }
+	if ( ydir < 0 ) { sy += h-1; dy += h-1; }
+
 	radeon_fifo_wait(3);
 	OUTREG(DP_GUI_MASTER_CNTL,
 		rinfo->dp_gui_master_cntl /* i.e. GMC_DST_32BPP */
@@ -60,12 +72,13 @@
 		| ROP3_S 
 		| DP_SRC_RECT );
 	OUTREG(DP_WRITE_MSK, 0xffffffff);
-	OUTREG(DP_CNTL, (DST_X_LEFT_TO_RIGHT | DST_Y_TOP_TO_BOTTOM));
+	OUTREG(DP_CNTL, (xdir>=0 ? DST_X_LEFT_TO_RIGHT : 0)
+			| (ydir>=0 ? DST_Y_TOP_TO_BOTTOM : 0));
 
 	radeon_fifo_wait(3);
-	OUTREG(SRC_Y_X, (area->sy << 16) | area->sx);
-	OUTREG(DST_Y_X, (area->dy << 16) | area->dx);
-	OUTREG(DST_HEIGHT_WIDTH, (area->height << 16) | area->width);
+	OUTREG(SRC_Y_X, (sy << 16) | sx);
+	OUTREG(DST_Y_X, (dy << 16) | dx);
+	OUTREG(DST_HEIGHT_WIDTH, (h << 16) | w);
 }
 
 
.........................................................................
# vim: syntax=diff

