From: Mike Anderson <andmike@us.ibm.com>
Subject: Don't mask off TASK_ABORTED from the SCSI error status
References: 64150, LTC12947

The STATUS_MASK previously would have cleared TASK_ABORTED, so a
SCSI command could have returned a success error status, when
it actually failed.

Signed-off-by: Kurt Garloff <garloff@suse.de>

--- linux-2.6.8/include/scsi/scsi.h.orig	2004-11-29 13:32:39.000000000 +0100
+++ linux-2.6.8/include/scsi/scsi.h	2004-12-15 23:33:35.563661314 +0100
@@ -172,8 +172,10 @@
 #define RESERVATION_CONFLICT 0x0c
 #define COMMAND_TERMINATED   0x11
 #define QUEUE_FULL           0x14
+#define ACA_ACTIVE           0x18
+#define TASK_ABORTED         0x20
 
-#define STATUS_MASK          0x3e
+#define STATUS_MASK          0xfe
 
 /*
  *  SENSE KEYS
@@ -340,7 +342,7 @@
  *      host_byte   = set by low-level driver to indicate status.
  *      driver_byte = set by mid-level.
  */
-#define status_byte(result) (((result) >> 1) & 0x1f)
+#define status_byte(result) (((result) >> 1) & 0x7f)
 #define msg_byte(result)    (((result) >> 8) & 0xff)
 #define host_byte(result)   (((result) >> 16) & 0xff)
 #define driver_byte(result) (((result) >> 24) & 0xff)
