From: Jeff Mahoney <jeffm@suse.com>
Subject: [PATCH] reiserfs: discard prealloc in reiserfs_delete_inode
References: bnc#389656

 With the removal of struct file from the xattr code, reiserfs_file_release()
 isn't used anymore, so the prealloc isn't discarded. This causes hangs
 later down the line.

 This patch adds it to reiserfs_delete_inode. In most cases it will be
 a no-op, but will avoid hangs with xattrs.

Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 fs/reiserfs/inode.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/fs/reiserfs/inode.c
+++ b/fs/reiserfs/inode.c
@@ -45,6 +45,8 @@ void reiserfs_delete_inode(struct inode
 			goto out;
 		reiserfs_update_inode_transaction(inode);
 
+		reiserfs_discard_prealloc(&th, inode);
+
 		err = reiserfs_delete_object(&th, inode);
 
 		/* Do quota update inside a transaction for journaled quotas. We must do that
