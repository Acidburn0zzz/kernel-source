From: Jens Axboe <axboe@suse.de>
Subject: Fix race in io scheduler switching
Patch-mainline: 
References: 

Drop the queue_lock a little later, to avoid someone sneaking in and
submitting io in the small window before we enable the new io scheduler.

Acked-by: 
Signed-off-by: 

diff --git a/block/elevator.c b/block/elevator.c
index 8768a36..eca7e25 100644
--- a/block/elevator.c
+++ b/block/elevator.c
@@ -806,8 +806,6 @@ static int elevator_switch(request_queue
 		elv_drain_elevator(q);
 	}
 
-	spin_unlock_irq(q->queue_lock);
-
 	/*
 	 * unregister old elevator data
 	 */
@@ -820,6 +818,8 @@ static int elevator_switch(request_queue
 	if (elevator_attach(q, e))
 		goto fail;
 
+	spin_unlock_irq(q->queue_lock);
+
 	if (elv_register_queue(q))
 		goto fail_register;
 
@@ -837,8 +837,10 @@ fail_register:
 	 */
 	elevator_exit(e);
 	e = NULL;
+	spin_lock_irq(q->queue_lock);
 fail:
 	q->elevator = old_elevator;
+	spin_unlock_irq(q->queue_lock);
 	elv_register_queue(q);
 	clear_bit(QUEUE_FLAG_ELVSWITCH, &q->queue_flags);
 	if (e)
