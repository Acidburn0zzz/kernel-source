# Date: Fri, 14 May 2004 13:14:23 +1000 (EST)
# From: Nathan Scott <nathans@snort.melbourne.sgi.com>
# Subject: TAKE 914427 - jiffies to centisecs
# 
# Export/import tunable time intervals as centisecs not jiffies.
# 
# Date:  Thu May 13 20:13:52 PDT 2004
# Workarea:  snort.melbourne.sgi.com:/home/nathans/ultra-clean-xfs-linux
# Inspected by:  sandeen@sgi.com
# 
# The following file(s) were checked into:
#   bonnie.engr.sgi.com:/isms/xfs-kern/xfs-linux

Index: linux-2.6.5/fs/xfs/linux/xfs_buf.c
===================================================================
--- linux-2.6.5.orig/fs/xfs/linux/xfs_buf.c
+++ linux-2.6.5/fs/xfs/linux/xfs_buf.c
@@ -1596,6 +1596,7 @@ pagebuf_daemon(
 	void			*data)
 {
 	struct list_head	tmp;
+	unsigned long		age;
 	xfs_buf_t		*pb, *n;
 
 	/*  Set up the thread  */
@@ -1613,8 +1614,9 @@ pagebuf_daemon(
 			refrigerator(PF_IOTHREAD);
 
 		set_current_state(TASK_INTERRUPTIBLE);
-		schedule_timeout(xfs_flush_interval);
+		schedule_timeout((xfs_buf_timer_centisecs * HZ) / 100);
 
+		age = (xfs_buf_age_centisecs * HZ) / 100;
 		spin_lock(&pbd_delwrite_lock);
 		list_for_each_entry_safe(pb, n, &pbd_delwrite_queue, pb_list) {
 			PB_TRACE(pb, "walkq1", (long)pagebuf_ispin(pb));
@@ -1623,8 +1625,7 @@ pagebuf_daemon(
 			if (!pagebuf_ispin(pb) && !pagebuf_cond_lock(pb)) {
 				if (!force_flush &&
 				    time_before(jiffies,
-						pb->pb_queuetime +
-						xfs_age_buffer)) {
+						pb->pb_queuetime + age)) {
 					pagebuf_unlock(pb);
 					break;
 				}
Index: linux-2.6.5/fs/xfs/linux/xfs_globals.c
===================================================================
--- linux-2.6.5.orig/fs/xfs/linux/xfs_globals.c
+++ linux-2.6.5/fs/xfs/linux/xfs_globals.c
@@ -46,9 +46,9 @@ unsigned long xfs_physmem;
 
 /*
  * Tunable XFS parameters.  xfs_params is required even when CONFIG_SYSCTL=n,
- * other XFS code uses these values.
+ * other XFS code uses these values.  Times are measured in centisecs (i.e.
+ * 100ths of a second).
  */
-
 xfs_param_t xfs_params = {
 			  /*	MIN		DFLT		MAX	*/
 	.restrict_chown	= {	0,		1,		1	},
@@ -56,7 +56,7 @@ xfs_param_t xfs_params = {
 	.symlink_mode	= {	0,		0,		1	},
 	.panic_mask	= {	0,		0,		127	},
 	.error_level	= {	0,		3,		11	},
-	.sync_interval	= {	USER_HZ,	30*USER_HZ,	7200*USER_HZ },
+	.syncd_timer	= {	1*100,		30*100,		7200*100},
 	.probe_dmapi	= {	0,		1,		1	},
 	.probe_ioops	= {	0,		0,		1	},
 	.probe_quota	= {	0,		1,		1	},
@@ -64,8 +64,8 @@ xfs_param_t xfs_params = {
 	.inherit_sync	= {	0,		1,		1	},
 	.inherit_nodump	= {	0,		1,		1	},
 	.inherit_noatim = {	0,		1,		1	},
-	.flush_interval	= {	USER_HZ/2,	USER_HZ,	30*USER_HZ },
-	.age_buffer	= {	1*USER_HZ,	15*USER_HZ,	7200*USER_HZ },
+	.xfs_buf_timer	= {	100/2,		1*100,		30*100	},
+	.xfs_buf_age	= {	1*100,		15*100,		7200*100},
 };
 
 /*
Index: linux-2.6.5/fs/xfs/linux/xfs_linux.h
===================================================================
--- linux-2.6.5.orig/fs/xfs/linux/xfs_linux.h
+++ linux-2.6.5/fs/xfs/linux/xfs_linux.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2000-2003 Silicon Graphics, Inc.  All Rights Reserved.
+ * Copyright (c) 2000-2004 Silicon Graphics, Inc.  All Rights Reserved.
  *
  * This program is free software; you can redistribute it and/or modify it
  * under the terms of version 2 of the GNU General Public License as
@@ -127,14 +127,12 @@ static inline void set_buffer_unwritten_
 	bh->b_end_io = linvfs_unwritten_done;
 }
 
-#define xfs_refcache_size	xfs_params.refcache_size.val
-#define xfs_refcache_purge_count xfs_params.refcache_purge.val
 #define restricted_chown	xfs_params.restrict_chown.val
 #define irix_sgid_inherit	xfs_params.sgid_inherit.val
 #define irix_symlink_mode	xfs_params.symlink_mode.val
 #define xfs_panic_mask		xfs_params.panic_mask.val
 #define xfs_error_level		xfs_params.error_level.val
-#define xfs_syncd_interval	(xfs_params.sync_interval.val * HZ / USER_HZ)
+#define xfs_syncd_centisecs	xfs_params.syncd_timer.val
 #define xfs_probe_dmapi		xfs_params.probe_dmapi.val
 #define xfs_probe_ioops		xfs_params.probe_ioops.val
 #define xfs_probe_quota		xfs_params.probe_quota.val
@@ -142,8 +140,8 @@ static inline void set_buffer_unwritten_
 #define xfs_inherit_sync	xfs_params.inherit_sync.val
 #define xfs_inherit_nodump	xfs_params.inherit_nodump.val
 #define xfs_inherit_noatime	xfs_params.inherit_noatim.val
-#define xfs_flush_interval	(xfs_params.flush_interval.val * HZ / USER_HZ)
-#define xfs_age_buffer		(xfs_params.age_buffer.val * HZ / USER_HZ)
+#define xfs_buf_timer_centisecs	xfs_params.xfs_buf_timer.val
+#define xfs_buf_age_centisecs	xfs_params.xfs_buf_age.val
 
 #define current_cpu()		smp_processor_id()
 #define current_pid()		(current->pid)
Index: linux-2.6.5/fs/xfs/linux/xfs_super.c
===================================================================
--- linux-2.6.5.orig/fs/xfs/linux/xfs_super.c
+++ linux-2.6.5/fs/xfs/linux/xfs_super.c
@@ -405,7 +405,7 @@ xfssyncd(
 
 	for (;;) {
 		set_current_state(TASK_INTERRUPTIBLE);
-		schedule_timeout(xfs_syncd_interval);
+		schedule_timeout((xfs_syncd_centisecs * HZ) / 100);
 		/* swsusp */
 		if (current->flags & PF_FREEZE)
 			refrigerator(PF_IOTHREAD);
Index: linux-2.6.5/fs/xfs/linux/xfs_sysctl.c
===================================================================
--- linux-2.6.5.orig/fs/xfs/linux/xfs_sysctl.c
+++ linux-2.6.5/fs/xfs/linux/xfs_sysctl.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2001-2002 Silicon Graphics, Inc.  All Rights Reserved.
+ * Copyright (c) 2001-2004 Silicon Graphics, Inc.  All Rights Reserved.
  *
  * This program is free software; you can redistribute it and/or modify it
  * under the terms of version 2 of the GNU General Public License as
@@ -98,10 +98,10 @@ STATIC ctl_table xfs_table[] = {
 	&sysctl_intvec, NULL, 
 	&xfs_params.error_level.min, &xfs_params.error_level.max},
 
-	{XFS_SYNC_INTERVAL, "sync_interval", &xfs_params.sync_interval.val,
+	{XFS_SYNCD_TIMER, "xfssyncd_centisecs", &xfs_params.syncd_timer.val,
 	sizeof(int), 0644, NULL, &proc_dointvec_minmax,
 	&sysctl_intvec, NULL, 
-	&xfs_params.sync_interval.min, &xfs_params.sync_interval.max},
+	&xfs_params.syncd_timer.min, &xfs_params.syncd_timer.max},
 
 	{XFS_PROBE_DMAPI, "probe_dmapi", &xfs_params.probe_dmapi.val,
 	sizeof(int), 0644, NULL, &proc_dointvec_minmax,
@@ -133,15 +133,15 @@ STATIC ctl_table xfs_table[] = {
 	&sysctl_intvec, NULL,
 	&xfs_params.inherit_noatim.min, &xfs_params.inherit_noatim.max},
 	
-	{XFS_FLUSH_INTERVAL, "flush_interval", &xfs_params.flush_interval.val,
+	{XFS_BUF_TIMER, "xfsbufd_centisecs", &xfs_params.xfs_buf_timer.val,
 	sizeof(int), 0644, NULL, &proc_dointvec_minmax,
 	&sysctl_intvec, NULL,
-	&xfs_params.flush_interval.min, &xfs_params.flush_interval.max},
+	&xfs_params.xfs_buf_timer.min, &xfs_params.xfs_buf_timer.max},
 
-	{XFS_AGE_BUFFER, "age_buffer", &xfs_params.age_buffer.val,
+	{XFS_BUF_AGE, "age_buffer_centisecs", &xfs_params.xfs_buf_age.val,
 	sizeof(int), 0644, NULL, &proc_dointvec_minmax,
 	&sysctl_intvec, NULL,
-	&xfs_params.age_buffer.min, &xfs_params.age_buffer.max},
+	&xfs_params.xfs_buf_age.min, &xfs_params.xfs_buf_age.max},
 
 	/* please keep this the last entry */
 #ifdef CONFIG_PROC_FS
Index: linux-2.6.5/fs/xfs/linux/xfs_sysctl.h
===================================================================
--- linux-2.6.5.orig/fs/xfs/linux/xfs_sysctl.h
+++ linux-2.6.5/fs/xfs/linux/xfs_sysctl.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2001-2002 Silicon Graphics, Inc.  All Rights Reserved.
+ * Copyright (c) 2001-2004 Silicon Graphics, Inc.  All Rights Reserved.
  *
  * This program is free software; you can redistribute it and/or modify it
  * under the terms of version 2 of the GNU General Public License as
@@ -47,13 +47,12 @@ typedef struct xfs_sysctl_val {
 
 typedef struct xfs_param {
 	xfs_sysctl_val_t restrict_chown;/* Root/non-root can give away files.*/
-	xfs_sysctl_val_t sgid_inherit;	/* Inherit S_ISGID bit if process' GID 
-					 * is not a member of the parent dir
-					 * GID */
+	xfs_sysctl_val_t sgid_inherit;	/* Inherit S_ISGID if process' GID is
+					 * not a member of parent dir GID. */
 	xfs_sysctl_val_t symlink_mode;	/* Link creat mode affected by umask */
 	xfs_sysctl_val_t panic_mask;	/* bitmask to cause panic on errors. */
 	xfs_sysctl_val_t error_level;	/* Degree of reporting for problems  */
-	xfs_sysctl_val_t sync_interval;	/* time between sync calls           */
+	xfs_sysctl_val_t syncd_timer;	/* Interval between xfssyncd wakeups */
 	xfs_sysctl_val_t stats_clear;	/* Reset all XFS statistics to zero. */
 	xfs_sysctl_val_t probe_dmapi;	/* probe for DMAPI module on mount. */
 	xfs_sysctl_val_t probe_ioops;	/* probe for an IO module on mount. */
@@ -61,10 +60,8 @@ typedef struct xfs_param {
 	xfs_sysctl_val_t inherit_sync;	/* Inherit the "sync" inode flag. */
 	xfs_sysctl_val_t inherit_nodump;/* Inherit the "nodump" inode flag. */
 	xfs_sysctl_val_t inherit_noatim;/* Inherit the "noatime" inode flag. */
-	xfs_sysctl_val_t flush_interval;/* interval between runs of the
-					 * delwri flush daemon.  */
-	xfs_sysctl_val_t age_buffer;	/* time for buffer to age before
-					 * we flush it.  */
+	xfs_sysctl_val_t xfs_buf_timer;	/* Interval between xfsbufd wakeups. */
+	xfs_sysctl_val_t xfs_buf_age;	/* Metadata buffer age before flush. */
 } xfs_param_t;
 
 /*
@@ -83,12 +80,14 @@ typedef struct xfs_param {
  */
 
 enum {
+	/* XFS_REFCACHE_SIZE = 1 */
+	/* XFS_REFCACHE_PURGE = 2 */
 	XFS_RESTRICT_CHOWN = 3,
 	XFS_SGID_INHERIT = 4,
 	XFS_SYMLINK_MODE = 5,
 	XFS_PANIC_MASK = 6,
 	XFS_ERRLEVEL = 7,
-	XFS_SYNC_INTERVAL = 8,
+	XFS_SYNCD_TIMER = 8,
 	XFS_PROBE_DMAPI = 9,
 	XFS_PROBE_IOOPS = 10,
 	XFS_PROBE_QUOTA = 11,
@@ -96,8 +95,9 @@ enum {
 	XFS_INHERIT_SYNC = 13,
 	XFS_INHERIT_NODUMP = 14,
 	XFS_INHERIT_NOATIME = 15,
-	XFS_FLUSH_INTERVAL = 16,
-	XFS_AGE_BUFFER = 17,
+	XFS_BUF_TIMER = 16,
+	XFS_BUF_AGE = 17,
+	/* XFS_IO_BYPASS = 18 */
 };
 
 extern xfs_param_t	xfs_params;
Index: linux-2.6.5/fs/xfs/xfsidbg.c
===================================================================
--- linux-2.6.5.orig/fs/xfs/xfsidbg.c
+++ linux-2.6.5/fs/xfs/xfsidbg.c
@@ -2484,8 +2484,10 @@ kdbm_pb_flags(int argc, const char **arg
 static void
 print_pagebuf(
 	xfs_buf_t	*pb,
-	unsigned long addr)
+	unsigned long	addr)
 {
+	unsigned long	age = (xfs_buf_age_centisecs * HZ) / 100;
+
 	kdb_printf("xfs_buf_t at 0x%lx\n", addr);
 	kdb_printf("  pb_flags %s\n", pb_flags(pb->pb_flags));
 	kdb_printf("  pb_target 0x%p pb_hold %d pb_next 0x%p pb_prev 0x%p\n",
@@ -2500,15 +2502,15 @@ print_pagebuf(
 		   (unsigned long long) pb->pb_file_offset,
 		   (unsigned long long) pb->pb_buffer_length,
 		   pb->pb_addr);
-	kdb_printf("  pb_bn 0x%Lx pb_count_desired 0x%lx pb_locked %d\n",
-		   pb->pb_bn,
+	kdb_printf("  pb_bn 0x%llx pb_count_desired 0x%lx pb_locked %d\n",
+		   (unsigned long long)pb->pb_bn,
 		   (unsigned long) pb->pb_count_desired, (int)pb->pb_locked);
-	kdb_printf("  pb_queuetime %ld (%ld/%ld) pb_io_remaining %d pb_error %u\n",
-		   pb->pb_queuetime, jiffies, pb->pb_queuetime + xfs_age_buffer,
-		   pb->pb_io_remaining.counter, pb->pb_error);
-	kdb_printf("  pb_page_count %u pb_offset 0x%x pb_pages 0x%p\n",
+	kdb_printf("  pb_queuetime %ld (now=%ld/age=%ld) pb_io_remaining %d\n",
+		   pb->pb_queuetime, jiffies, pb->pb_queuetime + age,
+		   pb->pb_io_remaining.counter);
+	kdb_printf("  pb_page_count %u pb_offset 0x%x pb_pages 0x%p pb_error %u\n",
 		   pb->pb_page_count, pb->pb_offset,
-		   pb->pb_pages);
+		   pb->pb_pages, pb->pb_error);
 #if 0
 	kdb_printf("  pb_iodonesema (%d,%d) pb_sema (%d,%d) pincount (%d)\n",
 		   pb->pb_iodonesema.count.counter,
