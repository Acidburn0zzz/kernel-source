Date: Wed, 28 Apr 2004 05:14:25 +1000
From: Anton Blanchard <anton@samba.org>
To: olh@suse.de
Subject: e100/e1000 mb patch


Hi,

We need mb to order between cacheable and non cacheable accesses.
This is in reference to LTC 7055.

Longer term I will try and push for the addition of io_barrier into
Linux but this will fix things in the mean time.

Anton

another one needed in e1000_clean_tx_irq()  (#41111 - LTC8539)

--- linux-2.6.5/drivers/net/e1000/e1000_main.c~	2004-04-28 01:44:25.516475999 +1000
+++ linux-2.6.5/drivers/net/e1000/e1000_main.c	2004-04-28 01:44:43.411742230 +1000
@@ -1773,7 +1773,7 @@
 	 * know there are new descriptors to fetch.  (Only
 	 * applicable for weak-ordered memory model archs,
 	 * such as IA-64). */
-	wmb();
+	mb();
 
 	tx_ring->next_to_use = i;
 	E1000_WRITE_REG(&adapter->hw, TDT, i);
@@ -2256,6 +2256,8 @@ e1000_clean_tx_irq(struct e1000_adapter 
 					       buffer_info->length,
 					       PCI_DMA_TODEVICE);
 
+				wmb();
+
 				buffer_info->dma = 0;
 			}
 
@@ -2488,7 +2488,7 @@
 			 * know there are new descriptors to fetch.  (Only
 			 * applicable for weak-ordered memory model archs,
 			 * such as IA-64). */
-			wmb();
+			mb();
 
 			E1000_WRITE_REG(&adapter->hw, RDT, i);
 		}

