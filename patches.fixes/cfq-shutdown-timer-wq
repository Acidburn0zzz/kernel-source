From: Jens Axboe <axboe@suse.de>
Subject: Shutdown pending timer/wq from both last put and exit case
Patch-mainline: 
References: 

See subject

Acked-by: 
Signed-off-by: 

--- linux-2.6.11/drivers/block/cfq-iosched.c~	2005-03-17 15:39:09.000000000 +0100
+++ linux-2.6.11/drivers/block/cfq-iosched.c	2005-03-17 15:40:28.000000000 +0100
@@ -2100,6 +2100,12 @@
 	spin_unlock_irqrestore(cfqd->queue->queue_lock, flags);
 }
 
+static void cfq_shutdown_timer_wq(struct cfq_data *cfqd)
+{
+	del_timer_sync(&cfqd->idle_slice_timer);
+	del_timer_sync(&cfqd->idle_class_timer);
+	blk_sync_queue(cfqd->queue);
+}
 
 static void cfq_put_cfqd(struct cfq_data *cfqd)
 {
@@ -2108,7 +2114,7 @@
 	if (!atomic_dec_and_test(&cfqd->ref))
 		return;
 
-	blk_sync_queue(q);
+	cfq_shutdown_timer_wq(cfqd);
 
 	blk_put_queue(q);
 
@@ -2122,8 +2128,7 @@
 {
 	struct cfq_data *cfqd = e->elevator_data;
 
-	del_timer_sync(&cfqd->idle_slice_timer);
-	del_timer_sync(&cfqd->idle_class_timer);
+	cfq_shutdown_timer_wq(cfqd);
 	cfq_put_cfqd(cfqd);
 }
 
