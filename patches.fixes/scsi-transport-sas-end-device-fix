From: Jeremy Higdon <jeremy@sgi.com>
Subject: SAS transport panic after removing and adding disks
References: 185327
Patch-Mainline: yes

I had been using Maxtor disks, but needed to switch to testing Seagates.  So 
we pulled the Maxtor disks and inserted the Seagates.  I noticed that the 
SCSI layer at that point thought that I had 16 disks on channel 0 and 8 on 
channel 4 (the second wide port on the 1068).  It should have been 12 on each. 
So I thought, "let's do a scan".  So I scanned the interface with

echo - - - > /sys/class/scsi_host/host1/scan

and was rewarded with a panic in sas_read_port_mode_page():

        BUG_ON(rphy->identify.device_type != SAS_END_DEVICE);

Apparently, the SAS transport had gotten confused and had thought that the
Seagate disk was an Expander. 

Signed-off-by: Hannes Reinecke <hare@suse.de>
Signed-off-by: Chris Mason <mason@suse.de>

--- a/drivers/scsi/scsi_transport_sas.c	2006-06-15 16:11:39.000000000 -0700
+++ b/drivers/scsi/scsi_transport_sas.c	2006-06-15 16:00:23.353581889 -0700
@@ -955,7 +955,8 @@
 	list_for_each_entry(rphy, &sas_host->rphy_list, list) {
 		struct sas_phy *parent = dev_to_phy(rphy->dev.parent);
 
-		if (rphy->scsi_target_id == -1)
+		if (rphy->identify.device_type != SAS_END_DEVICE ||
+		    rphy->scsi_target_id == -1)
 			continue;
 
 		if ((channel == SCAN_WILD_CARD || channel == parent->port_identifier) &&
