#date: 2004-04-21
#from: Yury Umanets <torque@ukrpost.net>
#id: 1.1371.737.20
#tag: via-mm
#time: 07:44:58
#title: loop_set_fd() sendfile check fix
#who: akpm@osdl.org[torvalds]
#
# ChangeSet
#   1.1371.737.20 04/04/21 07:44:58 akpm@osdl.org[torvalds] +1 -0
#   [PATCH] loop_set_fd() sendfile check fix
#   
#   From: Yury Umanets <torque@ukrpost.net>
#   
#   I have found small inconsistency in loop_set_fd().  It checks if
#   ->sendfile() is implemented for passed block device file.  But in fact,
#   loop back device driver never calls it.  It uses ->sendfile() from backing
#   store file.
#
# drivers/block/loop.c +1 -1
#
diff -Nru a/drivers/block/loop.c b/drivers/block/loop.c
--- a/drivers/block/loop.c	Wed Apr 28 10:53:22 2004
+++ b/drivers/block/loop.c	Wed Apr 28 10:53:22 2004
@@ -656,7 +656,7 @@
 		 * If we can't read - sorry. If we only can't write - well,
 		 * it's going to be read-only.
 		 */
-		if (!lo_file->f_op->sendfile)
+		if (!file->f_op->sendfile)
 			goto out_putf;
 
 		if (!aops->prepare_write || !aops->commit_write)
