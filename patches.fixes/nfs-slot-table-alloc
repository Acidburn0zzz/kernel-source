From: Michal Hocko <mhocko@novell.com>
Subject: Don't fail allocations for the slot table when mounting an NFS filesystem
Patch-mainline: no
References: bnc#519820

When the *_slot_table_entries exceeds 111, the slot_table_size
exceeds 32K and an order-4 allocation is forced.  This does not
retry nearly as much as order-3 so failure is more likely.
But mount and autofs in particular doesn't cope well with failure.
So force __GFP_REPEAT - the assumption is that people will only
set the slot_table_size sysctl large on a machine with plenty
of memory, so this should not block indefinitely.

Acked-by: Neil Brown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 net/sunrpc/xprtsock.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

--- linux-2.6.16-SLES10_SP3_BRANCH.orig/net/sunrpc/xprtsock.c
+++ linux-2.6.16-SLES10_SP3_BRANCH/net/sunrpc/xprtsock.c
@@ -1262,7 +1262,7 @@ int xs_setup_udp(struct rpc_xprt *xprt, 
 
 	xprt->max_reqs = xprt_udp_slot_table_entries;
 	slot_table_size = xprt->max_reqs * sizeof(xprt->slot[0]);
-	xprt->slot = kmalloc(slot_table_size, GFP_KERNEL);
+	xprt->slot = kmalloc(slot_table_size, GFP_KERNEL | __GFP_REPEAT);
 	if (xprt->slot == NULL)
 		return -ENOMEM;
 	memset(xprt->slot, 0, slot_table_size);
@@ -1305,7 +1305,7 @@ int xs_setup_tcp(struct rpc_xprt *xprt, 
 
 	xprt->max_reqs = xprt_tcp_slot_table_entries;
 	slot_table_size = xprt->max_reqs * sizeof(xprt->slot[0]);
-	xprt->slot = kmalloc(slot_table_size, GFP_KERNEL);
+	xprt->slot = kmalloc(slot_table_size, GFP_KERNEL | __GFP_REPEAT);
 	if (xprt->slot == NULL)
 		return -ENOMEM;
 	memset(xprt->slot, 0, slot_table_size);
