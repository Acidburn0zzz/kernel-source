# This is a BitKeeper generated diff -Nru style patch.
#
# ChangeSet
#   2004/06/28 16:49:17-05:00 stevef@stevef95.austin.ibm.com 
#   hash cifs inodes
#   
#   Signed-off-by: Steve French (sfrench@us.ibm.com)
# 
# fs/cifs/file.c
#   2004/06/28 16:49:08-05:00 stevef@stevef95.austin.ibm.com +2 -0
#   hash cifs inodes
# 
# fs/cifs/inode.c
#   2004/06/28 16:49:08-05:00 stevef@stevef95.austin.ibm.com +6 -5
#   hash cifs inodes
# 
Index: linux-2.6.5/fs/cifs/file.c
===================================================================
--- linux-2.6.5.orig/fs/cifs/file.c
+++ linux-2.6.5/fs/cifs/file.c
@@ -1497,6 +1497,7 @@ construct_dentry(struct qstr *qstring, s
 			if(*ptmp_inode == NULL)
 				return;
 			d_instantiate(tmp_dentry, *ptmp_inode);
+			insert_inode_hash(*ptmp_inode);
 		}
 	} else {
 		tmp_dentry = d_alloc(file->f_dentry, qstring);
@@ -1514,6 +1515,7 @@ construct_dentry(struct qstr *qstring, s
 			return;
 		d_instantiate(tmp_dentry, *ptmp_inode);
 		d_rehash(tmp_dentry);
+		insert_inode_hash(*ptmp_inode);
 	}
 
 	tmp_dentry->d_time = jiffies;
Index: linux-2.6.5/fs/cifs/inode.c
===================================================================
--- linux-2.6.5.orig/fs/cifs/inode.c
+++ linux-2.6.5/fs/cifs/inode.c
@@ -85,6 +85,9 @@ cifs_get_inode_info_unix(struct inode **
 		/* get new inode */
 		if (*pinode == NULL) {
 			*pinode = new_inode(sb);
+			if(*pinode == NULL)
+				return -ENOMEM;
+			insert_inode_hash(*pinode);
 		}
 		inode = *pinode;
 
@@ -244,6 +247,9 @@ cifs_get_inode_info(struct inode **pinod
 		/* get new inode */
 		if (*pinode == NULL) {
 			*pinode = new_inode(sb);
+			if(*pinode == NULL)
+				return -ENOMEM;
+			insert_inode_hash(*pinode);
 		}
 
 		inode = *pinode;
