# Fix for #35148
# Submitted to akpm Mar 23, 2004
# The check for signals pending should only check for "shutdown" signals.
#
diff -ruNp linux-2.6.4/fs/autofs/root.c linux-2.6.4.autofs/fs/autofs/root.c
--- linux-2.6.4/fs/autofs/root.c	2004-03-10 21:55:27.000000000 -0500
+++ linux-2.6.4.autofs/fs/autofs/root.c	2004-03-23 10:38:27.607010457 -0500
@@ -238,9 +238,15 @@ static struct dentry *autofs_root_lookup
 	 * a signal. If so we can force a restart..
 	 */
 	if (dentry->d_flags & DCACHE_AUTOFS_PENDING) {
+		/* See if we were interrupted */
 		if (signal_pending(current)) {
-			unlock_kernel();
-			return ERR_PTR(-ERESTARTNOINTR);
+			sigset_t *sigset = &current->pending.signal;
+			if (sigismember (sigset, SIGKILL) ||
+			    sigismember (sigset, SIGQUIT) ||
+			    sigismember (sigset, SIGINT)) {
+				unlock_kernel();
+				return ERR_PTR(-ERESTARTNOINTR);
+			}
 		}
 	}
 	unlock_kernel();
diff -ruNp linux-2.6.4/fs/autofs4/root.c linux-2.6.4.autofs/fs/autofs4/root.c
--- linux-2.6.4/fs/autofs4/root.c	2004-03-10 21:55:21.000000000 -0500
+++ linux-2.6.4.autofs/fs/autofs4/root.c	2004-03-23 10:39:02.217761667 -0500
@@ -285,9 +285,15 @@ static struct dentry *autofs4_root_looku
 	 * a signal. If so we can force a restart..
 	 */
 	if (dentry->d_flags & DCACHE_AUTOFS_PENDING) {
+		/* See if we were interrupted */
 		if (signal_pending(current)) {
-			unlock_kernel();
-			return ERR_PTR(-ERESTARTNOINTR);
+			sigset_t *sigset = &current->pending.signal;
+			if (sigismember (sigset, SIGKILL) ||
+			    sigismember (sigset, SIGQUIT) ||
+			    sigismember (sigset, SIGINT)) {
+				unlock_kernel();
+				return ERR_PTR(-ERESTARTNOINTR);
+			}
 		}
 	}
 	unlock_kernel();
