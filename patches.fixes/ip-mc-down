# This is a BitKeeper generated diff -Nru style patch.
#
# ChangeSet
#   2004/03/25 15:06:22-08:00 davem@nuts.davemloft.net 
#   [IGMP]: Do nothing in ip_mc_down() if ip_mc_up() was not called previously.
# 
# net/ipv4/igmp.c
#   2004/03/25 15:06:10-08:00 davem@nuts.davemloft.net +5 -0
#   [IGMP]: Do nothing in ip_mc_down() if ip_mc_up() was not called previously.
# 
# include/linux/inetdevice.h
#   2004/03/25 15:06:10-08:00 davem@nuts.davemloft.net +2 -0
#   [IGMP]: Do nothing in ip_mc_down() if ip_mc_up() was not called previously.
# 
diff -Nru a/include/linux/inetdevice.h b/include/linux/inetdevice.h
--- a/include/linux/inetdevice.h	Fri Mar 26 08:30:24 2004
+++ b/include/linux/inetdevice.h	Fri Mar 26 08:30:24 2004
@@ -36,6 +36,8 @@
 	rwlock_t		lock;
 	int			dead;
 	struct in_ifaddr	*ifa_list;	/* IP ifaddr chain		*/
+	int			mc_initted;
+
 	struct ip_mc_list	*mc_list;	/* IP multicast filter chain    */
 	rwlock_t		mc_lock;	/* for mc_tomb */
 	struct ip_mc_list	*mc_tomb;
diff -Nru a/net/ipv4/igmp.c b/net/ipv4/igmp.c
--- a/net/ipv4/igmp.c	Fri Mar 26 08:30:24 2004
+++ b/net/ipv4/igmp.c	Fri Mar 26 08:30:24 2004
@@ -1217,6 +1217,9 @@
 
 	ASSERT_RTNL();
 
+	if (!in_dev->mc_initted)
+		return;
+
 #ifdef CONFIG_IP_MULTICAST
 	in_dev->mr_ifc_count = 0;
 	if (del_timer(&in_dev->mr_ifc_timer))
@@ -1262,6 +1265,8 @@
 
 	for (i=in_dev->mc_list; i; i=i->next)
 		igmp_group_added(i);
+
+	in_dev->mc_initted = 1;
 }
 
 /*
