From: Olaf Kirch <okir@suse.de>
Subject: VLAN over bonding: allow non-VLAN traffic to pass
References: SUSE50709

Normal network traffic over a bonding interface would stop as soon as
a VLAN interface was set up. This patch allows non-VLAN traffic even in
the presence of a configured VLAN interface.

Index: linux-2.6.10/drivers/net/bonding/bond_main.c
===================================================================
--- linux-2.6.10.orig/drivers/net/bonding/bond_main.c
+++ linux-2.6.10/drivers/net/bonding/bond_main.c
@@ -807,15 +807,10 @@ struct vlan_entry *bond_next_vlan(struct
 int bond_dev_queue_xmit(struct bonding *bond, struct sk_buff *skb, struct net_device *slave_dev)
 {
 	unsigned short vlan_id;
-	int res;
 
 	if (!list_empty(&bond->vlan_list) &&
-	    !(slave_dev->features & NETIF_F_HW_VLAN_TX)) {
-		res = vlan_get_tag(skb, &vlan_id);
-		if (res) {
-			return -EINVAL;
-		}
-
+	    !(slave_dev->features & NETIF_F_HW_VLAN_TX) &&
+	    vlan_get_tag(skb, &vlan_id) == 0) {
 		skb->dev = slave_dev;
 		skb = vlan_put_tag(skb, vlan_id);
 		if (!skb) {

