From: Urban Widmark
Subject: Security fix for 2.6 smbfs
References: 46204

This patch fixes a kernel memory exposure in the smbfs client that
can be triggered through CIFS fragment rebuilding.


Index: linux-2.6.8/fs/smbfs/request.c
===================================================================
--- linux-2.6.8.orig/fs/smbfs/request.c	2004-10-21 12:26:16.000000000 +0200
+++ linux-2.6.8/fs/smbfs/request.c	2004-10-21 12:28:40.000000000 +0200
@@ -634,6 +634,7 @@
 		req->rq_trans2buffer = smb_kmalloc(buf_len, GFP_NOFS);
 		if (!req->rq_trans2buffer)
 			goto out_no_mem;
+		memset(req->rq_trans2buffer, 0, buf_len);
 
 		req->rq_parm = req->rq_trans2buffer;
 		req->rq_data = req->rq_trans2buffer + parm_tot;
@@ -657,8 +658,11 @@
 	 * Check whether we've received all of the data. Note that
 	 * we use the packet totals -- total lengths might shrink!
 	 */
-	if (req->rq_ldata >= data_tot && req->rq_lparm >= parm_tot)
+	if (req->rq_ldata >= data_tot && req->rq_lparm >= parm_tot) {
+		req->rq_ldata = data_tot;
+		req->rq_lparm = parm_tot;
 		return 0;
+	}
 	return 1;
 
 out_too_long:
