mason@suse.com

bug #37758

block_write_full_page might see and lock clean metadata buffers, which leads
to journal-1777 messages.  Change the message to ignore bh locked.

Index: linux.t/fs/reiserfs/journal.c
===================================================================
--- linux.t.orig/fs/reiserfs/journal.c	2004-04-01 10:31:37.475834875 -0500
+++ linux.t/fs/reiserfs/journal.c	2004-04-01 10:34:54.825213190 -0500
@@ -2705,7 +2705,7 @@ int journal_mark_dirty(struct reiserfs_t
   ** a dirty or journal_dirty or locked buffer to be logged, as some changes
   ** could get to disk too early.  NOT GOOD.
   */
-  if (!prepared || buffer_locked(bh) || buffer_dirty(bh)) {
+  if (!prepared || buffer_dirty(bh)) {
     reiserfs_warning (p_s_sb, "journal-1777: buffer %llu bad state "
 		      "%cPREPARED %cLOCKED %cDIRTY %cJDIRTY_WAIT",
 		      (unsigned long long)bh->b_blocknr, prepared ? ' ' : '!', 
Index: linux.t/fs/reiserfs/do_balan.c
===================================================================
--- linux.t.orig/fs/reiserfs/do_balan.c	2004-04-16 15:58:43.000000000 -0400
+++ linux.t/fs/reiserfs/do_balan.c	2004-04-18 20:52:18.000000000 -0400
@@ -1341,7 +1341,8 @@ static void check_internal_node (struct 
 
 static int locked_or_not_in_tree (struct buffer_head * bh, char * which)
 {
-  if ( buffer_locked (bh) || !B_IS_IN_TREE (bh) ) {
+  if ( (!reiserfs_buffer_prepared(bh) && buffer_locked (bh)) || 
+        !B_IS_IN_TREE (bh) ) {
     reiserfs_warning (NULL, "vs-12339: locked_or_not_in_tree: %s (%b)",
                       which, bh);
     return 1;
