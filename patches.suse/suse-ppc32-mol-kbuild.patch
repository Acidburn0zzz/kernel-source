From: olh@suse.de
Subject: kbuild part

 drivers/macintosh/Kconfig      |    6 +++
 drivers/macintosh/Makefile     |    2 +
 drivers/macintosh/mol/Makefile |   80 +++++++++++++++++++++++++++++++++++++++++
 3 files changed, 88 insertions(+)

Index: linux-2.6.12/drivers/macintosh/Makefile
===================================================================
--- linux-2.6.12.orig/drivers/macintosh/Makefile
+++ linux-2.6.12/drivers/macintosh/Makefile
@@ -4,6 +4,8 @@
 
 # Each configuration option enables a list of files.
 
+obj-$(CONFIG_MACONLINUX)	+= mol/
+
 obj-$(CONFIG_PPC_PMAC)		+= macio_asic.o macio_sysfs.o
 
 obj-$(CONFIG_PMAC_MEDIABAY)	+= mediabay.o
Index: linux-2.6.12/drivers/macintosh/Kconfig
===================================================================
--- linux-2.6.12.orig/drivers/macintosh/Kconfig
+++ linux-2.6.12/drivers/macintosh/Kconfig
@@ -173,4 +173,10 @@ config ANSLCD
 	tristate "Support for ANS LCD display"
 	depends on ADB_CUDA && PPC_PMAC
 
+config MACONLINUX
+	tristate "Mac on Linux kernel module"
+	depends on PPC32 && PPC_PMAC && !SMP
+	help
+	  call helpdesk
+
 endmenu
Index: linux-2.6.12/drivers/macintosh/mol/Makefile
===================================================================
--- /dev/null
+++ linux-2.6.12/drivers/macintosh/mol/Makefile
@@ -0,0 +1,80 @@
+
+MOL_OBJS =	\
+		_fault.o \
+		_dev.o \
+		_misc.o \
+		_mmu.o \
+		init.o \
+		emu.o \
+		mmu.o \
+		mmu_fb.o \
+		mmu_io.o \
+		mmu_tracker.o \
+		skiplist.o \
+		mtable.o \
+		fault.o \
+		context.o \
+		ptaccess.o \
+		misc.o \
+		_traps.o \
+		hook.o \
+		_actions.o \
+		_performance.o \
+
+
+mol-objs	:= $(MOL_OBJS)
+obj-m		:= mol.o _kuname.o sheep.o
+
+RELBUILD	= $(obj)/relbuild.tmp.pl
+MOL_INCLUDE_DIR = $(srctree)/$(src)/include
+MOL_ASMFLAGS    = $(ASMFLAGS) $(INCLUDES) -D__ASSEMBLY__ -D__KERNEL__
+EXTRA_CFLAGS	= -I$(MOL_INCLUDE_DIR)
+
+$(obj)/asm_offsets.c:	$(srctree)/$(src)/asm_offsets.c $(MOL_INCLUDE_DIR)/asm_offsets.h
+	rm -f $@
+	cat $(srctree)/$(src)/asm_offsets.c $(MOL_INCLUDE_DIR)/asm_offsets.h > $@
+
+$(obj)/hook.o:		$(obj)/include/reloc_table.h
+$(obj)/_traps.o:	$(obj)/asm_offsets.h $(srctree)/$(src)/asm-files/traps.S $(srctree)/$(src)/asm-files/*.S
+
+$(obj)/include/reloc_table.h: $(obj)/_traps.o
+	$(RM) -fv $@ $@.tmp ; echo "/* WARNING! DO NOT EDIT! AUTOMATICALLY GENERATED! */" > $@.tmp
+	$(RM) -fv $(RELBUILD)
+	echo "#!/usr/bin/perl -w" > $(RELBUILD)
+	echo '$$'"NM = '$(NM)';" >> $(RELBUILD)
+	echo '$$'"OBJDUMP = '$(OBJDUMP)';" >> $(RELBUILD)
+	echo '$$'"GCC = '$(CC)  -D__KERNEL__ $(CFLAGS) $(LINUXINCLUDE) -I$(MOL_INCLUDE_DIR) -I$(src)';" >> $(RELBUILD)
+	echo '$$'"ARCH = 'ppc';" >> $(RELBUILD)
+	cat $(srctree)/$(src)/relbuild.pl >> $(RELBUILD)
+	perl $(RELBUILD) $< $(srctree)/$(src)/asm-files/traps.S >> $@.tmp
+	$(STRIP) -S -x $<
+	mv -v $@.tmp $@
+
+$(obj)/_%.o: $(src)/asm-files/%.S
+	echo "  AS [x]   $@"
+	$(RM) $@ $@.s
+	$(CPP) $(LINUXINCLUDE) -I$(MOL_INCLUDE_DIR) -I$(src) $(MOL_ASMFLAGS) $< | m4 > $@.m4
+	cat $@.m4 > $@.s
+	$(AS) $@.s $(AS_FLAGS) -o $@
+	$(RM) $@.s $@.m4
+
+$(obj)/asm_offsets.h:   $(MOL_INCLUDE_DIR)/archinclude.h $(MOL_INCLUDE_DIR)/kernel_vars.h $(MOL_INCLUDE_DIR)/mac_registers.h
+$(obj)/asm_offsets.h:   $(srctree)/$(src)/asm_offsets.c $(MOL_INCLUDE_DIR)/asm_offsets.inc
+	$(RM) -fv $(obj)/tmp-offsets.c $@ ; cat $^ > $(obj)/tmp-offsets.c
+	$(RM) -fv $(src)/autoconf.h
+	echo "/* nothing */" > $(src)/autoconf.h
+	$(CC) -D__KERNEL__ $(CFLAGS) $(LINUXINCLUDE) -I$(MOL_INCLUDE_DIR) -I$(src) -Wall -S $(obj)/tmp-offsets.c
+	echo "/* WARNING! Automatically generated from 'shared/asm_offsets.c' - DO NOT EDIT! */" > $@
+	grep '^#' tmp-offsets.s >> $@
+	$(RM) -fv $(obj)/tmp-offsets.*
+
+$(obj)/_performance.c: $(PERFOBJS)
+	$(RM) -fv $@ $@.tmp; echo "/* WARNING! DO NOT EDIT! AUTOMATICALLY GENERATED! */" > $@.tmp
+	echo "#include \"performance.h\"" >> $@.tmp
+	$(NM) $(PERFOBJS) | awk -- '/gPerf__/ { print "unsigned long "$$2";" }' >> $@.tmp
+	echo "perf_info_t g_perf_info_table[] = {" >> $@.tmp
+	$(NM) $(PERFOBJS) | awk -- '/gPerf__/ { print "  { \""$$2"\",&"$$2"}," }' >> $@.tmp
+	echo "  {0,0} };" >> $@.tmp
+	cat $@.tmp | sed s/_gPerf/gPerf/g > $@
+	$(RM) -fv $@.tmp
+
