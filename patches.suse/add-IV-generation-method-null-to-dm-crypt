From ludwig.nussel@suse.de  Thu Mar 15 22:22:52 2007
Date: Thu, 8 Mar 2007 16:19:00 +0100
From: Ludwig Nussel <ludwig.nussel@suse.de>
To: kernel@suse.de
Subject: [kernel] [PATCH] add IV generation method null to dm-crypt
References: 253527, FATE302001
Patch-mainline: submitted

Hi,

I've sent this patch to the dm-devel list and  Alasdair G Kergon
told me that he is going to include it upstream. With this patch the
patch that adds the loop_fish2 module can be dropped. Fate #302001.

Add IV generation method 'null' to be able to read old filesystem
images created with SuSE's loop_fish2 module.

Signed-off-by: Ludwig Nussel <ludwig.nussel@suse.de>
Acked-by: Christophe Saout <christophe@saout.de>

---
 drivers/md/dm-crypt.c |   17 +++++++++++++++++
 1 file changed, 17 insertions(+)

Index: linux-2.6.20/drivers/md/dm-crypt.c
===================================================================
--- linux-2.6.20.orig/drivers/md/dm-crypt.c
+++ linux-2.6.20/drivers/md/dm-crypt.c
@@ -120,6 +120,10 @@ static struct kmem_cache *_crypt_io_pool
  * benbi: the 64-bit "big-endian 'narrow block'-count", starting at 1
  *        (needed for LRW-32-AES and possible other narrow block modes)
  *
+ * null: the initial vector is always zero. This method is for
+ *       compatability with SuSE's obsolete loop_fish2 only. Do not
+ *       use it for creating new content.
+ *
  * plumb: unimplemented, see:
  * http://article.gmane.org/gmane.linux.kernel.device-mapper.dm-crypt/454
  */
@@ -256,6 +260,13 @@ static int crypt_iv_benbi_gen(struct cry
 	return 0;
 }
 
+static int crypt_iv_null_gen(struct crypt_config *cc, u8 *iv, sector_t sector)
+{
+	memset(iv, 0, cc->iv_size);
+
+	return 0;
+}
+
 static struct crypt_iv_operations crypt_iv_plain_ops = {
 	.generator = crypt_iv_plain_gen
 };
@@ -272,6 +283,10 @@ static struct crypt_iv_operations crypt_
 	.generator = crypt_iv_benbi_gen
 };
 
+static struct crypt_iv_operations crypt_iv_null_ops = {
+	.generator = crypt_iv_null_gen
+};
+
 static int
 crypt_convert_scatterlist(struct crypt_config *cc, struct scatterlist *out,
                           struct scatterlist *in, unsigned int length,
@@ -832,6 +847,8 @@ static int crypt_ctr(struct dm_target *t
 		cc->iv_gen_ops = &crypt_iv_essiv_ops;
 	else if (strcmp(ivmode, "benbi") == 0)
 		cc->iv_gen_ops = &crypt_iv_benbi_ops;
+	else if (strcmp(ivmode, "null") == 0)
+		cc->iv_gen_ops = &crypt_iv_null_ops;
 	else {
 		ti->error = "Invalid IV mode";
 		goto bad2;
