From: Olaf Kirch <okir@suse.de>
Subject: Make nlm_block hold a reference to the nlm_file

 Currently, the code dealing with blocked locks keeps a pointer
 to a struct nlm_file around, but never grabs a reference to it.
 Consequently, the file may (and will) go away, leaving us with a
 dangling pointer.

Signed-off-by: Olaf Kirch <okir@suse.de>

 fs/lockd/svclock.c |    2 ++
 1 files changed, 2 insertions(+)

Index: 2.6.15/fs/lockd/svclock.c
===================================================================
--- 2.6.15.orig/fs/lockd/svclock.c
+++ 2.6.15/fs/lockd/svclock.c
@@ -191,6 +191,7 @@ nlmsvc_create_block(struct svc_rqst *rqs
 	block->b_daemon = rqstp->rq_server;
 	block->b_host   = host;
 	block->b_file   = file;
+	file->f_count++;
 
 	/* Add to file's list of blocks */
 	list_add(&block->b_flist, &file->f_blocks);
@@ -247,6 +248,7 @@ nlmsvc_delete_block(struct nlm_block *bl
 	if (block->b_host)
 		nlm_release_host(block->b_host);
 	nlmclnt_freegrantargs(&block->b_call);
+	nlm_release_file(file);
 	kfree(block);
 }
 
