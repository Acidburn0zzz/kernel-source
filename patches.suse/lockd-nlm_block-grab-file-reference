From: Olaf Kirch <okir@suse.de>
Subject: Make nlm_block hold a reference to the nlm_file
Patch-mainline: 2.6.17

 Currently, the code dealing with blocked locks keeps a pointer
 to a struct nlm_file around, but never grabs a reference to it.
 Consequently, the file may (and will) go away, leaving us with a
 dangling pointer.

Signed-off-by: Olaf Kirch <okir@suse.de>

 fs/lockd/svclock.c |    2 ++
 1 files changed, 2 insertions(+)

diff -r 7b582cfacaa9 fs/lockd/svclock.c
--- a/fs/lockd/svclock.c	Mon Mar  6 12:43:14 2006 -0500
+++ b/fs/lockd/svclock.c	Mon Mar  6 12:46:50 2006 -0500
@@ -192,6 +192,7 @@ nlmsvc_create_block(struct svc_rqst *rqs
 	block->b_daemon = rqstp->rq_server;
 	block->b_host   = host;
 	block->b_file   = file;
+	file->f_count++;
 
 	/* Add to file's list of blocks */
 	list_add(&block->b_flist, &file->f_blocks);
@@ -244,6 +245,7 @@ nlmsvc_delete_block(struct nlm_block *bl
 	if (block->b_host)
 		nlm_release_host(block->b_host);
 	nlmclnt_freegrantargs(&block->b_call);
+	nlm_release_file(file);
 	kfree(block);
 	return status;
 }
