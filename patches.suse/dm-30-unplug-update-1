From axboe@suse.de Tue Mar 16 15:37:38 2004
Return-Path: <mason@watt>
Received: from watt ([unix socket]) (authenticated user=mason bits=0) by
	watt (Cyrus v2.1.15) with LMTP; Tue, 16 Mar 2004 15:37:38 -0500
X-Sieve: CMU Sieve 2.2
Return-Path: <axboe@suse.de>
Received: from extimap.suse.de [195.135.220.6] by localhost with IMAP
	(fetchmail-6.2.3) for mason@localhost (single-drop); Tue, 16 Mar 2004
	15:37:37 -0500 (EST)
Received: from extimap.suse.de ([unix socket]) by extimap (Cyrus v2.1.16)
	with LMTP; Tue, 16 Mar 2004 21:31:04 +0100
X-Sieve: CMU Sieve 2.2
Received: by extimap.suse.de (Postfix, from userid 65534) id 4F4BD7DA32;
	Tue, 16 Mar 2004 21:31:04 +0100 (CET)
Received: from Cantor.suse.de (ns.suse.de [195.135.220.2]) (using TLSv1
	with cipher EDH-RSA-DES-CBC3-SHA (168/168 bits)) (Client CN "mail.suse.de",
	Issuer "SuSE Linux AG internal IMAP-Server CA" (verified OK)) by
	extimap.suse.de (Postfix) with ESMTP id 6B2207D8FD for
	<mason@extimap.suse.de>; Tue, 16 Mar 2004 21:31:03 +0100 (CET)
Received: from hermes.suse.de (Hermes.suse.de [195.135.221.8]) (using TLSv1
	with cipher EDH-RSA-DES-CBC3-SHA (168/168 bits)) (No client certificate
	requested) by Cantor.suse.de (Postfix) with ESMTP id 3237A30A726 for
	<mason@extimap.suse.de>; Tue, 16 Mar 2004 21:31:03 +0100 (CET)
X-Sieve: CMU Sieve 2.2
Received: from Cantor.suse.de (ns.suse.de [195.135.220.2]) (using TLSv1
	with cipher EDH-RSA-DES-CBC3-SHA (168/168 bits)) (No client certificate
	requested) by hermes.suse.de (Postfix) with ESMTP id 8CC72159FA for
	<mason@suse.com>; Tue, 16 Mar 2004 21:31:02 +0100 (CET)
Received: from virtualhost.dk (ns.virtualhost.dk [195.184.98.160]) (using
	TLSv1 with cipher EDH-RSA-DES-CBC3-SHA (168/168 bits)) (No client
	certificate requested) by Cantor.suse.de (Postfix) with ESMTP id
	397DA30A720 for <mason@suse.com>; Tue, 16 Mar 2004 21:31:02 +0100 (CET)
Received: from [62.242.22.158] (helo=wiggum.home.kernel.dk) by
	virtualhost.dk with esmtp (Exim 3.36 #1) id 1B3LDL-0008H8-00 for
	mason@suse.com; Tue, 16 Mar 2004 21:31:03 +0100
Received: from axboe by wiggum.home.kernel.dk with local (Exim 4.22) id
	1B3LDH-0001SF-Pv for mason@suse.com; Tue, 16 Mar 2004 21:30:59 +0100
Date: Tue, 16 Mar 2004 21:30:59 +0100
From: Jens Axboe <axboe@suse.de>
To: Chris Mason <mason@suse.com>
Subject: dm-30-unplug-update-1
Message-ID: <20040316203059.GB2966@suse.de>
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary="nFreZHaLTZJo0R7j"
Content-Disposition: inline
X-Bogosity: No, tests=bogofilter, spamicity=0.500000, version=0.14.4
X-Evolution-Source: imap://mason@watt/


--nFreZHaLTZJo0R7j
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: 8bit

Hi Chris

Care to check this one in? It corrects the bad BIO_RW_SYNC, and adds an
unplug for dm-raid1.c. It should be safe, do_recovery() also just
derefences ->table without getting a reference to it.

-- 
Jens Axboe


--nFreZHaLTZJo0R7j
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=dm-30-unplug-update-1
Content-Transfer-Encoding: 8bit

diff -ur /opt/kernel/linux-2.6.4-suse/drivers/md/dm-io.c linux-2.6.4/drivers/md/dm-io.c
--- /opt/kernel/linux-2.6.4-suse/drivers/md/dm-io.c	2004-03-16 21:24:52.375438000 +0100
+++ linux-2.6.4/drivers/md/dm-io.c	2004-03-16 21:25:35.805763468 +0100
@@ -497,7 +497,7 @@
 	struct dpages old_pages = *dp;
 
 	if (sync)
-		rw |= BIO_RW_SYNC;
+		rw |= (1 << BIO_RW_SYNC);
 
 	/*
 	 * For multiple regions we need to be careful to rewind
diff -ur /opt/kernel/linux-2.6.4-suse/drivers/md/dm-raid1.c linux-2.6.4/drivers/md/dm-raid1.c
--- /opt/kernel/linux-2.6.4-suse/drivers/md/dm-raid1.c	2004-03-16 21:24:52.446431000 +0100
+++ linux-2.6.4/drivers/md/dm-raid1.c	2004-03-16 21:27:21.325409855 +0100
@@ -859,6 +859,7 @@
 	do_recovery(ms);
 	do_reads(ms, &reads);
 	do_writes(ms, &writes);
+	dm_table_unplug_all(ms->ti->table);
 }
 
 static void do_work(void *ignored)

--nFreZHaLTZJo0R7j--


