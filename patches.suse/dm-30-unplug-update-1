
From: Jens Axboe
Note: Minor problems with the unplugging. md doesn't need to set/clear the
plugged bit, in fact it can cause races with drivers that check the plugged
bit in the request_fn. Add unplug call to dm-raid1, and correct the missing
shift in dm-io

---

diff -ur /opt/kernel/linux-2.6.4-suse/drivers/md/dm-io.c linux-2.6.4/drivers/md/dm-io.c
--- /opt/kernel/linux-2.6.4-suse/drivers/md/dm-io.c	2004-03-17 07:47:56.314073342 +0100
+++ linux-2.6.4/drivers/md/dm-io.c	2004-03-17 07:48:23.349153215 +0100
@@ -497,7 +497,7 @@
 	struct dpages old_pages = *dp;
 
 	if (sync)
-		rw |= BIO_RW_SYNC;
+		rw |= (1 << BIO_RW_SYNC);
 
 	/*
 	 * For multiple regions we need to be careful to rewind
diff -ur /opt/kernel/linux-2.6.4-suse/drivers/md/dm-raid1.c linux-2.6.4/drivers/md/dm-raid1.c
--- /opt/kernel/linux-2.6.4-suse/drivers/md/dm-raid1.c	2004-03-17 07:47:56.315073234 +0100
+++ linux-2.6.4/drivers/md/dm-raid1.c	2004-03-17 07:48:23.350153107 +0100
@@ -859,6 +859,7 @@
 	do_recovery(ms);
 	do_reads(ms, &reads);
 	do_writes(ms, &writes);
+	dm_table_unplug_all(ms->ti->table);
 }
 
 static void do_work(void *ignored)
 
