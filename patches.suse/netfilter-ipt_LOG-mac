From: Jaroslav Kysela <perex@suse.cz>
Subject: LTC23987-iptables LOG output shows too long MAC info
References: 176921

LTC23987-iptables LOG output shows too long MAC info for qeth VLAN interface

Signed-off-by: Jaroslav Kysela <perex@suse.cz>

--- linux-2.6.16.orig/net/ipv4/netfilter/ipt_LOG.c	2006-03-20 06:53:29.000000000 +0100
+++ linux-2.6.16/net/ipv4/netfilter/ipt_LOG.c	2006-05-26 12:05:08.000000000 +0200
@@ -395,12 +395,12 @@ ipt_log_packet(unsigned int pf,
 		printk("MAC=");
 		if (skb->dev && skb->dev->hard_header_len
 		    && skb->mac.raw != (void*)skb->nh.iph) {
-			int i;
+			int i, len;
 			unsigned char *p = skb->mac.raw;
-			for (i = 0; i < skb->dev->hard_header_len; i++,p++)
-				printk("%02x%c", *p,
-				       i==skb->dev->hard_header_len - 1
-				       ? ' ':':');
+			len = (int)((unsigned char *)skb->nh.iph - p);
+			len = min((int)skb->dev->hard_header_len, len);
+			for (i = 0; i < len; i++,p++)
+				printk("%02x%c", *p, i==len - 1 ? ' ':':');
 		} else
 			printk(" ");
 	}
