From: Polyserve
Subject: rq_daddr should be filled out for TCP-based RPC
Patch-mainline: submitted 2005-07-12
References: SUSE49441

  This patch fills the daddr member of the rpc struct svc_rqst structure for  
  TCP-based sockets in the recvfrom proceedure.  Currently, the field is 
  not set thus leaving it with left over garbage from a previous allocation. 
 
  This makes the behavior consistent between UDP- and TCP-based RPC. 
 
  This patch enables Hi-Av software to failover TCP-based RPC applications 
  such as TCP-based NFS. 

Acked-by: okir@suse.de

Index: linux-2.6.12/net/sunrpc/svcsock.c
===================================================================
--- linux-2.6.12.orig/net/sunrpc/svcsock.c	2005-07-11 12:34:53.000000000 +0200
+++ linux-2.6.12/net/sunrpc/svcsock.c	2005-07-12 10:58:09.000000000 +0200
@@ -455,8 +455,9 @@ svc_recvfrom(struct svc_rqst *rqstp, str
 	struct socket	*sock;
 	int		len, alen;
 
-	rqstp->rq_addrlen = sizeof(rqstp->rq_addr);
 	sock = rqstp->rq_sock->sk_sock;
+	rqstp->rq_daddr = inet_sk((const struct sock *)sock)->rcv_saddr;
+	rqstp->rq_addrlen = sizeof(rqstp->rq_addr);
 
 	msg.msg_name    = &rqstp->rq_addr;
 	msg.msg_namelen = sizeof(rqstp->rq_addr);
