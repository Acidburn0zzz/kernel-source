From: Jordan Hargrave <jordan_hargrave@dell.com>
Subject: fix hang in bonding ALB driver
Reference: 206629
Acked-by: Karsten Keil <kkeil@novell.com>

Since the driver is using workqueues now the lock must be protected
against the softirq handler.

Index: linux-2.6.16-SLES10_SP1_BRANCH/drivers/net/bonding/bond_alb.c
===================================================================
--- linux-2.6.16-SLES10_SP1_BRANCH.orig/drivers/net/bonding/bond_alb.c
+++ linux-2.6.16-SLES10_SP1_BRANCH/drivers/net/bonding/bond_alb.c
@@ -123,12 +123,12 @@ static inline u8 _simple_hash(u8 *hash_s
 
 static inline void _lock_tx_hashtbl(struct bonding *bond)
 {
-	spin_lock(&(BOND_ALB_INFO(bond).tx_hashtbl_lock));
+	spin_lock_bh(&(BOND_ALB_INFO(bond).tx_hashtbl_lock));
 }
 
 static inline void _unlock_tx_hashtbl(struct bonding *bond)
 {
-	spin_unlock(&(BOND_ALB_INFO(bond).tx_hashtbl_lock));
+	spin_unlock_bh(&(BOND_ALB_INFO(bond).tx_hashtbl_lock));
 }
 
 /* Caller must hold tx_hashtbl lock */
@@ -302,12 +302,12 @@ static struct slave *tlb_choose_channel(
 /*********************** rlb specific functions ***************************/
 static inline void _lock_rx_hashtbl(struct bonding *bond)
 {
-	spin_lock(&(BOND_ALB_INFO(bond).rx_hashtbl_lock));
+	spin_lock_bh(&(BOND_ALB_INFO(bond).rx_hashtbl_lock));
 }
 
 static inline void _unlock_rx_hashtbl(struct bonding *bond)
 {
-	spin_unlock(&(BOND_ALB_INFO(bond).rx_hashtbl_lock));
+	spin_unlock_bh(&(BOND_ALB_INFO(bond).rx_hashtbl_lock));
 }
 
 /* when an ARP REPLY is received from a client update its info
