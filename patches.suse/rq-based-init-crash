From: Hannes Reinecke <hare@suse.de>
Subject: Machines crashes during boot
References: bnc#428354

We need to check if the gendisk has been initialized before
calling del_gendisk() on it.

Signed-off-by: Hannes Reinecke <hare@suse.de>

---
 drivers/md/dm.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@ -1799,7 +1799,8 @@ static void free_dev(struct mapped_devic
 		mempool_destroy(md->io_pool);
 	if (md->bs)
 		bioset_free(md->bs);
-	del_gendisk(md->disk);
+	if (test_bit(DMF_INITIALIZED, &md->flags))
+		del_gendisk(md->disk);
 	free_minor(minor);
 
 	spin_lock(&_minor_lock);
