From: tonyj@suse.de
Subject: Export namespace semaphore
Patch-mainline: no

Export global namespace_sem (this used to be a per namespace semaphore).
Change AppArmor (SubDomain) to use this exported global.
Alas, this isn't going to win _any_ points for style.
Patch is not in mainline -- pending AppArmor code submission to lkml


Index: linux-2.6.14/fs/namespace.c
===================================================================
--- linux-2.6.14.orig/fs/namespace.c
+++ linux-2.6.14/fs/namespace.c
@@ -45,7 +45,8 @@ static int event;
 static struct list_head *mount_hashtable;
 static int hash_mask __read_mostly, hash_bits __read_mostly;
 static kmem_cache_t *mnt_cache;
-static struct rw_semaphore namespace_sem;
+struct rw_semaphore namespace_sem;
+EXPORT_SYMBOL_GPL(namespace_sem);
 
 static inline unsigned long hash(struct vfsmount *mnt, struct dentry *dentry)
 {
Index: linux-2.6.14/include/linux/namespace.h
===================================================================
--- linux-2.6.14.orig/include/linux/namespace.h
+++ linux-2.6.14/include/linux/namespace.h
@@ -5,6 +5,9 @@
 #include <linux/mount.h>
 #include <linux/sched.h>
 
+/* exported for AppArmor (SubDomain) */
+extern struct rw_semaphore namespace_sem;
+
 struct namespace {
 	atomic_t		count;
 	struct vfsmount *	root;
Index: linux-2.6.14/security/subdomain/inline.h
===================================================================
--- linux-2.6.14.orig/security/subdomain/inline.h
+++ linux-2.6.14/security/subdomain/inline.h
@@ -299,7 +299,7 @@ static inline void sd_path_begin2(struct
 	prefetch(data->pos->next);
 	data->errno = 0;
 
-	down_read(&data->namespace->sem);
+	down_read(&namespace_sem);
 }
 
 /** sd_path_begin
@@ -322,7 +322,7 @@ static inline void sd_path_begin(struct 
  */
 static inline int sd_path_end(struct sd_path_data *data)
 {
-	up_read(&data->namespace->sem);
+	up_read(&namespace_sem);
 	dput(data->root);
 
 	return data->errno;
