From: Chris Mason <mason@suse.com>
Subject: reiserfs_fsync should only use barriers when they are enabled

make sure that reiserfs_fsync only triggers barriers when mounted with
-o barrier=flush

Index: linux.head/fs/reiserfs/file.c
===================================================================
--- linux.head.orig/fs/reiserfs/file.c	2004-12-17 08:12:14.832988764 -0500
+++ linux.head/fs/reiserfs/file.c	2004-12-17 08:21:08.737487290 -0500
@@ -131,7 +131,7 @@ static int reiserfs_sync_file(
   reiserfs_write_lock(p_s_inode->i_sb);
   barrier_done = reiserfs_commit_for_inode(p_s_inode);
   reiserfs_write_unlock(p_s_inode->i_sb);
-  if (barrier_done != 1)
+  if (barrier_done != 1 && reiserfs_barrier_flush(p_s_inode->i_sb))
       blkdev_issue_flush(p_s_inode->i_sb->s_bdev, NULL);
   if (barrier_done < 0)
     return barrier_done;
