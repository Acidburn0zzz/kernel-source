Index: linux/include/linux/kdb.h
===================================================================
--- linux.orig/include/linux/kdb.h	2004-05-17 11:52:46.000000000 -0500
+++ linux/include/linux/kdb.h	2004-05-17 11:58:55.000000000 -0500
@@ -99,6 +99,7 @@
 #define KDB_FLAG_CMD_INTERRUPT	(1 << 2)	/* Previous command was interrupted */
 #define KDB_FLAG_NOIPI		(1 << 3)	/* Do not send IPIs */
 #define KDB_FLAG_ONLY_DO_DUMP	(1 << 4)	/* Only do a dump, used when kdb is off */
+#define KDB_FLAG_NO_CONSOLE	(1 << 5)	/* No console is available, kdb is disabled */
 
 	/*
 	 * Internal debug flags
Index: linux/kdb/kdb_io.c
===================================================================
--- linux.orig/kdb/kdb_io.c	2004-05-17 11:52:46.000000000 -0500
+++ linux/kdb/kdb_io.c	2004-05-17 11:58:55.000000000 -0500
@@ -640,8 +640,9 @@
 	}
 
 	if (kdbcons == NULL) {
-		printk("kdb: Initialization failed - no console\n");
-		while (1) {};
+		printk(KERN_ERR "kdb: Initialization failed - no console.  kdb is disabled.\n");
+		KDB_FLAG_SET(NO_CONSOLE);
+		kdb_on = 0;
 	}
 	kdb_input_flush();
 #endif
Index: linux/kernel/sysctl.c
===================================================================
--- linux.orig/kernel/sysctl.c	2004-05-17 11:53:40.000000000 -0500
+++ linux/kernel/sysctl.c	2004-05-17 11:58:55.000000000 -0500
@@ -42,6 +42,7 @@
 #include <asm/uaccess.h>
 #ifdef	CONFIG_KDB
 #include <linux/kdb.h>
+static int proc_do_kdb(ctl_table *table, int write, struct file *filp, void *buffer, size_t *lenp);
 #endif	/* CONFIG_KDB */
 #ifdef CONFIG_XMON
 #include <asm/system.h>
@@ -533,7 +534,7 @@
 		.data		= &kdb_on,
 		.maxlen		= sizeof(kdb_on),
 		.mode		= 0644,
-		.proc_handler	= &proc_dointvec,
+		.proc_handler	= &proc_do_kdb,
 	},
 #endif	/* CONFIG_KDB */
 #ifdef CONFIG_XMON
@@ -2269,6 +2270,22 @@
 
 #endif /* CONFIG_SYSCTL */
 
+#ifdef	CONFIG_KDB
+static int proc_do_kdb(ctl_table *table, int write, struct file *filp,
+		       void *buffer, size_t *lenp)
+{
+#ifdef	CONFIG_SYSCTL
+	if (KDB_FLAG(NO_CONSOLE) && write) {
+		printk(KERN_ERR "kdb has no working console and has switched itself off\n");
+		return -EINVAL;
+	}
+	return proc_dointvec(table, write, filp, buffer, lenp);
+#else	/* !CONFIG_SYSCTL */
+	return -ENOSYS;
+#endif	/* CONFIG_SYSCTL */
+}
+#endif	/* CONFIG_KDB */
+
 /*
  * No sense putting this after each symbol definition, twice,
  * exception granted :-)
