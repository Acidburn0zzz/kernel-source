diff -ur -X /home/axboe/cdrom/exclude /opt/kernel/linux-2.6.5-rc1-mm2/fs/ext3/super.c linux-2.6.5-rc1-mm2/fs/ext3/super.c
--- /opt/kernel/linux-2.6.5-rc1-mm2/fs/ext3/super.c	2004-03-19 15:13:58.218979274 +0100
+++ linux-2.6.5-rc1-mm2/fs/ext3/super.c	2004-03-19 15:24:52.950317300 +0100
@@ -536,7 +536,8 @@
 	Opt_user_xattr, Opt_nouser_xattr, Opt_acl, Opt_noacl, Opt_noload,
 	Opt_commit, Opt_journal_update, Opt_journal_inum,
 	Opt_abort, Opt_data_journal, Opt_data_ordered, Opt_data_writeback,
-	Opt_ignore, Opt_err,
+	Opt_ignore, Opt_barrier,
+	Opt_err,
 };
 
 static match_table_t tokens = {
@@ -575,6 +576,7 @@
 	{Opt_ignore, "noquota"},
 	{Opt_ignore, "quota"},
 	{Opt_ignore, "usrquota"},
+	{Opt_barrier, "barrier=%u"},
 	{Opt_err, NULL}
 };
 
@@ -762,6 +764,14 @@
 		case Opt_abort:
 			set_opt(sbi->s_mount_opt, ABORT);
 			break;
+		case Opt_barrier:
+			if (match_int(&args[0], &option))
+				return 0;
+			if (option)
+				set_opt(sbi->s_mount_opt, BARRIER);
+			else
+				clear_opt(sbi->s_mount_opt, BARRIER);
+			break;
 		case Opt_ignore:
 			break;
 		default:
@@ -1419,16 +1429,23 @@
  * initial mount, once the journal has been initialised but before we've
  * done any recovery; and again on any subsequent remount. 
  */
-static void ext3_init_journal_params(struct ext3_sb_info *sbi, 
-				     journal_t *journal)
+static void ext3_init_journal_params(struct super_block *sb, journal_t *journal)
 {
+	struct ext3_sb_info *sbi = EXT3_SB(sb);
+
 	if (sbi->s_commit_interval)
 		journal->j_commit_interval = sbi->s_commit_interval;
 	/* We could also set up an ext3-specific default for the commit
 	 * interval here, but for now we'll just fall back to the jbd
 	 * default. */
-}
 
+	spin_lock(&journal->j_state_lock);
+	if (test_opt(sb, BARRIER))
+		journal->j_flags |= JFS_BARRIER;
+	else
+		journal->j_flags &= ~JFS_BARRIER;
+	spin_unlock(&journal->j_state_lock);
+}
 
 static journal_t *ext3_get_journal(struct super_block *sb, int journal_inum)
 {
@@ -1465,7 +1482,7 @@
 		iput(journal_inode);
 	}
 	journal->j_private = sb;
-	ext3_init_journal_params(EXT3_SB(sb), journal);
+	ext3_init_journal_params(sb, journal);
 	return journal;
 }
 
@@ -1550,7 +1567,7 @@
 		goto out_journal;
 	}
 	EXT3_SB(sb)->journal_bdev = bdev;
-	ext3_init_journal_params(EXT3_SB(sb), journal);
+	ext3_init_journal_params(sb, journal);
 	return journal;
 out_journal:
 	journal_destroy(journal);
@@ -1843,7 +1860,7 @@
 
 	es = sbi->s_es;
 
-	ext3_init_journal_params(sbi, sbi->s_journal);
+	ext3_init_journal_params(sb, sbi->s_journal);
 
 	if ((*flags & MS_RDONLY) != (sb->s_flags & MS_RDONLY)) {
 		if (sbi->s_mount_opt & EXT3_MOUNT_ABORT)
diff -ur -X /home/axboe/cdrom/exclude /opt/kernel/linux-2.6.5-rc1-mm2/fs/jbd/commit.c linux-2.6.5-rc1-mm2/fs/jbd/commit.c
--- /opt/kernel/linux-2.6.5-rc1-mm2/fs/jbd/commit.c	2004-03-11 03:55:44.000000000 +0100
+++ linux-2.6.5-rc1-mm2/fs/jbd/commit.c	2004-03-19 15:24:52.954316867 +0100
@@ -636,6 +636,8 @@
 	{
 		struct buffer_head *bh = jh2bh(descriptor);
 		set_buffer_uptodate(bh);
+		if (journal->j_flags & JFS_BARRIER)
+			set_buffer_ordered(bh);
 		sync_dirty_buffer(bh);
 		if (unlikely(!buffer_uptodate(bh)))
 			err = -EIO;
diff -ur -X /home/axboe/cdrom/exclude /opt/kernel/linux-2.6.5-rc1-mm2/include/linux/ext3_fs.h linux-2.6.5-rc1-mm2/include/linux/ext3_fs.h
--- /opt/kernel/linux-2.6.5-rc1-mm2/include/linux/ext3_fs.h	2004-03-11 03:55:33.000000000 +0100
+++ linux-2.6.5-rc1-mm2/include/linux/ext3_fs.h	2004-03-19 15:24:52.951317191 +0100
@@ -324,6 +324,7 @@
 #define EXT3_MOUNT_NO_UID32		0x2000  /* Disable 32-bit UIDs */
 #define EXT3_MOUNT_XATTR_USER		0x4000	/* Extended user attributes */
 #define EXT3_MOUNT_POSIX_ACL		0x8000	/* POSIX Access Control Lists */
+#define EXT3_MOUNT_BARRIER		0x10000 /* Use block barriers */
 
 /* Compatibility, for having both ext2_fs.h and ext3_fs.h included at once */
 #ifndef _LINUX_EXT2_FS_H
diff -ur -X /home/axboe/cdrom/exclude /opt/kernel/linux-2.6.5-rc1-mm2/include/linux/jbd.h linux-2.6.5-rc1-mm2/include/linux/jbd.h
--- /opt/kernel/linux-2.6.5-rc1-mm2/include/linux/jbd.h	2004-03-11 03:55:43.000000000 +0100
+++ linux-2.6.5-rc1-mm2/include/linux/jbd.h	2004-03-19 15:24:52.952317083 +0100
@@ -825,6 +825,7 @@
 #define JFS_ACK_ERR	0x004	/* The errno in the sb has been acked */
 #define JFS_FLUSHED	0x008	/* The journal superblock has been flushed */
 #define JFS_LOADED	0x010	/* The journal superblock has been loaded */
+#define JFS_BARRIER	0x020	/* Use IDE barriers */
 
 /* 
  * Function declarations for the journaling transaction and buffer
