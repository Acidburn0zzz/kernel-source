
From: Hans Reiser <reiser@namesys.com>
Subject: add per filesystem sync_inodes call

This patch adds new operation to struct super_operations - sync_inodes,
generic implementaion and changes fs-writeback.c:sync_sb_inodes() to call
filesystem's sync_inodes if it is defined or generic implementaion otherwise. 
This new operation allows filesystem to decide itself what to flush.

Reiser4 flushes dirty pages on basic of atoms, not of inodes.  sync_sb_inodes
used to call address space flushing method (writepages) for every dirty inode.
 For reiser4 it caused having to commit atoms unnecessarily often.  This
turned into substantial slowdown.  Having this method helped to fix that
problem.

Signed-off-by: Andrew Morton <akpm@osdl.org>
Acked-by: Chris Mason <mason@suse.com>
---

 fs/fs-writeback.c  |   14 ++++++++++++--
 include/linux/fs.h |    3 +++
 2 files changed, 15 insertions(+), 2 deletions(-)

diff -puN fs/fs-writeback.c~reiser4-sb_sync_inodes fs/fs-writeback.c
--- 25/fs/fs-writeback.c~reiser4-sb_sync_inodes	2005-06-25 01:17:25.000000000 -0700
+++ 25-akpm/fs/fs-writeback.c	2005-06-25 01:17:25.000000000 -0700
@@ -300,8 +300,8 @@ __writeback_single_inode(struct inode *i
  * on the writer throttling path, and we get decent balancing between many
  * throttled threads: we don't want them all piling up on __wait_on_inode.
  */
-static void
-sync_sb_inodes(struct super_block *sb, struct writeback_control *wbc)
+void
+generic_sync_sb_inodes(struct super_block *sb, struct writeback_control *wbc)
 {
 	const unsigned long start = jiffies;	/* livelock avoidance */
 
@@ -386,6 +386,16 @@ sync_sb_inodes(struct super_block *sb, s
 	}
 	return;		/* Leave any unwritten inodes on s_io */
 }
+EXPORT_SYMBOL(generic_sync_sb_inodes);
+
+static void
+sync_sb_inodes(struct super_block *sb, struct writeback_control *wbc)
+{
+	if (sb->s_op->sync_inodes)
+		sb->s_op->sync_inodes(sb, wbc);
+	else
+		generic_sync_sb_inodes(sb, wbc);
+}
 
 /*
  * Start writeback of dirty pagecache data against all unlocked inodes.
diff -puN include/linux/fs.h~reiser4-sb_sync_inodes include/linux/fs.h
--- 25/include/linux/fs.h~reiser4-sb_sync_inodes	2005-06-25 01:17:25.000000000 -0700
+++ 25-akpm/include/linux/fs.h	2005-06-25 01:17:25.000000000 -0700
@@ -1040,6 +1040,8 @@ struct super_operations {
 	void (*clear_inode) (struct inode *);
 	void (*umount_begin) (struct super_block *);
 
+	void (*sync_inodes) (struct super_block *sb,
+				struct writeback_control *wbc);
 	int (*show_options)(struct seq_file *, struct vfsmount *);
 
 	ssize_t (*quota_read)(struct super_block *, int, char *, size_t, loff_t);
@@ -1388,6 +1390,7 @@ extern int invalidate_inode_pages2(struc
 extern int invalidate_inode_pages2_range(struct address_space *mapping,
 					 pgoff_t start, pgoff_t end);
 extern int write_inode_now(struct inode *, int);
+extern void generic_sync_sb_inodes(struct super_block *, struct writeback_control *);
 extern int filemap_fdatawrite(struct address_space *);
 extern int filemap_flush(struct address_space *);
 extern int filemap_fdatawait(struct address_space *);
_
