Subject: Allow one kernel binary with static 8250 and pmac_zilog
From: olh@suse.de
Patch-mainline: never

Allow co-existance of 8250=y and pmac_zilog=y.
Both try to claim ttyS0. 8250 comes first and zilog init fails.
The right fix would be a rewrite of the tty devnode handling with dynamic
minor assignment.
http://bugzilla.kernel.org/show_bug.cgi?id=1529

Signed-off-by: Olaf Hering <olh@suse.de>

 arch/powerpc/platforms/powermac/setup.c |   17 +++++++++++++++++
 drivers/serial/8250.c                   |    9 +++++++++
 drivers/serial/8250_pci.c               |    7 +++++++
 include/asm-powerpc/io.h                |    4 ++++
 include/asm-ppc/io.h                    |    5 +++++
 5 files changed, 42 insertions(+)

--- a/arch/powerpc/platforms/powermac/setup.c
+++ b/arch/powerpc/platforms/powermac/setup.c
@@ -725,6 +725,20 @@ static void pmac_cpu_die(void)
 
 #endif /* CONFIG_PPC64 */
 
+#ifdef CONFIG_SERIAL_8250
+/*
+ * if both serial drivers exists, 8250 will be inited first
+ * it claims ttyS0 and pmac_zilog init fails
+ */
+int do_not_probe_pc_legacy_8250;
+EXPORT_SYMBOL(do_not_probe_pc_legacy_8250);
+#ifdef CONFIG_SERIAL_PMACZILOG
+static void pmac_pcibios_fixup(void) {
+	do_not_probe_pc_legacy_8250 = 1;
+}
+#endif
+#endif
+
 define_machine(powermac) {
 	.name			= "PowerMac",
 	.probe			= pmac_probe,
@@ -733,6 +747,9 @@ define_machine(powermac) {
 	.show_cpuinfo		= pmac_show_cpuinfo,
 	.init_IRQ		= pmac_pic_init,
 	.get_irq		= NULL,	/* changed later */
+#if defined(CONFIG_SERIAL_8250) && defined(CONFIG_SERIAL_PMACZILOG)
+	.pcibios_fixup		= pmac_pcibios_fixup,
+#endif
 	.pci_irq_fixup		= pmac_pci_irq_fixup,
 	.restart		= pmac_restart,
 	.power_off		= pmac_power_off,
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -46,6 +46,10 @@
 
 #include "8250.h"
 
+#ifndef NO_PC_LEGACY_SERIAL_8250
+#define do_not_probe_pc_legacy_8250 (0)
+#endif
+
 /*
  * Configuration:
  *   share_irqs - whether we pass IRQF_SHARED to request_irq().  This option
@@ -2527,6 +2531,8 @@ static struct console serial8250_console
 
 static int __init serial8250_console_init(void)
 {
+	if (do_not_probe_pc_legacy_8250)
+		return -ENODEV;
 	serial8250_isa_init_ports();
 	register_console(&serial8250_console);
 	return 0;
@@ -2849,6 +2855,9 @@ static int __init serial8250_init(void)
 {
 	int ret, i;
 
+	if (do_not_probe_pc_legacy_8250)
+		return -ENODEV;
+
 	if (nr_uarts > UART_NR)
 		nr_uarts = UART_NR;
 
--- a/drivers/serial/8250_pci.c
+++ b/drivers/serial/8250_pci.c
@@ -32,6 +32,10 @@
 
 #undef SERIAL_DEBUG_PCI
 
+#ifndef NO_PC_LEGACY_SERIAL_8250
+#define do_not_probe_pc_legacy_8250 (0)
+#endif
+
 /*
  * init function returns:
  *  > 0 - number of ports
@@ -2433,6 +2437,9 @@ static struct pci_driver serial_pci_driv
 
 static int __init serial8250_pci_init(void)
 {
+	if (do_not_probe_pc_legacy_8250)
+		return -ENODEV;
+
 	return pci_register_driver(&serial_pci_driver);
 }
 
--- a/include/asm-powerpc/io.h
+++ b/include/asm-powerpc/io.h
@@ -568,6 +568,10 @@ static inline void iosync(void)
 #define iobarrier_r()  eieio()
 #define iobarrier_w()  eieio()
 
+#if defined(CONFIG_PPC_PMAC) && defined(CONFIG_SERIAL_8250)
+#define NO_PC_LEGACY_SERIAL_8250 1
+extern int do_not_probe_pc_legacy_8250;
+#endif
 
 /*
  * output pause versions need a delay at least for the
--- a/include/asm-ppc/io.h
+++ b/include/asm-ppc/io.h
@@ -535,6 +535,11 @@ extern void pci_iounmap(struct pci_dev *
 
 #endif
 
+#if defined(CONFIG_PPC_PMAC) && defined(CONFIG_SERIAL_8250)
+#define NO_PC_LEGACY_SERIAL_8250 1
+extern int do_not_probe_pc_legacy_8250;
+#endif
+
 /*
  * Convert a physical pointer to a virtual kernel pointer for /dev/mem
  * access
