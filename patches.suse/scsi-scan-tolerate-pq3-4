From: Kurt Garloff <garloff@suse.de>
Subject: Tolerate PQ 3 at LUN 0 for scanning
Patch-mainline: 
References: 158532

Some devices report a peripheral qualifier of 3 for LUN 0; with the original
code, we would still try a REPORT_LUNS scan (if SCSI level is >= 3 or if we 
have the BLIST_REPORTLUNS2 passed in), but NOT any sequential scan.
Also, the device at LUN 0 (which is not connected according to the PQ) is not
registered with the OS.

Unfortunately, SANs exist that are SCSI-2 and do NOT support REPORT_LUNS, but
report a unknown device with PQ 3 on LUN 0. We still need to scan them, and
most probably we even need BLIST_SPARSELUN (and BLIST_LARGELUN). See the bug
reference for an infamous example.

This patch 4/3:
Log all PQ3 devices, even if blacklisted. For testing.

Acked-by: 
Signed-off-by: Kurt Garloff <garloff@suse.de>


Index: linux-2.6.16/drivers/scsi/scsi_scan.c
===================================================================
--- linux-2.6.16.orig/drivers/scsi/scsi_scan.c
+++ linux-2.6.16/drivers/scsi/scsi_scan.c
@@ -846,8 +846,9 @@ static int scsi_probe_and_add_lun(struct
 	struct scsi_device *sdev;
 	unsigned char *result;
 	int bflags, res = SCSI_SCAN_NO_RESPONSE, result_len = 256;
 	struct Scsi_Host *shost = dev_to_shost(starget->dev.parent);
+	unsigned char pq;
 
 	/*
 	 * The rescan flag is used as an optimization, the first scan of a
 	 * host adapter calls into here with rescan == 0.
@@ -884,12 +885,27 @@ static int scsi_probe_and_add_lun(struct
 		goto out_free_result;
 
 	if (bflagsp)
 		*bflagsp = bflags;
+
+	pq = (result[0] >> 5) & 3;
+	/* DEBUG */
+	if (pq != 0) {
+		sdev_printk(KERN_INFO, sdev, "scsi scan: peripheral "
+				"qualifier of %i, device not added\n", pq);
+		if (lun == 0) {
+			unsigned char vend[9], mod[17];
+			sdev_printk(KERN_INFO, sdev, "scsi scan: consider "
+					"passing scsi_mod.dev_flags=%s:%s:"
+					"0x240 or 0x800240\n",
+					scsi_inq_str(vend, result, 8, 16),
+					scsi_inq_str(mod, result, 16, 32));
+		}
+	}
 	/*
 	 * result contains valid SCSI INQUIRY data.
 	 */
-	if (((result[0] >> 5) == 3) && !(bflags & BLIST_ATTACH_PQ3)) {
+	if (pq == 3 && !(bflags & BLIST_ATTACH_PQ3)) {
 		/*
 		 * For a Peripheral qualifier 3 (011b), the SCSI
 		 * spec says: The device server is not capable of
 		 * supporting a physical device on this logical
