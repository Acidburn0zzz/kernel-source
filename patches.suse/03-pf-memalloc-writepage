Index: linux.t/fs/buffer.c
===================================================================
--- linux.t.orig/fs/buffer.c	2004-06-02 09:08:18.000000000 -0400
+++ linux.t/fs/buffer.c	2004-06-02 09:15:08.000000000 -0400
@@ -1830,6 +1830,11 @@ static int __block_write_full_page(struc
 	if (!page_has_buffers(page)) {
 		if (!PageUptodate(page))
 			buffer_error();
+		if (current->flags & PF_MEMALLOC) {
+			redirty_page_for_writepage(wbc, page);
+			unlock_page(page);
+			return 0;
+		}
 		create_empty_buffers(page, 1 << inode->i_blkbits,
 					(1 << BH_Dirty)|(1 << BH_Uptodate));
 	}
Index: linux.t/fs/ext3/inode.c
===================================================================
--- linux.t.orig/fs/ext3/inode.c	2004-06-02 09:08:18.000000000 -0400
+++ linux.t/fs/ext3/inode.c	2004-06-02 09:23:26.000000000 -0400
@@ -1355,6 +1355,9 @@ static int ext3_ordered_writepage(struct
 	if (ext3_journal_current_handle())
 		goto out_fail;
 
+	if (current->flags & PF_MEMALLOC)
+		goto out_fail;
+
 	handle = ext3_journal_start(inode, ext3_writepage_trans_blocks(inode));
 
 	if (IS_ERR(handle)) {
@@ -1416,6 +1419,9 @@ static int ext3_writeback_writepage(stru
 	if (ext3_journal_current_handle())
 		goto out_fail;
 
+	if (current->flags & PF_MEMALLOC)
+		goto out_fail;
+
 	handle = ext3_journal_start(inode, ext3_writepage_trans_blocks(inode));
 	if (IS_ERR(handle)) {
 		ret = PTR_ERR(handle);
@@ -1445,6 +1451,9 @@ static int ext3_journalled_writepage(str
 	if (ext3_journal_current_handle())
 		goto no_write;
 
+	if (current->flags & PF_MEMALLOC)
+		goto no_write;
+
 	handle = ext3_journal_start(inode, ext3_writepage_trans_blocks(inode));
 	if (IS_ERR(handle)) {
 		ret = PTR_ERR(handle);
Index: linux.t/fs/reiserfs/inode.c
===================================================================
--- linux.t.orig/fs/reiserfs/inode.c	2004-06-02 09:08:18.000000000 -0400
+++ linux.t/fs/reiserfs/inode.c	2004-06-02 09:20:16.000000000 -0400
@@ -2232,6 +2232,8 @@ static int reiserfs_write_full_page(stru
      * in the BH_Uptodate is just a sanity check.
      */
     if (!page_has_buffers(page)) {
+	if (current->flags & PF_MEMALLOC)
+	    goto redirty_exit;
 	if (!PageUptodate(page))
 	    buffer_error();
 	create_empty_buffers(page, s->s_blocksize,
@@ -2263,6 +2265,8 @@ static int reiserfs_write_full_page(stru
     do {
 	if ((checked || buffer_dirty(bh)) && (!buffer_mapped(bh) ||
 	   (buffer_mapped(bh) && bh->b_blocknr == 0))) {
+	    if (current->flags & PF_MEMALLOC)
+		goto redirty_exit;
 	    /* not mapped yet, or it points to a direct item, search
 	     * the btree for the mapping info, and log any direct
 	     * items found
@@ -2408,6 +2412,11 @@ fail:
 	bh = next;
     } while(bh != head);
     goto done;
+
+redirty_exit:
+    redirty_page_for_writepage(wbc, page);
+    unlock_page(page);
+    return error;
 }
 
 
