Date: Thu, 05 Aug 2004 14:00:10 +0200
From: olh@suse.de
Subject: Prevent legacy io access on pmac

The ppc32 common config runs also on PReP/CHRP, which uses PC style IO
devices.  The probing is bogus, it crashes or floods dmesg.

ppc can boot one single binary on prep, chrp and pmac boards.
ppc64 can boot one single binary on pseries and G5 boards.
pmac has no legacy io, probing for PC style legacy hardware leads to a
hard crash.
Several patches exist to prevent serial, floppy, ps2, parport and other
drivers from probing these io ports in the legacy IO space.
I think the simplest fix for 2.6 is a request_region of the problematic
areas.
Leave the serial ports open on Powerbooks with pccard slot, modem cards
should work that way.

Signed-off-by: Olaf Hering <olh@suse.de>

 arch/ppc/kernel/setup.c       |   16 ++++++++++++++++
 arch/ppc/platforms/pmac_pci.c |   14 ++++++++++++++
 arch/ppc64/kernel/pmac_pci.c  |    4 ++++
 arch/ppc64/kernel/setup.c     |    9 +++++++++
 drivers/serial/8250.c         |   13 +++++++++++++
 include/asm-ppc/io.h          |    4 ++++
 include/asm-ppc64/io.h        |    2 ++
 7 files changed, 62 insertions(+)

Index: linux-2.6.14/arch/powerpc/platforms/powermac/pci.c
===================================================================
--- linux-2.6.14.orig/arch/powerpc/platforms/powermac/pci.c	2005-12-01 13:13:43.873593413 +0100
+++ linux-2.6.14/arch/powerpc/platforms/powermac/pci.c	2005-12-01 13:28:06.344630601 +0100
@@ -840,6 +840,7 @@ pmac_pcibios_fixup(void)
 {
 	/* Fixup interrupts according to OF tree */
 	pcibios_fixup_OF_interrupts();
+	request_region(0x0UL, 0x10000UL, "reserved legacy io");
 }
 
 #ifdef CONFIG_PPC64
