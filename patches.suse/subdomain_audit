From: tonyj@suse.de
Subject: Export audit subsystem for use by modules
Patch-mainline: not yet -- pending AppArmor code submission

Adds necessary export symbols for audit subsystem routines.
Changes audit_log_vformat to be externally visible (analagous to vprintf)


--- linux-2.6.14-audit/include/linux/audit.h.orig	2005-11-22 15:49:57.000000000 -0800
+++ linux-2.6.14-audit/include/linux/audit.h	2005-11-22 15:55:35.000000000 -0800
@@ -73,6 +73,8 @@
 #define AUDIT_SELINUX_ERR	1401	/* Internal SE Linux Errors */
 #define AUDIT_AVC_PATH		1402	/* dentry, vfsmount pair from avc */
 
+#define AUDIT_SD		1500	/* AppArmor (SubDomain) audit */
+
 #define AUDIT_KERNEL		2000	/* Asynchronous audit record. NOT A REQUEST. */
 
 /* Rule flags */
@@ -265,6 +267,8 @@
 				      __attribute__((format(printf,4,5)));
 
 extern struct audit_buffer *audit_log_start(struct audit_context *ctx, int gfp_mask, int type);
+extern void		    audit_log_vformat(struct audit_buffer *ab, 
+					      const char *fmt, va_list args);
 extern void		    audit_log_format(struct audit_buffer *ab,
 					     const char *fmt, ...)
 			    __attribute__((format(printf,2,3)));
--- linux-2.6.14-audit/kernel/audit.c.orig	2005-11-22 15:56:39.000000000 -0800
+++ linux-2.6.14-audit/kernel/audit.c	2005-11-22 16:02:01.000000000 -0800
@@ -731,8 +731,8 @@
  * room in the audit buffer, more room will be allocated and vsnprint
  * will be called a second time.  Currently, we assume that a printk
  * can't format message larger than 1024 bytes, so we don't either. */
-static void audit_log_vformat(struct audit_buffer *ab, const char *fmt,
-			      va_list args)
+void audit_log_vformat(struct audit_buffer *ab, const char *fmt,
+		       va_list args)
 {
 	int len, avail;
 	struct sk_buff *skb;
@@ -893,3 +893,11 @@
 		audit_log_end(ab);
 	}
 }
+
+EXPORT_SYMBOL_GPL(audit_log_start);
+EXPORT_SYMBOL_GPL(audit_log_vformat);
+EXPORT_SYMBOL_GPL(audit_log_format);
+EXPORT_SYMBOL_GPL(audit_log_untrustedstring);
+EXPORT_SYMBOL_GPL(audit_log_d_path);
+EXPORT_SYMBOL_GPL(audit_log_end);
+EXPORT_SYMBOL_GPL(audit_log);
