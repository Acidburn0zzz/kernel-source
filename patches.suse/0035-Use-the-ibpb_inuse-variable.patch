From: Jun Nakajima <jun.nakajima@intel.com>
Date: Wed, 20 Dec 2017 08:04:53 -0800
Subject: Use the ibpb_inuse variable.
Patch-mainline: submitted on 2018/1/9
References: bnc#1068032 CVE-2017-5715

Signed-off-by: Jun Nakajima <jun.nakajima@intel.com>
Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 arch/x86/kvm/svm.c | 4 ++--
 arch/x86/kvm/vmx.c | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/x86/kvm/svm.c b/arch/x86/kvm/svm.c
index c4c34d532377..a7fd621e4174 100644
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@ -1719,7 +1719,7 @@ static void svm_free_vcpu(struct kvm_vcpu *vcpu)
 	 * The VMCB could be recycled, causing a false negative in svm_vcpu_load;
 	 * block speculative execution.
 	 */
-	if (static_cpu_has(X86_FEATURE_IBPB_SUPPORT))
+	if (ibpb_inuse)
 		wrmsrl(MSR_IA32_PRED_CMD, FEATURE_SET_IBPB);
 }
 
@@ -1757,7 +1757,7 @@ static void svm_vcpu_load(struct kvm_vcpu *vcpu, int cpu)
 
 	if (sd->current_vmcb != svm->vmcb) {
 		sd->current_vmcb = svm->vmcb;
-		if (static_cpu_has(X86_FEATURE_IBPB_SUPPORT))
+		if (ibpb_inuse)
 			wrmsrl(MSR_IA32_PRED_CMD, FEATURE_SET_IBPB);
 	}
 
diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index 0f7fe5c0d165..0f76d6303241 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -9365,7 +9365,7 @@ static void __noclone vmx_vcpu_run(struct kvm_vcpu *vcpu)
 	    vcpu->arch.pkru != vmx->host_pkru)
 		__write_pkru(vcpu->arch.pkru);
 
-	if (static_cpu_has(X86_FEATURE_SPEC_CTRL) &&
+	if (ibpb_inuse &&
 	    vmx->spec_ctrl != FEATURE_ENABLE_IBRS)
 		wrmsrl(MSR_IA32_SPEC_CTRL, vmx->spec_ctrl);
 
@@ -9498,7 +9498,7 @@ static void __noclone vmx_vcpu_run(struct kvm_vcpu *vcpu)
 #endif
 	      );
 
-	if (static_cpu_has(X86_FEATURE_SPEC_CTRL)) {
+	if (ibpb_inuse) {
 		rdmsrl(MSR_IA32_SPEC_CTRL, vmx->spec_ctrl);
 		if (vmx->spec_ctrl)
 			wrmsrl(MSR_IA32_SPEC_CTRL, FEATURE_ENABLE_IBRS);
-- 
2.15.1

