diff -u linux/arch/i386/mm/hugetlbpage.c-o linux/arch/i386/mm/hugetlbpage.c
--- linux/arch/i386/mm/hugetlbpage.c-o	2004-06-16 18:24:32.000000000 +0200
+++ linux/arch/i386/mm/hugetlbpage.c	2004-06-17 13:48:07.000000000 +0200
@@ -164,6 +164,8 @@
 	return -ENOMEM;
 }
 
+/* no force parameter right now unlike get_user_pages itself.
+   Could get funny effects on ptrace/core dumps. */
 int
 follow_hugetlb_page(struct mm_struct *mm, struct vm_area_struct *vma,
 		    struct page **pages, struct vm_area_struct **vmas,
@@ -171,6 +173,10 @@
 {
 	unsigned long vpfn, vaddr = *position;
 	int remainder = *length;
+	
+	long needed_flags = write ? VM_WRITE : VM_READ; 
+	if ((vma->vm_flags & needed_flags) == 0)
+		return -EFAULT;
 
 	spin_lock(&mm->page_table_lock);
 	vpfn = vaddr/PAGE_SIZE;
@@ -184,10 +190,6 @@
 				pte = huge_pte_offset(mm, vaddr);
 				if (pte && !pte_none(*pte))
 					break; 
-				if (!write) { 
-					spin_unlock(&mm->page_table_lock);
-					return -EFAULT;
-				}
 				switch (hugetlb_alloc_fault(mm, vma, vaddr, 0)) { 
 				case VM_FAULT_SIGBUS:
 					return -EFAULT;
@@ -355,7 +357,7 @@
 hugetlb_alloc_fault(struct mm_struct *mm, struct vm_area_struct *vma, 
 			       unsigned long addr, int flush)
 {
-		unsigned long idx;
+	unsigned long idx;
 	int ret;
 	pte_t *pte;
 	struct page *page = NULL;
diff -u linux/arch/ia64/mm/hugetlbpage.c-o linux/arch/ia64/mm/hugetlbpage.c
--- linux/arch/ia64/mm/hugetlbpage.c-o	2004-06-16 18:24:32.000000000 +0200
+++ linux/arch/ia64/mm/hugetlbpage.c	2004-06-17 13:50:51.000000000 +0200
@@ -192,6 +192,10 @@
 	int len = *length;
 	struct page *page;
 
+	long needed_flags = write ? VM_WRITE : VM_READ; 
+	if ((vma->vm_flags & needed_flags) == 0)
+		return -EFAULT;
+
 	spin_lock(&mm->page_table_lock);
 	do {
 		pstart = start & HPAGE_MASK;
@@ -200,10 +204,6 @@
 			pte = huge_pte_offset(mm, start);
 			if (pte && !pte_none(*pte))
 				break; 
-			if (!write) { 
-				spin_unlock(&mm->page_table_lock);
-				return -EFAULT;
-			}
 			spin_unlock(&mm->page_table_lock); 
 			switch (arch_hugetlb_fault(mm, vma, start, write)) { 
 			case VM_FAULT_SIGBUS:
