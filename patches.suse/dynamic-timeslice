From: garloff@suse.de
Subject: allow tuning of scheduling timeslices

Forward port from andrea's 2.4 patch.

 include/linux/sched.h  |    1 +
 include/linux/sysctl.h |    3 +++
 kernel/sched.c         |   20 +++++++++++++++++---
 kernel/sysctl.c        |   25 +++++++++++++++++++++++++
 4 files changed, 46 insertions(+), 3 deletions(-)

Index: linux-2.6.15/include/linux/sched.h
===================================================================
--- linux-2.6.15.orig/include/linux/sched.h	2006-02-20 16:08:55.000000000 +0100
+++ linux-2.6.15/include/linux/sched.h	2006-02-20 16:12:46.000000000 +0100
@@ -234,6 +234,7 @@
 extern signed long schedule_timeout_interruptible(signed long timeout);
 extern signed long schedule_timeout_uninterruptible(signed long timeout);
 asmlinkage void schedule(void);
+extern int def_timeslice, min_timeslice;
 
 struct namespace;
 
Index: linux-2.6.15/include/linux/sysctl.h
===================================================================
--- linux-2.6.15.orig/include/linux/sysctl.h	2006-02-20 16:08:55.000000000 +0100
+++ linux-2.6.15/include/linux/sysctl.h	2006-02-20 16:13:20.000000000 +0100
@@ -151,6 +151,9 @@
 	KERN_DUMP=73,		/* directory: dump parameters */
 	KERN_DELAYACCT=74,	/* int: Per-task delay accounting on/off */
 	KERN_SCHEDSTATS=75,	/* int: Schedstats on/off */
+	KERN_DEFTIMESLICE=76,	/* int: nice   0 def timeslice */
+	KERN_MINTIMESLICE=77,	/* int: nice +19 min timeslice */
+	KERN_HZ=78,		/* unsigned long: internal kernel HZ */
 };
 
 
Index: linux-2.6.15/kernel/sched.c
===================================================================
--- linux-2.6.15.orig/kernel/sched.c	2006-02-20 16:08:55.000000000 +0100
+++ linux-2.6.15/kernel/sched.c	2006-02-20 16:12:46.000000000 +0100
@@ -92,8 +92,11 @@
  * default timeslice is 100 msecs, maximum timeslice is 800 msecs.
  * Timeslices get refilled after they expire.
  */
-#define MIN_TIMESLICE		max(5 * HZ / 1000, 1)
-#define DEF_TIMESLICE		(100 * HZ / 1000)
+#define __MIN_TIMESLICE		  4000 /* usec userspace */
+#define __DEF_TIMESLICE		104000 /* usec userspace */
+int def_timeslice = __DEF_TIMESLICE, min_timeslice = __MIN_TIMESLICE;
+#define MIN_TIMESLICE ((min_timeslice * HZ + 999999) / 1000000)
+#define DEF_TIMESLICE ((def_timeslice * HZ + 999999) / 1000000)
 #define ON_RUNQUEUE_WEIGHT	 30
 #define CHILD_PENALTY		 95
 #define PARENT_PENALTY		100
Index: linux-2.6.15/kernel/sysctl.c
===================================================================
--- linux-2.6.15.orig/kernel/sysctl.c	2006-02-20 16:08:55.000000000 +0100
+++ linux-2.6.15/kernel/sysctl.c	2006-02-20 16:12:46.000000000 +0100
@@ -175,6 +175,7 @@
 static void unregister_proc_table(ctl_table *, struct proc_dir_entry *);
 #endif
 
+static unsigned int __HZ = HZ;
 /* The default sysctl tables: */
 
 static ctl_table root_table[] = {
@@ -668,6 +669,30 @@
 		.proc_handler	= &proc_dointvec,
 	},
 #endif
+	{
+		.ctl_name	= KERN_DEFTIMESLICE,
+		.procname	= "def-timeslice",
+		.data		=  &def_timeslice,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= &proc_dointvec,
+	},
+	{
+		.ctl_name	= KERN_MINTIMESLICE,
+		.procname	= "min-timeslice",
+		.data		= &min_timeslice,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= &proc_dointvec,
+	},
+	{
+		.ctl_name	= KERN_HZ,
+		.procname	= "HZ",
+		.data		= &__HZ,
+		.maxlen		= sizeof(int),
+		.mode		= 0444,
+		.proc_handler	= &proc_dointvec,
+	},
 	{ .ctl_name = 0 }
 };
 
