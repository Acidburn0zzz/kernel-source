Index: linux-2.6.5/arch/i386/kernel/vsyscall-int80.S
===================================================================
--- linux-2.6.5.orig/arch/i386/kernel/vsyscall-int80.S	2004-04-04 05:38:17.000000000 +0200
+++ linux-2.6.5/arch/i386/kernel/vsyscall-int80.S	2004-04-26 11:16:59.000000000 +0200
@@ -1,3 +1,6 @@
+#include <linux/config.h>
+#include <asm/unistd.h>
+#include <asm/vsyscall-gtod.h>
 /*
  * Code for the vsyscall page.  This version uses the old int $0x80 method.
  *
@@ -12,8 +15,26 @@
 	.type __kernel_vsyscall,@function
 __kernel_vsyscall:
 .LSTART_vsyscall:
+#ifdef CONFIG_VSYSCALL_GTOD
+	cmp $__NR_gettimeofday, %eax
+	je .Lvgettimeofday
+#endif /* CONFIG_VSYSCALL_GTOD */
 	int $0x80
 	ret
+
+#ifdef CONFIG_VSYSCALL_GTOD
+/* vsyscall-gettimeofday code */
+.Lvgettimeofday:
+	pushl %edx
+	pushl %ecx
+	pushl %ebx
+	call VSYSCALL_GTOD_START
+	popl %ebx
+	popl %ecx
+	popl %edx
+	ret
+#endif /* CONFIG_VSYSCALL_GTOD */
+
 .LEND_vsyscall:
 	.size __kernel_vsyscall,.-.LSTART_vsyscall
 	.previous
Index: linux-2.6.5/arch/i386/kernel/vsyscall-sigreturn.S
===================================================================
--- linux-2.6.5.orig/arch/i386/kernel/vsyscall-sigreturn.S	2004-04-04 05:37:40.000000000 +0200
+++ linux-2.6.5/arch/i386/kernel/vsyscall-sigreturn.S	2004-04-26 11:17:23.000000000 +0200
@@ -15,7 +15,7 @@
 */
 
 	.text
-	.org	__kernel_vsyscall+32
+	.org	__kernel_vsyscall+64
 	.globl __kernel_sigreturn
 	.type __kernel_sigreturn,@function
 __kernel_sigreturn:
Index: linux-2.6.5/arch/i386/kernel/vsyscall-sysenter.S
===================================================================
--- linux-2.6.5.orig/arch/i386/kernel/vsyscall-sysenter.S	2004-04-04 05:36:57.000000000 +0200
+++ linux-2.6.5/arch/i386/kernel/vsyscall-sysenter.S	2004-04-26 11:16:59.000000000 +0200
@@ -1,3 +1,6 @@
+#include <linux/config.h>
+#include <asm/unistd.h>
+#include <asm/vsyscall-gtod.h>
 /*
  * Code for the vsyscall page.  This version uses the sysenter instruction.
  *
@@ -12,6 +15,10 @@
 	.type __kernel_vsyscall,@function
 __kernel_vsyscall:
 .LSTART_vsyscall:
+#ifdef CONFIG_VSYSCALL_GTOD
+	cmp $__NR_gettimeofday, %eax
+	je .Lvgettimeofday
+#endif /* CONFIG_VSYSCALL_GTOD */
 	push %ecx
 .Lpush_ecx:
 	push %edx
@@ -36,6 +43,20 @@
 	pop %ecx
 .Lpop_ecx:
 	ret
+
+#ifdef CONFIG_VSYSCALL_GTOD
+/* vsyscall-gettimeofday code */
+.Lvgettimeofday:
+	pushl %edx
+	pushl %ecx
+	pushl %ebx
+	call VSYSCALL_GTOD_START
+	popl %ebx
+	popl %ecx
+	popl %edx
+	ret
+#endif /* CONFIG_VSYSCALL_GTOD */
+
 .LEND_vsyscall:
 	.size __kernel_vsyscall,.-.LSTART_vsyscall
 	.previous
