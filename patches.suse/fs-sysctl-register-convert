From: Olaf Kirch <okir@suse.de>
Subject: Make sunrpc and lockd use register_sysctl_table_path

  This changes lockd and sunrpc to use the new register_sysctl_table_path
  call.

Signed-off-by: Olaf Kirch <okir@suse.de>

 fs/lockd/svc.c      |   29 ++++++-----------------------
 net/sunrpc/sysctl.c |   16 ++++------------
 2 files changed, 10 insertions(+), 35 deletions(-)

--- linux-2.6.19.orig/net/sunrpc/sysctl.c
+++ linux-2.6.19/net/sunrpc/sysctl.c
@@ -36,7 +36,9 @@ void
 rpc_register_sysctl(void)
 {
 	if (!sunrpc_table_header) {
-		sunrpc_table_header = register_sysctl_table(sunrpc_table, 1);
+		struct ctl_path ctl_path[] = { { CTL_SUNRPC, "sunrpc", 0555 }, { 0 } };
+
+		sunrpc_table_header = register_sysctl_table_path(sunrpc_table, ctl_path);
 #ifdef CONFIG_PROC_FS
 		if (sunrpc_table[0].de)
 			sunrpc_table[0].de->owner = THIS_MODULE;
@@ -118,7 +120,7 @@ done:
 }
 
 
-static ctl_table debug_table[] = {
+static ctl_table sunrpc_table[] = {
 	{
 		.ctl_name	= CTL_RPCDEBUG,
 		.procname	= "rpc_debug",
@@ -154,14 +156,4 @@ static ctl_table debug_table[] = {
 	{ .ctl_name = 0 }
 };
 
-static ctl_table sunrpc_table[] = {
-	{
-		.ctl_name	= CTL_SUNRPC,
-		.procname	= "sunrpc",
-		.mode		= 0555,
-		.child		= debug_table
-	},
-	{ .ctl_name = 0 }
-};
-
 #endif
--- linux-2.6.19.orig/fs/lockd/svc.c
+++ linux-2.6.19/fs/lockd/svc.c
@@ -413,26 +413,6 @@ static ctl_table nlm_sysctls[] = {
 	{ .ctl_name = 0 }
 };
 
-static ctl_table nlm_sysctl_dir[] = {
-	{
-		.ctl_name	= CTL_UNNUMBERED,
-		.procname	= "nfs",
-		.mode		= 0555,
-		.child		= nlm_sysctls,
-	},
-	{ .ctl_name = 0 }
-};
-
-static ctl_table nlm_sysctl_root[] = {
-	{
-		.ctl_name	= CTL_FS,
-		.procname	= "fs",
-		.mode		= 0555,
-		.child		= nlm_sysctl_dir,
-	},
-	{ .ctl_name = 0 }
-};
-
 /*
  * Module (and driverfs) parameters.
  */
@@ -506,15 +486,18 @@ module_param(nsm_use_hostnames, bool, 06
 
 static int __init init_nlm(void)
 {
-	nlm_sysctl_table = register_sysctl_table(nlm_sysctl_root, 0);
-	return nlm_sysctl_table ? 0 : -ENOMEM;
+	struct ctl_path ctl_path[] = { { CTL_FS, "fs", 0555 }, { -2, "nfs", 0555 }, { 0 } };
+
+	nlm_sysctl_table = register_sysctl_table_path(nlm_sysctls, ctl_path);
+	return 0;
 }
 
 static void __exit exit_nlm(void)
 {
 	/* FIXME: delete all NLM clients */
 	nlm_shutdown_hosts();
-	unregister_sysctl_table(nlm_sysctl_table);
+	if (nlm_sysctl_table)
+		unregister_sysctl_table(nlm_sysctl_table);
 }
 
 module_init(init_nlm);
