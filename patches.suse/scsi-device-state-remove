diff -urp /mnt/kscratch/linux-2.6.5/drivers/scsi/scsi.c linux-2.6.5-SUSE-20040614/drivers/scsi/scsi.c
--- /mnt/kscratch/linux-2.6.5/drivers/scsi/scsi.c	2004-06-14 13:22:55.000000000 +0200
+++ linux-2.6.5-SUSE-20040614/drivers/scsi/scsi.c	2004-06-14 20:06:44.066070192 +0200
@@ -979,7 +979,7 @@ int scsi_device_get(struct scsi_device *
 {
 	if (!sdev)
 		return -ENXIO;
-	if (sdev->sdev_state == SDEV_DEL)
+	if (sdev->sdev_state == SDEV_DEL || sdev->sdev_state == SDEV_CANCEL)
 		return -ENXIO;
 	if (!get_device(&sdev->sdev_gendev))
 		return -ENXIO;
diff -urp /mnt/kscratch/linux-2.6.5/drivers/scsi/scsi_sysfs.c linux-2.6.5-SUSE-20040614/drivers/scsi/scsi_sysfs.c
--- /mnt/kscratch/linux-2.6.5/drivers/scsi/scsi_sysfs.c	2004-06-14 13:22:35.000000000 +0200
+++ linux-2.6.5-SUSE-20040614/drivers/scsi/scsi_sysfs.c	2004-06-14 20:18:29.643420435 +0200
@@ -459,18 +459,19 @@ int scsi_sysfs_add_sdev(struct scsi_devi
  **/
 void scsi_remove_device(struct scsi_device *sdev)
 {
-	if (sdev->sdev_state == SDEV_RUNNING || sdev->sdev_state == SDEV_CANCEL) {
-		scsi_device_set_state(sdev, SDEV_DEL);
-		class_device_unregister(&sdev->sdev_classdev);
-		if(sdev->transport_classdev.class)
-			class_device_unregister(&sdev->transport_classdev);
-		device_del(&sdev->sdev_gendev);
-		if (sdev->host->hostt->slave_destroy)
-			sdev->host->hostt->slave_destroy(sdev);
-		if (sdev->host->transportt->cleanup)
-			sdev->host->transportt->cleanup(sdev);
-		put_device(&sdev->sdev_gendev);
-	}
+	if (scsi_device_set_state(sdev, SDEV_CANCEL) != 0)
+		return;
+
+	class_device_unregister(&sdev->sdev_classdev);
+	if( sdev->transport_classdev.class)
+		class_device_unregister(&sdev->transport_classdev);
+	device_del(&sdev->sdev_gendev);
+	scsi_device_set_state(sdev, SDEV_DEL);
+	if (sdev->host->hostt->slave_destroy)
+		sdev->host->hostt->slave_destroy(sdev);
+	if (sdev->host->transportt->cleanup)
+		sdev->host->transportt->cleanup(sdev);
+	put_device(&sdev->sdev_gendev);
 }
 
 int scsi_register_driver(struct device_driver *drv)
