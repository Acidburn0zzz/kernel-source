From: Takashi Iwai <tiwai@suse.de>
Subject: Support polling mode for ata_piix
Patch-mainline: 
References: 

Signed-off-by: Takashi Iwai <tiwai@suse.de>

--- linux-2.6.15/drivers/scsi/ata_piix.c-dist	2006-01-30 16:50:08.000000000 +0100
+++ linux-2.6.15/drivers/scsi/ata_piix.c	2006-01-30 18:30:17.000000000 +0100
@@ -192,6 +192,8 @@ static struct scsi_host_template piix_sh
 	.bios_param		= ata_std_bios_param,
 	.resume			= ata_scsi_device_resume,
 	.suspend		= ata_scsi_device_suspend,
+	.dump_quiesce		= ata_scsi_dump_quiesce,
+	.dump_poll		= ata_scsi_dump_poll,
 };
 
 static const struct ata_port_operations piix_pata_ops = {
--- linux-2.6.15/drivers/scsi/libata-core.c-dist	2006-01-30 16:50:11.000000000 +0100
+++ linux-2.6.15/drivers/scsi/libata-core.c	2006-01-30 18:30:17.000000000 +0100
@@ -5173,6 +5173,8 @@ EXPORT_SYMBOL_GPL(ata_dev_classify);
 EXPORT_SYMBOL_GPL(ata_dev_id_string);
 EXPORT_SYMBOL_GPL(ata_dev_config);
 EXPORT_SYMBOL_GPL(ata_scsi_simulate);
+EXPORT_SYMBOL_GPL(ata_scsi_dump_quiesce);
+EXPORT_SYMBOL_GPL(ata_scsi_dump_poll);
 
 EXPORT_SYMBOL_GPL(ata_pio_need_iordy);
 EXPORT_SYMBOL_GPL(ata_timing_compute);
--- linux-2.6.15/drivers/scsi/libata-scsi.c-dist	2006-01-30 16:50:00.000000000 +0100
+++ linux-2.6.15/drivers/scsi/libata-scsi.c	2006-01-30 18:30:17.000000000 +0100
@@ -412,6 +412,33 @@ int ata_scsi_device_suspend(struct scsi_
 	return ata_device_suspend(ap, dev);
 }
 
+/* LKCD ops */
+int ata_scsi_dump_quiesce(struct scsi_device *device)
+{
+	struct ata_port *ap = (struct ata_port *) device->host->hostdata;
+	struct ata_host_set *host_set = ap->host_set;
+
+	/*
+	 * Give the device 1 second to finish whatever it might be doing,
+	 * then deal with any pending interrupts.
+	 */
+	mdelay(1000);
+	ap->ops->irq_handler(0, host_set, NULL);
+
+	ap->qactive = 0;
+	ap->active_tag = ATA_TAG_POISON;
+
+	return 0;
+}
+
+void ata_scsi_dump_poll(struct scsi_device *device)
+{
+	struct ata_port *ap = (struct ata_port *) device->host->hostdata;
+	struct ata_host_set *host_set = ap->host_set;
+
+	ap->ops->irq_handler(0, host_set, NULL);
+}
+
 /**
  *	ata_to_sense_error - convert ATA error to SCSI error
  *	@id: ATA device number
--- linux-2.6.15/include/linux/libata.h-dist	2006-01-30 16:50:15.000000000 +0100
+++ linux-2.6.15/include/linux/libata.h	2006-01-30 18:30:17.000000000 +0100
@@ -499,6 +499,10 @@ extern int ata_std_bios_param(struct scs
 			      sector_t capacity, int geom[]);
 extern int ata_scsi_slave_config(struct scsi_device *sdev);
 
+/* LKCD dump ops */
+int ata_scsi_dump_quiesce(struct scsi_device *device);
+void ata_scsi_dump_poll(struct scsi_device *device);
+
 /*
  * Timing helpers
  */
