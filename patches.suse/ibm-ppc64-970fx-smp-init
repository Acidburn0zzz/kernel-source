ChangeSet
  1.1724 04/05/14 20:07:57 benh@kernel.crashing.org[torvalds] +1 -0
  [PATCH] ppc64: Add proper  SMP init on dual 970FX based machines
  
  This patch fixes SMP boot on Apple Xserve G5

diff -Nru a/arch/ppc64/kernel/cpu_setup_power4.S b/arch/ppc64/kernel/cpu_setup_power4.S
--- a/arch/ppc64/kernel/cpu_setup_power4.S	Sat May 15 07:50:05 2004
+++ b/arch/ppc64/kernel/cpu_setup_power4.S	Sat May 15 07:50:05 2004
@@ -119,7 +119,9 @@
 	/* We only deal with 970 for now */
 	mfspr	r0,SPRN_PVR
 	srwi	r0,r0,16
-	cmpwi	r0,0x39
+	cmpwi	cr0,r0,0x39
+	cmpwi	cr1,r0,0x3c
+	cror	4*cr0+eq,4*cr0+eq,4*cr1+eq
 	bne	1f
 
 	/* Save HID0,1,4 and 5 */
@@ -149,7 +151,9 @@
 	/* We only deal with 970 for now */
 	mfspr	r0,SPRN_PVR
 	srwi	r0,r0,16
-	cmpwi	r0,0x39
+	cmpwi	cr0,r0,0x39
+	cmpwi	cr1,r0,0x3c
+	cror	4*cr0+eq,4*cr0+eq,4*cr1+eq
 	bne	1f
 
 	/* Clear interrupt prefix */
.........................................................................
# vim: syntax=diff

