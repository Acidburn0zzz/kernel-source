Hello everyone,

This patch turns on barriers by default for ext3.  mount -o barrier=0
will turn them off.  It also changes the ext3 fsync call to trigger a
barrier when a commit isn't done.

It should be safe, but some extra review would be appreciated.

--- /opt/kernel/linux-2.6.7/fs/ext3/fsync.c	2004-08-10 10:38:55.000000000 +0200
+++ linux-2.6.7/fs/ext3/fsync.c	2004-08-10 11:59:19.711655296 +0200
@@ -27,6 +27,7 @@
 #include <linux/sched.h>
 #include <linux/writeback.h>
 #include <linux/jbd.h>
+#include <linux/blkdev.h>
 #include <linux/ext3_fs.h>
 #include <linux/ext3_jbd.h>
 
@@ -85,7 +86,10 @@
 			.sync_mode = WB_SYNC_ALL,
 			.nr_to_write = 0, /* sys_fsync did this */
 		};
+		journal_t *journal = EXT3_SB(inode->i_sb)->s_journal;
 		ret = sync_inode(inode, &wbc);
+		if (journal && (journal->j_flags & JFS_BARRIER))
+			blkdev_issue_flush(inode->i_sb->s_bdev, NULL);
 	}
 out:
 	return ret;
--- /opt/kernel/linux-2.6.7/fs/ext3/super.c	2004-08-10 10:38:55.000000000 +0200
+++ linux-2.6.7/fs/ext3/super.c	2004-08-10 11:59:08.122898143 +0200
@@ -1288,6 +1297,9 @@
 	sbi->s_resuid = le16_to_cpu(es->s_def_resuid);
 	sbi->s_resgid = le16_to_cpu(es->s_def_resgid);
 
+	/* enable barriers by default */
+	set_opt(sbi->s_mount_opt, BARRIER);
+
 	if (!parse_options ((char *) data, sb, &journal_inum, 0))
 		goto failed_mount;
 
