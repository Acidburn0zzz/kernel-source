
I would like to commit the following patch from mainline to CVS.

It improves suspend/resume with Intel AGP bridges. Hopefully it will fix a few
Centrino laptops. The patch is low risk because it only touches the suspend path and 
suspend to ram is a building place and mostly broken anyways, so it's unlikely
to get any worse.

Comments?

-Andi

Begin forwarded message:

Date: Tue, 01 Jun 2004 09:35:02 +0000
From: Linux Kernel Mailing List <linux-kernel@vger.kernel.org>
To: bk-commits-head@vger.kernel.org
Subject: [AGPGART] Improve the resume functions for Intel AGP bridges by restoring config space


ChangeSet 1.1371.675.23, 2004/06/01 10:35:02+01:00, davej@redhat.com

	[AGPGART] Improve the resume functions for Intel AGP bridges by restoring config space
	(the bios might not have done that).
	
	From: Arjan van de Ven



 intel-agp.c     |    8 ++------
 intel-mch-agp.c |    8 ++------
 2 files changed, 4 insertions(+), 12 deletions(-)


diff -Nru a/drivers/char/agp/intel-agp.c b/drivers/char/agp/intel-agp.c
--- a/drivers/char/agp/intel-agp.c	2004-06-03 07:14:42 -07:00
+++ b/drivers/char/agp/intel-agp.c	2004-06-03 07:14:42 -07:00
@@ -1445,14 +1445,11 @@
 	agp_put_bridge(bridge);
 }
 
-static int agp_intel_suspend(struct pci_dev *dev, u32 state)
-{
-	return 0;
-}
-
 static int agp_intel_resume(struct pci_dev *pdev)
 {
 	struct agp_bridge_data *bridge = pci_get_drvdata(pdev);
+	
+	pci_restore_state(pdev, pdev->saved_config_space);
 
 	if (bridge->driver == &intel_generic_driver)
 		intel_configure();
@@ -1506,7 +1503,6 @@
 	.id_table	= agp_intel_pci_table,
 	.probe		= agp_intel_probe,
 	.remove		= agp_intel_remove,
-	.suspend	= agp_intel_suspend,
 	.resume		= agp_intel_resume,
 };
 
diff -Nru a/drivers/char/agp/intel-mch-agp.c b/drivers/char/agp/intel-mch-agp.c
--- a/drivers/char/agp/intel-mch-agp.c	2004-06-03 07:14:42 -07:00
+++ b/drivers/char/agp/intel-mch-agp.c	2004-06-03 07:14:42 -07:00
@@ -569,14 +569,11 @@
 	agp_put_bridge(bridge);
 }
 
-static int agp_intelmch_suspend(struct pci_dev *dev, u32 state)
-{
-	return 0;
-}
-
 static int agp_intelmch_resume(struct pci_dev *pdev)
 {
 	struct agp_bridge_data *bridge = pci_get_drvdata(pdev);
+	
+	pci_restore_state(pdev, pdev->saved_config_space);
 
 	if (bridge->driver == &intel_845_driver)
 		intel_845_configure();
@@ -611,7 +608,6 @@
 	.id_table	= agp_intelmch_pci_table,
 	.probe		= agp_intelmch_probe,
 	.remove		= agp_intelmch_remove,
-	.suspend	= agp_intelmch_suspend,
 	.resume		= agp_intelmch_resume,
 };
 
-
To unsubscribe from this list: send the line "unsubscribe bk-commits-head" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  http://vger.kernel.org/majordomo-info.html

