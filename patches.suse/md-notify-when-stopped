From: NeilBrown <neilb@suse.de>
Subject: md: notify udev when an md array is stopped.
Patch-mainline: 2.6.28-rc3
References: fate#303894

When an md array is stopped we need to tear down the partitions
and signal udev to remove any (/dev/disk/by-id/md*) links.
Otherwise /dev can become a bit of a mess.

Signed-off-by: Neil Brown <neilb@suse.de>

---
 drivers/md/md.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- linux-2.6.27-neilb.orig/drivers/md/md.c
+++ linux-2.6.27-neilb/drivers/md/md.c
@@ -3898,6 +3898,7 @@ static int do_md_stop(mddev_t * mddev, i
 	if (mode == 0) {
 		mdk_rdev_t *rdev;
 		struct list_head *tmp;
+		struct block_device *bdev;
 
 		printk(KERN_INFO "md: %s stopped.\n", mdname(mddev));
 
@@ -3955,6 +3956,13 @@ static int do_md_stop(mddev_t * mddev, i
 		mddev->barriers_work = 0;
 		mddev->safemode = 0;
 
+		bdev = bdget_disk(mddev->gendisk, 0);
+		if (bdev) {
+			blkdev_ioctl(bdev->bd_inode, NULL, BLKRRPART, 0);
+			bdput(bdev);
+		}
+		kobject_uevent(&mddev->gendisk->dev.kobj, KOBJ_CHANGE);
+
 	} else if (mddev->pers)
 		printk(KERN_INFO "md: %s switched to read-only mode.\n",
 			mdname(mddev));
