
revalidate_special() can be successfull returning a negative dentry.
We need to check for that unconditionally, not just in the error
case as done by the lustre VFS changes.



diff -puN fs/namei.c~fix-revalidate-special fs/namei.c
--- linux-2.6.5-vfs/fs/namei.c~fix-revalidate-special	2004-05-29 13:08:54.909894976 -0700
+++ linux-2.6.5-vfs-dipankar/fs/namei.c	2004-05-29 13:13:31.012985416 -0700
@@ -764,17 +764,15 @@ last_component:
  				nd->flags |= LOOKUP_LAST;
  				err = revalidate_special(nd);
  				nd->flags &= ~LOOKUP_LAST;
+				if (!nd->dentry->d_inode)
+					err = -ENOENT;
 				if (err)
  					break;
 				goto return_reval;
 		}
-		
-		if (err) {
-			if (!nd->dentry->d_inode)
-				err = -ENOENT;
-			
+
+		if (err)
 			goto return_err;			
-		}
 		
 		if (nd->dentry->d_op && nd->dentry->d_op->d_hash) {
 			err = nd->dentry->d_op->d_hash(nd->dentry, &this);

_
