From: Jaroslav Kysela <perex.suse.cz>
Subject: Fix debug traces for bonding (might_sleep)
References: 174843

The network bonding module might call rtmsg_ifinfo in the atomic context.
It is not ideal solution - ideally, the bonding module will use a workqueue.

Signed-off-by: Jaroslav Kysela <perex@suse.cz>
Acked-by: Olaf Kirch <okir@suse.de>

---
 net/core/rtnetlink.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

--- linux-2.6.18.orig/net/core/rtnetlink.c
+++ linux-2.6.18/net/core/rtnetlink.c
@@ -612,7 +612,7 @@ void rtmsg_ifinfo(int type, struct net_d
 			       sizeof(struct rtnl_link_ifmap) +
 			       sizeof(struct rtnl_link_stats) + 128);
 
-	skb = alloc_skb(size, GFP_KERNEL);
+	skb = alloc_skb(size, in_atomic() ? GFP_ATOMIC : GFP_KERNEL);
 	if (!skb)
 		return;
 
@@ -621,7 +621,7 @@ void rtmsg_ifinfo(int type, struct net_d
 		return;
 	}
 	NETLINK_CB(skb).dst_group = RTNLGRP_LINK;
-	netlink_broadcast(rtnl, skb, 0, RTNLGRP_LINK, GFP_KERNEL);
+	netlink_broadcast(rtnl, skb, 0, RTNLGRP_LINK, in_atomic() ? GFP_ATOMIC : GFP_KERNEL);
 }
 
 /* Protected by RTNL sempahore.  */
