diff -u linux/arch/i386/mm/hugetlbpage.c-o linux/arch/i386/mm/hugetlbpage.c
--- linux/arch/i386/mm/hugetlbpage.c-o	2004-06-03 12:02:54.000000000 +0200
+++ linux/arch/i386/mm/hugetlbpage.c	2004-06-03 20:08:33.000000000 +0200
@@ -356,6 +356,7 @@
 	
 	idx = ((addr - vma->vm_start) >> HPAGE_SHIFT)
 		+ (vma->vm_pgoff >> (HPAGE_SHIFT - PAGE_SHIFT));
+ retry:
 	page = find_get_page(mapping, idx);
 	if (!page) {
 		/* Should do this at prefault time, but that gets us into
@@ -383,9 +384,11 @@
 		ret = add_to_page_cache(page, mapping, idx, GFP_ATOMIC);
 		if (!ret)
 			unlock_page(page);
-		if (ret) {
+		if (ret) {        		
 			hugetlb_put_quota(mapping);
-			free_huge_page(page);
+			huge_page_release(page);
+			if (ret == -EEXIST)
+				goto retry;
 			ret = VM_FAULT_SIGBUS;
 			goto out;
 		}
diff -u linux/arch/ia64/mm/hugetlbpage.c-o linux/arch/ia64/mm/hugetlbpage.c
--- linux/arch/ia64/mm/hugetlbpage.c-o	2004-06-03 12:02:54.000000000 +0200
+++ linux/arch/ia64/mm/hugetlbpage.c	2004-06-03 20:08:07.000000000 +0200
@@ -672,7 +672,7 @@
 		if (!ret) {
 			unlock_page(page);
 		} else {
-			free_huge_page(page);
+			huge_page_release(page);	
 			if (ret == -EEXIST)
 				goto retry;
 			else
diff -u linux/arch/ppc64/mm/hugetlbpage.c-o linux/arch/ppc64/mm/hugetlbpage.c
--- linux/arch/ppc64/mm/hugetlbpage.c-o	2004-06-03 12:02:54.000000000 +0200
+++ linux/arch/ppc64/mm/hugetlbpage.c	2004-06-03 20:08:24.000000000 +0200
@@ -555,6 +555,7 @@
 
 		idx = ((addr - vma->vm_start) >> HPAGE_SHIFT)
 			+ (vma->vm_pgoff >> (HPAGE_SHIFT - PAGE_SHIFT));
+	retry:
 		page = find_get_page(mapping, idx);
 		if (!page) {
 			/* charge the fs quota first */
@@ -569,10 +570,13 @@
 				goto out;
 			}
 			ret = add_to_page_cache(page, mapping, idx, GFP_ATOMIC);
-			unlock_page(page);
+			if (!ret)
+				unlock_page(page);
 			if (ret) {
 				hugetlb_put_quota(mapping);
-				free_huge_page(page);
+				huge_page_release(page);
+				if (ret == -EEXIST)
+					goto retry;
 				goto out;
 			}
 		}
