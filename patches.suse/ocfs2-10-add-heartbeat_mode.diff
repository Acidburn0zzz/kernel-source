From: Jeff Mahoney <jeffm@suse.com>
Subject: [PATCH 14/15] ocfs2: add the ability to switch between heartbeat group modes

 This patch allows the user to switch heartbeat modes by writing the desired
 mode into /sys/o2cb/heartbeat_mode.

 The mode cannot be switched when another is in use. This means that
 <configfs>/cluster/ must be empty.

 fs/ocfs2/cluster/heartbeat.h |    3 +++
 fs/ocfs2/cluster/sys.c       |   18 ++++++++++++++++--
 2 files changed, 19 insertions(+), 2 deletions(-)

Signed-off-by: Jeff Mahoney <jeffm@suse.com>

--- a/fs/ocfs2/cluster/heartbeat.h	2008-02-08 15:53:43.000000000 -0500
+++ b/fs/ocfs2/cluster/heartbeat.h	2008-02-08 15:53:43.000000000 -0500
@@ -124,6 +124,9 @@ int o2hb_check_node_heartbeating_from_ca
                                                u8 node_num);
 int o2hb_check_local_node_heartbeating(const char *resource);
 
+const char *o2hb_heartbeat_mode(void);
+int o2hb_set_heartbeat_mode(const char *type, size_t count);
+
 static inline struct o2hb_heartbeat_group *to_o2hb_heartbeat_group(struct config_group *group)
 {
 	return container_of(group, struct o2hb_heartbeat_group, hs_group);
--- a/fs/ocfs2/cluster/sys.c	2008-02-08 15:53:14.000000000 -0500
+++ b/fs/ocfs2/cluster/sys.c	2008-02-08 15:53:43.000000000 -0500
@@ -1,5 +1,4 @@
-/* -*- mode: c; c-basic-offset: 8; -*-
- * vim: noexpandtab sw=8 ts=8 sts=0:
+/* -*- mode: c; c-basic-offset: 8; -*- * vim: noexpandtab sw=8 ts=8 sts=0:
  *
  * sys.c
  *
@@ -30,6 +29,7 @@
 #include <linux/sysfs.h>
 
 #include "ocfs2_nodemanager.h"
+#include "heartbeat.h"
 #include "masklog.h"
 #include "sys.h"
 
@@ -51,8 +51,26 @@ static ssize_t o2cb_interface_revision_s
 static struct kobj_attribute attr_version =
 	__ATTR(interface_revision, S_IFREG | S_IRUGO, version_show, NULL);
 
+static ssize_t heartbeat_mode_show(struct kobject *kobj,
+				   struct kobj_attribute *attr, char *buf)
+{
+	return snprintf(buf, PAGE_SIZE, "%s\n", o2hb_heartbeat_mode());
+}
+
+static ssize_t heartbeat_mode_store(struct kobject *kobj,
+				    struct kobj_attribute *attr,
+				    const char *buffer, size_t count)
+{
+	return o2hb_set_heartbeat_mode(buffer, count);
+}
+
+static struct kobj_attribute attr_heartbeat_mode =
+	__ATTR(heartbeat_mode, S_IFREG | S_IRUGO | S_IWUSR,
+                 heartbeat_mode_show, heartbeat_mode_store);
+
 static struct attribute *o2cb_attrs[] = {
 	&attr_version.attr,
+	&attr_heartbeat_mode.attr,
 	NULL,
 };
 
