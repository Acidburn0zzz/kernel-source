From: mark.fasheh@oracle.com
References: 187359
Subject: LVBs getting out of sync across the cluster


Acked-by: lmb@suse.de
Acked-by: Jeff Mahoney <jeffm@suse.com>

Index: fs/ocfs2/dlm/dlmunlock.c
===================================================================
--- a/fs/ocfs2/dlm/dlmunlock.c	(revision 2917)
+++ b/fs/ocfs2/dlm/dlmunlock.c	(working copy)
@@ -474,6 +474,11 @@ int dlm_unlock_lock_handler(struct o2net
 
 	/* lock was found on queue */
 	lksb = lock->lksb;
+	if (flags & (LKM_VALBLK|LKM_PUT_LVB) &&
+	    lock->ml.type != LKM_EXMODE) {
+		flags &= ~(LKM_VALBLK|LKM_PUT_LVB);
+	}
+
 	/* unlockast only called on originating node */
 	if (flags & LKM_PUT_LVB) {
 		lksb->flags |= DLM_LKSB_PUT_LVB;
@@ -623,6 +628,9 @@ retry:
 
 	spin_lock(&res->spinlock);
 	is_master = (res->owner == dlm->node_num);
+	if (flags & LKM_VALBLK && lock->ml.type != LKM_EXMODE) {
+		flags &= ~LKM_VALBLK;
+	}
 	spin_unlock(&res->spinlock);
 
 	if (is_master) {

