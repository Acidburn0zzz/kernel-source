This patch adds register_filesystem_lifo(), which allows to
register a filesystem at the head of the list of filesystems.
Used to add ext3 before ext2 even when ext3 is registered later.

Index: linux-2.6.1/fs/ext3/super.c
===================================================================
--- linux-2.6.1.orig/fs/ext3/super.c
+++ linux-2.6.1/fs/ext3/super.c
@@ -2015,7 +2015,7 @@ static int __init init_ext3_fs(void)
 	old_write_dquot = ext3_qops.write_dquot;
 	ext3_qops.write_dquot = ext3_write_dquot;
 #endif
-        err = register_filesystem(&ext3_fs_type);
+        err = register_filesystem_lifo(&ext3_fs_type);
 	if (err)
 		goto out;
 	return 0;
Index: linux-2.6.1/fs/filesystems.c
===================================================================
--- linux-2.6.1.orig/fs/filesystems.c
+++ linux-2.6.1/fs/filesystems.c
@@ -62,7 +62,7 @@ static struct file_system_type **find_fi
  *	unregistered.
  */
  
-int register_filesystem(struct file_system_type * fs)
+int __register_filesystem(struct file_system_type * fs, int lifo)
 {
 	int res = 0;
 	struct file_system_type ** p;
@@ -76,13 +76,19 @@ int register_filesystem(struct file_syst
 	p = find_filesystem(fs->name);
 	if (*p)
 		res = -EBUSY;
-	else
-		*p = fs;
+	else {
+		if (!lifo)
+			*p = fs;
+		else {
+			fs->next = file_systems;
+			file_systems = fs;
+		}
+	}
 	write_unlock(&file_systems_lock);
 	return res;
 }
 
-EXPORT_SYMBOL(register_filesystem);
+EXPORT_SYMBOL(__register_filesystem);
 
 /**
  *	unregister_filesystem - unregister a file system
Index: linux-2.6.1/include/linux/fs.h
===================================================================
--- linux-2.6.1.orig/include/linux/fs.h
+++ linux-2.6.1/include/linux/fs.h
@@ -1040,7 +1040,9 @@ struct super_block *get_sb_pseudo(struct
 #define fops_put(fops) \
 	do { if (fops) module_put((fops)->owner); } while(0)
 
-extern int register_filesystem(struct file_system_type *);
+extern int __register_filesystem(struct file_system_type *, int);
+#define register_filesystem(fs) __register_filesystem(fs, 0)
+#define register_filesystem_lifo(fs) __register_filesystem(fs, 1)
 extern int unregister_filesystem(struct file_system_type *);
 extern struct vfsmount *kern_mount(struct file_system_type *);
 extern int may_umount(struct vfsmount *);
