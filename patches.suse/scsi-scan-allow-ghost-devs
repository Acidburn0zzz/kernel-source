--- linux-2.6.5.noreplunhost/drivers/scsi/scsi_scan.c.orig	2004-04-15 22:42:48.544207000 +0200
+++ linux-2.6.5.noreplunhost/drivers/scsi/scsi_scan.c	2004-04-15 22:51:08.291252857 +0200
@@ -119,6 +119,12 @@ module_param_named(scsi_reportlun2, scsi
 MODULE_PARM_DESC(scsi_reportlun2,
 		 "Use REPORT_LUNs for scanning SCSI-2 devs as well");
 
+static unsigned int scsi_allow_ghost_devices;
+module_param_named(scsi_allow_ghost_devices ,scsi_allow_ghost_devices, int, S_IRUGO|S_IWUSR);
+MODULE_PARM_DESC(scsi_allow_ghost_devices, 
+		 "allow devices marked as being offline to be accessed anyway "
+		 "(0 = off, else allow ghosts on lun 0 through allow_ghost_devices - 1");
+
 
 /**
  * scsi_unlock_floptical - unlock device via a special MODE SENSE command
@@ -573,7 +579,8 @@ static int scsi_add_lun(struct scsi_devi
 	 * otherwise, offline devices still get an sd allocated, and they
 	 * use up an sd slot.
 	 */
-	if (((inq_result[0] >> 5) & 7) == 1) {
+	if (((inq_result[0] >> 5) & 7) == 1 &&
+	    (sdev->lun >= scsi_allow_ghost_devices)) {
 		SCSI_LOG_SCAN_BUS(3, printk(KERN_INFO "scsi scan: peripheral"
 				" qualifier of 1, device offlined\n"));
 		sdev->online = FALSE;
