From: olh@suse.de
Subject: correct keymapping on Powerbook built-in USB ISO keyboards

similar to the version in adbhid_input_register()
The '<>' key and the '^Â°' key on a german keyboard is swapped.
Provide correct keys to userland, external USB keyboards will not work
correctly when the 'badmap'/'goodmap' workarounds from xkeyboard-config
are used.
It is expected that distributions drop the badmap/goodmap part from 
keycodes/macintosh in the xkeyboard-config package.

Signed-off-by: Olaf Hering <olh@suse.de>

---
 drivers/usb/input/hid-input.c |   17 +++++++++++++++++
 1 files changed, 17 insertions(+)

--- linux-2.6.18.orig/drivers/usb/input/hid-input.c
+++ linux-2.6.18/drivers/usb/input/hid-input.c
@@ -129,6 +129,12 @@ static struct hidinput_key_translation p
 	{ }
 };
 
+static struct hidinput_key_translation powerbook_iso_keyboard[] = {
+	{ KEY_GRAVE,    KEY_102ND },
+	{ KEY_102ND,    KEY_GRAVE },
+	{ }
+};
+
 static int usbhid_pb_fnmode = 1;
 module_param_named(pb_fnmode, usbhid_pb_fnmode, int, 0644);
 MODULE_PARM_DESC(pb_fnmode,
@@ -211,6 +217,14 @@ static int hidinput_pb_event(struct hid_
 		}
 	}
 
+	if (hid->quirks & HID_QUIRK_POWERBOOK_ISO_KEYBOARD) {
+		trans = find_translation(powerbook_iso_keyboard, usage->code);
+		if (trans) {
+			input_event(input, usage->type, trans->to, value);
+			return 1;
+		}
+	}
+
 	return 0;
 }
 
@@ -229,6 +243,9 @@ static void hidinput_pb_setup(struct inp
 
 	for (trans = powerbook_iso_keyboard; trans->from; trans++)
 		set_bit(trans->to, input->keybit);
+
+	for (trans = powerbook_iso_keyboard; trans->from; trans++)
+		set_bit(trans->to, input->keybit);
 }
 #else
 static inline int hidinput_pb_event(struct hid_device *hid, struct input_dev *input,
