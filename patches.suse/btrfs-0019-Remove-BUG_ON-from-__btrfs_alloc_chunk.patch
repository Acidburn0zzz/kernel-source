From: Mark Fasheh <mfasheh@suse.de>
Date: Thu, 8 Sep 2011 17:29:00 -0700
Subject: btrfs: Remove BUG_ON from __btrfs_alloc_chunk()
Patch-mainline: 3.4-rc1
Git-commit: 3acd395317f22b4346a139571cd4723408c5d4af

We BUG_ON() error from add_extent_mapping(), but that error looks pretty
easy to bubble back up - as far as I can tell there have not been any
permanent modifications to fs state at that point.

Signed-off-by: Mark Fasheh <mfasheh@suse.de>
---
 fs/btrfs/volumes.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/fs/btrfs/volumes.c
+++ b/fs/btrfs/volumes.c
@@ -3328,8 +3328,9 @@ static int __btrfs_alloc_chunk(struct bt
 	write_lock(&em_tree->lock);
 	ret = add_extent_mapping(em_tree, em);
 	write_unlock(&em_tree->lock);
-	BUG_ON(ret);
 	free_extent_map(em);
+	if (ret)
+		goto error;
 
 	ret = btrfs_make_block_group(trans, extent_root, 0, type,
 				     BTRFS_FIRST_CHUNK_TREE_OBJECTID,
