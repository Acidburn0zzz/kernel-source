diff -u linux/drivers/dump/dump_x8664.c-o linux/drivers/dump/dump_x8664.c
--- linux/drivers/dump/dump_x8664.c-o	2004-05-25 12:34:17.000000000 +0200
+++ linux/drivers/dump/dump_x8664.c	2004-05-25 14:43:39.000000000 +0200
@@ -27,11 +27,13 @@
 #include <linux/dump.h>
 #include "dump_methods.h"
 #include <linux/mm.h>
+#include <linux/rcupdate.h>
 #include <asm/processor.h>
 #include <asm/hardirq.h>
 #include <asm/kdebug.h>
 #include <asm/uaccess.h>
 #include <asm/nmi.h>
+#include <asm/kdebug.h>
 
 static __s32 	saved_irq_count; /* saved preempt_count() flag */
 
@@ -75,7 +77,7 @@
 }
 
 #ifdef CONFIG_SMP
-extern unsigned long irq_affinity[];
+extern cpumask_t irq_affinity[];
 extern irq_desc_t irq_desc[];
 extern void dump_send_ipi(void);
 static int dump_expect_ipi[NR_CPUS];
@@ -152,6 +154,7 @@
 	}
 	return;
 }
+
 /*
  * Routine to save the old irq affinities and change affinities of all irqs to
  * the dumping cpu.
@@ -160,13 +163,14 @@
 set_irq_affinity(void)
 {
 	int i;
-	int cpu = smp_processor_id();
+	cpumask_t cpu = CPU_MASK_NONE;
 
+	cpu_set(smp_processor_id(), cpu); 
 	memcpy(saved_affinity, irq_affinity, NR_IRQS * sizeof(unsigned long));
 	for (i = 0; i < NR_IRQS; i++) {
 		if (irq_desc[i].handler == NULL)
 			continue;
-		irq_affinity[i] = 1UL << cpu;
+		irq_affinity[i] = cpu;
 		if (irq_desc[i].handler->set_affinity != NULL)
 			irq_desc[i].handler->set_affinity(i, irq_affinity[i]);
 	}
@@ -251,16 +255,25 @@
 	return (0);
 }
 
+static int notify(struct notifier_block *nb, unsigned long code, void *data)
+{
+	if (code == DIE_NMI_IPI && dump_oncpu)
+		return NOTIFY_BAD; 
+	return NOTIFY_DONE; 
+} 
+
+static struct notifier_block dump_notifier = { 
+	.notifier_call = notify,	
+}; 
+
 /*
  * Name: __dump_init()
- * Func: Initialize the dumping routine process.  This is in case
- *       it's necessary in the future.
+ * Func: Initialize the dumping routine process.
  */
 void
 __dump_init(uint64_t local_memory_start)
 {
-	/* return */
-	return;
+	notifier_chain_register(&die_chain, &dump_notifier);
 }
 
 /*
@@ -285,6 +298,8 @@
 __dump_cleanup(void)
 {
 	free_dha_stack();
+	notifier_chain_unregister(&die_chain, &dump_notifier);
+	synchronize_kernel(); 
 	return;
 }
 
