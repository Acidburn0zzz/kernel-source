garloff@suse.de

Feature.

This patch introduces a field in the per SCSI host struct that allows
host adapters to switch off the user of REPORT_LUNS during SCSI scanning.
Some host adapters/devices may not cope with the way Linux maps the 8byte 
LUNS to a 32bit number and may provide their own mechanism. zfcp (S/390) 
is known to do this.

 drivers/scsi/scsi_scan.c |    1 +
 include/scsi/scsi_host.h |    6 ++++++
 2 files changed, 7 insertions(+)

diff -uNrp linux-2.6.5.replun2/drivers/scsi/scsi_scan.c linux-2.6.5.noreplunhost/drivers/scsi/scsi_scan.c
--- linux-2.6.5.replun2/drivers/scsi/scsi_scan.c	2004-04-15 22:36:53.844309095 +0200
+++ linux-2.6.5.noreplunhost/drivers/scsi/scsi_scan.c	2004-04-15 22:42:48.544207185 +0200
@@ -951,6 +951,7 @@ static int scsi_report_lun_scan(struct s
 	 */
 	
 	if ( scsi_noreportlun ||
+	     sdev->host->no_reportlun ||
 	     sdev->scsi_level < SCSI_2 || 
 	    (sdev->scsi_level < SCSI_3 &&
 	     (!scsi_reportlun2 || sdev->host->max_lun <= 8)))
Files linux-2.6.5.replun2/drivers/scsi/.scsi_scan.c.swp and linux-2.6.5.noreplunhost/drivers/scsi/.scsi_scan.c.swp differ
diff -uNrp linux-2.6.5.replun2/include/scsi/scsi_host.h linux-2.6.5.noreplunhost/include/scsi/scsi_host.h
--- linux-2.6.5.replun2/include/scsi/scsi_host.h	2004-04-04 05:36:25.000000000 +0200
+++ linux-2.6.5.noreplunhost/include/scsi/scsi_host.h	2004-04-15 22:41:20.813609917 +0200
@@ -459,6 +459,12 @@ struct Scsi_Host {
 	unsigned reverse_ordering:1;
 
 	/*
+	 * True for host adapters that dislike REPORT_LUN as they
+	 * use a different mapping of 8byte LUNs to (long) integers
+	 */
+	unsigned no_reportlun:1;
+
+	/*
 	 * Host has rejected a command because it was busy.
 	 */
 	unsigned int host_blocked;
Files linux-2.6.5.replun2/include/scsi/.scsi_host.h.swp and linux-2.6.5.noreplunhost/include/scsi/.scsi_host.h.swp differ
