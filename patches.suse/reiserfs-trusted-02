diff -ruN -X ../dontdiff linux-2.6.0-test4/fs/reiserfs/Makefile linux-2.6.0-test4.xattr/fs/reiserfs/Makefile
--- linux-2.6.0-test4/fs/reiserfs/Makefile	2003-09-09 16:13:28.408889792 -0400
+++ linux-2.6.0-test4.xattr/fs/reiserfs/Makefile	2003-09-09 16:13:20.167142728 -0400
@@ -10,7 +10,7 @@
 		 item_ops.o ioctl.o procfs.o
 
 ifeq ($(CONFIG_REISERFS_FS_XATTR),y)
-reiserfs-objs += xattr.o xattr_user.o
+reiserfs-objs += xattr.o xattr_user.o xattr_trusted.o
 endif
 
 ifeq ($(CONFIG_REISERFS_FS_POSIX_ACL),y)
diff -ruN -X ../dontdiff linux-2.6.0-test4/fs/reiserfs/xattr.c linux-2.6.0-test4.xattr/fs/reiserfs/xattr.c
--- linux-2.6.0-test4/fs/reiserfs/xattr.c	2003-09-09 16:13:28.409889640 -0400
+++ linux-2.6.0-test4.xattr/fs/reiserfs/xattr.c	2003-09-09 16:13:20.168142576 -0400
@@ -1138,6 +1138,7 @@
 
     /* Add the handlers */
     list_add_tail (&user_handler.handlers, &xattr_handlers);
+    list_add_tail (&trusted_handler.handlers, &xattr_handlers);
 #ifdef CONFIG_REISERFS_FS_POSIX_ACL
     list_add_tail (&posix_acl_access_handler.handlers, &xattr_handlers);
     list_add_tail (&posix_acl_default_handler.handlers, &xattr_handlers);
diff -ruN -X ../dontdiff linux-2.6.0-test4/fs/reiserfs/xattr_trusted.c linux-2.6.0-test4.xattr/fs/reiserfs/xattr_trusted.c
--- linux-2.6.0-test4/fs/reiserfs/xattr_trusted.c	1969-12-31 19:00:00.000000000 -0500
+++ linux-2.6.0-test4.xattr/fs/reiserfs/xattr_trusted.c	2003-09-09 16:15:36.428427864 -0400
@@ -0,0 +1,81 @@
+#include <linux/reiserfs_fs.h>
+#include <linux/errno.h>
+#include <linux/fs.h>
+#include <linux/pagemap.h>
+#include <linux/xattr.h>
+#include <linux/reiserfs_xattr.h>
+#include <asm/uaccess.h>
+
+#define XATTR_TRUSTED_PREFIX "trusted."
+
+static int
+trusted_get (struct inode *inode, const char *name, void *buffer, size_t size)
+{
+    if (strlen(name) < sizeof(XATTR_TRUSTED_PREFIX))
+        return -EINVAL;
+
+    if (!reiserfs_xattrs_trusted (inode->i_sb))
+        return -EOPNOTSUPP;
+
+    if (!(capable(CAP_SYS_ADMIN) || is_reiserfs_priv_object(inode)))
+        return -EPERM;
+
+    return reiserfs_xattr_get (inode, name, buffer, size);
+}
+
+static int
+trusted_set (struct inode *inode, const char *name, const void *buffer,
+          size_t size, int flags)
+{
+    if (strlen(name) < sizeof(XATTR_TRUSTED_PREFIX))
+        return -EINVAL;
+
+    if (!reiserfs_xattrs_trusted (inode->i_sb))
+        return -EOPNOTSUPP;
+
+    if (!(capable(CAP_SYS_ADMIN) || is_reiserfs_priv_object(inode)))
+        return -EPERM;
+
+    return reiserfs_xattr_set (inode, name, buffer, size, flags);
+}
+
+static int
+trusted_del (struct inode *inode, const char *name)
+{
+    if (strlen(name) < sizeof(XATTR_TRUSTED_PREFIX))
+        return -EINVAL;
+
+    if (!reiserfs_xattrs_trusted (inode->i_sb))
+        return -EOPNOTSUPP;
+
+    if (!(capable(CAP_SYS_ADMIN) || is_reiserfs_priv_object(inode)))
+        return -EPERM;
+
+    return 0;
+}
+
+static int
+trusted_list (struct inode *inode, const char *name, int namelen, char *out)
+{
+    int len = namelen;
+
+    if (!reiserfs_xattrs_trusted (inode->i_sb))
+        return 0;
+
+    if (!(capable(CAP_SYS_ADMIN) || is_reiserfs_priv_object(inode)))
+        return 0;
+
+    if (out)
+        memcpy (out, name, len);
+
+    return len;
+}
+
+
+struct reiserfs_xattr_handler trusted_handler = {
+    prefix: XATTR_TRUSTED_PREFIX,
+    get: trusted_get,
+    set: trusted_set,
+    del: trusted_del,
+    list: trusted_list,
+};
diff -ruN -X ../dontdiff linux-2.6.0-test4/include/linux/reiserfs_fs_sb.h linux-2.6.0-test4.xattr/include/linux/reiserfs_fs_sb.h
--- linux-2.6.0-test4/include/linux/reiserfs_fs_sb.h	2003-09-09 16:13:28.410889488 -0400
+++ linux-2.6.0-test4.xattr/include/linux/reiserfs_fs_sb.h	2003-09-09 15:55:55.366976496 -0400
@@ -477,10 +477,17 @@
 #define reiserfs_attrs(s) (REISERFS_SB(s)->s_mount_opt & (1 << REISERFS_ATTRS))
 #define old_format_only(s) (REISERFS_SB(s)->s_properties & (1 << REISERFS_3_5))
 #define convert_reiserfs(s) (REISERFS_SB(s)->s_mount_opt & (1 << REISERFS_CONVERT))
-#define reiserfs_xattrs(s) (REISERFS_SB(s)->s_mount_opt & (1 << REISERFS_XATTRS))
 #define reiserfs_xattrs_user(s) (REISERFS_SB(s)->s_mount_opt & (1 << REISERFS_XATTRS_USER))
 #define reiserfs_posixacl(s) (REISERFS_SB(s)->s_mount_opt & (1 << REISERFS_POSIXACL))
 #define reiserfs_xattrs_optional(s) (reiserfs_xattrs_user(s) || reiserfs_posixacl(s))
+#define reiserfs_xattrs(s) reiserfs_xattrs_trusted(s)
+#ifndef CONFIG_REISERFS_FS_XATTR
+# define reiserfs_xattrs_trusted(s) (0)
+#else
+/* If xattrs are compiled in, trusted xattrs are "always on." */
+# define reiserfs_xattrs_trusted(s) (1)
+#endif
+
 
 
 
diff -ruN -X ../dontdiff linux-2.6.0-test4/include/linux/reiserfs_xattr.h linux-2.6.0-test4.xattr/include/linux/reiserfs_xattr.h
--- linux-2.6.0-test4/include/linux/reiserfs_xattr.h	2003-09-09 16:13:28.410889488 -0400
+++ linux-2.6.0-test4.xattr/include/linux/reiserfs_xattr.h	2003-09-09 16:13:20.170142272 -0400
@@ -91,6 +91,7 @@
 
 
 extern struct reiserfs_xattr_handler user_handler;
+extern struct reiserfs_xattr_handler trusted_handler;
 
 extern int reiserfs_xattr_register_handlers (void) __init;
 extern void reiserfs_xattr_unregister_handlers (void);
