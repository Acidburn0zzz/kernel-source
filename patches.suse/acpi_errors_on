From: trenn@suse.de
Subject: acpi is dead slow (battery / thermal zone)
Patch-mainline: not yet

Full ACPI_DEBUG output slows down the system significantly,
even if not enabled during runtime.
This variable takes care that errors and warnings will still be printed,
but higher debug levels can not be enabled any more during runtime.

Index: linux-2.6.13/drivers/acpi/Makefile
===================================================================
--- linux-2.6.13.orig/drivers/acpi/Makefile
+++ linux-2.6.13/drivers/acpi/Makefile
@@ -10,6 +10,10 @@ ifdef CONFIG_ACPI_DEBUG
   ACPI_CFLAGS	+= -DACPI_DEBUG_OUTPUT
 endif
 
+ifdef CONFIG_ACPI_DEBUG_LITE
+  ACPI_CFLAGS	+= -DACPI_DEBUG_LITE
+endif
+
 EXTRA_CFLAGS	+= $(ACPI_CFLAGS)
 
 #
Index: linux-2.6.13/drivers/acpi/dispatcher/dswload.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/dispatcher/dswload.c
+++ linux-2.6.13/drivers/acpi/dispatcher/dswload.c
@@ -722,9 +722,10 @@ acpi_ds_load2_end_op (
 	ACPI_FUNCTION_TRACE ("ds_load2_end_op");
 
 	op = walk_state->op;
+#ifdef ACPI_DEBUG_OUTPUT
 	ACPI_DEBUG_PRINT ((ACPI_DB_DISPATCH, "Opcode [%s] Op %p State %p\n",
 			walk_state->op_info->name, op, walk_state));
-
+#endif
 	/* Only interested in opcodes that have namespace objects */
 
 	if (!(walk_state->op_info->flags & AML_NSOBJECT)) {
Index: linux-2.6.13/drivers/acpi/events/evmisc.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/events/evmisc.c
+++ linux-2.6.13/drivers/acpi/events/evmisc.c
@@ -148,6 +148,7 @@ acpi_ev_queue_notify_request (
 	 * For value 0x80 (Status Change) on the power button or sleep button,
 	 *   initiate soft-off or sleep operation?
 	 */
+#ifdef ACPI_DEBUG_OUTPUT
 	ACPI_DEBUG_PRINT ((ACPI_DB_INFO,
 		"Dispatching Notify(%X) on node %p\n", notify_value, node));
 
@@ -160,7 +161,7 @@ acpi_ev_queue_notify_request (
 			"Notify value: 0x%2.2X **Device Specific**\n",
 			notify_value));
 	}
-
+#endif
 	/* Get the notify object attached to the NS Node */
 
 	obj_desc = acpi_ns_get_attached_object (node);
Index: linux-2.6.13/drivers/acpi/executer/exconvrt.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/executer/exconvrt.c
+++ linux-2.6.13/drivers/acpi/executer/exconvrt.c
@@ -690,11 +690,9 @@ acpi_ex_convert_to_target_type (
 
 
 	default:
-		ACPI_DEBUG_PRINT ((ACPI_DB_ERROR,
-			"Unknown Target type ID 0x%X Op %s dest_type %s\n",
+		ACPI_REPORT_ERROR (("Unknown Target type ID 0x%X dest_type %s\n",
 			GET_CURRENT_ARG_TYPE (walk_state->op_info->runtime_args),
-			walk_state->op_info->name, acpi_ut_get_type_name (destination_type)));
-
+		        acpi_ut_get_type_name (destination_type)));
 		ACPI_REPORT_ERROR (("Bad Target Type (ARGI): %X\n",
 			GET_CURRENT_ARG_TYPE (walk_state->op_info->runtime_args)))
 		status = AE_AML_INTERNAL;
Index: linux-2.6.13/drivers/acpi/namespace/nsalloc.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/namespace/nsalloc.c
+++ linux-2.6.13/drivers/acpi/namespace/nsalloc.c
@@ -364,9 +364,10 @@ acpi_ns_delete_children (
 
 		ACPI_MEM_TRACKING (acpi_gbl_memory_lists[ACPI_MEM_LIST_NSNODE].total_freed++);
 
+#ifdef ACPI_DEBUG_OUTPUT
 		ACPI_DEBUG_PRINT ((ACPI_DB_ALLOCATIONS, "Object %p, Remaining %X\n",
 			child_node, acpi_gbl_current_node_count));
-
+#endif 
 		/*
 		 * Detach an object if there is one, then free the child node
 		 */
Index: linux-2.6.13/drivers/acpi/parser/psparse.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/parser/psparse.c
+++ linux-2.6.13/drivers/acpi/parser/psparse.c
@@ -701,10 +701,12 @@ acpi_ps_parse_loop (
 			op->common.aml_offset = walk_state->aml_offset;
 
 			if (walk_state->op_info) {
+#ifdef ACPI_DEBUG_OUTPUT
 				ACPI_DEBUG_PRINT ((ACPI_DB_PARSE,
 					"Opcode %4.4X [%s] Op %p Aml %p aml_offset %5.5X\n",
 					 (u32) op->common.aml_opcode, walk_state->op_info->name,
 					 op, parser_state->aml, op->common.aml_offset));
+#endif
 			}
 		}
 
Index: linux-2.6.13/include/acpi/acmacros.h
===================================================================
--- linux-2.6.13.orig/include/acpi/acmacros.h
+++ linux-2.6.13/include/acpi/acmacros.h
@@ -594,7 +594,18 @@
 #define ACPI_DUMP_PATHNAME(a,b,c,d)
 #define ACPI_DUMP_RESOURCE_LIST(a)
 #define ACPI_DUMP_BUFFER(a,b)
+
+
+#ifdef ACPI_DEBUG_LITE
+/* compiler must optimize, no solution to only integrate
+   this in preprocessing directives found */
+#define ACPI_DEBUG_PRINT_SUB(L, LINE, DB_INFO, A...) (L == ACPI_LV_ERROR || L == ACPI_LV_WARN) ? \
+ (ACPI_REPORT_WARNING ((A))) : (0)
+#define ACPI_DEBUG_PRINT(pl)  ACPI_DEBUG_PRINT_SUB pl
+#else
 #define ACPI_DEBUG_PRINT(pl)
+#endif
+
 #define ACPI_DEBUG_PRINT_RAW(pl)
 #define ACPI_BREAK_MSG(a)
 
Index: linux-2.6.13/include/acpi/acutils.h
===================================================================
--- linux-2.6.13.orig/include/acpi/acutils.h
+++ linux-2.6.13/include/acpi/acutils.h
@@ -45,6 +45,8 @@
 #define _ACUTILS_H
 
 
+#include <linux/module.h>
+
 typedef
 acpi_status (*acpi_pkg_callback) (
 	u8                              object_type,
Index: linux-2.6.13/drivers/acpi/utilities/utglobal.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/utilities/utglobal.c
+++ linux-2.6.13/drivers/acpi/utilities/utglobal.c
@@ -675,7 +675,7 @@ acpi_ut_get_descriptor_name (
 }
 
 
-#if defined(ACPI_DEBUG_OUTPUT) || defined(ACPI_DEBUGGER)
+#if defined(ACPI_DEBUG_OUTPUT) || defined(ACPI_DEBUGGER) || defined(ACPI_DEBUG_LITE)
 /*
  * Strings and procedures used for debug only
  */
Index: linux-2.6.13/drivers/acpi/executer/exresop.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/executer/exresop.c
+++ linux-2.6.13/drivers/acpi/executer/exresop.c
@@ -169,9 +169,11 @@ acpi_ex_resolve_operands (
 		return_ACPI_STATUS (AE_AML_INTERNAL);
 	}
 
+#ifdef ACPI_DEBUG
 	ACPI_DEBUG_PRINT ((ACPI_DB_EXEC,
 		"Opcode %X [%s] required_operand_types=%8.8X \n",
 		opcode, op_info->name, arg_types));
+#endif
 
 	/*
 	 * Normal exit is with (arg_types == 0) at end of argument list.
@@ -247,10 +249,9 @@ acpi_ex_resolve_operands (
 					break;
 
 				default:
-					ACPI_DEBUG_PRINT ((ACPI_DB_ERROR,
+					ACPI_REPORT_ERROR ((
 						"Operand is a Reference, Unknown Reference Opcode %X [%s]\n",
-						obj_desc->reference.opcode,
-						(acpi_ps_get_opcode_info (obj_desc->reference.opcode))->name));
+						obj_desc->reference.opcode));
 
 					return_ACPI_STATUS (AE_AML_OPERAND_TYPE);
 				}
Index: linux-2.6.13/include/acpi/aclocal.h
===================================================================
--- linux-2.6.13.orig/include/acpi/aclocal.h
+++ linux-2.6.13/include/acpi/aclocal.h
@@ -90,7 +90,7 @@ typedef u32                             
 #define NUM_MUTEX                       MAX_MUTEX+1
 
 
-#if defined(ACPI_DEBUG_OUTPUT) || defined(ACPI_DEBUGGER)
+#if defined(ACPI_DEBUG_OUTPUT) || defined(ACPI_DEBUGGER) || defined(ACPI_DEBUG_LITE)
 #ifdef DEFINE_ACPI_GLOBALS
 
 /* Names for the mutexes used in the subsystem */
Index: linux-2.6.13/drivers/acpi/Kconfig
===================================================================
--- linux-2.6.13.orig/drivers/acpi/Kconfig
+++ linux-2.6.13/drivers/acpi/Kconfig
@@ -281,6 +281,16 @@ config ACPI_DEBUG
 	  of verbosity. Saying Y enables these statements. This will increase
 	  your kernel size by around 50K.
 
+config ACPI_DEBUG_LITE
+        bool "Print ACPI errors and warnings"
+        depends on ACPI
+        default n
+        help
+          Full ACPI_DEBUG output slows down the system significantly,
+	  even if not enabled during runtime.
+	  This variable takes care that errors and warnings will still be printed,
+	  but higher debug levels can not be enabled any more during runtime.
+
 config ACPI_BUS
 	bool
 	default y
Index: linux-2.6.13/drivers/acpi/utilities/utmisc.c
===================================================================
--- linux-2.6.13.orig/drivers/acpi/utilities/utmisc.c
+++ linux-2.6.13/drivers/acpi/utilities/utmisc.c
@@ -45,6 +45,9 @@
 #include <acpi/acpi.h>
 #include <acpi/acnamesp.h>
 
+#ifdef CONFIG_ACPI_DEBUG_LITE
+#define acpi_ut_get_mutex_name(x) NULL
+#endif
 
 #define _COMPONENT          ACPI_UTILITIES
 	 ACPI_MODULE_NAME    ("utmisc")
@@ -745,7 +748,6 @@ acpi_ut_acquire_mutex (
 		}
 	}
 #endif
-
 	ACPI_DEBUG_PRINT ((ACPI_DB_MUTEX,
 		"Thread %X attempting to acquire Mutex [%s]\n",
 		this_thread_id, acpi_ut_get_mutex_name (mutex_id)));
@@ -1503,6 +1505,7 @@ acpi_ut_report_warning (
 	acpi_os_printf ("%8s-%04d: *** Warning: ", module_name, line_number);
 }
 
+EXPORT_SYMBOL(acpi_ut_report_warning);
 
 /*******************************************************************************
  *
Index: linux-2.6.13/include/acpi/acoutput.h
===================================================================
--- linux-2.6.13.orig/include/acpi/acoutput.h
+++ linux-2.6.13/include/acpi/acoutput.h
@@ -177,7 +177,12 @@
 
 /* Defaults for debug_level, debug and normal */
 
+#ifdef CONFIG_ACPI_DEBUG_LITE
+/* Don't print warnings and other noise by default. Can be still enabled on the command line. */
+#define ACPI_DEBUG_DEFAULT          (ACPI_LV_INIT | ACPI_LV_ERROR)
+#else
 #define ACPI_DEBUG_DEFAULT          (ACPI_LV_INIT | ACPI_LV_WARN | ACPI_LV_ERROR | ACPI_LV_DEBUG_OBJECT)
+#endif
 #define ACPI_NORMAL_DEFAULT         (ACPI_LV_INIT | ACPI_LV_WARN | ACPI_LV_ERROR | ACPI_LV_DEBUG_OBJECT)
 #define ACPI_DEBUG_ALL              (ACPI_LV_AML_DISASSEMBLE | ACPI_LV_ALL_EXCEPTIONS | ACPI_LV_ALL)
 
