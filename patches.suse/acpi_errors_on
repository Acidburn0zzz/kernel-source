From: trenn@suse.de
Subject: acpi is dead slow (battery / thermal zone)
Patch-mainline: not yet

Full ACPI_DEBUG output slows down the system significantly,
even if not enabled during runtime.
This variable takes care that errors and warnings will still be printed,
but higher debug levels can not be enabled any more during runtime.

diff -purN linux-2.6.10/drivers/acpi/Kconfig linux-2.6.10.acpi/drivers/acpi/Kconfig
--- linux-2.6.10/drivers/acpi/Kconfig	2005-03-02 14:02:16.148680048 +0100
+++ linux-2.6.10.acpi/drivers/acpi/Kconfig	2005-03-02 14:03:26.818239454 +0100
@@ -279,6 +279,16 @@ config ACPI_DEBUG
 	  of verbosity. Saying Y enables these statements. This will increase
 	  your kernel size by around 50K.
 
+config ACPI_DEBUG_LITE
+        bool "Print ACPI errors and warnings"
+        depends on ACPI
+        default n
+        help
+          Full ACPI_DEBUG output slows down the system significantly,
+	  even if not enabled during runtime.
+	  This variable takes care that errors and warnings will still be printed,
+	  but higher debug levels can not be enabled any more during runtime.
+
 config ACPI_BUS
 	bool
 	depends on ACPI_INTERPRETER
--- x/drivers/acpi/Makefile.orig	2005-07-14 07:08:30.000000000 -0600
+++ y/drivers/acpi/Makefile	2005-07-14 07:11:22.000000000 -0600
@@ -10,6 +10,10 @@
   ACPI_CFLAGS	+= -DACPI_DEBUG_OUTPUT
 endif
 
+ifdef CONFIG_ACPI_DEBUG_LITE
+  ACPI_CFLAGS	+= -DACPI_DEBUG_LITE
+endif
+
 EXTRA_CFLAGS	+= $(ACPI_CFLAGS)
 
 #
--- x/drivers/acpi/dispatcher/dswload.c.orig	2005-07-14 07:08:30.000000000 -0600
+++ y/drivers/acpi/dispatcher/dswload.c	2005-07-14 07:11:22.000000000 -0600
@@ -728,9 +728,10 @@
 	ACPI_FUNCTION_TRACE ("ds_load2_end_op");
 
 	op = walk_state->op;
+#ifdef ACPI_DEBUG_OUTPUT
 	ACPI_DEBUG_PRINT ((ACPI_DB_DISPATCH, "Opcode [%s] Op %p State %p\n",
 			walk_state->op_info->name, op, walk_state));
-
+#endif
 	/* Only interested in opcodes that have namespace objects */
 
 	if (!(walk_state->op_info->flags & AML_NSOBJECT)) {
--- x/drivers/acpi/events/evmisc.c.orig	2005-07-14 07:08:31.000000000 -0600
+++ y/drivers/acpi/events/evmisc.c	2005-07-14 07:11:22.000000000 -0600
@@ -148,6 +148,7 @@
 	 * For value 0x80 (Status Change) on the power button or sleep button,
 	 *   initiate soft-off or sleep operation?
 	 */
+#ifdef ACPI_DEBUG_OUTPUT
 	ACPI_DEBUG_PRINT ((ACPI_DB_INFO,
 		"Dispatching Notify(%X) on node %p\n", notify_value, node));
 
@@ -160,7 +161,7 @@
 			"Notify value: 0x%2.2X **Device Specific**\n",
 			notify_value));
 	}
-
+#endif
 	/* Get the notify object attached to the NS Node */
 
 	obj_desc = acpi_ns_get_attached_object (node);
--- x/drivers/acpi/executer/exconvrt.c.orig	2005-07-14 07:08:31.000000000 -0600
+++ y/drivers/acpi/executer/exconvrt.c	2005-07-14 07:11:22.000000000 -0600
@@ -690,11 +690,9 @@
 
 
 	default:
-		ACPI_DEBUG_PRINT ((ACPI_DB_ERROR,
-			"Unknown Target type ID 0x%X Op %s dest_type %s\n",
+		ACPI_REPORT_ERROR (("Unknown Target type ID 0x%X dest_type %s\n",
 			GET_CURRENT_ARG_TYPE (walk_state->op_info->runtime_args),
-			walk_state->op_info->name, acpi_ut_get_type_name (destination_type)));
-
+		        acpi_ut_get_type_name (destination_type)));
 		ACPI_REPORT_ERROR (("Bad Target Type (ARGI): %X\n",
 			GET_CURRENT_ARG_TYPE (walk_state->op_info->runtime_args)))
 		status = AE_AML_INTERNAL;
--- x/drivers/acpi/namespace/nsalloc.c.orig	2005-07-14 07:08:32.000000000 -0600
+++ y/drivers/acpi/namespace/nsalloc.c	2005-07-14 07:11:22.000000000 -0600
@@ -364,9 +364,10 @@
 
 		ACPI_MEM_TRACKING (acpi_gbl_memory_lists[ACPI_MEM_LIST_NSNODE].total_freed++);
 
+#ifdef ACPI_DEBUG_OUTPUT
 		ACPI_DEBUG_PRINT ((ACPI_DB_ALLOCATIONS, "Object %p, Remaining %X\n",
 			child_node, acpi_gbl_current_node_count));
-
+#endif 
 		/*
 		 * Detach an object if there is one, then free the child node
 		 */
--- x/drivers/acpi/parser/psparse.c.orig	2005-07-14 07:08:33.000000000 -0600
+++ y/drivers/acpi/parser/psparse.c	2005-07-14 07:11:22.000000000 -0600
@@ -701,10 +701,12 @@
 			op->common.aml_offset = walk_state->aml_offset;
 
 			if (walk_state->op_info) {
+#ifdef ACPI_DEBUG_OUTPUT
 				ACPI_DEBUG_PRINT ((ACPI_DB_PARSE,
 					"Opcode %4.4X [%s] Op %p Aml %p aml_offset %5.5X\n",
 					 (u32) op->common.aml_opcode, walk_state->op_info->name,
 					 op, parser_state->aml, op->common.aml_offset));
+#endif
 			}
 		}
 
--- x/include/acpi/acmacros.h.orig	2005-07-14 07:09:00.000000000 -0600
+++ y/include/acpi/acmacros.h	2005-07-14 07:11:22.000000000 -0600
@@ -594,7 +594,18 @@
 #define ACPI_DUMP_PATHNAME(a,b,c,d)
 #define ACPI_DUMP_RESOURCE_LIST(a)
 #define ACPI_DUMP_BUFFER(a,b)
+
+
+#ifdef ACPI_DEBUG_LITE
+/* compiler must optimize, no solution to only integrate
+   this in preprocessing directives found */
+#define ACPI_DEBUG_PRINT_SUB(L, LINE, DB_INFO, A...) (L == ACPI_LV_ERROR || L == ACPI_LV_WARN) ? \
+ (ACPI_REPORT_WARNING ((A))) : (0)
+#define ACPI_DEBUG_PRINT(pl)  ACPI_DEBUG_PRINT_SUB pl
+#else
 #define ACPI_DEBUG_PRINT(pl)
+#endif
+
 #define ACPI_DEBUG_PRINT_RAW(pl)
 #define ACPI_BREAK_MSG(a)
 
--- x/include/acpi/acutils.h.orig	2005-07-14 07:09:01.000000000 -0600
+++ y/include/acpi/acutils.h	2005-07-14 07:11:22.000000000 -0600
@@ -45,6 +45,8 @@
 #define _ACUTILS_H
 
 
+#include <linux/module.h>
+
 typedef
 acpi_status (*acpi_pkg_callback) (
 	u8                              object_type,
--- x/drivers/acpi/utilities/utglobal.c.orig	2005-07-14 07:17:25.000000000 -0600
+++ y/drivers/acpi/utilities/utglobal.c	2005-07-14 07:17:49.000000000 -0600
@@ -675,7 +675,7 @@
 }
 
 
-#if defined(ACPI_DEBUG_OUTPUT) || defined(ACPI_DEBUGGER)
+#if defined(ACPI_DEBUG_OUTPUT) || defined(ACPI_DEBUGGER) || defined(ACPI_DEBUG_LITE)
 /*
  * Strings and procedures used for debug only
  */
--- x/drivers/acpi/executer/exresop.c.orig	2005-07-14 07:08:32.000000000 -0600
+++ y/drivers/acpi/executer/exresop.c	2005-07-14 07:19:11.000000000 -0600
@@ -169,9 +169,11 @@
 		return_ACPI_STATUS (AE_AML_INTERNAL);
 	}
 
+#ifdef ACPI_DEBUG
 	ACPI_DEBUG_PRINT ((ACPI_DB_EXEC,
 		"Opcode %X [%s] required_operand_types=%8.8X \n",
 		opcode, op_info->name, arg_types));
+#endif
 
 	/*
 	 * Normal exit is with (arg_types == 0) at end of argument list.
@@ -247,10 +249,9 @@
 					break;
 
 				default:
-					ACPI_DEBUG_PRINT ((ACPI_DB_ERROR,
+					ACPI_REPORT_ERROR ((
 						"Operand is a Reference, Unknown Reference Opcode %X [%s]\n",
-						obj_desc->reference.opcode,
-						(acpi_ps_get_opcode_info (obj_desc->reference.opcode))->name));
+						obj_desc->reference.opcode));
 
 					return_ACPI_STATUS (AE_AML_OPERAND_TYPE);
 				}
