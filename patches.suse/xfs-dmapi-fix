Index: linux-2.6.2/fs/xfs/dmapi/dmapi_sysent.c
===================================================================
--- linux-2.6.2.orig/fs/xfs/dmapi/dmapi_sysent.c
+++ linux-2.6.2/fs/xfs/dmapi/dmapi_sysent.c
@@ -42,7 +42,6 @@
 #include <linux/init.h>
 #include <linux/proc_fs.h>
 #include <linux/module.h>
-#include <linux/devfs_fs_kernel.h>
 
 #include <asm/uaccess.h>
 
@@ -633,9 +632,6 @@ static struct file_operations dmapi_fops
 static struct miscdevice dmapi_dev = {
 	.minor		= MISC_DYNAMIC_MINOR,
 	.name		= "xfs_dmapi",
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,0)
-	.devfs_name	= "xfs_dmapi",
-#endif
 	.fops		= &dmapi_fops
 };
 
Index: linux-2.6.2/fs/xfs/linux/xfs_super.c
===================================================================
--- linux-2.6.2.orig/fs/xfs/linux/xfs_super.c
+++ linux-2.6.2/fs/xfs/linux/xfs_super.c
@@ -911,7 +911,6 @@ init_xfs_fs( void )
 	vn_init();
 	xfs_init();
 	uuid_init();
-	vfs_initquota();
 
 	error = register_filesystem(&xfs_fs_type);
 	if (error)
@@ -932,7 +931,6 @@ STATIC void __exit
 exit_xfs_fs( void )
 {
 	unregister_filesystem(&xfs_fs_type);
-	vfs_exitquota();
 	xfs_cleanup();
 	pagebuf_terminate();
 	destroy_inodecache();
Index: linux-2.6.2/fs/xfs/linux/xfs_super.h
===================================================================
--- linux-2.6.2.orig/fs/xfs/linux/xfs_super.h
+++ linux-2.6.2/fs/xfs/linux/xfs_super.h
@@ -32,26 +32,6 @@
 #ifndef __XFS_SUPER_H__
 #define __XFS_SUPER_H__
 
-#ifdef CONFIG_XFS_DMAPI
-# define vfs_insertdmapi(vfs)	vfs_insertops(vfsp, &xfs_dmops)
-# define vfs_initdmapi()	dmapi_init()
-# define vfs_exitdmapi()	dmapi_uninit()
-#else
-# define vfs_insertdmapi(vfs)	do { } while (0)
-# define vfs_initdmapi()	do { } while (0)
-# define vfs_exitdmapi()	do { } while (0)
-#endif
-
-#ifdef CONFIG_XFS_QUOTA
-# define vfs_insertquota(vfs)	vfs_insertops(vfsp, &xfs_qmops)
-# define vfs_initquota()	xfs_qm_init()
-# define vfs_exitquota()	xfs_qm_exit()
-#else
-# define vfs_insertquota(vfs)	do { } while (0)
-# define vfs_initquota()	do { } while (0)
-# define vfs_exitquota()	do { } while (0)
-#endif
-
 #ifdef CONFIG_XFS_POSIX_ACL
 # define XFS_ACL_STRING		"ACLs, "
 # define set_posix_acl_flag(sb)	((sb)->s_flags |= MS_POSIXACL)
Index: linux-2.6.2/fs/xfs/linux/xfs_vfs.c
===================================================================
--- linux-2.6.2.orig/fs/xfs/linux/xfs_vfs.c
+++ linux-2.6.2/fs/xfs/linux/xfs_vfs.c
@@ -321,9 +321,14 @@ bhv_insert_all_vfsops(
 	struct vfs		*vfsp)
 {
 	struct xfs_mount	*mp;
+	struct bhv_vfsops	*op;
 
 	mp = xfs_mount_init();
 	vfs_insertbhv(vfsp, &mp->m_bhv, &xfs_vfsops, mp);
-	vfs_insertdmapi(vfsp);
-	vfs_insertquota(vfsp);
+	op = (struct bhv_vfsops *) bhv_lookup_module(XFS_DMOPS, XFS_DM_MODULE);
+	if (op)
+		vfs_insertops(vfsp, op);
+	op = (struct bhv_vfsops *) bhv_lookup_module(XFS_QMOPS, XFS_QM_MODULE);
+	if (op)
+		vfs_insertops(vfsp, op);
 }
