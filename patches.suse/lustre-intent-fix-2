Hello!

On Tue, May 25, 2004 at 01:03:13PM -0400, Chris Mason wrote:
> > It has come to my attention that you do not have several separate lustre
> > patches, but just one single combined patch instead.
> > See one combined patch with fix attached.
> Could I trouble you for an incremental fix?  This is easier to review
> then a replacement patch.

Sure.
Here it is:

diff -uNr linux-2.6.5-12.1/fs/block_dev.c linux-2.6.5-12.1.fixed/fs/block_dev.c
--- linux-2.6.5-12.1/fs/block_dev.c	2004-05-10 19:21:55.000000000 +0300
+++ linux-2.6.5-12.1.fixed/fs/block_dev.c	2004-05-25 18:47:22.000000000 +0300
@@ -834,6 +834,7 @@
 	if (!path || !*path)
 		return ERR_PTR(-EINVAL);
 
+	intent_init(&nd.intent, IT_LOOKUP);
 	error = path_lookup(path, LOOKUP_FOLLOW, &nd);
 	if (error)
 		return ERR_PTR(error);
diff -uNr linux-2.6.5-12.1/fs/exec.c linux-2.6.5-12.1.fixed/fs/exec.c
--- linux-2.6.5-12.1/fs/exec.c	2004-05-25 20:31:15.009185312 +0300
+++ linux-2.6.5-12.1.fixed/fs/exec.c	2004-05-25 18:47:22.000000000 +0300
@@ -124,10 +124,11 @@
 	struct file * file;
 	struct nameidata nd;
 	int error;
+
 	intent_init(&nd.intent, IT_OPEN);
 
-	nd.intent.it_flags = O_RDONLY;
-	FSHOOK_BEGIN_USER_WALK(open,
+	nd.intent.it_flags = FMODE_READ;
+	FSHOOK_BEGIN_USER_WALK_IT(open,
 		error,
 		library,
 		LOOKUP_FOLLOW|LOOKUP_OPEN,
@@ -496,7 +497,7 @@
 	FSHOOK_BEGIN(open, err, .filename = name, .flags = O_RDONLY)
 
 	intent_init(&nd.intent, IT_OPEN);
-	nd.intent.it_flags = O_RDONLY;
+	nd.intent.it_flags = FMODE_READ;
 	err = path_lookup(name, LOOKUP_FOLLOW, &nd);
 	file = ERR_PTR(err);
 
diff -uNr linux-2.6.5-12.1/fs/namespace.c linux-2.6.5-12.1.fixed/fs/namespace.c
--- linux-2.6.5-12.1/fs/namespace.c	2004-05-25 20:31:14.919198992 +0300
+++ linux-2.6.5-12.1.fixed/fs/namespace.c	2004-05-25 18:47:22.000000000 +0300
@@ -534,6 +534,8 @@
 		return err;
 	if (!old_name || !*old_name)
 		return -EINVAL;
+
+	intent_init(&old_nd.intent, IT_LOOKUP);
 	err = path_lookup(old_name, LOOKUP_FOLLOW, &old_nd);
 	if (err)
 		return err;
@@ -602,6 +604,7 @@
 		return -EPERM;
 	if (!old_name || !*old_name)
 		return -EINVAL;
+	intent_init(&old_nd.intent, IT_LOOKUP);
 	err = path_lookup(old_name, LOOKUP_FOLLOW, &old_nd);
 	if (err)
 		return err;
diff -uNr linux-2.6.5-12.1/fs/open.c linux-2.6.5-12.1.fixed/fs/open.c
--- linux-2.6.5-12.1/fs/open.c	2004-05-25 20:31:15.615093200 +0300
+++ linux-2.6.5-12.1.fixed/fs/open.c	2004-05-25 18:47:23.000000000 +0300
@@ -240,7 +240,7 @@
 	if (length < 0)	/* sorry, but loff_t says... */
 		goto out;
 
-	FSHOOK_BEGIN_USER_PATH_WALK(truncate, error, path, nd, filename, .length = length)
+	FSHOOK_BEGIN_USER_PATH_WALK_IT(truncate, error, path, nd, filename, .length = length)
 
 	inode = nd.dentry->d_inode;
 
@@ -509,7 +509,7 @@
 	else
 		current->cap_effective = current->cap_permitted;
 
-	FSHOOK_BEGIN_USER_WALK(access,
+	FSHOOK_BEGIN_USER_WALK_IT(access,
 		res,
 		filename,
 		LOOKUP_FOLLOW|LOOKUP_ACCESS,
@@ -606,7 +606,7 @@
 	int error;
 	intent_init(&nd.intent, IT_GETATTR);
 
-	FSHOOK_BEGIN_USER_WALK(chroot,
+	FSHOOK_BEGIN_USER_WALK_IT(chroot,
 		error,
 		filename,
 		LOOKUP_FOLLOW | LOOKUP_DIRECTORY | LOOKUP_NOALT,
diff -uNr linux-2.6.5-12.1/fs/stat.c linux-2.6.5-12.1.fixed/fs/stat.c
--- linux-2.6.5-12.1/fs/stat.c	2004-05-25 20:31:14.920198840 +0300
+++ linux-2.6.5-12.1.fixed/fs/stat.c	2004-05-25 18:47:22.000000000 +0300
@@ -75,9 +75,9 @@
 	int error;
 	intent_init(&nd.intent, IT_GETATTR);
 
-	FSHOOK_BEGIN_USER_PATH_WALK(stat, error, name, nd, path, .link = false)
+	FSHOOK_BEGIN_USER_PATH_WALK_IT(stat, error, name, nd, path, .link = false)
 
-	  error = vfs_getattr_it(nd.mnt, nd.dentry, &nd.intent, stat);
+		error = vfs_getattr_it(nd.mnt, nd.dentry, &nd.intent, stat);
 		path_release(&nd);
 
 	FSHOOK_END_USER_WALK(stat, error, path)
@@ -93,7 +93,7 @@
 	int error;
 	intent_init(&nd.intent, IT_GETATTR);
 
-	FSHOOK_BEGIN_USER_PATH_WALK_LINK(stat, error, name, nd, path, .link = true)
+	FSHOOK_BEGIN_USER_PATH_WALK_LINK_IT(stat, error, name, nd, path, .link = true)
 
 		error = vfs_getattr_it(nd.mnt, nd.dentry, &nd.intent, stat);
 		path_release(&nd);
diff -uNr linux-2.6.5-12.1/include/linux/fshooks.h linux-2.6.5-12.1.fixed/include/linux/fshooks.h
--- linux-2.6.5-12.1/include/linux/fshooks.h	2004-05-10 19:21:56.000000000 +0300
+++ linux-2.6.5-12.1.fixed/include/linux/fshooks.h	2004-05-25 18:47:22.000000000 +0300
@@ -90,12 +90,18 @@
 
 #define FSHOOK_BEGIN_USER_WALK(type, err, path, flags, nd, field, args...) \
 		FSHOOK_BEGIN_USER_WALK_COMMON(type, err, __user_walk(path, flags, &nd, &info.field), nd, args)
+#define FSHOOK_BEGIN_USER_WALK_IT(type, err, path, flags, nd, field, args...) \
+		FSHOOK_BEGIN_USER_WALK_COMMON(type, err, __user_walk_it(path, flags, &nd, &info.field), nd, args)
 
 #define FSHOOK_BEGIN_USER_PATH_WALK(type, err, path, nd, field, args...) \
 		FSHOOK_BEGIN_USER_WALK_COMMON(type, err, __user_walk(path, LOOKUP_FOLLOW, &nd, &info.field), nd, args)
+#define FSHOOK_BEGIN_USER_PATH_WALK_IT(type, err, path, nd, field, args...) \
+		FSHOOK_BEGIN_USER_WALK_COMMON(type, err, __user_walk_it(path, LOOKUP_FOLLOW, &nd, &info.field), nd, args)
 
 #define FSHOOK_BEGIN_USER_PATH_WALK_LINK(type, err, path, nd, field, args...) \
 		FSHOOK_BEGIN_USER_WALK_COMMON(type, err, __user_walk(path, 0, &nd, &info.field), nd, args)
+#define FSHOOK_BEGIN_USER_PATH_WALK_LINK_IT(type, err, path, nd, field, args...) \
+		FSHOOK_BEGIN_USER_WALK_COMMON(type, err, __user_walk_it(path, 0, &nd, &info.field), nd, args)
 
 #define FSHOOK_END_USER_WALK(type, err, field) \
 				(void)(&info != (struct fshook_##type##_info *)-1L); \
@@ -126,12 +132,18 @@
 
 #define FSHOOK_BEGIN_USER_WALK(type, err, path, flags, nd, field, args...) \
 	if (!(err = __user_walk(path, flags, &nd, 0))) {
+#define FSHOOK_BEGIN_USER_WALK_IT(type, err, path, flags, nd, field, args...) \
+	if (!(err = __user_walk_it(path, flags, &nd, 0))) {
 
 #define FSHOOK_BEGIN_USER_PATH_WALK(type, err, path, nd, field, args...) \
 	if (!(err = user_path_walk(path, &nd))) {
+#define FSHOOK_BEGIN_USER_PATH_WALK_IT(type, err, path, nd, field, args...) \
+	if (!(err = user_path_walk_it(path, &nd))) {
 
 #define FSHOOK_BEGIN_USER_PATH_WALK_LINK(type, err, path, nd, field, args...) \
 	if (!(err = user_path_walk_link(path, &nd))) {
+#define FSHOOK_BEGIN_USER_PATH_WALK_LINK_IT(type, err, path, nd, field, args...) \
+	if (!(err = user_path_walk_link_it(path, &nd))) {
 
 #define FSHOOK_END_USER_WALK(type, err, field) ((void)0);}
 

Bye,
    Oleg

