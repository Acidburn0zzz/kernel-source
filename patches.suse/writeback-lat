From Takashi

lock profiling shows 

- mpage_writepages
- sync_supers

Are causing latency problems.  This adds some conditional schedules to
help fix things

Index: linux.t/fs/fs-writeback.c
===================================================================
--- linux.t.orig/fs/fs-writeback.c	2004-03-11 14:13:17.626476957 -0500
+++ linux.t/fs/fs-writeback.c	2004-03-11 14:31:16.239000800 -0500
@@ -315,6 +315,7 @@
 			writeback_release(bdi);
 		spin_unlock(&inode_lock);
 		iput(inode);
+		cond_resched();
 		spin_lock(&inode_lock);
 		if (wbc->nr_to_write <= 0)
 			break;
@@ -360,6 +361,7 @@
 	}
 	spin_unlock(&sb_lock);
 	spin_unlock(&inode_lock);
+	cond_resched();
 }
 
 /*
Index: linux.t/fs/super.c
===================================================================
--- linux.t.orig/fs/super.c	2004-03-11 14:28:01.657694751 -0500
+++ linux.t/fs/super.c	2004-03-11 14:29:53.465180483 -0500
@@ -356,6 +356,7 @@
 {
 	struct super_block * sb;
 restart:
+	cond_resched();
 	spin_lock(&sb_lock);
 	sb = sb_entry(super_blocks.next);
 	while (sb != sb_entry(&super_blocks))
Index: linux.t/fs/mpage.c
===================================================================
--- linux.t.orig/fs/mpage.c	2004-01-09 01:59:19.000000000 -0500
+++ linux.t/fs/mpage.c	2004-03-11 14:29:53.464180776 -0500
@@ -695,6 +695,7 @@
 			unlock_page(page);
 		}
 		page_cache_release(page);
+		cond_resched();
 		spin_lock(&mapping->page_lock);
 	}
 	/*
