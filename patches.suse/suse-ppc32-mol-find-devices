From: schwab@suse.de
Patch-mainline: never
Subject: MoL compilation fixes

---
 drivers/macintosh/mol/_dev.c |   15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

--- a/drivers/macintosh/mol/_dev.c	2007-08-27 14:01:19.000000000 -0400
+++ b/drivers/macintosh/mol/_dev.c	2007-08-27 14:01:20.000000000 -0400
@@ -72,18 +72,27 @@ find_physical_rom( int *base, int *size 
 #ifndef CONFIG_AMIGAONE
 	struct device_node *dn;
 	int len, *p;
+	int by_type = 0;
 	
-	if( !(dn=find_devices("boot-rom")) && !(dn=find_type_devices("rom")) )
+	dn = of_find_node_by_name(NULL, "boot-rom");
+	if (!dn) {
+		by_type = 1;
+		dn = of_find_node_by_type(NULL, "rom");
+	}
+	if (!dn)
 		return 0;
 	do {
-		if( !(p=(int*)get_property(dn, "reg", &len)) || len != sizeof(int[2]) )
+		if( !(p=(int*)get_property(dn, "reg", &len)) || len != sizeof(int[2]) ) {
+			of_node_put(dn);
 			return 0;
+		}
 		if( (unsigned int)(0xfff00100 - p[0]) < (unsigned int)p[1] ) {
 			*base = p[0];
 			*size = p[1];
+			of_node_put(dn);
 			return 1;
 		}
-		dn = dn->next;
+		dn = by_type ? of_find_node_by_type(dn, "rom") : of_find_node_by_name(dn, "boot-rom");
 	} while( dn );
 #endif
 
