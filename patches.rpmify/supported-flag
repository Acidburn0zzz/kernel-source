diff -u linux/include/linux/kernel.h-SUP linux/include/linux/kernel.h
--- linux/include/linux/kernel.h-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/include/linux/kernel.h	2004-06-07 13:03:14.000000000 +0200
@@ -113,6 +113,7 @@
 extern int panic_on_oops;
 extern int system_state;		/* See values below */
 extern int tainted;
+extern int unsupported;
 extern const char *print_tainted(void);
 
 /* Values used for system_state */
@@ -124,6 +125,7 @@
 #define TAINT_FORCED_MODULE		(1<<1)
 #define TAINT_UNSAFE_SMP		(1<<2)
 #define TAINT_FORCED_RMMOD		(1<<3)
+#define TAINT_UNSUPPORTED		(1<<4)
 
 extern void dump_stack(void);
 
diff -u linux/include/linux/sysctl.h-SUP linux/include/linux/sysctl.h
--- linux/include/linux/sysctl.h-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/include/linux/sysctl.h	2004-06-07 13:03:14.000000000 +0200
@@ -141,6 +141,7 @@
 	KERN_MMAPUSEHUGEPAGES=71,       /* int: back anon mmap with hpages */
 	KERN_HPAGES_MAP_SZ=72,  /* int: min size (MB) of mapping */
 	KERN_XMON=73,		/* int: xmon debugger enabled */
+	KERN_UNSUPPORTED=74,	/* int: allow loading of unsupported modules */
 
 };
 
diff -u linux/scripts/Makefile.modpost-SUP linux/scripts/Makefile.modpost
--- linux/scripts/Makefile.modpost-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/scripts/Makefile.modpost	2004-06-07 13:03:14.000000000 +0200
@@ -52,6 +52,7 @@
 quiet_cmd_modpost = MODPOST
       cmd_modpost = scripts/modpost \
 	$(if $(KBUILD_EXTMOD),-i,-o) $(symverfile) \
+	-s $(objtree)/Module.supported \
 	$(filter-out FORCE,$^)
 
 .PHONY: __modpost
diff -u linux/scripts/modpost.c-SUP linux/scripts/modpost.c
--- linux/scripts/modpost.c-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/scripts/modpost.c	2004-06-07 13:03:14.000000000 +0200
@@ -392,6 +392,30 @@
 	return strcmp(myname, "vmlinux") == 0;
 }
 
+static struct {
+	void *file;
+	unsigned long size;
+} supp;
+
+int
+supported(struct module *mod)
+{
+	unsigned long pos = 0;
+	char *line, *basename;
+
+	/* In a first shot, do a simple linear scan. */
+	while ((line = get_next_line(&pos, supp.file, supp.size))) {
+		basename = strrchr(mod->name, '/');
+		if (!basename)
+			basename = line;
+		else
+			basename++;
+		if (!strcmp(basename, line))
+			return 1;
+	}
+	return 0;
+}
+
 void
 read_symbols(char *modname)
 {
@@ -496,6 +520,13 @@
 	buf_printf(b, "};\n");
 }
 
+void
+add_supported_flag(struct buffer *b, struct module *mod)
+{
+	if (supported(mod))
+		buf_printf(b, "\nMODULE_INFO(supported, \"yes\");\n");
+}
+
 /* Record CRCs for unresolved symbols */
 
 void
@@ -617,6 +648,14 @@
 }
 
 void
+read_supported(const char *fname)
+{
+	supp.file = grab_file(fname, &supp.size);
+	if (!supp.file)
+		; /* ignore error */
+}
+
+void
 read_dump(const char *fname)
 {
 	unsigned long size, pos = 0;
@@ -691,9 +730,10 @@
 	struct buffer buf = { };
 	char fname[SZ];
 	char *dump_read = NULL, *dump_write = NULL;
+	char *supp = NULL;
 	int opt;
 
-	while ((opt = getopt(argc, argv, "i:o:")) != -1) {
+	while ((opt = getopt(argc, argv, "i:o:s:")) != -1) {
 		switch(opt) {
 			case 'i':
 				dump_read = optarg;
@@ -701,11 +741,17 @@
 			case 'o':
 				dump_write = optarg;
 				break;
+			case 's':
+				supp = optarg;
+				break;
 			default:
 				exit(1);
 		}
 	}
 
+	if (supp)
+		read_supported(supp);
+
 	if (dump_read)
 		read_dump(dump_read);
 
@@ -720,6 +766,7 @@
 		buf.pos = 0;
 
 		add_header(&buf);
+		add_supported_flag(&buf, mod);
 		add_versions(&buf, mod);
 		add_depends(&buf, mod, modules);
 		add_moddevtable(&buf, mod);
diff -u linux/Documentation/sysctl/kernel.txt-SUP linux/Documentation/sysctl/kernel.txt
--- linux/Documentation/sysctl/kernel.txt-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/Documentation/sysctl/kernel.txt	2004-06-07 13:03:14.000000000 +0200
@@ -321,6 +321,17 @@
   2 - A module was force loaded by insmod -f.
       Set by modutils >= 2.4.9 and module-init-tools.
   4 - Unsafe SMP processors: SMP with CPUs not designed for SMP.
+  8 - An unsupported kernel module was loaded.
+
+==============================================================
+
+unsupported:
+
+Allow to load unsupported kernel modules:
+
+  0 - refuse to load unsupported modules,
+  1 - warn when loading unsupported modules,
+  2 - don't warn.
 
 ==============================================================
 
diff -u linux/Documentation/kernel-parameters.txt-SUP linux/Documentation/kernel-parameters.txt
--- linux/Documentation/kernel-parameters.txt-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/Documentation/kernel-parameters.txt	2004-06-07 13:03:14.000000000 +0200
@@ -1179,6 +1179,12 @@
 
 	stram_swap=	[HW,M68k]
 
+	unsupported	Allow loading of unsupported kernel modules:
+			0 = only allow supported modules,
+			1 = warn when loading unsupported modules,
+			2 = don't warn.
+			
+
 	swiotlb=	[IA-64] Number of I/O TLB slabs
  
 	switches=	[HW,M68k]
diff -u linux/kernel/module.c-SUP linux/kernel/module.c
--- linux/kernel/module.c-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/kernel/module.c	2004-06-07 13:03:14.000000000 +0200
@@ -57,6 +57,20 @@
 #define symbol_is(literal, string)				\
 	(strcmp(MODULE_SYMBOL_PREFIX literal, (string)) == 0)
 
+/* Allow unsupported modules switch. */ 
+#ifdef UNSUPPORTED_MODULES
+int unsupported = UNSUPPORTED_MODULES;
+#else
+int unsupported = 2;  /* don't warn when loading unsupported modules. */
+#endif
+
+static int __init unsupported_setup(char *str)
+{
+	get_option(&str, &unsupported);
+	return 1;
+}
+__setup("unsupported=", unsupported_setup);
+
 /* Protects module list */
 static spinlock_t modlist_lock = SPIN_LOCK_UNLOCKED;
 
@@ -1310,7 +1324,7 @@
 {
 	Elf_Ehdr *hdr;
 	Elf_Shdr *sechdrs;
-	char *secstrings, *args, *modmagic, *strtab = NULL;
+	char *secstrings, *args, *modmagic, *strtab = NULL, *supported;
 	unsigned int i, symindex = 0, strindex = 0, setupindex, exindex,
 		exportindex, modindex, obsparmindex, infoindex, gplindex,
 		crcindex, gplcrcindex, versindex, pcpuindex;
@@ -1425,6 +1439,23 @@
 		goto free_hdr;
 	}
 
+	supported = get_modinfo(sechdrs, infoindex, "supported");
+	if (!supported || strcmp(supported, "yes")) {
+		if (unsupported == 0) {
+			printk(KERN_WARNING "%s: unsupported module, refusing "
+			       "to load. To override, echo "
+			       "1 > /proc/sys/kernel/unsupported\n",
+			       mod->name);
+			err = -ENOEXEC;
+			goto free_hdr;
+		}
+		tainted |= TAINT_UNSUPPORTED;
+		if (unsupported == 1) {
+			printk(KERN_WARNING "%s: unsupported module, tainting "
+			       "kernel.\n", mod->name);
+		}
+	}
+
 	/* Now copy in args */
 	arglen = strlen_user(uargs);
 	if (!arglen) {
diff -u linux/kernel/panic.c-SUP linux/kernel/panic.c
--- linux/kernel/panic.c-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/kernel/panic.c	2004-06-07 13:03:14.000000000 +0200
@@ -160,6 +160,7 @@
  *  'P' - Proprietary module has been loaded.
  *  'F' - Module has been forcibly loaded.
  *  'S' - SMP with CPUs not designed for SMP.
+ *  'U' - Unsuported modules loaded.
  *
  *	The string is overwritten by the next call to print_taint().
  */
@@ -168,10 +169,11 @@
 {
 	static char buf[20];
 	if (tainted) {
-		snprintf(buf, sizeof(buf), "Tainted: %c%c%c",
+		snprintf(buf, sizeof(buf), "Tainted: %c%c%c%c",
 			tainted & TAINT_PROPRIETARY_MODULE ? 'P' : 'G',
 			tainted & TAINT_FORCED_MODULE ? 'F' : ' ',
-			tainted & TAINT_UNSAFE_SMP ? 'S' : ' ');
+			tainted & TAINT_UNSAFE_SMP ? 'S' : ' ',
+			tainted & TAINT_UNSUPPORTED ? 'U' : ' ');
 	}
 	else
 		snprintf(buf, sizeof(buf), "Not tainted");
diff -u linux/kernel/sysctl.c-SUP linux/kernel/sysctl.c
--- linux/kernel/sysctl.c-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/kernel/sysctl.c	2004-06-07 13:03:43.000000000 +0200
@@ -306,6 +306,16 @@
 		.mode		= 0644,
 		.proc_handler	= &proc_dointvec,
 	},
+#ifdef CONFIG_MODULE
+	{
+		.ctl_name	= KERN_UNSUPPORTED,
+		.procname	= "unsupported",
+		.data		= &unsupported,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= &proc_dointvec,
+	},
+#endif
 	{
 		.ctl_name	= KERN_CAP_BSET,
 		.procname	= "cap-bound",
diff -u linux/Makefile-SUP linux/Makefile
--- linux/Makefile-SUP	2004-06-07 13:03:09.000000000 +0200
+++ linux/Makefile	2004-06-07 13:03:14.000000000 +0200
@@ -313,6 +313,10 @@
 	  	   -fno-strict-aliasing -fno-common
 AFLAGS		:= -D__ASSEMBLY__
 
+ifneq ($(UNSUPPORTED_MODULES),)
+CFLAGS		+= -DUNSUPPORTED_MODULES=$(UNSUPPORTED_MODULES)
+endif
+
 export	VERSION PATCHLEVEL SUBLEVEL EXTRAVERSION KERNELRELEASE ARCH \
 	CONFIG_SHELL HOSTCC HOSTCFLAGS CROSS_COMPILE AS LD CC \
 	CPP AR NM STRIP OBJCOPY OBJDUMP MAKE AWK GENKSYMS PERL UTS_MACHINE \
