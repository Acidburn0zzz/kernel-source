Index: linux-2.6.4/Makefile
===================================================================
--- linux-2.6.4.orig/Makefile
+++ linux-2.6.4/Makefile
@@ -274,7 +274,8 @@ AFLAGS_KERNEL	=
 NOSTDINC_FLAGS  = -nostdinc -iwithprefix include
 
 CPPFLAGS        := -D__KERNEL__ -Iinclude \
-		   $(if $(KBUILD_SRC),-Iinclude2 -I$(srctree)/include)
+		   $(if $(KBUILD_SRC),-Iinclude2 -I$(srctree)/include) \
+		   $(if $(ARCH_FLAVOR),-DARCH_FLAVOR_$(shell echo $(ARCH_FLAVOR) | tr a-z- A-Z_))
 
 CFLAGS 		:= -Wall -Wstrict-prototypes -Wno-trigraphs \
 	  	   -fno-strict-aliasing -fno-common
Index: linux-2.6.4/scripts/kconfig/Makefile
===================================================================
--- linux-2.6.4.orig/scripts/kconfig/Makefile
+++ linux-2.6.4/scripts/kconfig/Makefile
@@ -3,25 +3,37 @@
 # These targets are used from top-level makefile
 
 .PHONY: oldconfig xconfig gconfig menuconfig config silentoldconfig \
-	cloneconfig
+	cloneconfig check-meta
 
-xconfig: $(obj)/qconf
+check-meta:
+	@if [ -e .config ] &&						\
+		grep /var/adm/running-kernel.make .config; then		\
+	    echo;							\
+	    echo "The .config file is a merged configuration; please"	\
+		 "remove it by hand before creating your own."		\
+		 "You can use one of the files arch/$(ARCH)/defconfig.*" \
+		 "as a template.";					\
+	    echo;							\
+	    exit 1;							\
+	fi
+
+xconfig: check-meta $(obj)/qconf
 	$< arch/$(ARCH)/Kconfig
 
-gconfig: $(obj)/gconf
+gconfig: $check-meta (obj)/gconf
 	./$<  arch/$(ARCH)/Kconfig
 
-menuconfig: $(obj)/mconf
+menuconfig: check-meta $(obj)/mconf
 	$(Q)$(MAKE) $(build)=scripts/lxdialog
 	$< arch/$(ARCH)/Kconfig
 
-config: $(obj)/conf
+config: check-meta $(obj)/conf
 	$< arch/$(ARCH)/Kconfig
 
-oldconfig: $(obj)/conf
+oldconfig: check-meta $(obj)/conf
 	$< -o arch/$(ARCH)/Kconfig
 
-silentoldconfig: $(obj)/conf
+silentoldconfig: check-meta $(obj)/conf
 	$< -s arch/$(ARCH)/Kconfig
 
 check_CONFIG_IKCONFIG_PROC:
@@ -32,20 +44,20 @@ check_CONFIG_IKCONFIG_PROC:
 
 _cloneconfig: check_CONFIG_IKCONFIG_PROC
 	$(Q)gzip -cd /proc/config.gz > $(obj)/.config
-cloneconfig: _cloneconfig oldconfig
+cloneconfig: check-meta _cloneconfig oldconfig
 
 .PHONY: randconfig allyesconfig allnoconfig allmodconfig defconfig
 
-randconfig: $(obj)/conf
+randconfig: check-meta $(obj)/conf
 	$< -r arch/$(ARCH)/Kconfig
 
-allyesconfig: $(obj)/conf
+allyesconfig: check-meta $(obj)/conf
 	$< -y arch/$(ARCH)/Kconfig
 
-allnoconfig: $(obj)/conf
+allnoconfig: check-meta $(obj)/conf
 	$< -n arch/$(ARCH)/Kconfig
 
-allmodconfig: $(obj)/conf
+allmodconfig: check-meta $(obj)/conf
 	$< -m arch/$(ARCH)/Kconfig
 
 _defconfig: check_CONFIG_IKCONFIG_PROC
@@ -56,7 +68,7 @@ _defconfig: check_CONFIG_IKCONFIG_PROC
 	    false;							\
 	fi;								\
 	cp $$config $(obj)/.config
-defconfig: _defconfig oldconfig
+defconfig: check-meta _defconfig oldconfig
 
 # Help text used by make help
 help:
