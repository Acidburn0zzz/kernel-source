Index: linux/Makefile
===================================================================
--- linux.orig/Makefile	2003-12-05 17:12:05.000000000 +0100
+++ linux/Makefile	2003-12-05 23:10:38.760732214 +0100
@@ -273,7 +273,8 @@
 NOSTDINC_FLAGS  = -nostdinc -iwithprefix include
 
 CPPFLAGS        := -D__KERNEL__ -Iinclude \
-		   $(if $(KBUILD_SRC),-Iinclude2 -I$(srctree)/include)
+		   $(if $(KBUILD_SRC),-Iinclude2 -I$(srctree)/include) \
+		   $(if $(CONFIG_CFGNAME),-DCONFIG_FLAVOR_$(shell echo $(CONFIG_CFGNAME) |tr a-z A-Z))
 
 CFLAGS 		:= -Wall -Wstrict-prototypes -Wno-trigraphs -O2 \
 	  	   -fno-strict-aliasing -fno-common
Index: linux/scripts/kconfig/Makefile
===================================================================
--- linux.orig/scripts/kconfig/Makefile	2003-12-05 15:49:34.000000000 +0100
+++ linux/scripts/kconfig/Makefile	2003-12-05 16:47:22.218763479 +0100
@@ -4,40 +4,52 @@
 
-.PHONY: oldconfig xconfig gconfig menuconfig config silentoldconfig
+.PHONY: oldconfig xconfig gconfig menuconfig config silentoldconfig check-meta
 
-xconfig: $(obj)/qconf
+check-meta:
+	@if [ -e .config ] && \
+	   grep /var/adm/running-kernel.make .config ; then \
+		echo ; \
+		echo "The .config file is a merged configuration; please" \
+		     "remove it by hand before creating your own" \
+		     "configuration. You can use one of the files" \
+		     "arch/$(ARCH)/defconfig.* as template." ; \
+		echo ; \
+		exit 1 ; \
+	fi
+
+xconfig: $(obj)/qconf check-meta
 	$< arch/$(ARCH)/Kconfig
 
-gconfig: $(obj)/gconf
+gconfig: $(obj)/gconf check-meta
 	./$<  arch/$(ARCH)/Kconfig
 
-menuconfig: $(obj)/mconf
+menuconfig: $(obj)/mconf check-meta
 	$(Q)$(MAKE) $(build)=scripts/lxdialog
 	$< arch/$(ARCH)/Kconfig
 
-config: $(obj)/conf
+config: $(obj)/conf check-meta
 	$< arch/$(ARCH)/Kconfig
 
-oldconfig: $(obj)/conf
+oldconfig: $(obj)/conf check-meta
 	$< -o arch/$(ARCH)/Kconfig
 
-silentoldconfig: $(obj)/conf
+silentoldconfig: $(obj)/conf check-meta
 	$< -s arch/$(ARCH)/Kconfig
 
 .PHONY: randconfig allyesconfig allnoconfig allmodconfig defconfig
 
-randconfig: $(obj)/conf
+randconfig: $(obj)/conf check-meta
 	$< -r arch/$(ARCH)/Kconfig
 
-allyesconfig: $(obj)/conf
+allyesconfig: $(obj)/conf check-meta
 	$< -y arch/$(ARCH)/Kconfig
 
-allnoconfig: $(obj)/conf
+allnoconfig: $(obj)/conf check-meta
 	$< -n arch/$(ARCH)/Kconfig
 
-allmodconfig: $(obj)/conf
+allmodconfig: $(obj)/conf check-meta
 	$< -m arch/$(ARCH)/Kconfig
 
-defconfig: $(obj)/conf
+defconfig: $(obj)/conf check-meta
 	$< -d arch/$(ARCH)/Kconfig
 
 %_defconfig: $(obj)/conf
