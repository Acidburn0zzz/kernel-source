From: Andreas Gruenbacher <agruen@suse.de>
Subject: Fix compiling /usr/src/linux directly with O=

/etc/init.d/running-kernel creates the /usr/src/linux/include/asm
symlink among other things so that user-space programs which include
kernel headers directly won't fail miserably. While including kernel
headers directly is not recommended, it's sometimes the most sensible
thing to do. Now when trying to compile the /usr/src/linux tree with
a different output directory as below, a check in the main kernel
Makefile aborts the build. This patch fixes it.

  /usr/src/linux$ mkdir /var/tmp/obj
  /usr/src/linux$ cp arch/i386/defconfig.default /var/tmp/obj/.config
  /usr/src/linux$ make O=/var/tmp/obj

Signed-off-by: Andreas Gruenbacher <agruen@suse.de>

Index: linux-2.6.11/Makefile
===================================================================
--- linux-2.6.11.orig/Makefile
+++ linux-2.6.11/Makefile
@@ -760,7 +760,7 @@ $(vmlinux-dirs): prepare-all scripts
 prepare2:
 ifneq ($(KBUILD_SRC),)
 	@echo '  Using $(srctree) as source for kernel'
-	$(Q)if [ -h $(srctree)/include/asm -o -f $(srctree)/.config ]; then \
+	$(Q)if [ -f $(srctree)/.config ]; then \
 		echo "  $(srctree) is not clean, please run 'make mrproper'";\
 		echo "  in the '$(srctree)' directory.";\
 		/bin/false; \
@@ -772,7 +772,7 @@ endif
 # prepare1 creates a makefile if using a separate output directory
 prepare1: prepare2 outputmakefile
 
-prepare0: prepare1 include/linux/version.h include/asm include/config/MARKER
+prepare0: prepare1 include/linux/version.h $(objtree)/include/asm include/config/MARKER
 ifneq ($(KBUILD_MODULES),)
 	$(Q)rm -rf $(MODVERDIR)
 	$(Q)mkdir -p $(MODVERDIR)
@@ -808,7 +808,8 @@ export CPPFLAGS_vmlinux.lds += -P -C -U$
 #	hard to detect, but I suppose "make mrproper" is a good idea
 #	before switching between archs anyway.
 
-include/asm:
+include/asm: $(objtree)/include/asm
+$(objtree)/include/asm:
 	@echo '  SYMLINK $@ -> include/asm-$(ARCH)'
 	$(Q)if [ ! -d include ]; then mkdir -p include; fi;
 	@ln -fsn asm-$(ARCH) $@
