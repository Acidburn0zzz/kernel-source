From: Andreas Gruenbacher <agruen@suse.de>
Subject: Fix compiling /usr/src/linux directly with O=
References: 65891

/etc/init.d/running-kernel creates the /usr/src/linux/include/asm
symlink among other things so that user-space programs which include
kernel headers directly won't fail miserably. While including kernel
headers directly is not recommended, it's sometimes the most sensible
thing to do. Now when trying to compile the /usr/src/linux tree with
a different output directory as below, a check in the main kernel
Makefile aborts the build. This patch fixes it.

  /usr/src/linux$ mkdir /var/tmp/obj
  /usr/src/linux$ cp arch/i386/defconfig.default /var/tmp/obj/.config
  /usr/src/linux$ make O=/var/tmp/obj

Signed-off-by: Andreas Gruenbacher <agruen@suse.de>

Index: linux-2.6.13/Makefile
===================================================================
--- linux-2.6.13.orig/Makefile
+++ linux-2.6.13/Makefile
@@ -469,7 +469,7 @@ ifeq ($(KBUILD_EXTMOD),)
 scripts: scripts_basic include/config/MARKER
 	$(Q)$(MAKE) $(build)=$(@)
 
-scripts_basic: include/linux/autoconf.h
+scripts_basic: $(objtree)/include/linux/autoconf.h
 
 # Objects we will link into vmlinux / subdirs we need to visit
 init-y		:= init/
@@ -495,11 +495,11 @@ include .config
 
 # If .config is newer than include/linux/autoconf.h, someone tinkered
 # with it and forgot to run make oldconfig
-include/linux/autoconf.h: .config
+$(objtree)/include/linux/autoconf.h: .config
 	$(Q)$(MAKE) -f $(srctree)/Makefile silentoldconfig
 else
 # Dummy target needed, because used as prerequisite
-include/linux/autoconf.h: ;
+$(objtree)/include/linux/autoconf.h: ;
 endif
 
 # The all: target is the default when no target is given on the
@@ -761,7 +761,7 @@ $(vmlinux-dirs): prepare-all scripts
 prepare2:
 ifneq ($(KBUILD_SRC),)
 	@echo '  Using $(srctree) as source for kernel'
-	$(Q)if [ -h $(srctree)/include/asm -o -f $(srctree)/.config ]; then \
+	$(Q)if [ -f $(srctree)/.config ]; then \
 		echo "  $(srctree) is not clean, please run 'make mrproper'";\
 		echo "  in the '$(srctree)' directory.";\
 		/bin/false; \
@@ -773,7 +773,7 @@ endif
 # prepare1 creates a makefile if using a separate output directory
 prepare1: prepare2 outputmakefile
 
-prepare0: prepare1 include/linux/version.h include/asm include/config/MARKER
+prepare0: prepare1 $(objtree)/include/linux/version.h $(objtree)/include/asm include/config/MARKER
 ifneq ($(KBUILD_MODULES),)
 	$(Q)rm -rf $(MODVERDIR)
 	$(Q)mkdir -p $(MODVERDIR)
@@ -812,14 +812,14 @@ export CPPFLAGS_vmlinux.lds += -P -C -U$
 #	hard to detect, but I suppose "make mrproper" is a good idea
 #	before switching between archs anyway.
 
-include/asm:
+$(objtree)/include/asm:
 	@echo '  SYMLINK $@ -> include/asm-$(ARCH)'
 	$(Q)if [ ! -d include ]; then mkdir -p include; fi;
 	@ln -fsn asm-$(ARCH) $@
 
 # 	Split autoconf.h into include/linux/config/*
 
-include/config/MARKER: include/linux/autoconf.h
+include/config/MARKER: $(objtree)/include/linux/autoconf.h
 	@echo '  SPLIT   include/linux/autoconf.h -> include/config/*'
 	@scripts/basic/split-include include/linux/autoconf.h include/config
 	@touch $@
@@ -843,7 +843,7 @@ define filechk_version.h
 	)
 endef
 
-include/linux/version.h: $(srctree)/Makefile FORCE
+$(objtree)/include/linux/version.h: $(srctree)/Makefile FORCE
 	$(call filechk,version.h)
 
 # ---------------------------------------------------------------------------
Index: linux-2.6.13/scripts/Makefile.lib
===================================================================
--- linux-2.6.13.orig/scripts/Makefile.lib
+++ linux-2.6.13/scripts/Makefile.lib
@@ -112,7 +112,7 @@ __cpp_flags     = $(_cpp_flags)
 else
 
 # Prefix -I with $(srctree) if it is not an absolute path
-addtree = $(if $(filter-out -I/%,$(1)),$(patsubst -I%,-I$(srctree)/%,$(1))) $(1)
+addtree = $(1) $(if $(filter-out -I/%,$(1)),$(patsubst -I%,-I$(srctree)/%,$(1)))
 # Find all -I options and call addtree
 flags = $(foreach o,$($(1)),$(if $(filter -I%,$(o)),$(call addtree,$(o)),$(o)))
 
Index: linux-2.6.13/arch/alpha/Makefile
===================================================================
--- linux-2.6.13.orig/arch/alpha/Makefile
+++ linux-2.6.13/arch/alpha/Makefile
@@ -111,7 +111,8 @@ bootimage bootpfile bootpzfile: vmlinux
 
 prepare: include/asm-$(ARCH)/asm_offsets.h
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/asm_offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/arm/Makefile
===================================================================
--- linux-2.6.13.orig/arch/arm/Makefile
+++ linux-2.6.13/arch/arm/Makefile
@@ -178,7 +178,7 @@ endif
 prepare: maketools include/asm-arm/.arch
 
 .PHONY: maketools FORCE
-maketools: include/asm-arm/constants.h include/linux/version.h FORCE
+maketools: include/asm-arm/constants.h $(objtree)/include/linux/version.h FORCE
 	$(Q)$(MAKE) $(build)=arch/arm/tools include/asm-arm/mach-types.h
 
 # Convert bzImage to zImage
@@ -201,7 +201,8 @@ archclean:
 bp:;	$(Q)$(MAKE) $(build)=$(boot) MACHINE=$(MACHINE) $(boot)/bootpImage
 i zi:;	$(Q)$(MAKE) $(build)=$(boot) MACHINE=$(MACHINE) $@
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/asm-arm/.arch
 
 include/asm-$(ARCH)/constants.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/arm26/Makefile
===================================================================
--- linux-2.6.13.orig/arch/arm26/Makefile
+++ linux-2.6.13/arch/arm26/Makefile
@@ -98,7 +98,8 @@ zi:;	$(Q)$(MAKE) $(build)=$(boot) zinsta
 	fi; \
 	)
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/asm_offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/cris/Makefile
===================================================================
--- linux-2.6.13.orig/arch/cris/Makefile
+++ linux-2.6.13/arch/cris/Makefile
@@ -129,8 +129,10 @@ $(srctree)/include/asm-$(ARCH)/.arch: $(
 	@ln -sf $(srctree)/include/asm-$(ARCH)/$(SARCH) $(srctree)/include/asm-$(ARCH)/arch
 	@touch $@
 
-arch/$(ARCH)/$(SARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
-					include/config/MARKER
+arch/$(ARCH)/$(SARCH)/kernel/asm-offsets.s: \
+				$(objtree)/include/asm \
+				$(objtree)/include/linux/version.h \
+				include/config/MARKER
 
 include/asm-$(ARCH)/$(SARCH)/offset.h: arch/$(ARCH)/$(SARCH)/kernel/asm-offsets.s
 	$(call filechk,gen-asm-offsets)
Index: linux-2.6.13/arch/h8300/Makefile
===================================================================
--- linux-2.6.13.orig/arch/h8300/Makefile
+++ linux-2.6.13/arch/h8300/Makefile
@@ -64,7 +64,8 @@ archclean:
 prepare: include/asm-$(ARCH)/asm-offsets.h
 
 include/asm-$(ARCH)/asm-offsets.h: arch/$(ARCH)/kernel/asm-offsets.s \
-				   include/asm include/linux/version.h
+				   $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h
 	$(call filechk,gen-asm-offsets)
 
 vmlinux.srec vmlinux.bin: vmlinux
Index: linux-2.6.13/arch/i386/Makefile
===================================================================
--- linux-2.6.13.orig/arch/i386/Makefile
+++ linux-2.6.13/arch/i386/Makefile
@@ -159,7 +159,8 @@ install kernel_install:
 prepare: include/asm-$(ARCH)/asm_offsets.h
 CLEAN_FILES += include/asm-$(ARCH)/asm_offsets.h
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/asm_offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/ia64/Makefile
===================================================================
--- linux-2.6.13.orig/arch/ia64/Makefile
+++ linux-2.6.13/arch/ia64/Makefile
@@ -88,7 +88,9 @@ MRPROPER_FILES += include/asm-ia64/offse
 
 prepare: include/asm-ia64/offsets.h
 
-arch/ia64/kernel/asm-offsets.s: include/asm include/linux/version.h include/config/MARKER
+arch/ia64/kernel/asm-offsets.s: $(objtree)/include/asm \
+				$(objtree)/include/linux/version.h \
+				include/config/MARKER
 
 include/asm-ia64/offsets.h: arch/ia64/kernel/asm-offsets.s
 	$(call filechk,gen-asm-offsets)
Index: linux-2.6.13/arch/m68k/Makefile
===================================================================
--- linux-2.6.13.orig/arch/m68k/Makefile
+++ linux-2.6.13/arch/m68k/Makefile
@@ -116,7 +116,8 @@ endif
 prepare: include/asm-$(ARCH)/offsets.h
 MRPROPER_FILES += include/asm-$(ARCH)/offsets.h
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/m68knommu/Makefile
===================================================================
--- linux-2.6.13.orig/arch/m68knommu/Makefile
+++ linux-2.6.13/arch/m68knommu/Makefile
@@ -112,6 +112,7 @@ archclean:
 	$(call descend arch/$(ARCH)/boot, subdirclean)
 
 include/asm-$(ARCH)/asm-offsets.h: arch/$(ARCH)/kernel/asm-offsets.s \
-				   include/asm include/linux/version.h \
+				   $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 	$(call filechk,gen-asm-offsets)
Index: linux-2.6.13/arch/mips/Makefile
===================================================================
--- linux-2.6.13.orig/arch/mips/Makefile
+++ linux-2.6.13/arch/mips/Makefile
@@ -754,8 +754,9 @@ endef
 
 prepare: include/asm-$(ARCH)/offset.h
 
-arch/$(ARCH)/kernel/offset.s: include/asm include/linux/version.h \
-				   include/config/MARKER
+arch/$(ARCH)/kernel/offset.s: $(objtree)/include/asm \
+			      $(objtree)/include/linux/version.h \
+			      include/config/MARKER
 
 include/asm-$(ARCH)/offset.h: arch/$(ARCH)/kernel/offset.s
 	$(call filechk,gen-asm-offset.h)
Index: linux-2.6.13/arch/parisc/Makefile
===================================================================
--- linux-2.6.13.orig/arch/parisc/Makefile
+++ linux-2.6.13/arch/parisc/Makefile
@@ -102,8 +102,9 @@ install: kernel_install modules_install
 
 prepare: include/asm-parisc/offsets.h
 
-arch/parisc/kernel/asm-offsets.s: include/asm include/linux/version.h \
-				   include/config/MARKER
+arch/parisc/kernel/asm-offsets.s: $(objtree)/include/asm \
+				  $(objtree)/include/linux/version.h \
+				  include/config/MARKER
 
 include/asm-parisc/offsets.h: arch/parisc/kernel/asm-offsets.s
 	$(call filechk,gen-asm-offsets)
Index: linux-2.6.13/arch/ppc/Makefile
===================================================================
--- linux-2.6.13.orig/arch/ppc/Makefile
+++ linux-2.6.13/arch/ppc/Makefile
@@ -104,7 +104,8 @@ archclean:
 
 prepare: include/asm-$(ARCH)/offsets.h checkbin
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/ppc64/Makefile
===================================================================
--- linux-2.6.13.orig/arch/ppc64/Makefile
+++ linux-2.6.13/arch/ppc64/Makefile
@@ -115,8 +115,9 @@ archclean:
 
 prepare: include/asm-ppc64/offsets.h
 
-arch/ppc64/kernel/asm-offsets.s: include/asm include/linux/version.h \
-				   include/config/MARKER
+arch/ppc64/kernel/asm-offsets.s: $(objtree)/include/asm \
+				 $(objtree)/include/linux/version.h \
+				 include/config/MARKER
 
 include/asm-ppc64/offsets.h: arch/ppc64/kernel/asm-offsets.s
 	$(call filechk,gen-asm-offsets)
Index: linux-2.6.13/arch/s390/Makefile
===================================================================
--- linux-2.6.13.orig/arch/s390/Makefile
+++ linux-2.6.13/arch/s390/Makefile
@@ -102,7 +102,8 @@ archclean:
 
 prepare: include/asm-$(ARCH)/offsets.h
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/sh/Makefile
===================================================================
--- linux-2.6.13.orig/arch/sh/Makefile
+++ linux-2.6.13/arch/sh/Makefile
@@ -155,7 +155,7 @@ endif
 prepare: maketools include/asm-sh/.cpu include/asm-sh/.mach
 
 .PHONY: maketools FORCE
-maketools: include/asm-sh/asm-offsets.h include/linux/version.h FORCE
+maketools: include/asm-sh/asm-offsets.h $(objtree)/include/linux/version.h FORCE
 	$(Q)$(MAKE) $(build)=arch/sh/tools include/asm-sh/machtypes.h
 
 all: zImage
@@ -170,7 +170,8 @@ archclean:
 
 CLEAN_FILES += include/asm-sh/machtypes.h include/asm-sh/asm-offsets.h
 
-arch/sh/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/sh/kernel/asm-offsets.s: $(objtree)/include/asm \
+			      $(objtree)/include/linux/version.h \
 			      include/asm-sh/.cpu include/asm-sh/.mach
 
 include/asm-sh/asm-offsets.h: arch/sh/kernel/asm-offsets.s
Index: linux-2.6.13/arch/sh64/Makefile
===================================================================
--- linux-2.6.13.orig/arch/sh64/Makefile
+++ linux-2.6.13/arch/sh64/Makefile
@@ -76,7 +76,8 @@ archclean:
 prepare: include/asm-$(ARCH)/asm-offsets.h arch/$(ARCH)/lib/syscalltab.h
 
 include/asm-$(ARCH)/asm-offsets.h: arch/$(ARCH)/kernel/asm-offsets.s \
-				   include/asm include/linux/version.h
+				   $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h
 	$(call filechk,gen-asm-offsets)
 
 define filechk_gen-syscalltab
Index: linux-2.6.13/arch/sparc/Makefile
===================================================================
--- linux-2.6.13.orig/arch/sparc/Makefile
+++ linux-2.6.13/arch/sparc/Makefile
@@ -61,7 +61,8 @@ archclean:
 
 prepare: include/asm-$(ARCH)/asm_offsets.h
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/asm_offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
Index: linux-2.6.13/arch/um/Makefile
===================================================================
--- linux-2.6.13.orig/arch/um/Makefile
+++ linux-2.6.13/arch/um/Makefile
@@ -196,7 +196,7 @@ define filechk_umlconfig
 	sed 's/ CONFIG/ UML_CONFIG/'
 endef
 
-$(ARCH_DIR)/include/uml-config.h : include/linux/autoconf.h
+$(ARCH_DIR)/include/uml-config.h : $(objtree)/include/linux/autoconf.h
 	$(call filechk,umlconfig)
 
 $(ARCH_DIR)/user-offsets.s: $(ARCH_DIR)/sys-$(SUBARCH)/user-offsets.c
@@ -210,7 +210,8 @@ CLEAN_FILES += $(ARCH_DIR)/user-offsets.
 $(ARCH_DIR)/kernel-offsets.s: $(ARCH_DIR)/sys-$(SUBARCH)/kernel-offsets.c \
 				   $(ARCH_SYMLINKS) \
 				   $(SYS_DIR)/sc.h \
-				   include/asm include/linux/version.h \
+				   $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER \
 				   $(ARCH_DIR)/include/user_constants.h
 	$(CC) $(CFLAGS) $(NOSTDINC_FLAGS) $(CPPFLAGS) -S -o $@ $<
Index: linux-2.6.13/arch/um/Makefile-i386
===================================================================
--- linux-2.6.13.orig/arch/um/Makefile-i386
+++ linux-2.6.13/arch/um/Makefile-i386
@@ -50,7 +50,7 @@ $(SYS_UTIL_DIR)/mk_sc: scripts_basic $(A
 $(SYS_UTIL_DIR)/mk_thread: scripts_basic $(ARCH_DIR)/kernel-offsets.h FORCE
 	$(Q)$(MAKE) $(build)=$(SYS_UTIL_DIR) $@
 
-$(SYS_UTIL_DIR): scripts_basic include/asm FORCE
+$(SYS_UTIL_DIR): scripts_basic $(objtree)/include/asm FORCE
 	$(Q)$(MAKE) $(build)=$(SYS_UTIL_DIR)
 
 CLEAN_FILES += $(SYS_HEADERS)
Index: linux-2.6.13/arch/v850/Makefile
===================================================================
--- linux-2.6.13.orig/arch/v850/Makefile
+++ linux-2.6.13/arch/v850/Makefile
@@ -55,8 +55,9 @@ endif
 prepare: include/asm-$(ARCH)/asm-consts.h
 
 # Generate constants from C code for use by asm files
-arch/$(ARCH)/kernel/asm-consts.s: include/asm include/linux/version.h \
-				   include/config/MARKER
+arch/$(ARCH)/kernel/asm-consts.s: $(objtree)/include/asm \
+				  $(objtree)/include/linux/version.h \
+				  include/config/MARKER
 
 include/asm-$(ARCH)/asm-consts.h: arch/$(ARCH)/kernel/asm-consts.s
 	$(call filechk,gen-asm-offsets)
Index: linux-2.6.13/arch/x86_64/Makefile
===================================================================
--- linux-2.6.13.orig/arch/x86_64/Makefile
+++ linux-2.6.13/arch/x86_64/Makefile
@@ -88,7 +88,8 @@ archclean:
 
 prepare: include/asm-$(ARCH)/offset.h
 
-arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h \
+arch/$(ARCH)/kernel/asm-offsets.s: $(objtree)/include/asm \
+				   $(objtree)/include/linux/version.h \
 				   include/config/MARKER
 
 include/asm-$(ARCH)/offset.h: arch/$(ARCH)/kernel/asm-offsets.s
