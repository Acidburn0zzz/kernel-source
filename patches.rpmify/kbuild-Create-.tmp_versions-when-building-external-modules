#date: 2004-04-13
#from: Sam Ravnborg <sam@ravnborg.org>
#id: 1.1371.1.370
#tag: via-mm
#time: 09:21:59
#title: kbuild: Create .tmp_versions when building external modules
#who: akpm@osdl.org[torvalds]
#
# ChangeSet
#   1.1371.1.370 04/04/13 09:21:59 akpm@osdl.org[torvalds] +2 -0
#   [PATCH] kbuild: Create .tmp_versions when building external modules
#   
#   From: Sam Ravnborg <sam@ravnborg.org>
#   
#   When building external modules the $PWD/.tmp_versions directory is used.
#   The .tmp_versions directory in the kernel tree cannot be used because this
#   would clutter up the kernel tree especially when more than one external
#   module is being build for the same kernel tree.
#   
#   This patch make sure to create $PWD/.tmp_versions, and to delete it during
#   make clean.  It also removes warning about 'messed with SUBDIRS', this is
#   no longer relevant when .tmp_versions is made outside the kernel tree.
#
# scripts/Makefile.modinst +0 -4
# Makefile +13 -7
#
diff -Nru a/Makefile b/Makefile
--- a/Makefile	Tue Apr 27 23:19:35 2004
+++ b/Makefile	Tue Apr 27 23:19:35 2004
@@ -787,12 +787,6 @@
 # make mrproper  Delete the current configuration, and all generated files
 # make distclean Remove editor backup files, patch leftover files and the like
 
-quiet_cmd_rmdirs = $(if $(wildcard $(rm-dirs)),CLEAN   $(wildcard $(rm-dirs)))
-      cmd_rmdirs = rm -rf $(rm-dirs)
-
-quiet_cmd_rmfiles = $(if $(wildcard $(rm-files)),CLEAN   $(wildcard $(rm-files)))
-      cmd_rmfiles = rm -f $(rm-files)
-
 # Directories & files removed with 'make clean'
 CLEAN_DIRS  += $(MODVERDIR)
 CLEAN_FILES +=	vmlinux System.map kernel.spec \
@@ -951,9 +945,12 @@
 
 # We are always building modules
 KBUILD_MODULES := 1
+.PHONY: crmodverdir
+crmodverdir: FORCE
+	$(Q)mkdir -p $(MODVERDIR)
 
 .PHONY: $(KBUILD_EXTMOD)
-$(KBUILD_EXTMOD): FORCE
+$(KBUILD_EXTMOD): crmodverdir FORCE
 	$(Q)$(MAKE) $(build)=$@
 
 .PHONY: modules
@@ -971,7 +968,9 @@
 $(clean-dirs):
 	$(Q)$(MAKE) $(clean)=$(patsubst _clean_%,%,$@)
 
+clean:	rm-dirs := $(MODVERDIR)
 clean: $(clean-dirs)
+	$(call cmd,rmdirs)
 	@find $(KBUILD_EXTMOD) $(RCS_FIND_IGNORE) \
 	 	\( -name '*.[oas]' -o -name '*.ko' -o -name '.*.cmd' \
 		-o -name '.*.d' -o -name '.*.tmp' -o -name '*.mod.c' \) \
@@ -1057,6 +1056,13 @@
 
 # FIXME Should go into a make.lib or something 
 # ===========================================================================
+
+quiet_cmd_rmdirs = $(if $(wildcard $(rm-dirs)),CLEAN   $(wildcard $(rm-dirs)))
+      cmd_rmdirs = rm -rf $(rm-dirs)
+
+quiet_cmd_rmfiles = $(if $(wildcard $(rm-files)),CLEAN   $(wildcard $(rm-files)))
+      cmd_rmfiles = rm -f $(rm-files)
+
 
 a_flags = -Wp,-MD,$(depfile) $(AFLAGS) $(AFLAGS_KERNEL) \
 	  $(NOSTDINC_FLAGS) $(CPPFLAGS) \
diff -Nru a/scripts/Makefile.modinst b/scripts/Makefile.modinst
--- a/scripts/Makefile.modinst	Tue Apr 27 23:19:35 2004
+++ b/scripts/Makefile.modinst	Tue Apr 27 23:19:35 2004
@@ -12,10 +12,6 @@
 __modules := $(shell head -q -n1 /dev/null $(wildcard $(MODVERDIR)/*.mod))
 modules := $(patsubst %.o,%.ko,$(wildcard $(__modules:.ko=.o)))
 
-ifneq ($(filter-out $(modules),$(__modules)),)
-  $(warning *** Uh-oh, you have stale module entries. You messed with SUBDIRS, do not complain if something goes wrong.)
-endif
-
 .PHONY: $(modules)
 __modinst: $(modules)
 	@:
