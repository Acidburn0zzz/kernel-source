From: Jeff Mahoney <jeffm@suse.com>
Subject: [PATCH] spin_is_contended Kconfig fixes

 include/linux/spinlock.h contains the following chunk:
 #ifdef CONFIG_GENERIC_LOCKBREAK
 #define spin_is_contended(lock) ((lock)->break_lock)
 #else
 #define spin_is_contended(lock) __raw_spin_is_contended(&(lock)->raw_lock)
 #endif

 __raw_spin_is_contended() is only implemented on mips and x86.

 Prior to a recent commit against btrfs, spin_needbreak was the only
 user of spin_is_contended, and it returns 0 when !CONFIG_PREEMPT. The
 architecture Kconfigs reflect that, depending on PREEMPT to enable
 GENERIC_LOCKBREAK. With the btrfs changes, this is causing build
 failures on anything !x86 (and mips, but I don't build on mips).

 Now that there is another user of spin_is_contended, the PREEMPT
 dependency is obsolete. This removes the dependency.

 This patch also adds GENERIC_LOCKBREAK entries to architectures that
 didn't have it and offer SMP support.

 The removal of the SPARC64 dependency isn't an oversight - SMP is
 supported for 32-bit sparc, so it would run into the same problem.

Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 arch/alpha/Kconfig    |    5 +++++
 arch/arm/Kconfig      |    2 +-
 arch/blackfin/Kconfig |    5 +++++
 arch/ia64/Kconfig     |    2 +-
 arch/m32r/Kconfig     |    2 +-
 arch/parisc/Kconfig   |    2 +-
 arch/powerpc/Kconfig  |    2 +-
 arch/s390/Kconfig     |    2 +-
 arch/sh/Kconfig       |    7 ++++++-
 arch/sparc/Kconfig    |    2 +-
 10 files changed, 23 insertions(+), 8 deletions(-)

--- a/arch/alpha/Kconfig
+++ b/arch/alpha/Kconfig
@@ -25,6 +25,11 @@ config MMU
 config RWSEM_GENERIC_SPINLOCK
 	bool
 
+config GENERIC_LOCKBREAK
+        bool
+        default y
+        depends on SMP
+
 config RWSEM_XCHGADD_ALGORITHM
 	bool
 	default y
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -111,7 +111,7 @@ config GENERIC_IRQ_PROBE
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config RWSEM_GENERIC_SPINLOCK
 	bool
--- a/arch/blackfin/Kconfig
+++ b/arch/blackfin/Kconfig
@@ -17,6 +17,11 @@ config RWSEM_GENERIC_SPINLOCK
 config RWSEM_XCHGADD_ALGORITHM
 	def_bool n
 
+config GENERIC_LOCKBREAK
+        bool
+        default y
+        depends on SMP
+
 config BLACKFIN
 	def_bool y
 	select HAVE_FUNCTION_GRAPH_TRACER
--- a/arch/ia64/Kconfig
+++ b/arch/ia64/Kconfig
@@ -62,7 +62,7 @@ config IOMMU_HELPER
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config RWSEM_XCHGADD_ALGORITHM
 	bool
--- a/arch/m32r/Kconfig
+++ b/arch/m32r/Kconfig
@@ -243,7 +243,7 @@ config IRAM_SIZE
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config RWSEM_GENERIC_SPINLOCK
 	bool
--- a/arch/parisc/Kconfig
+++ b/arch/parisc/Kconfig
@@ -33,7 +33,7 @@ config STACK_GROWSUP
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config RWSEM_GENERIC_SPINLOCK
 	def_bool y
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -78,7 +78,7 @@ config RWSEM_XCHGADD_ALGORITHM
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config ARCH_HAS_ILOG2_U32
 	bool
--- a/arch/s390/Kconfig
+++ b/arch/s390/Kconfig
@@ -63,7 +63,7 @@ config NO_DMA
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config PGSTE
 	bool
--- a/arch/sh/Kconfig
+++ b/arch/sh/Kconfig
@@ -48,6 +48,11 @@ config RWSEM_GENERIC_SPINLOCK
 config RWSEM_XCHGADD_ALGORITHM
 	bool
 
+config GENERIC_LOCKBREAK
+        bool
+        default y
+        depends on SMP
+
 config GENERIC_BUG
 	def_bool y
 	depends on BUG && SUPERH32
@@ -98,7 +103,7 @@ config GENERIC_CMOS_UPDATE
 
 config GENERIC_LOCKBREAK
 	def_bool y
-	depends on SMP && PREEMPT
+	depends on SMP
 
 config SYS_SUPPORTS_PM
 	bool
--- a/arch/sparc/Kconfig
+++ b/arch/sparc/Kconfig
@@ -306,7 +306,7 @@ config US3_MC
 config GENERIC_LOCKBREAK
 	bool
 	default y
-	depends on SPARC64 && SMP && PREEMPT
+	depends on SMP
 
 choice
 	prompt "SPARC64 Huge TLB Page Size"
