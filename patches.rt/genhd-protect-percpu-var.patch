Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
Protect use of smp_processor_id in genhd.h with preempt disable.

Signed-off-by: Steven Rostedt <srostedt@redhat.com>
---
 include/linux/genhd.h |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

Index: linux-2.6.26.3-rt6/include/linux/genhd.h
===================================================================
--- linux-2.6.26.3-rt6.orig/include/linux/genhd.h	2008-09-05 00:23:07.000000000 -0400
+++ linux-2.6.26.3-rt6/include/linux/genhd.h	2008-09-05 00:23:47.000000000 -0400
@@ -190,7 +190,11 @@ static inline void disk_stat_set_all(str
 }		
 
 #define __part_stat_add(part, field, addnd)				\
-	(per_cpu_ptr(part->dkstats, smp_processor_id())->field += addnd)
+do {									\
+	preempt_disable();						\
+	(per_cpu_ptr(part->dkstats, smp_processor_id())->field += addnd); \
+	preempt_enable();						\
+} while (0)
 
 #define __all_stat_add(gendiskp, part, field, addnd, sector)	\
 ({								\
