Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
---
 arch/x86/kernel/io_apic_64.c |    9 +++++++++
 1 file changed, 9 insertions(+)

Index: linux-2.6.26.3-rt6/arch/x86/kernel/io_apic_64.c
===================================================================
--- linux-2.6.26.3-rt6.orig/arch/x86/kernel/io_apic_64.c	2008-09-05 00:23:15.000000000 -0400
+++ linux-2.6.26.3-rt6/arch/x86/kernel/io_apic_64.c	2008-09-05 00:23:44.000000000 -0400
@@ -1519,6 +1519,15 @@ static void ack_apic_level(unsigned int 
 			move_masked_irq(irq);
 		unmask_IO_APIC_irq(irq);
 	}
+#if (defined(CONFIG_GENERIC_PENDING_IRQ) || defined(CONFIG_IRQBALANCE)) && \
+	defined(CONFIG_PREEMPT_HARDIRQS)
+	/*
+	 * With threaded interrupts, we always have IRQ_INPROGRESS
+	 * when acking.
+	 */
+	else if (unlikely(irq_desc[irq].status & IRQ_MOVE_PENDING))
+		move_masked_irq(irq);
+#endif
 }
 
 static struct irq_chip ioapic_chip __read_mostly = {
