Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
diff --git a/include/linux/ftrace.h b/include/linux/ftrace.h
index 702cf7b..89e72c7 100644
--- a/include/linux/ftrace.h
+++ b/include/linux/ftrace.h
@@ -38,6 +38,9 @@ extern void ftrace_stub(unsigned long a0, unsigned long a1);
 void ftrace_enable(void);
 void ftrace_disable(void);
 
+extern void ftrace_disable_daemon(void);
+extern void ftrace_enable_daemon(void);
+
 /* totally disable ftrace - can not re-enable after this */
 void ftrace_kill(void);
 void __ftrace_kill(void);
@@ -51,6 +54,10 @@ void ftrace_kill_atomic(void);
 # define ftrace_kill()				do { } while (0)
 # define __ftrace_kill()			do { } while (0)
 # define ftrace_kill_atomic()			do { } while (0)
+# define ftrace_enable()			do { } while (0)
+# define ftrace_disable()			do { } while (0)
+# define ftrace_enable_daemon()			do { } while (0)
+# define ftrace_disable_daemon()		do { } while (0)
 #endif /* CONFIG_FTRACE */
 
 #ifdef CONFIG_DYNAMIC_FTRACE
diff --git a/include/linux/tracepoint.h b/include/linux/tracepoint.h
index e623a6f..142f787 100644
--- a/include/linux/tracepoint.h
+++ b/include/linux/tracepoint.h
@@ -40,14 +40,14 @@ struct tracepoint {
 	do {								\
 		void **it_func;						\
 									\
-		rcu_read_lock_sched();					\
+		preempt_disable();					\
 		it_func = rcu_dereference((tp)->funcs);			\
 		if (it_func) {						\
 			do {						\
 				((void(*)(proto))(*it_func))(args);	\
 			} while (*(++it_func));				\
 		}							\
-		rcu_read_unlock_sched();				\
+		preempt_enable();				\
 	} while (0)
 
 /*
diff --git a/init/main.c b/init/main.c
index 8347fba..48c24cd 100644
--- a/init/main.c
+++ b/init/main.c
@@ -45,6 +45,7 @@
 #include <linux/interrupt.h>
 #include <linux/taskstats_kern.h>
 #include <linux/delayacct.h>
+#include <linux/ftrace.h>
 #include <linux/unistd.h>
 #include <linux/rmap.h>
 #include <linux/irq.h>
