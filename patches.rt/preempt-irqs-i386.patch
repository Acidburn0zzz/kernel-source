Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Tony Jones <tonyj@suse.de>
---
 arch/x86/kernel/i8259.c       |    1 +
 arch/x86/kernel/io_apic_32.c  |   22 +++++-----------------
 arch/x86/kernel/irqinit_32.c  |    1 +
 arch/x86/mach-default/setup.c |    3 ++-
 arch/x86/mach-voyager/setup.c |    3 ++-
 5 files changed, 11 insertions(+), 19 deletions(-)

Index: linux-2.6.27-RT/arch/x86/kernel/i8259.c
===================================================================
--- linux-2.6.27-RT.orig/arch/x86/kernel/i8259.c
+++ linux-2.6.27-RT/arch/x86/kernel/i8259.c
@@ -329,6 +329,7 @@ void init_8259A(int auto_eoi)
 	/* 8259A-1 (the master) has a slave on IR2 */
 	outb_pic(1U << PIC_CASCADE_IR, PIC_MASTER_IMR);
 
+	/* XXX preempt_rt originally was using outb_p() -checking on that */
 	if (auto_eoi)	/* master does Auto EOI */
 		outb_pic(MASTER_ICW4_DEFAULT | PIC_ICW4_AEOI, PIC_MASTER_IMR);
 	else		/* master expects normal EOI */
Index: linux-2.6.27-RT/arch/x86/kernel/io_apic_32.c
===================================================================
--- linux-2.6.27-RT.orig/arch/x86/kernel/io_apic_32.c
+++ linux-2.6.27-RT/arch/x86/kernel/io_apic_32.c
@@ -281,20 +281,6 @@ static void __unmask_IO_APIC_irq(unsigne
 	__modify_IO_APIC_irq(irq, 0, IO_APIC_REDIR_MASKED);
 }
 
-/* mask = 1, trigger = 0 */
-static void __mask_and_edge_IO_APIC_irq(unsigned int irq)
-{
-	__modify_IO_APIC_irq(irq, IO_APIC_REDIR_MASKED,
-				IO_APIC_REDIR_LEVEL_TRIGGER);
-}
-
-/* mask = 0, trigger = 1 */
-static void __unmask_and_level_IO_APIC_irq(unsigned int irq)
-{
-	__modify_IO_APIC_irq(irq, IO_APIC_REDIR_LEVEL_TRIGGER,
-				IO_APIC_REDIR_MASKED);
-}
-
 static void mask_IO_APIC_irq(unsigned int irq)
 {
 	unsigned long flags;
@@ -1464,7 +1450,7 @@ void __init print_IO_APIC(void)
 	return;
 }
 
-#if 0
+#if 1
 
 static void print_APIC_bitfield(int base)
 {
@@ -1964,8 +1950,10 @@ static void ack_ioapic_quirk_irq(unsigne
 	if (!(v & (1 << (i & 0x1f)))) {
 		atomic_inc(&irq_mis_count);
 		spin_lock(&ioapic_lock);
-		__mask_and_edge_IO_APIC_irq(irq);
-		__unmask_and_level_IO_APIC_irq(irq);
+		/* mask = 1, trigger = 0 */
+		__modify_IO_APIC_irq(irq, 0x00010000, 0x00008000);
+		/* mask = 0, trigger = 1 */
+		__modify_IO_APIC_irq(irq, 0x00008000, 0x00010000);
 		spin_unlock(&ioapic_lock);
 	}
 }
Index: linux-2.6.27-RT/arch/x86/kernel/irqinit_32.c
===================================================================
--- linux-2.6.27-RT.orig/arch/x86/kernel/irqinit_32.c
+++ linux-2.6.27-RT/arch/x86/kernel/irqinit_32.c
@@ -52,6 +52,7 @@ static irqreturn_t math_error_irq(int cp
  */
 static struct irqaction fpu_irq = {
 	.handler = math_error_irq,
+	.flags = IRQF_NODELAY,
 	.mask = CPU_MASK_NONE,
 	.name = "fpu",
 };
Index: linux-2.6.27-RT/arch/x86/mach-default/setup.c
===================================================================
--- linux-2.6.27-RT.orig/arch/x86/mach-default/setup.c
+++ linux-2.6.27-RT/arch/x86/mach-default/setup.c
@@ -41,6 +41,7 @@ void __init pre_intr_init_hook(void)
  */
 static struct irqaction irq2 = {
 	.handler = no_action,
+	.flags = IRQF_NODELAY,
 	.mask = CPU_MASK_NONE,
 	.name = "cascade",
 };
@@ -97,7 +98,7 @@ void __init trap_init_hook(void)
 
 static struct irqaction irq0  = {
 	.handler = timer_interrupt,
-	.flags = IRQF_DISABLED | IRQF_NOBALANCING | IRQF_IRQPOLL,
+	.flags = IRQF_DISABLED | IRQF_NOBALANCING | IRQF_IRQPOLL | IRQF_NODELAY,
 	.mask = CPU_MASK_NONE,
 	.name = "timer"
 };
Index: linux-2.6.27-RT/arch/x86/mach-voyager/setup.c
===================================================================
--- linux-2.6.27-RT.orig/arch/x86/mach-voyager/setup.c
+++ linux-2.6.27-RT/arch/x86/mach-voyager/setup.c
@@ -20,6 +20,7 @@ void __init pre_intr_init_hook(void)
  */
 static struct irqaction irq2 = {
 	.handler = no_action,
+	.flags = IRQF_NODELAY,
 	.mask = CPU_MASK_NONE,
 	.name = "cascade",
 };
@@ -46,7 +47,7 @@ void __init trap_init_hook(void)
 
 static struct irqaction irq0 = {
 	.handler = timer_interrupt,
-	.flags = IRQF_DISABLED | IRQF_NOBALANCING | IRQF_IRQPOLL,
+	.flags = IRQF_DISABLED | IRQF_NOBALANCING | IRQF_IRQPOLL | IRQF_NODELAY,
 	.mask = CPU_MASK_NONE,
 	.name = "timer"
 };
