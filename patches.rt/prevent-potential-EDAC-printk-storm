Subject: [Rtibm-dev] [PATCH 3/3] Prevent potential EDAC printk storm
From: "Timothy R. Chavez" <tim.chavez@linux.vnet.ibm.com>
Date: Fri, 16 May 2008 14:34:15 -0500
Organization: IBM

Rate-limit EDAC system messages to avoid crippling the system with a 
printk storm.

Signed-off-by: Keith Mannthey <kmannth@us.ibm.com>
Signed-off-by: Timothy R. Chavez <tim.chavez@linux.vnet.ibm.com>

Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>

Index: linux-2.6.22/drivers/edac/amd76x_edac.c
===================================================================
--- linux-2.6.22.orig/drivers/edac/amd76x_edac.c	2008-05-15 22:50:04.000000000 +0000
+++ linux-2.6.22/drivers/edac/amd76x_edac.c	2008-05-15 22:52:35.000000000 +0000
@@ -23,10 +23,12 @@
 #define EDAC_MOD_STR	"amd76x_edac"
 
 #define amd76x_printk(level, fmt, arg...) \
-	edac_printk(level, "amd76x", fmt, ##arg)
+	if (printk_ratelimit()) \
+		edac_printk(level, "amd76x", fmt, ##arg)
 
 #define amd76x_mc_printk(mci, level, fmt, arg...) \
-	edac_mc_chipset_printk(mci, level, "amd76x", fmt, ##arg)
+	if (printk_ratelimit()) \
+		edac_mc_chipset_printk(mci, level, "amd76x", fmt, ##arg)
 
 #define AMD76X_NR_CSROWS 8
 #define AMD76X_NR_CHANS  1
Index: linux-2.6.22/drivers/edac/i5000_edac.c
===================================================================
--- linux-2.6.22.orig/drivers/edac/i5000_edac.c	2008-05-15 22:46:24.000000000 +0000
+++ linux-2.6.22/drivers/edac/i5000_edac.c	2008-05-15 22:52:35.000000000 +0000
@@ -31,10 +31,12 @@
 #define EDAC_MOD_STR      "i5000_edac"
 
 #define i5000_printk(level, fmt, arg...) \
-        edac_printk(level, "i5000", fmt, ##arg)
+	if (printk_ratelimit())	\
+        	edac_printk(level, "i5000", fmt, ##arg)
 
 #define i5000_mc_printk(mci, level, fmt, arg...) \
-        edac_mc_chipset_printk(mci, level, "i5000", fmt, ##arg)
+	if (printk_ratelimit()) \
+	        edac_mc_chipset_printk(mci, level, "i5000", fmt, ##arg)
 
 #ifndef PCI_DEVICE_ID_INTEL_FBD_0
 #define PCI_DEVICE_ID_INTEL_FBD_0	0x25F5


