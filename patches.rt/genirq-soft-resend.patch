Subject: Linux-RT 2.6.24-rc2-rt1
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
Subject: x86: activate HARDIRQS_SW_RESEND
From: Ingo Molnar <mingo@elte.hu>

activate the software-triggered IRQ-resend logic.

it appears some chipsets/cpus do not handle local-APIC driven IRQ
resends all that well, so always use the soft mechanism to trigger
the execution of pending interrupts.

Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 arch/x86/Kconfig.i386   |    4 ++++
 arch/x86/Kconfig.x86_64 |    4 ++++
 kernel/irq/manage.c     |    8 ++++++++
 3 files changed, 16 insertions(+)

Index: linux-2.6.24-rc2-rt1/arch/x86/Kconfig.i386
===================================================================
--- linux-2.6.24-rc2-rt1.orig/arch/x86/Kconfig.i386
+++ linux-2.6.24-rc2-rt1/arch/x86/Kconfig.i386
@@ -1304,6 +1304,10 @@ config GENERIC_PENDING_IRQ
 	depends on GENERIC_HARDIRQS && SMP
 	default y
 
+config HARDIRQS_SW_RESEND
+	bool
+	default y
+
 config X86_SMP
 	bool
 	depends on SMP && !X86_VOYAGER
Index: linux-2.6.24-rc2-rt1/arch/x86/Kconfig.x86_64
===================================================================
--- linux-2.6.24-rc2-rt1.orig/arch/x86/Kconfig.x86_64
+++ linux-2.6.24-rc2-rt1/arch/x86/Kconfig.x86_64
@@ -709,6 +709,10 @@ config GENERIC_PENDING_IRQ
 	depends on GENERIC_HARDIRQS && SMP
 	default y
 
+config HARDIRQS_SW_RESEND
+	bool
+	default y
+
 menu "Power management options"
 
 source kernel/power/Kconfig
Index: linux-2.6.24-rc2-rt1/kernel/irq/manage.c
===================================================================
--- linux-2.6.24-rc2-rt1.orig/kernel/irq/manage.c
+++ linux-2.6.24-rc2-rt1/kernel/irq/manage.c
@@ -191,6 +191,14 @@ void enable_irq(unsigned int irq)
 		desc->depth--;
 	}
 	spin_unlock_irqrestore(&desc->lock, flags);
+#ifdef CONFIG_HARDIRQS_SW_RESEND
+	/*
+	 * Do a bh disable/enable pair to trigger any pending
+	 * irq resend logic:
+	 */
+	local_bh_disable();
+	local_bh_enable();
+#endif
 }
 EXPORT_SYMBOL(enable_irq);
 
