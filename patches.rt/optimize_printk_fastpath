From ghaskins@novell.com Wed Feb 13 16:37:43 2008
Return-path: <ghaskins@novell.com>
Received: from adonis.novell.com (adonis.provo.novell.com [130.57.1.97]) by
	sinclair.provo.novell.com with ESMTP; Wed, 13 Feb 2008 16:37:43 -0700
Received: from novell1.haskins.net (75-130-111-13.dhcp.oxfr.ma.charter.com
	[75.130.111.13]) by adonis.novell.com (TMA SMTPRS 4.4.568.30) with ESMTP id
	<C0131301071@adonis.novell.com>; Wed, 13 Feb 2008 16:37:38 -0700
Received-SPF: none (adonis.novell.com: domain of ghaskins@novell.com does
	not designate any permitted senders)
X-IADB2: None
X-Bonded-Senders: None
X-Habeas: None
X-Cloudmark-Rating: 0 <127.0.50.0>
X-IDDB: None
X-Modus-ReverseDNS: OK
X-Modus-BlackList: 75.130.111.13=OK;ghaskins@novell.com=OK
X-Modus-RBL: 75.130.111.13=OK
X-Modus-Trusted: 75.130.111.13=NO
X-Modus-Audit: FALSE;0;0;0
Received: from novell1.haskins.net (localhost [127.0.0.1]) by
	novell1.haskins.net (Postfix) with ESMTP id B630C3FC1D7; Wed, 13 Feb 2008
	18:11:23 -0500 (EST)
From: Gregory Haskins <ghaskins@novell.com>
Subject: [PATCH 7/9] optimize the !printk fastpath through the lock
	acquisition
To: pmorreale@novell.com, sdietrich@novell.com
Cc: ghaskins@novell.com
Date: Wed, 13 Feb 2008 18:11:23 -0500
Message-ID: <20080213231123.4771.38571.stgit@novell1.haskins.net>
In-Reply-To: <20080213230912.4771.22530.stgit@novell1.haskins.net>
References: <20080213230912.4771.22530.stgit@novell1.haskins.net>
User-Agent: StGIT/0.12.1
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
X-Evolution-Source: imap://sdietrich@prv1-3.novell.com/
Content-Transfer-Encoding: 8bit

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---

 kernel/rtmutex.c |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/kernel/rtmutex.c b/kernel/rtmutex.c
index 10215f9..3ada393 100644
--- a/kernel/rtmutex.c
+++ b/kernel/rtmutex.c
@@ -652,12 +652,12 @@ rt_spin_lock_fastlock(struct rt_mutex *lock,
 		void fastcall (*slowfn)(struct rt_mutex *lock))
 {
 	/* Temporary HACK! */
-	if (!current->in_printk)
-		might_sleep();
-	else if (in_atomic() || irqs_disabled())
+	if (unlikely(current->in_printk) && (in_atomic() || irqs_disabled()))
 		/* don't grab locks for printk in atomic */
 		return;
 
+	might_sleep();
+
 	if (likely(rt_mutex_cmpxchg(lock, NULL, current)))
 		rt_mutex_deadlock_account_lock(lock, current);
 	else
@@ -669,7 +669,7 @@ rt_spin_lock_fastunlock(struct rt_mutex *lock,
 			void fastcall (*slowfn)(struct rt_mutex *lock))
 {
 	/* Temporary HACK! */
-	if (current->in_printk && (in_atomic() || irqs_disabled()))
+	if (unlikely(current->in_printk) && (in_atomic() || irqs_disabled()))
 		/* don't grab locks for printk in atomic */
 		return;
 

