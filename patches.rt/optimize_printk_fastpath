From slert-devel-bounces+sdietrich=novell.com@suse.de Fri Feb 15 18:53:11 2008
Return-path: <slert-devel-bounces+sdietrich=novell.com@suse.de>
Received: from Relay1.suse.de ([149.44.160.87]) by emea5-mh.id5.novell.com
	with ESMTP (TLS encrypted); Fri, 15 Feb 2008 18:53:11 +0100
Received: from Fourier.suse.de (fourier.suse.de [149.44.160.40]) by
	Relay1.suse.de (Postfix) with ESMTP id 73F5F1C052B1 for
	<sdietrich@novell.com>; Fri, 15 Feb 2008 18:53:11 +0100 (CET)
Received: from fourier.suse.de (localhost [127.0.0.1]) by Fourier.suse.de
	(Postfix) with ESMTP id 6BAC71E42792 for <sdietrich@novell.com>; Fri, 15
	Feb 2008 18:53:11 +0100 (CET)
Received: from Relay1.suse.de (relay1.suse.de [149.44.160.87]) by
	Fourier.suse.de (Postfix) with ESMTP id 5A42D1E4278D for
	<slert-devel@mailman.suse.de>; Fri, 15 Feb 2008 18:53:10 +0100 (CET)
Received: by Relay1.suse.de (Postfix) id 57DBE1C052A8; Fri, 15 Feb 2008
	18:53:10 +0100 (CET)
Received: from relay1.suse.de (localhost [127.0.0.1]) by Relay1.suse.de
	(Postfix) with ESMTP id 4CB621C052A7 for <slert-devel@suse.de>; Fri, 15 Feb
	2008 18:53:10 +0100 (CET)
X-Virus-Scanned: by amavisd-new at relay1.suse.de
X-Spam-Score: -2.499
X-Spam-Level: 
X-Spam-Status: No, score=-2.499 tagged_above=-20 required=5
	tests=[BAYES_00=-2.599, RDNS_DYNAMIC=0.1]
Received: from mx2.suse.de ([195.135.220.15]) by relay1.suse.de
	(relay1.suse.de [149.44.160.87]) (amavisd-new, port 10025) with ESMTP id
	wC9E-v96yfET for <slert-devel@suse.de>; Fri, 15 Feb 2008 18:53:04 +0100
	(CET)
Received: from novell1.haskins.net (75-130-111-13.dhcp.oxfr.ma.charter.com
	[75.130.111.13]) by mx2.suse.de (Postfix) with ESMTP id 74A4D35456 for
	<slert-devel@suse.de>; Fri, 15 Feb 2008 18:53:04 +0100 (CET)
Received: from novell1.haskins.net (localhost [127.0.0.1]) by
	novell1.haskins.net (Postfix) with ESMTP id 11C6D3FC1DB for
	<slert-devel@suse.de>; Fri, 15 Feb 2008 12:26:16 -0500 (EST)
From: Gregory Haskins <ghaskins@novell.com>
To: slert-devel@suse.de
Date: Fri, 15 Feb 2008 12:26:16 -0500
Message-ID: <20080215172615.25573.12222.stgit@novell1.haskins.net>
In-Reply-To: <20080215172421.25573.85164.stgit@novell1.haskins.net>
References: <20080215172421.25573.85164.stgit@novell1.haskins.net>
User-Agent: StGIT/0.12.1
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Subject: [slert-devel] [PATCH 08/10] optimize the !printk fastpath through
	the lock acquisition
X-BeenThere: slert-devel@suse.de
X-Mailman-Version: 2.1.4
Precedence: list
List-Id: All things slert <slert-devel.suse.de>
List-Unsubscribe: <https://mailman.suse.de/mailman/listinfo/slert-devel>,
	<mailto:slert-devel-request@suse.de?subject=unsubscribe>
List-Archive: <https://mailman.suse.de/mailman/private/slert-devel>
List-Post: <mailto:slert-devel@suse.de>
List-Help: <mailto:slert-devel-request@suse.de?subject=help>
List-Subscribe: <https://mailman.suse.de/mailman/listinfo/slert-devel>,
	<mailto:slert-devel-request@suse.de?subject=subscribe>
Sender: slert-devel-bounces+sdietrich=novell.com@suse.de
Errors-To: slert-devel-bounces+sdietrich=novell.com@suse.de
X-Evolution-Source: imap://sdietrich@prv1-3.novell.com/
Content-Transfer-Encoding: 8bit

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---

 kernel/rtmutex.c |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/kernel/rtmutex.c b/kernel/rtmutex.c
index 10215f9..3ada393 100644
--- a/kernel/rtmutex.c
+++ b/kernel/rtmutex.c
@@ -652,12 +652,12 @@ rt_spin_lock_fastlock(struct rt_mutex *lock,
 		void fastcall (*slowfn)(struct rt_mutex *lock))
 {
 	/* Temporary HACK! */
-	if (!current->in_printk)
-		might_sleep();
-	else if (in_atomic() || irqs_disabled())
+	if (unlikely(current->in_printk) && (in_atomic() || irqs_disabled()))
 		/* don't grab locks for printk in atomic */
 		return;
 
+	might_sleep();
+
 	if (likely(rt_mutex_cmpxchg(lock, NULL, current)))
 		rt_mutex_deadlock_account_lock(lock, current);
 	else
@@ -669,7 +669,7 @@ rt_spin_lock_fastunlock(struct rt_mutex *lock,
 			void fastcall (*slowfn)(struct rt_mutex *lock))
 {
 	/* Temporary HACK! */
-	if (current->in_printk && (in_atomic() || irqs_disabled()))
+	if (unlikely(current->in_printk) && (in_atomic() || irqs_disabled()))
 		/* don't grab locks for printk in atomic */
 		return;
 

