From: jbeulich@novell.com
Subject: fix intel-agp address handling
Patch-mainline: obsolete
References: 254208

---
 drivers/char/agp/intel-agp.c |   10 ++++++++++
 1 file changed, 10 insertions(+)

--- a/drivers/char/agp/intel-agp.c	2007-08-27 14:01:24.000000000 -0400
+++ b/drivers/char/agp/intel-agp.c	2007-08-27 14:01:27.000000000 -0400
@@ -208,6 +208,13 @@ static void *i8xx_alloc_pages(void)
 	if (page == NULL)
 		return NULL;
 
+#ifdef CONFIG_XEN
+	if (xen_create_contiguous_region((unsigned long)page_address(page), 2, 32)) {
+		__free_pages(page, 2);
+		return NULL;
+	}
+#endif
+
 	if (change_page_attr(page, 4, PAGE_KERNEL_NOCACHE) < 0) {
 		change_page_attr(page, 4, PAGE_KERNEL);
 		global_flush_tlb();
@@ -231,6 +238,9 @@ static void i8xx_destroy_pages(void *add
 	page = virt_to_page(addr);
 	change_page_attr(page, 4, PAGE_KERNEL);
 	global_flush_tlb();
+#ifdef CONFIG_XEN
+	xen_destroy_contiguous_region((unsigned long)page_address(page), 2);
+#endif
 	put_page(page);
 	unlock_page(page);
 	__free_pages(page, 2);
