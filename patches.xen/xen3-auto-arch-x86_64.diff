Subject: xen3 arch-x86_64
From: kraxel@suse.de

autogenerated from http://xenbits.xensource.com/ext/linux-2.6-merge.hg (tip 15332)

Index: linux-2.6.15/arch/x86_64/Makefile
===================================================================
--- linux-2.6.15.orig/arch/x86_64/Makefile
+++ linux-2.6.15/arch/x86_64/Makefile
@@ -56,23 +56,39 @@ CFLAGS += $(call cc-option,-mno-sse -mno
 
 AFLAGS += -m64
 
-head-y := arch/x86_64/kernel/head.o arch/x86_64/kernel/head64.o arch/x86_64/kernel/init_task.o
+ifndef CONFIG_XEN
+archdir := x86_64
+else
+archdir := x86_64/xen
+arch/x86_64/kernel/vmlinux.lds: arch/x86_64/kernel/vmlinux.lds.S
+CPPFLAGS := -D__KERNEL__ -Iinclude$(if $(KBUILD_SRC),2)/asm/mach-xen $(LINUXINCLUDE)
+LDFLAGS_vmlinux := -e _start
+endif
+
+head-y := arch/$(archdir)/kernel/head.o arch/$(archdir)/kernel/head64.o arch/$(archdir)/kernel/init_task.o
+
+libs-y 					+= arch/$(archdir)/lib/
+core-y					+= arch/$(archdir)/kernel/ \
+					   arch/$(archdir)/mm/ \
+					   arch/$(archdir)/crypto/
+core-$(CONFIG_IA32_EMULATION)		+= arch/$(archdir)/ia32/
+drivers-$(CONFIG_PCI)			+= arch/$(archdir)/pci/
+drivers-$(CONFIG_OPROFILE)		+= arch/$(archdir)/oprofile/
+drivers-$(CONFIG_KDB)			+= arch/$(archdir)/kdb/
 
-libs-y 					+= arch/x86_64/lib/
-core-y					+= arch/x86_64/kernel/ \
-					   arch/x86_64/mm/ \
-					   arch/x86_64/crypto/
-core-$(CONFIG_IA32_EMULATION)		+= arch/x86_64/ia32/
-drivers-$(CONFIG_PCI)			+= arch/x86_64/pci/
-drivers-$(CONFIG_OPROFILE)		+= arch/x86_64/oprofile/
-drivers-$(CONFIG_KDB)			+= arch/x86_64/kdb/
-
-boot := arch/x86_64/boot
+boot := arch/$(archdir)/boot
 
 .PHONY: bzImage bzlilo install archmrproper \
 	fdimage fdimage144 fdimage288 archclean
 
 #Default target when executing "make"
+ifdef CONFIG_XEN
+all: vmlinuz
+
+vmlinuz: vmlinux
+	$(Q)$(MAKE) $(build)=$(boot) $@
+
+else
 all: bzImage
 
 BOOTIMAGE                     := arch/x86_64/boot/bzImage
@@ -89,6 +105,7 @@ bzdisk: vmlinux
 
 fdimage fdimage144 fdimage288: vmlinux
 	$(Q)$(MAKE) $(build)=$(boot) BOOTIMAGE=$(BOOTIMAGE) $@
+endif
 
 install:
 	$(Q)$(MAKE) $(build)=$(boot) BOOTIMAGE=$(BOOTIMAGE) $@ 
Index: linux-2.6.15/arch/x86_64/ia32/Makefile
===================================================================
--- linux-2.6.15.orig/arch/x86_64/ia32/Makefile
+++ linux-2.6.15/arch/x86_64/ia32/Makefile
@@ -27,5 +27,5 @@ $(obj)/vsyscall-sysenter.so $(obj)/vsysc
 $(obj)/vsyscall-%.so: $(src)/vsyscall.lds $(obj)/vsyscall-%.o FORCE
 	$(call if_changed,syscall)
 
-AFLAGS_vsyscall-sysenter.o = -m32
-AFLAGS_vsyscall-syscall.o = -m32
+AFLAGS_vsyscall-sysenter.o = -m32 -Iarch/i386/kernel
+AFLAGS_vsyscall-syscall.o = -m32 -Iarch/i386/kernel
Index: linux-2.6.15/arch/x86_64/ia32/vsyscall-sigreturn.S
===================================================================
--- linux-2.6.15.orig/arch/x86_64/ia32/vsyscall-sigreturn.S
+++ linux-2.6.15/arch/x86_64/ia32/vsyscall-sigreturn.S
@@ -120,5 +120,5 @@ __kernel_rt_sigreturn:
 	.align 4
 .LENDFDE3:
 
-#include "../../i386/kernel/vsyscall-note.S"
+#include <vsyscall-note.S>
 
