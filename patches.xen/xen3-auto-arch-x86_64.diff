Subject: xen3 arch-x86_64
From: jbeulich@novell.com

autogenerated from http://xenbits.xensource.com/xen-unstable.hg (tip 8819)

Index: head-2006-02-13/arch/x86_64/ia32/Makefile
===================================================================
--- head-2006-02-13.orig/arch/x86_64/ia32/Makefile	2006-02-13 11:38:07.000000000 +0100
+++ head-2006-02-13/arch/x86_64/ia32/Makefile	2006-02-13 14:54:53.000000000 +0100
@@ -23,9 +23,25 @@ quiet_cmd_syscall = SYSCALL $@
 			   -Wl,-soname=linux-gate.so.1 -o $@ \
 			   -Wl,-T,$(filter-out FORCE,$^)
 
+$(obj)/vsyscall-int80.so \
 $(obj)/vsyscall-sysenter.so $(obj)/vsyscall-syscall.so: \
 $(obj)/vsyscall-%.so: $(src)/vsyscall.lds $(obj)/vsyscall-%.o FORCE
 	$(call if_changed,syscall)
 
-AFLAGS_vsyscall-sysenter.o = -m32
-AFLAGS_vsyscall-syscall.o = -m32
+AFLAGS_vsyscall-sysenter.o = -m32 -Iarch/i386/kernel
+AFLAGS_vsyscall-syscall.o = -m32 -Iarch/i386/kernel
+
+ifdef CONFIG_XEN
+AFLAGS_vsyscall-int80.o = -m32 -Iarch/i386/kernel
+CFLAGS_syscall32-xen.o += -DUSE_INT80
+AFLAGS_syscall32_syscall-xen.o += -DUSE_INT80
+
+$(obj)/syscall32_syscall-xen.o: \
+	$(foreach F,int80 sysenter syscall,$(obj)/vsyscall-$F.so)
+
+targets := $(foreach F,int80 sysenter syscall,vsyscall-$F.o vsyscall-$F.so)
+
+include $(srctree)/scripts/Makefile.xen
+
+obj-y := $(call cherrypickxen, $(obj-y))
+endif
Index: head-2006-02-13/arch/x86_64/ia32/vsyscall-sigreturn.S
===================================================================
--- head-2006-02-13.orig/arch/x86_64/ia32/vsyscall-sigreturn.S	2006-02-13 11:38:07.000000000 +0100
+++ head-2006-02-13/arch/x86_64/ia32/vsyscall-sigreturn.S	2006-02-13 14:54:53.000000000 +0100
@@ -120,5 +120,5 @@ __kernel_rt_sigreturn:
 	.align 4
 .LENDFDE3:
 
-#include "../../i386/kernel/vsyscall-note.S"
+#include <vsyscall-note.S>
 
Index: head-2006-02-13/arch/x86_64/kernel/acpi/Makefile
===================================================================
--- head-2006-02-13.orig/arch/x86_64/kernel/acpi/Makefile	2006-02-13 11:24:59.000000000 +0100
+++ head-2006-02-13/arch/x86_64/kernel/acpi/Makefile	2006-02-13 14:54:53.000000000 +0100
@@ -6,3 +6,4 @@ ifneq ($(CONFIG_ACPI_PROCESSOR),)
 obj-y			+= processor.o
 endif
 
+boot-$(CONFIG_XEN)		:= ../../../i386/kernel/acpi/boot-xen.o
Index: head-2006-02-13/arch/x86_64/kernel/Makefile
===================================================================
--- head-2006-02-13.orig/arch/x86_64/kernel/Makefile	2006-02-13 11:24:17.000000000 +0100
+++ head-2006-02-13/arch/x86_64/kernel/Makefile	2006-02-13 14:54:53.000000000 +0100
@@ -20,11 +20,13 @@ obj-$(CONFIG_MICROCODE)		+= microcode.o
 obj-$(CONFIG_X86_CPUID)		+= cpuid.o
 obj-$(CONFIG_SMP)		+= smp.o smpboot.o trampoline.o
 obj-$(CONFIG_X86_LOCAL_APIC)	+= apic.o  nmi.o
+obj-$(CONFIG_X86_XEN_GENAPIC)	+= genapic.o genapic_xen.o
 obj-$(CONFIG_X86_IO_APIC)	+= io_apic.o mpparse.o \
 		genapic.o genapic_cluster.o genapic_flat.o
 obj-$(CONFIG_KEXEC)		+= machine_kexec.o relocate_kernel.o crash.o
 obj-$(CONFIG_CRASH_DUMP)	+= crash_dump.o
-obj-$(CONFIG_PM)		+= suspend.o
+obj-$(CONFIG_SOFTWARE_SUSPEND)	+= suspend.o
+obj-$(CONFIG_ACPI_SLEEP)	+= suspend.o
 obj-$(CONFIG_SOFTWARE_SUSPEND)	+= suspend_asm.o
 obj-$(CONFIG_CPU_FREQ)		+= cpufreq/
 obj-$(CONFIG_EARLY_PRINTK)	+= early_printk.o
@@ -51,3 +53,17 @@ i8237-y				+= ../../i386/kernel/i8237.o
 msr-$(subst m,y,$(CONFIG_X86_MSR))  += ../../i386/kernel/msr.o
 dmi_scan-y			+= ../../i386/kernel/dmi_scan.o
 
+ifdef CONFIG_XEN
+time-y				+= ../../i386/kernel/time-xen.o
+pci-dma-y			+= ../../i386/kernel/pci-dma-xen.o
+microcode-$(subst m,y,$(CONFIG_MICROCODE))  := ../../i386/kernel/microcode-xen.o
+quirks-y			:= ../../i386/kernel/quirks-xen.o
+
+n-obj-xen := i8259.o reboot.o i8237.o smpboot.o trampoline.o
+
+include $(srctree)/scripts/Makefile.xen
+
+obj-y := $(call filterxen, $(obj-y), $(n-obj-xen))
+obj-y := $(call cherrypickxen, $(obj-y))
+extra-y := $(call cherrypickxen, $(extra-y))
+endif
Index: head-2006-02-13/arch/x86_64/Makefile
===================================================================
--- head-2006-02-13.orig/arch/x86_64/Makefile	2006-02-13 11:38:07.000000000 +0100
+++ head-2006-02-13/arch/x86_64/Makefile	2006-02-13 14:54:53.000000000 +0100
@@ -75,6 +75,21 @@ boot := arch/x86_64/boot
 .PHONY: bzImage bzlilo install archmrproper \
 	fdimage fdimage144 fdimage288 archclean
 
+ifdef CONFIG_XEN
+CPPFLAGS := -D__KERNEL__ -Iinclude$(if $(KBUILD_SRC),2)/asm/mach-xen $(LINUXINCLUDE)
+head-y := arch/x86_64/kernel/head-xen.o arch/x86_64/kernel/head64-xen.o arch/x86_64/kernel/init_task.o
+LDFLAGS_vmlinux := -e _start
+boot := arch/i386/boot-xen
+.PHONY: vmlinuz
+#Default target when executing "make"
+all: vmlinuz
+
+vmlinuz: vmlinux
+	$(Q)$(MAKE) $(build)=$(boot) $@
+
+install: vmlinux
+	$(Q)$(MAKE) $(build)=$(boot) XENGUEST=$(XENGUEST) $@
+else
 #Default target when executing "make"
 all: bzImage
 
@@ -95,6 +110,7 @@ fdimage fdimage144 fdimage288: vmlinux
 
 install:
 	$(Q)$(MAKE) $(build)=$(boot) BOOTIMAGE=$(BOOTIMAGE) $@ 
+endif
 
 archclean:
 	$(Q)$(MAKE) $(clean)=$(boot)
Index: head-2006-02-13/arch/x86_64/mm/Makefile
===================================================================
--- head-2006-02-13.orig/arch/x86_64/mm/Makefile	2006-02-13 11:24:17.000000000 +0100
+++ head-2006-02-13/arch/x86_64/mm/Makefile	2006-02-13 14:54:53.000000000 +0100
@@ -9,3 +9,13 @@ obj-$(CONFIG_K8_NUMA) += k8topology.o
 obj-$(CONFIG_ACPI_NUMA) += srat.o
 
 hugetlbpage-y = ../../i386/mm/hugetlbpage.o
+
+ifdef CONFIG_XEN
+include $(srctree)/scripts/Makefile.xen
+
+ioremap-y	+= ../../i386/mm/ioremap-xen.o
+hypervisor-y	+= ../../i386/mm/hypervisor.o
+obj-y		+= hypervisor.o
+
+obj-y := $(call cherrypickxen, $(obj-y))
+endif
Index: head-2006-02-13/arch/x86_64/pci/Makefile
===================================================================
--- head-2006-02-13.orig/arch/x86_64/pci/Makefile	2006-01-03 04:21:10.000000000 +0100
+++ head-2006-02-13/arch/x86_64/pci/Makefile	2006-02-13 14:54:53.000000000 +0100
@@ -22,3 +22,11 @@ irq-y    += ../../i386/pci/irq.o
 common-y += ../../i386/pci/common.o
 fixup-y  += ../../i386/pci/fixup.o
 i386-y  += ../../i386/pci/i386.o
+
+ifdef CONFIG_XEN
+irq-y		:= ../../i386/pci/irq-xen.o
+i386-y		:= ../../i386/pci/i386.o
+include $(srctree)/scripts/Makefile.xen
+
+obj-y := $(call cherrypickxen, $(obj-y))
+endif
