Subject: xen3 arch-x86_64
From: kraxel@suse.de

autogenerated from http://xenbits.xensource.com/ext/linux-2.6-merge.hg (tip 15332)

--- vanilla-2.6.15-rc4/arch/x86_64/Makefile	2005-10-28 02:02:08.000000000 +0200
+++ xen-hg15332/arch/x86_64/Makefile	2005-11-29 11:06:00.000000000 +0100
@@ -50,22 +50,40 @@ CFLAGS += $(call cc-option,-funit-at-a-t
 # prevent gcc from generating any FP code by mistake
 CFLAGS += $(call cc-option,-mno-sse -mno-mmx -mno-sse2 -mno-3dnow,)
 
-head-y := arch/x86_64/kernel/head.o arch/x86_64/kernel/head64.o arch/x86_64/kernel/init_task.o
+ifndef CONFIG_XEN
+archdir := x86_64
+else
+archdir := x86_64/xen
+arch/x86_64/kernel/vmlinux.lds: arch/x86_64/kernel/vmlinux.lds.S
+CPPFLAGS := -D__KERNEL__ -Iinclude$(if $(KBUILD_SRC),2)/asm/mach-xen $(LINUXINCLUDE)
+LDFLAGS_vmlinux := -e _start
+endif
+
+head-y := arch/$(archdir)/kernel/head.o arch/$(archdir)/kernel/head64.o arch/$(archdir)/kernel/init_task.o
 
 libs-y 					+= arch/x86_64/lib/
-core-y					+= arch/x86_64/kernel/ \
-					   arch/x86_64/mm/ \
+core-y					+= arch/$(archdir)/kernel/ \
+					   arch/$(archdir)/mm/ \
 					   arch/x86_64/crypto/
-core-$(CONFIG_IA32_EMULATION)		+= arch/x86_64/ia32/
-drivers-$(CONFIG_PCI)			+= arch/x86_64/pci/
+core-$(CONFIG_IA32_EMULATION)		+= arch/$(archdir)/ia32/
+drivers-$(CONFIG_PCI)			+= arch/$(archdir)/pci/
 drivers-$(CONFIG_OPROFILE)		+= arch/x86_64/oprofile/
 
-boot := arch/x86_64/boot
+boot := arch/$(archdir)/boot
 
 .PHONY: bzImage bzlilo install archmrproper \
 	fdimage fdimage144 fdimage288 archclean
 
 #Default target when executing "make"
+ifdef CONFIG_XEN
+all: vmlinuz
+
+vmlinuz: vmlinux
+	$(Q)$(MAKE) $(build)=$(boot) $@
+
+install: vmlinuz
+	$(Q)$(MAKE) $(build)=$(boot) BOOTIMAGE=$(BOOTIMAGE) $@
+else
 all: bzImage
 
 BOOTIMAGE                     := arch/x86_64/boot/bzImage
@@ -82,6 +100,7 @@ bzdisk: vmlinux
 
 install fdimage fdimage144 fdimage288: vmlinux
 	$(Q)$(MAKE) $(build)=$(boot) BOOTIMAGE=$(BOOTIMAGE) $@
+endif
 
 archclean:
 	$(Q)$(MAKE) $(clean)=$(boot)
--- vanilla-2.6.15-rc4/arch/x86_64/ia32/Makefile	2005-10-28 02:02:08.000000000 +0200
+++ xen-hg15332/arch/x86_64/ia32/Makefile	2005-11-15 16:19:10.000000000 +0100
@@ -27,6 +27,6 @@ $(obj)/vsyscall-sysenter.so $(obj)/vsysc
 $(obj)/vsyscall-%.so: $(src)/vsyscall.lds $(obj)/vsyscall-%.o FORCE
 	$(call if_changed,syscall)
 
-AFLAGS_vsyscall-sysenter.o = -m32
-AFLAGS_vsyscall-syscall.o = -m32
+AFLAGS_vsyscall-sysenter.o = -m32 -Iarch/i386/kernel
+AFLAGS_vsyscall-syscall.o = -m32 -Iarch/i386/kernel
 CFLAGS_ia32_ioctl.o += -Ifs/
--- vanilla-2.6.15-rc4/arch/x86_64/ia32/vsyscall-sigreturn.S	2005-10-28 02:02:08.000000000 +0200
+++ xen-hg15332/arch/x86_64/ia32/vsyscall-sigreturn.S	2005-11-15 16:19:10.000000000 +0100
@@ -119,5 +119,5 @@ __kernel_rt_sigreturn:
 	.align 4
 .LENDFDE3:
 
-#include "../../i386/kernel/vsyscall-note.S"
+#include <vsyscall-note.S>
 
