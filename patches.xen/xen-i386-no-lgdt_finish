# HG changeset 8927+8928 patch
# User Ian.Campbell@xensource.com, cl349@firebug.cl.cam.ac.uk
# Node ID ed274ca1fbb7b0b0a5c1b8733962e5831835928c
# Parent  32a74fa9e221fa6e60ec150fab8e74d7a4494f04
From: Ian Campbell <Ian.Campbell@XenSource.com>
From: Christian Limpach <Christian.Limpach@cl.cam.ac.uk>
Subject: Don't reload segment registers -- it's done later in generic code.

Signed-off-by: Ian Campbell <Ian.Campbell@XenSource.com>
Signed-off-by: Christian Limpach <Christian.Limpach@cl.cam.ac.uk>
Acked-by: Jan Beulich <jbeulich@novell.com>

Index: head-2006-03-02/arch/i386/kernel/cpu/common-xen.c
===================================================================
--- head-2006-03-02.orig/arch/i386/kernel/cpu/common-xen.c	2006-03-02 11:08:47.000000000 +0100
+++ head-2006-03-02/arch/i386/kernel/cpu/common-xen.c	2006-03-02 11:23:38.000000000 +0100
@@ -587,7 +587,6 @@ void __cpuinit cpu_gdt_init(struct Xgt_d
 	}
 	if (HYPERVISOR_set_gdt(frames, gdt_descr->size / 8))
 		BUG();
-	lgdt_finish();
 }
 
 /*
Index: head-2006-03-02/arch/i386/kernel/head-xen.S
===================================================================
--- head-2006-03-02.orig/arch/i386/kernel/head-xen.S	2006-03-02 11:23:27.000000000 +0100
+++ head-2006-03-02/arch/i386/kernel/head-xen.S	2006-03-02 11:24:01.000000000 +0100
@@ -76,19 +76,6 @@ L6:
 	jmp L6			# main should never return here, but
 				# just in case, we know what happens.
 
-ENTRY(lgdt_finish)
-	movl $(__KERNEL_DS),%eax	# reload all the segment registers
-	movw %ax,%ss			# after changing gdt.
-
-	movl $(__USER_DS),%eax		# DS/ES contains default USER segment
-	movw %ax,%ds
-	movw %ax,%es
-
-	popl %eax			# reload CS by intersegment return
-	pushl $(__KERNEL_CS)
-	pushl %eax
-	lret
-
 #define HYPERCALL_PAGE_OFFSET 0x1000
 .org HYPERCALL_PAGE_OFFSET
 ENTRY(hypercall_page)
Index: head-2006-03-02/include/asm-i386/mach-xen/asm/hypervisor.h
===================================================================
--- head-2006-03-02.orig/include/asm-i386/mach-xen/asm/hypervisor.h	2006-03-02 11:08:47.000000000 +0100
+++ head-2006-03-02/include/asm-i386/mach-xen/asm/hypervisor.h	2006-03-02 11:23:38.000000000 +0100
@@ -61,9 +61,6 @@ void xen_cpu_idle (void);
 /* arch/xen/i386/kernel/hypervisor.c */
 void do_hypervisor_callback(struct pt_regs *regs);
 
-/* arch/xen/i386/kernel/head.S */
-void lgdt_finish(void);
-
 /* arch/xen/i386/mm/hypervisor.c */
 /*
  * NB. ptr values should be PHYSICAL, not MACHINE. 'vals' should be already
