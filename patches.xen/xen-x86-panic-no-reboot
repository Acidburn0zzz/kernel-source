From: jbeulich@novell.com
Subject: Don't automatically reboot Dom0 on panic (match native)
Patch-mainline: obsolete

$subject says it all.

Index: head-2008-04-02/arch/x86/kernel/setup_32-xen.c
===================================================================
--- head-2008-04-02.orig/arch/x86/kernel/setup_32-xen.c	2008-04-02 15:13:11.000000000 +0200
+++ head-2008-04-02/arch/x86/kernel/setup_32-xen.c	2008-04-02 15:18:59.000000000 +0200
@@ -743,11 +743,13 @@ void __init setup_arch(char **cmdline_p)
 
 	/* Force a quick death if the kernel panics (not domain 0). */
 	extern int panic_timeout;
-	if (!panic_timeout && !is_initial_xendomain())
-		panic_timeout = 1;
+	if (!is_initial_xendomain()) {
+		if (!panic_timeout)
+			panic_timeout = 1;
 
-	/* Register a call for panic conditions. */
-	atomic_notifier_chain_register(&panic_notifier_list, &xen_panic_block);
+		/* Register a call for panic conditions. */
+		atomic_notifier_chain_register(&panic_notifier_list, &xen_panic_block);
+	}
 
 	WARN_ON(HYPERVISOR_vm_assist(VMASST_CMD_enable,
 				     VMASST_TYPE_4gb_segments));
Index: head-2008-04-02/arch/x86/kernel/setup_64-xen.c
===================================================================
--- head-2008-04-02.orig/arch/x86/kernel/setup_64-xen.c	2008-04-02 15:08:41.000000000 +0200
+++ head-2008-04-02/arch/x86/kernel/setup_64-xen.c	2008-04-02 15:18:59.000000000 +0200
@@ -323,9 +323,6 @@ void __init setup_arch(char **cmdline_p)
 
 	printk(KERN_INFO "Command line: %s\n", boot_command_line);
 
-	/* Register a call for panic conditions. */
-	atomic_notifier_chain_register(&panic_notifier_list, &xen_panic_block);
-
 	WARN_ON(HYPERVISOR_vm_assist(VMASST_CMD_enable,
 				     VMASST_TYPE_writable_pagetables));
 
@@ -343,9 +340,13 @@ void __init setup_arch(char **cmdline_p)
 		                      xen_start_info->console.dom0.info_size);
 		xen_start_info->console.domU.mfn = 0;
 		xen_start_info->console.domU.evtchn = 0;
-	} else
+	} else {
 		screen_info.orig_video_isVGA = 0;
 
+		/* Register a call for panic conditions. */
+		atomic_notifier_chain_register(&panic_notifier_list, &xen_panic_block);
+	}
+
 	copy_edid();
 #else
 	printk(KERN_INFO "Command line: %s\n", boot_command_line);
