From: jbeulich@novell.com
Subject: Don't automatically reboot on panic (match native)
Patch-mainline: obsolete

$subject says it all.

Index: head-2006-10-04/arch/i386/kernel/setup-xen.c
===================================================================
--- head-2006-10-04.orig/arch/i386/kernel/setup-xen.c	2006-10-05 13:22:32.000000000 +0200
+++ head-2006-10-04/arch/i386/kernel/setup-xen.c	2006-10-05 13:23:00.000000000 +0200
@@ -73,11 +73,6 @@
 /* Forward Declaration. */
 void __init find_max_pfn(void);
 
-static int xen_panic_event(struct notifier_block *, unsigned long, void *);
-static struct notifier_block xen_panic_block = {
-	xen_panic_event, NULL, 0 /* try to go last */
-};
-
 extern char hypercall_page[PAGE_SIZE];
 EXPORT_SYMBOL(hypercall_page);
 
@@ -1566,14 +1561,6 @@ void __init setup_arch(char **cmdline_p)
 	struct physdev_set_iopl set_iopl;
 	unsigned long max_low_pfn;
 
-	/* Force a quick death if the kernel panics (not domain 0). */
-	extern int panic_timeout;
-	if (!panic_timeout && !is_initial_xendomain())
-		panic_timeout = 1;
-
-	/* Register a call for panic conditions. */
-	notifier_chain_register(&panic_notifier_list, &xen_panic_block);
-
 	HYPERVISOR_vm_assist(VMASST_CMD_enable, VMASST_TYPE_4gb_segments);
 	HYPERVISOR_vm_assist(VMASST_CMD_enable,
 			     VMASST_TYPE_writable_pagetables);
@@ -1834,14 +1821,6 @@ static __init int add_pcspkr(void)
 }
 device_initcall(add_pcspkr);
 
-static int
-xen_panic_event(struct notifier_block *this, unsigned long event, void *ptr)
-{
-	HYPERVISOR_shutdown(SHUTDOWN_crash);
-	/* we're never actually going to get here... */
-	return NOTIFY_DONE;
-}
-
 /*
  * Local Variables:
  * mode:c
Index: head-2006-10-04/arch/x86_64/kernel/setup-xen.c
===================================================================
--- head-2006-10-04.orig/arch/x86_64/kernel/setup-xen.c	2006-10-04 10:17:55.000000000 +0200
+++ head-2006-10-04/arch/x86_64/kernel/setup-xen.c	2006-10-04 10:25:34.000000000 +0200
@@ -89,11 +89,6 @@ EXPORT_SYMBOL(hypercall_page);
 /* Allows setting of maximum possible memory size  */
 unsigned long xen_override_max_pfn;
 
-static int xen_panic_event(struct notifier_block *, unsigned long, void *);
-static struct notifier_block xen_panic_block = {
-	xen_panic_event, NULL, 0 /* try to go last */
-};
-
 unsigned long *phys_to_machine_mapping;
 unsigned long *pfn_to_mfn_frame_list_list, *pfn_to_mfn_frame_list[512];
 
@@ -578,9 +573,6 @@ static void discover_ebda(void)
 void __init setup_arch(char **cmdline_p)
 {
 #ifdef CONFIG_XEN
-	/* Register a call for panic conditions. */
-	notifier_chain_register(&panic_notifier_list, &xen_panic_block);
-
  	ROOT_DEV = MKDEV(RAMDISK_MAJOR,0); 
  	screen_info = SCREEN_INFO;
 
@@ -941,16 +933,6 @@ void __init setup_arch(char **cmdline_p)
 #endif /* !CONFIG_XEN */
 }
 
-#ifdef CONFIG_XEN
-static int
-xen_panic_event(struct notifier_block *this, unsigned long event, void *ptr)
-{
-	HYPERVISOR_shutdown(SHUTDOWN_crash);
-	/* we're never actually going to get here... */
-	return NOTIFY_DONE;
-}
-#endif /* !CONFIG_XEN */
-
 
 static int __cpuinit get_model_name(struct cpuinfo_x86 *c)
 {
