From: garloff@suse.de
Subject: Adapt arch/xen to suse-specific used_math changes

Necessary adjustments for patches.fixes/used_math (andrea):
Convert the unsafe signed (16bit) used_math to a safe and optimal PF_USED_MATH

diff -uNrp linux-2.6.10/arch/xen/i386/kernel/cpu/common.c linux-2.6.10.math/arch/xen/i386/kernel/cpu/common.c
--- linux-2.6.10/arch/xen/i386/kernel/cpu/common.c	2005-01-20 20:38:15.311762429 +0100
+++ linux-2.6.10.math/arch/xen/i386/kernel/cpu/common.c	2005-01-20 20:42:02.453350202 +0100
@@ -601,6 +601,6 @@ void __init cpu_init (void)
 	 * Force FPU initialization:
 	 */
 	current_thread_info()->status = 0;
-	current->used_math = 0;
+	clear_used_math();
 	mxcsr_feature_mask_init();
 }
diff -uNrp linux-2.6.10/arch/xen/i386/kernel/process.c linux-2.6.10.math/arch/xen/i386/kernel/process.c
--- linux-2.6.10/arch/xen/i386/kernel/process.c	2005-01-20 20:38:15.320759402 +0100
+++ linux-2.6.10.math/arch/xen/i386/kernel/process.c	2005-01-20 20:44:00.912499682 +0100
@@ -237,7 +237,7 @@ void flush_thread(void)
 	 * Forget coprocessor state..
 	 */
 	clear_fpu(tsk);
-	tsk->used_math = 0;
+	clear_stopped_child_used_math(tsk);
 }
 
 void release_thread(struct task_struct *dead_task)
diff -uNrp linux-2.6.10/arch/xen/i386/kernel/traps.c linux-2.6.10.math/arch/xen/i386/kernel/traps.c
--- linux-2.6.10/arch/xen/i386/kernel/traps.c	2005-01-20 20:38:15.328756712 +0100
+++ linux-2.6.10.math/arch/xen/i386/kernel/traps.c	2005-01-20 20:44:57.387501097 +0100
@@ -911,7 +911,7 @@ asmlinkage void math_state_restore(struc
 		return;
 
 	clts();		/* Allow maths ops (or we recurse) */
-	if (!tsk->used_math)
+	if (!tsk_used_math(tsk))
 		init_fpu(tsk);
 	restore_fpu(tsk);
 	thread->status |= TS_USEDFPU;	/* So we fnsave on switch_to() */
