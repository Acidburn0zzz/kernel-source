From: garloff@suse.de
Subject: Avoid disfunctional RTC drivers in unprivileged domain

When we just get 0xff back from our CMOS reads, we can assume that
there is no RTC or that we actually can't access it.

Signed-off-by: Kurt Garloff <garloff@suse.de>

--- linux-2.6.11/drivers/char/genrtc.c.orig	2005-03-02 08:38:26.000000000 +0100
+++ linux-2.6.11/drivers/char/genrtc.c	2005-03-08 10:40:15.000000000 +0100
@@ -504,6 +504,8 @@ static struct miscdevice rtc_gen_dev =
 static int __init rtc_generic_init(void)
 {
 	int retval;
+	struct rtc_time tm;
+	unsigned int flags;
 
 	printk(KERN_INFO "Generic RTC Driver v%s\n", RTC_VERSION);
 
@@ -511,6 +513,15 @@ static int __init rtc_generic_init(void)
 	if (retval < 0)
 		return retval;
 
+	/* If we just read 0xff from the ioports, 
+	 * the RTC is disfunctional */
+	flags = get_rtc_time(&tm);
+	if (tm.tm_year == 165 || tm.tm_year == 255) {
+		printk(KERN_WARNING "genrtc: Got 0xff, disable\n");
+		misc_deregister(&rtc_gen_dev);
+		return -ENODEV;
+	}
+
 	retval = gen_rtc_proc_init();
 	if (retval) {
 		misc_deregister(&rtc_gen_dev);
--- linux-2.6.11/drivers/char/rtc.c.orig	2005-03-08 10:29:11.000000000 +0100
+++ linux-2.6.11/drivers/char/rtc.c	2005-03-08 10:36:27.000000000 +0100
@@ -967,6 +967,15 @@ no_irq:
 
 #endif /* __sparc__ vs. others */
 
+	/* If reads just return 0xff, the RTC is disfunctional */
+	if (CMOS_READ(RTC_YEAR) == 0xff) {
+		printk(KERN_WARNING "rtc: Got 0xff, disable\n");
+#ifdef RTC_IRQ
+		free_irq(RTC_IRQ, NULL);
+#endif
+		release_region(RTC_PORT(0), RTC_IO_EXTENT);
+		return -ENODEV;
+	}
 	if (misc_register(&rtc_dev)) {
 #ifdef RTC_IRQ
 		free_irq(RTC_IRQ, NULL);
