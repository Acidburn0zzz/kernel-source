From: Keir Fraser <keir@xensource.com>
Subject: Fix race in generic RCU code.

ChangeSet@1.1888, 2005-05-30 11:18:30+01:00, kaf24@firebug.cl.cam.ac.uk
  Fix Xen idle loop to enter/exit tickless mode in same way as s390,
  which interfaces properly with the RCU subsystem.

  This includes a patch that fixes a race in the generic RCU code: it
  was created by IBM for s390, and is being pushed upstream by them.

Signed-off-by: Keir Fraser <keir@xensource.com>
Acked-by: Kurt Garloff <garloff@suse.de>

Index: linux-2.6.11/kernel/rcupdate.c
===================================================================
--- linux-2.6.11.orig/kernel/rcupdate.c	2005-06-11 12:53:04.000000000 +0200
+++ linux-2.6.11/kernel/rcupdate.c	2005-06-11 17:26:26.000000000 +0200
@@ -242,8 +242,11 @@
  */
 static void cpu_quiet(int cpu, struct rcu_ctrlblk *rcp, struct rcu_state *rsp)
 {
+	cpumask_t mask;
+
 	cpu_clear(cpu, rsp->cpumask);
-	if (cpus_empty(rsp->cpumask)) {
+	cpus_andnot(mask, rsp->cpumask, nohz_cpu_mask);
+	if (cpus_empty(mask)) {
 		/* batch completed ! */
 		rcp->completed = rcp->cur;
 		rcu_start_batch(rcp, rsp, 0);
