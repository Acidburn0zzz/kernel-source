Subject: xen3 TCP/UDP checksumming
From: http://xenbits.xensource.com/xen-3.1-testing.hg (tip 15042)
Acked-by: jbeulich@novell.com

This is only a guess, based on suggestions from Keir Fraser.

Index: head-2007-05-31/net/ipv4/netfilter/nf_nat_proto_tcp.c
===================================================================
--- head-2007-05-31.orig/net/ipv4/netfilter/nf_nat_proto_tcp.c	2007-04-26 05:08:32.000000000 +0200
+++ head-2007-05-31/net/ipv4/netfilter/nf_nat_proto_tcp.c	2007-05-31 13:46:50.000000000 +0200
@@ -132,6 +132,9 @@ tcp_manip_pkt(struct sk_buff **pskb,
 	if (hdrsize < sizeof(*hdr))
 		return 1;
 
+	if (skb_checksum_setup(*pskb))
+		return 0;
+
 	nf_proto_csum_replace4(&hdr->check, *pskb, oldip, newip, 1);
 	nf_proto_csum_replace2(&hdr->check, *pskb, oldport, newport, 0);
 	return 1;
Index: head-2007-05-31/net/ipv4/netfilter/nf_nat_proto_udp.c
===================================================================
--- head-2007-05-31.orig/net/ipv4/netfilter/nf_nat_proto_udp.c	2007-04-26 05:08:32.000000000 +0200
+++ head-2007-05-31/net/ipv4/netfilter/nf_nat_proto_udp.c	2007-05-31 13:48:11.000000000 +0200
@@ -116,6 +116,10 @@ udp_manip_pkt(struct sk_buff **pskb,
 		newport = tuple->dst.u.udp.port;
 		portptr = &hdr->dest;
 	}
+
+	if (skb_checksum_setup(*pskb))
+		return 0;
+
 	if (hdr->check || (*pskb)->ip_summed == CHECKSUM_PARTIAL) {
 		nf_proto_csum_replace4(&hdr->check, *pskb, oldip, newip, 1);
 		nf_proto_csum_replace2(&hdr->check, *pskb, *portptr, newport,
Index: head-2007-05-31/net/ipv4/xfrm4_output.c
===================================================================
--- head-2007-05-31.orig/net/ipv4/xfrm4_output.c	2007-05-31 13:45:11.000000000 +0200
+++ head-2007-05-31/net/ipv4/xfrm4_output.c	2007-05-31 13:46:50.000000000 +0200
@@ -47,6 +47,10 @@ static int xfrm4_output_one(struct sk_bu
 	struct xfrm_state *x = dst->xfrm;
 	int err;
 
+	err = skb_checksum_setup(skb);
+	if (err)
+		goto error_nolock;
+
 	if (skb->ip_summed == CHECKSUM_PARTIAL) {
 		err = skb_checksum_help(skb);
 		if (err)
