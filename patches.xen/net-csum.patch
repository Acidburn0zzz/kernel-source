Subject: xen3 TCP/UDP checksumming
From: http://xenbits.xensource.com/xen-unstable.hg (tip 13816)
Acked-by: jbeulich@novell.com

This is only a guess, based on suggestions from Keir Fraser.

---
 net/ipv4/netfilter/ip_nat_proto_tcp.c |    3 +++
 net/ipv4/netfilter/ip_nat_proto_udp.c |    3 +++
 net/ipv4/xfrm4_output.c               |    4 ++++
 3 files changed, 10 insertions(+)

--- linux-2.6.20.orig/net/ipv4/netfilter/ip_nat_proto_tcp.c
+++ linux-2.6.20/net/ipv4/netfilter/ip_nat_proto_tcp.c
@@ -134,6 +134,9 @@ tcp_manip_pkt(struct sk_buff **pskb,
 	if (hdrsize < sizeof(*hdr))
 		return 1;
 
+	if (skb_checksum_setup(*pskb))
+		return 0;
+
 	nf_proto_csum_replace4(&hdr->check, *pskb, oldip, newip, 1);
 	nf_proto_csum_replace2(&hdr->check, *pskb, oldport, newport, 0);
 	return 1;
--- linux-2.6.20.orig/net/ipv4/netfilter/ip_nat_proto_udp.c
+++ linux-2.6.20/net/ipv4/netfilter/ip_nat_proto_udp.c
@@ -119,6 +119,9 @@ udp_manip_pkt(struct sk_buff **pskb,
 		portptr = &hdr->dest;
 	}
 
+	if (skb_checksum_setup(*pskb))
+		return 0;
+
 	if (hdr->check || (*pskb)->ip_summed == CHECKSUM_PARTIAL) {
 		nf_proto_csum_replace4(&hdr->check, *pskb, oldip, newip, 1);
 		nf_proto_csum_replace2(&hdr->check, *pskb, *portptr, newport, 0);
--- linux-2.6.20.orig/net/ipv4/xfrm4_output.c
+++ linux-2.6.20/net/ipv4/xfrm4_output.c
@@ -48,6 +48,10 @@ static int xfrm4_output_one(struct sk_bu
 	struct xfrm_state *x = dst->xfrm;
 	int err;
 
+	err = skb_checksum_setup(skb);
+	if (err)
+		goto error_nolock;
+
 	if (skb->ip_summed == CHECKSUM_PARTIAL) {
 		err = skb_checksum_help(skb);
 		if (err)
