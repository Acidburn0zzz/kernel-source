From: Jiri Slaby <jslaby@suse.cz>
Subject: Linux 3.18.5
Patch-mainline: 3.18.5
Git-commit: 3e14dcf7cb80b34a1f38b55bc96f02d23fdaaaaf
Git-commit: 4943ba16bbc2db05115707b3ff7b4874e9e3c560
Git-commit: 5d26a105b5a73e5635eae0629b42fa0a90e07b7b
Git-commit: 175f8e2650f7ca6b33d338be3ccc1c00e89594ea
Git-commit: 7e2a38831db4cf082aa8b4997f3cbfe8cb03b669
Git-commit: dbdd74763f1faf799fbb9ed30423182e92919378
Git-commit: 3b05ac3824ed9648c0d9c02d51d9b54e4e7e874f
Git-commit: 8ca3f5e974f2b4b7f711589f4abff920db36637a
Git-commit: 62924af247e95de7041a6d6f2d06cdd05152e2dc
Git-commit: a2f18db0c68fec96631c10cad9384c196e9008ac
Git-commit: 9ea2aa8b7dba9e99544c4187cc298face254569f
Git-commit: 45f87de57f8fad59302fd263dd81ffa4843b5b24
Git-commit: a3a8784454692dd72e5d5d34dcdab17b4420e74c
Git-commit: 5c0b8e0de76a86edb99e46612fd9d341b4c4fa0a
Git-commit: 4aaa71873ddb9faf4b0c4826579e2f6d18ff9ab4
Git-commit: 38a1dfda8e77d7ba74c94d06d8bc41ba98a4bc8c
Git-commit: 3669ef9fa7d35f573ec9c0e0341b29251c2734a7
Git-commit: e30ab185c490e9a9381385529e0fd32f0a399495
Git-commit: 63ea0a49ae0b145b91ff2b070c01b66fc75854b9
Git-commit: f3747379accba8e95d70cec0eae0582c8c182050
Git-commit: f285f4a21c3253887caceed493089ece17579d59
Git-commit: 520452172e6b318f3a8bd9d4fe1e25066393de25
Git-commit: 32c6590d126836a062b3140ed52d898507987017
Git-commit: 8c38d28ba8da98f7102c31d35359b4dbe9d1f329
Git-commit: 4a0d3107d6b19125f21172c2b7d95f9c30ecaf6f
Git-commit: 91d1179212161f220938198b742c328ad38fd0a3
Git-commit: 378ff1a53b5724f3ac97b0aba3c9ecac072f6fcd
Git-commit: 38bdf45f4aa5cb6186d50a29e6cbbd9d486a1519
Git-commit: 8f1e8ee28660018a935c7576b9af8ffe1feab54c
Git-commit: 7ecd0bde5bfea524a843ad8fa8cb66ccbce68779
Git-commit: 5e5aeb4367b450a28f447f6d5ab57d8f2ab16a5f
Git-commit: 6ada1fc0e1c4775de0e043e1bd3ae9d065491aa5
Git-commit: 4b149e417463bbb6d1d9b805f729627ca2b54495
Git-commit: a59db67656021fa212e9b95a583f13c34eb67cd9
Git-commit: 9b1cc9f251affdd27f29fe46d0989ba76c33faf6
Git-commit: 6cf11ee6300f38b7cfc43af9b7be2afaa5e05869
Git-commit: 721f3223f26bbe81c7e55f84188e74d99df50a16
Git-commit: 6cdb08172bc89f0a39e1643c5e7eab362692fd1b
Git-commit: c3e59ee4e76686b0c84ca8faa1011d10cd4ca1b8
Git-commit: f331a859e0ee5a898c1f47596eddad4c4f02d657
Git-commit: 851b09369255a91e77f56d83e3643439ac5b209a
Git-commit: 0f7e7aee2f37119a32e6e8b63250922442528961
Git-commit: 8505e729a2f6eb0803ff943a15f133dd10afff3a
Git-commit: 3f2f4dc456e9f80849b99d79600a7257690ca4b1
Git-commit: d8a74e186949e1a2c2f1309212478b0659bf9225
Git-commit: 5615f890bc6babdc2998dec62f3552326d06eb7b
Git-commit: 4369a69ec6ab86821352bd753c68af5880f87956
Git-commit: 226e5ae9e5f9108beb0bde4ac69f68fe6210fed9
Git-commit: 48bf5b2d00bfeb681f6500c626189c7cd2c964d2
Git-commit: 1caf6aaaa47471831d77c75f094d4e00ad1ec808
Git-commit: 29187a9eeaf362d8422e62e17a22a6e115277a49
Git-commit: 6455931186bff407493135e74c5f32efd30860e2
Git-commit: ce7514526742c0898b837d4395f515b79dfb5a12
Git-commit: 72dd299d5039a336493993dcc63413cf31d0e662
Git-commit: b166010f6afbadb896efa37ff85eb681a8f89392
Git-commit: f29ae369a412942e81035984fa3d7a22ddf91fcb
Git-commit: 773328da243978bebac82bf4c45604281edb6975
Git-commit: db93facfb0ef542aa5d8079e47580b3e669a4d82
Git-commit: bcd53f858d87f52843cc87764b283999126a50d6
Git-commit: 6cfda7fbebe8a4fd33ea5722fa0212f98f643c35
Git-commit: 9b1087aa5e86448fe6ad40a58964e35f3ba423d5

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
Automatically created from "patches.kernel.org/patch-3.18.4-5" by xen-port-patches.py

diff --git a/arch/x86/include/mach-xen/asm/desc.h b/arch/x86/include/mach-xen/asm/desc.h
index 50d033a8947d..a94b82e8f156 100644
--- a/arch/x86/include/mach-xen/asm/desc.h
+++ b/arch/x86/include/mach-xen/asm/desc.h
@@ -251,7 +251,8 @@ static inline void native_load_tls(struct thread_struct *t, unsigned int cpu)
 }
 #endif
 
-#define _LDT_empty(info)				\
+/* This intentionally ignores lm, since 32-bit apps don't have that field. */
+#define LDT_empty(info)					\
 	((info)->base_addr		== 0	&&	\
 	 (info)->limit			== 0	&&	\
 	 (info)->contents		== 0	&&	\
@@ -261,11 +262,18 @@ static inline void native_load_tls(struct thread_struct *t, unsigned int cpu)
 	 (info)->seg_not_present	== 1	&&	\
 	 (info)->useable		== 0)
 
-#ifdef CONFIG_X86_64
-#define LDT_empty(info) (_LDT_empty(info) && ((info)->lm == 0))
-#else
-#define LDT_empty(info) (_LDT_empty(info))
-#endif
+/* Lots of programs expect an all-zero user_desc to mean "no segment at all". */
+static inline bool LDT_zero(const struct user_desc *info)
+{
+	return (info->base_addr		== 0 &&
+		info->limit		== 0 &&
+		info->contents		== 0 &&
+		info->read_exec_only	== 0 &&
+		info->seg_32bit		== 0 &&
+		info->limit_in_pages	== 0 &&
+		info->seg_not_present	== 0 &&
+		info->useable		== 0);
+}
 
 static inline void clear_LDT(void)
 {
