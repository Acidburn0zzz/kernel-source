From: jbeulich@novell.com
Subject: clear_fixmap() results in ill use of set_pte()
Patch-mainline: obsolete
References: 

Also prevent p2m translations in the context of clear_fixmap().

Index: head-2006-11-21/arch/i386/mm/pgtable-xen.c
===================================================================
--- head-2006-11-21.orig/arch/i386/mm/pgtable-xen.c	2006-11-21 10:47:18.000000000 +0100
+++ head-2006-11-21/arch/i386/mm/pgtable-xen.c	2006-11-21 10:47:30.000000000 +0100
@@ -101,8 +101,11 @@ static void set_pte_pfn(unsigned long va
 		return;
 	}
 	pte = pte_offset_kernel(pmd, vaddr);
-	/* <pfn,flags> stored as-is, to permit clearing entries */
-	set_pte(pte, pfn_pte(pfn, flags));
+	if (pgprot_val(flags))
+		/* <pfn,flags> stored as-is, to permit clearing entries */
+		set_pte(pte, pfn_pte(pfn, flags));
+	else
+		pte_clear(&init_mm, vaddr, pte);
 
 	/*
 	 * It's enough to flush this one mapping.
@@ -139,8 +142,11 @@ static void set_pte_pfn_ma(unsigned long
 		return;
 	}
 	pte = pte_offset_kernel(pmd, vaddr);
-	/* <pfn,flags> stored as-is, to permit clearing entries */
-	set_pte(pte, pfn_pte_ma(pfn, flags));
+	if (pgprot_val(flags))
+		/* <pfn,flags> stored as-is, to permit clearing entries */
+		set_pte(pte, pfn_pte_ma(pfn, flags));
+	else
+		pte_clear(&init_mm, vaddr, pte);
 
 	/*
 	 * It's enough to flush this one mapping.
Index: head-2006-11-21/arch/x86_64/mm/init-xen.c
===================================================================
--- head-2006-11-21.orig/arch/x86_64/mm/init-xen.c	2006-11-21 10:47:18.000000000 +0100
+++ head-2006-11-21/arch/x86_64/mm/init-xen.c	2006-11-21 10:47:30.000000000 +0100
@@ -265,7 +265,10 @@ static __init void set_pte_phys(unsigned
 			return;
 		}
 	}
-	new_pte = pfn_pte(phys >> PAGE_SHIFT, prot);
+	if (pgprot_val(prot))
+		new_pte = pfn_pte(phys >> PAGE_SHIFT, prot);
+	else
+		new_pte = __pte(0);
 
 	pte = pte_offset_kernel(pmd, vaddr);
 	if (!pte_none(*pte) &&
