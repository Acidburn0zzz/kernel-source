Subject: xen3 patch: rcu-nohz
From: kraxel

Copied from xen-unstable.hg/patches/linux-2.6.12

Signed-off-by: Gerd Knorr <kraxel@suse.de>
Index: linux-2.6.12/kernel/rcupdate.c
===================================================================
--- linux-2.6.12.orig/kernel/rcupdate.c
+++ linux-2.6.12/kernel/rcupdate.c
@@ -241,10 +241,13 @@ static void rcu_start_batch(struct rcu_c
  * cpu. Start another grace period if someone has further entries pending
  */
 static void cpu_quiet(int cpu, struct rcu_ctrlblk *rcp, struct rcu_state *rsp)
 {
+	cpumask_t mask;
+
 	cpu_clear(cpu, rsp->cpumask);
-	if (cpus_empty(rsp->cpumask)) {
+	cpus_andnot(mask, rsp->cpumask, nohz_cpu_mask);
+	if (cpus_empty(mask)) {
 		/* batch completed ! */
 		rcp->completed = rcp->cur;
 		rcu_start_batch(rcp, rsp, 0);
 	}
