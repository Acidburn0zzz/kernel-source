Subject: display last accessed sysfs file on kernel panic message
From: Andrew Morton <akpm@osdl.org>
Patch-mainline: never

Display the most-recently-opened sysfs file's name when oopsing.

From: Adrian Bunk <bunk@stusta.de>

  Build fix

From: Greg Kroah-Hartman <gregkh@suse.de>

  Modified to make the api call cleaner, and available to all arches if
  need be.  Also added it to x86-64's crash dump message.


Signed-off-by: Adrian Bunk <bunk@stusta.de>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
Automatically created from "patches.drivers/sysfs-crash-debugging.patch" by xen-port-patches.py

Index: head-2006-02-23/arch/i386/kernel/traps-xen.c
===================================================================
--- head-2006-02-23.orig/arch/i386/kernel/traps-xen.c	2006-02-24 12:38:30.000000000 +0100
+++ head-2006-02-23/arch/i386/kernel/traps-xen.c	2006-02-24 12:51:34.000000000 +0100
@@ -355,7 +355,8 @@ void die(const char * str, struct pt_reg
 #endif
 		if (nl)
 			printk("\n");
-	notify_die(DIE_OOPS, (char *)str, regs, err, 255, SIGSEGV);
+		sysfs_printk_last_file();
+		notify_die(DIE_OOPS, (char *)str, regs, err, 255, SIGSEGV);
 		show_registers(regs);
   	} else
 		printk(KERN_EMERG "Recursive die() failure, output suppressed\n");
Index: head-2006-02-23/arch/x86_64/kernel/traps-xen.c
===================================================================
--- head-2006-02-23.orig/arch/x86_64/kernel/traps-xen.c	2006-02-24 12:40:36.000000000 +0100
+++ head-2006-02-23/arch/x86_64/kernel/traps-xen.c	2006-02-24 12:51:34.000000000 +0100
@@ -428,6 +428,7 @@ void __kprobes __die(const char * str, s
 	printk("DEBUG_PAGEALLOC");
 #endif
 	printk("\n");
+	sysfs_printk_last_file();
 	notify_die(DIE_OOPS, str, regs, err, current->thread.trap_no, SIGSEGV);
 	show_registers(regs);
 	/* Executive summary in case the oops scrolled away */
