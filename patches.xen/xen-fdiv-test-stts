From: Vincent Hanquez <vincent@xensource.com>
Subject: FPU screwed up after fdiv test

The fdiv bug test is not properly wrapped in kernel_fpu_begin()
and _end(). Set TS, so it gets restored on a task switch.
Ths screwed FPU caused problems with RAID (checksumming) or caused
an app to fail with SIGFPE once.

Signed-off-by: Kurt Garloff <garloff@suse.de>

Index: linux-2.6.11/include/asm-i386/bugs.h
===================================================================
--- linux-2.6.11.orig/include/asm-i386/bugs.h	2005-03-02 08:37:49.000000000 +0100
+++ linux-2.6.11/include/asm-i386/bugs.h	2005-06-11 17:17:24.000000000 +0200
@@ -107,6 +107,7 @@
 		"fninit"
 		: "=m" (*&boot_cpu_data.fdiv_bug)
 		: "m" (*&x), "m" (*&y));
+	stts();
 	if (boot_cpu_data.fdiv_bug)
 		printk("Hmm, FPU with FDIV bug.\n");
 }
