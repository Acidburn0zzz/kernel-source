Subject: Fix xen blkfront initialization order.
From: kraxel@suse.de
References: 119407

First enter connect state, then register partitions, otherwise we'll
deadlock on the attempt to read the master boot record ...

Index: linux-2.6.15/drivers/xen/blkfront/blkfront.c
===================================================================
--- linux-2.6.15.orig/drivers/xen/blkfront/blkfront.c	2006-01-27 16:11:59.000000000 +0100
+++ linux-2.6.15/drivers/xen/blkfront/blkfront.c	2006-01-30 10:07:20.000000000 +0100
@@ -328,13 +328,12 @@ static void connect(struct blkfront_info
 		return;
 	}
 	
-        xlvbd_add(sectors, info->vdevice, binfo, sector_size, info);
-
+	info->connected = BLKIF_STATE_CONNECTED;
 	(void)xenbus_switch_state(info->xbdev, NULL, XenbusStateConnected); 
+	xlvbd_add(sectors, info->vdevice, binfo, sector_size, info);
 	
 	/* Kick pending requests. */
 	spin_lock_irq(&blkif_io_lock);
-	info->connected = BLKIF_STATE_CONNECTED;
 	kick_pending_request_queues(info);
 	spin_unlock_irq(&blkif_io_lock);
 }
