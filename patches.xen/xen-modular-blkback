Subject: Allow blkback to be built as a module
From: jbeulich@novell.com

Index: head-2006-03-02/drivers/xen/blkback/Makefile
===================================================================
--- head-2006-03-02.orig/drivers/xen/blkback/Makefile	2006-03-02 10:28:08.000000000 +0100
+++ head-2006-03-02/drivers/xen/blkback/Makefile	2006-03-02 11:26:34.000000000 +0100
@@ -1,2 +1,3 @@
+obj-$(CONFIG_XEN_BLKDEV_BACKEND) := blkbk.o
 
-obj-y	:= blkback.o xenbus.o interface.o vbd.o
+blkbk-y	:= blkback.o xenbus.o interface.o vbd.o
Index: head-2006-03-02/drivers/xen/blkback/blkback.c
===================================================================
--- head-2006-03-02.orig/drivers/xen/blkback/blkback.c	2006-03-02 10:28:08.000000000 +0100
+++ head-2006-03-02/drivers/xen/blkback/blkback.c	2006-03-02 11:26:34.000000000 +0100
@@ -29,14 +29,10 @@
  * 64 should be enough to keep us competitive with Linux.
  */
 static int blkif_reqs = 64;
-static int mmap_pages;
+module_param_named(reqs, blkif_reqs, int, 0);
+MODULE_PARM_DESC(reqs, "Number of blkback requests to allocate");
 
-static int __init set_blkif_reqs(char *str)
-{
-	get_option(&str, &blkif_reqs);
-	return 1;
-}
-__setup("blkif_reqs=", set_blkif_reqs);
+static int mmap_pages;
 
 /* Run-time switchable: /sys/module/blkback/parameters/ */
 static unsigned int log_stats = 0;
@@ -574,10 +570,20 @@ static int __init blkif_init(void)
 		list_add_tail(&pending_reqs[i].free_list, &pending_free);
     
 	blkif_xenbus_init();
+	__unsafe(THIS_MODULE);
 	return 0;
 }
 
-__initcall(blkif_init);
+module_init(blkif_init);
+
+static void blkif_exit(void)
+{
+	BUG();
+}
+
+module_exit(blkif_exit);
+
+MODULE_LICENSE("Dual BSD/GPL");
 
 /*
  * Local variables:
