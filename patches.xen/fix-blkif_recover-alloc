# HG changeset 8900 patch
# User vhanquez@kneesa.uk.xensource.com
# Node ID e9e319c61a1e62c499ebc3efa2a083b96121d46d
# Parent  011d6df7697987007205ff59e6d14de41cd47702
From: Vincent Hanquez <vincent@xensource.com>
Subject: do not BUG() if memory cannot be allocated, just wait.

Signed-off-by: Vincent Hanquez <vincent@xensource.com>
Acked-by: Jan Beulich <jbeulich@novell.com>

Index: head-2006-02-20/drivers/xen/blkfront/blkfront.c
===================================================================
--- head-2006-02-20.orig/drivers/xen/blkfront/blkfront.c	2006-02-21 09:20:32.000000000 +0100
+++ head-2006-02-20/drivers/xen/blkfront/blkfront.c	2006-02-20 18:14:19.000000000 +0100
@@ -726,8 +726,7 @@ static void blkif_recover(struct blkfron
 	int j;
 
 	/* Stage 1: Make a safe copy of the shadow state. */
-	copy = kmalloc(sizeof(info->shadow), GFP_KERNEL);
-	BUG_ON(copy == NULL);
+	copy = kmalloc(sizeof(info->shadow), GFP_KERNEL | __GFP_NOFAIL);
 	memcpy(copy, info->shadow, sizeof(info->shadow));
 
 	/* Stage 2: Set up free list. */
