Subject: bimodal: blkfront
Patch-mainline: obsolete

Create a new node "protocol" in xenstore, add the protocol name it speaks there.

Signed-off-by: Gerd Hoffmann <kraxel@suse.de>
---
 linux-2.6-xen-sparse/drivers/xen/blkfront/blkfront.c |    7 +++++++
 1 file changed, 7 insertions(+)

Index: head-2007-01-30/drivers/xen/blkfront/blkfront.c
===================================================================
--- head-2007-01-30.orig/drivers/xen/blkfront/blkfront.c	2007-01-31 16:58:36.000000000 +0100
+++ head-2007-01-30/drivers/xen/blkfront/blkfront.c	2007-01-31 17:01:16.000000000 +0100
@@ -44,6 +44,7 @@
 #include <xen/evtchn.h>
 #include <xen/xenbus.h>
 #include <xen/interface/grant_table.h>
+#include <xen/interface/io/protocols.h>
 #include <xen/gnttab.h>
 #include <asm/hypervisor.h>
 #include <asm/maddr.h>
@@ -180,6 +181,12 @@ again:
 		message = "writing event-channel";
 		goto abort_transaction;
 	}
+	err = xenbus_printf(xbt, dev->nodename, "protocol", "%s",
+			    XEN_IO_PROTO_ABI_NATIVE);
+	if (err) {
+		message = "writing protocol";
+		goto abort_transaction;
+	}
 
 	err = xenbus_transaction_end(xbt, 0);
 	if (err) {
