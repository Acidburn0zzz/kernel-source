From: sles8
Subject: change the start of mmap

x

Signed-off-by: Andrea Arcangeli <andrea@suse.de>

Automatically created from "patches.suse/mapped-base" by xen-port-patches.py

--- x/include/asm-xen/asm-i386/processor.h.orig	2005-01-04 01:13:27.000000000 +0100
+++ x/include/asm-xen/asm-i386/processor.h	2005-01-22 07:09:15.000000000 +0100
@@ -296,7 +296,8 @@ extern unsigned int mca_pentium_flag;
 /* This decides where the kernel will search for a free chunk of vm
  * space during mmap's.
  */
-#define TASK_UNMAPPED_BASE	(PAGE_ALIGN(TASK_SIZE / 3))
+#define TASK_UNMAPPED_BASE	(current->map_base)
+#define __TASK_UNMAPPED_BASE PAGE_ALIGN(TASK_SIZE/3)
 
 #define HAVE_ARCH_PICK_MMAP_LAYOUT
 
--- x/include/asm-xen/asm-x86_64/processor.h.orig	2005-01-04 01:13:29.000000000 +0100
+++ x/include/asm-xen/asm-x86_64/processor.h	2005-01-22 07:09:15.000000000 +0100
@@ -171,9 +171,14 @@ static inline void clear_in_cr4 (unsigne
 
 /* This decides where the kernel will search for a free chunk of vm
  * space during mmap's.
+ *
+ * /proc/pid/unmap_base is only supported for 32bit processes without
+ * 3GB personality for now.
  */
 #define IA32_PAGE_OFFSET ((current->personality & ADDR_LIMIT_3GB) ? 0xc0000000 : 0xFFFFe000)
-#define TASK_UNMAPPED_32 PAGE_ALIGN(IA32_PAGE_OFFSET/3)
+#define __TASK_UNMAPPED_BASE (PAGE_ALIGN(0xffffe000 / 3))
+#define TASK_UNMAPPED_32 ((current->personality & ADDR_LIMIT_3GB) ? \
+	PAGE_ALIGN(0xc0000000 / 3) : PAGE_ALIGN(current->map_base))
 #define TASK_UNMAPPED_64 PAGE_ALIGN(TASK_SIZE/3) 
 #define TASK_UNMAPPED_BASE	\
 	(test_thread_flag(TIF_IA32) ? TASK_UNMAPPED_32 : TASK_UNMAPPED_64)  
