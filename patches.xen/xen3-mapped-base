From: sles8
Subject: change the start of mmap

x

Signed-off-by: Andrea Arcangeli <andrea@suse.de>

Automatically created from "patches.suse/mapped-base" by xen-port-patches.py

Index: linux-2.6.12/include/asm-xen/asm-i386/processor.h
===================================================================
--- linux-2.6.12.orig/include/asm-xen/asm-i386/processor.h
+++ linux-2.6.12/include/asm-xen/asm-i386/processor.h
@@ -326,9 +326,10 @@ extern int bootloader_type;
 
 /* This decides where the kernel will search for a free chunk of vm
  * space during mmap's.
  */
-#define TASK_UNMAPPED_BASE	(PAGE_ALIGN(TASK_SIZE / 3))
+#define TASK_UNMAPPED_BASE	(current->map_base)
+#define __TASK_UNMAPPED_BASE PAGE_ALIGN(TASK_SIZE/3)
 
 #define HAVE_ARCH_PICK_MMAP_LAYOUT
 
 /*
Index: linux-2.6.12/include/asm-xen/asm-x86_64/processor.h
===================================================================
--- linux-2.6.12.orig/include/asm-xen/asm-x86_64/processor.h
+++ linux-2.6.12/include/asm-xen/asm-x86_64/processor.h
@@ -186,15 +186,20 @@ static inline void clear_in_cr4 (unsigne
 #define TASK_SIZE64	(0x800000000000UL - 4096)
 
 /* This decides where the kernel will search for a free chunk of vm
  * space during mmap's.
+ *
+ * /proc/pid/unmap_base is only supported for 32bit processes without
+ * 3GB personality for now.
  */
 #define IA32_PAGE_OFFSET ((current->personality & ADDR_LIMIT_3GB) ? 0xc0000000 : 0xFFFFe000)
 
 #define TASK_SIZE 		(test_thread_flag(TIF_IA32) ? IA32_PAGE_OFFSET : TASK_SIZE64)
 #define TASK_SIZE_OF(child) 	((test_tsk_thread_flag(child, TIF_IA32)) ? IA32_PAGE_OFFSET : TASK_SIZE64)
 
-#define TASK_UNMAPPED_BASE	PAGE_ALIGN(TASK_SIZE/3)
+#define __TASK_UNMAPPED_BASE (PAGE_ALIGN(0xffffe000 / 3))
+#define TASK_UNMAPPED_BASE ((current->personality & ADDR_LIMIT_3GB) ? \
+	PAGE_ALIGN(0xc0000000 / 3) : PAGE_ALIGN(current->map_base))
 
 /*
  * Size of io_bitmap.
  */
