# HG changeset 8830 patch
# User kaf24@firebug.cl.cam.ac.uk
# Node ID fcc833cbaf827327ad9e9348c93aaf7f99f0253f
# Parent  d6b16f57058a984ba903541d77927e07686659e9
From: Keir Fraser <keir@xensource.com>
Subject: Return real error code from Xen /dev/mem, not EAGAIN.

Signed-off-by: Keir Fraser <keir@xensource.com>
Acked-by: Jan Beulich <jbeulich@novell.com>

Index: head-2006-02-16/drivers/xen/char/mem.c
===================================================================
--- head-2006-02-16.orig/drivers/xen/char/mem.c	2006-02-16 17:06:52.000000000 +0100
+++ head-2006-02-16/drivers/xen/char/mem.c	2006-02-16 17:07:05.000000000 +0100
@@ -96,12 +96,9 @@ static int mmap_mem(struct file * file, 
 	if (uncached_access(file))
 		vma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);
 
-	if (direct_remap_pfn_range(vma, vma->vm_start, vma->vm_pgoff,
-				   size,
-				   vma->vm_page_prot, DOMID_IO))
-		return -EAGAIN;
-
-	return 0;
+	/* We want to return the real error code, not EAGAIN. */
+	return direct_remap_pfn_range(vma, vma->vm_start, vma->vm_pgoff,
+				      size, vma->vm_page_prot, DOMID_IO);
 }
 
 /*
