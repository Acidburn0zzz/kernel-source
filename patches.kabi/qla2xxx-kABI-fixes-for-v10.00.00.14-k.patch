From: Hannes Reinecke <hare@suse.de>
Date: Wed, 5 Jun 2019 15:47:50 +0200
Subject: [PATCH] qla2xxx: kABI fixes for v10.00.00.14-k
References: bsc#1136215
Patch-Mainline: never, SLE15 SP1 specific kABI fix.

That patch series breaks kABI, so fix it up.

Signed-off-by: Hannes Reinecke <hare@suse.com>
---
 drivers/scsi/qla2xxx/qla_def.h    | 26 ++++++++++++++++----------
 drivers/scsi/qla2xxx/qla_target.h |  6 ++++--
 2 files changed, 20 insertions(+), 12 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_def.h b/drivers/scsi/qla2xxx/qla_def.h
index c0f7593666a1..b14af4819290 100644
--- a/drivers/scsi/qla2xxx/qla_def.h
+++ b/drivers/scsi/qla2xxx/qla_def.h
@@ -1892,7 +1892,7 @@ struct crc_context {
 	dma_addr_t	crc_ctx_dma;
 	/* List of DMA context transfers */
 	struct list_head dsd_list;
-
+#ifndef __GENKSYMS__
 	/* List of DIF Bundling context DMA address */
 	struct list_head ldif_dsd_list;
 	u8 no_ldif_dsd;
@@ -1900,6 +1900,7 @@ struct crc_context {
 	struct list_head ldif_dma_hndl_list;
 	u32 dif_bundl_len;
 	u8 no_dif_bundl;
+#endif
 	/* This structure should not exceed 512 bytes */
 };
 
@@ -2369,7 +2370,6 @@ typedef struct fc_port {
 #define NVME_PRLI_SP_DISCOVERY  BIT_3
 #define NVME_PRLI_SP_FIRST_BURST	BIT_0
 	uint8_t nvme_flag;
-	uint32_t nvme_first_burst_size;
 #define NVME_FLAG_REGISTERED 4
 #define NVME_FLAG_DELETING 2
 #define NVME_FLAG_RESETTING 1
@@ -2438,6 +2438,9 @@ typedef struct fc_port {
 	u8 last_login_state;
 	u16 n2n_link_reset_cnt;
 	u16 n2n_chip_reset;
+#ifndef __GENKSYMS__
+	uint32_t nvme_first_burst_size;
+#endif
 } fc_port_t;
 
 #define QLA_FCPORT_SCAN		1
@@ -3705,7 +3708,6 @@ struct qla_hw_data {
 #define PORT_SPEED_32GB 0x06
 #define PORT_SPEED_10GB	0x13
 	uint16_t	link_data_rate;         /* F/W operating speed */
-	uint16_t	set_data_rate;		/* Set by user */
 
 	uint8_t		current_topology;
 	uint8_t		prev_topology;
@@ -4200,6 +4202,14 @@ struct qla_hw_data {
 	uint16_t min_link_speed;
 	uint16_t max_speed_sup;
 
+	atomic_t        nvme_active_aen_cnt;
+	uint16_t        nvme_last_rptd_aen;             /* Last recorded aen count */
+
+	atomic_t zio_threshold;
+	uint16_t last_zio_threshold;
+#define DEFAULT_ZIO_THRESHOLD 5
+#ifndef __GENKSYMS__
+	uint16_t	set_data_rate;		/* Set by user */
 	/* DMA pool for the DIF bundling buffers */
 	struct dma_pool *dif_bundl_pool;
 	#define DIF_BUNDLING_DMA_POOL_SIZE  1024
@@ -4219,13 +4229,7 @@ struct qla_hw_data {
 	unsigned long long dif_bundle_writes;
 	unsigned long long dif_bundle_kallocs;
 	unsigned long long dif_bundle_dma_allocs;
-
-	atomic_t        nvme_active_aen_cnt;
-	uint16_t        nvme_last_rptd_aen;             /* Last recorded aen count */
-
-	atomic_t zio_threshold;
-	uint16_t last_zio_threshold;
-#define DEFAULT_ZIO_THRESHOLD 5
+#endif
 };
 
 #define FW_ABILITY_MAX_SPEED_MASK	0xFUL
@@ -4269,7 +4273,9 @@ typedef struct scsi_qla_host {
 		uint32_t	qpairs_req_created:1;
 		uint32_t	qpairs_rsp_created:1;
 		uint32_t	nvme_enabled:1;
+#ifndef __GENKSYMS__
 		uint32_t        nvme_first_burst:1;
+#endif
 	} flags;
 
 	atomic_t	loop_state;
diff --git a/drivers/scsi/qla2xxx/qla_target.h b/drivers/scsi/qla2xxx/qla_target.h
index 54925e2fe5ea..0054d884e000 100644
--- a/drivers/scsi/qla2xxx/qla_target.h
+++ b/drivers/scsi/qla2xxx/qla_target.h
@@ -928,13 +928,15 @@ struct qla_tgt_cmd {
 	uint64_t	lba;
 	uint16_t	a_guard, e_guard, a_app_tag, e_app_tag;
 	uint32_t	a_ref_tag, e_ref_tag;
-#define DIF_BUNDL_DMA_VALID 1
-	uint16_t prot_flags;
 
 	uint64_t jiffies_at_alloc;
 	uint64_t jiffies_at_free;
 
 	enum trace_flags trc_flags;
+#ifndef __GENKSYMS__
+#define DIF_BUNDL_DMA_VALID 1
+	uint16_t prot_flags;
+#endif
 };
 
 struct qla_tgt_sess_work_param {
-- 
2.16.4

