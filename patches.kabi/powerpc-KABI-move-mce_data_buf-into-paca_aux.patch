From 0dd395049d5b7ebe26ffdad6be543f0997d25e88 Mon Sep 17 00:00:00 2001
From: Michal Suchanek <msuchanek@suse.de>
Date: Fri, 14 Sep 2018 16:49:40 +0200
Subject: [PATCH 3/3] powerpc: KABI: move mce_data_buf into paca_aux.

References: bsc#1094244
Patch-mainline: no, kabi

Signed-off-by: Michal Suchanek <msuchanek@suse.de>
---
 arch/powerpc/include/asm/paca.h        |  6 +++---
 arch/powerpc/platforms/pseries/ras.c   | 10 +++++-----
 arch/powerpc/platforms/pseries/setup.c |  2 +-
 3 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/arch/powerpc/include/asm/paca.h b/arch/powerpc/include/asm/paca.h
index 723812dbff21..1584afd2fe10 100644
--- a/arch/powerpc/include/asm/paca.h
+++ b/arch/powerpc/include/asm/paca.h
@@ -58,6 +58,9 @@ struct task_struct;
  */
 #ifdef CONFIG_PPC_BOOK3S_64
 struct paca_aux_struct {
+#ifdef CONFIG_PPC_PSERIES
+	u8 *mce_data_buf;		/* buffer to hold per cpu rtas errlog */
+#endif /* CONFIG_PPC_PSERIES */
 };
 #endif
 
@@ -260,9 +263,6 @@ struct paca_struct {
 	void *rfi_flush_fallback_area;
 	u64 l1d_flush_size;
 #endif
-#ifdef CONFIG_PPC_PSERIES
-	u8 *mce_data_buf;		/* buffer to hold per cpu rtas errlog */
-#endif /* CONFIG_PPC_PSERIES */
 };
 
 extern void copy_mm_to_paca(struct mm_struct *mm);
diff --git a/arch/powerpc/platforms/pseries/ras.c b/arch/powerpc/platforms/pseries/ras.c
index 07ba857110cf..874d744d95c7 100644
--- a/arch/powerpc/platforms/pseries/ras.c
+++ b/arch/powerpc/platforms/pseries/ras.c
@@ -335,7 +335,7 @@ static irqreturn_t ras_error_interrupt(int irq, void *dev_id)
 
 static inline struct rtas_error_log *fwnmi_get_errlog(void)
 {
-	return (struct rtas_error_log *)local_paca->mce_data_buf;
+	return (struct rtas_error_log *)local_paca->aux_ptr->mce_data_buf;
 }
 
 /*
@@ -371,18 +371,18 @@ static struct rtas_error_log *fwnmi_get_errinfo(struct pt_regs *regs)
 
 	h = (struct rtas_error_log *)&savep[1];
 	/* Use the per cpu buffer from paca to store rtas error log */
-	memset(local_paca->mce_data_buf, 0, RTAS_ERROR_LOG_MAX);
+	memset(local_paca->aux_ptr->mce_data_buf, 0, RTAS_ERROR_LOG_MAX);
 	if (!rtas_error_extended(h)) {
-		memcpy(local_paca->mce_data_buf, h, sizeof(__u64));
+		memcpy(local_paca->aux_ptr->mce_data_buf, h, sizeof(__u64));
 	} else {
 		int len, error_log_length;
 
 		error_log_length = 8 + rtas_error_extended_log_length(h);
 		len = min_t(int, error_log_length, RTAS_ERROR_LOG_MAX);
-		memcpy(local_paca->mce_data_buf, h, len);
+		memcpy(local_paca->aux_ptr->mce_data_buf, h, len);
 	}
 
-	return (struct rtas_error_log *)local_paca->mce_data_buf;
+	return (struct rtas_error_log *)local_paca->aux_ptr->mce_data_buf;
 }
 
 /* Call this when done with the data returned by FWNMI_get_errinfo.
diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.c
index ee60f5284e54..b2062261c37b 100644
--- a/arch/powerpc/platforms/pseries/setup.c
+++ b/arch/powerpc/platforms/pseries/setup.c
@@ -127,7 +127,7 @@ static void __init fwnmi_init(void)
 	mce_data_buf = __va(memblock_alloc_base(RTAS_ERROR_LOG_MAX * nr_cpus,
 					RTAS_ERROR_LOG_MAX, ppc64_rma_size));
 	for_each_possible_cpu(i) {
-		paca[i].mce_data_buf = mce_data_buf +
+		paca[i].aux_ptr->mce_data_buf = mce_data_buf +
 						(RTAS_ERROR_LOG_MAX * i);
 	}
 }
-- 
2.13.7

