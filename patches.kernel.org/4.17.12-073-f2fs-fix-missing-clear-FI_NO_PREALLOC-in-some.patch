From: Yunlei He <heyunlei@huawei.com>
Date: Tue, 24 Apr 2018 11:40:19 +0800
Subject: [PATCH] f2fs: fix missing clear FI_NO_PREALLOC in some error case
References: bnc#1012628
Patch-mainline: 4.17.12
Git-commit: cba41be08cb182476fec4d318a8a8f2f8361a901

[ Upstream commit cba41be08cb182476fec4d318a8a8f2f8361a901 ]

This patch fix missing clear FI_NO_PREALLOC in some error case

Signed-off-by: Yunlei He <heyunlei@huawei.com>
Reviewed-by: Chao Yu <yuchao0@huawei.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 fs/f2fs/file.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/fs/f2fs/file.c b/fs/f2fs/file.c
index 5d99fd113a80..ffa20409c703 100644
--- a/fs/f2fs/file.c
+++ b/fs/f2fs/file.c
@@ -2927,6 +2927,8 @@ static ssize_t f2fs_file_write_iter(struct kiocb *iocb, struct iov_iter *from)
 						iov_iter_count(from)) ||
 					f2fs_has_inline_data(inode) ||
 					f2fs_force_buffered_io(inode, WRITE)) {
+						clear_inode_flag(inode,
+								FI_NO_PREALLOC);
 						inode_unlock(inode);
 						return -EAGAIN;
 				}
-- 
2.18.0

