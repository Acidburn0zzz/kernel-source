diff -u linux/arch/x86_64/kernel/setup.c-o linux/arch/x86_64/kernel/setup.c
--- linux/arch/x86_64/kernel/setup.c-o	2004-05-07 12:21:01.000000000 +0200
+++ linux/arch/x86_64/kernel/setup.c	2004-05-14 09:47:14.000000000 +0200
@@ -728,7 +728,6 @@
 	unsigned int trace = 0, l1i = 0, l1d = 0, l2 = 0, l3 = 0; 
 	unsigned n;
 
-	select_idle_routine(c);
 	if (c->cpuid_level > 1) {
 		/* supports eax=2  call */
 		int i, j, n;
@@ -797,9 +796,6 @@
 		c->x86_cache_size = l2 ? l2 : (l1i+l1d);
 	}
 
-	if (cpu_has(c, X86_FEATURE_HT))
-		detect_ht(); 
-
 	n = cpuid_eax(0x80000000);
 	if (n >= 0x80000008) {
 		unsigned eax = cpuid_eax(0x80000008);
@@ -928,7 +924,10 @@
 			display_cacheinfo(c);
 			break;
 	}
-	
+	select_idle_routine(c);	
+	if (cpu_has(c, X86_FEATURE_HT))
+		detect_ht(); 
+
 	/*
 	 * On SMP, boot_cpu_data holds the common feature set between
 	 * all CPUs; so make sure that we indicate which features are
diff -u linux/arch/x86_64/kernel/domain.c-o linux/arch/x86_64/kernel/domain.c
--- linux/arch/x86_64/kernel/domain.c-o	2004-05-07 12:20:33.000000000 +0200
+++ linux/arch/x86_64/kernel/domain.c	2004-05-14 09:45:42.000000000 +0200
@@ -21,6 +21,10 @@
 		struct sched_domain *phys_domain = &per_cpu(phys_domains, i);
 
 		*cpu_domain = SD_SIBLING_INIT;
+		/* Disable SMT NICE for CMP */
+		/* RED-PEN use a generic flag */ 
+		if (cpu_data[i].x86_vendor == X86_VENDOR_AMD) 
+			cpu_domain->flags &= ~SD_SHARE_CPUPOWER; 
 		cpu_domain->span = cpu_sibling_map[i];
 		cpu_domain->parent = phys_domain;
 		cpu_domain->groups = &sched_group_cpus[i];
