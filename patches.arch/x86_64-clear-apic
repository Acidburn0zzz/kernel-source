From: ak@suse.de
Subject: Clear APIC feature bit when local APIC is disabled

Needed for other checks later in ACPI.

Pointed out by Len Brown

Signed-off-by: Andi Kleen <ak@suse.de>

---
 arch/x86_64/kernel/setup.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletion(-)

Index: linux-2.6.16/arch/x86_64/kernel/setup.c
===================================================================
--- linux-2.6.16.orig/arch/x86_64/kernel/setup.c
+++ linux-2.6.16/arch/x86_64/kernel/setup.c
@@ -339,8 +339,10 @@ static __init void parse_cmdline_early (
 			disable_timer_pin_1 = -1;
 
 		if (!memcmp(from, "nolapic", 7) ||
-		    !memcmp(from, "disableapic", 11))
+		    !memcmp(from, "disableapic", 11)) {
+			clear_bit(X86_FEATURE_APIC, boot_cpu_data.x86_capability);	
 			disable_apic = 1;
+		}
 
 		/* Don't confuse with noapictimer */
 		if (!memcmp(from, "noapic", 6) &&
