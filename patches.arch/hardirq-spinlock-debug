diff -u linux/include/asm-x86_64/hardirq.h.bak linux/include/asm-x86_64/hardirq.h
--- linux/include/asm-x86_64/hardirq.h.bak	2004-04-06 13:12:21.000000000 +0200
+++ linux/include/asm-x86_64/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -77,7 +77,7 @@
 #define nmi_exit()		(preempt_count() -= HARDIRQ_OFFSET)
 
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # include <linux/smp_lock.h>
 # define in_atomic()   ((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-ppc/hardirq.h.bak linux/include/asm-ppc/hardirq.h
--- linux/include/asm-ppc/hardirq.h.bak	2004-03-21 21:11:54.000000000 +0100
+++ linux/include/asm-ppc/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -81,7 +81,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-m68k/hardirq.h.bak linux/include/asm-m68k/hardirq.h
--- linux/include/asm-m68k/hardirq.h.bak	2004-03-21 21:11:54.000000000 +0100
+++ linux/include/asm-m68k/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -71,7 +71,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	(preempt_count() != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-ppc64/hardirq.h.bak linux/include/asm-ppc64/hardirq.h
diff -u linux/include/asm-ia64/hardirq.h.bak linux/include/asm-ia64/hardirq.h
--- linux/include/asm-ia64/hardirq.h.bak	2004-04-06 13:12:19.000000000 +0200
+++ linux/include/asm-ia64/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -86,7 +86,7 @@
 #define hardirq_trylock()	(!in_interrupt())
 #define hardirq_endlock()	do { } while (0)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # include <linux/smp_lock.h>
 # define in_atomic()		((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-m68knommu/hardirq.h.bak linux/include/asm-m68knommu/hardirq.h
--- linux/include/asm-m68knommu/hardirq.h.bak	2004-03-21 21:11:54.000000000 +0100
+++ linux/include/asm-m68knommu/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -72,13 +72,13 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
 # define IRQ_EXIT_OFFSET HARDIRQ_OFFSET
 #endif
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	(preempt_count() != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-parisc/hardirq.h.bak linux/include/asm-parisc/hardirq.h
--- linux/include/asm-parisc/hardirq.h.bak	2004-03-21 21:11:54.000000000 +0100
+++ linux/include/asm-parisc/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -87,7 +87,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # error CONFIG_PREEMT currently not supported.
 # define in_atomic()	 BUG()
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-um/hardirq.h.bak linux/include/asm-um/hardirq.h
diff -u linux/include/asm-arm/hardirq.h.bak linux/include/asm-arm/hardirq.h
--- linux/include/asm-arm/hardirq.h.bak	2004-04-06 13:12:19.000000000 +0200
+++ linux/include/asm-arm/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -69,7 +69,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-mips/hardirq.h.bak linux/include/asm-mips/hardirq.h
--- linux/include/asm-mips/hardirq.h.bak	1970-01-01 01:12:51.000000000 +0100
+++ linux/include/asm-mips/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -79,7 +79,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # include <linux/smp_lock.h>
 # define in_atomic()	(preempt_count() != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-sparc/hardirq.h.bak linux/include/asm-sparc/hardirq.h
--- linux/include/asm-sparc/hardirq.h.bak	1970-01-01 01:12:51.000000000 +0100
+++ linux/include/asm-sparc/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -79,7 +79,7 @@
 
 #define irq_enter()             (preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 #include <linux/smp_lock.h>
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-alpha/hardirq.h.bak linux/include/asm-alpha/hardirq.h
--- linux/include/asm-alpha/hardirq.h.bak	2004-03-21 21:11:56.000000000 +0100
+++ linux/include/asm-alpha/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -79,7 +79,7 @@
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 #define in_atomic()	(preempt_count() != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-s390/hardirq.h.bak linux/include/asm-s390/hardirq.h
--- linux/include/asm-s390/hardirq.h.bak	2004-03-21 21:11:56.000000000 +0100
+++ linux/include/asm-s390/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -98,7 +98,7 @@
 
 #define invoke_softirq() do_call_softirq()
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-i386/hardirq.h.bak linux/include/asm-i386/hardirq.h
--- linux/include/asm-i386/hardirq.h.bak	2004-03-21 21:11:56.000000000 +0100
+++ linux/include/asm-i386/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -76,7 +76,7 @@
 #define nmi_enter()		(irq_enter())
 #define nmi_exit()		(preempt_count() -= HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # include <linux/smp_lock.h>
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-h8300/hardirq.h.bak linux/include/asm-h8300/hardirq.h
--- linux/include/asm-h8300/hardirq.h.bak	2004-03-21 21:11:56.000000000 +0100
+++ linux/include/asm-h8300/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -74,7 +74,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	(preempt_count() != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-sparc64/hardirq.h.bak linux/include/asm-sparc64/hardirq.h
--- linux/include/asm-sparc64/hardirq.h.bak	2004-03-21 21:11:57.000000000 +0100
+++ linux/include/asm-sparc64/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -78,7 +78,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # include <linux/smp_lock.h>
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
diff -u linux/include/asm-cris/hardirq.h.bak linux/include/asm-cris/hardirq.h
--- linux/include/asm-cris/hardirq.h.bak	2004-03-21 21:11:57.000000000 +0100
+++ linux/include/asm-cris/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -77,7 +77,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-v850/hardirq.h.bak linux/include/asm-v850/hardirq.h
--- linux/include/asm-v850/hardirq.h.bak	2004-03-21 21:11:57.000000000 +0100
+++ linux/include/asm-v850/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -72,7 +72,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()    (preempt_count() != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-sh/hardirq.h.bak linux/include/asm-sh/hardirq.h
--- linux/include/asm-sh/hardirq.h.bak	1970-01-01 01:12:51.000000000 +0100
+++ linux/include/asm-sh/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -74,7 +74,7 @@
 #define nmi_enter()		(irq_enter())
 #define nmi_exit()		(preempt_count() -= HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()	((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())
 # define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
diff -u linux/include/asm-arm26/hardirq.h.bak linux/include/asm-arm26/hardirq.h
--- linux/include/asm-arm26/hardirq.h.bak	2004-03-21 21:11:57.000000000 +0100
+++ linux/include/asm-arm26/hardirq.h	2004-06-01 19:01:34.000000000 +0200
@@ -68,7 +68,7 @@
 
 #define irq_enter()		(preempt_count() += HARDIRQ_OFFSET)
 
-#ifdef CONFIG_PREEMPT
+#if defined(CONFIG_PREEMPT) || defined(CONFIG_DEBUG_SPINLOCK_SLEEP)
 # define in_atomic()    ((preempt_count() & ~PREEMPT_ACTIVE) != kernel_locked())# define IRQ_EXIT_OFFSET (HARDIRQ_OFFSET-1)
 #else
 # define in_atomic()    (preempt_count() != 0)
