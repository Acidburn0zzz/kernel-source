Subject: [PATCH 8/8] Cell: Draw SPE helper penguin logos

Let spu_management_ops.enumerate_spus() return the number of found SPEs
and use that information to draw some little helper penguin logos.

Signed-off-by: Geert Uytterhoeven <Geert.Uytterhoeven@sonycom.com>
Signed-off-by: Geoff Levand <geoffrey.levand@am.sony.com>
Cc: Arnd Bergmann <arnd@arndb.de>
Acked-By: James Simmons <jsimmons@infradead.org>
---
 arch/powerpc/platforms/cell/spu_base.c   |    6 +++++-
 arch/powerpc/platforms/cell/spu_manage.c |    4 +++-
 arch/powerpc/platforms/ps3/spu.c         |    6 ++++--
 3 files changed, 12 insertions(+), 4 deletions(-)

--- ps3-linux-2.6.21.orig/arch/powerpc/platforms/cell/spu_base.c
+++ ps3-linux-2.6.21/arch/powerpc/platforms/cell/spu_base.c
@@ -31,6 +31,7 @@
 #include <linux/mm.h>
 #include <linux/io.h>
 #include <linux/mutex.h>
+#include <linux/linux_logo.h>
 #include <asm/spu.h>
 #include <asm/spu_priv1.h>
 #include <asm/xmon.h>
@@ -624,12 +625,15 @@ static int __init init_spu_base(void)
 
 	ret = spu_enumerate_spus(create_spu);
 
-	if (ret) {
+	if (ret < 0) {
 		printk(KERN_WARNING "%s: Error initializing spus\n",
 			__FUNCTION__);
 		goto out_unregister_sysdev_class;
 	}
 
+	if (ret > 0)
+		fb_append_extra_logo(&logo_spe_clut224, ret);
+
 	xmon_register_spus(&spu_full_list);
 
 	return 0;
--- ps3-linux-2.6.21.orig/arch/powerpc/platforms/cell/spu_manage.c
+++ ps3-linux-2.6.21/arch/powerpc/platforms/cell/spu_manage.c
@@ -280,6 +280,7 @@ static int __init of_enumerate_spus(int 
 {
 	int ret;
 	struct device_node *node;
+	unsigned int n = 0;
 
 	ret = -ENODEV;
 	for (node = of_find_node_by_type(NULL, "spe");
@@ -290,8 +291,9 @@ static int __init of_enumerate_spus(int 
 				__FUNCTION__, node->name);
 			break;
 		}
+		n++;
 	}
-	return ret;
+	return ret ? ret : n;
 }
 
 static int __init of_create_spu(struct spu *spu, void *data)
--- ps3-linux-2.6.21.orig/arch/powerpc/platforms/ps3/spu.c
+++ ps3-linux-2.6.21/arch/powerpc/platforms/ps3/spu.c
@@ -401,11 +401,13 @@ static int __init ps3_enumerate_spus(int
 		}
 	}
 
-	if (result)
+	if (result) {
 		printk(KERN_WARNING "%s:%d: Error initializing spus\n",
 			__func__, __LINE__);
+		return result;
+	}
 
-	return result;
+	return num_resource_id;
 }
 
 static int ps3_enable_spu(struct spu_context *ctx)
