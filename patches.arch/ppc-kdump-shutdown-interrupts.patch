Subject: [PATCH] powerpc: Disable and EOI interrupts in machine_crash_shutdown()
From: Michael Ellerman <michael@ellerman.id.au>
Date: Tue, 04 Apr 2006 13:43:01 +0200
Message-Id: <20060404114306.8DC0F679EF@ozlabs.org>                                                                                                                   

Bug 152932 - LTC21954 - kdump: js20 stuck after "Brought up 2 CPUs"
Bug 152925 - LTC21956 - kdump: no input accepted on power5 hvc console

We've seen several bugs caused by interrupt weirdness in the kdump kernel.
Panicking from an interrupt handler means we fail to EOI the interrupt, and
so the second kernel never gets that interrupt ever again. We also see hangs
on JS20 where we take interrupts in the second kernel early during boot.

This patch fixes both those problems, and although it adds more code to the
crash path I think it is the best solution.

Signed-off-by: Michael Ellerman <michael@ellerman.id.au>
Signed-off-by: Olaf Hering <olh@suse.de>

---
 arch/powerpc/kernel/crash.c |    2 ++
 1 files changed, 2 insertions(+)

--- linux-2.6.17.orig/arch/powerpc/kernel/crash.c
+++ linux-2.6.17/arch/powerpc/kernel/crash.c
@@ -249,6 +249,8 @@ void crash_kexec_secondary(struct pt_reg
 #else
 static void crash_kexec_prepare_cpus(int cpu)
 {
+	unsigned int irq;
+
 	/*
 	 * move the secondarys to us so that we can copy
 	 * the new kernel 0-0x100 safely
