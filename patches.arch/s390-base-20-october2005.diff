From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: IBM Codestream linux-2.6.16 october2005, patch base-20

  [patch] multicast notifier.

  s390 network driver change:
   - Add option NETIF_F_MC_ALL to get notified for all multicast
     address additions/removals.
Acked-by: Hannes Reinecke <hare@suse.de>

---

 drivers/s390/net/lcs.c       |    4 +++-
 drivers/s390/net/qeth_main.c |    4 +++-
 include/linux/netdevice.h    |    3 +++
 net/core/dev_mcast.c         |    5 +++++
 4 files changed, 14 insertions(+), 2 deletions(-)

diff -urpN linux-2.6/drivers/s390/net/lcs.c linux-2.6-patched/drivers/s390/net/lcs.c
--- linux-2.6/drivers/s390/net/lcs.c	2006-03-20 06:53:29.000000000 +0100
+++ linux-2.6-patched/drivers/s390/net/lcs.c	2006-03-22 11:47:02.000000000 +0100
@@ -2198,8 +2198,10 @@ lcs_new_device(struct ccwgroup_device *c
 	SET_MODULE_OWNER(dev);
 	memcpy(card->dev->dev_addr, card->mac, LCS_MAC_LENGTH);
 #ifdef CONFIG_IP_MULTICAST
-	if (!lcs_check_multicast_support(card))
+	if (!lcs_check_multicast_support(card)) {
 		card->dev->set_multicast_list = lcs_set_multicast_list;
+		card->dev->features |= NETIF_F_MC_ALL;
+	}
 #endif
 netdev_out:
 	lcs_set_allowed_threads(card,0xffffffff);
diff -urpN linux-2.6/drivers/s390/net/qeth_main.c linux-2.6-patched/drivers/s390/net/qeth_main.c
--- linux-2.6/drivers/s390/net/qeth_main.c	2006-03-22 11:47:02.000000000 +0100
+++ linux-2.6-patched/drivers/s390/net/qeth_main.c	2006-03-22 11:47:02.000000000 +0100
@@ -7027,6 +7027,7 @@ qeth_start_ipa_multicast(struct qeth_car
 	} else {
 		PRINT_INFO("Multicast enabled\n");
 		card->dev->flags |= IFF_MULTICAST;
+		card->dev->features |= NETIF_F_MC_ALL;
 	}
 	return rc;
 }
@@ -7414,7 +7415,8 @@ qeth_softsetup_card(struct qeth_card *ca
 		card->dev->features |=
 			NETIF_F_HW_VLAN_FILTER |
 			NETIF_F_HW_VLAN_TX |
-			NETIF_F_HW_VLAN_RX;
+			NETIF_F_HW_VLAN_RX |
+			NETIF_F_MC_ALL;
 		card->dev->flags|=IFF_MULTICAST|IFF_BROADCAST;
 		card->info.broadcast_capable=1;
 		if ((rc = qeth_layer2_initialize(card))) {
diff -urpN linux-2.6/include/linux/netdevice.h linux-2.6-patched/include/linux/netdevice.h
--- linux-2.6/include/linux/netdevice.h	2006-03-20 06:53:29.000000000 +0100
+++ linux-2.6-patched/include/linux/netdevice.h	2006-03-22 11:47:02.000000000 +0100
@@ -309,6 +309,9 @@ struct net_device
 #define NETIF_F_TSO		2048	/* Can offload TCP/IP segmentation */
 #define NETIF_F_LLTX		4096	/* LockLess TX */
 #define NETIF_F_UFO             8192    /* Can offload UDP Large Send*/
+#define NETIF_F_MC_ALL		16384   /* trigger driver on every multicast
+	                                 * address been added/deleted
+				         */
 
 	struct net_device	*next_sched;
 
diff -urpN linux-2.6/net/core/dev_mcast.c linux-2.6-patched/net/core/dev_mcast.c
--- linux-2.6/net/core/dev_mcast.c	2006-03-20 06:53:29.000000000 +0100
+++ linux-2.6-patched/net/core/dev_mcast.c	2006-03-22 11:47:02.000000000 +0100
@@ -145,6 +145,8 @@ int dev_mc_delete(struct net_device *dev
 	}
 	err = -ENOENT;
 done:
+	if (dev->features & NETIF_F_MC_ALL)
+		__dev_mc_upload(dev);
 	spin_unlock_bh(&dev->xmit_lock);
 	return err;
 }
@@ -193,6 +195,9 @@ int dev_mc_add(struct net_device *dev, v
 	return 0;
 
 done:
+	if (dev->features & NETIF_F_MC_ALL)
+		__dev_mc_upload(dev);
+
 	spin_unlock_bh(&dev->xmit_lock);
 	kfree(dmi1);
 	return err;
