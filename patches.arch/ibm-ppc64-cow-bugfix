diff -urN /home/dgibson/ibm/htlb/linux-gogogo/arch/ppc64/mm/hugetlbpage.c ./arch/ppc64/mm/hugetlbpage.c
--- /home/dgibson/ibm/htlb/linux-gogogo/arch/ppc64/mm/hugetlbpage.c	2004-04-22 15:36:24.000000000 +1000
+++ ./arch/ppc64/mm/hugetlbpage.c	2004-04-23 15:44:20.115247344 +1000
@@ -852,7 +852,7 @@
 	if (cpus_equal(vma->vm_mm->cpu_vm_mask, tmp))
 		local = 1;
 
-	ptep = hugepte_offset(mm, address);
+	ptep = hugepte_offset(mm, address & HPAGE_MASK);
 	if (hugepte_same(*ptep, pte)) {
 		/* Break COW */
 		for (i = 0; i < HUGEPTE_BATCH_SIZE; i++)
