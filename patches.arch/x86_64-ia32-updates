--- linux-2.6.5rc2-amd64/arch/x86_64/ia32/sys_ia32.c-o	2004-03-21 21:12:10.000000000 +0100
+++ linux-2.6.5rc2-amd64/arch/x86_64/ia32/sys_ia32.c	2004-03-24 06:05:56.000000000 +0100
@@ -512,7 +512,7 @@
 {
 	struct linux32_dirent * dirent;
 	struct getdents32_callback * buf = (struct getdents32_callback *) __buf;
-	int reclen = ROUND_UP(NAME_OFFSET(dirent) + namlen + 1, 4);
+	int reclen = ROUND_UP(NAME_OFFSET(dirent) + namlen + 2, 4);
 
 	buf->error = -EINVAL;	/* only used if we fail.. */
 	if (reclen > buf->count)
@@ -526,7 +526,8 @@
 	put_user(reclen, &dirent->d_reclen);
 	copy_to_user(dirent->d_name, name, namlen);
 	put_user(0, dirent->d_name + namlen);
-	dirent = ((void *)dirent) + reclen;
+	put_user(d_type, (char *)dirent + reclen - 1); 
+	dirent = ((void *)dirent) + reclen;	
 	buf->current_dir = dirent;
 	buf->count -= reclen;
 	return 0;
@@ -881,7 +882,10 @@
 static int checktype(char *user_type) 
 { 
 	int err = 0; 
-	char **s,*kernel_type = getname(user_type); 
+	char **s,*kernel_type;
+	if (!user_type) 
+		return 0;
+	kernel_type = getname(user_type); 
 	if (!kernel_type || IS_ERR(kernel_type)) 
 		return -EFAULT; 
 	for (s = badfs; *s; ++s) 
