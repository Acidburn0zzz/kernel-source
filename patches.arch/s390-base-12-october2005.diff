From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Subject: IBM Codedrop 2006-01-09 - linux-2.6.15-s390-base-12-october2005.diff

[patch] ipv6 shared card id and delete route objects.

IPv6 changes:
 - Copy ipv6 shared card id from real device to vlan device.
 - Delete route objects related to netdevices on NETDEV_UNREGISTER events.

Acked-by: Hannes Reinecke <hare@suse.de>

---

 net/8021q/vlan.c |    3 +++
 net/ipv6/ndisc.c |    3 +++
 2 files changed, 6 insertions(+)

diff -urpN linux-2.6/net/8021q/vlan.c linux-2.6-patched/net/8021q/vlan.c
--- linux-2.6/net/8021q/vlan.c	2006-01-03 04:21:10.000000000 +0100
+++ linux-2.6-patched/net/8021q/vlan.c	2006-01-09 15:25:39.000000000 +0100
@@ -449,6 +449,9 @@ static struct net_device *register_vlan_
 	new_dev->flags = real_dev->flags;
 	new_dev->flags &= ~IFF_UP;
 
+	/* ipv6 shared card related stuff */
+	new_dev->dev_id = real_dev->dev_id;
+
 	new_dev->state = real_dev->state & VLAN_LINK_STATE_MASK;
 
 	/* need 4 bytes for extra VLAN header info,
diff -urpN linux-2.6/net/ipv6/ndisc.c linux-2.6-patched/net/ipv6/ndisc.c
--- linux-2.6/net/ipv6/ndisc.c	2006-01-03 04:21:10.000000000 +0100
+++ linux-2.6-patched/net/ipv6/ndisc.c	2006-01-09 15:25:39.000000000 +0100
@@ -1519,6 +1519,9 @@ static int ndisc_netdev_event(struct not
 		neigh_ifdown(&nd_tbl, dev);
 		fib6_run_gc(~0UL);
 		break;
+	case NETDEV_UNREGISTER:
+		fib6_run_gc(0);
+		break;
 	default:
 		break;
 	}
