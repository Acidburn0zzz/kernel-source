Subject: x86: Add acpi_user_timer_override option for Asus boards
From: ak@suse.de
Patch-mainline: 2.6.19

Timer overrides are normally disabled on Nvidia board because
they are commonly wrong, except on new ones with HPET support.
Unfortunately there are quite some Asus boards around that
don't have HPET, but need a timer override.

We don't know yet how to handle this transparently,
but at least add a command line option to force the timer override
and let them boot.

Cc: len.brown@intel.com

Signed-off-by: Andi Kleen <ak@suse.de>

---
 Documentation/kernel-parameters.txt |    4 ++++
 arch/i386/kernel/acpi/boot.c        |    8 ++++++++
 arch/i386/kernel/acpi/earlyquirk.c  |    8 +++++++-
 arch/x86_64/kernel/early-quirks.c   |    8 ++++++++
 include/asm-i386/acpi.h             |    1 +
 include/asm-x86_64/acpi.h           |    1 +
 6 files changed, 29 insertions(+), 1 deletion(-)

Index: linux-2.6.18/arch/i386/kernel/acpi/boot.c
===================================================================
--- linux-2.6.18.orig/arch/i386/kernel/acpi/boot.c
+++ linux-2.6.18/arch/i386/kernel/acpi/boot.c
@@ -75,6 +75,7 @@ EXPORT_SYMBOL(acpi_strict);
 acpi_interrupt_flags acpi_sci_flags __initdata;
 int acpi_sci_override_gsi __initdata;
 int acpi_skip_timer_override __initdata;
+int acpi_use_timer_override __initdata;
 
 #ifdef CONFIG_X86_LOCAL_APIC
 static u64 acpi_lapic_addr __initdata = APIC_DEFAULT_PHYS_BASE;
Index: linux-2.6.18/arch/i386/kernel/acpi/earlyquirk.c
===================================================================
--- linux-2.6.18.orig/arch/i386/kernel/acpi/earlyquirk.c
+++ linux-2.6.18/arch/i386/kernel/acpi/earlyquirk.c
@@ -28,11 +28,17 @@ static int __init check_bridge(int vendo
 #ifdef CONFIG_ACPI
 	/* According to Nvidia all timer overrides are bogus unless HPET
 	   is enabled. */
-	if (vendor == PCI_VENDOR_ID_NVIDIA) {
+	if (!acpi_use_timer_override && vendor == PCI_VENDOR_ID_NVIDIA) {
 		nvidia_hpet_detected = 0;
 		acpi_table_parse(ACPI_HPET, nvidia_hpet_check);
 		if (nvidia_hpet_detected == 0) {
 			acpi_skip_timer_override = 1;
+			  printk(KERN_INFO "Nvidia board "
+                       "detected. Ignoring ACPI "
+                       "timer override.\n");
+                printk(KERN_INFO "If you got timer trouble "
+			 	 "try acpi_use_timer_override\n");
+
 		}
 	}
 #endif
Index: linux-2.6.18/include/asm-i386/acpi.h
===================================================================
--- linux-2.6.18.orig/include/asm-i386/acpi.h
+++ linux-2.6.18/include/asm-i386/acpi.h
@@ -133,6 +133,7 @@ extern int acpi_gsi_to_irq(u32 gsi, unsi
 #ifdef CONFIG_X86_IO_APIC
 extern int skip_ioapic_setup;
 extern int acpi_skip_timer_override;
+extern int acpi_use_timer_override;
 
 static inline void disable_ioapic_setup(void)
 {
Index: linux-2.6.18/include/asm-x86_64/acpi.h
===================================================================
--- linux-2.6.18.orig/include/asm-x86_64/acpi.h
+++ linux-2.6.18/include/asm-x86_64/acpi.h
@@ -165,6 +165,7 @@ extern u8 x86_acpiid_to_apicid[];
 #define ARCH_HAS_POWER_INIT 1
 
 extern int acpi_skip_timer_override;
+extern int acpi_use_timer_override;
 
 #endif /*__KERNEL__*/
 
Index: linux-2.6.18/Documentation/kernel-parameters.txt
===================================================================
--- linux-2.6.18.orig/Documentation/kernel-parameters.txt
+++ linux-2.6.18/Documentation/kernel-parameters.txt
@@ -158,6 +158,10 @@ running once the system is up.
 	acpi_skip_timer_override [HW,ACPI]
 			Recognize and ignore IRQ0/pin2 Interrupt Override.
 			For broken nForce2 BIOS resulting in XT-PIC timer.
+	acpi_use_timer_override [HW,ACPI}
+			Use timer override. For some broken Nvidia NF5 boards
+			that require a timer override, but don't have
+			HPET
 
 	acpi_dbg_layer=	[HW,ACPI]
 			Format: <int>
Index: linux-2.6.18/arch/x86_64/kernel/io_apic.c
===================================================================
--- linux-2.6.18.orig/arch/x86_64/kernel/io_apic.c
+++ linux-2.6.18/arch/x86_64/kernel/io_apic.c
@@ -337,11 +337,16 @@ void __init check_ioapic(void) 
 					nvidia_hpet_detected = 0;
 					acpi_table_parse(ACPI_HPET,
 							nvidia_hpet_check);
-					if (nvidia_hpet_detected == 0) {
+					if (!acpi_use_timer_override &&
+					    nvidia_hpet_detected == 0) {
 						acpi_skip_timer_override = 1;
 						printk(KERN_INFO "Nvidia board "
 						    "detected. Ignoring ACPI "
 						    "timer override.\n");
+						printk(KERN_INFO 
+						       "If you got timer trouble "
+						       "try acpi_use_timer_override\n");
+
 					}
 #endif
 					/* RED-PEN skip them on mptables too? */
