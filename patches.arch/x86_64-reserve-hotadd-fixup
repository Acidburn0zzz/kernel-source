From: Keith Mannthey
Subject: Convert sparsemem x86-64 memory hotadd to reservation based
Acked-by: ak@suse.de
Suse-bugzilla: 142035

Index: linux-2.6.15/arch/x86_64/mm/init.c
===================================================================
--- linux-2.6.15.orig/arch/x86_64/mm/init.c
+++ linux-2.6.15/arch/x86_64/mm/init.c
@@ -481,7 +481,7 @@ void __init clear_kernel_mapping(unsigne
  * Memory hotplug specific functions
  * These are only for non-NUMA machines right now.
  */
-#ifdef CONFIG_MEMORY_HOTPLUG
+#ifdef CONFIG_ACPI_HOTPLUG_MEMORY
 
 void online_page(struct page *page)
 {
@@ -492,25 +492,24 @@ void online_page(struct page *page)
 	num_physpages++;
 }
 
+/* You can only add memory you reserved during boot */
 int add_memory(u64 start, u64 size)
 {
-	struct pglist_data *pgdat = NODE_DATA(0);
-	struct zone *zone = pgdat->node_zones + MAX_NR_ZONES-2;
-	unsigned long start_pfn = start >> PAGE_SHIFT;
-	unsigned long nr_pages = size >> PAGE_SHIFT;
-	int ret;
-
-	ret = __add_pages(zone, start_pfn, nr_pages);
-	if (ret)
-		goto error;
-	
-	init_memory_mapping(start, (start + size -1));
+	u64 i;
+	int ret = 0;
 
-	return ret;
-error:
-	printk("%s: Problem encountered in __add_pages!\n", __func__);
+	init_memory_mapping(start, (start + size -1));
+	for (i = start;  i < start+size; i+= PAGE_SIZE) {
+		if (pfn_valid(i>>PAGE_SHIFT))
+			online_page(pfn_to_page(i >> PAGE_SHIFT));
+ 		else {
+			printk (KERN_ERR "%Lx is not a valid pfn\n",i);
+			ret = -EINVAL; 
+		}
+	}
 	return ret;
 }
+
 EXPORT_SYMBOL_GPL(add_memory);
 
 int remove_memory(u64 start, u64 size)
Index: linux-2.6.15/drivers/acpi/Kconfig
===================================================================
--- linux-2.6.15.orig/drivers/acpi/Kconfig
+++ linux-2.6.15/drivers/acpi/Kconfig
@@ -319,7 +319,7 @@ config ACPI_CONTAINER
 config ACPI_HOTPLUG_MEMORY
 	tristate "Memory Hotplug"
 	depends on ACPI
-	depends on MEMORY_HOTPLUG
+	depends on MEMORY_HOTPLUG || X86_64
 	default n
 	help
 	  This driver adds supports for ACPI Memory Hotplug.  This driver
Index: linux-2.6.15/include/linux/memory_hotplug.h
===================================================================
--- linux-2.6.15.orig/include/linux/memory_hotplug.h
+++ linux-2.6.15/include/linux/memory_hotplug.h
@@ -53,9 +53,6 @@ extern int zone_grow_waitqueues(struct z
 extern int add_one_highpage(struct page *page, int pfn, int bad_ppro);
 /* need some defines for these for archs that don't support it */
 extern void online_page(struct page *page);
-/* VM interface that may be used by firmware interface */
-extern int add_memory(u64 start, u64 size);
-extern int remove_memory(u64 start, u64 size);
 extern int online_pages(unsigned long, unsigned long);
 
 /* reasonably generic interface to expand the physical pages in a zone  */
@@ -101,4 +98,14 @@ static inline int __remove_pages(struct 
 	dump_stack();
 	return -ENOSYS;
 }
+
+/* VM interface that may be used by firmware interface */
+extern int add_memory(u64 start, u64 size);
+extern int remove_memory(u64 start, u64 size);
+
+#ifdef CONFIG_ACPI_HOTPLUG_MEMORY
+extern int add_memory(u64 start, u64 size);
+extern int remove_memory(u64 start, u64 size);
+#endif 
+
 #endif /* __LINUX_MEMORY_HOTPLUG_H */
