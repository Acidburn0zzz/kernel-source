From: Amul Shah <amul.shah@unisys.com>
Subject: Fix kdump Crash Kernel boot memory reservation for NUMA machines
Patch-mainline: 
References: 179095

This patch will fix a boot memory reservation bug that trashes memory on
the ES7000 when loading the kdump crash kernel.

The code in arch/x86_64/kernel/setup.c to reserve boot memory for the 
crash kernel uses the non-numa aware "reserve_bootmem" function instead 
of the NUMA aware "reserve_bootmem_generic".  I checked to make sure 
that no other function was using "reserve_bootmem" and found none, 
except the ones that had NUMA ifdef'ed out.

I have tested this patch only on an ES7000 with NUMA on and off (numa=off)
in a single (non-NUMA) and multi-cell (NUMA) configurations.

Signed-off-by: Amul Shah <amul.shah@unisys.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
diff -Naur -p linux-2.6.16.18-1.8/arch/x86_64/kernel/setup.c linux-2.6.16.18-1.8-az/arch/x86_64/kernel/setup.c
--- linux-2.6.16.18-1.8/arch/x86_64/kernel/setup.c	2006-06-06 12:07:42.000000000 -0400
+++ linux-2.6.16.18-1.8-az/arch/x86_64/kernel/setup.c	2006-06-21 17:06:04.000000000 -0400
@@ -715,7 +715,7 @@ void __init setup_arch(char **cmdline_p)
 #endif
 #ifdef CONFIG_KEXEC
 	if (crashk_res.start != crashk_res.end) {
-		reserve_bootmem(crashk_res.start,
+		reserve_bootmem_generic(crashk_res.start,
 			crashk_res.end - crashk_res.start + 1);
 	}
 #endif
