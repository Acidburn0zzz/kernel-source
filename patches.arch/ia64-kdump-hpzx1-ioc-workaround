From: Terry Loftin <terry.loftin@hp.com>
Subject: Fix problems with sba_iommu and kdump
References: 271158

See http://article.gmane.org/gmane.linux.ports.ia64/16535

If we are booting a kdump kernel, the sba_iommu will cause devices that were
not shutdown properly to MCA as soon as they are turned back on. Our only
option for a successful kdump kernel boot is to use the swiotlb.


Acked-by: Bernhard Walle <bwalle@suse.de>

---
 arch/ia64/hp/common/sba_iommu.c |   20 ++++++++++++++++++--
 1 file changed, 18 insertions(+), 2 deletions(-)

--- a/arch/ia64/hp/common/sba_iommu.c	2007-07-08 19:32:17.000000000 -0400
+++ b/arch/ia64/hp/common/sba_iommu.c	2007-08-27 14:03:45.000000000 -0400
@@ -42,6 +42,9 @@
 #include <asm/system.h>		/* wmb() */
 
 #include <asm/acpi-ext.h>
+#include <linux/crash_dump.h>
+
+extern int swiotlb_late_init_with_default_size (size_t size);
 
 #define PFX "IOC: "
 
@@ -2026,11 +2029,24 @@ sba_init(void)
 	if (!ia64_platform_is("hpzx1") && !ia64_platform_is("hpzx1_swiotlb"))
 		return 0;
 
+#ifdef CONFIG_CRASH_DUMP
+	/* If we are booting a kdump kernel, the sba_iommu will
+	 * cause devices that were not shutdown properly to MCA
+	 * as soon as they are turned back on.  Our only option for
+	 * a successful kdump kernel boot is to use the swiotlb.
+	 */
+	if (elfcorehdr_addr < ELFCORE_ADDR_MAX) {
+		if (swiotlb_late_init_with_default_size(64 * (1<<20)) != 0)
+			panic("Unable to initialize software I/O TLB:"
+				  " Try machvec=dig boot option");
+		machvec_init("dig");
+		return 0;
+	}
+#endif
+
 	acpi_bus_register_driver(&acpi_sba_ioc_driver);
 	if (!ioc_list) {
 #ifdef CONFIG_IA64_GENERIC
-		extern int swiotlb_late_init_with_default_size (size_t size);
-
 		/*
 		 * If we didn't find something sba_iommu can claim, we
 		 * need to setup the swiotlb and switch to the dig machvec.
