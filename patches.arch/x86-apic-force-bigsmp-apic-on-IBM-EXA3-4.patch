From: IBM <lcm@us.ibm.com>
Subject: Use apic=bigsmp on specific xseries machines
References: bnc#440497
Patch-Mainline: not yet

Signed-off-by: Thomas Renninger <trenn@suse.de>


 arch/x86/mach-generic/bigsmp.c |   26 +++++++++++++++++++++++---
 arch/x86/mach-generic/probe.c  |    4 ++--
 2 files changed, 25 insertions(+), 5 deletions(-)

--- a/arch/x86/mach-generic/bigsmp.c
+++ b/arch/x86/mach-generic/bigsmp.c
@@ -21,7 +21,7 @@
 
 static int dmi_bigsmp; /* can be set by dmi scanners */
 
-static int hp_ht_bigsmp(const struct dmi_system_id *d)
+static int force_bigsmp_apic(const struct dmi_system_id *d)
 {
 	printk(KERN_NOTICE "%s detected: force use of apic=bigsmp\n", d->ident);
 	dmi_bigsmp = 1;
@@ -30,15 +30,35 @@ static int hp_ht_bigsmp(const struct dmi
 
 
 static const struct dmi_system_id bigsmp_dmi_table[] = {
-	{ hp_ht_bigsmp, "HP ProLiant DL760 G2",
+	{ force_bigsmp_apic, "HP ProLiant DL760 G2",
 	{ DMI_MATCH(DMI_BIOS_VENDOR, "HP"),
 	DMI_MATCH(DMI_BIOS_VERSION, "P44-"),}
 	},
 
-	{ hp_ht_bigsmp, "HP ProLiant DL740",
+	{ force_bigsmp_apic, "HP ProLiant DL740",
 	{ DMI_MATCH(DMI_BIOS_VENDOR, "HP"),
 	DMI_MATCH(DMI_BIOS_VERSION, "P47-"),}
 	},
+
+	{ force_bigsmp_apic, "IBM x260 / x366 / x460",
+	{ DMI_MATCH(DMI_BIOS_VENDOR, "IBM"),
+	DMI_MATCH(DMI_BIOS_VERSION, "-[ZT"),}
+	},
+
+	{ force_bigsmp_apic, "IBM x3800 / x3850 / x3950",
+	{ DMI_MATCH(DMI_BIOS_VENDOR, "IBM"),
+	DMI_MATCH(DMI_BIOS_VERSION, "-[ZU"),}
+	},
+
+	{ force_bigsmp_apic, "IBM x3800 / x3850 / x3950",
+	{ DMI_MATCH(DMI_BIOS_VENDOR, "IBM"),
+	DMI_MATCH(DMI_BIOS_VERSION, "-[ZS"),}
+	},
+
+	{ force_bigsmp_apic, "IBM x3850 M2 / x3950 M2",
+	{ DMI_MATCH(DMI_BIOS_VENDOR, "IBM"),
+	DMI_MATCH(DMI_BIOS_VERSION, "-[A3"),}
+	},
 	 { }
 };
 
--- a/arch/x86/mach-generic/probe.c
+++ b/arch/x86/mach-generic/probe.c
@@ -115,7 +115,7 @@ int __init mps_oem_check(struct mpc_tabl
 	int i;
 	for (i = 0; apic_probe[i]; ++i) {
 		if (apic_probe[i]->mps_oem_check(mpc, oem, productid)) {
-			if (!cmdline_apic) {
+			if (!cmdline_apic && genapic == &apic_default) {
 				genapic = apic_probe[i];
 				if (x86_quirks->update_genapic)
 					x86_quirks->update_genapic();
@@ -133,7 +133,7 @@ int __init acpi_madt_oem_check(char *oem
 	int i;
 	for (i = 0; apic_probe[i]; ++i) {
 		if (apic_probe[i]->acpi_madt_oem_check(oem_id, oem_table_id)) {
-			if (!cmdline_apic) {
+			if (!cmdline_apic && genapic == &apic_default) {
 				genapic = apic_probe[i];
 				if (x86_quirks->update_genapic)
 					x86_quirks->update_genapic();
