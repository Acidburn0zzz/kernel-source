Date: Mon, 3 May 2004 07:19:59 +1000
From: Anton Blanchard <anton@samba.org>
To: olh@suse.de
Subject: enable stack overflow on pseries


This for LTC bug #8089.

--- linux-2.6.5/arch/ppc64/kernel/irq.c~	2004-05-02 16:08:57.380062434 -0500
+++ linux-2.6.5/arch/ppc64/kernel/irq.c	2004-05-02 16:10:21.254560881 -0500
@@ -624,6 +624,21 @@
 
 	irq_enter();
 
+#ifdef CONFIG_DEBUG_STACKOVERFLOW
+	/* Debugging check for stack overflow: is there less than 4KB free? */
+	{
+		long sp;
+
+		sp = __get_SP() & (THREAD_SIZE-1);
+
+		if (unlikely(sp < (sizeof(struct thread_info) + 4096))) {
+			printk("do_IRQ: stack overflow: %ld\n",
+				sp - sizeof(struct thread_info));
+			dump_stack();
+		}
+	}
+#endif
+
 	/*
 	 * Every arch is required to implement ppc_md.get_irq.
 	 * This function will either return an irq number or -1 to

