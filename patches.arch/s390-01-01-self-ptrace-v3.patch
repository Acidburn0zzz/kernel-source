From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: [s390] system call notification with self_ptrace
References: bnc#417299

Implement PTRACE SELF for s390. See patches.suse/self-ptrace.patch
for more documentation.

Signed-off-by: Pierre Morel <pmorel@fr.ibm.com>
Signed-off-by: Volker Sameske <sameske@de.ibm.com>

Acked-by: John Jolly <jjolly@suse.de>
---

 arch/s390/kernel/ptrace.c |   16 ++++++++++++++++
 arch/s390/kernel/signal.c |    5 +++++
 2 files changed, 21 insertions(+)

--- linux-2.6.26.orig/arch/s390/kernel/ptrace.c	2008-09-26 10:23:31.000000000 +0200
+++ linux-2.6.26/arch/s390/kernel/ptrace.c	2008-09-26 10:24:53.000000000 +0200
@@ -647,6 +647,22 @@ syscall_trace(struct pt_regs *regs, int 
 
 	if (!test_thread_flag(TIF_SYSCALL_TRACE))
 		goto out;
+
+	if (is_self_ptracing(regs->gprs[2])) {
+		if (!entryexit) {
+			struct siginfo info;
+
+			memset(&info, 0, sizeof(struct siginfo));
+			info.si_signo = SIGSYS;
+			info.si_code = SYS_SYSCALL;
+			info.si_errno = regs->gprs[2];
+			info.si_addr = (void *)regs->orig_gpr2;
+			send_sig_info(SIGSYS, &info, current);
+			regs->gprs[2] = -1;
+		}
+		return;
+	}
+
 	if (!(current->ptrace & PT_PTRACED))
 		goto out;
 	ptrace_notify(SIGTRAP | ((current->ptrace & PT_TRACESYSGOOD)
--- linux-2.6.26.orig/arch/s390/kernel/signal.c	2008-09-26 10:23:31.000000000 +0200
+++ linux-2.6.26/arch/s390/kernel/signal.c	2008-09-26 10:24:53.000000000 +0200
@@ -409,6 +409,11 @@ handle_signal(unsigned long sig, struct 
 		spin_unlock_irq(&current->sighand->siglock);
 	}
 
+	if (current->instrumentation) {
+		clear_thread_flag(TIF_SYSCALL_TRACE);
+		current->instrumentation &= ~PTS_SELF;
+	}
+
 	return ret;
 }
 
