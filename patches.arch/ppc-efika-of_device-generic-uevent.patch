Subject: Add a unified uevent handler for bus based on of_device
From: Sylvain Munaut <tnt@246tNt.com>

This common uevent handler allow the several bus types based on
of_device to generate the uevent properly and avoiding
code duplication.

This handlers take a struct device as argument and can therefore
be used as the uevent call directly if no special treatment is
needed for the bus.

Signed-off-by: Sylvain Munaut <tnt@246tNt.com>
Signed-off-by: Olaf Hering <olh@suse.de>

---
 arch/powerpc/kernel/ibmebus.c |   18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

--- a/arch/powerpc/kernel/ibmebus.c	2007-10-31 17:43:32.000000000 -0400
+++ b/arch/powerpc/kernel/ibmebus.c	2007-10-31 17:43:53.000000000 -0400
@@ -449,11 +449,27 @@ static struct bus_attribute ibmebus_bus_
 	__ATTR_NULL
 };
 
+static int ibmebus_bus_uevent(struct device *dev,
+		char **envp, int num_envp, char *buffer, int buffer_size)
+{
+	struct ibmebus_dev *ebus_dev;
+
+	if (!dev)
+		return -ENODEV;
+
+	ebus_dev = to_ibmebus_dev(dev);
+	if (ebus_dev==&ibmebus_bus_device)	/* filter dummy root device */
+		return -ENODEV;
+
+	return of_device_uevent(dev, envp, num_envp, buffer, buffer_size);
+}
+
 struct bus_type ibmebus_bus_type = {
 	.name      = "ibmebus",
 	.match     = ibmebus_bus_match,
 	.dev_attrs = ibmebus_dev_attrs,
-	.bus_attrs = ibmebus_bus_attrs
+	.bus_attrs = ibmebus_bus_attrs,
+	.uevent    = ibmebus_bus_uevent,
 };
 EXPORT_SYMBOL(ibmebus_bus_type);
 
