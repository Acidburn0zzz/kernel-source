From: jschoenh@amazon.de
Date: Thu, 7 Sep 2017 19:02:48 +0100
Subject: [PATCH 2/2] KVM: Don't accept obviously wrong gsi values via
 KVM_IRQFD
Patch-mainline: Not yet, CVE fix
References: bsc#1058038, CVE-2017-1000252

We cannot add routes for gsi values >= KVM_MAX_IRQ_ROUTES -- see
kvm_set_irq_routing(). Hence, there is no sense in accepting them
via KVM_IRQFD. Prevent them from entering the system in the first
place.

Signed-off-by: Jan H. Sch√∂nherr <jschoenh@amazon.de>
Acked-by: Joerg Roedel <jroedel@suse.de>
---
 virt/kvm/eventfd.c | 2 ++
 1 file changed, 2 insertions(+)

--- a/virt/kvm/eventfd.c
+++ b/virt/kvm/eventfd.c
@@ -565,6 +565,8 @@ kvm_irqfd(struct kvm *kvm, struct kvm_ir
 {
 	if (args->flags & ~(KVM_IRQFD_FLAG_DEASSIGN | KVM_IRQFD_FLAG_RESAMPLE))
 		return -EINVAL;
+	if (args->gsi >= KVM_MAX_IRQ_ROUTES)
+		return -EINVAL;
 
 	if (args->flags & KVM_IRQFD_FLAG_DEASSIGN)
 		return kvm_irqfd_deassign(kvm, args);
--- a/include/linux/kvm_host.h
+++ b/include/linux/kvm_host.h
@@ -1017,8 +1017,6 @@ static inline int mmu_notifier_retry(str
 }
 #endif
 
-#ifdef CONFIG_HAVE_KVM_IRQ_ROUTING
-
 #ifdef CONFIG_S390
 #define KVM_MAX_IRQ_ROUTES 4096 //FIXME: we can have more than that...
 #elif defined(CONFIG_ARM64)
@@ -1027,6 +1025,8 @@ static inline int mmu_notifier_retry(str
 #define KVM_MAX_IRQ_ROUTES 1024
 #endif
 
+#ifdef CONFIG_HAVE_KVM_IRQ_ROUTING
+
 bool kvm_arch_can_set_irq_routing(struct kvm *kvm);
 int kvm_set_irq_routing(struct kvm *kvm,
 			const struct kvm_irq_routing_entry *entries,
