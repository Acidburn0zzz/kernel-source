Subject: [PATCH] allow xmon=bt to print a backtrace by default                                                                                                       
From: Olaf Hering <olh@suse.de>                                                                                                                                      

xmon does not print a backtrace per default. This is bad on systems with 
USB keyboard, the most needed info about the crash is lost.
print a backtrace during the very first xmon entry.

Booting with xmon=nobt disables the autobacktrace functionality.

Signed-off-by: Olaf Hering <olh@suse.de>

 arch/ppc64/Kconfig.debug  |    2 ++
 arch/ppc64/kernel/setup.c |    4 ++++
 arch/ppc64/xmon/xmon.c    |    7 +++++++
 3 files changed, 13 insertions(+)

Index: linux-2.6.12/arch/ppc64/Kconfig.debug
===================================================================
--- linux-2.6.12.orig/arch/ppc64/Kconfig.debug
+++ linux-2.6.12/arch/ppc64/Kconfig.debug
@@ -47,6 +47,8 @@ config XMON
 	  The cmdline option 'xmon' or 'xmon=early' will drop into xmon very
 	  early during boot. 'xmon=on' will just enable the xmon debugger hooks.
 	  'xmon=off' will disable the debugger hooks if CONFIG_XMON_DEFAULT is set.
+	  xmon will print a backtrace on the very first invocation. 'xmon=nobt' will
+	  disable this autobacktrace.
 
 config XMON_DEFAULT
 	bool "Enable xmon by default"
Index: linux-2.6.12/arch/ppc64/kernel/setup.c
===================================================================
--- linux-2.6.12.orig/arch/ppc64/kernel/setup.c
+++ linux-2.6.12/arch/ppc64/kernel/setup.c
@@ -92,6 +92,8 @@ extern void udbg_init_maple_realmode(voi
 	do { ppc_md.udbg_putc = call_rtas_display_status_delay; } while(0)
 #endif
 
+extern int xmon_no_auto_backtrace;
+
 /* extern void *stab; */
 extern unsigned long klimit;
 
@@ -1353,6 +1355,8 @@ static int __init early_xmon(char *p)
 			xmon_init(1);
 		if (strncmp(p, "off", 3) == 0)
 			xmon_init(0);
+		if (strncmp(p, "nobt", 4) == 0)
+			xmon_no_auto_backtrace = 1;
 		if (strncmp(p, "early", 5) != 0)
 			return 0;
 	}
Index: linux-2.6.12/arch/ppc64/xmon/xmon.c
===================================================================
--- linux-2.6.12.orig/arch/ppc64/xmon/xmon.c
+++ linux-2.6.12/arch/ppc64/xmon/xmon.c
@@ -132,12 +132,15 @@ static void csum(void);
 static void bootcmds(void);
 void dump_segments(void);
 static void symbol_lookup(void);
+static void xmon_show_stack(unsigned long sp, unsigned long lr, unsigned long pc);
 static void xmon_print_symbol(unsigned long address, const char *mid,
 			      const char *after);
 static const char *getvecname(unsigned long vec);
 
 static void debug_trace(void);
 
+int xmon_no_auto_backtrace;
+
 extern int print_insn_powerpc(unsigned long, unsigned long, int);
 extern void printf(const char *fmt, ...);
 extern void xmon_vfprintf(void *f, const char *fmt, va_list ap);
@@ -771,6 +774,10 @@ cmds(struct pt_regs *excp)
 
 	last_cmd = NULL;
 	xmon_regs = excp;
+
+	if (!xmon_no_auto_backtrace++)
+		xmon_show_stack(excp->gpr[1], excp->link, excp->nip);
+
 	for(;;) {
 #ifdef CONFIG_SMP
 		printf("%x:", smp_processor_id());
