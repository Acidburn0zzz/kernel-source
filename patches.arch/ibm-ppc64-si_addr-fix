ChangeSet
  1.1713.17.14 04/04/12 12:41:57 akpm@osdl.org[torvalds] +1 -0
  [PATCH] ppc64: si_addr fix
  
  From: Benjamin Herrenschmidt <benh@kernel.crashing.org>
  
  This patch fixes si_addr on some segfaults in 64 bits mode, it used to be
  bogus (address not passed to do_page_fault by the asm code after a failure
  to set an SLB entry).

  arch/ppc64/kernel/head.S
    1.52 04/04/12 10:54:01 akpm@osdl.org[torvalds] +2 -0
    ppc64: si_addr fix

diff -Nru a/arch/ppc64/kernel/head.S b/arch/ppc64/kernel/head.S
--- a/arch/ppc64/kernel/head.S	Tue Apr 13 07:19:45 2004
+++ b/arch/ppc64/kernel/head.S	Tue Apr 13 07:19:45 2004
@@ -767,6 +767,7 @@
 	beq     fast_exception_return   /* Return if we succeeded */
 	addi	r3,r1,STACK_FRAME_OVERHEAD
 	DO_COPY_EE()
+	ld      r4,_DAR(r1)
 	li	r6,0x380
 	li	r5,0
 	bl      .save_remaining_regs
@@ -810,6 +811,7 @@
 
 	addi	r3,r1,STACK_FRAME_OVERHEAD
 	DO_COPY_EE()
+	mr      r4,r22                  /* SRR0 = NIA        */
 	li	r6,0x480
 	li	r5,0
 	bl      .save_remaining_regs
.........................................................................
# vim: syntax=diff

