- Description: Kernel: Lost dirty bits.
  Symptom:     Data corruption under memory pressure.
  Problem:     The hardware dirty bit is cleared everytime SetPageUptodate
               is called. The common memory management code calls the
               function even if the page already is up to date. In this
               case the dirty bit may not be cleared because the page
               is potentially mapped writable in some user process which
               could have written to the page since the last writeback.
  Solution:    Add a check to arch_set_page_uptodate to skip the clearing
               of the dirty if if the page is already up to date.
  Problem-ID:  8165
  Archs:       s390-31, s390-64

--- linux-2.5/include/asm-s390/pgtable.h	24 Mar 2004 18:18:22 -0000	1.23
+++ linux-2.5/include/asm-s390/pgtable.h	15 Jun 2004 16:43:35 -0000	1.23.2.1
@@ -652,7 +652,8 @@
 
 #define arch_set_page_uptodate(__page)					  \
 	do {								  \
-		asm volatile ("sske %0,%1" : : "d" (0),			  \
+		if (!PageUptodate(__page))				  \
+			asm volatile ("sske %0,%1" : : "d" (0),		  \
 			      "a" (__pa((__page-mem_map) << PAGE_SHIFT)));\
 	} while (0)
 

