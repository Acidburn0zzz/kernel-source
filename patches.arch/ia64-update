# This is a BitKeeper generated patch for the following project:
# Project Name: Linux kernel tree
# This patch format is intended for GNU patch command version 2.5 or higher.
# This patch includes the following deltas:
#	           ChangeSet	1.1352  -> 1.1356 
#	arch/i386/kernel/process.c	1.51.1.6 -> 1.57   
#	include/asm-x86_64/agp.h	1.2     -> 1.4    
#	arch/ppc64/kernel/signal.c	1.28    -> 1.29   
#	drivers/input/serio/i8042-io.h	1.4.1.1 -> 1.6    
#	include/asm-parisc/unistd.h	1.8.1.1 -> 1.11   
#	arch/sparc/kernel/module.c	1.11    -> 1.12   
#	include/asm-ppc64/page.h	1.19.1.1 -> 1.22   
#	include/asm-i386/agp.h	1.1.1.1 -> 1.4    
#	include/asm-generic/sections.h	1.2     -> 1.3    
#	arch/alpha/kernel/module.c	1.5     -> 1.6    
#	include/asm-ppc64/unistd.h	1.20.1.2 -> 1.26   
#	arch/ppc64/kernel/entry.S	1.26.1.1 -> 1.29   
#	include/asm-mips/unistd.h	1.6.1.2 -> 1.10   
#	include/asm-alpha/agp.h	1.2     -> 1.4    
#	         fs/select.c	1.20.1.1 -> 1.22   
#	include/linux/timex.h	1.5.1.4 -> 1.12   
#	include/asm-alpha/hw_irq.h	1.2     -> 1.4    
#	  include/linux/mm.h	1.121.1.12 -> 1.127  
#	include/linux/init.h	1.26.1.1 -> 1.28   
#	arch/arm/kernel/module.c	1.7     -> 1.8    
#	drivers/serial/8250.c	1.34.1.7 -> 1.38   
#	include/asm-ia64/io.h	1.13.1.5 -> 1.20   
#	arch/ppc64/kernel/udbg.c	1.8     -> 1.10   
#	include/asm-ppc64/processor.h	1.30.1.3 -> 1.34   
#	include/asm-i386/ptrace.h	1.5     -> 1.7    
#	include/asm-sparc/unistd.h	1.20.1.6 -> 1.26   
#	 arch/ia64/defconfig	1.19.1.1 -> 1.21   
#	drivers/char/drm/i830_dma.c	1.18.1.1 -> 1.20   
#	include/linux/sched.h	1.151.1.22 -> 1.163  
#	       kernel/fork.c	1.124.1.21 -> 1.133  
#	net/sunrpc/svcsock.c	1.62    -> 1.63   
#	include/asm-ppc64/module.h	1.4     -> 1.6    
#	        kernel/sys.c	1.43.1.24 -> 1.54   
#	     kernel/sysctl.c	1.46.1.9 -> 1.52   
#	include/asm-ppc64/thread_info.h	1.7.1.2 -> 1.10   
#	include/asm-ppc64/ucontext.h	1.3     -> 1.5    
#	include/asm-sparc64/agp.h	1.1     -> 1.3    
#	arch/ppc64/kernel/chrp_setup.c	1.29.1.2 -> 1.33   
#	include/asm-i386/thread_info.h	1.11.1.2 -> 1.14   
#	arch/ppc64/kernel/rtas.c	1.11.1.1 -> 1.14   
#	drivers/char/drm/r128_cce.c	1.12.1.3 -> 1.16   
#	drivers/char/drm/drm_memory_debug.h	1.1.1.4 -> 1.5    
#	include/asm-sparc64/unistd.h	1.19.1.6 -> 1.25   
#	arch/i386/kernel/traps.c	1.52.1.11 -> 1.59   
#	drivers/char/drm/drm_memory.h	1.8.1.6 -> 1.13   
#	arch/i386/kernel/Makefile	1.44.1.8 -> 1.50   
#	drivers/char/drm/radeon_cp.c	1.20.1.1 -> 1.22   
#	include/asm-ppc/unistd.h	1.23.1.3 -> 1.27   
#	include/asm-ia64/sn/nodepda.h	1.10    -> 1.11   
#	include/asm-ppc64/sigcontext.h	1.4     -> 1.6    
#	include/linux/serial.h	1.8.1.1 -> 1.10   
#	include/asm-ppc/pgtable.h	1.23.1.3 -> 1.26   
#	include/asm-ppc/thread_info.h	1.7.1.3 -> 1.11   
#	       kernel/time.c	1.11.1.7 -> 1.19   
#	drivers/char/drm/drm_bufs.h	1.14.1.2 -> 1.17   
#	drivers/serial/serial_core.c	1.72    -> 1.73   
#	    kernel/softirq.c	1.39.1.8 -> 1.44   
#	arch/ppc64/kernel/LparData.c	1.9     -> 1.11   
#	drivers/net/tulip/media.c	1.11    -> 1.12   
#	arch/ppc/kernel/module.c	1.9.1.1 -> 1.11   
#	drivers/acpi/pci_root.c	1.13.1.3 -> 1.17   
#	include/asm-ppc64/types.h	1.3     -> 1.5    
#	arch/ia64/sn/io/machvec/pci_dma.c	1.16    -> 1.17   
#	include/asm-ia64/pgtable.h	1.30    -> 1.32   
#	arch/ppc64/kernel/ras.c	1.5     -> 1.7    
#	include/asm-parisc/thread_info.h	1.2.1.1 -> 1.4    
#	include/asm-um/thread_info.h	1.3.1.1 -> 1.5    
#	drivers/char/drm/i810_dma.c	1.26.1.4 -> 1.31   
#	include/asm-h8300/thread_info.h	1.1.1.2 -> 1.4    
#	include/linux/nfs_fs.h	1.45.1.7 -> 1.50   
#	drivers/media/video/Makefile	1.18.1.3 -> 1.22   
#	include/asm-v850/thread_info.h	1.2.1.1 -> 1.4    
#	include/asm-ppc64/proc_fs.h	1.2     -> 1.4    
#	           mm/swap.c	1.52.1.1 -> 1.55   
#	drivers/acpi/tables.c	1.14.1.2 -> 1.18   
#	include/linux/pci_ids.h	1.103.1.20 -> 1.110  
#	 include/linux/irq.h	1.6.1.3 -> 1.12   
#	include/linux/moduleloader.h	1.6     -> 1.7    
#	include/asm-alpha/unistd.h	1.18.1.4 -> 1.23   
#	include/asm-m68knommu/thread_info.h	1.2.1.1 -> 1.4    
#	arch/ppc64/kernel/irq.c	1.30.1.6 -> 1.34   
#	drivers/acpi/pci_irq.c	1.16.1.6 -> 1.23   
#	         mm/memory.c	1.123.1.17 -> 1.135  
#	include/linux/moduleparam.h	1.3.1.1 -> 1.5    
#	arch/ppc64/kernel/rtas-proc.c	1.6     -> 1.8    
#	arch/ppc64/kernel/setup.c	1.28.1.3 -> 1.32   
#	 include/linux/pci.h	1.90.1.18 -> 1.98   
#	include/asm-arm/thread_info.h	1.6.1.2 -> 1.9    
#	arch/ia64/kernel/process.c	1.39.1.10 -> 1.50   
#	include/asm-m68k/unistd.h	1.8     -> 1.10   
#	arch/i386/kernel/module.c	1.11    -> 1.12   
#	drivers/serial/Makefile	1.14.1.6 -> 1.22   
#	include/asm-ppc64/naca.h	1.6     -> 1.8    
#	include/asm-h8300/unistd.h	1.1.1.1 -> 1.4    
#	include/linux/acpi_serial.h	1.2.1.1 -> 1.4    
#	  drivers/char/mem.c	1.42.1.3 -> 1.46   
#	arch/ppc64/kernel/traps.c	1.19.1.1 -> 1.21   
#	include/asm-m68knommu/unistd.h	1.2     -> 1.4    
#	arch/ppc64/kernel/head.S	1.36.1.3 -> 1.40   
#	kernel/posix-timers.c	1.19.1.2 -> 1.22   
#	include/asm-ppc64/xics.h	1.5     -> 1.7    
#	include/linux/sunrpc/svc.h	1.20.1.5 -> 1.26   
#	include/linux/sysctl.h	1.47.1.5 -> 1.52   
#	arch/ppc64/kernel/xics.c	1.25.1.3 -> 1.28   
#	   drivers/net/tg3.c	1.72.1.36 -> 1.79   
#	arch/ia64/ia32/ia32_entry.S	1.30    -> 1.31   
#	 include/linux/smp.h	1.22.1.4 -> 1.25   
#	        usr/Makefile	1.6.1.3 -> 1.10   
#	arch/v850/kernel/module.c	1.5     -> 1.6    
#	arch/ia64/kernel/signal.c	1.35    -> 1.36   
#	drivers/media/radio/Makefile	1.9     -> 1.10   
#	arch/ppc64/mm/init.c	1.46.1.7 -> 1.54   
#	arch/ppc64/kernel/htab.c	1.34.1.2 -> 1.37   
#	arch/ppc64/kernel/open_pic.c	1.15.1.1 -> 1.17   
#	drivers/char/agp/i460-agp.c	1.25.1.4 -> 1.31   
#	arch/ppc64/kernel/process.c	1.35.1.6 -> 1.40   
#	arch/ppc64/kernel/pci_dma.c	1.16.1.1 -> 1.18   
#	           mm/mmap.c	1.85.1.8 -> 1.91   
#	      fs/proc/base.c	1.42.1.17 -> 1.51   
#	include/linux/time.h	1.16.1.5 -> 1.20   
#	arch/sparc64/kernel/module.c	1.14.1.2 -> 1.16   
#	arch/ppc64/kernel/open_pic_defs.h	1.2     -> 1.4    
#	include/asm-i386/unistd.h	1.25.1.5 -> 1.31   
#	sound/oss/cs4281/cs4281pm-24.c	1.3.1.1 -> 1.5    
#	arch/ppc64/kernel/asm-offsets.c	1.14.1.1 -> 1.17   
#	include/asm-m68k/thread_info.h	1.4.1.1 -> 1.6    
#	            Makefile	1.410.1.27 -> 1.424  
#	          fs/fcntl.c	1.28.1.3 -> 1.31   
#	include/asm-s390/thread_info.h	1.4.1.1 -> 1.6    
#	include/asm-x86_64/unistd.h	1.14.1.4 -> 1.20   
#	include/asm-ppc64/mmu.h	1.7.1.1 -> 1.10   
#	arch/ppc64/mm/numa.c	1.7.1.5 -> 1.11   
#	drivers/char/agp/backend.c	1.83.1.7 -> 1.87   
#	arch/ppc64/kernel/syscalls.c	1.11.1.2 -> 1.15   
#	include/asm-x86_64/thread_info.h	1.12.1.1 -> 1.14   
#	include/asm-ppc64/ptrace.h	1.2     -> 1.4    
#	arch/ppc64/kernel/sys_ppc32.c	1.66.1.5 -> 1.69   
#	  arch/ia64/mm/tlb.c	1.19    -> 1.20   
#	include/asm-sparc64/thread_info.h	1.10.1.2 -> 1.13   
#	arch/ppc64/kernel/prom.c	1.28.1.3 -> 1.33   
#	     kernel/module.c	1.86.1.8 -> 1.94   
#	include/asm-x86_64/pgtable.h	1.21.1.2 -> 1.24   
#	arch/ppc64/kernel/iSeries_setup.c	1.15.1.1 -> 1.18   
#	arch/ia64/kernel/perfmon_mckinley.h	1.9     -> 1.10   
#	arch/ppc64/kernel/smp.c	1.40.1.2 -> 1.43   
#	drivers/char/drm/drmP.h	1.23.1.6 -> 1.28   
#	include/asm-i386/pgtable.h	1.35.1.3 -> 1.39   
#	net/ipv4/tcp_input.c	1.39.1.7 -> 1.44   
#	arch/ppc64/mm/fault.c	1.10.1.2 -> 1.14   
#	include/linux/highmem.h	1.25.1.2 -> 1.28   
#	arch/ppc64/kernel/pacaData.c	1.7.1.2 -> 1.11   
#	           mm/slab.c	1.93.1.17 -> 1.102  
#	include/linux/module.h	1.66.1.2 -> 1.70   
#	      kernel/sched.c	1.193.1.29 -> 1.205  
#	drivers/char/agp/hp-agp.c	1.24.1.3 -> 1.30   
#	  drivers/acpi/osl.c	1.37.1.5 -> 1.43   
#	 include/linux/jbd.h	1.21.1.17 -> 1.25   
#	drivers/char/drm/drm_drv.h	1.20.1.6 -> 1.26   
#	arch/alpha/kernel/traps.c	1.24.1.3 -> 1.28   
#	      kernel/timer.c	1.59.1.13 -> 1.70   
#	drivers/scsi/sym53c8xx_2/sym_malloc.c	1.2     -> 1.4    
#	arch/ppc64/xmon/xmon.c	1.26.1.3 -> 1.30   
#	arch/ppc64/kernel/pci.c	1.33.1.2 -> 1.37   
#	include/asm-sh/unistd.h	1.5.1.1 -> 1.8    
#	include/asm-m68k/pgtable.h	1.8.1.1 -> 1.10   
#	arch/ppc64/kernel/misc.S	1.62.1.2 -> 1.64   
#	drivers/char/drm/mga_dma.c	1.13.1.1 -> 1.15   
#	arch/ia64/kernel/irq.c	1.30    -> 1.31   
#	arch/s390/kernel/module.c	1.8.1.2 -> 1.11   
#	drivers/char/drm/mga_drv.h	1.13.1.1 -> 1.15   
#	arch/x86_64/kernel/module.c	1.9.1.2 -> 1.12   
#	arch/arm/kernel/process.c	1.28.1.4 -> 1.31   
#	include/linux/percpu.h	1.5.1.2 -> 1.7    
#	include/asm-alpha/thread_info.h	1.5.1.1 -> 1.7    
#	arch/ppc64/kernel/signal32.c	1.40    -> 1.42   
#	include/asm-cris/unistd.h	1.10.1.1 -> 1.13   
#	drivers/serial/Kconfig	1.8.1.11 -> 1.17   
#	drivers/char/drm/gamma_dma.c	1.12.1.4 -> 1.16   
#	arch/ppc64/kernel/rtas_flash.c	1.5     -> 1.7    
#	    net/sunrpc/svc.c	1.21.1.1 -> 1.23   
#	include/linux/irq_cpustat.h	1.7.1.3 -> 1.10   
#	arch/ia64/kernel/perfmon.c	1.65    -> 1.67   
#	include/asm-arm/unistd.h	1.16.1.2 -> 1.20   
#	   arch/ia64/Kconfig	1.38.1.10 -> 1.46   
#	include/asm-ppc64/pgtable.h	1.23.1.3 -> 1.26   
#	include/asm-ppc64/mmzone.h	1.11.1.2 -> 1.14   
#	include/asm-sparc/thread_info.h	1.4.1.1 -> 1.6    
#	include/asm-ppc64/io.h	1.8.1.1 -> 1.11   
#	drivers/video/radeonfb.c	1.26.1.4 -> 1.29   
#	include/asm-v850/unistd.h	1.6     -> 1.8    
#	include/asm-ppc64/topology.h	1.8.1.1 -> 1.10   
#	   kernel/kallsyms.c	1.11.1.3 -> 1.15   
#	arch/ppc64/kernel/Makefile	1.27.1.1 -> 1.30   
#	arch/ppc64/kernel/module.c	1.6     -> 1.7    
#	include/asm-ppc64/rtas.h	1.6.1.1 -> 1.9    
#	include/asm-i386/hw_irq.h	1.21.1.4 -> 1.27   
#	sound/oss/cs4281/cs4281m.c	1.21.1.6 -> 1.26   
#	arch/ppc64/kernel/align.c	1.10    -> 1.11   
#	     kernel/printk.c	1.25.1.3 -> 1.30   
#	arch/ppc64/kernel/ioctl32.c	1.35.1.3 -> 1.39   
#	drivers/scsi/qla1280.c	1.38.1.12 -> 1.43   
#	arch/ppc64/kernel/pSeries_lpar.c	1.21.1.1 -> 1.24   
#	drivers/char/drm/drm_vm.h	1.23.1.2 -> 1.26   
#	include/asm-s390/unistd.h	1.16.1.1 -> 1.19   
#	arch/parisc/kernel/module.c	1.5.1.3 -> 1.8    
#	drivers/scsi/sym53c8xx_2/sym_glue.c	1.23.1.15 -> 1.29   
#	               (new)	        -> 1.1     drivers/media/video/dummy.c
#	               (new)	        -> 1.1     drivers/media/radio/dummy.c
#
# The following is the BitKeeper ChangeSet Log
# --------------------------------------------
# 03/10/27	eranian@hpl.hp.com	1.1337.44.17
# [PATCH] ia64: fix perfmon UP breakage
# 
# --------------------------------------------
# 03/10/27	davidm@tiger.hpl.hp.com	1.1337.43.12
# Merge tiger.hpl.hp.com:/data1/bk/lia64/to-linus-2.5
# into tiger.hpl.hp.com:/data1/bk/lia64/linux-ia64-2.5
# --------------------------------------------
# 03/10/27	davidm@tiger.hpl.hp.com	1.1353
# Merge tiger.hpl.hp.com:/data1/bk/vanilla/linux-2.6.0-test9
# into tiger.hpl.hp.com:/data1/bk/lia64/to-linus-2.5
# --------------------------------------------
# 03/10/27	davidm@tiger.hpl.hp.com	1.1354
# Merge tiger.hpl.hp.com:/data1/bk/lia64/to-linus-2.5
# into tiger.hpl.hp.com:/data1/bk/lia64/linux-ia64-2.5
# --------------------------------------------
# 03/10/27	eranian@hpl.hp.com	1.1353.1.1
# [PATCH] ia64: fix 2 more perfmon2 bugs
# 
# Here is the minimal patch that fixes things that do not work and that
# can be noticed fairly easily:
# 
#         - remove a typo in pfm_check_task_state() which causes
#           PFM_READ_PMDS to fail when context is in  PFM_MASKED state.
# 
#         - fix a typo in perfmon_mcklinley.h when checking the value
#           combinations for when writing to PMC14. This could reject a
#           valid request to program PMC14.
# --------------------------------------------
# 03/11/03	ajm@sgi.com	1.1353.1.2
# [PATCH] ia64: fix bug in SN2 sn_pci_map_sg that causes MCA
# 
# If sg->dma_address is set, we try to do a __pa() on a dma_address,
# then, later, create a dma_addresss from a munged dma_address.  When
# this bogus dma_address is used by the card, it results in MCAs.
# --------------------------------------------
# 03/11/03	kochi@hpc.bs1.fc.nec.co.jp	1.1353.1.3
# [PATCH] ia64: don't access per-CPU data of off-line CPUs
# 
# This patch prevents a crash that happens when per-CPU data is allocated
# only for CPUs that are online.
# --------------------------------------------
# 03/11/10	davidm@tiger.hpl.hp.com	1.1353.1.4
# Fix pte_modify() bug which allowed mprotect() to change too many bits.
# Found by Russell King.
# --------------------------------------------
# 03/11/10	davidm@tiger.hpl.hp.com	1.1355
# Merge tiger.hpl.hp.com:/data1/bk/lia64/to-linus-2.5
# into tiger.hpl.hp.com:/data1/bk/lia64/linux-ia64-2.5
# --------------------------------------------
# 03/11/10	pj@sgi.com	1.1353.1.5
# [PATCH] ia64: fix bug in prof_cpu_mask_read_proc()
# 
# Display of cpumask for /proc/irq/prof_cpu_mask has a botch in the print
# loop - should consume 2 bytes per loop.
# --------------------------------------------
# 03/11/10	davidm@tiger.hpl.hp.com	1.1353.1.6
# ia64: Fix _PAGE_CHG_MASK so PROT_NONE works again.  Caught by Linus.
# --------------------------------------------
# 03/11/11	steiner@sgi.com	1.1353.1.7
# [PATCH] ia64: fix is_headless_node() for SN
# 
# Without this patch, SN machines which have nodes that contain memory only (no
# CPUs will hang.
# --------------------------------------------
# 03/11/11	davidm@wailua.hpl.hp.com	1.1353.1.8
# ia64: From Linus: Always disable system call restart when invoking a
# 	signal handler.  Otherwise, a restarted system call that gets
# 	interrupted before the restart has taken effect by _another_
# 	signal will potentially restart the wrong system call.
# --------------------------------------------
# 03/11/13	arun.sharma@intel.com	1.1353.1.9
# [PATCH] ia64: invoking schedule_tail unconditionally on ia32
# 
# The #ifdef CONFIG_SMP around the call to schedule_tail was removed a long
# time ago for native ia64, but ia32 continues to have a #ifdef. We saw a bunch
# of weird behavior with respect to getpid() on multithreaded programs (they
# behave ok on SMP, but break on UP).
# --------------------------------------------
# 03/11/13	davidm@tiger.hpl.hp.com	1.1356
# Merge tiger.hpl.hp.com:/data1/bk/lia64/to-linus-2.5
# into tiger.hpl.hp.com:/data1/bk/lia64/linux-ia64-2.5
# --------------------------------------------
#
diff -Nru a/arch/ia64/Kconfig b/arch/ia64/Kconfig
--- a/arch/ia64/Kconfig	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/Kconfig	Fri Nov 14 00:38:53 2003
@@ -621,6 +621,33 @@
 	  keys are documented in <file:Documentation/sysrq.txt>. Don't say Y
 	  unless you really know what this hack does.
 
+config IA64_EARLY_PRINTK
+	bool "Early printk support"
+	depends on DEBUG_KERNEL && !IA64_GENERIC
+	help
+	  Selecting this option uses the VGA screen or serial console for
+	  printk() output before the consoles are initialised.  It is useful
+	  for debugging problems early in the boot process, but only if you
+	  have a suitable VGA/serial console attached.  If you're unsure,
+	  select N.
+
+config IA64_EARLY_PRINTK_UART
+	bool "Early printk on MMIO serial port"
+	depends on IA64_EARLY_PRINTK
+
+config IA64_EARLY_PRINTK_UART_BASE
+	hex "UART MMIO base address"
+	depends on IA64_EARLY_PRINTK_UART
+	default "ff5e0000"
+
+config IA64_EARLY_PRINTK_VGA
+	bool "Early printk on VGA"
+	depends on IA64_EARLY_PRINTK
+
+config IA64_EARLY_PRINTK_SGI_SN
+	bool "Early printk on SGI SN serial console"
+	depends on IA64_EARLY_PRINTK && (IA64_GENERIC || IA64_SGI_SN2)
+
 config DEBUG_SLAB
 	bool "Debug memory allocations"
 	depends on DEBUG_KERNEL
diff -Nru a/arch/ia64/ia32/ia32_entry.S b/arch/ia64/ia32/ia32_entry.S
--- a/arch/ia64/ia32/ia32_entry.S	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/ia32/ia32_entry.S	Fri Nov 14 00:38:53 2003
@@ -90,7 +90,6 @@
 
 GLOBAL_ENTRY(ia32_ret_from_clone)
 	PT_REGS_UNWIND_INFO(0)
-#if defined(CONFIG_SMP) || defined(CONFIG_PREEMPT)
 {	/*
 	 * Some versions of gas generate bad unwind info if the first instruction of a
 	 * procedure doesn't go into the first slot of a bundle.  This is a workaround.
@@ -105,7 +104,6 @@
 	br.call.sptk.many rp=ia64_invoke_schedule_tail
 }
 .ret1:
-#endif
 	adds r2=TI_FLAGS+IA64_TASK_SIZE,r13
 	;;
 	ld4 r2=[r2]
diff -Nru a/arch/ia64/kernel/irq.c b/arch/ia64/kernel/irq.c
--- a/arch/ia64/kernel/irq.c	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/kernel/irq.c	Fri Nov 14 00:38:53 2003
@@ -1039,7 +1039,7 @@
 	if (count < HEX_DIGITS+1)
 		return -EINVAL;
 
-	for (k = 0; k < sizeof(cpumask_t)/sizeof(unsigned long); ++k) {
+	for (k = 0; k < sizeof(cpumask_t)/sizeof(u16); ++k) {
 		int j = sprintf(page, "%04hx", (u16)cpus_coerce(*mask));
 		len += j;
 		page += j;
diff -Nru a/arch/ia64/kernel/perfmon.c b/arch/ia64/kernel/perfmon.c
--- a/arch/ia64/kernel/perfmon.c	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/kernel/perfmon.c	Fri Nov 14 00:38:53 2003
@@ -4717,7 +4717,7 @@
 	/*
 	 * context is UNLOADED, MASKED, TERMINATED we are safe to go
 	 */
-	if (state != PFM_CTX_LOADED == 0) return 0;
+	if (state != PFM_CTX_LOADED) return 0;
 
 	if (state == PFM_CTX_ZOMBIE) return -EINVAL;
 
@@ -5787,7 +5787,7 @@
 	 */
 	psr = pfm_get_psr();
 
-	BUG_ON(foo & (IA64_PSR_I));
+	BUG_ON(psr & (IA64_PSR_I));
 
 	/*
 	 * stop monitoring:
diff -Nru a/arch/ia64/kernel/perfmon_mckinley.h b/arch/ia64/kernel/perfmon_mckinley.h
--- a/arch/ia64/kernel/perfmon_mckinley.h	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/kernel/perfmon_mckinley.h	Fri Nov 14 00:38:53 2003
@@ -167,7 +167,7 @@
 			 val14 = ctx->ctx_pmcs[14];
 			 check_case1 = 1;
 			 break;
-		case 14: val8  = ctx->ctx_pmcs[13];
+		case 14: val8  = ctx->ctx_pmcs[8];
 			 val13 = ctx->ctx_pmcs[13];
 			 val14 = *val;
 			 check_case1 = 1;
diff -Nru a/arch/ia64/kernel/signal.c b/arch/ia64/kernel/signal.c
--- a/arch/ia64/kernel/signal.c	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/kernel/signal.c	Fri Nov 14 00:38:53 2003
@@ -559,10 +559,12 @@
 
 		ka = &current->sighand->action[signr - 1];
 
+		/* Always make any pending restarted system calls return -EINTR */
+		current_thread_info()->restart_block.fn = do_no_restart_syscall;
+
 		if (restart) {
 			switch (errno) {
 			      case ERESTART_RESTARTBLOCK:
-				current_thread_info()->restart_block.fn = do_no_restart_syscall;
 			      case ERESTARTNOHAND:
 				scr->pt.r8 = ERR_CODE(EINTR);
 				/* note: scr->pt.r10 is already -1 */
diff -Nru a/arch/ia64/mm/tlb.c b/arch/ia64/mm/tlb.c
--- a/arch/ia64/mm/tlb.c	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/mm/tlb.c	Fri Nov 14 00:38:53 2003
@@ -77,7 +77,7 @@
 	{
 		int cpu = get_cpu(); /* prevent preemption/migration */
 		for (i = 0; i < NR_CPUS; ++i)
-			if (i != cpu)
+			if (cpu_online(i) && (i != cpu))
 				per_cpu(ia64_need_tlb_flush, i) = 1;
 		put_cpu();
 	}
diff -Nru a/arch/ia64/sn/io/machvec/pci_dma.c b/arch/ia64/sn/io/machvec/pci_dma.c
--- a/arch/ia64/sn/io/machvec/pci_dma.c	Fri Nov 14 00:38:53 2003
+++ b/arch/ia64/sn/io/machvec/pci_dma.c	Fri Nov 14 00:38:53 2003
@@ -279,8 +279,7 @@
 	 * scatterlist.
 	 */
 	for (i = 0; i < nents; i++, sg++) {
-		phys_addr = __pa(sg->dma_address ? sg->dma_address :
-			(unsigned long)page_address(sg->page) + sg->offset);
+		phys_addr = __pa((unsigned long)page_address(sg->page) + sg->offset);
 
 		/*
 		 * Handle the most common case: 64 bit cards.  This
diff -Nru a/drivers/acpi/tables.c b/drivers/acpi/tables.c
--- a/drivers/acpi/tables.c	Fri Nov 14 00:38:53 2003
+++ b/drivers/acpi/tables.c	Fri Nov 14 00:38:53 2003
@@ -262,10 +262,17 @@
 
 	/* Map the DSDT header via the pointer in the FADT */
 	if (id == ACPI_DSDT) {
-		struct acpi_table_fadt *fadt = (struct acpi_table_fadt *) *header;
+		struct fadt_descriptor_rev2 *fadt = (struct fadt_descriptor_rev2 *) *header;
+
+		if (fadt->revision == 3 && fadt->Xdsdt) {
+			*header = (void *) __acpi_map_table(fadt->Xdsdt,
+					sizeof(struct acpi_table_header));
+		} else if (fadt->V1_dsdt) {
+			*header = (void *) __acpi_map_table(fadt->V1_dsdt,
+					sizeof(struct acpi_table_header));
+		} else
+			*header = 0;
 
-		*header = (void *) __acpi_map_table(fadt->dsdt_addr,
-				sizeof(struct acpi_table_header));
 		if (!*header) {
 			printk(KERN_WARNING PREFIX "Unable to map DSDT\n");
 			return -ENODEV;
diff -Nru a/drivers/media/radio/Makefile b/drivers/media/radio/Makefile
--- a/drivers/media/radio/Makefile	Fri Nov 14 00:38:53 2003
+++ b/drivers/media/radio/Makefile	Fri Nov 14 00:38:53 2003
@@ -2,6 +2,8 @@
 # Makefile for the kernel character device drivers.
 #
 
+obj-y		:= dummy.o
+
 miropcm20-objs	:= miropcm20-rds-core.o miropcm20-radio.o
 
 obj-$(CONFIG_RADIO_AZTECH) += radio-aztech.o
diff -Nru a/drivers/media/radio/dummy.c b/drivers/media/radio/dummy.c
--- /dev/null	Wed Dec 31 16:00:00 1969
+++ b/drivers/media/radio/dummy.c	Fri Nov 14 00:38:53 2003
@@ -0,0 +1 @@
+/* just so the linker knows what kind of object files it's deadling with... */
diff -Nru a/drivers/media/video/Makefile b/drivers/media/video/Makefile
--- a/drivers/media/video/Makefile	Fri Nov 14 00:38:53 2003
+++ b/drivers/media/video/Makefile	Fri Nov 14 00:38:53 2003
@@ -7,6 +7,7 @@
 zoran-objs      :=	zr36120.o zr36120_i2c.o zr36120_mem.o
 zr36067-objs	:=	zoran_procfs.o zoran_device.o \
 			zoran_driver.o zoran_card.o
+obj-y		:=	dummy.o
 
 obj-$(CONFIG_VIDEO_DEV) += videodev.o v4l2-common.o v4l1-compat.o
 
diff -Nru a/drivers/media/video/dummy.c b/drivers/media/video/dummy.c
--- /dev/null	Wed Dec 31 16:00:00 1969
+++ b/drivers/media/video/dummy.c	Fri Nov 14 00:38:53 2003
@@ -0,0 +1 @@
+/* just so the linker knows what kind of object files it's deadling with... */
diff -Nru a/drivers/net/tulip/media.c b/drivers/net/tulip/media.c
--- a/drivers/net/tulip/media.c	Fri Nov 14 00:38:53 2003
+++ b/drivers/net/tulip/media.c	Fri Nov 14 00:38:53 2003
@@ -278,6 +278,10 @@
 				for (i = 0; i < init_length; i++)
 					outl(init_sequence[i], ioaddr + CSR12);
 			}
+
+			(void) inl(ioaddr + CSR6); /* flush CSR12 writes */
+			udelay(500);		/* Give MII time to recover */
+
 			tmp_info = get_u16(&misc_info[1]);
 			if (tmp_info)
 				tp->advertising[phy_num] = tmp_info | 1;
diff -Nru a/drivers/serial/serial_core.c b/drivers/serial/serial_core.c
--- a/drivers/serial/serial_core.c	Fri Nov 14 00:38:53 2003
+++ b/drivers/serial/serial_core.c	Fri Nov 14 00:38:53 2003
@@ -1859,6 +1859,9 @@
 	if (flow == 'r')
 		termios.c_cflag |= CRTSCTS;
 
+	if (!port->ops)
+		return 0;
+
 	port->ops->set_termios(port, &termios, NULL);
 	co->cflag = termios.c_cflag;
 
diff -Nru a/include/asm-ia64/pgtable.h b/include/asm-ia64/pgtable.h
--- a/include/asm-ia64/pgtable.h	Fri Nov 14 00:38:53 2003
+++ b/include/asm-ia64/pgtable.h	Fri Nov 14 00:38:53 2003
@@ -63,7 +63,8 @@
 #define _PAGE_FILE		(1 << 1)		/* see swap & file pte remarks below */
 
 #define _PFN_MASK		_PAGE_PPN_MASK
-#define _PAGE_CHG_MASK		(_PFN_MASK | _PAGE_A | _PAGE_D)
+/* Mask of bits which may be changed by pte_modify(); the odd bits are there for _PAGE_PROTNONE */
+#define _PAGE_CHG_MASK	(_PAGE_P | _PAGE_PROTNONE | _PAGE_PL_MASK | _PAGE_AR_MASK | _PAGE_ED)
 
 #define _PAGE_SIZE_4K	12
 #define _PAGE_SIZE_8K	13
@@ -230,7 +231,7 @@
 #define mk_pte(page, pgprot)	pfn_pte(page_to_pfn(page), (pgprot))
 
 #define pte_modify(_pte, newprot) \
-	(__pte((pte_val(_pte) & _PAGE_CHG_MASK) | pgprot_val(newprot)))
+	(__pte((pte_val(_pte) & ~_PAGE_CHG_MASK) | (pgprot_val(newprot) & _PAGE_CHG_MASK)))
 
 #define page_pte_prot(page,prot)	mk_pte(page, prot)
 #define page_pte(page)			page_pte_prot(page, __pgprot(0))
diff -Nru a/include/asm-ia64/sn/nodepda.h b/include/asm-ia64/sn/nodepda.h
--- a/include/asm-ia64/sn/nodepda.h	Fri Nov 14 00:38:53 2003
+++ b/include/asm-ia64/sn/nodepda.h	Fri Nov 14 00:38:53 2003
@@ -128,7 +128,7 @@
  * Check if given a compact node id the corresponding node has all the
  * cpus disabled. 
  */
-#define is_headless_node(cnode)		(!node_to_cpu_mask[cnode])
+#define is_headless_node(cnode)		(nr_cpus_node(cnode) == 0)
 
 /*
  * Check if given a node vertex handle the corresponding node has all the
diff -Nru a/include/linux/module.h b/include/linux/module.h
--- a/include/linux/module.h	Fri Nov 14 00:38:53 2003
+++ b/include/linux/module.h	Fri Nov 14 00:38:53 2003
@@ -60,10 +60,11 @@
 #define __module_cat(a,b) ___module_cat(a,b)
 #define __MODULE_INFO(tag, name, info)					  \
 static const char __module_cat(name,__LINE__)[]				  \
+  __attribute_used__							  \
   __attribute__((section(".modinfo"),unused)) = __stringify(tag) "=" info
 
-#define MODULE_GENERIC_TABLE(gtype,name)			\
-extern const struct gtype##_id __mod_##gtype##_table		\
+#define MODULE_GENERIC_TABLE(gtype,name)		\
+extern const struct gtype##_id __mod_##gtype##_table	\
   __attribute__ ((unused, alias(__stringify(name))))
 
 #define THIS_MODULE (&__this_module)
@@ -142,6 +143,7 @@
 #define __CRC_SYMBOL(sym, sec)					\
 	extern void *__crc_##sym __attribute__((weak));		\
 	static const unsigned long __kcrctab_##sym		\
+	__attribute_used__					\
 	__attribute__((section("__kcrctab" sec), unused))	\
 	= (unsigned long) &__crc_##sym;
 #else
@@ -155,6 +157,7 @@
 	__attribute__((section("__ksymtab_strings")))		\
 	= MODULE_SYMBOL_PREFIX #sym;                    	\
 	static const struct kernel_symbol __ksymtab_##sym	\
+	__attribute_used__					\
 	__attribute__((section("__ksymtab" sec), unused))	\
 	= { (unsigned long)&sym, __kstrtab_##sym }
 
diff -Nru a/include/linux/moduleparam.h b/include/linux/moduleparam.h
--- a/include/linux/moduleparam.h	Fri Nov 14 00:38:53 2003
+++ b/include/linux/moduleparam.h	Fri Nov 14 00:38:53 2003
@@ -52,6 +52,7 @@
 #define __module_param_call(prefix, name, set, get, arg, perm)		\
 	static char __param_str_##name[] __initdata = prefix #name;	\
 	static struct kernel_param const __param_##name			\
+	__attribute_used__						\
     __attribute__ ((unused,__section__ ("__param"),aligned(sizeof(void *)))) \
 	= { __param_str_##name, perm, set, get, arg }
 
diff -Nru a/include/linux/nfs_fs.h b/include/linux/nfs_fs.h
--- a/include/linux/nfs_fs.h	Fri Nov 14 00:38:53 2003
+++ b/include/linux/nfs_fs.h	Fri Nov 14 00:38:53 2003
@@ -403,7 +403,7 @@
 nfs_size_to_loff_t(__u64 size)
 {
 	loff_t maxsz = (((loff_t) ULONG_MAX) << PAGE_CACHE_SHIFT) + PAGE_CACHE_SIZE - 1;
-	if (size > maxsz)
+	if (size > (__u64) maxsz)
 		return maxsz;
 	return (loff_t) size;
 }
diff -Nru a/include/linux/sysctl.h b/include/linux/sysctl.h
--- a/include/linux/sysctl.h	Fri Nov 14 00:38:53 2003
+++ b/include/linux/sysctl.h	Fri Nov 14 00:38:53 2003
@@ -127,6 +127,7 @@
 	KERN_PANIC_ON_OOPS=57,  /* int: whether we will panic on an oops */
 	KERN_HPPA_PWRSW=58,	/* int: hppa soft-power enable */
 	KERN_HPPA_UNALIGNED=59,	/* int: hppa unaligned-trap enable */
+	KERN_CACHEDECAYTICKS=60,/* ulong: value for cache_decay_ticks (EXPERIMENTAL!) */
 };
 
 
diff -Nru a/kernel/printk.c b/kernel/printk.c
--- a/kernel/printk.c	Fri Nov 14 00:38:53 2003
+++ b/kernel/printk.c	Fri Nov 14 00:38:53 2003
@@ -361,6 +361,12 @@
 			__call_console_drivers(start, end);
 		}
 	}
+#ifdef CONFIG_IA64_EARLY_PRINTK
+	if (!console_drivers) {
+		void early_printk (const char *str, size_t len);
+		early_printk(&LOG_BUF(start), end - start);
+	}
+#endif
 }
 
 /*
@@ -678,7 +684,11 @@
 		 * for us.
 		 */
 		spin_lock_irqsave(&logbuf_lock, flags);
+#ifdef CONFIG_IA64_EARLY_PRINTK
+		con_start = log_end;
+#else
 		con_start = log_start;
+#endif
 		spin_unlock_irqrestore(&logbuf_lock, flags);
 	}
 	release_console_sem();
@@ -731,3 +741,117 @@
 		tty->driver->write(tty, 0, msg, strlen(msg));
 	return;
 }
+
+#ifdef CONFIG_IA64_EARLY_PRINTK
+
+#include <asm/io.h>
+
+# ifdef CONFIG_IA64_EARLY_PRINTK_VGA
+
+
+#define VGABASE		((char *)0xc0000000000b8000)
+#define VGALINES	24
+#define VGACOLS		80
+
+static int current_ypos = VGALINES, current_xpos = 0;
+
+static void
+early_printk_vga (const char *str, size_t len)
+{
+	char c;
+	int  i, k, j;
+
+	while (len-- > 0) {
+		c = *str++;
+		if (current_ypos >= VGALINES) {
+			/* scroll 1 line up */
+			for (k = 1, j = 0; k < VGALINES; k++, j++) {
+				for (i = 0; i < VGACOLS; i++) {
+					writew(readw(VGABASE + 2*(VGACOLS*k + i)),
+					       VGABASE + 2*(VGACOLS*j + i));
+				}
+			}
+			for (i = 0; i < VGACOLS; i++) {
+				writew(0x720, VGABASE + 2*(VGACOLS*j + i));
+			}
+			current_ypos = VGALINES-1;
+		}
+		if (c == '\n') {
+			current_xpos = 0;
+			current_ypos++;
+		} else if (c != '\r')  {
+			writew(((0x7 << 8) | (unsigned short) c),
+			       VGABASE + 2*(VGACOLS*current_ypos + current_xpos++));
+			if (current_xpos >= VGACOLS) {
+				current_xpos = 0;
+				current_ypos++;
+			}
+		}
+	}
+}
+
+# endif /* CONFIG_IA64_EARLY_PRINTK_VGA */
+
+# ifdef CONFIG_IA64_EARLY_PRINTK_UART
+
+#include <linux/serial_reg.h>
+#include <asm/system.h>
+
+static void early_printk_uart(const char *str, size_t len)
+{
+	static char *uart = NULL;
+	unsigned long uart_base;
+	char c;
+
+	if (!uart) {
+		uart_base = 0;
+#  ifdef CONFIG_SERIAL_8250_HCDP
+		{
+			extern unsigned long hcdp_early_uart(void);
+			uart_base = hcdp_early_uart();
+		}
+#  endif
+#  if CONFIG_IA64_EARLY_PRINTK_UART_BASE
+		if (!uart_base)
+			uart_base = CONFIG_IA64_EARLY_PRINTK_UART_BASE;
+#  endif
+		if (!uart_base)
+			return;
+
+		uart = ioremap(uart_base, 64);
+		if (!uart)
+			return;
+	}
+
+	while (len-- > 0) {
+		c = *str++;
+		while ((readb(uart + UART_LSR) & UART_LSR_TEMT) == 0)
+			cpu_relax(); /* spin */
+
+		writeb(c, uart + UART_TX);
+
+		if (c == '\n')
+			writeb('\r', uart + UART_TX);
+	}
+}
+
+# endif /* CONFIG_IA64_EARLY_PRINTK_UART */
+
+#ifdef CONFIG_IA64_EARLY_PRINTK_SGI_SN
+extern int early_printk_sn_sal(const char *str, int len);
+#endif
+
+void early_printk(const char *str, size_t len)
+{
+#ifdef CONFIG_IA64_EARLY_PRINTK_UART
+	early_printk_uart(str, len);
+#endif
+#ifdef CONFIG_IA64_EARLY_PRINTK_VGA
+	early_printk_vga(str, len);
+#endif
+#ifdef CONFIG_IA64_EARLY_PRINTK_SGI_SN
+ 	early_printk_sn_sal(str, len);
+#endif
+}
+
+#endif /* CONFIG_IA64_EARLY_PRINTK */
diff -Nru a/kernel/sysctl.c b/kernel/sysctl.c
--- a/kernel/sysctl.c	Fri Nov 14 00:38:53 2003
+++ b/kernel/sysctl.c	Fri Nov 14 00:38:53 2003
@@ -579,6 +579,16 @@
 		.mode		= 0644,
 		.proc_handler	= &proc_dointvec,
 	},
+#ifdef CONFIG_SMP
+	{
+		.ctl_name	= KERN_CACHEDECAYTICKS,
+		.procname	= "cache_decay_ticks",
+		.data		= &cache_decay_ticks,
+		.maxlen		= sizeof(cache_decay_ticks),
+		.mode		= 0644,
+		.proc_handler	= &proc_doulongvec_minmax,
+	},
+#endif
 	{ .ctl_name = 0 }
 };
 
diff -Nru a/mm/memory.c b/mm/memory.c
--- a/mm/memory.c	Fri Nov 14 00:38:53 2003
+++ b/mm/memory.c	Fri Nov 14 00:38:53 2003
@@ -121,8 +121,10 @@
 	}
 	pmd = pmd_offset(dir, 0);
 	pgd_clear(dir);
-	for (j = 0; j < PTRS_PER_PMD ; j++)
+	for (j = 0; j < PTRS_PER_PMD ; j++) {
+		prefetchw(pmd + j + PREFETCH_STRIDE/sizeof(*pmd));
 		free_one_pmd(tlb, pmd+j);
+	}
 	pmd_free_tlb(tlb, pmd);
 }
 
