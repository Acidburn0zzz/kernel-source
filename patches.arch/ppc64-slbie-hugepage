ChangeSet
  1.1612 04/05/04 07:57:29 david@gibson.dropbear.id.au[torvalds] +1 -0
  [PATCH] ppc64: Use slbie, not slbia in hugepage code
  
  On PPC64, when we prepare segments below 4G for use with hugepages, we
  need to flush their entries from the SLB, in case SLB entries
  specifying normal pages were already present.
  
  Previously we did that by flushing the entire SLB, the patch below
  changes this to individually flush each necessary segment with slbie.
  The new version may well be slightly faster, but the real reason for
  it is so that this code path doesn't need to be changed to reinstate
  any bolted SLB entries, if we add them.  The existing version has
  already caused problems (read, crashes) when combined with some
  patches that add bolted SLB entries.

  arch/ppc64/mm/hugetlbpage.c
    1.27 04/05/04 03:07:00 david@gibson.dropbear.id.au[torvalds] +15 -4
    ppc64: Use slbie, not slbia in hugepage code

diff -Nru a/arch/ppc64/mm/hugetlbpage.c b/arch/ppc64/mm/hugetlbpage.c
--- a/arch/ppc64/mm/hugetlbpage.c	Wed May  5 06:24:41 2004
+++ b/arch/ppc64/mm/hugetlbpage.c	Wed May  5 06:24:41 2004
@@ -155,9 +155,20 @@
 	return 0;
 }
 
-static void do_slbia(void *unused)
+static void flush_segments(void *parm)
 {
-	asm volatile ("isync; slbia; isync":::"memory");
+	u16 segs = (unsigned long) parm;
+	unsigned long i;
+
+	asm volatile("isync" : : : "memory");
+
+	for (i = 0; i < 16; i++) {
+		if (! (segs & (1U << i)))
+			continue;
+		asm volatile("slbie %0" : : "r" (i << SID_SHIFT));
+	}
+
+	asm volatile("isync" : : : "memory");
 }
 
 static int prepare_low_seg_for_htlb(struct mm_struct *mm, unsigned long seg)
@@ -226,10 +237,10 @@
 				return -EBUSY;
 
 	mm->context.htlb_segs |= newsegs;
-	/* the context change must make it to memory before the slbia,
+	/* the context change must make it to memory before the flush,
 	 * so that further SLB misses do the right thing. */
 	mb();
-	on_each_cpu(do_slbia, NULL, 0, 1);
+	on_each_cpu(flush_segments, (void *)(unsigned long)newsegs, 0, 1);
 
 	return 0;
 }
.........................................................................
# vim: syntax=diff

