ChangeSet
  1.1552.1.1 04/04/06 14:37:26 anton@samba.org +1 -0
  Buffers we pass into RTAS must be in the RMO region.
  Use snprintf.

  arch/ppc64/kernel/rtas.c
    1.35 04/04/06 14:34:34 anton@samba.org +12 -8
    Buffers we pass into RTAS must be in the RMO region.
    Use snprintf.


Another fix as a part of LTC #7338.

Anton

diff -urN linux-2.6.5/arch/ppc64/kernel/rtas.c ameslab-2.5/arch/ppc64/kernel/rtas.c
--- linux-2.6.5/arch/ppc64/kernel/rtas.c	2004-04-16 21:05:09.599941464 +1000
+++ ameslab-2.5/arch/ppc64/kernel/rtas.c	2004-04-16 17:55:25.122425604 +1000
@@ -467,23 +431,27 @@
         rtas_power_off();
 }
 
-void
-rtas_os_term(char *str)
+/* Must be in the RMO region, so we place it here */
+static char rtas_os_term_buf[2048];
+
+void rtas_os_term(char *str)
 {
 	long status;
-	char buf[1035];
 
-	sprintf(buf, "OS panic: %s", str);
+	snprintf(rtas_os_term_buf, 2048, "OS panic: %s", str);
+
 	do {
-		status = rtas_call(rtas_token("ibm,os-term"), 1, 1, NULL, __pa(buf));
+		status = rtas_call(rtas_token("ibm,os-term"), 1, 1, NULL,
+				   __pa(rtas_os_term_buf));
+
 		if (status == RTAS_BUSY)
 			udelay(1);
 		else if (status != 0)
-			printk(KERN_EMERG "ibm,os-term call failed %ld\n", status);
-	} while (status != RTAS_BUSY);
+			printk(KERN_EMERG "ibm,os-term call failed %ld\n",
+			       status);
+	} while (status == RTAS_BUSY);
 }
 
-
 unsigned long rtas_rmo_buf = 0;
 
 asmlinkage int ppc_rtas(struct rtas_args __user *uargs)

