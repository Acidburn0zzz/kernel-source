From: ak@suse.de
Subject: Add command line option to disable memory hot add
Suse-bugzilla: 142035


Out of paranoia reasons - if something goes wrong with this code
we can disable it.
	

Index: linux-2.6.15/Documentation/x86_64/boot-options.txt
===================================================================
--- linux-2.6.15.orig/Documentation/x86_64/boot-options.txt
+++ linux-2.6.15/Documentation/x86_64/boot-options.txt
@@ -135,6 +135,9 @@ NUMA
 
   numa=fake=X   Fake X nodes and ignore NUMA setup of the actual machine.
 
+  numa=ignorehotadd Ignore hot add memory in SRAT. This will disable memory
+                hotplug      [SUSE extension for now]
+
 ACPI
 
   acpi=off	Don't enable ACPI
Index: linux-2.6.15/arch/x86_64/mm/numa.c
===================================================================
--- linux-2.6.15.orig/arch/x86_64/mm/numa.c
+++ linux-2.6.15/arch/x86_64/mm/numa.c
@@ -329,6 +329,8 @@ __init int numa_setup(char *opt) 
 #ifdef CONFIG_ACPI_NUMA
  	if (!strncmp(opt,"noacpi",6))
  		acpi_numa = -1;
+	if (!strncmp(opt,"ignorehotadd",13))
+		ignore_hotadd = 1;
 #endif
 	return 1;
 } 
Index: linux-2.6.15/arch/x86_64/mm/srat.c
===================================================================
--- linux-2.6.15.orig/arch/x86_64/mm/srat.c
+++ linux-2.6.15/arch/x86_64/mm/srat.c
@@ -27,6 +27,7 @@ static nodemask_t nodes_found __initdata
 static struct node nodes[MAX_NUMNODES] __initdata;
 struct node nodes_add[MAX_NUMNODES] __initdata;
 static int found_add_area __initdata;
+int ignore_hotadd __initdata;
 static u8 pxm2node[256] = { [0 ... 255] = 0xff };
 
 static int node_to_pxm(int n);
@@ -223,7 +224,7 @@ acpi_numa_memory_affinity_init(struct ac
  	 * It is fine to add this area to the nodes data it will be used later
  	 * This code supports one contigious hot add area per node.
  	 */
- 	if (ma->flags.hot_pluggable == 1) {
+ 	if (ma->flags.hot_pluggable == 1 && !ignore_hotadd) {
  		found_add_area = 1;
  		if (nodes_add[node].start == nodes_add[node].end) {
  			nodes_add[node].start = start;
Index: linux-2.6.15/include/asm-x86_64/numa.h
===================================================================
--- linux-2.6.15.orig/include/asm-x86_64/numa.h
+++ linux-2.6.15/include/asm-x86_64/numa.h
@@ -19,6 +19,7 @@ extern int numa_off;
 
 extern void numa_set_node(int cpu, int node);
 extern void srat_reserve_add_area(int nodeid);
+extern int ignore_hotadd;
 
 extern unsigned char apicid_to_node[256];
 #ifdef CONFIG_NUMA
