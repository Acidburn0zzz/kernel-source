Date: Fri, 16 Apr 2004 13:48:29 +1000
From: Anton Blanchard <anton@samba.org>
To: olh@suse.de
Subject: [anton@samba.org: [PATCH] [ppc64] catch branch to 0 in real mode]

Hi,

Another important fix, a step towards working out ibm bugzilla 7403.

Anton

----- Forwarded message from Anton Blanchard <anton@samba.org> -----

From: Anton Blanchard <anton@samba.org>
To: torvalds@osdl.org
Cc: akpm@osdl.org
Subject: [PATCH] [ppc64] catch branch to 0 in real mode


Hi,

We have been debugging some strange fails where we branch to 0 in real
mode. At the moment this results in the cpu running through the
initialisation code and failing somewhere well into it.

The following patch uses the featuring nop'ing code to remove the branch
at real address 0 so it falls through to a trap instruction and gets
caught early.

Anton

---

 foobar2-anton/arch/ppc64/kernel/head.S |    5 +++++
 1 files changed, 5 insertions(+)

diff -puN arch/ppc64/kernel/head.S~trap1 arch/ppc64/kernel/head.S
--- foobar2/arch/ppc64/kernel/head.S~trap1	2004-04-16 13:21:40.934017481 +1000
+++ foobar2-anton/arch/ppc64/kernel/head.S	2004-04-16 13:30:39.877969214 +1000
@@ -93,8 +93,13 @@
 _stext:
 #ifdef CONFIG_PPC_PSERIES
 _STATIC(__start)
+	/* NOP this out unconditionally */
+BEGIN_FTR_SECTION
 	b .__start_initialization_pSeries
+END_FTR_SECTION(0, 1)
 #endif
+	/* Catch branch to 0 in real mode */
+	trap
 #ifdef CONFIG_PPC_ISERIES
 	/*
 	 * At offset 0x20, there is a pointer to iSeries LPAR data.

_

----- End forwarded message -----

