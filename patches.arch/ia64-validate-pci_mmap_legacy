From: Bjorn Helgaas <bjorn.helgaas@hp.com>
Subject: Add validation to legacy_mem mmap
Patch-mainline: 2.6.18
References: 166316

Acked-by: rw@suse.de

Index: linux-2.6.16-8/arch/ia64/pci/pci.c
===================================================================
--- linux-2.6.16-8.orig/arch/ia64/pci/pci.c	2006-04-13 14:55:45.000000000 -0600
+++ linux-2.6.16-8/arch/ia64/pci/pci.c	2006-04-14 10:14:13.000000000 -0600
@@ -646,8 +646,17 @@
 int
 pci_mmap_legacy_page_range(struct pci_bus *bus, struct vm_area_struct *vma)
 {
+	unsigned long size;
 	char *addr;
 
+	/*
+	 * If we allow WB access to the region, we can't map it
+	 * UC at the same time.
+	 */
+	size = vma->vm_end - vma->vm_start;
+	if (valid_phys_addr_range(vma->vm_pgoff << PAGE_SHIFT, &size))
+		return -EINVAL;
+
 	addr = pci_get_legacy_mem(bus);
 	if (IS_ERR(addr))
 		return PTR_ERR(addr);
@@ -657,7 +666,7 @@
 	vma->vm_flags |= (VM_SHM | VM_RESERVED | VM_IO);
 
 	if (remap_pfn_range(vma, vma->vm_start, vma->vm_pgoff,
-			    vma->vm_end - vma->vm_start, vma->vm_page_prot))
+			    size, vma->vm_page_prot))
 		return -EAGAIN;
 
 	return 0;

