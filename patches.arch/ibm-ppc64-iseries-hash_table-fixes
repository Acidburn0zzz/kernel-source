===== arch/ppc64/kernel/iSeries_htab.c 1.3 vs edited =====
--- 1.3/arch/ppc64/kernel/iSeries_htab.c	2004-05-31 09:07:18 +10:00
+++ edited/arch/ppc64/kernel/iSeries_htab.c	2004-05-31 10:57:58 +10:00
@@ -29,19 +29,23 @@
 #include <asm/cputable.h>
 #endif
 
-static spinlock_t iSeries_hlocks[16] __cacheline_aligned_in_smp = { [0 ... 15] = SPIN_LOCK_UNLOCKED};
+static spinlock_t iSeries_hlocks[64] __cacheline_aligned_in_smp = { [0 ... 63] = SPIN_LOCK_UNLOCKED};
 
 /*
  * Very primitive algorithm for picking up a lock
  */
 static inline void iSeries_hlock(unsigned long slot)
 {
-	spin_lock(&iSeries_hlocks[(slot >> 3) & 0x0f]);
+	if (slot & 0x8)
+		slot = ~slot;
+	spin_lock(&iSeries_hlocks[(slot >> 4) & 0x3f]);
 }
 
 static inline void iSeries_hunlock(unsigned long slot)
 {
-	spin_unlock(&iSeries_hlocks[(slot >> 3) & 0x0f]);
+	if (slot & 0x8)
+		slot = ~slot;
+	spin_unlock(&iSeries_hlocks[(slot >> 4) & 0x3f]);
 }
 
 static long iSeries_hpte_insert(unsigned long hpte_group, unsigned long va,
