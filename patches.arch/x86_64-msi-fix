diff -u linux/include/asm-x86_64/msi.h-MSI linux/include/asm-x86_64/msi.h
--- linux/include/asm-x86_64/msi.h-MSI	2004-10-02 01:15:14.000000000 +0200
+++ linux/include/asm-x86_64/msi.h	2004-10-02 01:15:18.000000000 +0200
@@ -7,10 +7,11 @@
 #define ASM_MSI_H
 
 #include <asm/desc.h>
+#include <asm/smp.h>
 
 #define LAST_DEVICE_VECTOR		232
 #define MSI_DEST_MODE			MSI_LOGICAL_MODE
 #define MSI_TARGET_CPU_SHIFT		12
-#define MSI_TARGET_CPU			TARGET_CPUS
+#define MSI_TARGET_CPU			logical_smp_processor_id()
 
 #endif /* ASM_MSI_H */
diff -u linux/include/asm-x86_64/smp.h-MSI linux/include/asm-x86_64/smp.h
--- linux/include/asm-x86_64/smp.h-MSI	2004-10-02 01:15:14.000000000 +0200
+++ linux/include/asm-x86_64/smp.h	2004-10-02 01:16:44.000000000 +0200
@@ -137,5 +144,13 @@
 })
 #endif
 
+#ifndef __ASSEMBLY__
+static __inline int logical_smp_processor_id(void)
+{
+	/* we don't want to mark this access volatile - bad code generation */
+	return GET_APIC_LOGICAL_ID(*(unsigned long *)(APIC_BASE+APIC_LDR));
+}
+#endif
+
 #endif
 
