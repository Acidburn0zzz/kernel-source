diff -u linux/drivers/pci/msi.c-MSI linux/drivers/pci/msi.c
--- linux/drivers/pci/msi.c-MSI	2004-09-26 02:11:33.000000000 +0200
+++ linux/drivers/pci/msi.c	2004-09-26 02:12:58.000000000 +0200
@@ -275,6 +275,7 @@
 static void msi_address_init(struct msg_address *msi_address)
 {
 	unsigned int	dest_id;
+	unsigned long val; 
 
 	memset(msi_address, 0, sizeof(struct msg_address));
 	msi_address->hi_address = (u32)0;
@@ -282,7 +283,13 @@
 	msi_address->lo_address.u.dest_mode = MSI_DEST_MODE;
 	msi_address->lo_address.u.redirection_hint = MSI_REDIRECTION_HINT_MODE;
 	msi_address->lo_address.u.dest_id = dest_id;
-	msi_address->lo_address.value |= (MSI_TARGET_CPU << MSI_TARGET_CPU_SHIFT);
+	/* FIXME: broken for >64 CPUs */
+#ifdef __i386__
+	val = MSI_TARGET_CPU;
+#else
+	val = *cpus_addr(MSI_TARGET_CPU);
+#endif
+	msi_address->lo_address.value |= (val << MSI_TARGET_CPU_SHIFT);
 }
 
 static int msi_free_vector(struct pci_dev* dev, int vector, int reassign);
