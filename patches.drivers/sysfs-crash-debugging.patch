Subject: display last accessed sysfs file on kernel panic message
From: Andrew Morton <akpm@osdl.org>
Patch-mainline: never

Display the most-recently-opened sysfs file's name when oopsing.

From: Adrian Bunk <bunk@stusta.de>

  Build fix

From: Greg Kroah-Hartman <gregkh@suse.de>

  Modified to make the api call cleaner, and available to all arches if
  need be.  Also added it to x86-64's crash dump message.


Signed-off-by: Adrian Bunk <bunk@stusta.de>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
---
 arch/i386/kernel/traps.c   |    3 ++-
 arch/x86_64/kernel/traps.c |    1 +
 fs/sysfs/file.c            |   13 +++++++++++++
 include/linux/sysfs.h      |    7 +++++++
 4 files changed, 23 insertions(+), 1 deletion(-)

--- linux-2.6.15.orig/fs/sysfs/file.c	2006-01-26 11:31:26.000000000 -0800
+++ linux-2.6.15/fs/sysfs/file.c	2006-01-26 11:41:10.000000000 -0800
@@ -6,6 +6,7 @@
 #include <linux/fsnotify.h>
 #include <linux/kobject.h>
 #include <linux/namei.h>
+#include <linux/limits.h>
 #include <asm/uaccess.h>
 #include <asm/semaphore.h>
 
@@ -14,6 +15,9 @@
 #define to_subsys(k) container_of(k,struct subsystem,kset.kobj)
 #define to_sattr(a) container_of(a,struct subsys_attribute,attr)
 
+/* used in crash dumps to help with debugging */
+static char last_sysfs_file[PATH_MAX];
+
 /*
  * Subsystem file operations.
  * These operations allow subsystems to have files that can be 
@@ -326,9 +330,18 @@
 
 static int sysfs_open_file(struct inode * inode, struct file * filp)
 {
+	char *p = d_path(filp->f_dentry, sysfs_mount, last_sysfs_file,
+			sizeof(last_sysfs_file));
+	if (p)
+		memmove(last_sysfs_file, p, strlen(p) + 1);
 	return check_perm(inode,filp);
 }
 
+void sysfs_printk_last_file(void)
+{
+	printk(KERN_EMERG "last sysfs file: %s\n", last_sysfs_file);
+}
+
 static int sysfs_release(struct inode * inode, struct file * filp)
 {
 	struct kobject * kobj = to_kobj(filp->f_dentry->d_parent);
--- linux-2.6.15.orig/arch/i386/kernel/traps.c	2006-01-26 11:31:26.000000000 -0800
+++ linux-2.6.15/arch/i386/kernel/traps.c	2006-01-26 11:40:48.000000000 -0800
@@ -372,7 +372,8 @@
 #endif
 		if (nl)
 			printk("\n");
-	notify_die(DIE_OOPS, (char *)str, regs, err, 255, SIGSEGV);
+		sysfs_printk_last_file();
+		notify_die(DIE_OOPS, (char *)str, regs, err, 255, SIGSEGV);
 		show_registers(regs);
   	} else
 		printk(KERN_EMERG "Recursive die() failure, output suppressed\n");
--- linux-2.6.15.orig/include/linux/sysfs.h	2006-01-26 11:31:26.000000000 -0800
+++ linux-2.6.15/include/linux/sysfs.h	2006-01-26 11:41:47.000000000 -0800
@@ -118,6 +118,8 @@
 int sysfs_create_group(struct kobject *, const struct attribute_group *);
 void sysfs_remove_group(struct kobject *, const struct attribute_group *);
 
+void sysfs_printk_last_file(void);
+
 #else /* CONFIG_SYSFS */
 
 static inline int sysfs_create_dir(struct kobject * k)
@@ -185,6 +187,11 @@
 	;
 }
 
+static inline void sysfs_printk_last_file(void)
+{
+	;
+}
+
 #endif /* CONFIG_SYSFS */
 
 #endif /* _SYSFS_H_ */
--- linux-2.6.15.orig/arch/x86_64/kernel/traps.c	2006-01-26 11:31:26.000000000 -0800
+++ linux-2.6.15/arch/x86_64/kernel/traps.c	2006-01-26 11:40:48.000000000 -0800
@@ -414,6 +414,7 @@
 	printk("DEBUG_PAGEALLOC");
 #endif
 	printk("\n");
+	sysfs_printk_last_file();
 	notify_die(DIE_OOPS, str, regs, err, current->thread.trap_no, SIGSEGV);
 	show_registers(regs);
 	/* Executive summary in case the oops scrolled away */
