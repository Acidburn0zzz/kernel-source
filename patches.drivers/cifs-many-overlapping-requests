This is a patch from Steve French to address problems reported in LTC8025

Quote:
	[This patch] fixes queueing to handle more than 100 overlapping
	requests, letting 50 (server max mpx) sends through at a time
	properly.

Index: linux-2.6.5/fs/cifs/transport.c
===================================================================
--- linux-2.6.5.orig/fs/cifs/transport.c	2004-06-21 14:54:01.000000000 +0200
+++ linux-2.6.5/fs/cifs/transport.c	2004-06-21 14:54:49.000000000 +0200
@@ -200,23 +200,30 @@
 	}
 
 	/* Ensure that we do not send more than 50 overlapping requests 
-		to the same server. We may make this configurable later or
-		use ses->maxReq */
+	   to the same server. We may make this configurable later or
+	   use ses->maxReq */
 
-	/* can not count locking commands against the total since
-		they are allowed to block on server */
-	if(long_op < 3) {
-		/* update # of requests on the wire to this server */
-		atomic_inc(&ses->server->inFlight); 
-	}
- 
-	if(atomic_read(&ses->server->inFlight) > 50) {
-		wait_event(ses->server->request_q,atomic_read(&ses->server->inFlight) <= 50);
+	spin_lock(&GlobalMid_Lock); 
+	while(1) {        
+		if(atomic_read(&ses->server->inFlight) >= 50) {
+			spin_unlock(&GlobalMid_Lock);         
+			wait_event(ses->server->request_q,atomic_read(&ses->server->inFlight) < 50);
+			spin_lock(&GlobalMid_Lock); 
+		} else {
+			/* can not count locking commands against the total since
+			   they are allowed to block on server */
+			if(long_op < 3) {
+				/* update # of requests on the wire to this server */
+				atomic_inc(&ses->server->inFlight); 
+			}
+			spin_unlock(&GlobalMid_Lock); 
+			break;
+		}
 	}
 
 	/* make sure that we sign in the same order that we send on this socket 
-		and avoid races inside tcp sendmsg code that could cause corruption
-		of smb data */
+	   and avoid races inside tcp sendmsg code that could cause corruption
+	   of smb data */
 
 	down(&ses->server->tcpSem); 
 
