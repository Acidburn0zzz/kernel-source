From: Takashi Iwai <tiwai@suse.de>
Subject: sound: snd_register_device_for_dev fix
Patch-mainline: 2.6.24-rc1
References: 

snd_register_device_for_dev() can oops when device_create() returns
ERR_PTR(err).

Scenario:

preg->dev = device_create(...); /* fails */
if (preg->dev) /* contains ERR_PTR(err) */
        dev_set_drvdata(preg->dev, private_data);

and dev_set_drvdata() looks like this:

static inline void
dev_set_drvdata (struct device *dev, void *data)
{
        dev->driver_data = data; <--- boom
}

This patch should prevent that.

Signed-off-by: Mariusz Kozlowski <m.kozlowski@tuxland.pl>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/core/sound.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/sound/core/sound.c	2007-10-31 17:43:15.000000000 -0400
+++ b/sound/core/sound.c	2007-10-31 17:45:01.000000000 -0400
@@ -266,6 +266,14 @@ int snd_register_device_for_dev(int type
 	snd_minors[minor] = preg;
 	preg->dev = device_create(sound_class, device, MKDEV(major, minor),
 				  "%s", name);
+	if (IS_ERR(preg->dev)) {
+		snd_minors[minor] = NULL;
+		mutex_unlock(&sound_mutex);
+		minor = PTR_ERR(preg->dev);
+		kfree(preg);
+		return minor;
+	}
+
 	if (preg->dev)
 		dev_set_drvdata(preg->dev, private_data);
 
