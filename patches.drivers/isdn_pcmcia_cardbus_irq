From: Karsten Keil <kkeil@suse.de>
Subject: enable PCMCIA IRQ sharing for all PCMCIA ISDN cards
Suse-bugzilla: 72300

most current laptops do not work without allowing shared cardbus IRQs.
This patch enables IRQ sharing, so these cards work again.
Note: It was not working before. so this patch is low risk to break
something. If a old laptop without cardbus do not work with IRQ
sharing, it is also no problem, you can exclude the shared IRQs in
/etc/pcmcia/config.opts.


diff -ur linux-2.6.11.4-9.org/drivers/isdn/hardware/avm/b1pcmcia.c linux/drivers/isdn/hardware/avm/b1pcmcia.c
--- linux-2.6.11.4-9.org/drivers/isdn/hardware/avm/b1pcmcia.c	2005-03-02 08:37:30.000000000 +0100
+++ linux/drivers/isdn/hardware/avm/b1pcmcia.c	2005-03-20 16:32:46.000000000 +0100
@@ -82,7 +82,7 @@
 	card->irq = irq;
 	card->cardtype = cardtype;
 
-	retval = request_irq(card->irq, b1_interrupt, 0, card->name, card);
+	retval = request_irq(card->irq, b1_interrupt, SA_SHIRQ, card->name, card);
 	if (retval) {
 		printk(KERN_ERR "b1pcmcia: unable to get IRQ %d.\n",
 		       card->irq);
diff -ur linux-2.6.11.4-9.org/drivers/isdn/hisax/sedlbauer_cs.c linux/drivers/isdn/hisax/sedlbauer_cs.c
--- linux-2.6.11.4-9.org/drivers/isdn/hisax/sedlbauer_cs.c	2005-03-02 08:37:53.000000000 +0100
+++ linux/drivers/isdn/hisax/sedlbauer_cs.c	2005-03-20 16:29:27.000000000 +0100
@@ -198,7 +198,7 @@
     link = &local->link; link->priv = local;
     
     /* Interrupt setup */
-    link->irq.Attributes = IRQ_TYPE_EXCLUSIVE;
+    link->irq.Attributes = IRQ_TYPE_DYNAMIC_SHARING|IRQ_FIRST_SHARED;
     link->irq.IRQInfo1 = IRQ_LEVEL_ID;
     link->irq.Handler = NULL;
 
diff -ur linux-2.6.11.4-9.org/drivers/isdn/hisax/teles3.c linux/drivers/isdn/hisax/teles3.c
--- linux-2.6.11.4-9.org/drivers/isdn/hisax/teles3.c	2005-03-02 08:38:33.000000000 +0100
+++ linux/drivers/isdn/hisax/teles3.c	2005-03-20 16:36:57.000000000 +0100
@@ -369,6 +369,7 @@
 			       cs->hw.teles3.hscx[1] + 96);
 			return (0);
 		}
+		cs->irq_flags |= SA_SHIRQ; /* cardbus can share */
 	} else {
 		if (cs->hw.teles3.cfg_reg) {
 			if (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {
