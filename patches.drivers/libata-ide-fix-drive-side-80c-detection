From: Tejun Heo <htejun@gmail.com>
Subject: [PATCH] libata/ide: fix drive side 80c cable detection
References: 237164
Patch-Mainline: 2.6.20-x or 2.6.21

Drive side 80c cable detection was wrong on both ide and libata.
Fix it.

Signed-off-by: Tejun Heo <htejun@gmail.com>
---
 drivers/ide/ide-iops.c |    2 ++
 include/linux/ata.h    |    2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

Index: linux-2.6.19/drivers/ide/ide-iops.c
===================================================================
--- linux-2.6.19.orig/drivers/ide/ide-iops.c
+++ linux-2.6.19/drivers/ide/ide-iops.c
@@ -607,6 +607,8 @@ u8 eighty_ninty_three (ide_drive_t *driv
 	if(!(drive->id->hw_config & 0x4000))
 		return 0;
 #endif /* CONFIG_IDEDMA_IVB */
+	if (!(drive->id->hw_config & 0x2000))
+		return 0;
 	return 1;
 }
 
Index: linux-2.6.19/include/linux/ata.h
===================================================================
--- linux-2.6.19.orig/include/linux/ata.h
+++ linux-2.6.19/include/linux/ata.h
@@ -347,7 +347,7 @@ static inline int ata_drive_40wire(const
 {
 	if (ata_id_major_version(dev_id) >= 5 && ata_id_is_sata(dev_id))
 		return 0;	/* SATA */
-	if (dev_id[93] & 0x4000)
+	if ((dev_id[93] & 0xE000) == 0x6000)
 		return 0;	/* 80 wire */
 	return 1;
 }
