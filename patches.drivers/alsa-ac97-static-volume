From: Takashi Iwai <tiwai@suse.de>
Subject: [ALSA] ac97 - Add support of static resolution tables
Patch-mainline: 2.6.16-git
References: 116387

[ALSA] ac97 - Add support of static resolution tables

Added the support of static resolution table support for codecs
that the driver cannot probe the volume resolution properly.

The table pointer should be set in each codec patch.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
commit c7dd65e1bfe9152c0b10d24969059c178d6c45eb
tree 06a4aa07fa71a2d176040057c58aee279bf2c949
parent 4e5f4b9c0a6df1a77ccf7ae49bdc14049d50f612
author Takashi Iwai <tiwai@suse.de> Thu, 09 Feb 2006 12:45:20 +0100
committer Takashi Iwai <tiwai@suse.de> Tue, 07 Mar 2006 12:37:47 +0100

 include/sound/ac97_codec.h  |    7 +++++++
 sound/pci/ac97/ac97_codec.c |   12 ++++++++++++
 2 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/include/sound/ac97_codec.h b/include/sound/ac97_codec.h
index ad3fe04..9036d25 100644
--- a/include/sound/ac97_codec.h
+++ b/include/sound/ac97_codec.h
@@ -444,6 +444,12 @@ struct snd_ac97_template {
 	DECLARE_BITMAP(reg_accessed, 0x80); /* bit flags */
 };
 
+/* static resolution table */
+struct snd_ac97_res_table {
+	unsigned short reg;	/* register */
+	unsigned short bits;	/* resolution bitmask */
+};
+
 struct snd_ac97 {
 	/* -- lowlevel (hardware) driver specific -- */
 	struct snd_ac97_build_ops * build_ops;
@@ -464,6 +470,7 @@ struct snd_ac97 {
 	unsigned short caps;	/* capabilities (register 0) */
 	unsigned short ext_id;	/* extended feature identification (register 28) */
 	unsigned short ext_mid;	/* extended modem ID (register 3C) */
+	const struct snd_ac97_res_table *res_table;	/* static resolution */
 	unsigned int scaps;	/* driver capabilities */
 	unsigned int flags;	/* specific code */
 	unsigned int rates[6];	/* see AC97_RATES_* defines */
diff --git a/sound/pci/ac97/ac97_codec.c b/sound/pci/ac97/ac97_codec.c
index 6108cdc..124c1bc 100644
--- a/sound/pci/ac97/ac97_codec.c
+++ b/sound/pci/ac97/ac97_codec.c
@@ -1030,6 +1030,18 @@ static void check_volume_resolution(stru
 	unsigned char max[3] = { 63, 31, 15 };
 	int i;
 
+	/* first look up the static resolution table */
+	if (ac97->res_table) {
+		const struct snd_ac97_res_table *tbl;
+		for (tbl = ac97->res_table; tbl->reg; tbl++) {
+			if (tbl->reg == reg) {
+				*lo_max = tbl->bits & 0xff;
+				*hi_max = (tbl->bits >> 8) & 0xff;
+				return;
+			}
+		}
+	}
+
 	*lo_max = *hi_max = 0;
 	for (i = 0 ; i < ARRAY_SIZE(cbit); i++) {
 		unsigned short val;
