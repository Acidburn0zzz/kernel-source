--- linux-2.6.5/drivers/scsi/libata-core.c~	2004-04-06 09:49:24.305064101 +0200
+++ linux-2.6.5/drivers/scsi/libata-core.c	2004-04-06 09:50:27.774192567 +0200
@@ -40,6 +40,7 @@
 #include "hosts.h"
 #include <linux/libata.h>
 #include <asm/io.h>
+#include <linux/ide.h>
 #include <asm/semaphore.h>
 
 #include "libata.h"
@@ -2099,10 +2100,17 @@
 
 	/* do the actual data transfer */
 	/* FIXME: mmio-ize */
-	if (qc->tf.flags & ATA_TFLAG_WRITE)
-		outsl(ap->ioaddr.data_addr, buf, ATA_SECT_DWORDS);
-	else
-		insl(ap->ioaddr.data_addr, buf, ATA_SECT_DWORDS);
+	if (ap->flags & ATA_FLAG_MMIO) {
+		if (qc->flags & ATA_TFLAG_WRITE)
+			__ide_mm_outsl(ap->ioaddr.data_addr, buf, ATA_SECT_DWORDS);
+		else
+			__ide_mm_insl(ap->ioaddr.data_addr, buf, ATA_SECT_DWORDS);
+	} else {
+		if (qc->flags & ATA_TFLAG_WRITE)
+			outsl(ap->ioaddr.data_addr, buf, ATA_SECT_DWORDS);
+		else
+			insl(ap->ioaddr.data_addr, buf, ATA_SECT_DWORDS);
+	}
 
 	kunmap(sg[qc->cursg].page);
 }
