From: Bastiaan Jacques <b.jacques@planet.nl>
Subject: [ALSA] via82xx: tweak VT8251 workaround
Patch-mainline: 
References: 

[ALSA] via82xx: tweak VT8251 workaround

Move the workaround for the VT8251 up a bit, and check for STAT_EOL
rather than STAT_ACTIVE. This resolves issues some people were having
with certain ALSA clients (and allows the STAT_ACTIVE check to do what
it was intended to do).

This change was suggested by Andrew Daviel.

Signed-off-by: Bastiaan Jacques <b.jacques@planet.nl>
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
commit 7e673b5959bf118ed184605c0d14a94555a26eec
tree 78254adf6f3476f70c9535198cc0e300accdda38
parent c9ad723548f45db01a1c4c4fb69d7a9ffffb387b
author Bastiaan Jacques <b.jacques@planet.nl> Thu, 20 Apr 2006 00:00:00 +0200
committer Takashi Iwai <tiwai@suse.de> Thu, 20 Apr 2006 16:50:36 +0200

 sound/pci/via82xx.c |   16 +++++++---------
 1 files changed, 7 insertions(+), 9 deletions(-)

diff --git a/sound/pci/via82xx.c b/sound/pci/via82xx.c
index 1b740dd..f7a22aa 100644
--- a/sound/pci/via82xx.c
+++ b/sound/pci/via82xx.c
@@ -863,16 +863,14 @@ static snd_pcm_uframes_t snd_via8233_pcm
 	if (!status)
 		status = inb(VIADEV_REG(viadev, OFFSET_STATUS));
 
+	/* An apparent bug in the 8251 is worked around by sending a 
+	 * REG_CTRL_START. */
+	if (chip->revision == VIA_REV_8251 && (status & VIA_REG_STAT_EOL))
+		snd_via82xx_pcm_trigger(substream, SNDRV_PCM_TRIGGER_START);
+
 	if (!(status & VIA_REG_STAT_ACTIVE)) {
-		/* An apparent bug in the 8251 is worked around by sending
-		 * a REG_CTRL_START. */
-		if (chip->revision == VIA_REV_8251)
-			snd_via82xx_pcm_trigger(substream,
-						SNDRV_PCM_TRIGGER_START);
-		else {
-			res = 0;
-			goto unlock;
-		}
+		res = 0;
+		goto unlock;
 	}
 	if (count & 0xffffff) {
 		idx = count >> 24;
