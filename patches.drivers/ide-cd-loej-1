
From Jens Axboe <axboe@suse.de>

Don't log failures to issue a START_STOP_UNIT with LoEj set, since we
cannot reliably tell if the drive can do this or not. Lots of laptop
(and server) cdroms advertise tray loading, even if they are slotted.

--- linux-2.6.5-SUSE-20040426/drivers/ide/ide-cd.c~	2004-04-26 15:18:44.000000000 +0200
+++ linux-2.6.5-SUSE-20040426/drivers/ide/ide-cd.c	2004-04-26 20:58:07.520313290 +0200
@@ -360,6 +360,14 @@ static int cdrom_log_sense(ide_drive_t *
 				break;
 			log = 1;
 			break;
+		case ILLEGAL_REQUEST:
+			/*
+			 * don't log START_STOP unit with LoEj set, since
+			 * we cannot reliably check if drive can auto-close
+			 */
+			if (rq->cmd[0] == GPCMD_START_STOP_UNIT && sense->asc == 0x24)
+				log = 0;
+			break;
 		case UNIT_ATTENTION:
 			/*
 			 * Make good and sure we've seen this potential media
@@ -2152,6 +2160,7 @@ static int cdrom_eject(ide_drive_t *driv
 		       struct request_sense *sense)
 {
 	struct request req;
+	char loej = 0x02;
 
 	if (CDROM_CONFIG_FLAGS(drive)->no_eject && !ejectflag)
 		return -EDRIVE_CANT_DO_THIS;
@@ -2162,9 +2171,13 @@ static int cdrom_eject(ide_drive_t *driv
 
 	cdrom_prepare_request(&req);
 
+	/* only tell drive to close tray if open, if it can do that */
+	if (ejectflag && !CDROM_CONFIG_FLAGS(drive)->close_tray)
+		loej = 0;
+
 	req.sense = sense;
 	req.cmd[0] = GPCMD_START_STOP_UNIT;
-	req.cmd[4] = 0x02 + (ejectflag != 0);
+	req.cmd[4] = loej | (ejectflag != 0);
 	return cdrom_queue_packet_command(drive, &req);
 }
 
