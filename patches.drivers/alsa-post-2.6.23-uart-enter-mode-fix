From: Takashi Iwai <tiwai@suse.de>
Subject: [ALSA] Fix UART enter mode
Patch-mainline: 2.6.24-rc1
References: 

Fixed UART-ENTER command bugs in some MPU-compatible devices.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 Documentation/sound/alsa/ALSA-Configuration.txt |    1 -
 include/sound/mpu401.h                          |    1 -
 sound/drivers/mpu401/mpu401.c                   |    6 ++++--
 sound/drivers/mpu401/mpu401_uart.c              |    3 +--
 4 files changed, 5 insertions(+), 6 deletions(-)

--- a/Documentation/sound/alsa/ALSA-Configuration.txt	2007-10-31 17:45:05.000000000 -0400
+++ b/Documentation/sound/alsa/ALSA-Configuration.txt	2007-10-31 17:45:05.000000000 -0400
@@ -1389,7 +1389,6 @@ Prior to version 0.9.0rc4 options had a 
     port	- port number or -1 (disable)
     irq		- IRQ number or -1 (disable)
     pnp		- PnP detection - 0 = disable, 1 = enable (default)
-    uart_enter	- Issue UART_ENTER command at open - bool, default = on
 
     This module supports multiple devices and PnP.
     
--- a/include/sound/mpu401.h	2007-10-31 17:43:11.000000000 -0400
+++ b/include/sound/mpu401.h	2007-10-31 17:45:05.000000000 -0400
@@ -50,7 +50,6 @@
 #define MPU401_INFO_INTEGRATED	(1 << 2)	/* integrated h/w port */
 #define MPU401_INFO_MMIO	(1 << 3)	/* MMIO access */
 #define MPU401_INFO_TX_IRQ	(1 << 4)	/* independent TX irq */
-#define MPU401_INFO_UART_ONLY	(1 << 5)	/* No ENTER_UART cmd needed */
 
 #define MPU401_MODE_BIT_INPUT		0
 #define MPU401_MODE_BIT_OUTPUT		1
--- a/sound/drivers/mpu401/mpu401.c	2007-10-31 17:43:11.000000000 -0400
+++ b/sound/drivers/mpu401/mpu401.c	2007-10-31 17:45:05.000000000 -0400
@@ -70,6 +70,9 @@ static int snd_mpu401_create(int dev, st
 	struct snd_card *card;
 	int err;
 
+	if (!uart_enter[dev])
+		snd_printk(KERN_ERR "the uart_enter option is obsolete; remove it\n");
+
 	*rcard = NULL;
 	card = snd_card_new(index[dev], id[dev], THIS_MODULE, 0);
 	if (card == NULL)
@@ -83,8 +86,7 @@ static int snd_mpu401_create(int dev, st
 		strcat(card->longname, "polled");
 	}
 
-	err = snd_mpu401_uart_new(card, 0, MPU401_HW_MPU401, port[dev],
-				  uart_enter[dev] ? 0 : MPU401_INFO_UART_ONLY,
+	err = snd_mpu401_uart_new(card, 0, MPU401_HW_MPU401, port[dev], 0,
 				  irq[dev], irq[dev] >= 0 ? IRQF_DISABLED : 0,
 				  NULL);
 	if (err < 0) {
--- a/sound/drivers/mpu401/mpu401_uart.c	2007-10-31 17:43:11.000000000 -0400
+++ b/sound/drivers/mpu401/mpu401_uart.c	2007-10-31 17:45:05.000000000 -0400
@@ -270,8 +270,7 @@ static int snd_mpu401_do_reset(struct sn
 {
 	if (snd_mpu401_uart_cmd(mpu, MPU401_RESET, 1))
 		return -EIO;
-	if (!(mpu->info_flags & MPU401_INFO_UART_ONLY) &&
-	    snd_mpu401_uart_cmd(mpu, MPU401_ENTER_UART, 1))
+	if (snd_mpu401_uart_cmd(mpu, MPU401_ENTER_UART, 0))
 		return -EIO;
 	return 0;
 }
