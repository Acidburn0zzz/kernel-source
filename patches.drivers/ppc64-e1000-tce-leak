 ChangeSet 1.1453.1.6 2004/02/24 10:56:17 olof@olof.austin.ibm.com
   Temporary TCE leak fix until we get a patch from upstream.
 drivers/net/e1000/e1000_main.c 1.93 2004/02/24 10:51:53 olof@olof.austin.ibm.com
   Don't wrap the ring in tx_map, since that'll lead to TCE leaks

diff -purN linux-2.5/drivers/net/e1000/e1000_main.c linuxppc64-2.5/drivers/net/e1000/e1000_main.c
--- linux-2.5/drivers/net/e1000/e1000_main.c	2004-02-20 22:09:55.000000000 +0000
+++ linuxppc64-2.5/drivers/net/e1000/e1000_main.c	2004-02-26 05:41:58.000000000 +0000
@@ -1582,7 +1582,7 @@ e1000_tx_map(struct e1000_adapter *adapt
 
 	i = tx_ring->next_to_use;
 
-	while(len) {
+	while(len && count < E1000_DESC_UNUSED(&adapter->tx_ring)) {
 		buffer_info = &tx_ring->buffer_info[i];
 		size = min(len, max_per_txd);
 #ifdef NETIF_F_TSO
@@ -1619,7 +1619,7 @@ e1000_tx_map(struct e1000_adapter *adapt
 		len = frag->size;
 		offset = frag->page_offset;
 
-		while(len) {
+		while(len && count < E1000_DESC_UNUSED(&adapter->tx_ring)) {
 			buffer_info = &tx_ring->buffer_info[i];
 			size = min(len, max_per_txd);
 #ifdef NETIF_F_TSO
