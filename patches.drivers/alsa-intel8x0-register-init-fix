From: Takashi Iwai <tiwai@suse.de>
Subject: [ALSA] intel8x0 - wait for ICH_RESETREGS
Patch-mainline: 
References: 

[ALSA] intel8x0 - wait for ICH_RESETREGS

It seems that hardware requires some time to reset bus master registers.
We need to wait until ICH_RESETREGS bit is not released.

The suggestion and symptom was described by Mike Gorchak <lestat@i.com.ua>.

Signed-off-by: Jaroslav Kysela <perex@suse.cz>

---
commit 866f579861abc3516dd681c3622e6b70c2629a55
tree 22ade039ef2006c987f3b5cecb92a1a93b55b5de
parent 2f0fc34d04efc7ceee451971e92dd8e4f3b04165
author Jaroslav Kysela <perex@suse.cz> Wed, 15 Feb 2006 14:31:23 +0100
committer Takashi Iwai <tiwai@suse.de> Thu, 16 Feb 2006 20:54:26 +0100

 sound/pci/intel8x0.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/sound/pci/intel8x0.c b/sound/pci/intel8x0.c
index da024ff..ebbf2cf 100644
--- a/sound/pci/intel8x0.c
+++ b/sound/pci/intel8x0.c
@@ -2351,7 +2351,7 @@ static int snd_intel8x0_ali_chip_init(st
 
 static int snd_intel8x0_chip_init(struct intel8x0 *chip, int probing)
 {
-	unsigned int i;
+	unsigned int i, timeout;
 	int err;
 	
 	if (chip->device_type != DEVICE_ALI) {
@@ -2369,6 +2369,15 @@ static int snd_intel8x0_chip_init(struct
 	/* reset channels */
 	for (i = 0; i < chip->bdbars_count; i++)
 		iputbyte(chip, ICH_REG_OFF_CR + chip->ichd[i].reg_offset, ICH_RESETREGS);
+	for (i = 0; i < chip->bdbars_count; i++) {
+	        timeout = 100000;
+	        while (--timeout != 0) {
+        		if ((igetbyte(chip, ICH_REG_OFF_CR + chip->ichd[i].reg_offset) & ICH_RESETREGS) == 0)
+        		        break;
+                }
+                if (timeout == 0)
+                        printk(KERN_ERR "intel8x0: reset of registers failed?\n");
+        }
 	/* initialize Buffer Descriptor Lists */
 	for (i = 0; i < chip->bdbars_count; i++)
 		iputdword(chip, ICH_REG_OFF_BDBAR + chip->ichd[i].reg_offset,
