Date: Wed, 21 Apr 2004 09:08:31 -0400
From: Ben Collins <bcollins@debian.org>
To: Olaf Hering <olh@suse.de>
Cc: linux1394-devel@lists.sourceforge.net
Subject: Re: rmmod ohci1394 hangs with 2.6.6rc2, works with 2.6.5

On Wed, Apr 21, 2004 at 01:24:02PM +0200, Olaf Hering wrote:
> 
> see attached message. rmmod the hostcontroller driver does not work
> anymore with 2.6.6rc2, but it did work ok with 2.6.5.
> this is required for powermanagement on intel.

Oh fuck. This is from the removal of accepting the SIGTERM from the
kernel threads. Which means the kill_proc(hi->pid, SIGTERM, 1) in
nodemgr.c:nodemgr_remove_host() doesn't kill the proc, and it means it
waits for ever for it to do so.

See if this works. I haven't even test compiled it, so fair warning.


===== drivers/ieee1394/nodemgr.c 1.54 vs edited =====
--- 1.54/drivers/ieee1394/nodemgr.c	Tue Apr  6 07:34:15 2004
+++ edited/drivers/ieee1394/nodemgr.c	Wed Apr 21 09:07:41 2004
@@ -117,6 +117,7 @@
 	struct semaphore reset_sem;
 	int pid;
 	char daemon_name[15];
+	int kill_me;
 };
 
 static int nodemgr_bus_match(struct device * dev, struct device_driver * drv);
@@ -1478,6 +1479,9 @@
 		unsigned int generation = 0;
 		int i;
 
+		if (hi->kill_me)
+			break;
+
 		/* Pause for 1/4 second in 1/16 second intervals,
 		 * to make sure things settle down. */
 		for (i = 0; i < 4 ; i++) {
@@ -1678,7 +1682,9 @@
 
 	if (hi) {
 		if (hi->pid >= 0) {
-			kill_proc(hi->pid, SIGTERM, 1);
+			hi->kill_me = 1;
+			mb();
+			up(&hi->reset_sem);
 			wait_for_completion(&hi->exited);
 			nodemgr_remove_host_dev(&host->device);
 		}

-- 
Debian     - http://www.debian.org/
Linux 1394 - http://www.linux1394.org/
Subversion - http://subversion.tigris.org/
WatchGuard - http://www.watchguard.com/

