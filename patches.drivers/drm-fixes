From: Egbert Eich <eich@suse.de>
Subject: DRM: Fix 32bit support on x86_64 (MGA and Rage128)
References: 78708

-  Fix for signature of an ioctl32 on r128 
-  Fix for offset of AGP base on mga 
-  Fix, to achieve consistent structure size on 32 and 64bit 
-  Fix race condition in drm driver 

Index: linux/drivers/char/drm/drm_bufs.c
===================================================================
RCS file: /work/kernelcvs/linux/drivers/char/drm/drm_bufs.c,v
retrieving revision 1.1.1.2
diff -u -r1.1.1.2 drm_bufs.c
--- linux/drivers/char/drm/drm_bufs.c	1 Apr 2005 13:55:27 -0000	1.1.1.2
+++ linux/drivers/char/drm/drm_bufs.c	19 Apr 2005 18:06:47 -0000
@@ -44,8 +44,8 @@
     drm_map_list_t *r_list = NULL;
    
     hash = (unsigned int)(((lhandle >> 32) 
-			   + (lhandle >> 16) 
-			   + lhandle) & 0xffff0000);
+			   + (lhandle >> 16 & 0xffff0000) 
+			   + lhandle) & PAGE_MASK);
     while (1) {
 	if (hash == 0) hash = (1 << 16);
 	list = &dev->maplist->head;
@@ -221,16 +221,17 @@
 	list->map = map;
 
 	down(&dev->struct_sem);
+	map->pub_handle =
+	    (map->type == _DRM_SHM 
+			? HandleID((unsigned long)map->handle,dev) 
+			: HandleID(map->offset,dev));
 	list_add(&list->head, &dev->maplist->head);
  	up(&dev->struct_sem);
 	
-	map->pub_handle =
-	tmp_map.handle = (map->type == _DRM_SHM 
-			  ? HandleID((unsigned long)map->handle,dev) 
-			  : HandleID(map->offset,dev));
 	DRM_DEBUG("HandleID = 0x%lx addr = %p offset = 0x%lx\n",
 		   map->pub_handle,map->handle,map->offset);
 
+	tmp_map.handle = map->pub_handle;
 	if ( copy_to_user( argp, &tmp_map, sizeof(tmp_map) ) )
 		return -EFAULT;
 
Index: linux/drivers/char/drm/drm_context.c
===================================================================
RCS file: /work/kernelcvs/linux/drivers/char/drm/drm_context.c,v
retrieving revision 1.1.1.2
diff -u -r1.1.1.2 drm_context.c
--- linux/drivers/char/drm/drm_context.c	1 Apr 2005 13:55:27 -0000	1.1.1.2
+++ linux/drivers/char/drm/drm_context.c	19 Apr 2005 18:06:47 -0000
@@ -369,7 +369,7 @@
 		for ( i = 0 ; i < DRM_RESERVED_CONTEXTS ; i++ ) {
 			ctx.handle = i;
 			if ( copy_to_user( &res.contexts[i],
-					   &i, sizeof(i) ) )
+					   &ctx, sizeof(ctx) ) )
 				return -EFAULT;
 		}
 	}
Index: linux/drivers/char/drm/drm_ioctl32.c
===================================================================
RCS file: /work/kernelcvs/linux/drivers/char/drm/Attic/drm_ioctl32.c,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 drm_ioctl32.c
--- linux/drivers/char/drm/drm_ioctl32.c	1 Apr 2005 13:55:27 -0000	1.1.1.1
+++ linux/drivers/char/drm/drm_ioctl32.c	19 Apr 2005 18:06:47 -0000
@@ -66,10 +66,8 @@
 #define DRM_IOCTL_MAP_BUFS_32		DRM_IOWR(0x19, drm32_buf_map_t)
 #define DRM_IOCTL_FREE_BUFS_32		DRM_IOW( 0x1a, drm32_buf_free_t)
 #define DRM_IOCTL_RM_MAP_32		DRM_IOW( 0x1b, drm32_map_t)
-#if 0
 #define DRM_IOCTL_SET_SAREA_CTX_32	DRM_IOW( 0x1c, drm32_ctx_priv_map_t)
 #define DRM_IOCTL_GET_SAREA_CTX_32 	DRM_IOWR(0x1d, drm32_ctx_priv_map_t)
-#endif
 #define DRM_IOCTL_RES_CTX_32		DRM_IOWR(0x26, drm32_ctx_res_t)
 #define DRM_IOCTL_DMA_32		DRM_IOWR(0x29, drm32_dma_t)
 #define DRM_IOCTL_AGP_ENABLE_32		DRM_IOW( 0x32, drm32_agp_mode_t)
@@ -108,12 +106,10 @@
 /*?*/	unsigned int	iocs;	/* Ioctl count                              */
 } drm32_client_t;
 
-#if 0
 typedef struct drm32_ctx_priv_map {
 	unsigned int	ctx_id;  /* Context requesting private mapping */
 /*?*/	u32		handle;  /* Handle of map */
 } drm32_ctx_priv_map_t;
-#endif
 
 typedef struct drm32_buf_desc { /* OK */
 	int	      count;	 /* Number of buffers of this size	     */
@@ -452,7 +448,6 @@
     return err ? -EFAULT : 0;
 }
 
-#if 0
 static int
 drm_ctx_priv_map_wr_32_64(unsigned int fd, unsigned int cmd, 
 			  unsigned long arg, struct file *file)
@@ -465,7 +460,7 @@
 
     DEBUG("drm_ctx_priv_map_wr_32_64");
     GET_USER(ctx_id);
-//    GET_USER_P(handle);
+//    GET_USER(handle);
 
     if (err) return -EFAULT;
     
@@ -473,7 +468,7 @@
     if (err) return err;
     
 //    PUT_USER(ctx_id);
-    PUT_USER_P(handle);
+    PUT_USER(handle);
 
     DEBUG("done");
     return err ? -EFAULT : 0;
@@ -491,7 +486,7 @@
 
     DEBUG("drm_ctx_priv_map_w_32_64");
     GET_USER(ctx_id);
-    GET_USER_P(handle);
+    GET_USER(handle);
 
     if (err) return -EFAULT;
     
@@ -500,7 +495,6 @@
     DEBUG("done");
     return err;
 }
-#endif
 
 static int
 drm_ctx_res_32_64(unsigned int fd, unsigned int cmd, 
@@ -960,10 +954,8 @@
     REG_IOCTL32(DRM_IOCTL_MAP_BUFS_32,drm_buf_map_32_64);
     REG_IOCTL32(DRM_IOCTL_FREE_BUFS_32,drm_buf_free_w_32_64);
     REG_IOCTL32(DRM_IOCTL_RM_MAP_32,drm_map_w_32_64);
-#if 0
     REG_IOCTL32(DRM_IOCTL_SET_SAREA_CTX_32,drm_ctx_priv_map_w_32_64);
     REG_IOCTL32(DRM_IOCTL_GET_SAREA_CTX_32,drm_ctx_priv_map_wr_32_64);
-#endif
     REG_IOCTL32(DRM_IOCTL_RES_CTX_32,drm_ctx_res_32_64)
     REG_IOCTL32(DRM_IOCTL_DMA_32,drm_dma_32_64);
     REG_IOCTL32(DRM_IOCTL_AGP_ENABLE_32,drm_agp_mode_w_32_64);
@@ -982,8 +974,10 @@
     REG_IOCTL32(DRM_IOCTL_BLOCK,drm32_default_handler);
     REG_IOCTL32(DRM_IOCTL_UNBLOCK,drm32_default_handler);
     REG_IOCTL32(DRM_IOCTL_CONTROL,drm32_default_handler);
+#if 0
     REG_IOCTL32(DRM_IOCTL_SET_SAREA_CTX,drm32_default_handler);
     REG_IOCTL32(DRM_IOCTL_GET_SAREA_CTX,drm32_default_handler);
+#endif
     REG_IOCTL32(DRM_IOCTL_ADD_CTX,drm32_default_handler);
     REG_IOCTL32(DRM_IOCTL_RM_CTX,drm32_default_handler);
     REG_IOCTL32(DRM_IOCTL_MOD_CTX,drm32_default_handler);
@@ -1012,10 +1006,8 @@
     UNREG_IOCTL32(DRM_IOCTL_VERSION_32);
     UNREG_IOCTL32(DRM_IOCTL_GET_UNIQUE_32);
     UNREG_IOCTL32(DRM_IOCTL_GET_CLIENT_32);
-#if 0
     UNREG_IOCTL32(DRM_IOCTL_SET_SAREA_CTX_32);
     UNREG_IOCTL32(DRM_IOCTL_GET_SAREA_CTX_32);
-#endif
     UNREG_IOCTL32(DRM_IOCTL_RES_CTX_32);
     UNREG_IOCTL32(DRM_IOCTL_DMA_32);
     
@@ -1047,8 +1039,10 @@
     UNREG_IOCTL32(DRM_IOCTL_BLOCK);
     UNREG_IOCTL32(DRM_IOCTL_UNBLOCK);
     UNREG_IOCTL32(DRM_IOCTL_CONTROL);
+#if 0
     UNREG_IOCTL32(DRM_IOCTL_SET_SAREA_CTX);
     UNREG_IOCTL32(DRM_IOCTL_GET_SAREA_CTX);
+#endif
     UNREG_IOCTL32(DRM_IOCTL_ADD_CTX);
     UNREG_IOCTL32(DRM_IOCTL_RM_CTX);
     UNREG_IOCTL32(DRM_IOCTL_MOD_CTX);
Index: linux/drivers/char/drm/r128_drm.h
===================================================================
RCS file: /work/kernelcvs/linux/drivers/char/drm/r128_drm.h,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 r128_drm.h
--- linux/drivers/char/drm/r128_drm.h	20 Nov 2004 10:55:18 -0000	1.1.1.1
+++ linux/drivers/char/drm/r128_drm.h	19 Apr 2005 18:06:47 -0000
@@ -215,7 +215,7 @@
 #define DRM_IOCTL_R128_INDIRECT   DRM_IOWR(DRM_COMMAND_BASE + DRM_R128_INDIRECT, drm_r128_indirect_t)
 #define DRM_IOCTL_R128_FULLSCREEN DRM_IOW( DRM_COMMAND_BASE + DRM_R128_FULLSCREEN, drm_r128_fullscreen_t)
 #define DRM_IOCTL_R128_CLEAR2     DRM_IOW( DRM_COMMAND_BASE + DRM_R128_CLEAR2, drm_r128_clear2_t)
-#define DRM_IOCTL_R128_GETPARAM   DRM_IOW( DRM_COMMAND_BASE + DRM_R128_GETPARAM, drm_r128_getparam_t)
+#define DRM_IOCTL_R128_GETPARAM   DRM_IOWR( DRM_COMMAND_BASE + DRM_R128_GETPARAM, drm_r128_getparam_t)
 #define DRM_IOCTL_R128_FLIP       DRM_IO(  DRM_COMMAND_BASE + DRM_R128_FLIP)
 
 typedef struct drm_r128_init {
Index: linux/drivers/char/drm/r128_ioctl32.c
===================================================================
RCS file: /work/kernelcvs/linux/drivers/char/drm/Attic/r128_ioctl32.c,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 r128_ioctl32.c
--- linux/drivers/char/drm/r128_ioctl32.c	1 Apr 2005 13:55:27 -0000	1.1.1.1
+++ linux/drivers/char/drm/r128_ioctl32.c	19 Apr 2005 18:06:47 -0000
@@ -49,7 +49,7 @@
 #define DRM_IOCTL_R128_INIT32		DRM_IOW( 0x40, drm32_r128_init_t)
 #define DRM_IOCTL_R128_DEPTH32		DRM_IOW( 0x4c, drm32_r128_depth_t)
 #define DRM_IOCTL_R128_STIPPLE32	DRM_IOW( 0x4d, drm32_r128_stipple_t)
-#define DRM_IOCTL_R128_GETPARAM32	DRM_IOW( 0x52, drm32_r128_getparam_t)
+#define DRM_IOCTL_R128_GETPARAM32	DRM_IOWR( 0x52, drm32_r128_getparam_t)
 
 typedef struct drm32_r128_init {
 	int func;
ivers/cifs-1.33-update
-'  2  28  /work/ul-kernel/sles9-sp2/patches.drivers/cifs-1.33-update
-'  1  0  /work/ul-kernel/sles9-sp2/patches.drivers/cifs-1.32-update
-'  6  0  /work/ul-kernel/sles9-sp2/patches.drivers/cifs-1.32-update
-'  7  0  /work/ul-kernel/sles9-sp2/patches.drivers/cifs-1.33-update
-'  1  0  /work/ul-kernel/sles8/patches.common/locks_remove_posix-race.diff
-'  1  0  /work/ul-kernel/sles8/kernel-source.changes
-'  4150  32  /work/ul-kernel/sles9-sp2/series.conf
-'  4083  17  /work/ul-kernel/sles9-sp2/series.conf
-'  4149  1  /work/ul-kernel/sles9-sp2/series.conf
