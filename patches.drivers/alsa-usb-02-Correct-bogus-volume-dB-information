From eedbdf03a25ab3b2c332ad7fa205aa8ffbe477ba Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Tue, 16 Jun 2009 14:27:35 +0200
Subject: ALSA: usb-audio - Correct bogus volume dB information
Patch-mainline: 
References: 

Some USB devices give bogus dB information and it screws up PA.
It's better to detect a broken value and correct it in the driver
before exposing the value to the outside.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/usb/usbmixer.c |    9 +++++++++
 1 file changed, 9 insertions(+)

--- a/sound/usb/usbmixer.c
+++ b/sound/usb/usbmixer.c
@@ -470,6 +470,15 @@
 	 */
 	scale[2] = (convert_signed_value(cval, cval->min) * 100) / 256;
 	scale[3] = (convert_signed_value(cval, cval->max) * 100) / 256;
+	if (scale[3] <= scale[2]) {
+		/* something is wrong; assume it's either from/to 0dB */
+		if (scale[2] < 0)
+			scale[3] = 0;
+		else if (scale[2] > 0)
+			scale[2] = 0;
+		else /* totally crap, return an error */
+			return -EINVAL;
+	}
 	if (copy_to_user(_tlv, scale, sizeof(scale)))
 		return -EFAULT;
 	return 0;
