From: garloff@suse.de
Subject: Avoid serialize recursion in cmd64x.
Patch-mainline: 
References: SUSE49565

Using hdparm -d1 on cmd64x recurses on ide_pin_hwgroup and thus hangs.
Here's the call trace:

set_using_dma() 
  ide_pin_hwgroup()                                       <---
  hwif->ide_dma_check() == cmd64x_config_drive_for_dma()
    config_chipset_for_dma()
      config_chipset_for_pio()
      ide_set_xfer_rate()
        ide_pin_hwgroup()                                 <---
        hwif->speedproc() == cmd64x_tune_chipset()

Fix is easy: Call cmd64x_tune_chipset() directly instead of calling
the wrapper that calls it but pins the already pinned hwgroup before.

Acked-by: 
Signed-off-by: axboe@suse.de

--- linux-2.6.10/drivers/ide/pci/cmd64x.c~	2005-02-01 11:09:16.000000000 +0100
+++ linux-2.6.10/drivers/ide/pci/cmd64x.c	2005-02-01 11:09:21.000000000 +0100
@@ -426,7 +426,7 @@
 	if (!speed)
 		return 0;
 
-	if(ide_set_xfer_rate(drive, speed))
+	if (cmd64x_tune_chipset(drive, speed))
 		return 0; 
 
 	if (!drive->init_speed)

