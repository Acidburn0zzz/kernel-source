From:	Alan Cox <alan@lxorguk.ukuu.org.uk>
Subject: [PATCH] Fix HPA handling regression
References: 329584
Patch-Mainline: pending

Restore the support for handling drives that report one sector too many
(ie SCSI not ATA style). This worked before the HPA update but was
removed in that process

Signed-off-by: Alan Cox <alan@redhat.com>
Signed-off-by: Tejun Heo <teheo@suse.de>
---
---
 drivers/ata/libata-core.c |    7 ++++++-
 include/linux/libata.h    |    1 +
 2 files changed, 7 insertions(+), 1 deletion(-)

--- a/drivers/ata/libata-core.c	2007-10-31 17:44:47.000000000 -0400
+++ b/drivers/ata/libata-core.c	2007-10-31 17:44:48.000000000 -0400
@@ -930,7 +930,8 @@ static int ata_read_native_max_address(s
 		*max_sectors = ata_tf_to_lba48(&tf);
 	else
 		*max_sectors = ata_tf_to_lba(&tf);
-
+        if (dev->horkage & ATA_HORKAGE_HPA_SIZE)
+		(*max_sectors)--;
 	return 0;
 }
 
@@ -3927,6 +3928,10 @@ static const struct ata_blacklist_entry 
 	{ "WDC WD2500JD-00HBB0", "WD-WMAL71490727", ATA_HORKAGE_BROKEN_HPA },
 	{ "MAXTOR 6L080L4",	"A93.0500",	ATA_HORKAGE_BROKEN_HPA },
 
+	/* Devices which report 1 sector over size HPA */
+	{ "ST340823A",		NULL,		ATA_HORKAGE_HPA_SIZE, },
+	{ "ST320413A",		NULL,		ATA_HORKAGE_HPA_SIZE, },
+
 	/* End Marker */
 	{ }
 };
--- a/include/linux/libata.h	2007-10-31 17:44:47.000000000 -0400
+++ b/include/linux/libata.h	2007-10-31 17:44:48.000000000 -0400
@@ -329,6 +329,7 @@ enum {
 	ATA_HORKAGE_MAX_SEC_128	= (1 << 3),	/* Limit max sects to 128 */
 	ATA_HORKAGE_BROKEN_HPA	= (1 << 4),	/* Broken HPA */
 	ATA_HORKAGE_SKIP_PM	= (1 << 5),	/* Skip PM operations */
+	ATA_HORKAGE_HPA_SIZE	= (1 << 6), 	/* Reports native size off by one */
 
 	/* DMA mask for user DMA control: User visible values do not
 	   renumber */
