From: Takashi Iwai <tiwai@suse.de>
Subject: [ALSA] Add Kconfig for AC97 power_save default
Patch-mainline: 2.6.24-rc1
References: 

Added the Kconfig option for the default AC97 power_save value.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

--- linux-2.6.23/sound/pci/ac97/ac97_codec.c-dist	2007-10-17 13:02:09.000000000 +0200
+++ linux-2.6.23/sound/pci/ac97/ac97_codec.c	2007-10-17 13:07:18.000000000 +0200
@@ -49,7 +49,7 @@ module_param(enable_loopback, bool, 0444
 MODULE_PARM_DESC(enable_loopback, "Enable AC97 ADC/DAC Loopback Control");
 
 #ifdef CONFIG_SND_AC97_POWER_SAVE
-static int power_save;
+static int power_save = CONFIG_SND_AC97_POWER_SAVE_DEFAULT;
 module_param(power_save, bool, 0644);
 MODULE_PARM_DESC(power_save, "Enable AC97 power-saving control");
 #endif
--- linux-2.6.23/sound/pci/Kconfig-dist	2007-10-09 22:31:38.000000000 +0200
+++ linux-2.6.23/sound/pci/Kconfig	2007-10-17 13:07:18.000000000 +0200
@@ -799,4 +799,12 @@
 	  snd-ac97-codec driver.  You can toggle it dynamically over
 	  sysfs, too.
 
+config SND_AC97_POWER_SAVE_DEFAULT
+	int "Default time-out for AC97 power-save mode"
+	depends on SND_AC97_POWER_SAVE
+	default 0
+	help
+	  The default time-out value in seconds for AC97 automatic
+	  power-save mode.  0 means to disable the power-save mode.
+
 endmenu
--- linux-2.6.23/Documentation/sound/alsa/powersave.txt-dist	2007-10-17 13:07:18.000000000 +0200
+++ linux-2.6.23/Documentation/sound/alsa/powersave.txt	2007-10-17 13:07:18.000000000 +0200
@@ -0,0 +1,41 @@
+Notes on Power-Saving Mode
+==========================
+
+AC97 and HD-audio drivers have the automatic power-saving mode.
+This feature is enabled via Kconfig CONFIG_SND_AC97_POWER_SAVE
+and CONFIG_SND_HDA_POWER_SAVE options, respectively.
+
+With the automatic power-saving, the driver turns off the codec power
+appropriately when no operation is required.  When no applications use
+the device and/or no analog loopback is set, the power disablement is
+done fully or partially.  It'll save a certain power consumption, thus
+good for laptops (even for desktops).
+
+The time-out for automatic power-off can be specified via power_save
+module option of snd-ac97-codec and snd-hda-intel modules.  Specify
+the time-out value in seconds.  0 means to disable the automatic
+power-saving.  The default value of timeout is given via
+CONFIG_SND_AC97_POWER_SAVE_DEFAULT and
+CONFIG_SND_HDA_POWER_SAVE_DEFAULT Kconfig options.  Setting this to 1
+(the minimum value) isn't recommended because many applications try to
+reopen the device frequently.  10 would be a good choice for normal
+operations.
+
+The power_save option is exported as writable.  This means you can
+adjust the value via sysfs on the fly.  For example, to turn on the
+automatic power-save mode with 10 seconds, write to
+/sys/modules/snd_ac97_codec/parameters/power_save (usually as root):
+
+	# echo 10 > /sys/modules/snd_ac97_codec/parameters/power_save
+
+
+Note that you might hear click noise/pop when changing the power
+state.  Also, it often takes certain time to wake up from the
+power-down to the active state.  These are often hardly to fix, so
+don't report extra bug reports unless you have a fix patch ;-)
+
+For HD-audio interface, there is another module option,
+power_save_controller.  This enables/disables the power-save mode of
+the controller side.  Setting this on may reduce a bit more power
+consumption, but might result in longer wake-up time and click noise.
+Try to turn it off when you experience such a thing too often.
--- linux-2.6.23/Documentation/sound/alsa/ALSA-Configuration.txt-dist	2007-10-09 22:31:38.000000000 +0200
+++ linux-2.6.23/Documentation/sound/alsa/ALSA-Configuration.txt	2007-10-17 13:07:18.000000000 +0200
@@ -768,6 +768,10 @@
     single_cmd  - Use single immediate commands to communicate with
 		codecs (for debugging only)
     enable_msi	- Enable Message Signaled Interrupt (MSI) (default = off)
+    power_save	- Automatic power-saving timtout (in second, 0 =
+		disable)
+    power_save_controller - Reset HD-audio controller in power-saving mode
+		(default = on)
 
     This module supports one card and autoprobe.
 
