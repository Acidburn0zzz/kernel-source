From: Dean Nelson <dcn@sgi.com>
Subject: SGI SN: Eliminate dependency of the XP/XPC drivers on GRU.
Patch-mainline: no
References: bnc#442442

For the time being build for ia64-sn2 alone when CONFIG_IA64_GENERIC is
specified.

Signed-off-by: Dean Nelson <dcn@sgi.com>
Acked-by: Raymund Will <rw@suse.de>

---

 drivers/misc/sgi-xp/Makefile   |    4 ++--
 drivers/misc/sgi-xp/xp.h       |    4 ++++
 drivers/misc/sgi-xp/xpc_main.c |    4 ++--
 3 files changed, 8 insertions(+), 4 deletions(-)

Index: linux/drivers/misc/sgi-xp/Makefile
===================================================================
--- linux.orig/drivers/misc/sgi-xp/Makefile	2008-10-23 10:59:42.000000000 -0500
+++ linux/drivers/misc/sgi-xp/Makefile	2008-10-23 10:59:44.000000000 -0500
@@ -5,14 +5,14 @@
 obj-$(CONFIG_SGI_XP)		+= xp.o
 xp-y				:= xp_main.o
 xp-$(CONFIG_IA64_SGI_SN2)	+= xp_sn2.o xp_nofault.o
-xp-$(CONFIG_IA64_GENERIC)	+= xp_sn2.o xp_nofault.o xp_uv.o
+xp-$(CONFIG_IA64_GENERIC)	+= xp_sn2.o xp_nofault.o
 xp-$(CONFIG_IA64_SGI_UV)	+= xp_uv.o
 xp-$(CONFIG_X86_64)		+= xp_uv.o
 
 obj-$(CONFIG_SGI_XP)		+= xpc.o
 xpc-y				:= xpc_main.o xpc_channel.o xpc_partition.o
 xpc-$(CONFIG_IA64_SGI_SN2)	+= xpc_sn2.o
-xpc-$(CONFIG_IA64_GENERIC)	+= xpc_sn2.o xpc_uv.o
+xpc-$(CONFIG_IA64_GENERIC)	+= xpc_sn2.o
 xpc-$(CONFIG_IA64_SGI_UV) 	+= xpc_uv.o
 xpc-$(CONFIG_X86_64)		+= xpc_uv.o
 
Index: linux/drivers/misc/sgi-xp/xp.h
===================================================================
--- linux.orig/drivers/misc/sgi-xp/xp.h	2008-10-23 10:59:42.000000000 -0500
+++ linux/drivers/misc/sgi-xp/xp.h	2008-10-23 10:59:44.000000000 -0500
@@ -19,7 +19,11 @@
 #include <asm/system.h>
 #include <asm/sn/arch.h>	/* defines is_shub1() and is_shub2() */
 #define is_shub()	ia64_platform_is("sn2")
+#ifdef CONFIG_IA64_SGI_UV
 #define is_uv()		ia64_platform_is("uv")
+#else
+#define is_uv()		0
+#endif
 #endif
 #ifdef CONFIG_X86_64
 #include <asm/genapic.h>
Index: linux/drivers/misc/sgi-xp/xpc_main.c
===================================================================
--- linux.orig/drivers/misc/sgi-xp/xpc_main.c	2008-10-23 10:59:42.000000000 -0500
+++ linux/drivers/misc/sgi-xp/xpc_main.c	2008-10-23 10:59:44.000000000 -0500
@@ -1104,7 +1104,7 @@ xpc_do_exit(enum xp_retval reason)
 
 	if (is_shub())
 		xpc_exit_sn2();
-	else
+	else if (is_uv())
 		xpc_exit_uv();
 }
 
@@ -1363,7 +1363,7 @@ out_2:
 out_1:
 	if (is_shub())
 		xpc_exit_sn2();
-	else
+	else if (is_uv())
 		xpc_exit_uv();
 	return ret;
 }

