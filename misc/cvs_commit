#! /bin/sh

#
# Record that a CVS commit has happened.
#

COMMITS_DIR=$HOME/COMMITS
LOGFILE=$HOME/kbuild.log

log() {
    local msg=$1 date=$(date "+%Y-%m-%d %H:%M:%S")

    echo "$date $msg" >> $LOGFILE
}

# Read the path in which the updates did occur, the files updated,
# the user doing the update, and the update timestamp.
while read path updates ; do
    [ -n "$path" ] && break
done
repository=${path%%/*}
read user
read date_str
# CVS wraps long file/versions lines at ~2040 characters. Some wrapped
# lines (but not all) end in a '!'. Take care of this by shifting up
# the user name and date_str until we reach the following blank line.
while : ; do
    updates=${updates%!}
    if ! read blankline || [ -z "$blankline" ]; then
        break
    fi
    updates="$updates$user"
    user="$date_str"
    date_str="$blankline"
done
exec 1<&-

# Find out the branch the commit belongs to.
tagnames=( $(sed -ne 's/^      Tag: \([-_a-zA-Z0-9]*\)$/\1/p') )
tagname=${tagnames[0]}
for t in "${tagnames[@]}"; do
    if [ "$t" != "$tagname" ]; then
	tagname='?'
	break
    fi
done
[ -z "$tagname" ] && tagname="HEAD"

if [ -d $COMMITS_DIR/$repository ]; then
    echo $user $date_str >> "$COMMITS_DIR/$repository/$tagname"
    log "commit $repository $tagname $user"
fi
