#! /bin/sh

ORIG=linux-2.6.5
XFS=linux-2.6-xfs
TMP=$(mktemp -d $(basename $0).XXXXXX)

trap "rm -rf $TMP" SIGINT SIGQUIT SIGTERM ERR

set -e

mkdir -p $TMP/fs
(   cd $XFS
    (   find fs/xfs -type f -a \
	     ! \( -path '*/CVS/*' -o -name '.*' -o -name '*.mod.c' -o \
		  -name '*.o' -o -name '*.ko' -o \
		  -name '*.orig' -o -name '*.rej' \)
	echo fs/Kconfig
    ) | cpio -p --quiet -d ../$TMP
)
xfs=$TMP/fs/xfs
for d in $xfs $xfs/dmapi $xfs/quota ; do
    mv $d/Makefile-linux-2.6 $d/Makefile
    rm $d/Makefile-linux-2.4
done
rm -rf $xfs/linux-2.4
mv $xfs/linux-2.6 $xfs/linux

#These files have moved to different locations. For a more compact diff,
#move them back:
#mv $xfs/support/{mrlock.h,mrlock.c,mutex.h,sema.h,spin.h,sv.h,time.h} \
#    $xfs/linux/

(   diff -Nurp $ORIG/fs/Kconfig $TMP/fs/Kconfig || true
    diff -Nurp $ORIG/fs/xfs $TMP/fs/xfs || true
) | sed -e "s:$TMP/:${ORIG%.orig}/:" \
      -e '\:^diff -Nur:d' \
      -e 's:\(^\(---\|+++\)[^	]*\)	.*:\1:'

rm -rf $TMP
