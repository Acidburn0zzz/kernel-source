#! /bin/sh

sourcedir=$1

cat <<'EOF'
set -ex

targets="$*"
: ${targets:=modules install clean}

if [ -z "$KERNEL_SOURCE" ]; then
    KERNEL_SOURCE=${0%/scripts/*}
fi

if [ -z "$ARCH" ]; then
    ARCH=$(uname -m | sed -e s/i.86/i386/ -e s/sun4u/sparc64/ \
			  -e s/arm.*/arm/ -e s/sa110/arm/ \
			  -e s/s390x/s390/ -e s/parisc64/parisc/)
fi

EOF

for arch in $($sourcedir/arch-symbols --list); do
    symbols=$($sourcedir/arch-symbols $arch)
    eval syms_$arch='$($sourcedir/guards $symbols < $sourcedir/config.conf)'
done

# Merge identical lists of symbols
unstable=1
while [ -n "$unstable" ]; do
    unstable=
    for syms in ${!syms_*}; do
	for syms2 in ${!syms_*}; do
	    [ $syms == $syms2 ] && continue
	    if [ "${!syms}" = "${!syms2}" ]; then
		archs=${syms#syms_}
		archs=
		eval syms_${syms#syms_}__${syms2#syms_}='"${!syms}"'
		unset $syms $syms2
		unstable=1
		break 2
	    fi
	done
    done
done

echo 'case "$ARCH" in'
for syms in ${!syms_*}; do
    [ -z "${!syms}" ] && continue
    archs=${syms#syms_}
    archs=${archs//__/|}
    echo -e "$archs)"
    echo -e "\tarch_flavors=\"$(echo ${!syms})\" ;;"
done
echo 'esac'

cat <<'EOF'

if ! [ -e Makefile ]; then
    echo "File Makefile not found." >&2
    exit 1
fi

rm -rf .build .install

for arch_flavor in $arch_flavors; do
    for target in $targets; do
	subarch=${arch_flavor%/*}
	flavor=${arch_flavor#*/}
	if [ $flavor = um ]; then
	    MAKE_ARGS="ARCH=um SUBARCH=$subarch"
	else
	    MAKE_ARGS="ARCH=$subarch"
	fi

	case $target in
	clean|distclean)
	    make $target $MAKE_ARGS KERNEL_SOURCE=$KERNEL_SOURCE
	    #rm -rf .install #.build
	    ;;
	modules)
	    #mkdir -p .build/$arch_flavor
	    #cp -u $KERNEL_SOURCE/arch/$subarch/defconfig.$flavor \
	    #    .build/$arch_flavor/.config
	    cp -u $KERNEL_SOURCE/arch/$subarch/defconfig.$flavor \
	        $KERNEL_SOURCE/.config
	    make $target $MAKE_ARGS KERNEL_SOURCE=$KERNEL_SOURCE
	    # O=$PWD/.build/$arch_flavor
	    ;;
	install)
	    mkdir -p .install/$arch_flavor
	    make install $MAKE_ARGS KERNEL_SOURCE=$KERNEL_SOURCE \
		INSTALL_MOD_PATH=$PWD/.install/$arch_flavor
	    # O=$PWD/.build/$arch_flavor
	    ;;
	esac
    done
done
EOF
