#
# spec file for package @NAME@ (Version @RPMVERSION@)
#
# Copyright (c) 2003 SuSE Linux AG, Nuernberg, Germany.
# This file and all modifications and additions to the pristine
# package are under the same license as the package itself.
#
# Please submit bugfixes or comments via http://www.suse.de/feedback/
#

# norootforbuild
# neededforbuild kernel-dummy kernel-binary-packages

# ( kernel-binary-packages is expanded into the list of all binary kernel
#   packages for each architecture by Autobuild. )

Name:         @NAME@
License:      GPL
Autoreqprov:  off
Summary:      Dummy summary
Group:        Development/Sources
Version:      @RPMVERSION@
Release:      0
Requires:     linux
Requires:     kernel-source = @RPMVERSION@-%release
Source11:     arch-symbols
Source12:     guards
Source21:     config.conf
BuildRoot:    %_tmppath/%name-%version-build
Prefix:       /usr/src

%(chmod +x %_sourcedir/arch-symbols)

%define preconf @PRECONF@
%define symbols %(export PATCH_ARCH=%_target_cpu ; cd %_sourcedir ; set -- $(./arch-symbols) $([ -e extra-symbols ] && cat extra-symbols) ; echo $*)

%description
Dummy description.

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT

%if %preconf
# Add all the symbol version hashes from the binary kernel packages
%_sourcedir/guards %symbols < %_sourcedir/series.conf \
    > %_builddir/kernel-source.patches
for config in $(%_sourcedir/guards %symbols < %_sourcedir/config.conf) ; do
    arch="${config%%/*}"
    flavor="${config#*/}"
    
    # Don't add the preconf files for kernels that are based
    # on a different set of patches than kernel-source.
    %_sourcedir/guards %symbols kernel-$flavor < %_sourcedir/series.conf \
	> %_builddir/kernel-$flavor.patches
    diff -q %_builddir/kernel-{source,$flavor}.patches || continue
    
    shopt -s nullglob
    for symvers in /boot/symvers-*-$arch-$flavor.gz; do
	ver_rel=${symvers#*symvers-}
	ver_rel=${ver_rel%%-$arch-*}
	mkdir -p $RPM_BUILD_ROOT/usr/src/linux-$ver_rel-obj/$arch/$flavor
	cd $RPM_BUILD_ROOT/usr/src/linux-$ver_rel-obj/$arch/$flavor
	gzip -cd /boot/symvers-*-$arch-$flavor.gz > Module.symvers
    done
done
%endif

%files
%defattr(-, root, root)
%if %preconf
/usr/src/linux-*-obj
%endif
