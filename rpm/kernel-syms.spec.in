#
# spec file for package @NAME@ (Version @VERSION@)
#
# Copyright (c) 2003 SuSE Linux AG, Nuernberg, Germany.
# This file and all modifications and additions to the pristine
# package are under the same license as the package itself.
#
# Please submit bugfixes or comments via http://www.suse.de/feedback/
#

# norootforbuild
# neededforbuild  kernel-binary-packages

# ( kernel-binary-packages is expanded into the list of all binary kernel
#   packages for each architecture by Autobuild. )

Name:         @NAME@
License:      GPL
Autoreqprov:  off
Summary:      Dummy summary
Group:        Development/Sources
Requires:     linux
Version:      @VERSION@
Release:      0
%define kversion %(echo %version | sed s/_/-/g)
%define ver_str %kversion-%release
Source11:     arch-symbols
Source12:     guards
Source21:     config.conf
BuildRoot:    %_tmppath/%name-%version-build
Prefix:       /usr/src

%(chmod +x %_sourcedir/arch-symbols)

%define preconf @PRECONF@
%define symbols %(export PATCH_ARCH=%_target_cpu ; cd %_sourcedir ; set -- $(./arch-symbols) $([ -e extra-symbols ] && cat extra-symbols) ; echo $*)

%description
Dummy description.

%install
rm -rf $RPM_BUILD_ROOT
mkdir $RPM_BUILD_ROOT

%if %preconf
mkdir -p $RPM_BUILD_ROOT/usr/src/linux-%ver_str-obj
cd $RPM_BUILD_ROOT/usr/src/linux-%ver_str-obj
# Add all the symbol version hashes from the binary kernel packages
for config in $(%_sourcedir/guards %symbols < %_sourcedir/config.conf) ; do
    arch="${config%/*}"
    flavor="${config#*/}"
    
    # UML needs a slightly different setup; we cannot support it
    # in the meta-configuration.
    [ $flavor = um ] && continue
    
    # With properly synchronized version numbers, this would work:
    #gzip -cd /boot/symvers-%ver_str-$arch-$flavor.gz \
    #	> symvers-$arch-$flavor
    mkdir -p $arch/$flavor
    gzip -cd /boot/symvers-%kversion-*-$arch-$flavor.gz \
    	> $arch/$flavor/Module.symvers
done
%endif

%files
%defattr(-, root, root)
%if %preconf
/usr/src/linux-%ver_str
%endif
