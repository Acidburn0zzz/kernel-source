#! /bin/sh

# Generate a Module.symvers-like list of symbols a module exports.

for obj in "$@"; do
	objdump -t "$obj" | awk '
	BEGIN { known_types["__ksymtab"] = "EXPORT_SYMBOL"
		known_types["__ksymtab_unused"] = "EXPORT_UNUSED_SYMBOL"
		known_types["__ksymtab_gpl"] = "EXPORT_SYMBOL_GPL"
		known_types["__ksymtab_unused_gpl"] = "EXPORT_UNUSED_SYMBOL_GPL"
		known_types["__ksymtab_gpl_future"] = "EXPORT_SYMBOL_GPL_FUTURE"
	      }
	      { if (NF < 3)
		  next
		if (gsub(/__crc_/, "", $NF))
		  crcs[$NF] = substr($1, length($1)-8, 8)
		else if (gsub(/__ksymtab_/, "", $NF) &&
			 ($(NF-2) in known_types))
		  types[$NF] = known_types[$(NF-2)]
	      }
	END   { for (sym in types) {
		  crc=(sym in crcs ? crcs[sym] : "00000000")
		  print "0x" crc "\t" sym "\t" module "\t" types[sym]
		}
	      }
	' module=${obj%.ko}
done
