divert(-1)

# This file is processed with m4, with "«" and "»" as the string
# delimiters. The default delimiters and angle brackets (a common
# fallback) would both interfere with shell syntax.

# Change quote characters:
changequote(«, »)

# Macros start with @ here:
changesyntax(«@@»)

@divert(0)@dnl
#
# spec file for package @NAME@ (Version @VERSION@)
#
# Copyright (c) 2003 SuSE Linux AG, Nuernberg, Germany.
# This file and all modifications and additions to the pristine
# package are under the same license as the package itself.
#
# Please submit bugfixes or comments via http://www.suse.de/feedback/
#

# norootforbuild
# neededforbuild  kernel-binary-packages modutils

# ( kernel-binary-packages is expanded into the list of all binary kernel
#   packages for each architecture by Autobuild. )

Name:         @NAME@
License:      GPL
Provides:     linux
Autoreqprov:  off
Summary:      Dummy summary
Group:        Development/Sources
Requires:     make c_compiler
PreReq:       %insserv_prereq
Version:      @VERSION@
Release:      0
%define kversion %(echo %version | sed s/_/-/g)
Source0:      http://www.kernel.org/pub/linux/kernel/v2.6/linux-%kversion.tar.bz2
Source10:     series.conf
Source11:     arch-symbols
Source12:     guards
Source21:     config.conf
Source22:     config.tar.bz2
Source30:     config_subst.sh
Source31:     merge-headers
Source32:     running-kernel.init.in
Source33:     check-for-config-changes
Source100:    patches.arch.tar.bz2
Source101:    patches.fixes.tar.bz2
Source102:    patches.drivers.tar.bz2
Source103:    patches.rpmify.tar.bz2
Source104:    patches.uml.tar.bz2
Source105:    patches.suse.tar.bz2
%define ver_str %kversion-%release
BuildRoot:    %_tmppath/%name-%version-build
Prefix:       /usr/src
%ifarch ppc
# do not waste space on the CDs and on the mirrors
NoSource:     0
%endif

%define preconf @PRECONF@

# Determine which symbols to use for controlling the patch/file
# selection mechanism.
%define symbols %(export PATCH_ARCH=%_target_cpu ; chmod +x %_sourcedir/arch-symbols ; %_sourcedir/arch-symbols ; [ -e %_sourcedir/extra-symbols ] && cat %_sourcedir/extra-symbols )

%description
Dummy description.

%prep
echo "Architecture symbol(s): %symbols"

# Unpack all sources and patches
%setup -q -T -n config          -b 22
%setup -q -T -n patches.arch    -b 100
%setup -q -T -n patches.fixes   -b 101
%setup -q -T -n patches.drivers -b 102
%setup -q -T -n patches.rpmify  -b 103
%setup -q -T -n patches.uml     -b 104
%setup -q -T -n patches.suse    -b 105

# The kernel source tree is unpacked last so that RPM_BUILD_DIR
# points to the right path, /usr/src/packages/BUILD/linux-%version
%setup -q -n linux-%kversion

# Apply the patches needed for this architecture.
chmod +x %_sourcedir/guards
for patch in $(%_sourcedir/guards %symbols < %_sourcedir/series.conf); do
    if ! patch -s -E -p1 --no-backup-if-mismatch -i ../$patch; then
	echo "*** Patch $patch failed ***"
	exit 1
    fi
done

# Install all config files. Some of them might not work in the
# kernel sources because of architecture specific patches, but
# we don't care.
source %{SOURCE30}  # config_subst.sh
configs="$(%_sourcedir/guards --list < %_sourcedir/config.conf)"
for config in $configs; do
    name=$(basename $config)
    path=arch/$(dirname $config)/defconfig.$name
    mkdir -p $(dirname $path)
    cat ../config/$config \
	| config_subst CONFIG_CFGNAME '"'$name'"' \
	| config_subst CONFIG_RELEASE %release \
	> $path
done

# For all architectures included, if there is a defconfig.default,
# make that the defconfig as well. If there is no defconfig.default,
# also remove the defconfig, as it is obviously not a tested, and
# woldn't work, anyway.
for config in $configs; do
    arch=$(dirname $config)
    if [ -e arch/$arch/defconfig.default ]; then
	cat arch/$arch/defconfig.default > arch/$arch/defconfig
    else
	rm -f arch/$arch/defconfig
    fi
done

chmod +x arch/ia64/scripts/toolchain-flags  # agruen: necessary?

%build
%if %preconf
# Add all the symbol version hashes from the binary kernel packages
for config in $(%_sourcedir/guards %symbols < %_sourcedir/config.conf) ; do
    arch="${config%/*}"
    flavor="${config#*/}"
    
    # UML needs a slightly different setup; we cannot support it
    # in the meta-configuration.
    [ $flavor = um ] && continue
    
    # With properly synchronized version numbers, this would work:
    #gzip -cd /boot/modversions-%ver_str-$arch-$flavor.gz \
    #	> modversions.$arch-$flavor
    gzip -cd /boot/modversions-%kversion-*-$arch-$flavor.gz \
    	> modversions.$arch-$flavor
done
%endif

# Collect the filelist
find . -mindepth 1 -not -path ./linux.files > linux.files

chmod +x %{SOURCE31}  # merge-headers

## Create a custom hostname utility and place it in the path
## before the system wide one so that we don't need to create
## a temporary make file.
#export PATH=%_builddir:$PATH
#cat > %_builddir/hostname <<-EOF
#	#! /bin/sh
#	echo "%_arch.suse.de"
#	EOF
#chmod +x %_builddir/hostname

%if %preconf
# Configure the kernel sources for each supported configuration

set +o posix  # turn on bash extensions
mkdir FLAVORS
for config in $(%_sourcedir/guards %symbols < %_sourcedir/config.conf); do
    arch=${config%/*}
    flavor=${config#*/}
    config=arch/$arch/defconfig.$flavor

    # UML needs a slightly different setup; we cannot support it
    # in the meta-configuration.
    [ $flavor = um ] && continue

    cfg="$(echo ARCH_FLAVOR_${arch}_${flavor} | tr a-z- A-Z_)"
    ln -s ../$cfg FLAVORS/'"'$arch-$flavor'"'

    cp $config .config

    MAKE_ARGS=
    if [ "$arch" != "$HOSTTYPE" ]; then
	MAKE_ARGS="ARCH=$arch"
%ifarch mips
	echo "CONFIG_CROSSCOMPILE=y" >> .config
%endif
    fi

    yes '' \
	| make oldconfig $MAKE_ARGS > /dev/null
    chmod +x %{SOURCE33}  # check-for-config-changes
    %{SOURCE33} $config .config

    make include/linux/version.h $MAKE_ARGS
    mkdir $cfg
    cp .config $cfg/.config
    cp include/linux/version.h include/linux/autoconf.h $cfg/
#%ifarch x86_64
#    make include/asm-x86_64/offset.h $MAKE_ARGS
#    cp include/asm-x86_64/offset.h $cfg/
#%endif
    make -s distclean $MAKE_ARGS
done
set -o posix  # turn off bash extensions

# Merge the configurations

any_defined() {
    while [ $# -gt 1 ]; do
	echo -n "defined($1) || "
	shift
    done
    echo -n "defined($1)"
}

(   cat <<-EOF
	ifeq (\$(ARCH_FLAVOR),)
	-include /var/adm/running-kernel.make
	endif
	EOF
	cd FLAVORS
	%{SOURCE31} --make ARCH_FLAVOR */.config
) > .config
(   cat <<-EOF
	#if !($(any_defined ARCH_FLAVOR_*))
	# include </var/adm/running-kernel.h>
	#endif
	EOF
    %{SOURCE31} ARCH_FLAVOR_*/autoconf.h
) > include/linux/autoconf.h
(   cat <<-EOF
	#if !($(any_defined ARCH_FLAVOR_*))
	# include </var/adm/running-kernel.h>
	#endif
	EOF
    %{SOURCE31} ARCH_FLAVOR_*/version.h
) > include/linux/version.h
#%ifarch x86_64
#(   cat <<-EOF
#	#if !($(any_defined ARCH_FLAVOR_*))
#	# include </var/adm/running-kernel.h>
#	#endif
#	EOF
#    %{SOURCE31} ARCH_FLAVOR_*/offset.h
#) > include/asm-x86_64/offset.h
#%endif

# Add files generated by configuring
any_flavor="$( cd FLAVORS ; set -- * ; echo $1 )"
make include/asm $MAKE_ARGS ARCH_FLAVOR='"'$any_flavor'"'
cat >> linux.files <<-EOF
	./.config
	./include/linux/version.h
	./include/linux/autoconf.h
	./include/asm
	EOF

rm -r ARCH_FLAVOR_* FLAVORS
%endif

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/usr/src/linux-%ver_str
ln -sf linux-%ver_str $RPM_BUILD_ROOT/usr/src/linux
cpio -p $RPM_BUILD_ROOT/usr/src/linux-%ver_str < linux.files

## Install the documentation and demo modules
DOC=$RPM_BUILD_ROOT/usr/share/doc/packages/%name
mkdir -p $DOC
#cp %{SOURCE?} $DOC
#bzip2 -cd %{SOURCE21} | tar -xf - -C $DOC
#ln -s /usr/share/doc/packages/%name/README.SuSE \
#    $RPM_BUILD_ROOT/usr/src/linux/

%if %preconf
# Generate a list of known flavors.
shopt -s nullglob
flavors=
for config in $(%_sourcedir/guards %symbols < %_sourcedir/config.conf); do
    arch=${config%/*}
    flavor=${config#*/}

    # UML needs a slightly different setup; we cannot support it
    # in the meta-configuration.
    [ "$flavor" = um ] && continue

    flavors="$flavors $arch-$flavor"
done
flavors="${flavors:1}"
shopt -u nullglob

# The init script that adapts /var/adm/running-kernel.{h,make}.
mkdir -p $RPM_BUILD_ROOT/etc/rc.d
sed -e "s,@FLAVORS@,$flavors," %{SOURCE32} \
> $RPM_BUILD_ROOT/etc/rc.d/running-kernel

mkdir -p $RPM_BUILD_ROOT/var/adm
touch $RPM_BUILD_ROOT/var/adm/running-kernel.h \
      $RPM_BUILD_ROOT/var/adm/running-kernel.make
%endif

%post
%if %preconf
#%{fillup_and_insserv -f running-kernel}  ## doesn't work: ???
/sbin/insserv running-kernel

if [ -e /.buildenv ]; then
    # Autobuild has a modified version of uname that reports a specific
    # kernel version if /.kernelversion exists.

    arch=$(uname -m)
    case $arch in
    i?86)       arch=i386 ;;
    sun4u)      arch=sparc64 ;;
    arm*|sa110) arch=arm ;;
    s390x)      arch=s390 ;;
    parisc64)   arch=parisc ;;
    esac

    flavor="$(
	cd /usr/src/linux-%ver_str/arch/$arch
	set -- defconfig.*
	[ -e defconfig.default ] && set -- defconfig.default
	echo ${1/defconfig.}
    )"

    echo %ver_str-$flavor > /.kernelversion
fi

/etc/rc.d/running-kernel
%endif

%postun
%if %preconf
%{insserv_cleanup}
%endif

%files
%defattr(-, root, root)
/usr/src/linux
/usr/src/linux-%ver_str
/usr/share/doc/packages/%name
%if %preconf
%ghost /var/adm/running-kernel.h
%ghost /var/adm/running-kernel.make
%attr(755, root, root) /etc/rc.d/running-kernel
%endif
