#
# spec file for package @NAME@ (Version @RPMVERSION@)
#
# Copyright (c) 2004 SuSE Linux AG, Nuernberg, Germany.
# This file and all modifications and additions to the pristine
# package are under the same license as the package itself.
#
# Please submit bugfixes or comments via http://www.suse.de/feedback/
#

# norootforbuild
# neededforbuild  gpp libgpp popt popt-devel python kernel-dummy kernel-module-packages gpg @EXTRA_NEEDS@

# ( kernel-module-packages is expanded into the list of all km_*
#   packages for each architecture by Autobuild. )

%define build_xen %([ @FLAVOR@ != xen ] ; echo $?)
%define build_um  %([ @FLAVOR@ != um ] ; echo $?)

Name:         @NAME@
Version:      @RPMVERSION@
Release:      0
Summary:      Dummy summary
License:      core kernel and most modules are GPL, some proprietary
Group:        System/Kernel
%if %build_um
#Conflicts:    kernel
%else
%if !%build_xen
Provides:     kernel = @RPMVERSION@-%release
%endif
%endif
@PROVIDES_OBSOLETES@
%ifarch x86_64
%if "@FLAVOR@" != "default"
Requires:     irqbalance
%endif
%endif
# the scsi target patch requires a new bootloader patch to figure out the boot-device
%ifarch ppc ppc64
%if "@FLAVOR@" == "ppc64"
Requires:     lilo >= 0.0.16
%endif
%endif
Autoreqprov:  on
%define my_builddir %_builddir/%{name}-%{version}
Source0:      http://www.kernel.org/pub/linux/kernel/v2.6/linux-@SRCVERSION@.tar.bz2
Source1:      functions.sh
Source8:      trigger-script.sh.in
Source11:     postun.sh
Source12:     post.sh
Source20:     series.conf
Source21:     config.conf
Source22:     supported.conf
Source30:     arch-symbols
Source31:     guards
Source32:     config-subst
Source33:     check-for-config-changes
Source34:     check-supported-list
Source35:     install-configs
Source40:     build-source-timestamp
@RPM_SOURCE_PATCHES@
PreReq:       mkinitrd >= 1.2
PreReq:       /usr/bin/test /bin/df /usr/bin/du /bin/cp /bin/sed /usr/bin/cut /usr/bin/expr /bin/touch
BuildRoot:    %_tmppath/%name-%version-build
ExclusiveArch: @ARCHS@

# These files are found in the kernel-source package:
NoSource:     0
@RPM_NO_SOURCE_PATCHES@

# Will failures in external modules abort the kernel build (0/1)?
%define extmod_failures_are_fatal 0

# Will unknown sybols cause the kernel build to fail (0/1)?
%define unknown_symbol_check 0

# Will modules not listed in supported.conf abort the kernel build (0/1)?
%define supported_modules_check 0

# Are we building with debug symbols enabled?
%define with_debug %(set -- " %optflags "; [ "$1" = "${1/ -g }" ]; echo $? )

%define tolerate_unknown_new_config_options @TOLERATE_UNKNOWN_NEW_CONFIG_OPTIONS@

%(chmod +x %_sourcedir/{arch-symbols,guards,config-subst,check-for-config-changes,check-supported-list})

%description
Dummy description.

%prep
if ! [ -e %_sourcedir/linux-@SRCVERSION@.tar.bz2 ]; then
    echo "The @NAME@-@RPMVERSION@.nosrc.rpm package does not contain the" \
	 "complete sources. Please install kernel-source-@RPMVERSION@.src.rpm."
    exit 1
fi

symbols=$(
    echo @NAME@
    cd %_sourcedir
    PATCH_ARCH=%_target_cpu ./arch-symbols
    ! [ -e extra-symbols ] || cat extra-symbols
)
echo "Architecture symbol(s):" $symbols

# Unpack all sources and patches
%setup -q -c -T -a 0 @RPM_ADDITIONAL_SETUP@

# Generate the list of supported modules
(   %_sourcedir/guards $symbols < %_sourcedir/supported.conf
    for how in external; do
	(   %_sourcedir/guards $symbols < %_sourcedir/supported.conf
	    %_sourcedir/guards $symbols < %_sourcedir/supported.conf
	    %_sourcedir/guards $symbols $how < %_sourcedir/supported.conf \
	) | sort | uniq -u | sed -e 's:$: '"$how"':'
    done
) | sed -e 's,.*/,,' | sort > linux-@SRCVERSION@/Module.supported

cd linux-@SRCVERSION@

# Find out for which architecture to build. We do this here, and use the
# result in the %build and %install sections.
#
# On architectures with a bi-arch or cross compiler, we can compile for
# an architecture different from %arch. The location of the config file
# tells us for which architecture to compile.
set -- $(
    for config in $(%_sourcedir/guards $symbols < %_sourcedir/config.conf) ; do
	[ ${config#*/} = @FLAVOR@ ] && echo $config
    done)
if [ $# -ne 1 ]; then
    echo "$# config files found for this spec file (but one needed)" >&2
    exit 1
fi
subarch=${1%/*}

# Apply the patches needed for this architecture.
for patch in $(%_sourcedir/guards $symbols < %_sourcedir/series.conf); do
    if ! patch -s -E -p1 --no-backup-if-mismatch -i ../$patch; then
	echo "*** Patch $patch failed ***"
	exit 1
    fi
done

%_sourcedir/install-configs %_sourcedir %my_builddir %release
config=arch/$subarch/defconfig.@FLAVOR@
cp $config .config

# If we are building with debug symbols enabled, set the corresponding
# config variable appropriately.
%if %with_debug
%_sourcedir/config-subst CONFIG_DEBUG_INFO y < .config > .config.new
mv .config.new .config
%endif

kernelrelease=$(make -s kernelrelease)

# We compile for this sub-architecture (i.e., machine architecture):
%if %build_um || %build_xen
cat > ../.rpm-defs <<EOF
ARCH=@FLAVOR@
SUBARCH=$subarch
MAKE_ARGS="ARCH=@FLAVOR@ SUBARCH=$subarch"
KERNELRELEASE=$kernelrelease
EOF
%else
cat > ../.rpm-defs <<EOF
ARCH=$subarch
SUBARCH=$subarch
MAKE_ARGS="ARCH=$subarch"
KERNELRELEASE=$kernelrelease
EOF
%endif

%build
source .rpm-defs

cd linux-@SRCVERSION@
cp .config .config.orig
%if %{tolerate_unknown_new_config_options}
yes '' | make oldconfig $MAKE_ARGS
%else
make silentoldconfig $MAKE_ARGS < /dev/null
%_sourcedir/check-for-config-changes .config.orig .config
rm .config.orig
%endif

# Override the timestamp `uname -v' reports with the build
# timestamp.
export BUILD_TIMESTAMP="$(head -n 1 %_sourcedir/build-source-timestamp)"

# The following branch/timestamp will end up in Oopses.
export OOPS_TIMESTAMP="$(
    echo -n $(sed -ne 's/^CVS Branch: \(.*\)/\1-/p' \
		  %_sourcedir/build-source-timestamp)
    head -n 1 %_sourcedir/build-source-timestamp \
	| tr -dc 0-9)"

export KBUILD_VERBOSE=0
make %{?jobs:-j%jobs} all $MAKE_ARGS

mkdir -p %my_builddir/modules-@RPMVERSION@
shopt -s nullglob
for dir in /usr/src/kernel-modules/*; do
    if [ -e $dir/Makefile ]; then
	build_dir=%my_builddir/modules-@RPMVERSION@/${dir##*/}
	cp -a $dir $build_dir

	rm -f $build_dir-failed
	if ! make -C $build_dir %{?jobs:-j%jobs} modules $MAKE_ARGS \
		  KERNEL_SOURCE=%my_builddir/linux-@SRCVERSION@; then
%if %extmod_failures_are_fatal
	    exit 1
%endif
	    echo "External module error: $dir failed"
	    touch $build_dir-failed
	fi
    fi
done
shopt -u nullglob

%install
source .rpm-defs

# get rid of /usr/lib/rpm/brp-strip-debug
# strip removes too much from the vmlinux ELF binary
export NO_BRP_STRIP_DEBUG=true

# /lib/modules/$KERNELRELEASE/build will be a stale symlink until the
# kernel-source package is installed. Don't check for stale symlinks
# in the brp-symlink check:
export NO_BRP_STALE_LINK_ERROR=yes

# Create the scipts for %pre, %post, %preun, %postun
for when in pre preun post postun ; do
    sed -e "s:@KERNELRELEASE@:$KERNELRELEASE:g" \
	-e "s/@WHEN@/$when/g" %_sourcedir/trigger-script.sh.in > $when.sh
done

(   echo 'run_mkinitrd=1'
    cat %_sourcedir/functions.sh
    sed -e "s:@KERNELRELEASE@:$KERNELRELEASE:g" %_sourcedir/post.sh
) >> post.sh
(   cat %_sourcedir/functions.sh
    sed -e "s:@KERNELRELEASE@:$KERNELRELEASE:g" %_sourcedir/postun.sh
) >> postun.sh

cd linux-@SRCVERSION@

rm -rf %buildroot
mkdir -p %buildroot/boot
# (Could strip out non-public symbols.)
cp -p System.map %buildroot/boot/System.map-$KERNELRELEASE

add_vmlinux()
{
%if %with_debug
    mkdir -p %buildroot/usr/lib/debug/boot/
    gzip -c9 vmlinux > %buildroot/usr/lib/debug/boot/vmlinux-$KERNELRELEASE.gz
    strip --strip-debug vmlinux
%endif
    gzip -c9 vmlinux > %buildroot/boot/vmlinux-$KERNELRELEASE.gz
}

%if %build_um
    mkdir -p %buildroot/usr/bin
    cp vmlinux %buildroot/usr/bin/linux-$KERNELRELEASE
    ln -s linux-$KERNELRELEASE %buildroot/usr/bin/linux
    cp vmlinux %buildroot/boot/linux-$KERNELRELEASE
    image=linux
%else
%if %build_xen
    add_vmlinux
    cp -p vmlinuz %buildroot/boot/vmlinuz-$KERNELRELEASE
    image=vmlinuz
%else
%ifarch %ix86 x86_64
    add_vmlinux
    cp -p arch/*/boot/bzImage %buildroot/boot/vmlinuz-$KERNELRELEASE
    image=vmlinuz
%endif
%endif
%ifarch alpha
    add_vmlinux
    cp -p arch/alpha/boot/vmlinux.gz %buildroot/boot/vmlinuz-$KERNELRELEASE
    image=vmlinuz
%endif
%ifarch ppc ppc64
    # FIXME: vmlinux is now much bigger. Should we strip it?
    cp -p vmlinux %buildroot/boot/vmlinux-$KERNELRELEASE
    image=vmlinux
%endif
%ifarch ia64
    # FIXME: vmlinux may be much bigger now. Should we strip it?
    cp -p vmlinux.gz %buildroot/boot/vmlinuz-$KERNELRELEASE
    image=vmlinuz
%endif
%ifarch s390 s390x
    add_vmlinux
    cp -p arch/s390/boot/image %buildroot/boot/image-$KERNELRELEASE
    image=image
%endif
    if [ -e init/kerntypes.o ]; then
	cp init/kerntypes.o %buildroot/boot/Kerntypes-$KERNELRELEASE
    fi
%endif

%if %build_um
suffix=-um
%else
%if %build_xen
suffix=-xen
%else
suffix=
%endif
%endif
ln -s $image$suffix %buildroot/boot/$image$suffix
ln -s initrd$suffix %buildroot/boot/initrd$suffix
ln -s $image %buildroot/boot/$image$suffix.previous
ln -s initrd %buildroot/boot/initrd$suffix.previous

cp .config %buildroot/boot/config-$KERNELRELEASE

make modules_install $MAKE_ARGS INSTALL_MOD_PATH=%buildroot

shopt -s nullglob
for build_dir in %my_builddir/modules-@RPMVERSION@/* ; do
    [ -d $build_dir ] || continue
    if [ -e $build_dir-failed ]; then
	echo "Build of $build_dir has failed"
    else
	make -C $build_dir install $MAKE_ARGS \
	    KERNEL_SOURCE=%my_builddir/linux-@SRCVERSION@ \
	    INSTALL_MOD_PATH=%buildroot
    fi
done
shopt -u nullglob

if ! %_sourcedir/check-supported-list \
	%_sourcedir %buildroot/lib/modules/$KERNELRELEASE; then
%if %supported_modules_check
    exit 1
%endif
    echo "Consistency check error: please update supported.conf."
fi

#if [ -e Module.symvers ]; then
#    gzip -c9 Module.symvers \
#	> %buildroot/boot/symvers-@SRCVERSION@-%release-$ARCH-@FLAVOR@.gz
#fi

# Recreate Module.symvers, and include all symbols from modules in
# km_* packages.
symver() {
    local file=$1 name=${1%.ko}
    nm $file \
    | sed -ne 's,^0*\([0-9a-f]\{8\}\) A __crc_\(.*\),0x\1\t\2\t'"$name"',p'
}

(   symver vmlinux
    moddir=%buildroot/lib/modules/$KERNELRELEASE
    cd $moddir/kernel
    for module in $(find * -name '*.ko'); do
	symver $module
    done
    cd $moddir
    for module in $(find * -path 'kernel/*' -prune -o \
			   -name '*.ko' -print); do
	symver $module
    done
) | sort -u -k2 \
| gzip -c9 > %buildroot/boot/symvers-${KERNELRELEASE%%-@FLAVOR@}-$ARCH-@FLAVOR@.gz

# Also put the resulting file in /usr/src/linux-obj/$SUBARCH/@FLAVOR@
# so that kernel-source + kernel-@FLAVOR@ is sufficient for building
# modules that have modversions as well.
mkdir -p %buildroot/usr/src/linux-${KERNELRELEASE%%-@FLAVOR@}-obj/$SUBARCH/@FLAVOR@
zcat %buildroot/boot/symvers-${KERNELRELEASE%%-@FLAVOR@}-$ARCH-@FLAVOR@.gz \
    > %buildroot/usr/src/linux-${KERNELRELEASE%%-@FLAVOR@}-obj/$SUBARCH/@FLAVOR@/Module.symvers

# We were building in %my_builddir/linux-@SRCVERSION@, but the sources will
# later be installed in /usr/src/linux-@SRCVERSION@-%release. Fix up the
# build symlink.
rm -f %buildroot/lib/modules/$KERNELRELEASE/{source,build}
ln -s /usr/src/linux-${KERNELRELEASE%%-@FLAVOR@} \
    %buildroot/lib/modules/$KERNELRELEASE/source
ln -s /usr/src/linux-${KERNELRELEASE%%-@FLAVOR@}-obj/$ARCH/@FLAVOR@ \
    %buildroot/lib/modules/$KERNELRELEASE/build

mkdir -p %buildroot/lib/modules/scripts
mkdir -p %buildroot/lib/modules/precompiled
/sbin/depmod -b %buildroot -ae -F %buildroot/boot/System.map-$KERNELRELEASE \
    $KERNELRELEASE 2>&1 \
| awk '
    /needs unknown symbol/  { fail=FAIL }
			    { print }
    END			    { exit fail }
' FAIL=%unknown_symbol_check

# Create a dummy initrd with roughly the size the real one will have.
# That way, YaST will know that this package requires some additional
# space in /boot.
dd if=/dev/zero of=%buildroot/boot/initrd-$KERNELRELEASE \
    bs=1024 seek=2047 count=1

cd %buildroot
# Collect the file list.
(   echo "%%defattr(-, root, root)"
    find boot \
	\( -type l -o -name 'initrd-*' \) -printf '%%%%ghost /%%p\n' -o \
	-type f -printf '/%%p\n'
    find lib/modules/$KERNELRELEASE \
	-type d -printf '%%%%dir /%%p\n' -o \
	-path '*/modules.*' -printf '%%%%ghost /%%p\n' -o \
	-not -path '*.ko' -printf '/%%p\n'
    find usr/src/linux-${KERNELRELEASE%%-@FLAVOR@}-obj \
	-type d -printf '%%%%dir /%%p\n' -o \
	-printf '/%%p\n'
    echo /lib/modules/scripts
    echo /lib/modules/precompiled
    if [ -e .%_docdir/%name ]; then
	echo "%%doc %_docdir/%name"
    fi
%if %with_debug
    if [ -e lib/debug/boot/vmlinux-$KERNELRELEASE.gz ]; then
	echo /usr/lib/debug/boot/vmlinux-$KERNELRELEASE.gz
    fi
%endif
) > %my_builddir/kernel.files
echo "%%defattr(-, root, root)" > %my_builddir/nongpl.files

has_target_nongpl=false
# Split modules in GPL (and GPL compatible) and others.
for module in $(find lib/modules/$KERNELRELEASE -path '*.ko'); do
    target=kernel
    while read license; do
	case "$license" in
	    "GPL" | "GPL v2" | "GPL and additional rights" | \
	    "Dual BSD/GPL" | "Dual MPL/GPL") ;;
	    *)
		target=nongpl
		has_target_nongpl=true
	    ;;
	esac
    done <<-EOF
	$(/sbin/modinfo $module | sed -ne 's/^license:[ \t]*//p')
	EOF
    # Also move the nvidia pre-compiled objects to the nongpl package
    case $module in
	*/fglrx-linux.o* | */nv-linux.o*)
	    has_target_nongpl=true
	    target=nongpl ;;
    esac
    echo "/$module" >> %my_builddir/$target.files
done
sed -n '/%%dir /s///p' %my_builddir/kernel.files |
while read dir; do
    if grep -Fq $dir %my_builddir/nongpl.files; then
	echo "%%dir $dir"
    fi
done >> %my_builddir/nongpl.files

# make sure the rpm is not empty
if test "$has_target_nongpl" = "false" ; then
echo "%%dir /lib/modules/$KERNELRELEASE" >> %my_builddir/nongpl.files
fi
# %post script for nongpl packages: regenerate the initrd if it
# contains one of the modules contained in the package.
(
    echo 'run_mkinitrd=
[ -e /etc/sysconfig/kernel ] && source /etc/sysconfig/kernel
for module in $INITRD_MODULES; do
    case "${module%.ko}" in'
    sed -ne 's:.*/\([^/]*\).ko$:    \1 | \\:p' %my_builddir/nongpl.files
    echo '    "")
	run_mkinitrd=1
	break
	;;
    esac
done'
    cat %_sourcedir/functions.sh
    sed -e "s:@KERNELRELEASE@:$KERNELRELEASE:g" \
	%_sourcedir/post.sh
) > %my_builddir/post-nongpl.sh

%pre -f pre.sh

%preun -f preun.sh

%post -f post.sh

%postun -f postun.sh

%files -f kernel.files

%package -n @NAME@-nongpl
Summary:      Dummy summary
Group:        System/Kernel
Provides:     kernel-nongpl
Requires:     @NAME@ = @RPMVERSION@-%release
PreReq:     @NAME@ = @RPMVERSION@-%release
%description -n @NAME@-nongpl
Dummy description.

%post -n @NAME@-nongpl -f post-nongpl.sh

%files -n @NAME@-nongpl -f nongpl.files

%if %build_um
%package -n um-host-kernel
Summary:      Dummy summary
Group:        System/Kernel

%description -n um-host-kernel
Dummy description.

%files -n um-host-kernel
%defattr(-, root, root)
/usr/bin/linux-*
/usr/bin/linux
%endif
